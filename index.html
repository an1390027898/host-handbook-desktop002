<!doctype html>
<html lang="zh-CN" data-theme="cream">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>新手主持人手册 v2.6.23</title>
<style>
/* -------------------------
   Theme tokens
--------------------------*/
:root{
  --sans: ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei","Noto Sans CJK SC",Arial;
  --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;

  /* common */
  --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  --radius-xl:26px; --radius-lg:22px; --radius-md:18px; --radius-sm:14px;
  --shadow: 0 14px 40px rgba(24, 24, 50, .10);
  --shadow2: 0 10px 26px rgba(24,24,50,.06);
  --blur: blur(10px);
  --txt: var(--text);
  --pri: var(--p2);
}

html[data-theme="cream"]{
  --bg:
    radial-gradient(1100px 680px at 10% -10%, rgba(255,196,220,.38), transparent 58%),
    radial-gradient(1050px 650px at 95% 0%, rgba(197,215,255,.36), transparent 58%),
    radial-gradient(900px 520px at 80% 95%, rgba(199,245,237,.32), transparent 60%),
    linear-gradient(180deg, #fffdf9, #fff7fb 45%, #f6fbff);

  --card: rgba(255,255,255,.72);
  --card2: rgba(255,255,255,.88);
  --line: rgba(30,35,60,.10);

  --text: #1b1d2a;
  --muted: rgba(27,29,42,.65);

  --p1:#ff6aa9;  /* strawberry */
  --p2:#6d5cff;  /* iris */
  --p3:#2dd4ff;  /* sky */
  --chipbg: rgba(255,255,255,.65);
  --chipbd: rgba(30,35,60,.10);
  --btnbg: rgba(255,255,255,.68);
  --btnbg2: rgba(255,255,255,.88);
}

html[data-theme="neon"]{
  --bg:
    radial-gradient(1100px 680px at 12% -10%, rgba(255,79,163,.26), transparent 58%),
    radial-gradient(1050px 650px at 95% 0%, rgba(109,92,255,.28), transparent 58%),
    radial-gradient(900px 520px at 80% 95%, rgba(45,212,255,.22), transparent 60%),
    linear-gradient(180deg, #070812, #070b1b 45%, #050714);

  --card: rgba(16,18,34,.62);
  --card2: rgba(16,18,34,.78);
  --line: rgba(240,245,255,.12);

  --text: #f2f4ff;
  --muted: rgba(242,244,255,.68);

  --p1:#ff4fa3;
  --p2:#7c5cff;
  --p3:#2dd4ff;
  --chipbg: rgba(16,18,34,.66);
  --chipbd: rgba(240,245,255,.12);
  --btnbg: rgba(16,18,34,.66);
  --btnbg2: rgba(16,18,34,.86);
  --shadow: 0 18px 55px rgba(0,0,0,.35);
  --shadow2: 0 12px 30px rgba(0,0,0,.25);
  --blur: blur(14px);
}

*{box-sizing:border-box}
body{
  margin:0; font-family:var(--sans); color:var(--text);
  background: var(--bg);
}
a{color:inherit; text-decoration:none}
.wrap{max-width:1220px; margin:0 auto; padding:18px}

/* Music page: make top header/nav full-width; other pages keep 1220 centered */
body.musicWideHeader .wrap{max-width:none; margin:0; width:100%;}


.header{
  border:1px solid var(--line); border-radius:var(--radius-xl); background:var(--card);
  box-shadow:var(--shadow); padding:16px; display:flex; gap:12px; flex-wrap:wrap; justify-content:space-between;
  backdrop-filter: var(--blur);
}
.brand{display:flex; gap:12px; align-items:flex-start}
.logo{
  width:44px;height:44px;border-radius:16px;
  background: linear-gradient(135deg, color-mix(in srgb, var(--p1) 85%, transparent), color-mix(in srgb, var(--p2) 85%, transparent));
  box-shadow: 0 10px 26px color-mix(in srgb, var(--p2) 22%, transparent);
}
h1{margin:0;font-size:18px; letter-spacing:.2px}
.sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.65;max-width:95ch}

.tools{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
.pill{display:inline-flex; gap:8px; align-items:center; padding:7px 10px; border-radius:999px; border:1px solid var(--line); background:color-mix(in srgb, var(--btnbg) 90%, transparent); font-size:12px; color:color-mix(in srgb, var(--text) 80%, transparent)}
.dot{width:8px;height:8px;border-radius:999px;background:var(--ok); box-shadow:0 0 0 4px color-mix(in srgb, var(--ok) 14%, transparent)}

.btn{
  cursor:pointer; user-select:none; padding:10px 12px; border-radius:16px;
  border:1px solid var(--line); background:var(--btnbg); font-size:12px; color:var(--text);
}
.btn:hover{background:var(--btnbg2)}
.fabReload{
  position: fixed;
  right: 18px;
  bottom: 18px;
  width: 44px;
  height: 44px;
  padding: 0;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: color-mix(in srgb, var(--card) 92%, transparent);
  color: var(--text);
  box-shadow: 0 16px 40px rgba(0,0,0,.18);
  z-index: 999999;
}
.fabReload:hover{ background: color-mix(in srgb, var(--card) 86%, transparent); }
@media (max-width: 520px){
  .fabReload{ right: 12px; bottom: 12px; width: 42px; height: 42px; }
}

.btn.primary{
  border: 1px solid color-mix(in srgb, var(--p2) 26%, transparent);
  background: linear-gradient(135deg, color-mix(in srgb, var(--p2) 20%, transparent), color-mix(in srgb, var(--p1) 18%, transparent));
}
.btn.danger{border-color:color-mix(in srgb, var(--danger) 26%, transparent); background:color-mix(in srgb, var(--danger) 12%, transparent)}

/* Theme switch */
.theme-switch{display:flex; gap:6px; padding:4px; border-radius:999px; border:1px solid var(--line); background:color-mix(in srgb, var(--btnbg) 92%, transparent)}
.tbtn{
  cursor:pointer; padding:8px 10px; border-radius:999px; border:1px solid transparent;
  background:transparent; color:color-mix(in srgb, var(--text) 78%, transparent); font-size:12px;
}
.tbtn.active{
  border-color:color-mix(in srgb, var(--p2) 26%, transparent);
  background: linear-gradient(135deg, color-mix(in srgb, var(--p1) 18%, transparent), color-mix(in srgb, var(--p3) 14%, transparent));
  color:var(--text);
}

.tabs{margin-top:12px; display:flex; gap:8px; flex-wrap:wrap}
.tab{
  padding:10px 12px; border-radius:18px; border:1px solid var(--line);
  background:color-mix(in srgb, var(--btnbg) 92%, transparent); color:color-mix(in srgb, var(--text) 70%, transparent); font-size:13px; cursor:pointer
}
.tab.active{
  background: linear-gradient(135deg, color-mix(in srgb, var(--p1) 18%, transparent), color-mix(in srgb, var(--p2) 16%, transparent));
  border-color:color-mix(in srgb, var(--p2) 22%, transparent);
  color:var(--text);
}


.ver{font-size:12px; font-weight:800; color:var(--muted); margin-left:8px; padding:4px 9px; border-radius:999px; border:1px solid var(--line); background:color-mix(in srgb, var(--btnbg) 85%, transparent)}

/* Header layout refinement */
.header{display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:start}
.brand{min-width:0}
.tools{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
.tabs{grid-column:1 / -1; margin-top:0}
@media (max-width: 980px){
  .header{grid-template-columns:1fr}
  .tools{justify-content:flex-start}
  .tabs{overflow:auto; padding-bottom:6px}
  .tabs::-webkit-scrollbar{height:6px}
}

/* More menu */
.menu{position:relative}
.menu > summary{list-style:none}
.menu > summary::-webkit-details-marker{display:none}
.menuPanel{
  position:absolute; right:0; top: calc(100% + 8px);
  min-width: 190px;
  border:1px solid var(--line);
  background: color-mix(in srgb, var(--card2) 92%, transparent);
  backdrop-filter: var(--blur);
  border-radius:16px;
  padding:8px;
  box-shadow: var(--shadow2);
  display:none;
  z-index: 30;
}
.menu[open] .menuPanel{display:block}
.menuItem{
  width:100%;
  text-align:left;
  padding:10px 10px;
  border-radius:12px;
  border:1px solid transparent;
  background: transparent;
  color: var(--text);
  cursor:pointer;
  font-size:12px;
}
.menuItem:hover{background: color-mix(in srgb, var(--btnbg2) 80%, transparent); border-color: color-mix(in srgb, var(--line) 80%, transparent)}
.menuItem.danger{color: color-mix(in srgb, var(--danger) 92%, var(--text));}
.menuSep{height:1px; margin:6px 2px; background: color-mix(in srgb, var(--line) 85%, transparent)}
.grid{display:grid; grid-template-columns:1fr 360px; gap:14px; margin-top:14px}
@media (max-width:780px){ .grid{grid-template-columns:1fr} }
.aside,.card,.schedule{
  border:1px solid var(--line); border-radius:var(--radius-xl); background:var(--card);
  box-shadow:var(--shadow);
  backdrop-filter: var(--blur);
}
.aside{padding:14px; position:sticky; top:14px; height:fit-content}
@media (max-width:780px){ .aside{position:static} }
.aside h2{margin:0 0 10px 0; font-size:15px}

.search{display:flex; gap:8px; margin-top:10px}
.search input{
  flex:1; padding:11px 12px; border-radius:16px; border:1px solid var(--line); background:color-mix(in srgb, var(--btnbg) 92%, transparent);
  color:var(--text); outline:none; font-size:13px;
}
.search input:focus{border-color:color-mix(in srgb, var(--p2) 35%, transparent); box-shadow:0 0 0 3px color-mix(in srgb, var(--p2) 14%, transparent)}

.nav{display:flex; flex-direction:column; gap:6px; margin-top:12px; max-height: 55vh; overflow:auto; padding-right:4px}
.nav a{
  padding:10px 10px; border-radius:16px; color:color-mix(in srgb, var(--text) 68%, transparent);
  border:1px solid transparent; display:flex; justify-content:space-between; align-items:center; font-size:13px
}
.nav a:hover{background:var(--card2); border-color:color-mix(in srgb, var(--p2) 14%, transparent); color:var(--text)}
.nav a.active{
  background: linear-gradient(135deg, color-mix(in srgb, var(--p2) 16%, transparent), color-mix(in srgb, var(--p3) 14%, transparent));
  border-color:color-mix(in srgb, var(--p2) 22%, transparent); color:var(--text)
}
.tag{
  font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid var(--chipbd);
  background:var(--chipbg); color:color-mix(in srgb, var(--text) 70%, transparent)
}
.progress{margin-top:12px; padding:12px; border-radius:20px; border:1px solid var(--line); background:color-mix(in srgb, var(--btnbg) 92%, transparent)}
.row{display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin-bottom:8px}
.bar{height:10px;border-radius:999px;border:1px solid var(--line); background:color-mix(in srgb, var(--text) 8%, transparent); overflow:hidden}
.bar>div{height:100%; width:0%; background:linear-gradient(90deg, var(--p1), var(--p2), var(--p3)); border-radius:999px; transition:width .2s ease}
.hint{margin-top:8px; font-size:12px; color:var(--muted); line-height:1.6}

.cards{display:flex; flex-direction:column; gap:12px}
.card{padding:16px; scroll-margin-top:14px}
.card h3{margin:0 0 8px 0; font-size:16px; display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap}
.num{
  width:28px;height:28px;border-radius:12px; display:inline-flex; align-items:center; justify-content:center;
  background: linear-gradient(135deg, color-mix(in srgb, var(--p1) 18%, transparent), color-mix(in srgb, var(--p2) 16%, transparent));
  border:1px solid color-mix(in srgb, var(--p2) 18%, transparent); font-size:12px
}
.note{margin:0; color:var(--muted); font-size:12px; line-height:1.6}
.boxgrid{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px}
@media (max-width:900px){ .boxgrid{grid-template-columns:1fr} }
.box{border:1px solid var(--line); background:var(--card2); border-radius:20px; padding:12px}
.box h4{margin:0 0 8px 0; font-size:13px}
.box p,.box li{margin:0; color:color-mix(in srgb, var(--text) 76%, transparent); font-size:13px; line-height:1.75}
.box ul{margin:8px 0 0 18px; padding:0}

.script{border:1px solid var(--line); background:var(--card2); border-radius:20px; padding:10px 12px; font-size:13px; line-height:1.75; color:color-mix(in srgb, var(--text) 88%, transparent)}
.cue{font-family:var(--mono); font-size:12px; color:color-mix(in srgb, var(--text) 78%, transparent)}
.scriptbox{padding:10px 10px;}
.script-line{display:flex; gap:8px; align-items:flex-start; padding:6px 6px; border-radius:14px;}
.script-line:hover{background:color-mix(in srgb, var(--p2) 6%, transparent)}
.script-text{flex:1; white-space:pre-wrap; outline:none;}
.script-line.editing .script-text{border:1px solid color-mix(in srgb, var(--p2) 20%, transparent); background:color-mix(in srgb, var(--p2) 10%, transparent); border-radius:14px; padding:6px 8px;}
.delbtn{display:none; width:28px;height:28px;border-radius:12px; border:1px solid var(--line); background:var(--btnbg); color:color-mix(in srgb, var(--text) 74%, transparent); cursor:pointer;}
.delbtn:hover{background:color-mix(in srgb, var(--danger) 14%, transparent); border-color:color-mix(in srgb, var(--danger) 26%, transparent)}
.scriptbox.edit-mode .delbtn{display:inline-flex; align-items:center; justify-content:center;}
.script-head{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px}
.script-tools{display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end}
.sbtn{
  border:1px solid var(--line); background:var(--btnbg); color:color-mix(in srgb, var(--text) 78%, transparent);
  border-radius:14px; padding:8px 10px; font-size:12px; cursor:pointer;
}
.sbtn:hover{background:var(--btnbg2)}
.sbtn:disabled{opacity:.45; cursor:not-allowed; pointer-events:none;}

.sbtn.tgl{padding:8px 10px; min-width:42px}
.sbtn.tgl.on{border-color:var(--accent); background:var(--accent); color:#fff; box-shadow:0 8px 24px rgba(0,0,0,.22); outline:none}
.sbtn.tgl.mid{outline:2px dashed color-mix(in srgb, var(--accent) 45%, transparent)}

.sbtn.primary{border-color:color-mix(in srgb, var(--p2) 22%, transparent); background:color-mix(in srgb, var(--p2) 10%, transparent)}
.sbtn.danger{border-color:color-mix(in srgb, var(--danger) 26%, transparent); background:color-mix(in srgb, var(--danger) 12%, transparent)}
.script-hint{margin-top:8px; color:var(--muted); font-size:12px; line-height:1.6}

.check{margin-top:10px; display:flex; gap:10px; align-items:flex-start; padding:12px; border-radius:20px; border:1px solid var(--line); background:color-mix(in srgb, var(--btnbg) 92%, transparent)}
.check input{margin-top:3px; accent-color: var(--p2)}
.check .txt{color:color-mix(in srgb, var(--text) 74%, transparent); font-size:13px; line-height:1.65}
.check .txt b{color:var(--text)}

.view{display:none}
.view.active{display:block}
.footer{margin:14px 0 0; text-align:center; color:var(--muted); font-size:12px; line-height:1.8}

/* Schedule module */
.schedule{padding:16px}
.sched-top{display:flex; gap:12px; justify-content:space-between; flex-wrap:wrap; align-items:flex-start}
.sched-title h2{font-size:18px}
.sub2{margin-top:6px; color:var(--muted); font-size:13px; line-height:1.6; max-width:85ch}
.sched-actions{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}

.sched-summary{margin-top:12px; display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
@media (max-width:780px){ .sched-summary{grid-template-columns:repeat(2, 1fr)} }
.stat{
  border:1px solid var(--line); border-radius:var(--radius-lg); background:var(--card2);
  padding:12px; box-shadow: var(--shadow2);
}
.stat.wide{grid-column:1/-1}
.stat .label{font-size:12px; color:var(--muted)}
.stat .value{margin-top:6px; font-size:22px; font-weight:750; letter-spacing:.2px;
  background: linear-gradient(135deg, var(--p1), var(--p2), var(--p3));
  -webkit-background-clip: text; background-clip:text; color:transparent;
}
.stat .small{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.5}
.days{margin-top:8px; display:flex; gap:8px; flex-wrap:wrap}
.daypill{
  padding:7px 10px; border-radius:999px; border:1px solid color-mix(in srgb, var(--p2) 18%, transparent);
  background:color-mix(in srgb, var(--p2) 10%, transparent); font-size:12px; cursor:pointer; color:color-mix(in srgb, var(--text) 80%, transparent)
}
.daypill:hover{background:color-mix(in srgb, var(--p1) 12%, transparent); border-color:color-mix(in srgb, var(--p1) 18%, transparent)}
.daypill.active{background:color-mix(in srgb, var(--p1) 14%, transparent); border-color:color-mix(in srgb, var(--p1) 22%, transparent)}
.daypill.all{background:color-mix(in srgb, var(--p3) 10%, transparent); border-color:color-mix(in srgb, var(--p3) 18%, transparent)}

.sched-split{margin-top:12px; display:grid; grid-template-columns: 1.2fr 0.8fr; gap:12px}
@media (max-width:780px){ .sched-split{grid-template-columns:1fr} }
.cal-card,.list-card{
  border:1px solid var(--line); border-radius:var(--radius-xl); background:var(--card2);
  padding:12px; box-shadow: var(--shadow2);
}
.cal-title,.list-title{display:flex; justify-content:space-between; gap:10px; align-items:flex-end; flex-wrap:wrap; margin-bottom:10px}
.month{font-size:14px; font-weight:800}
.mini{font-size:12px; color:var(--muted)}

.cal-head{display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-bottom:8px; color:var(--muted); font-size:12px}
.cal-body{display:grid; grid-template-columns:repeat(7,1fr); gap:8px}
.day{
  border:1px solid color-mix(in srgb, var(--text) 12%, transparent); border-radius:20px; padding:10px; min-height:110px;
  background:color-mix(in srgb, var(--card2) 86%, transparent); position:relative; overflow:hidden; cursor:pointer;
}
.day.muted{opacity:.48}
.day .dnum{font-size:12px; color:color-mix(in srgb, var(--text) 80%, transparent)}
.day .badge{position:absolute; right:10px; top:10px; font-size:11px; padding:2px 8px; border-radius:999px;
  border:1px solid color-mix(in srgb, var(--p2) 18%, transparent); background:color-mix(in srgb, var(--p2) 10%, transparent); color:color-mix(in srgb, var(--text) 78%, transparent)
}
.day.today{border-color:color-mix(in srgb, var(--warn) 40%, transparent); box-shadow:0 0 0 3px color-mix(in srgb, var(--warn) 14%, transparent) inset}
.day.has1{background:linear-gradient(135deg, color-mix(in srgb, var(--p3) 12%, transparent), color-mix(in srgb, var(--p2) 8%, transparent))}
.day.has2{background:linear-gradient(135deg, color-mix(in srgb, var(--p1) 14%, transparent), color-mix(in srgb, var(--p2) 8%, transparent))}
.day.has3{background:linear-gradient(135deg, color-mix(in srgb, var(--p1) 16%, transparent), color-mix(in srgb, var(--p3) 10%, transparent))}
.events{margin-top:8px; display:flex; flex-direction:column; gap:6px}
.ev{
  padding:7px 8px; border-radius:16px; border:1px solid color-mix(in srgb, var(--p2) 18%, transparent);
  background:color-mix(in srgb, var(--p2) 10%, transparent); cursor:pointer
}
.ev:hover{background:color-mix(in srgb, var(--p1) 12%, transparent); border-color:color-mix(in srgb, var(--p1) 18%, transparent)}
.ev .t{font-size:12px; color:color-mix(in srgb, var(--text) 90%, transparent); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.ev .s{margin-top:2px; font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

.list-toolbar{display:flex; gap:8px; align-items:center; justify-content:flex-start; flex-wrap:wrap; margin-bottom:10px}
.list-toolbar input{
  flex:1; min-width:180px;
  padding:11px 12px; border-radius:16px; border:1px solid var(--line); background:color-mix(in srgb, var(--btnbg) 92%, transparent);
  color:var(--text); outline:none; font-size:13px;
}
.list-wrap{display:flex; flex-direction:column; gap:10px}
.item{
  border:1px solid color-mix(in srgb, var(--text) 12%, transparent); border-radius:var(--radius-lg); background:color-mix(in srgb, var(--card2) 92%, transparent); padding:12px; cursor:pointer
}
.item:hover{border-color:color-mix(in srgb, var(--p2) 18%, transparent); background:color-mix(in srgb, var(--p2) 8%, transparent)}
.item .top{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center}
.item .title{font-size:14px; color:color-mix(in srgb, var(--text) 92%, transparent); font-weight:750}
.item .meta{font-size:12px; color:var(--muted)}
.item .chips{margin-top:8px; display:flex; gap:6px; flex-wrap:wrap}
.chip{font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--chipbd); background:var(--chipbg); color:var(--muted)}

/* Modal */
.modal{position:fixed; inset:0; display:none; z-index:9999}
.modal.show{display:block}
.modal-backdrop{position:absolute; inset:0; background:rgba(20,20,40,.35)}
.modal-panel{
  position:relative; max-width:980px; margin:24px auto; background:color-mix(in srgb, var(--card2) 94%, transparent);
  border:1px solid var(--line); border-radius:var(--radius-xl); box-shadow:var(--shadow); overflow:hidden;
  backdrop-filter: var(--blur);
}
@media (max-width:1020px){ .modal-panel{margin:12px;} }
.modal-head{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; padding:14px 16px; border-bottom:1px solid var(--line)}
.modal-title{font-size:16px; color:color-mix(in srgb, var(--text) 92%, transparent); font-weight:800}
.modal-sub{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.6}
.iconbtn{width:34px;height:34px;border-radius:16px; border:1px solid var(--line); background:var(--btnbg); color:var(--muted); cursor:pointer}
.iconbtn:hover{background:var(--btnbg2); color:var(--text)}
.modal-body{padding:16px; max-height:70vh; overflow:auto}
.modal-foot{display:flex; justify-content:space-between; gap:10px; align-items:center; padding:14px 16px; border-top:1px solid var(--line)}
.modal-foot .right{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

.form-grid{display:grid; grid-template-columns:repeat(2, 1fr); gap:10px}
@media (max-width:820px){ .form-grid{grid-template-columns:1fr} }
.field label{display:block; font-size:12px; color:color-mix(in srgb, var(--text) 78%, transparent); margin-bottom:6px}
.field input, .field textarea{
  width:100%; padding:11px 12px; border-radius:18px; border:1px solid var(--line);
  background:color-mix(in srgb, var(--btnbg) 92%, transparent); color:var(--text); outline:none; font-size:13px;
}
.field textarea{resize:vertical}
.field input:focus, .field textarea:focus{border-color:color-mix(in srgb, var(--p2) 28%, transparent); box-shadow:0 0 0 3px color-mix(in srgb, var(--p2) 12%, transparent)}
.divider{height:1px; background:var(--line); margin:14px 0}

.ls-head, .cs-head{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-start}
.ls-title{font-size:14px; color:color-mix(in srgb, var(--text) 92%, transparent); font-weight:800}
.ls-sub{margin-top:4px; font-size:12px; color:var(--muted); line-height:1.6}
.chip-grid{margin-top:10px; display:flex; flex-wrap:wrap; gap:8px}
.schip{
  padding:8px 10px; border-radius:999px; border:1px solid var(--chipbd); background:var(--chipbg);
  color:color-mix(in srgb, var(--text) 80%, transparent); font-size:12px; cursor:pointer
}
.schip:hover{background:color-mix(in srgb, var(--p2) 10%, transparent); border-color:color-mix(in srgb, var(--p2) 16%, transparent)}
.schip.on{border-color:color-mix(in srgb, var(--p1) 22%, transparent); background:color-mix(in srgb, var(--p1) 12%, transparent)}
.muted-small{font-size:12px; color:var(--muted); line-height:1.6}

.client-scripts .cs-wrap{margin-top:10px; display:flex; flex-direction:column; gap:10px}
.cs-block{border:1px solid var(--line); border-radius:var(--radius-lg); background:var(--card2); padding:12px}
.cs-block .top{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center}
.cs-block .name{font-size:13px; color:color-mix(in srgb, var(--text) 92%, transparent); font-weight:750}
.cs-block .mini{font-size:11px; color:var(--muted)}
.cs-tools{display:flex; gap:6px; flex-wrap:wrap}
.cs-block .scriptbox{border:1px solid var(--line)}

/* Print */
@media print{
  body{background:#fff!important; color:#111!important}
  .wrap{max-width:none; padding:0}
  .tools,.tabs,.aside,.theme-switch{display:none!important}
  .header{box-shadow:none; background:#fff; border:none}
  .card,.schedule{box-shadow:none; background:#fff; border:1px solid #ddd}
  .box,.script,.day,.item,.cs-block{border:1px solid #ddd; background:#fff}
  .sub,.sub2,.note,.box p,.box li,.check .txt,.script-hint,.mini,.muted-small{color:#333!important}
  .btn,.sbtn,.delbtn,.iconbtn,.daypill{display:none!important}
}
/* -------------------------
   Social module additions
--------------------------*/
.topiclist{display:flex; flex-direction:column; gap:10px; margin-top:12px}
.topicrow{
  display:flex; gap:12px; align-items:flex-start;
  padding:12px; border:1px solid var(--line); border-radius:var(--radius-xl);
  background:linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, transparent), color-mix(in srgb, var(--card2) 94%, transparent));
}
.topicrow .tno{
  flex:0 0 auto; width:44px; height:44px; border-radius:16px;
  display:flex; align-items:center; justify-content:center;
  font-weight:900; color:var(--text);
  background:color-mix(in srgb, var(--btnbg2) 88%, transparent);
  border:1px solid var(--line);
}
.topicrow .tmain{flex:1; min-width:0}
.topicrow .tmain .tt{font-weight:850; line-height:1.25}
.topicrow .tmeta{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
.topicrow .tmeta .tag{font-size:12px}
.topicrow details{margin-top:10px}
.topicrow summary{cursor:pointer; font-weight:750}
.topicrow .tplgrid{
  display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px
}
@media (max-width:780px){ .topicrow .tplgrid{grid-template-columns:1fr} }

.sm-kpi{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
.gen-grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
@media (max-width:780px){ .gen-grid{grid-template-columns:1fr} }

.ideas{display:flex; flex-direction:column; gap:10px; margin-top:12px}
.idea{
  padding:12px; border:1px solid var(--line); border-radius:var(--radius-xl);
  background:linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, transparent), color-mix(in srgb, var(--card2) 94%, transparent));
}
.idea .top{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap}
.idea .meta{font-size:12px; color:color-mix(in srgb, var(--text) 70%, transparent)}
.idea pre{
  margin:10px 0 0; white-space:pre-wrap; word-break:break-word;
  background:color-mix(in srgb, var(--btnbg) 75%, transparent);
  border:1px solid var(--line);
  border-radius:18px; padding:10px 12px;
}
details.soft > summary{list-style:none}
details.soft > summary::-webkit-details-marker{display:none}
details.soft > summary{
  padding:10px 12px; border:1px solid var(--line); border-radius:18px;
  background:color-mix(in srgb, var(--btnbg) 80%, transparent);
}

/* -------------------------
   Social Generator v2
--------------------------*/
.pillbtn{
  border:1px solid var(--line);
  background: var(--chipbg);
  color: color-mix(in srgb, var(--text) 84%, transparent);
  border-radius: 999px;
  padding: 8px 12px;
  font-size: 12px;
  cursor: pointer;
  transition: transform .12s ease, background .12s ease, border-color .12s ease;
}
.pillbtn:hover{ background: var(--btnbg2); transform: translateY(-1px); }
.pillbtn.active{
  border-color: color-mix(in srgb, var(--p2) 45%, var(--line));
  box-shadow: 0 10px 24px rgba(109,92,255,.18);
}
.krow{display:flex; align-items:center; gap:10px; margin-top:10px; flex-wrap:wrap}
.klabel{font-weight:800; font-size:12px; opacity:.9; min-width:72px}
.kchips{display:flex; gap:8px; flex-wrap:wrap}
.out-actions{display:flex; justify-content:flex-end; gap:8px; margin-top:8px; flex-wrap:wrap}
.soft summary{cursor:pointer}
.idea pre{white-space:pre-wrap}
.idea .meta{opacity:.8}
.idea .top{align-items:flex-start}
.idea .act{display:flex; gap:8px; flex-wrap:wrap}
.badge{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border:1px solid var(--line);
  border-radius:999px; background: var(--chipbg);
  font-size:12px;
}

/* -------------------------
   Title Library
--------------------------*/
.titleList{margin-top:12px; display:flex; flex-direction:column; gap:10px}
.titleItem{
  border:1px solid var(--line);
  background: color-mix(in srgb, var(--btnbg) 86%, transparent);
  border-radius:16px;
  padding:12px;
}
.titleTop{display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap}
.titleText{font-weight:900; line-height:1.28; font-size:16px; overflow-wrap:anywhere; word-break:break-word}
.titleMeta{margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; align-items:center}
.tchip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--line); background: var(--chipbg); border-radius:999px; font-size:12px}
.titleActions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
@media (max-width: 720px){
  .titleTop{flex-direction:column; align-items:stretch}
  .titleActions{justify-content:flex-start}
}

.star{cursor:pointer; user-select:none}
.star.on{filter: drop-shadow(0 10px 16px rgba(109,92,255,.25));}

/* -------------------------
   Music System
--------------------------*/
/* ===== New Music System (P1/Kugou) ===== */
.p1Player{
  position: sticky; top: 10px; z-index: 2;
  border:1px solid var(--line);
  background: color-mix(in srgb, var(--card) 80%, transparent);
  backdrop-filter: blur(10px);
  border-radius:18px;
  padding:12px;
  box-shadow: 0 20px 40px rgba(0,0,0,.06);
  margin: 12px 0 16px;
}
.p1Row{display:flex; align-items:center; justify-content:space-between; gap:10px}
.p1Now{flex:1; min-width:0}
.p1Title{font-weight:900; font-size:16px; line-height:1.2; overflow-wrap:anywhere; word-break:break-word}
.p1Meta{margin-top:4px; font-size:12px; color: var(--muted); overflow-wrap:anywhere}
.p1Btns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
.iconbtn{border:1px solid var(--line); background: var(--btnbg); color:var(--txt); padding:10px 12px; border-radius:12px; cursor:pointer}
.iconbtn.primary{background: linear-gradient(135deg, var(--pri), color-mix(in srgb, var(--pri) 70%, white)); color:white; border-color: transparent}

.iconbtn.active{outline: 3px solid color-mix(in srgb, var(--pri) 35%, transparent); border-color: var(--pri)}
.kgItem.active{outline: 3px solid color-mix(in srgb, var(--pri) 25%, transparent); border-color: color-mix(in srgb, var(--pri) 55%, var(--line))}
.kgTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
.kgTop .kgName{flex:1; min-width:0}
.sbtn.mini{padding:6px 10px; border-radius:999px; font-size:12px; line-height:1; font-weight:900}
.kgItem.editing{outline: 3px solid color-mix(in srgb, var(--p2) 22%, transparent); border-color: color-mix(in srgb, var(--p2) 55%, var(--line))}
.kgItem.editing .kgName{opacity:.95}
.p1Seek{flex:1; min-width:140px}
.p1Time{font-variant-numeric: tabular-nums; font-size:12px; color: var(--muted); width:44px; text-align:center}
.p1Vol{width:110px}
.p1Modes{margin-top:8px; justify-content:flex-start; gap:10px; flex-wrap:wrap}
.pill{border:1px solid var(--line); background: var(--chipbg); padding:6px 10px; border-radius:999px; font-size:12px}
.pill.muted{color: var(--muted)}
.kgGrid{display:grid; grid-template-columns: 1fr 1.3fr 1.2fr; gap:14px; margin-top: 8px}
.kgCol{border:1px solid var(--line); background: color-mix(in srgb, var(--card) 88%, transparent); border-radius:18px; padding:12px; min-height: 360px; display:flex; flex-direction:column}
/* v2.5.4 fix (theme-aware): prevent visual overlap in music lists */
html[data-theme="cream"] .kgCol, html[data-theme="cream"] .kgItem{background: rgba(255,255,255,.98)!important; backdrop-filter:none!important;}
html[data-theme="neon"]  .kgCol, html[data-theme="neon"]  .kgItem{background: rgba(16,18,34,.86)!important; backdrop-filter:none!important;}

.kgHead{display:flex; align-items:center; justify-content:flex-start; gap:10px; margin-bottom:10px}
.kgHeadRight{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; margin-left:auto}
.kgTitle{font-weight:900}
.kgSearch{border:1px solid var(--line); background: var(--btnbg); color:var(--txt); padding:9px 10px; border-radius:12px; outline:none; min-width:150px}
.kgList{flex:1; overflow:auto; display:flex; flex-direction:column; gap:10px; padding-right:4px}

/* Music: library list resizable height */
#kgColLib{overflow:hidden;}
#kgColLib #libList{flex:1 1 auto; height:auto; min-height:220px; max-height:none;}
#kgColLib.catsHidden #libCats{display:none!important;}
.kgTip{margin-top:10px; font-size:12px}
.kgItem{
  border:1px solid var(--line);
  background: color-mix(in srgb, var(--btnbg) 88%, transparent);
  border-radius:16px;
  padding:10px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}

.kgGrip{
  width:28px; min-width:28px; height:34px;
  display:flex; align-items:center; justify-content:center;
  border:1px dashed color-mix(in srgb, var(--line) 85%, transparent);
  border-radius:12px;
  background: color-mix(in srgb, var(--card) 85%, transparent);
  cursor:grab;
  user-select:none;
  opacity:.9;
}
.kgGrip:active{cursor:grabbing;}
.kgItem:hover{filter: drop-shadow(0 12px 18px rgba(0,0,0,.07))}
.kgLeft{flex:1; min-width:0}
.kgName{font-weight:900; overflow-wrap:anywhere; word-break:break-word}
.kgSub{margin-top:3px; font-size:12px; color:var(--muted)}
.kgRight{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

.kgItem .kgRight{margin-left:auto;}
.dropZone{
  border:1.6px dashed color-mix(in srgb, var(--line) 75%, transparent);
  background: color-mix(in srgb, var(--chipbg) 55%, transparent);
  border-radius:18px;
  padding:14px;
  margin-bottom:10px;
  text-align:center;
}
.dzBig{font-weight:900; margin-bottom:4px}
.dropZone.dragover{outline: 3px solid color-mix(in srgb, var(--pri) 35%, transparent); border-color: var(--pri)}
.clipDrawer{
  position: fixed; left: 50%; transform: translateX(-50%);
  bottom: 16px; z-index: 999;
  width: min(860px, calc(100vw - 24px));
  border:1px solid var(--line);
  background: color-mix(in srgb, var(--card) 90%, transparent);
  backdrop-filter: blur(14px);
  border-radius: 22px;
  padding: 12px;
  box-shadow: 0 30px 80px rgba(0,0,0,.22);
}
.clipHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
.clipTitle{font-weight:900}
.clipBody{display:flex; flex-direction:column; gap:12px}
.clipRow{display:grid; grid-template-columns: 64px 1fr 96px; gap:10px; align-items:center}
.clipLab{font-weight:800; color: var(--muted)}
.clipNum{border:1px solid var(--line); background: var(--btnbg); color:var(--txt); padding:9px 10px; border-radius:12px; width:96px}
.clipSeg{border:1px solid var(--line); background: var(--chipbg); padding:8px 10px; border-radius:14px; font-variant-numeric: tabular-nums}
@media (max-width: 980px){
  .kgGrid{grid-template-columns: 1fr; }
  .kgCol{min-height: 260px;}
  .p1Player{top: 8px;}
}

.musicWrap{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; margin-top:14px}
@media (max-width: 980px){ .musicWrap{grid-template-columns:1fr} }
.musicCol{border:1px solid var(--line); border-radius:20px; overflow:hidden; background: color-mix(in srgb, var(--btnbg) 86%, transparent)}
.musicHead{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px 12px; border-bottom:1px solid var(--line); background: color-mix(in srgb, var(--panel) 82%, transparent)}
.mhTitle{font-weight:900}
.mhTools{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
.inp{
  border:1px solid var(--line); background: color-mix(in srgb, var(--btnbg) 92%, transparent);
  color:var(--text); border-radius:14px; padding:10px 12px; outline:none; min-width:220px;
}
.musicList{padding:10px; display:flex; flex-direction:column; gap:8px; max-height:420px; overflow:auto}
.track{
  display:flex; gap:10px; align-items:center; justify-content:flex-start;
  padding:10px 10px; border:1px solid var(--line); border-radius:16px;
  background: color-mix(in srgb, var(--panel) 74%, transparent);
}
.track.active{border-color: color-mix(in srgb, var(--p2) 55%, var(--line)); box-shadow: 0 12px 24px rgba(109,92,255,.14)}
.trLeft{display:flex; gap:10px; align-items:center; min-width:0}
.trIcon{
  width:38px; height:38px; border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  background: linear-gradient(135deg, color-mix(in srgb, var(--p2) 26%, transparent), color-mix(in srgb, var(--p4) 18%, transparent));
  border:1px solid var(--line);
  flex: 0 0 auto;
}
.trText{min-width:0}
.trName{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:420px}
.trSub{font-size:12px; opacity:.75; margin-top:2px}
.trActs{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
.playerBar{
  margin-top:14px;
  border:1px solid var(--line);
  border-radius:22px;
  padding:10px 12px;
  display:flex; gap:12px; align-items:center; justify-content:flex-start;
  background: linear-gradient(135deg, color-mix(in srgb, var(--panel) 76%, transparent), color-mix(in srgb, var(--btnbg) 86%, transparent));
}
.miniCover{
  width:44px; height:44px; border-radius:16px;
  display:flex; align-items:center; justify-content:center;
  border:1px solid var(--line);
  background: radial-gradient(circle at 30% 30%, color-mix(in srgb, var(--p3) 18%, transparent), transparent 70%);
  font-weight:900;
  flex: 0 0 auto;
}
.playerInfo{flex:1; min-width:0}
.npTitle{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.seekRow{display:flex; gap:10px; align-items:center; margin-top:6px}
.seekRow input[type=range]{width:100%}
.playerCtrl{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
.volRow{display:flex; gap:6px; align-items:center; min-width:140px}
.volRow input[type=range]{width:100%}
.trimGrid{display:grid; grid-template-columns: 1fr .95fr; gap:12px; margin-top:10px}
@media (max-width: 980px){ .trimGrid{grid-template-columns:1fr} }
#wave{width:100%; border:1px solid var(--line); border-radius:16px; background: color-mix(in srgb, var(--btnbg) 90%, transparent)}
.rangeRow{display:flex; gap:10px; align-items:center; margin-top:10px}
.rangeRow input[type=range]{width:100%}

/* =========================
   v2.0 Additions
   ========================= */
.gen-grid{grid-template-columns: 380px 1fr;}
@media (max-width:1100px){ .gen-grid{grid-template-columns:1fr;} }
.titleList{display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr));}

/* Lines module */
.linesLayout{display:grid; grid-template-columns: 280px 1fr 1fr; gap:14px; margin-top:14px;}
@media (max-width:1100px){ .linesLayout{grid-template-columns:1fr; } }
.linesTools .input{width:100%}
.linesTools .rowBtns{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}
.linesCats{display:flex; flex-direction:column; gap:8px; margin-top:10px; max-height:520px; overflow:auto; padding-right:6px;}
.linesCats .catBtn{
  text-align:left; width:100%;
  padding:10px 12px;
  border:1px solid var(--line);
  background: color-mix(in srgb, var(--btnbg) 82%, transparent);
  border-radius:14px;
  cursor:pointer;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.linesCats .catBtn.active{outline:2px solid color-mix(in srgb, var(--accent) 55%, transparent);}
.linesCats .catBtn .cmeta{font-size:12px; color:color-mix(in srgb, var(--text) 65%, transparent)}
.linesMidHead{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:10px}
.linesList{display:flex; flex-direction:column; gap:10px; max-height:560px; overflow:auto; padding-right:6px;}
.lineCard{
  border:1px solid var(--line);
  background: color-mix(in srgb, var(--btnbg) 86%, transparent);
  border-radius:16px;
  padding:12px;
  cursor:pointer;
}
.lineCard.active{outline:2px solid color-mix(in srgb, var(--accent) 55%, transparent);}
.lineCard .t{font-weight:900; line-height:1.25}
.lineCard .m{margin-top:6px; font-size:12px; color:color-mix(in srgb, var(--text) 68%, transparent); display:flex; gap:8px; flex-wrap:wrap}
.edTitle{
  border:1px solid var(--line);
  background: color-mix(in srgb, var(--btnbg) 84%, transparent);
  border-radius:14px;
  padding:10px 12px;
  font-weight:900;
  min-height:42px;
}

/* Timeline editor */
.timelineBox{
  border:1px solid var(--line);
  border-radius: var(--radius-xl);
  padding:12px;
  background: linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, transparent), color-mix(in srgb, var(--card2) 95%, transparent));
}
.timelineWrap{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:14px;
  overflow:hidden;
}
.timelineHead{
  display:grid;
  grid-template-columns: 110px 1.2fr 1.2fr 120px;
  gap:10px;
  padding:10px 12px;
  background: color-mix(in srgb, var(--btnbg) 88%, transparent);
  font-size:12px;
  color:color-mix(in srgb, var(--text) 72%, transparent);
}
.timelineRow{
  display:grid;
  grid-template-columns: 110px 1.2fr 1.2fr 120px;
  gap:10px;
  padding:10px 12px;
  border-top:1px solid var(--line);
  align-items:center;
}
.timelineRow .tname{
  padding:8px 10px;
  border:1px solid var(--line);
  background: color-mix(in srgb, var(--btnbg) 84%, transparent);
  border-radius:12px;
  font-weight:800;
}
.timelineRow .tnote{
  padding:8px 10px;
  border:1px solid var(--line);
  background: color-mix(in srgb, var(--btnbg) 84%, transparent);
  border-radius:12px;
}
.timelineRow .tact{display:flex; gap:8px; justify-content:flex-end}
.timelineRow .drag{
  cursor:grab;
  user-select:none;
  padding:6px 10px;
  border:1px dashed var(--line);
  border-radius:12px;
  font-size:12px;
  color:color-mix(in srgb, var(--text) 70%, transparent);
}

/* Save prompt overlay */
.prompt{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  background: rgba(0,0,0,.45);
  z-index: 9999;
  padding:16px;
}
.prompt.show{display:flex;}
.promptPanel{
  width:min(560px, 100%);
  border:1px solid var(--line);
  border-radius: 20px;
  background: var(--card);
  box-shadow: 0 20px 60px rgba(0,0,0,.25);
  padding:16px;
}
.promptTitle{font-weight:1000; font-size:18px;}
.promptSub{margin-top:6px; color:color-mix(in srgb, var(--text) 70%, transparent); font-size:13px; line-height:1.5}
.promptBtns{display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap; margin-top:14px;}


/* =========================
   v2.3 Final patches
========================= */

/* Title library layout fix (avoid one-char-per-line) */
.titleList{display:grid !important; grid-template-columns:repeat(auto-fit, minmax(340px, 1fr)) !important; gap:12px !important;}
.titleItem{padding:14px !important;}
.titleTop{display:grid !important; grid-template-columns: 1fr auto; gap:12px !important; align-items:start !important;}
.titleText{min-width: 260px; overflow-wrap: break-word !important; word-break: break-word !important; line-height:1.35 !important;}
.titleActions{justify-content:flex-end !important; align-items:flex-start !important;}
@media (max-width:820px){
  .titleTop{grid-template-columns:1fr !important;}
  .titleActions{justify-content:flex-start !important;}
}

/* Lines tips compact */
.tipsCompact{padding:12px !important;}
.tipsCompact h3{font-size:14px !important; margin-bottom:8px !important;}
.tipsCompact .list{gap:6px !important;}
.tipsCompact .list li{font-size:13px !important; line-height:1.45 !important;}

/* Line picker overlay */
.picker{position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; background:rgba(0,0,0,.45); z-index:9999;}
.picker.show{display:flex;}
.pickerPanel{width:min(980px, 100%); max-height: min(760px, 92vh); overflow:hidden;
  background: var(--card); border:1px solid var(--line); border-radius:22px; box-shadow:0 30px 80px rgba(0,0,0,.25);
  display:flex; flex-direction:column;
}
.pickerHead{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:14px; border-bottom:1px solid var(--line);}
.pickerTitle{font-weight:1000; font-size:16px;}
.pickerSub{margin-top:6px;}
.pickerBody{display:grid; grid-template-columns: 260px 1fr; gap:12px; padding:14px; overflow:hidden;}
@media (max-width:900px){ .pickerBody{grid-template-columns:1fr;} }
.pickerLeft{border:1px solid var(--line); border-radius:16px; padding:12px; background: color-mix(in srgb, var(--btnbg) 86%, transparent); overflow:hidden;}
.pickerCats{margin-top:10px; display:flex; flex-direction:column; gap:8px; max-height: 420px; overflow:auto; padding-right:6px;}
.pickerCats .catBtn{width:100%; text-align:left; padding:10px 12px; border:1px solid var(--line); background: color-mix(in srgb, var(--btnbg) 84%, transparent); border-radius:14px; cursor:pointer; display:flex; justify-content:space-between; gap:10px;}
.pickerCats .catBtn.active{outline:2px solid color-mix(in srgb, var(--accent) 55%, transparent);}
.pickerRight{border:1px solid var(--line); border-radius:16px; padding:12px; overflow:hidden; background: color-mix(in srgb, var(--btnbg) 86%, transparent);}
.pickerList{display:flex; flex-direction:column; gap:10px; max-height: 520px; overflow:auto; padding-right:6px;}
.pItem{border:1px solid var(--line); background: color-mix(in srgb, var(--card) 90%, transparent); border-radius:16px; padding:12px; cursor:pointer;}
.pItem .t{font-weight:1000; line-height:1.25}
.pItem .s{margin-top:6px; font-size:12px; color: color-mix(in srgb, var(--text) 70%, transparent);}
.pickerFoot{padding:12px 14px; border-top:1px solid var(--line);}

/* Music: categories row + library slider */
.kgCats{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
.kgCats .chipBtn{
  display:inline-flex; align-items:center; gap:6px;
  padding:8px 12px; border-radius:999px; border:1px solid var(--line);
  background: var(--chipbg); cursor:pointer; font-weight:800; font-size:12px;
}
.kgCats .chipBtn.active{outline:2px solid color-mix(in srgb, var(--accent) 55%, transparent);}
.kgCats .chipBtn.editing{outline:2px dashed color-mix(in srgb, var(--accent) 55%, transparent);}
.kgCats .chipBtn .x{opacity:.65; font-weight:900}
.kgScroll{display:flex; gap:10px; align-items:center; margin-top:10px;}
.kgScroll .lab{font-size:12px; color: color-mix(in srgb, var(--text) 70%, transparent);}
.kgScroll input{flex:1}

/* Music: category hide + vertical resizer */
#kgColLib.catsHidden #libCats{display:none!important;}
#kgColLib.catsHidden .kgScroll{margin-top:0!important;}
.kgVResizer{
  height:26px; margin-top:6px; border-radius:14px;
  cursor:row-resize; position:relative; user-select:none; touch-action:none;
  background: color-mix(in srgb, var(--btnbg) 70%, transparent);
}
.kgVResizer::after{
  content:"⋯⋯⋯";
  position:absolute;
  left:50%; top:50%; transform:translate(-50%,-55%);
  font-weight:900; letter-spacing:2px;
  color: color-mix(in srgb, var(--text) 45%, transparent);
  font-size:12px;
  pointer-events:none;
}
.kgVResizer::before{
  content:"";
  position:absolute;
  left:12px; right:12px;
  top:50%; height:2px; transform:translateY(-50%);
  border-radius:999px;
  background: color-mix(in srgb, var(--line) 85%, transparent);
}
.kgVResizer:hover::before{background: color-mix(in srgb, var(--p2) 55%, transparent);}
.kgVResizer.dragging::before{background: var(--p2);}

.kgItem.placeholder{border:2px dashed color-mix(in srgb, var(--p2) 45%, var(--line)); background:transparent;}
.kgItem.pdrag{box-shadow:0 18px 45px rgba(0,0,0,.18); opacity:.96;}
.chipRename{width:110px; max-width:160px; font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background: color-mix(in srgb, var(--card) 92%, transparent); color:var(--text);}
.kgDragHandle{
  width:24px; height:28px; display:grid; place-items:center;
  border:1px solid var(--line); border-radius:10px;
  background: color-mix(in srgb, var(--btnbg) 88%, transparent);
  cursor:grab; user-select:none;
}
.kgDragHandle:active{cursor:grabbing;}

/* Music: draggable clip drawer + waveform */
.clipDrawer{cursor:default;}
.clipHandle{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:10px 12px; border:1px dashed var(--line); border-radius:16px;
  background: color-mix(in srgb, var(--btnbg) 84%, transparent);
  user-select:none;
}
.clipHandle .h{font-weight:1000}
.clipHandle .m{font-size:12px; color: color-mix(in srgb, var(--text) 70%, transparent);}
.clipWaveWrap{margin-top:10px; border:1px solid var(--line); border-radius:16px; overflow:hidden; background: color-mix(in srgb, var(--card) 92%, transparent);}
.clipWave{width:100%; height:120px; display:block;}
.clipWaveHint{display:flex; justify-content:space-between; gap:10px; padding:8px 10px; font-size:12px; color: color-mix(in srgb, var(--text) 70%, transparent);}


/* =========================
   v2.4 Music layout patch
   - library moved to left
   - resizable panes + collapse
   - queue card sizing buttons
   ========================= */
#viewMusic .grid{grid-template-columns:1fr;}
#viewMusic .aside{display:none!important;}

.kgBar{display:flex; gap:10px; align-items:center; justify-content:flex-start; flex-wrap:wrap; margin-top:10px}
.kgBarBtns{display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end}

.kgWrap{position:relative; margin-top:10px}
#kgGrid{
  --kgLibW: 340px;
  --kgPlW: 240px;
  --kgRes1: 44px;
  --kgRes2: 44px;
  display:grid;
  grid-template-columns: var(--kgLibW) var(--kgRes1) var(--kgPlW) var(--kgRes2) minmax(420px, 1fr);
  gap:0;
  align-items:stretch;
  margin-top:8px;
}
#kgGrid .kgCol{min-width:0;}
.kgResizer{cursor:col-resize; position:relative; user-select:none; touch-action:none; z-index:8; background:transparent; height:100%; min-height:360px;}
.kgResizer:hover{background: color-mix(in srgb, var(--btnbg) 55%, transparent);}
.kgResizer::before{
  content:"";
  position:absolute;
  left:50%;
  top:14px;
  bottom:14px;
  width:2px;
  transform:translateX(-50%);
  border-radius:999px;
  background: color-mix(in srgb, var(--line) 85%, transparent);
}
.kgResizer:hover::before{background: color-mix(in srgb, var(--p2) 55%, transparent);}
.kgResizer.dragging::before{background: var(--p2);}

#kgGrid.kgLibCollapsed{ --kgLibW:56px; --kgRes1:0px; }

#kgGrid.kgLibCollapsed .kgResizer[data-resize="lib"]{display:none!important;}
#kgGrid.kgLibCollapsed #kgColLib{display:flex!important; padding:12px 8px!important;}
#kgGrid.kgLibCollapsed #kgColLib .kgHeadRight,
#kgGrid.kgLibCollapsed #kgColLib #libCats,
#kgGrid.kgLibCollapsed #kgColLib #libDrop,
#kgGrid.kgLibCollapsed #kgColLib #libList,
#kgGrid.kgLibCollapsed #kgColLib #libVResizer,
#kgGrid.kgLibCollapsed #kgColLib .kgScroll{display:none!important;}
#kgGrid.kgLibCollapsed #kgColLib .kgHead{justify-content:center; border-bottom:none;}
#kgGrid.kgLibCollapsed #kgColLib .kgTitle{writing-mode:vertical-rl; text-orientation:mixed; letter-spacing:2px; font-weight:1000; font-size:13px; margin:0; text-align:center;}
#kgGrid.kgLibCollapsed #kgColLib{align-items:center; justify-content:center; cursor:pointer;}
#kgGrid.kgLibCollapsed #kgColLib::after{content:"⟫"; margin-top:10px; font-size:16px; color: color-mix(in srgb, var(--text) 55%, transparent);}
#kgGrid.kgLeftCollapsed{ --kgLibW:0px; --kgPlW:0px; --kgRes1:0px; --kgRes2:0px; }

#kgGrid.kgLeftCollapsed #kgColLib,
#kgGrid.kgLeftCollapsed #kgColPl{
  padding:0!important;
  border:none!important;
  opacity:0;
  pointer-events:none;
  overflow:hidden;
}

#kgGrid.kgLibCollapsed #kgColPl{opacity:1; pointer-events:auto;}
/* v2.6.18 fix: collapsing/resizing music library should not change height (avoid stacking) */
#musicSystem #kgGrid{height:min(74vh, 720px)!important; min-height:420px; grid-template-rows:1fr; align-content:stretch;}
#musicSystem #kgGrid > .kgCol,
#musicSystem #kgGrid > .kgResizer{height:100%;}
#musicSystem #kgColLib{height:100%;}
#musicSystem #kgGrid.kgLibCollapsed #kgColLib{height:100%!important;}

/* ===== Music Player Mode Switch (Built-in vs P1 Console) ===== */
.msModeBar{
  display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  margin: 10px 0 14px;
}
.msModeBar .seg{
  display:inline-flex; align-items:stretch;
  border:1px solid var(--line);
  border-radius:999px; overflow:hidden;
  background: color-mix(in srgb, var(--card2) 70%, transparent);
}
.msModeBar .seg .segbtn{
  padding:8px 12px; font-size:13px; line-height:1;
  color: var(--muted);
  background: transparent;
  border:0; cursor:pointer;
}
.msModeBar .seg .segbtn.on{
  color: var(--txt);
  background: color-mix(in srgb, var(--brand) 14%, transparent);
}

/* External tools button (placed next to P1) + panel styling */
#musicSystem #btnMusicExtTools{ white-space:nowrap; }
#musicSystem #extTools{ scroll-margin-top: 90px; }
#musicSystem #extTools > summary{ display:none; }
#musicSystem #extTools::before{ content:"🔗 外部工具入口"; display:block; font-weight:700; font-size:14px; margin: 2px 0 10px; color: var(--txt); }
.msModeBar .hint{
  margin-left:auto;
  font-size:12px;
  color: var(--muted);
}
#msP1Wrap{
  margin-top: 6px;
  display:none;
}
body[data-music-mode="p1"] #msP1Wrap{ display:block; }
#p1ConsoleFrame{
  width:100%;
  height: var(--p1ConsoleH, min(92vh, 1120px));
  border:1px solid var(--line);
  border-radius:18px;
  background: var(--card2);
  box-shadow: var(--shadow2);
}
#p1SizeBar{
  margin-top:8px;
  display:none;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
body[data-music-mode="p1"] #p1SizeBar{ display:flex; }
#p1HeightRange{ width: min(360px, 46vw); }
#p1HeightLabel{ min-width: 70px; text-align:right; }

body[data-p1-fullscreen="1"] #msP1Wrap{
  position: fixed;
  inset: 0;
  margin: 0;
  padding: 12px;
  background: var(--bg);
  z-index: 99999;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
body[data-p1-fullscreen="1"] #msP1Wrap .muted{ display:none; }
body[data-p1-fullscreen="1"] #p1ConsoleFrame{
  flex: 1 1 auto;
  height: auto !important;
}
body[data-p1-fullscreen="1"] #p1SizeBar{
  display:flex;
  position: sticky;
  top: 0;
  padding: 10px 12px;
  border: 1px solid var(--line);
  border-radius: 16px;
  background: color-mix(in srgb, var(--bg) 88%, transparent);
  box-shadow: var(--shadow2);
  z-index: 2;
}



/* P1：满屏时只保留一条极简顶栏 */
#p1MiniBar{
  display:none;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:16px;
  background: color-mix(in srgb, var(--card2) 86%, transparent);
  box-shadow: var(--shadow2);
}
#p1MiniBar .p1MiniLeft{display:flex; align-items:center; gap:10px; min-width:0;}
#p1MiniBar .p1MiniTitle{font-weight:900; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 42vw;}
#p1MiniBar .p1MiniRight{display:flex; align-items:center; gap:8px;}

body[data-p1-fullscreen="1"]{ overflow:hidden; }
body[data-p1-fullscreen="1"] #p1MiniBar{ display:flex; }
body[data-p1-fullscreen="1"] .msModeBar{ display:none !important; }

/* 当前队列：条形 / 方块（方块卡片） */
body[data-queue-grid="1"] #queueList{
  /* grid mode: tighten spacing, keep cards compact */
  --qPad: 10px;
  --qBtnFont: 11px;
  --qBtnPadY: 6px;
  --qBtnPadX: 8px;
  display:grid !important;
  grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
  gap:8px;
  align-content:start;
  padding-right:4px; /* keep scrollbar gutter behavior */
}
body[data-queue-grid="1"] #queueList .kgItem{
  width:auto !important;
  display:flex;
  flex-direction:column;
  align-items:stretch;
  justify-content:flex-start;
  gap:8px;
  aspect-ratio: 1 / 1;
  overflow:hidden;
}
body[data-queue-grid="1"] #queueList .kgLeft{
  width:100%;
  min-width:0;
}
body[data-queue-grid="1"] #queueList .kgName{
  white-space:normal;
  overflow:hidden;
  display:-webkit-box;
  -webkit-line-clamp:3;
  -webkit-box-orient: vertical;
}
body[data-queue-grid="1"] #queueList .kgSub{
  white-space:normal;
  overflow:hidden;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient: vertical;
}
body[data-queue-grid="1"] #queueList .kgRight{
  margin-top:6px; /* was auto: keeps content from being too dispersed */
  display:flex;
  justify-content:flex-end;
  gap:6px;
  flex-wrap:wrap;
}
body[data-queue-grid="1"] #queueList .sbtn{
  border-radius:14px;
}
/* 永久隐藏：当前播放标题下的提示行（如果存在） */
.panelHeader .sub{ display:none !important; }

/* 当前播放区：紧凑模式（给播放列表/队列更多高度） */
.nowWaveWrap{ margin-top:10px; }
.nowProg{ margin-top:10px; }
.nowTimeRow{ margin-top:10px; }
body[data-now-compact="1"] .rightTop .cardBody{ padding:10px; }
body[data-now-compact="1"] .bigWave{ height:86px; }
body[data-now-compact="1"] .nowWaveWrap,
body[data-now-compact="1"] .nowProg,
body[data-now-compact="1"] .nowTimeRow{ margin-top:6px; }
body[data-now-compact="1"] #nowMeta{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

body[data-music-mode="p1"] #msBuiltinWrap{ display:none; }
body[data-music-mode="builtin"] #msP1Wrap{ display:none; }

/* === v2.6.25: UVR 独立页面（伴奏制作） === */
#msUvrPage{ display:none; margin-top:12px; }
.msUvrTop{ display:flex; align-items:center; gap:10px; padding:6px 4px 10px; }
.msUvrTop #uvrPageHint{ margin-left:auto; }
body[data-music-page="uvr"] #msBuiltinWrap,
body[data-music-page="uvr"] #msP1Wrap{ display:none !important; }
body[data-music-page="uvr"] #msUvrPage{ display:block; }
body[data-music-page="uvr"] #p1SizeBar{ display:none !important; }
/* === v2.6.24: UVR 引擎（伴奏制作） === */
.uvrCol{ min-height:auto; margin-top:12px; }
.uvrGrid{ display:grid; grid-template-columns: 1.1fr .9fr; gap:12px; }
@media (max-width: 980px){ .uvrGrid{ grid-template-columns: 1fr; } }
.uvrRow{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.uvrRow .inp, .uvrRow select.inp{ min-width: 220px; }
.uvrPresetRow{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.uvrMeta{ font-size:12px; color:var(--muted); margin-top:2px; }
.uvrBadge{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 10px; border-radius:999px; border:1px solid var(--line);
  background: color-mix(in srgb, var(--card2) 85%, transparent);
  font-size:12px; color:var(--muted);
}
.uvrProgress{
  height:10px; width:100%;
  background: color-mix(in srgb, var(--card2) 72%, transparent);
  border:1px solid var(--line); border-radius:999px; overflow:hidden;
}
.uvrProgress > div{ height:100%; width:0%; background: var(--accent); transition: width .18s ease; }
.uvrPreview{ display:none; margin-top:2px; padding-top:2px; }
.uvrPreview audio{ width:100%; }
.uvrDetails summary{ list-style:none; }
.uvrDetails summary::-webkit-details-marker{ display:none; }



/* v2.6.18: playlist card compact layout (title above controls, remove helper text) */
.kgPlItem{display:grid!important; grid-template-columns:1fr; grid-template-rows:auto auto; gap:8px; align-items:center;}
.kgPlItem .kgLeft{display:flex; align-items:baseline; justify-content:space-between; gap:12px; min-width:0;}
.kgPlItem .kgName{font-weight:900; font-size:14px; line-height:1.15; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
.kgPlItem .kgSub{font-size:12px; color:var(--muted); white-space:nowrap;}
.kgPlItem .kgRight{display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;}

#kgGrid.kgLeftCollapsed #kgColQueue{grid-column:1/-1;}

.kgReopen{
  position:absolute;
  left:10px;
  top:50%;
  transform:translateY(-50%);
  display:none;
  z-index:12;
  padding:10px 10px;
  border-radius:16px;
  border:1px solid var(--line);
  background: color-mix(in srgb, var(--card2) 90%, transparent);
  box-shadow: var(--shadow2);
  cursor:pointer;
}
#kgWrap.leftCollapsed .kgReopen{display:inline-flex;}

.kgQueueFoot{
  margin-top:10px;
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:8px;
}
.kgQueueFoot .sbtn{border-radius:14px;}

#queueList .kgItem{width:100%;}
#queueList .kgName{overflow-wrap:break-word; word-break:break-word; line-height:1.22;}
#queueList{
  --qPad: 10px;
  --qName: 13px;
  --qSub: 12px;
  --qBtnFont: 12px;
  --qBtnPadY: 8px;
  --qBtnPadX: 10px;
}
#queueList .kgItem{padding: var(--qPad);}
#queueList .kgName{font-size: var(--qName);}
#queueList .kgSub{font-size: var(--qSub);}
#queueList .sbtn{font-size: var(--qBtnFont); padding: var(--qBtnPadY) var(--qBtnPadX);}

#queueList .kgItem.playing{
  outline:3px solid color-mix(in srgb, var(--ok) 26%, transparent);
  border-color: color-mix(in srgb, var(--ok) 70%, var(--line));
  background: color-mix(in srgb, var(--ok) 6%, var(--btnbg) 94%);
}
#queueList .kgItem.played{
  border-color: color-mix(in srgb, var(--danger) 62%, var(--line));
  background: color-mix(in srgb, var(--danger) 6%, var(--btnbg) 94%);
}
#queueList .kgItem.playing .kgSub{color: color-mix(in srgb, var(--ok) 55%, var(--text));}
#queueList .kgItem.played .kgSub{color: color-mix(in srgb, var(--danger) 55%, var(--text));}

.kgResizer{touch-action:none;}
/* Category chips delete indicator */
.chipBtn .chipX{
  display:inline-flex;
  margin-left:8px;
  width:18px; height:18px;
  align-items:center; justify-content:center;
  border-radius:999px;
  border:1px solid var(--line);
  background: color-mix(in srgb, var(--btnbg2) 88%, transparent);
  font-weight:900;
  font-size:12px;
  line-height:1;
}
.chipBtn .chipX:hover{border-color: color-mix(in srgb, var(--danger) 55%, var(--line)); color: var(--danger);}
#plList .kgItem.dragging{opacity:.72; transform: scale(.995);}



@media (max-width:780px){
  #kgGrid{grid-template-columns:1fr;}
  .kgResizer{display:none;}
  #kgGrid.kgLeftCollapsed #kgColQueue{grid-column:auto;}
  #kgWrap.leftCollapsed .kgReopen{display:none;}
}


/* =========================
   v2.2 Patch: Music system UX fixes
========================= */
#musicSystem #kgGrid{height:min(72vh, 720px);}
#musicSystem #kgGrid .kgCol{height:100%; min-height:420px;}
#musicSystem #kgGrid .kgList{-webkit-overflow-scrolling:touch; overscroll-behavior:contain; scrollbar-gutter:stable;}
#musicSystem .p1Btns .iconbtn{width:46px;height:46px;border-radius:18px;font-size:20px;line-height:1;}
#musicSystem .p1Btns .iconbtn.primary{width:54px;height:54px;border-radius:20px;font-size:22px;}
#musicSystem .p1Btns .iconbtn.active{outline:2px solid color-mix(in srgb, var(--p2) 65%, transparent); color:var(--text);}
#musicSystem .kgCats .chipBtn{position:relative;}
#musicSystem .kgCats .chipDel{margin-left:8px;display:inline-flex;width:18px;height:18px;align-items:center;justify-content:center;border-radius:9px;opacity:.75;font-weight:900;}
#musicSystem .kgCats .chipDel:hover{background:color-mix(in srgb, var(--danger) 22%, transparent);opacity:1;}
#musicSystem .kgItem.plDragging{opacity:.55;}
#musicSystem .kgItem.plOver{outline:2px dashed color-mix(in srgb, var(--p2) 55%, transparent);}

/* =========================
   v2.3 Music fixes
   - stable scroll areas
   - bigger player buttons
   - hide duplicate collapse button
========================= */
#kgGrid{height:min(74vh, 720px);}
#kgGrid .kgCol{min-height:0;}
#kgGrid .kgList{min-height:0;}
#kgColLib .kgList{overscroll-behavior:contain;}
#btnToggleLib{display:none!important;}
#btnReopenLeft{display:none!important;}

#p1Player .iconbtn{width:46px;height:46px;font-size:18px;}
#p1Player #btnPlay{width:56px;height:56px;font-size:20px;}
#p1Player .iconbtnRow{gap:10px;}
#modeHint{font-size:12px;}

.kgQMode{display:flex; gap:6px; align-items:center; padding:4px 8px; border:1px solid rgba(255,255,255,.12); border-radius:999px; background:rgba(0,0,0,.18);}
.kgQMode .sbtn{min-width:34px}
.kgQMode .sbtn.tgl.on{background:rgba(124,92,255,.22); border-color:rgba(124,92,255,.45);}



.miniSel{font-size:12px;padding:2px 6px;border-radius:10px;border:1px solid var(--line);background:var(--card2);color:var(--text);}


/* ---- v2.5 patches ---- */
.onecol{grid-template-columns:1fr !important;}
.tipsInline{padding:12px 14px;}
.tipsInline .tipsHead{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px}
.tipsInline .tipsTitle{font-weight:700; font-size:14px}
.tipsInline .list{margin:8px 0 0 0}
.social-left{grid-template-columns:360px 1fr !important;}
.social-left > main{grid-column:2;}
.social-left > aside{grid-column:1;}
@media (max-width:780px){
  .social-left{grid-template-columns:1fr !important;}
  .social-left > main, .social-left > aside{grid-column:auto;}
}

/* handbook nav to left */
.handbook-left{grid-template-columns:360px 1fr !important;}
.handbook-left > main{grid-column:2;}
.handbook-left > aside{grid-column:1;}
@media (max-width:780px){
  .handbook-left{grid-template-columns:1fr !important;}
  .handbook-left > main, .handbook-left > aside{grid-column:auto;}
}


/* keep left nav visible & aligned (desktop/tablet) */
.social-left, .handbook-left{align-items:start;}
.social-left > aside, .handbook-left > aside{
  position:sticky;
  top:92px;
  align-self:start;
  max-height:calc(100vh - 120px);
  overflow:auto;
}
@media (max-width:780px){
  .social-left > aside, .handbook-left > aside{
    position:static;
    max-height:none;
    overflow:visible;
  }
}

/* music player icon size */
.p1Player .p1Btns .iconbtn{width:46px;height:46px;font-size:20px;border-radius:18px}
.p1Player .p1Btns .iconbtn.primary{width:68px;height:68px;font-size:28px;border-radius:24px}

/* queue status colors (green=playing, red=played) */
.kgQueueList .kgItem.playing{border-color:#00c853; background: rgba(0,200,83,.08);}
.kgQueueList .kgItem.played{border-color:#ff1744; background: rgba(255,23,68,.06);}
.kgQueueList .kgItem.playing .kgName{color:#00c853; font-weight:900;}
.kgQueueList .kgItem.played .kgName{color:#ff1744;}


/* Schedule: finance fields + yearly summary */
.checkRow{display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--line); border-radius:14px; background: var(--card2);}
.checkRow input{width:18px; height:18px;}
.ys-card{margin-top:16px; padding:14px; border:1px solid var(--line); border-radius:20px; background: var(--card); box-shadow: var(--shadow);}
.ys-head{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:12px;}
.ys-title{font-weight:1000; font-size:18px;}
.ys-sub{color:var(--muted); font-size:13px; margin-top:4px;}
.ys-actions{display:flex; align-items:center; gap:10px;}
.ys-select{padding:10px 12px; border-radius:14px; border:1px solid var(--line); background: var(--card2); color: var(--text); font-weight:800;}
.ys-stats{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:12px;}
.ys-stat{padding:12px; border:1px solid var(--line); border-radius:16px; background: var(--card2);}
.ys-stat .k{font-size:12px; color:var(--muted); font-weight:800;}
.ys-stat .v{font-size:22px; font-weight:1000; margin-top:6px;}
.ys-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:6px;}
.ys-panel{padding:12px; border:1px solid var(--line); border-radius:18px; background: var(--card2);}
.ys-panel-title{font-weight:950; font-size:13px; margin-bottom:8px; color:var(--text);}
.ys-hotel-list{display:flex; flex-direction:column; gap:8px; max-height:210px; overflow:auto; padding-right:6px;}
.ys-hotel-item{display:flex; justify-content:space-between; gap:10px; padding:10px 12px; border:1px solid var(--line); border-radius:14px; background: rgba(255,255,255,.04);}
.ys-hotel-item .name{font-weight:900;}
.ys-hotel-item .cnt{font-weight:1000; color:var(--muted);}
.ys-table-wrap{margin-top:12px;}
.ys-table table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:16px; border:1px solid var(--line);}
.ys-table th,.ys-table td{padding:10px 12px; font-size:13px; border-bottom:1px solid var(--line);}

/* ---- Schedule / Year Summary toggle ---- */
.ys-topbar{display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin:2px 0 10px;}
.schedule.ysMode .sched-main{display:none;}
.schedule.ysMode #yearSummaryPage{display:block;}
#yearSummaryPage.hidden{display:none;}
/* make year summary calmer & consistent */
.ys-title{font-size:20px; letter-spacing:.2px}
.ys-sub{font-size:14px}
.ys-stat .k{font-size:13px}
.ys-stat .v{font-size:20px}
.ys-panel-title{font-size:14px}

/* ---- Topic Analyzer: output layout ---- */
.topiclist.ta{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px;}
.topiclist.ta .taItem{border:1px solid var(--line); background:var(--card2); border-radius:18px; padding:12px; display:flex; flex-direction:column; gap:10px; min-width:0;}
.topiclist.ta .taHead{display:flex; align-items:center; justify-content:space-between; gap:10px;}
.topiclist.ta .taNo{font-weight:1000; font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.04); min-width:44px; text-align:center;}
.topiclist.ta .taTitle{font-weight:950; font-size:15px; line-height:1.35; text-align:left; word-break:break-word; overflow-wrap:anywhere; white-space:normal; cursor:pointer;}
@media (max-width: 980px){ .topiclist.ta{grid-template-columns:1fr;} }

/* ---- Year Summary: make it denser + add editable notes ---- */
.ys-grid{gap:10px}
.ys-panel{padding:10px}
.ys-panel canvas{width:100%; height:160px;}
#ysChartMix{height:180px;}
.ys-hotel-list{max-height:180px;}
.ys-notes{grid-column:1/-1;}
.ys-notes-ta{width:100%; border:1px solid var(--line); background:rgba(255,255,255,.03); color:var(--text); border-radius:16px; padding:12px; min-height:120px; line-height:1.5; resize:vertical;}
.ys-note-actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}


.ys-table th{background: rgba(255,255,255,.06); text-align:left; font-weight:1000;}
.ys-table tr:last-child td{border-bottom:none;}
@media (max-width: 980px){
  .ys-stats{grid-template-columns:repeat(2,1fr);}
  .ys-grid{grid-template-columns:1fr;}
}


/* -------------------------
   Patch v2.6.3: usability fixes
--------------------------*/
.schedule{display:grid; grid-template-columns: 1fr; gap:14px; align-items:start;}
.sched-main{min-width:0;}
.sched-side{min-width:0; position:sticky; top:88px; align-self:start;}
@media (max-width: 1120px){
  .schedule{grid-template-columns:1fr;}
  .sched-side{position:static;}
}

/* Social topics: shorter layout */
.topiclist{display:grid; grid-template-columns:1fr; gap:10px; max-height:520px; overflow:auto; padding-right:4px;}
@media (min-width: 1060px){
  .topiclist{grid-template-columns:1fr 1fr;}
}
.topicrow{padding:10px; border-radius:14px;}
.topicrow .tmeta{gap:6px;}
.topicrow .sbtn{padding:6px 10px; font-size:12px;}
.topicrow details.soft>summary{font-size:12px;}

/* Music controls: bigger tap targets */
.p1Btns .iconbtn{width:50px; height:50px; font-size:22px; border-radius:14px;}
.p1Btns .iconbtn.primary{width:56px; height:56px; font-size:24px;}


/* Music: per-playlist play mode buttons */
.plModeBtn{min-width:44px; padding:8px 10px; border-radius:999px;}
.plModeBtn.on{
  border-color: color-mix(in srgb, var(--p2) 70%, var(--line));
  background: color-mix(in srgb, var(--p2) 18%, var(--btnbg));
  color: var(--p2);
  font-weight:1000;
}
#plList .kgRight{flex-wrap:wrap; justify-content:flex-end;}

/* === Fix: Lines module category readability in neon/dark === */
html[data-theme="neon"] #viewLines .muted-small{color: rgba(242,244,255,.78);}
html[data-theme="neon"] #viewLines .linesCats .catBtn{
  background: rgba(16,18,34,.92) !important;
  border-color: rgba(240,245,255,.18) !important;
  color: #f2f4ff !important;
}
html[data-theme="neon"] #viewLines .linesCats .catBtn:hover{
  background: rgba(16,18,34,.98) !important;
  border-color: rgba(124,92,255,.35) !important;
}
html[data-theme="neon"] #viewLines .linesCats .catBtn .cmeta{
  color: rgba(242,244,255,.78) !important;
}
html[data-theme="neon"] #viewLines .linesCats .catBtn.active{
  outline: 2px solid rgba(124,92,255,.70) !important;
  background: rgba(16,18,34,.98) !important;
}


/* build badge */
#buildBadge{
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 2147483000;
  padding: 6px 10px;
  font-size: 12px;
  line-height: 1;
  border-radius: 999px;
  background: rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.18);
  color: rgba(255,255,255,.9);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  pointer-events: none;
}


/* -------------------------
   Music view: full-width (avoid left/right blank)
--------------------------*/
#viewMusic{
  width:100vw;
  margin-left:calc(50% - 50vw);
  margin-right:calc(50% - 50vw);
  padding-left:18px;
  padding-right:18px;
  box-sizing:border-box;
}
@media (max-width:900px){
  #viewMusic{padding-left:10px; padding-right:10px;}
}
/* The default .grid has a 2nd empty column (360px). Remove it in Music view. */
#viewMusic .grid{grid-template-columns:1fr !important;}
#viewMusic .grid > main{grid-column:1 / -1;}


/* === v2.6.34: KTV 歌词投放（LRC / Enhanced LRC） === */
#btnMusicKtv{ margin-left:6px; }
.ktvDetails{ margin-top:12px; border:1px solid var(--line); border-radius:16px; background:var(--card); overflow:hidden; }
.ktvDetails > summary{ list-style:none; cursor:pointer; user-select:none; padding:12px 14px; font-weight:900; display:flex; align-items:center; gap:10px; }
.ktvDetails > summary::-webkit-details-marker{ display:none; }
.ktvDetails .ktvBody{ padding:12px 14px 14px; border-top:1px solid var(--line); }
.ktvTools{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
.ktvGrid{ display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; margin-top:12px; }
@media (max-width: 980px){ .ktvGrid{ grid-template-columns:1fr; } }
.ktvViewer{ max-height:320px; overflow:auto; padding:4px; border:1px solid var(--line); border-radius:14px; background:var(--panel2); }
.ktvLine{ padding:8px 10px; border-radius:12px; margin:4px 0; color:var(--text); display:flex; gap:10px; align-items:flex-start; }
.ktvLine .t{ color:var(--muted); font-size:12px; min-width:64px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
.ktvLine .tx{ flex:1; line-height:1.3; word-break:break-word; }
.ktvLine.active{ background: color-mix(in srgb, var(--accent, #6cf) 18%, transparent); outline:1px solid color-mix(in srgb, var(--accent, #6cf) 40%, transparent); font-weight:900; }
.ktvMeta{ display:grid; gap:10px; }
.ktvMeta .field{ display:grid; gap:6px; }
.ktvMeta label{ color:var(--muted); font-size:12px; }
.ktvMeta .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
.ktvMeta .row2{ display:flex; flex-wrap:wrap; gap:10px 14px; align-items:center; }
.ktvMeta .row2 label{ font-size:12px; color:var(--muted); }

/* ---- Karaoke visual tokens ---- */
:root{
  --ktv-outline: rgba(0,0,0,.88);
  --ktv-unsung: rgba(255,255,255,.92);
  --ktv-sung:   rgba(120,255,220,.95);
  --ktv-hot-a:  #ffe27a;
  --ktv-hot-b:  #ff7a18;
  --ktv-hot-c:  #ff3b6b;
  --ktv-role-m: #6cf;
  --ktv-role-f: #ff6aa5;
  --ktv-role-d: #ffb0ff;
  --ktv-role-bg:#a6ff6a;
}
html[data-theme="cream"]{
  --ktv-outline: rgba(0,0,0,.86);
  --ktv-unsung: rgba(255,255,255,.95);
  --ktv-sung: rgba(0,255,190,.92);
}
html[data-theme="neon"]{
  --ktv-outline: rgba(0,0,0,.92);
  --ktv-unsung: rgba(255,255,255,.92);
  --ktv-sung: rgba(140,255,220,.98);
}

.ktvKLine{ white-space:pre-wrap; }
.ktvWord{
  display:inline-block;
  padding:0 .04em;
  color:var(--ktv-unsung);
  -webkit-text-stroke: 2px var(--ktv-outline);
  text-shadow:
    0 4px 18px rgba(0,0,0,.55),
    0 0 1px rgba(0,0,0,.6);
}
.ktvWord.sung{
  color:var(--ktv-sung);
  filter: saturate(1.08);
}
.ktvWord.hot{
  color: transparent;
  background: linear-gradient(90deg, var(--ktv-hot-a), var(--ktv-hot-b), var(--ktv-hot-c), var(--ktv-hot-a));
  background-size: 100% 100%;
  -webkit-background-clip:text;
  background-clip:text;
  -webkit-text-fill-color: transparent;
  filter: drop-shadow(0 8px 16px rgba(0,0,0,.50));
  animation: none;
}
@keyframes ktvShine{
  0%{ background-position: 0% 50%; }
  100%{ background-position: 100% 50%; }
}

/* ---- Overlay (fullscreen) ---- */
#ktvOverlay{ position:fixed; inset:0; display:none; z-index:99999; background:rgba(0,0,0,.92); backdrop-filter: blur(3px); }
#ktvOverlay.show{ display:flex; flex-direction:column; }
.ktvOverlayTop{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 14px; border-bottom:1px solid rgba(255,255,255,.12); color:#fff; }
.ktvOverlayTitle{ font-weight:900; letter-spacing:.5px; }
.ktvOverlayBody{ flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; padding:24px; text-align:center; }
.ktvRoleBadge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.35);
  color: rgba(255,255,255,.9);
  font-size:12px;
  letter-spacing:.5px;
}
.ktvRoleBadge i{ width:8px; height:8px; border-radius:50%; display:inline-block; background: var(--ktv-role-m); }
.ktvRoleBadge.role-f i{ background: var(--ktv-role-f); }
.ktvRoleBadge.role-d i{ background: var(--ktv-role-d); }
.ktvRoleBadge.role-bg i{ background: var(--ktv-role-bg); }

.ktvBigLine{ font-weight:1000; line-height:1.18; text-shadow:0 6px 22px rgba(0,0,0,.55); transform: translateZ(0); backface-visibility:hidden; -webkit-font-smoothing: antialiased; contain: paint; }
.ktvNextLine{ opacity:.52; line-height:1.2; color:rgba(255,255,255,.62); }
.ktvProgress{
  width: min(86vw, 980px);
  height: 10px;
  border-radius:999px;
  background: rgba(255,255,255,.10);
  border: 1px solid rgba(255,255,255,.14);
  overflow:hidden;
}
.ktvProgress > i{
  display:block;
  height:100%;
  width:0%;
  background: linear-gradient(90deg, var(--ktv-hot-a), var(--ktv-hot-b), var(--ktv-hot-c));
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.55));
}
.ktvHintLine{ opacity:.55; font-size:14px; margin-top:8px; }




/* === v2.6.35: KTV 面板现代化与紧凑布局 + 标准LRC高亮兜底 === */
.ktvDetails{
  margin-top:10px;
  border:1px solid var(--line, rgba(0,0,0,.10));
  border-radius:18px;
  background:var(--card, rgba(255,255,255,.90));
  overflow:hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,.04);
}
html[data-theme="neon"] .ktvDetails{
  border-color: rgba(255,255,255,.14);
  background: rgba(15,18,28,.55);
  box-shadow: 0 16px 44px rgba(0,0,0,.38);
}
.ktvDetails > summary{
  padding:10px 12px;
  gap:10px;
}
.ktvSumTitle{ font-weight:1000; }
.ktvSumRight{
  margin-left:auto;
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.ktvSumStatus{
  font-weight:900;
  font-size:12px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--line, rgba(0,0,0,.12));
  background: color-mix(in srgb, var(--panel2, #fff) 70%, transparent);
  color: var(--muted, #666);
}
html[data-theme="neon"] .ktvSumStatus{
  border-color: rgba(255,255,255,.18);
  background: rgba(0,0,0,.35);
  color: rgba(255,255,255,.78);
}
.ktvDetails .ktvBody{ padding:10px 12px 12px; }
.ktvTools{ gap:8px; }
.ktvTools .btn{ border-radius:12px; }
.ktvGrid{ gap:10px; margin-top:10px; }
.ktvViewer{
  max-height:210px;
  overflow:auto;
  padding:6px;
  border:1px solid var(--line, rgba(0,0,0,.10));
  border-radius:14px;
  background:var(--panel2, #f7f7fb);
}
html[data-theme="neon"] .ktvViewer{
  border-color: rgba(255,255,255,.14);
  background: rgba(0,0,0,.25);
}
.ktvLine{ padding:6px 8px; border-radius:12px; margin:3px 0; }
.ktvLine .t{ min-width:60px; font-size:11px; }
.ktvMeta{ gap:8px; }
.ktvMeta .field{ gap:4px; }
.ktvMeta label{ font-size:12px; }
.ktvMeta .twoCol{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
@media (max-width: 980px){ .ktvMeta .twoCol{ grid-template-columns:1fr; } }
.ktvToggle,
.ktvMeta .row2 label{
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--line, rgba(0,0,0,.10));
  background: color-mix(in srgb, var(--panel2, #fff) 70%, transparent);
  display:flex;
  align-items:center;
  gap:8px;
  color: var(--muted, #666);
}
html[data-theme="neon"] .ktvToggle,
html[data-theme="neon"] .ktvMeta .row2 label{
  border-color: rgba(255,255,255,.16);
  background: rgba(0,0,0,.25);
  color: rgba(255,255,255,.78);
}
.ktvToggle input,
.ktvMeta .row2 input{ transform: translateY(1px); }

/* KTV options: modern 2x2 cards */
.ktvOptGrid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap:10px;
}

/* --- KTV modern compact toggles --- */
.ktvHiddenInputs{ display:none; }
.ktvTogGrid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap:10px;
  margin-top:4px;
}
@media (min-width: 920px){
  .ktvTogGrid{ grid-template-columns: repeat(4, minmax(0,1fr)); }
}
.ktvTog{
  cursor:pointer;
  user-select:none;
  border:1px solid var(--line, rgba(0,0,0,.12));
  background: rgba(255,255,255,.06);
  border-radius:18px;
  padding:10px 12px;
  text-align:left;
  display:grid;
  grid-template-columns: 26px 1fr;
  grid-template-rows: auto auto;
  column-gap:10px;
  row-gap:2px;
  align-items:center;
  min-height:56px;
  color: var(--text, #fff);
  transition: transform .12s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
}
.ktvTog .ico{ font-size:18px; line-height:1; grid-row: 1 / span 2; grid-column:1; filter: drop-shadow(0 4px 10px rgba(0,0,0,.25)); }
.ktvTog .tt{ font-weight:800; font-size:13px; letter-spacing:.2px; grid-column:2; grid-row:1; }
.ktvTog .dd{ font-size:11px; opacity:.72; grid-column:2; grid-row:2; }
.ktvTog:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
.ktvTog[aria-pressed="true"], .ktvTog.on{
  border-color: rgba(124,92,255,.55);
  background: linear-gradient(135deg, rgba(124,92,255,.18), rgba(255,79,163,.12));
  box-shadow: 0 10px 26px rgba(124,92,255,.14);
}
.ktvTog[aria-pressed="false"]{ opacity:.68; }
@media (max-width: 980px){ .ktvOptGrid{ grid-template-columns:1fr; } }

.ktvOpt{
  border:1px solid var(--line, rgba(0,0,0,.10));
  background: color-mix(in srgb, var(--panel2, #fff) 72%, transparent);
  border-radius:16px;
  padding:10px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  min-height:56px;
}
html[data-theme="neon"] .ktvOpt{
  border-color: rgba(255,255,255,.16);
  background: rgba(0,0,0,.22);
}
.ktvOpt .m{min-width:0}
.ktvOpt .t{font-weight:1000; font-size:13px; color:var(--text)}
.ktvOpt .d{font-size:12px; color:var(--muted); margin-top:2px}
.ktvOpt input[type="checkbox"]{
  appearance:none;
  -webkit-appearance:none;
  width:44px; height:26px;
  border-radius:999px;
  border:1px solid color-mix(in srgb, var(--line) 95%, transparent);
  background: rgba(0,0,0,.10);
  position:relative;
  flex:0 0 auto;
  outline:none;
  cursor:pointer;
  transition: background .18s ease, border-color .18s ease;
}
html[data-theme="neon"] .ktvOpt input[type="checkbox"]{
  background: rgba(255,255,255,.08);
  border-color: rgba(255,255,255,.18);
}
.ktvOpt input[type="checkbox"]::after{
  content:"";
  position:absolute;
  top:3px; left:3px;
  width:20px; height:20px;
  border-radius:999px;
  background: rgba(255,255,255,.92);
  box-shadow: 0 6px 18px rgba(0,0,0,.35);
  transition: transform .18s ease;
}
.ktvOpt input[type="checkbox"]:checked{
  background: linear-gradient(135deg, color-mix(in srgb, var(--p2) 55%, transparent), color-mix(in srgb, var(--p1) 55%, transparent));
  border-color: color-mix(in srgb, var(--p2) 40%, var(--line));
}
.ktvOpt input[type="checkbox"]:checked::after{ transform: translateX(18px); }
.ktvOpt:hover{ filter: brightness(1.02); }

#ktvEditorWrap textarea{ height:160px !important; }

#ktvOverlay{ color:#fff; }
.ktvOverlayBody{ color:#fff; }
.ktvNextLine{ color: rgba(255,255,255,.74); }

/* 标准 LRC 的逐行高亮兜底（单层渲染，避免“滚动重影”） */
.ktvLineFx{
  display:inline-block;
  white-space:pre-wrap;
  -webkit-text-stroke: 2px var(--ktv-outline);
  text-shadow: 0 4px 18px rgba(0,0,0,.55), 0 0 1px rgba(0,0,0,.6);
  color: transparent;
  background:
    linear-gradient(90deg, var(--ktv-hot-a), var(--ktv-hot-b), var(--ktv-hot-c)) 0 0 / var(--p, 0%) 100% no-repeat,
    linear-gradient(90deg, var(--ktv-unsung), var(--ktv-unsung)) 0 0 / 100% 100% no-repeat;
  -webkit-background-clip:text;
  background-clip:text;
  -webkit-text-fill-color: transparent;
}



/* =========================================================
   Mobile & Tablet UI Patch (v2.6.33-m1)
   - bottom tab bar on phone
   - TOC drawer on phone/tablet
   - touch targets + safe-area
   - music system one-panel switcher on small screens
========================================================= */
:root{
  --tap: 44px;
  --pad: clamp(12px, 3.6vw, 18px);
  --pad2: clamp(10px, 3.0vw, 16px);
  --fz: clamp(13px, 3.2vw, 15px);
  --fz2: clamp(15px, 3.8vw, 18px);
}

/* Mobile typography baseline */
body{ font-size: var(--fz); }

/* Touch ergonomics */
@media (hover:none) and (pointer:coarse){
  .btn,.tab,.menuItem,.sbtn,.pillbtn,.daypill,.kgItem,.iconbtn,.schip,.chipBtn,.catBtn{
    min-height: var(--tap);
  }
  .btn,.tab,.menuItem,.sbtn,.pillbtn{ padding-top: 11px; padding-bottom: 11px; }
}

/* iOS: prevent focus-zoom */
input, textarea, select{ font-size: 16px; }

/* Safe-area for fixed elements */
@supports (padding: max(0px)){
  .fabReload{ right: max(12px, calc(12px + env(safe-area-inset-right))); bottom: max(12px, calc(12px + env(safe-area-inset-bottom))); }
  .clipDrawer{ bottom: max(12px, calc(12px + env(safe-area-inset-bottom))); }
}

/* Scroll: momentum */
.nav,.kgList,.linesList,.modal-body,.pickerCats,.pickerList{ -webkit-overflow-scrolling: touch; }

/* ===== TOC drawer (mobile/tablet) ===== */
#tocBackdrop{
  position: fixed; inset: 0;
  background: rgba(0,0,0,.42);
  display:none;
  z-index: 9998;
}
#tocBackdrop.show{ display:block; }

@media (max-width: 900px){
  .wrap{ padding: var(--pad); }
  .header{ padding: var(--pad2); border-radius: 22px; }
  .brand{ align-items:center; }
  h1{ font-size: 17px; }
  .sub{ font-size: 12.5px; }
  .tools{ gap: 8px; justify-content:flex-start; }
  .theme-switch{ width: 100%; overflow:auto; }
  .theme-switch::-webkit-scrollbar{ height: 6px; }
  .tbtn{ white-space: nowrap; }

  /* Cards tighter */
  .card,.schedule,.aside{ border-radius: 22px; }
  .card{ padding: 14px; }
  .box{ border-radius: 18px; }
  .script{ border-radius: 18px; }

  /* Off-canvas aside */
  .aside{
    position: fixed !important;
    left: max(10px, env(safe-area-inset-left));
    top: max(10px, env(safe-area-inset-top));
    bottom: max(10px, env(safe-area-inset-bottom));
    width: min(360px, 86vw);
    transform: translateX(calc(-100% - 18px));
    transition: transform .18s ease;
    z-index: 9999;
    overflow: hidden;
  }
  body.tocOpen .aside{ transform: translateX(0); }
  body.tocOpen #tocBackdrop{ display:block; }

  /* When aside becomes drawer, don't waste space in layout */
  .grid{ grid-template-columns: 1fr !important; }
}

/* ===== Phone bottom tab bar ===== */
@media (max-width: 640px){
  .wrap{ padding-bottom: calc(92px + env(safe-area-inset-bottom)); }
  .tabs{
    position: fixed;
    left: 0; right: 0; bottom: 0;
    margin: 0;
    padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
    background: color-mix(in srgb, var(--card2) 92%, transparent);
    backdrop-filter: var(--blur);
    border-top: 1px solid var(--line);
    border-radius: 18px 18px 0 0;
    z-index: 9997;
    box-shadow: 0 -18px 55px rgba(0,0,0,.12);
    overflow-x: auto;
    flex-wrap: nowrap;
    gap: 10px;
  }
  .tab{ padding: 12px 14px; border-radius: 16px; white-space: nowrap; }
}

/* ===== Schedule calendar: compact on phone ===== */
@media (max-width: 520px){
  .sched-top{ gap: 10px; }
  .sched-actions{ width: 100%; justify-content:flex-start; }
  .sched-summary{ grid-template-columns: repeat(2, 1fr); gap: 8px; }

  /* Mobile compact: schedule stats */
  .stat{ padding:10px 10px; border-radius: 18px; }
  .stat .value{ font-size:18px; margin-top:4px; }
  .stat .small{ display:none; }
  .stat.wide{ padding:10px; }
  .days{ flex-wrap:nowrap; overflow:auto; -webkit-overflow-scrolling: touch; gap:6px; padding-bottom:4px; }
  .days::-webkit-scrollbar{ display:none; }
  .daypill{ padding:6px 8px; font-size:12px; white-space:nowrap; }
  .sched-split{ grid-template-columns: 1fr; }
  .cal-head,.cal-body{ gap: 6px; }
  .day{ min-height: 78px; padding: 8px; border-radius: 18px; }
  .events{ gap: 4px; max-height: 56px; overflow:hidden; }
  .ev{ padding: 6px 7px; border-radius: 14px; }
  .ev .t{ font-size: 12px; }
  .ev .s{ display:none; }
}


/* ===== Schedule: ultra-small phones ===== */
@media (max-width: 420px){
  .sched-summary{ grid-template-columns: 1fr !important; }
  .stat{ padding: 10px 10px; }
}
/* ===== Modal: bottom-sheet on small screens ===== */
@media (max-width: 520px){
  .modal-panel{
    margin: 0 !important;
    max-width: none !important;
    width: 100% !important;
    position: fixed !important;
    left: 0; right: 0; bottom: 0;
    border-radius: 22px 22px 0 0 !important;
  }
  .modal-head{ padding: 12px 12px; }
  .modal-body{ padding: 12px; max-height: min(74vh, 720px); }
  .modal-foot{ padding: 12px; }
}

/* ===== Music system: one-panel switcher on mobile/tablet ===== */
.kgMobileSeg{
  display:none;
  gap: 10px;
  align-items:center;
  justify-content: space-between;
  flex-wrap: wrap;
  margin: 8px 0 10px;
}
.kgMobileSeg .seg{
  display:inline-flex;
  border:1px solid var(--line);
  border-radius:999px;
  overflow:hidden;
  background: color-mix(in srgb, var(--card2) 70%, transparent);
}
.kgMobileSeg .segbtn{
  padding: 10px 12px;
  font-size: 13px;
  color: var(--muted);
  background: transparent;
  border:0;
  cursor:pointer;
  white-space: nowrap;
}
.kgMobileSeg .segbtn.on{
  color: var(--txt);
  background: color-mix(in srgb, var(--p2) 14%, transparent);
}
.kgMobileSeg .mini{ font-size: 12px; color: var(--muted); }

@media (max-width: 1100px){
  .kgMobileSeg{ display:flex; }
  /* Override the desktop multi-column splitter grid */
  #kgGrid{
    grid-template-columns: 1fr !important;
    grid-template-rows: 1fr !important;
    gap: 0 !important;
  }
  #kgGrid .kgResizer{ display:none !important; }

  /* one-at-a-time view */
  #kgGrid.mobilePortrait .kgCol{ display:none !important; }
  #kgGrid.mobilePortrait .kgCol.show{ display:flex !important; }
  #kgGrid.mobilePortrait .kgCol{ height: min(78dvh, 760px) !important; }
}


/* ===== Music system: landscape two-column mode (library + right panel) ===== */
@media (max-width: 1100px) and (orientation: landscape){
  /* override the single-column rule */
  #kgGrid{ grid-template-columns: minmax(240px, 34vw) 1fr !important; }
  /* portrait: one-at-a-time */
  #kgGrid.mobilePortrait .kgCol{ display:none !important; }
  #kgGrid.mobilePortrait .kgCol.show{ display:flex !important; }
  /* landscape: library + (playlist OR queue) */
  #kgGrid.mobileLandscape .kgCol{ display:none !important; }
  #kgGrid.mobileLandscape #kgColLib{ display:flex !important; }
  #kgGrid.mobileLandscape #kgColPl.show,
  #kgGrid.mobileLandscape #kgColQueue.show{ display:flex !important; }
  #kgGrid.mobileLandscape #kgColLib{ height: min(78dvh, 760px) !important; }
  #kgGrid.mobileLandscape #kgColPl,
  #kgGrid.mobileLandscape #kgColQueue{ height: min(78dvh, 760px) !important; }
}

</style>
</head>
<body data-music-mode="builtin" data-p1-fullscreen="0" data-now-compact="1" data-queue-grid="1">
  <div id="buildBadge">v2.6.33</div>
<div class="wrap">
  <header class="header">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>主持人学习手册 <span class="ver">v2.6.1 Final</span></h1>
</div>
    </div>
    
    <div class="tools">
      <div class="theme-switch" title="主题切换（会自动记住）">
        <button class="tbtn" id="themeCream" data-theme="cream">奶油白 INS</button>
        <button class="tbtn" id="themeNeon" data-theme="neon">霓虹夜店</button>
      </div>

      <span class="pill"><span class="dot"></span>本地自动保存</span>

      <button class="btn primary" id="btnExport">⬇️ 导出</button>

      <details class="menu">
        <summary class="btn" aria-label="更多操作">⋯ 更多</summary>
        <div class="menuPanel">
          <button class="menuItem" id="btnImport">⬆️ 导入</button>
          <button class="menuItem" id="btnPrint">🖨️ 打印当前页</button>
          <div class="menuSep"></div>
          <button class="menuItem danger" id="btnReset">🧹 重置全部</button>
        </div>
      </details>
    </div>

    <div class="tabs" role="tablist">
      <button class="tab active" id="tabSchedule" role="tab" aria-selected="true">📅 档期记录</button>
      <button class="tab" id="tabHandbook" role="tab" aria-selected="false">📘 学习手册</button>
      <button class="tab" id="tabLines" role="tab" aria-selected="false">🎙 主持台词</button>
      <button class="tab" id="tabSocial" role="tab" aria-selected="false">📱 主持人自媒体入门与进阶</button>
      <button class="tab" id="tabMusic" role="tab" aria-selected="false">🎵 音乐系统</button>
    </div>
  </header>

  <section class="view" id="viewHandbook">
    <div class="grid onecol">
      <main class="cards" id="hostHandbookCards">
        <section class="card" style="padding:0; overflow:hidden">
          <button class="fabReload" id="btnReloadHostHandbook" type="button" title="重新加载学习手册">🔄</button>
<iframe
            id="hostHandbookFrame"
            title="婚礼主持人学习手册 v1.9"
            style="width:100%; border:0; display:block; background:transparent; height:72vh"
          ></iframe>
        </section>
      </main>
    </div>

    <template id="hostHandbookTpl">
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <base href="about:srcdoc">
<title>婚礼主持人学习手册（教学版 v1.9 稳定目录版）</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#101a33;
      --text:#eaf0ff;
      --muted:#a9b5d6;
      --line:rgba(255,255,255,.12);
      --brand:#7aa7ff;
      --good:#2ee59d;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --sidebar: 280px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --card:#ffffff;
        --text:#0c1222;
        --muted:#4b5876;
        --line:rgba(12,18,34,.12);
        --brand:#2c61ff;
        --shadow: 0 12px 28px rgba(16,26,51,.10);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC","Microsoft YaHei","Noto Sans SC", Arial, sans-serif;
      line-height:1.6;
      background: radial-gradient(1000px 700px at 12% 0%, rgba(122,167,255,.25), transparent 60%),
                  radial-gradient(900px 700px at 90% 20%, rgba(46,229,157,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--brand); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      padding:18px 18px 14px;
      position:sticky;
      top:0;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,16,32,.85), rgba(11,16,32,.55), rgba(11,16,32,0));
      z-index:20;
      border-bottom:1px solid var(--line);
    }
    @media (prefers-color-scheme: light){
      header{
        background: linear-gradient(to bottom, rgba(246,247,251,.92), rgba(246,247,251,.62), rgba(246,247,251,0));
      }
    }
    .topwrap{max-width:1280px; margin:0 auto;}
    h1{margin:0; font-size:24px; letter-spacing:.2px}
    .subtitle{margin:6px 0 0; color:var(--muted); max-width:90ch}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      padding:7px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
    }
    @media (prefers-color-scheme: light){
      .badge{background:rgba(44,97,255,.06)}
    }

    /* Layout: stable left sidebar TOC */
    .page{max-width:1280px; margin:0 auto; padding:14px 18px 40px;}
    .layout{
      display:grid;
      grid-template-columns: var(--sidebar) minmax(0,1fr);
      gap:14px;
      align-items:start;
    }
    aside{
      position:sticky;
      top:84px;
      height: calc(100vh - 104px);
      overflow:auto;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      padding:12px;
    }
    @media (prefers-color-scheme: light){
      aside{background:linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,.96));}
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      aside{position:relative; top:auto; height:auto}
      header{position:relative}
    }

    /* TOC */
    .toc-title{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px}
    .toc-title b{font-size:14px}
    .toc a{
      display:block;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      font-size:13px;
      margin:8px 0;
    }
    .toc a span{display:block; color:var(--muted); font-size:12px; margin-top:2px}
    .toc a:hover{filter:brightness(1.06)}
    .toc .group{margin-top:10px}
    .toc .group .head{
      font-size:12px; color:var(--muted); margin:10px 0 6px;
      display:flex; align-items:center; gap:8px;
    }
    .toc .group .head::before{
      content:"";
      display:block; width:7px; height:7px; border-radius:999px; background:rgba(122,167,255,.7);
    }
    .tag{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      border-radius:999px;
      padding:2px 8px;
      white-space:nowrap;
    }

    /* Content cards */
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      margin-bottom:14px;
    }
    @media (prefers-color-scheme: light){
      .card{background:linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,.96));}
    }
    h2{margin:0 0 10px; font-size:18px}
    h3{margin:0 0 8px; font-size:15px}
    .muted{color:var(--muted)}
    .hr{height:1px; background:var(--line); margin:12px 0}
    .grid{display:grid; gap:14px;}
    .grid.two{grid-template-columns: repeat(2, minmax(0,1fr));}
    @media (max-width: 980px){
      .grid.two{grid-template-columns:1fr}
    }
    .pill{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
      margin-right:6px;
      margin-bottom:6px;
    }
    .callout{
      border-left:4px solid var(--brand);
      padding:10px 12px;
      background:rgba(122,167,255,.10);
      border-radius:12px;
      margin:10px 0;
    }
    .callout.good{border-left-color:var(--good); background:rgba(46,229,157,.12)}
    .callout.warn{border-left-color:var(--warn); background:rgba(255,204,102,.14)}
    .callout.bad{border-left-color:var(--bad); background:rgba(255,107,107,.12)}
    details{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.04);
      padding:10px 12px;
      margin:10px 0;
    }
    details > summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:650;
    }
    details > summary::-webkit-details-marker{display:none}
    details[open]{background:rgba(255,255,255,.06)}

    ul{margin:8px 0 0 18px}
    li{margin:4px 0}
    pre{
      margin:10px 0 0;
      background:rgba(0,0,0,.22);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      overflow:auto;
      white-space:pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
    }
    @media (prefers-color-scheme: light){
      pre{background:rgba(0,0,0,.05)}
      details{background:rgba(0,0,0,.02)}
      details[open]{background:rgba(0,0,0,.03)}
    }

    /* Editable tables (Template库) */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
      margin-top:10px;
    }
    th,td{
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
      text-align:left;
      font-size:13px;
    }
    th{background:rgba(255,255,255,.06)}
    tr:last-child td{border-bottom:none}
    td[contenteditable="true"]{
      outline:none;
      border-radius:10px;
      background:rgba(255,255,255,.03);
    }
    td[contenteditable="true"]:focus{
      box-shadow: 0 0 0 2px rgba(122,167,255,.35);
      background:rgba(122,167,255,.08);
    }
    .table-tools{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      margin-top:10px;
    }
    .btn{
      border:1px solid var(--line);
      border-radius:12px;
      padding:8px 10px;
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px)}
    .btn.good{border-color:rgba(46,229,157,.45)}
    .btn.warn{border-color:rgba(255,204,102,.45)}
    .btn.bad{border-color:rgba(255,107,107,.45)}
    .btn.small{padding:6px 9px; font-size:12px; border-radius:10px}
    .status{
      color:var(--muted);
      font-size:12px;
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.28); border:1px solid var(--line)}
    .dot.ok{background:rgba(46,229,157,.55); border-color:rgba(46,229,157,.55)}
    .dot.warn{background:rgba(255,204,102,.55); border-color:rgba(255,204,102,.55)}

    .footer{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
    }
    .small{font-size:12px}
    @media print{
      header{position:static; background:none; border:none}
      aside{display:none !important}
      body{background:#fff; color:#000}
      .card, details, table, pre{box-shadow:none}
      a{color:#000; text-decoration:none}
      .btn, .table-tools{display:none !important}
      td[contenteditable="true"]{background:transparent}
    }
  
    .tpl-frame{width:100%;border:1px solid var(--line);border-radius:18px;background:var(--card);min-height:1080px;display:block;}

    /* embed mode: hide redundant top title bar */
    header{display:none !important;}
    .page{padding-top:8px !important;}
</style>

<style id="__embedHostHandbookOverrides">
  :root{
    --radius: 18px;
    --brand: var(--p2, #6d5cff);
    --good: var(--ok, #22c55e);
    --bad: var(--danger, #ef4444);
  }
  html,body{ font-family: var(--sans, ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei","Noto Sans CJK SC",Arial) !important; }
  body{ background: var(--bg) !important; color: var(--text) !important; }
  header{ background: transparent !important; border-bottom: 1px solid var(--line) !important; padding: 12px 18px 10px !important; }
  header .badge{ display:none !important; }
  .topwrap{ max-width:none !important; }
  .page{ padding: 12px 12px 12px !important; }
  /* unify card/line look */
  .layout, .toc-title, .toc a, .pane, .card, .panel, .box{
    border-color: var(--line) !important;
    color: var(--text) !important;
  }
  .muted, .subtitle, .sub, .sub2{ color: var(--muted) !important; }
  button, input, textarea{ font-family: inherit !important; }

  /* embed: align TOC height with content after hiding internal header */
  .layout{ min-height: calc(100vh - 24px) !important; align-items: stretch !important; }
  aside{
    top: 12px !important;
    height: calc(100vh - 24px) !important;
    max-height: none !important;
  }
  .layout > main{ min-height: calc(100vh - 24px) !important; }
  @media (max-width: 980px){
    aside{ position: relative !important; top: auto !important; height: auto !important; }
  }
</style>
<script id="__embedHostHandbookThemeSync">
(function(){
  function pullFromParent(){
    try{
      if(!parent || !parent.document) return;
      const pr = parent.document.documentElement;
      const cs = parent.getComputedStyle(pr);
      const dst = document.documentElement.style;
      const vars = ["--bg","--card","--card2","--line","--text","--muted","--p2","--sans","--shadow","--radius-md","--radius-lg","--radius-xl"];
      vars.forEach(function(v){
        const val = cs.getPropertyValue(v).trim();
        if(val) dst.setProperty(v, val);
      });
      const brand = cs.getPropertyValue("--p2").trim();
      if(brand) dst.setProperty("--brand", brand);
    }catch(e){}
  }
  pullFromParent();
  window.addEventListener("message", function(ev){
    if(ev && ev.data && ev.data.type === "__theme_sync__"){ pullFromParent(); }
  });
})();
</script>

</head>
<body>
<header>
  <div class="topwrap">
    <h1>婚礼主持人学习手册（教学版）</h1>
</div>
</header>

<div class="page">
  <div class="layout">
    <aside aria-label="目录">
      <div class="toc-title">
        <b>目录</b>
        <span class="tag">固定左侧</span>
      </div>
      <div class="toc">
        <div class="group">
          <div class="head">总览</div>
          <a href="#map">01｜职业地图<span>价值、训练拆法、方法论融合</span></a>
          <a href="#roadmap">02｜30天训练路线<span>从0到能上台：每天最小动作</span></a>
        </div>
        <div class="group">
          <div class="head">基本功</div>
          <a href="#skills">03｜四项基本功<span>声音 / 台风 / 台词音乐 / 形象审美</span></a>
          <a href="#stage">03A｜舞台剧与声音表演<span>角色、节拍、潜台词、声音塑形</span></a>
        </div>
        <div class="group">
          <div class="head">流程教学</div>
          <a href="#flow">04｜流程台本拆解<span>迎宾→仪式→宴会逐段可练</span></a>
          <a href="#control">05｜控场与应急<span>突发处理、救场话术、应急流程</span></a>
          <a href="#music">06｜音乐与设备<span>编排思路 + 到场检查</span></a>
        </div>
        <div class="group">
          <div class="head">商务与实操</div>
          <a href="#biz">07｜沟通与商务<span>教练式提问、报价与作品</span></a>
          <a href="#practice">08｜练习与清单<span>每日打勾、彩排检查</span></a>
          <a href="#templates">09｜模板库（表格可编辑）<span>问卷 / 流程单 / 意义句（可保存）</span></a>
          <a href="#sources">10｜参考与来源<span>继续深挖关键词</span></a>
        </div>
      </div>
      <div class="footer">
        小技巧：Ctrl/Cmd + F 可全文搜索。<br/>
        表格内：直接点击格子修改文字。
      </div>
    </aside>

    <main>
      <section class="card" id="map">
        <h2>01｜婚礼主持人的职业地图</h2>
        <div class="grid two">
          <div>
            <h3>你到底在“卖”什么？</h3>
            <ul>
              <li><b>节奏与安全</b>：时间节点、流程衔接、突发事件的“稳住”。</li>
              <li><b>情绪与关系</b>：让新人、父母、来宾舒服；把情绪推到关键点。</li>
              <li><b>审美与表达</b>：语言、台风、服装、音乐选择，决定“质感”和“身价”。</li>
              <li><b>前期策划</b>：沟通 + 信息采集 + 脚本定制 + 彩排对齐。</li>
            </ul>
            <div class="callout good">
              <b>教练式提醒：</b>婚礼不是主持人个人秀——新人是主角，你的价值是“让他们更好地呈现自己”。
            </div>
          </div>
          <div>
            <h3>主流训练通常怎么拆？</h3>
            <p class="muted">很多集训会把能力拆成可考核的四块，并覆盖中/西式流程、声台行表、审美包装等。</p>
            <div class="hr"></div>
            <div>
              <span class="pill">声音</span>
              <span class="pill">台风</span>
              <span class="pill">台词 &amp; 音乐</span>
              <span class="pill">形象 &amp; 服装</span>
            </div>
            <p class="small muted">建议：先“能复现”（稳定输出），再“能溢价”（质感与标签）。</p>
          </div>
        </div>

        <details>
          <summary>三种常见教学取向如何落到你的训练？<span class="tag">展开</span></summary>
          <div class="grid two">
            <div class="card" style="box-shadow:none">
              <h3>言传身教（示范拆解）</h3>
              <ul>
                <li><b>看示范 → 立刻跟练</b>：同一段开场/串联，先模仿再微调。</li>
                <li><b>上台录制 → 逐句复盘</b>：用“作品”倒逼动作标准。</li>
                <li><b>用考核维度逼近职业线</b>：声音、台风、台词音乐、形象服装。</li>
              </ul>
            </div>
            <div class="card" style="box-shadow:none">
              <h3>教练式（新人主角）</h3>
              <ul>
                <li><b>赛前训练&gt;赛场发挥</b>：前期陪新人做选择、做准备。</li>
                <li><b>脚本不背套词</b>：以新人故事为蓝本，语言更像“朋友对话”。</li>
                <li><b>现场引导与鼓励</b>：捕捉情绪，帮新人“说出那句话”。</li>
              </ul>
            </div>
            <div class="card" style="box-shadow:none">
              <h3>添彩（审美与五感）</h3>
              <ul>
                <li><b>角色定位</b>：像闺蜜/兄弟一样进入婚礼，更容易让来宾代入。</li>
                <li><b>五感调度</b>：尤其重视音乐编排，让“仪式感”可感知。</li>
                <li><b>包装与标签</b>：资料/作品匹配报价，形成可被记住的个人标签。</li>
              </ul>
            </div>
          </div>
        </details>
      </section>

      <section class="card" id="roadmap">
        <h2>02｜30天训练路线（从0到能上台）</h2>
        <p class="muted">先把流程跑通，再做审美与个性：稳定比花更重要。</p>
        <table>
          <thead>
            <tr>
              <th class="nowrap">阶段</th>
              <th>目标</th>
              <th>每天最小动作（30–60分钟）</th>
              <th class="nowrap">输出物</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><b>Day 1–7</b></td>
              <td>打底：声音 &amp; 台风可控</td>
              <td>口部操 10′ + 朗读 15′ + 站姿手势 10′ + 录音复听 10′</td>
              <td>3段“可听清”的口播音频</td>
            </tr>
            <tr>
              <td><b>Day 8–14</b></td>
              <td>流程：能完整串联一场婚礼</td>
              <td>按“流程台本拆解”逐段练：开场/入场/誓言/戒指/合影/退场</td>
              <td>一份「基础版台本」</td>
            </tr>
            <tr>
              <td><b>Day 15–21</b></td>
              <td>控场：突发不慌</td>
              <td>每天演练2个情境：迟到/音乐错/冷场/家长强势/新人哽咽</td>
              <td>10条救场话术 + 1张应急流程</td>
            </tr>
            <tr>
              <td><b>Day 22–30</b></td>
              <td>溢价：审美、音乐、作品</td>
              <td>学习一场高质感样片并复刻结构；更新个人资料与作品呈现</td>
              <td>1条样片（或模拟样片脚本）</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section class="card" id="skills">
        <h2>03｜四项基本功（练到“能复现”）</h2>
        <div class="grid two">
          <div class="card" style="box-shadow:none">
            <h3>1）声音（清晰、饱满、有对象感）</h3>
            <ul>
              <li><b>清晰度</b>：咬字不糊；句尾不吞。</li>
              <li><b>饱满度</b>：气息支撑；不靠喊。</li>
              <li><b>情绪曲线</b>：该收就收，该放就放。</li>
            </ul>
            <details>
              <summary>一分钟口部操（每天）<span class="tag">展开</span></summary>
              <ul>
                <li>唇：噗噗噗（10次）→ 咧嘴/噘嘴切换（10次）</li>
                <li>舌：顶上颚（10次）→ 舌尖绕口腔一圈（5次）</li>
                <li>气：长“嘶——” 10秒×3（不憋气）</li>
              </ul>
            </details>
          </div>
          <div class="card" style="box-shadow:none">
            <h3>2）台风（站得住、走得稳、看得准）</h3>
            <ul>
              <li><b>站位</b>：舞台中心/偏侧/走位点——每一步有目的。</li>
              <li><b>眼神</b>：找“对象”说话，不对着天花板。</li>
              <li><b>手势</b>：只做“有信息”的动作，别乱挥。</li>
            </ul>
            <details>
              <summary>镜前 5 分钟：站姿/手势/微笑<span class="tag">展开</span></summary>
              <ul>
                <li>站姿：双脚与肩同宽，重心微前，肩放松。</li>
                <li>手势：胸口到腰间活动区；指向要落到人/物。</li>
                <li>微笑：先用眼睛笑，再用嘴笑，避免“挂脸”。</li>
              </ul>
            </details>
          </div>
          <div class="card" style="box-shadow:none">
            <h3>3）台词 &amp; 音乐（结构&gt;辞藻）</h3>
            <ul>
              <li><b>先结构</b>：开场、转场、情绪推进、收口。</li>
              <li><b>后词汇</b>：少空话，多“具体画面”。</li>
              <li><b>音乐匹配</b>：人物/场景/节奏一致才丝滑。</li>
            </ul>
            <details>
              <summary>万能转场结构（比背套词更好用）<span class="tag">展开</span></summary>
              <pre>承接（刚发生了什么）
→ 意义（这一刻为什么重要）
→ 牵引（下一步我们要去哪里）
→ 指令（给谁/怎么做/多久）</pre>
            </details>
          </div>
          <div class="card" style="box-shadow:none">
            <h3>4）形象 &amp; 审美（决定“值不值钱”）</h3>
            <ul>
              <li><b>服装合体</b>：肩线、袖长、裤长——一眼看职业。</li>
              <li><b>质感统一</b>：领结/口袋巾/鞋袜与婚礼风格匹配。</li>
              <li><b>作品呈现</b>：样片质量=你在客户心里的报价上限。</li>
            </ul>
            <div class="callout warn"><b>提醒：</b>资料/作品要与报价匹配，否则对比中直接出局。</div>
          </div>
        </div>
      </section>

      <section class="card" id="stage">
        <h2>03A｜舞台剧思维 &amp; 声音表演（把“能说”升级为“会演”）</h2>
        <p class="muted">婚礼主持不是夸张表演，但可以借舞台训练让表达更“有层次、有对象、有画面”。核心是精准控制：<b>目的、节奏、潜台词、声音形态</b>。</p>

        <div class="grid two">
          <div class="card" style="box-shadow:none">
            <h3>舞台剧四件套（每段话都能套）</h3>
            <ul>
              <li><b>角色目标</b>：我想让现场发生什么？（安静/鼓掌/感动/推进）</li>
              <li><b>障碍</b>：阻力是什么？（嘈杂/冷场/新人紧张/长辈插话）</li>
              <li><b>行动动词</b>：我用什么动作达成？（邀请/安抚/点燃/引导/收束）</li>
              <li><b>节拍（Beat）</b>：哪里停顿、哪里加速、哪里抬情绪？</li>
            </ul>
            <div class="callout good"><b>落地：</b>写台本时在句子旁标动词【安抚】【点燃】【牵引】——你说话会立刻“有目的”。</div>
          </div>

          <div class="card" style="box-shadow:none">
            <h3>声音表演三层（同一句话说出不同“角色感”）</h3>
            <ul>
              <li><b>音色层</b>：明亮 / 温暖 / 沉稳（共鸣位置变化）</li>
              <li><b>节奏层</b>：快慢、停顿、重音（让来宾“跟得上”）</li>
              <li><b>对象层</b>：你在对谁说？（新人/父母/全场/摄影）</li>
            </ul>
            <details>
              <summary>练习 1：一句话三版本（每天 3 分钟）<span class="tag">展开</span></summary>
              <pre>句子： “这一刻，请把掌声留给他们。”
版本A（点燃）：语速略快+重音在“掌声”“他们”，音色明亮。
版本B（郑重）：语速慢10%+停顿在“这一刻”，音色沉稳。
版本C（温柔）：音量下降半档+尾音收干净，像对新人说悄悄话。</pre>
            </details>
          </div>

          <div class="card" style="box-shadow:none">
            <h3>潜台词训练（让“套词”变“真话”）</h3>
            <ul>
              <li>同一句话换潜台词：你说的是词，但你传递的是态度。</li>
              <li>婚礼里最常用潜台词：<b>我理解你</b>、<b>你很重要</b>、<b>我们慢一点</b>、<b>我来替你稳住</b>。</li>
            </ul>
            <details>
              <summary>练习 2：给句子加潜台词标注<span class="tag">展开</span></summary>
              <pre>台词： “没关系，我们停一停。”
潜台词1（安抚新人）：我知道你紧张，你不用硬撑。
潜台词2（控场全场）：大家别急，最重要的是把这一刻做好。
潜台词3（给摄影时间）：我们慢一点，让画面更完整。</pre>
            </details>
          </div>

          <div class="card" style="box-shadow:none">
            <h3>舞台走位像“场面调度”（不是乱走）</h3>
            <ul>
              <li><b>一个环节只定 2–3 个点位</b>：中心点 / 新人点 / 合影停点。</li>
              <li><b>走位要配台词节拍</b>：停顿时停步，重音时定住。</li>
              <li><b>麦克风距离</b>：嘴角 2–3 指，别贴嘴、别甩头。</li>
            </ul>
            <div class="callout warn"><b>经验：</b>“走位太多 + 手势太多”会显得慌。舞台感来自“可控的少”。</div>
          </div>
        </div>
      </section>

      <section class="card" id="flow">
        <h2>04｜流程台本拆解（常规婚礼环节）</h2>
        <p class="muted">用“可执行动作”来学：每个环节给你 <b>任务</b>、<b>结构</b>、<b>禁忌</b>、<b>练习</b>、<b>示例</b>。</p>

        <details open>
          <summary>A｜迎宾与开场（含新人入场）<span class="tag">重点</span></summary>

          <details>
            <summary>1）迎宾提示 / 暖场（开席前 20–30 分钟）<span class="tag">展开</span></summary>
            <ul>
              <li><b>任务</b>：把来宾从“散”带到“聚”；让大家知道“等会儿要发生什么”。</li>
              <li><b>结构</b>：欢迎→提示（落座/静音/洗手间）→预告（入场/仪式/合影）→致谢。</li>
              <li><b>禁忌</b>：别讲太长；别反复催；别训话。</li>
              <li><b>练习</b>：把提示语压到 40 秒以内（录音计时）。</li>
            </ul>
            <pre>示例（40秒）
各位亲友下午好，欢迎来到今天的喜宴现场。我是本场主持人。
提醒大家：手机调至静音/震动，照顾一下台上新人最重要的时刻；洗手间在（方向）。
大约在（时间）我们将迎来新人入场、誓言与戒指仪式，之后会有合影与敬酒环节。
感谢大家的到来，我们一起把祝福留给他们。</pre>
          </details>

          <details>
            <summary>2）开场（正式开始）<span class="tag">展开</span></summary>
            <ul>
              <li><b>任务</b>：立住你的角色（沉稳/温暖/幽默），把注意力统一到舞台。</li>
              <li><b>结构</b>：一句话定调→一句话给新人定位→一句话给来宾角色→进入入场。</li>
              <li><b>舞台思维</b>：给自己一个行动动词：例如【点燃】——你会自然有力量。</li>
            </ul>
            <pre>示例（60–90秒）
各位亲友，下午好。今天我们相聚在这里，只为了同一件事——见证两个人把“喜欢”变成“决定”。
这不是一场表演，而是一段真实人生的开始。等会儿请大家把最热烈的掌声，留给今天最重要的两位主角。
现在，让我们用掌声请出新郎（姓名/称呼），带着对她的答案，走向他此生最想守护的人。</pre>
          </details>

          <details>
            <summary>3）新人入场（含交接可选）<span class="tag">展开</span></summary>
            <ul>
              <li><b>任务</b>：把“走路”变成“仪式”。</li>
              <li><b>结构</b>：介绍→音乐起→走位指令→停点（合影点）→到达仪式区。</li>
              <li><b>禁忌</b>：别连续下导演式指令；指令要短、清晰、有温度。</li>
            </ul>
            <pre>指令句（可直接用）
音乐响起的这一刻，请大家把目光交给他们。
新郎请站在（位置），等她走近时，你给她一个拥抱/牵手。
摄影老师准备好，我们在（点位）停3秒，留一张全场最亮的照片。</pre>
          </details>
        </details>

        <details>
          <summary>B｜仪式段（故事/誓言/戒指/致辞）<span class="tag">情绪线</span></summary>

          <details>
            <summary>4）爱情故事引入（建议）<span class="tag">展开</span></summary>
            <ul>
              <li><b>任务</b>：让来宾“知道他们是谁”，情绪才会跟上来。</li>
              <li><b>结构</b>：一句画面→一句转折→一句选择→一句今天的意义。</li>
              <li><b>舞台技巧</b>：画面句说慢一点，转折句提一点力度。</li>
            </ul>
            <pre>示例（90秒）
他们第一次见面是在（地点/场景），当时谁也没想到，这会成为后来每一次想起都会笑的开端。
后来经历了（一个困难/转折），他们并没有走散，反而更确定：我想和这个人把日子过成家。
所以今天，我们不只是听一段故事，而是见证——他们选择彼此，也选择一种生活。</pre>
          </details>

          <details>
            <summary>5）誓言（最容易翻车也最容易封神）<span class="tag">展开</span></summary>
            <ul>
              <li><b>任务</b>：让新人“说得出来”。</li>
              <li><b>教练式做法</b>：提前准备 3 句：感谢、承诺、愿望；现场你只引导。</li>
              <li><b>声音表演</b>：此处音量下降半档、语速慢一点，给情绪空间。</li>
            </ul>
            <pre>引导句（主持人说这些就够）
（对新郎）你可以先对她说一句“谢谢”，谢谢她让你成为更好的人。
（对新娘）你也可以告诉他，你最想和他一起完成的一件小事是什么。
如果你们想停一停没关系，今天全场都在等你们把真心说完。</pre>
          </details>

          <details>
            <summary>6）戒指 / 拥吻（仪式三连可选）<span class="tag">展开</span></summary>
            <ul>
              <li><b>任务</b>：节奏要“慢一点”，让摄影摄像跟得上，让来宾看得清。</li>
              <li><b>结构</b>：意义→指令（慢、清）→停点→掌声→转场。</li>
            </ul>
            <pre>指令句（慢一点）
请你们面对彼此，牵起对方的手。
戒指不只是礼物，它是一个承诺的“可见证明”。
请新郎/新娘为对方戴上戒指——慢一点，让我们把这一刻记得更久。</pre>
          </details>

          <details>
            <summary>7）致辞（父母/证婚/好友）<span class="tag">展开</span></summary>
            <ul>
              <li><b>任务</b>：把“人”介绍好，把“时间”控制住。</li>
              <li><b>结构</b>：身份/关系→一句亮点→给掌声→柔性提醒时长。</li>
            </ul>
            <pre>主持人介绍模板
接下来邀请（称呼），他/她在他们的成长里一直扮演着最重要的角色。
请把掌声送给（姓名/称呼），我们听听他/她想对这对新人说的祝福与叮嘱。</pre>
          </details>
        </details>

        <details>
          <summary>C｜宴会段（祝酒/互动/收尾）<span class="tag">节奏</span></summary>

          <details>
            <summary>8）开席 / 祝酒（宴会开场）<span class="tag">展开</span></summary>
            <ul>
              <li><b>任务</b>：把“吃饭”开得体面，不尴尬。</li>
              <li><b>结构</b>：感谢→祝福→举杯指令→开席。</li>
            </ul>
            <pre>示例（45秒）
感谢各位亲友把时间留给他们，把祝福带到这里。
现在请大家举起酒杯/饮料，让我们把最真挚的祝愿送给这对新人——
愿他们从此同心同路，日子有光，家里有笑。干杯！</pre>
          </details>

          <details>
            <summary>9）互动（建议用“祝福征集”最稳）<span class="tag">展开</span></summary>
            <ul>
              <li><b>原则</b>：短（3–5分钟）｜不羞辱｜不灌酒｜不强迫｜不低俗。</li>
              <li><b>最稳互动</b>：祝福征集（给3位来宾一个“可说的句子”）。</li>
            </ul>
            <pre>稳妥互动（祝福征集）
我想邀请三位亲友，分别用一句话完成：
“我最希望你们婚后一直保持的，是____。”
（提示：温柔/耐心/幽默/一起旅行/一起运动…）</pre>
          </details>

          <details>
            <summary>10）敬酒 / 合影 / 收尾（最后一公里）<span class="tag">展开</span></summary>
            <ul>
              <li><b>敬酒提示</b>：路线、桌数、时间预估讲清楚，避免新人被围住出不来。</li>
              <li><b>合影组织</b>：分组（亲友/同学/同事）+站位点+口令短。</li>
              <li><b>收尾</b>：感谢+祝福+提示离场（停车/礼品/返程）。</li>
            </ul>
            <pre>收尾模板（60秒）
今天我们把祝福留在这里，也把故事带回生活里。
感谢各位亲友一路见证他们从相遇到相守。婚礼会结束，但爱会继续。
离场时请注意随身物品，礼品在（位置），停车/返程可（提示）。
祝大家今晚都平安顺利，也祝这对新人——从此相爱不止今天。</pre>
          </details>
        </details>
      </section>

      <section class="card" id="control">
        <h2>05｜控场与应急（你稳，现场就稳）</h2>
        <div class="grid two">
          <div>
            <h3>控场底层：三件事</h3>
            <ul>
              <li><b>你先稳</b>：声音降低半档，语速慢 10%。</li>
              <li><b>给清指令</b>：谁、做什么、到哪里、多久。</li>
              <li><b>把情绪收回来</b>：用一句“意义句”把大家拉回婚礼。</li>
            </ul>
            <div class="callout good"><b>救场口诀：</b>“我看见了 → 没关系 → 我们这样做 → 谢谢配合”。</div>
          </div>
          <div>
            <h3>常见突发话术</h3>
            <details>
              <summary>音乐放错 / 音响出问题<span class="tag">展开</span></summary>
              <pre>各位亲友稍等一下，我们给新人一个更完美的出场音乐。
工作人员正在调整，30秒就好。感谢大家的耐心与掌声。</pre>
            </details>
            <details>
              <summary>新人迟到 / 关键人物未到<span class="tag">展开</span></summary>
              <pre>我们把最重要的时刻留给最完整的家人。
先请大家稍作休息/观看大屏/签到合影，等一会儿我们用掌声迎接主角到来。</pre>
            </details>
            <details>
              <summary>现场冷 / 掌声不够<span class="tag">展开</span></summary>
              <pre>掌声不用客气，今天你们越热烈，新人越有勇气把真心说出来。
我数三声，我们把祝福一次性送到位：3、2、1——</pre>
            </details>
          </div>
        </div>
      </section>

      <section class="card" id="music">
        <h2>06｜音乐与设备（仪式感的“看不见的手”）</h2>
        <div class="grid two">
          <div>
            <h3>音乐：别只会“放歌”，要会“编排”</h3>
            <ul>
              <li><b>统一风格</b>：别东一首西一首。</li>
              <li><b>节点对齐</b>：入场、誓言、戒指、拥吻、退场——提前对齐。</li>
              <li><b>五感参与</b>：音乐决定“情绪底色”。</li>
            </ul>
            <details>
              <summary>基础歌单结构<span class="tag">展开</span></summary>
              <pre>迎宾：轻快/舒适
开场：有张力但不吵
新郎入场：坚定
新娘入场：情绪拉升
誓言：留空间给人声
戒指/拥吻：情绪峰值（不抢台词）
退场：明亮庆祝
宴会：松弛可聊天</pre>
            </details>
          </div>
          <div>
            <h3>到场 10 分钟检查清单</h3>
            <ul>
              <li>麦克风：主麦/备麦电量、静音键、距离嘴角 2–3 指</li>
              <li>音控：每个节点音乐是否在列表、音量上限、切歌方式</li>
              <li>灯光：入场/誓言/拥吻/合影的灯位与亮度</li>
              <li>大屏：视频/照片顺序与备用U盘</li>
              <li>走位：上台动线、仪式区、合影点位</li>
            </ul>
            <div class="callout warn"><b>高发翻车点：</b>流程没问题但音控没对齐。把音控当“第二台词”。</div>
          </div>
        </div>
      </section>

      <section class="card" id="biz">
        <h2>07｜客户沟通与商务（从能主持到能成交）</h2>
        <div class="grid two">
          <div>
            <h3>第一次沟通：拿到哪些关键信息？</h3>
            <ul>
              <li>新人性格：外向/内向、能不能表达、怕不怕尴尬。</li>
              <li>家庭结构：父母是否强势、是否有禁忌。</li>
              <li>风格与预算：中式/西式/仪式+宴会，预算档位。</li>
              <li>关键节点：交接、致辞、敬茶、互动。</li>
            </ul>
            <details>
              <summary>教练式提问清单（用提问代替“我懂我会”）<span class="tag">展开</span></summary>
              <ul>
                <li>你们希望来宾记住今天的哪三件事？</li>
                <li>你们更想要“热闹”还是“仪式感”？哪个占 60%？</li>
                <li>你们最怕现场出现什么？（迟到/尴尬/插话…）</li>
                <li>誓言你们想“说”还是“我引导你们说”？</li>
              </ul>
            </details>
          </div>
          <div>
            <h3>报价与作品：如何让它“看起来值”</h3>
            <ul>
              <li><b>作品匹配报价</b>：样片/照片/文案都要匹配你的价位层级。</li>
              <li><b>建立标签</b>：让市场用一句话记住你。</li>
              <li><b>增值服务</b>：问卷/台本定制/音乐编排/彩排陪同/应急方案。</li>
            </ul>
            <div class="callout good"><b>溢价路径：</b>审美 + 服务完整度 + 现场稳定度。</div>
          </div>
        </div>
      </section>

      <section class="card" id="practice">
        <h2>08｜练习与清单（照着做就能进步）</h2>
        <div class="grid two">
          <div>
            <h3>每日练习（30–60 分钟）</h3>
            <ul>
              <li>口部操+气息（10′）</li>
              <li>朗读一段开场/誓言引导（15′）</li>
              <li>镜前台风：站姿+手势+微笑（10′）</li>
              <li>录音/录像复听（10′）</li>
              <li>写一条救场话术或转场句（5′）</li>
            </ul>
          </div>
          <div>
            <h3>四项自评分（不计算，只记录）</h3>
            <table>
              <thead><tr><th>维度</th><th>我今天的表现（0–20）</th><th>下一次只改一个点</th></tr></thead>
              <tbody>
                <tr><td>声音</td><td>____</td><td>例如：句尾不吞 / 语速慢10%</td></tr>
                <tr><td>台风</td><td>____</td><td>例如：眼神找对象 / 手势减少</td></tr>
                <tr><td>台词音乐</td><td>____</td><td>例如：转场四步 / 音乐对齐</td></tr>
                <tr><td>形象服装</td><td>____</td><td>例如：合体度 / 鞋袜细节</td></tr>
              </tbody>
            </table>
            <p class="small muted">建议：每次只改 1 个点，连续 7 天效果明显。</p>
          </div>
        </div>
      </section>

      <section class="card" id="templates" data-mc-templates="1">
        <h2>09｜模板库（可编辑表格：新增/删除/保存/读取/恢复默认）</h2>
        <p class="muted">用法：直接点击单元格修改；改完点「保存」。如果你是把本页“注入加载”，请确保模板引擎脚本已在主程序中加载（见文件底部脚本）。</p>

        <details open>
          <summary>模板 1：新人信息采集（婚礼问卷）<span class="tag">可保存</span></summary>
          <div class="table-tools">
            <button class="btn good" type="button" data-mc-action="add" data-mc-target="qTable">新增一行</button>
            <button class="btn" type="button" data-mc-action="load" data-mc-target="qTable">读取保存</button>
            <button class="btn warn" type="button" data-mc-action="save" data-mc-target="qTable">保存</button>
            <button class="btn bad" type="button" data-mc-action="reset" data-mc-target="qTable">恢复默认</button>
            <div class="status"><span class="dot" id="qDot"></span><span id="qStatus">未保存</span></div>
          </div>

          <table id="qTable" data-mc-key="wedding_mc_tpl_questionnaire" data-mc-prefix="q" data-mc-cols="3">
            <thead>
              <tr>
                <th class="nowrap">模块</th>
                <th>问题</th>
                <th>填写（可改）</th>
                <th class="nowrap">操作</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>基本信息</td><td>新郎姓名/称呼偏好</td><td></td><td class="nowrap"><button class="btn small bad" type="button" data-mc-row-act="del">删除</button></td>
              </tr>
              <tr>
                <td>基本信息</td><td>新娘姓名/称呼偏好</td><td></td><td class="nowrap"><button class="btn small bad" type="button" data-mc-row-act="del">删除</button></td>
              </tr>
              <tr>
                <td>基本信息</td><td>婚礼日期/场地/开席时间</td><td></td><td class="nowrap"><button class="btn small bad" type="button" data-mc-row-act="del">删除</button></td>
              </tr>
              <tr>
                <td>风格预算</td><td>婚礼风格（热闹/温暖/仪式感/幽默）</td><td></td><td class="nowrap"><button class="btn small bad" type="button" data-mc-row-act="del">删除</button></td>
              </tr>
              <tr>
                <td>故事素材</td><td>第一次见面：地点/场景/细节</td><td></td><td class="nowrap"><button class="btn small bad" type="button" data-mc-row-act="del">删除</button></td>
              </tr>
              <tr>
                <td>家庭来宾</td><td>父母是否有特殊安排/禁忌</td><td></td><td class="nowrap"><button class="btn small bad" type="button" data-mc-row-act="del">删除</button></td>
              </tr>
            </tbody>
          </table>

          <template id="qDefault" data-mc-default-for="qTable">
            <tr><td>基本信息</td><td>新郎姓名/称呼偏好</td><td></td></tr>
            <tr><td>基本信息</td><td>新娘姓名/称呼偏好</td><td></td></tr>
            <tr><td>基本信息</td><td>婚礼日期/场地/开席时间</td><td></td></tr>
            <tr><td>风格预算</td><td>婚礼风格（热闹/温暖/仪式感/幽默）</td><td></td></tr>
            <tr><td>故事素材</td><td>第一次见面：地点/场景/细节</td><td></td></tr>
            <tr><td>家庭来宾</td><td>父母是否有特殊安排/禁忌</td><td></td></tr>
          </template>

          <div class="footer">提示：把“填写”列留空也没关系；后续和新人沟通时再补全。</div>
        </details>

        <details>
          <summary>模板 2：流程单（给音控/策划/摄影）<span class="tag">可保存</span></summary>
          <div class="table-tools">
            <button class="btn good" type="button" data-mc-action="add" data-mc-target="fTable">新增一行</button>
            <button class="btn" type="button" data-mc-action="load" data-mc-target="fTable">读取保存</button>
            <button class="btn warn" type="button" data-mc-action="save" data-mc-target="fTable">保存</button>
            <button class="btn bad" type="button" data-mc-action="reset" data-mc-target="fTable">恢复默认</button>
            <div class="status"><span class="dot" id="fDot"></span><span id="fStatus">未保存</span></div>
          </div>

          <table id="fTable" data-mc-key="wedding_mc_tpl_flow" data-mc-prefix="f" data-mc-cols="4">
            <thead>
              <tr>
                <th class="nowrap">节点</th>
                <th class="nowrap">时间</th>
                <th>BGM/音乐</th>
                <th>备注（灯光/站位/停点）</th>
                <th class="nowrap">操作</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>迎宾</td><td>____</td><td>A1（迎宾）</td><td>提示：静音/洗手间/预告节点</td><td class="nowrap"><button class="btn small bad" type="button" data-mc-row-act="del">删除</button></td>
              </tr>
              <tr>
                <td>开场</td><td>____</td><td>A2（开场）</td><td>主持人上台，定调，统一注意力</td><td class="nowrap"><button class="btn small bad" type="button" data-mc-row-act="del">删除</button></td>
              </tr>
              <tr>
                <td>新娘入场</td><td>____</td><td>B2（新娘）</td><td>停点：合影点 3 秒</td><td class="nowrap"><button class="btn small bad" type="button" data-mc-row-act="del">删除</button></td>
              </tr>
            </tbody>
          </table>

          <template id="fDefault" data-mc-default-for="fTable">
            <tr><td>迎宾</td><td>____</td><td>A1（迎宾）</td><td>提示：静音/洗手间/预告节点</td></tr>
            <tr><td>开场</td><td>____</td><td>A2（开场）</td><td>主持人上台，定调，统一注意力</td></tr>
            <tr><td>新娘入场</td><td>____</td><td>B2（新娘）</td><td>停点：合影点 3 秒</td></tr>
          </template>

          <div class="footer">建议：把“停点（3秒）”写进备注，摄影摄像更容易出片。</div>
        </details>

        <details>
          <summary>模板 3：万能“意义句”库（可增删改）<span class="tag">可保存</span></summary>
          <div class="table-tools">
            <button class="btn good" type="button" data-mc-action="add" data-mc-target="mTable">新增一行</button>
            <button class="btn" type="button" data-mc-action="load" data-mc-target="mTable">读取保存</button>
            <button class="btn warn" type="button" data-mc-action="save" data-mc-target="mTable">保存</button>
            <button class="btn bad" type="button" data-mc-action="reset" data-mc-target="mTable">恢复默认</button>
            <div class="status"><span class="dot" id="mDot"></span><span id="mStatus">未保存</span></div>
          </div>

          <table id="mTable" data-mc-key="wedding_mc_tpl_meaning" data-mc-prefix="m" data-mc-cols="3">
            <thead>
              <tr>
                <th class="nowrap">序号</th>
                <th>句子（可改）</th>
                <th>使用场景备注（可选）</th>
                <th class="nowrap">操作</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1</td><td>今天不是把婚礼办完，而是把日子开始。</td><td>开场/收尾</td><td class="nowrap"><button class="btn small bad" type="button" data-mc-row-act="del">删除</button></td>
              </tr>
              <tr>
                <td>2</td><td>这一刻的掌声，是所有祝福的合唱。</td><td>入场/仪式</td><td class="nowrap"><button class="btn small bad" type="button" data-mc-row-act="del">删除</button></td>
              </tr>
              <tr>
                <td>3</td><td>愿你们把热烈留给彼此，把温柔留给生活。</td><td>誓言/收尾</td><td class="nowrap"><button class="btn small bad" type="button" data-mc-row-act="del">删除</button></td>
              </tr>
              <tr>
                <td>4</td><td>爱不是突然的心动，而是长久的选择。</td><td>誓言/过渡</td><td class="nowrap"><button class="btn small bad" type="button" data-mc-row-act="del">删除</button></td>
              </tr>
            </tbody>
          </table>

          <template id="mDefault" data-mc-default-for="mTable">
            <tr><td>1</td><td>今天不是把婚礼办完，而是把日子开始。</td><td>开场/收尾</td></tr>
            <tr><td>2</td><td>这一刻的掌声，是所有祝福的合唱。</td><td>入场/仪式</td></tr>
            <tr><td>3</td><td>愿你们把热烈留给彼此，把温柔留给生活。</td><td>誓言/收尾</td></tr>
            <tr><td>4</td><td>爱不是突然的心动，而是长久的选择。</td><td>誓言/过渡</td></tr>
          </template>

          <div class="footer">你也可以把你的“地方口吻/人设语气”写进句子里，形成自己的标签。</div>
        </details>
      </section>

<section class="card" id="sources">
        <h2>10｜参考与来源（便于继续深挖）</h2>
        <ul>
          <li>集训课程常见模块与考核维度：声音、台风、台词音乐、形象服装，以及中/西式流程、声台行表、审美包装等。</li>
          <li>教练式司仪理念：强调新人是主角、赛前训练、脚本定制、现场引导与鼓励。</li>
          <li>添彩方向：强调审美提升、音乐与五感参与、标签打造、作品与报价匹配。</li>
        </ul>
        <div class="footer">
          本页除模板库外不依赖按钮脚本；模板库按钮为纯原生 JS + 本地存储，不用外部库。<br/>
          打印：浏览器菜单「打印」即可（自动隐藏按钮/目录）。
        </div>
      </section>

    </main>
  </div>
</div>


<script>
(function(){
  // 防止 #锚点在 srcdoc 场景下“跳到父页面”：统一在本 iframe 内滚动
  document.addEventListener('click', function(ev){
    var a = ev.target && ev.target.closest ? ev.target.closest('a[href^="#"]') : null;
    if(!a) return;
    var href = a.getAttribute('href');
    if(!href || href === '#') return;
    var id = href.slice(1);
    var el = document.getElementById(id);
    if(!el) return;
    ev.preventDefault();
    history.replaceState(null, '', href);
    el.scrollIntoView({behavior:'smooth', block:'start'});
  }, true);
})();
</script>



<script>
/* Wedding Handbook Templates Engine (v1.9)
   目标：在“注入加载/脚本不自动执行”的场景，你可以把这段脚本放到主程序的公共JS里；
   只要脚本在页面中运行一次，就会自动识别模板库并让按钮生效。
*/
(function(){
  'use strict';

  function $(root, sel){ return (root||document).querySelector(sel); }
  function $all(root, sel){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }

  function safeLS(){
    try{ return window.localStorage; }catch(e){ return null; }
  }

  function setStatus(prefix, state){
    var dot = document.getElementById(prefix+'Dot');
    var txt = document.getElementById(prefix+'Status');
    if(!dot || !txt) return;
    if(state==='ok'){ dot.className='dot ok'; txt.textContent='已保存'; }
    else if(state==='dirty'){ dot.className='dot warn'; txt.textContent='有未保存修改'; }
    else { dot.className='dot warn'; txt.textContent='未保存'; }
  }

  function markDirtyFromTable(t){
    if(!t) return;
    var prefix = t.getAttribute('data-mc-prefix') || '';
    if(prefix) setStatus(prefix, 'dirty');
  }

  function ensureRowShape(t, tr){
    var cols = parseInt(t.getAttribute('data-mc-cols')||'0',10);
    if(!cols) cols = Math.max(1, (t.tHead && t.tHead.rows[0] ? t.tHead.rows[0].cells.length-1 : (tr.cells.length-1)));
    // Ensure enough editable cells (exclude last action cell)
    // If row already has action cell with delete button, treat last cell as action.
    var hasAction = tr.querySelector('[data-mc-row-act="del"]') ? true : false;
    // Add missing cells
    while(tr.cells.length < cols + 1){
      tr.appendChild(document.createElement('td'));
    }
    // Make first cols editable
    for(var i=0;i<cols;i++){
      tr.cells[i].setAttribute('contenteditable','true');
    }
    // Ensure action cell
    var actionTd = tr.cells[cols];
    if(!actionTd) { actionTd = document.createElement('td'); tr.appendChild(actionTd); }
    actionTd.className = 'nowrap';
    if(!actionTd.querySelector('[data-mc-row-act="del"]')){
      var b = document.createElement('button');
      b.type='button';
      b.className='btn small bad';
      b.textContent='删除';
      b.setAttribute('data-mc-row-act','del');
      actionTd.innerHTML='';
      actionTd.appendChild(b);
    }
  }

  function initTable(t){
    if(!t || !t.tBodies || !t.tBodies[0]) return;
    var trs = Array.prototype.slice.call(t.tBodies[0].rows);
    trs.forEach(function(tr){ ensureRowShape(t, tr); });
  }

  function buildRow(t, cells){
    var tr = document.createElement('tr');
    var cols = parseInt(t.getAttribute('data-mc-cols')||'0',10);
    if(!cols) cols = cells.length;
    for(var i=0;i<cols;i++){
      var td = document.createElement('td');
      td.setAttribute('contenteditable','true');
      td.textContent = (cells && cells[i]) ? String(cells[i]) : '';
      tr.appendChild(td);
    }
    var tdA = document.createElement('td');
    tdA.className='nowrap';
    var b = document.createElement('button');
    b.type='button';
    b.className='btn small bad';
    b.textContent='删除';
    b.setAttribute('data-mc-row-act','del');
    tdA.appendChild(b);
    tr.appendChild(tdA);
    return tr;
  }

  function addRow(tableId){
    var t = document.getElementById(tableId);
    if(!t || !t.tBodies || !t.tBodies[0]) return;
    var cols = parseInt(t.getAttribute('data-mc-cols')||'3',10);
    var arr = [];
    for(var i=0;i<cols;i++) arr.push('');
    t.tBodies[0].appendChild(buildRow(t, arr));
    markDirtyFromTable(t);
  }

  function saveTable(tableId){
    var t = document.getElementById(tableId);
    if(!t || !t.tBodies || !t.tBodies[0]) return;
    var key = t.getAttribute('data-mc-key');
    if(!key) return alert('缺少存储键（data-mc-key）');
    var ls = safeLS();
    if(!ls) return alert('当前环境不可用本地存储（localStorage）。');
    try{
      var rows = $all(t.tBodies[0], 'tr').map(function(tr){
        var cols = parseInt(t.getAttribute('data-mc-cols')||'0',10) || (tr.cells.length-1);
        var arr=[];
        for(var i=0;i<cols;i++) arr.push((tr.cells[i].innerText||'').trim());
        return arr;
      });
      ls.setItem(key, JSON.stringify(rows));
      var prefix = t.getAttribute('data-mc-prefix')||'';
      if(prefix) setStatus(prefix,'ok');
    }catch(e){
      alert('保存失败：'+e.message);
    }
  }

  function loadTable(tableId){
    var t = document.getElementById(tableId);
    if(!t || !t.tBodies || !t.tBodies[0]) return;
    var key = t.getAttribute('data-mc-key');
    if(!key) return alert('缺少存储键（data-mc-key）');
    var ls = safeLS();
    if(!ls) return alert('当前环境不可用本地存储（localStorage）。');
    try{
      var raw = ls.getItem(key);
      if(!raw){ alert('没有找到已保存内容'); return; }
      var data = JSON.parse(raw);
      t.tBodies[0].innerHTML='';
      (data||[]).forEach(function(row){
        t.tBodies[0].appendChild(buildRow(t, row));
      });
      initTable(t);
      var prefix = t.getAttribute('data-mc-prefix')||'';
      if(prefix) setStatus(prefix,'ok');
    }catch(e){
      alert('读取失败：'+e.message);
    }
  }

  function resetTable(tableId){
    var t = document.getElementById(tableId);
    if(!t || !t.tBodies || !t.tBodies[0]) return;
    var defTpl = document.querySelector('template[data-mc-default-for="'+tableId+'"]');
    if(!defTpl) return alert('缺少默认模板（template[data-mc-default-for]）');
    var key = t.getAttribute('data-mc-key');
    var ls = safeLS();
    try{ if(ls && key) ls.removeItem(key); }catch(e){}
    t.tBodies[0].innerHTML='';
    // Parse template rows and rebuild
    var tmp = document.createElement('tbody');
    tmp.innerHTML = defTpl.innerHTML;
    var trs = $all(tmp, 'tr');
    trs.forEach(function(tr){
      var cols = parseInt(t.getAttribute('data-mc-cols')||'0',10) || tr.cells.length;
      var arr=[];
      for(var i=0;i<cols;i++){
        arr.push((tr.cells[i].innerText||'').trim());
      }
      t.tBodies[0].appendChild(buildRow(t, arr));
    });
    initTable(t);
    var prefix = t.getAttribute('data-mc-prefix')||'';
    if(prefix) setStatus(prefix,'dirty');
  }

  function handleClick(ev){
    var btn = ev.target.closest('button');
    if(!btn) return;
    // row delete
    if(btn.getAttribute('data-mc-row-act') === 'del'){
      var tr = btn.closest('tr');
      var t = btn.closest('table');
      if(tr) tr.remove();
      markDirtyFromTable(t);
      return;
    }
    // toolbar
    var act = btn.getAttribute('data-mc-action');
    var target = btn.getAttribute('data-mc-target');
    if(!act || !target) return;
    if(act==='add') addRow(target);
    else if(act==='save') saveTable(target);
    else if(act==='load') loadTable(target);
    else if(act==='reset') resetTable(target);
  }

  function handleInput(ev){
    var td = ev.target.closest('td[contenteditable="true"]');
    if(!td) return;
    var t = td.closest('table');
    if(!t) return;
    markDirtyFromTable(t);
  }

  function initAll(){
    var root = document;
    var sections = $all(root, '[data-mc-templates="1"]');
    sections.forEach(function(sec){
      if(sec.getAttribute('data-mc-inited') === '1') return;
      sec.setAttribute('data-mc-inited','1');
      // init each table
      $all(sec, 'table[data-mc-key]').forEach(initTable);
      // bind delegated events on section (isolated)
      sec.addEventListener('click', handleClick, true);
      sec.addEventListener('input', handleInput, true);
    });
  }

  // Public hook (for host app): window.WeddingHandbookTemplatesInit()
  window.WeddingHandbookTemplatesInit = initAll;

  // Auto-init now + observe later (for injected content)
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initAll);
  }else{
    initAll();
  }
  try{
    var mo = new MutationObserver(function(){ initAll(); });
    mo.observe(document.documentElement, {subtree:true, childList:true});
  }catch(e){}
})();
</script>


<script>
(function(){
  // 防止 #锚点在 srcdoc 场景下“跳到父页面”：统一在本 iframe 内滚动
  document.addEventListener('click', function(ev){
    var a = ev.target && ev.target.closest ? ev.target.closest('a[href^="#"]') : null;
    if(!a) return;
    var href = a.getAttribute('href');
    if(!href || href === '#') return;
    var id = href.slice(1);
    var el = document.getElementById(id);
    if(!el) return;
    ev.preventDefault();
    history.replaceState(null, '', href);
    el.scrollIntoView({behavior:'smooth', block:'start'});
  }, true);
})();
</script>

</body>
</html>

    </template>
  </section>

  
  <section class="view" id="viewLines">
    <div class="grid onecol">
      <main class="cards">
        <section class="card tipsInline" id="linesTipsInline">
          <div class="tipsHead">
            <div class="tipsTitle">使用建议</div>
            <button class="btn ghost" id="btnToggleLinesTips" type="button">展开</button>
          </div>
          <div class="tipsBody" id="linesTipsBody" hidden>
            <ul class="list">
            <li><b>先搜关键词</b>：开场 / 父母 / 证婚 / 敬酒 / 合影 / 退场。</li>
            <li><b>再改成你的口吻</b>：把“空话”换成具体动作与画面。</li>
            <li><b>做成你的“模板库”</b>：常用的就收藏（本模块支持本地保存）。</li>
          </ul>
            <div class="divider"></div>
            <div class="muted-small">
            这个模块后续也能扩展：增加更多分类、把台词一键插入到“客户专属台词”、或关联到音乐点位表。
          </div>
          </div>
        </section>

        <section class="card">
          <div class="hd">
            <h3><span class="num">🎙</span> 主持台词（大标题分类 / 搜索 / 可新增）</h3>
            <div class="tag">导入台词文件</div>
          </div>
          <div class="sub2">
            这里已把你提供的台词文件按「大标题」分组，并支持按 <b>标题 / 关键词 / 正文</b> 搜索。
            你也可以在这里新增分类与台词（会保存在本地，不影响原始库）。
          </div>

          <div class="linesLayout">
            <div class="linesLeft box">
              <div class="linesTools">
                <input id="linesSearch" class="input" placeholder="搜索：例如「开场 / 父母 / 敬酒 / 退场 / 元旦…」" />
                <div class="rowBtns">
                  <button class="sbtn primary" id="btnLinesNew">＋ 新建台词</button>
                  <button class="sbtn" id="btnLinesNewCat">＋ 新建分类</button>
                </div>
              </div>
              <div class="muted-small" style="margin-top:8px">分类（点击筛选）</div>
              <div class="linesCats" id="linesCats"></div>
            </div>

            <div class="linesMid box">
              <div class="linesMidHead">
                <div>
                  <div class="ls-title" id="linesListTitle">台词列表</div>
                  <div class="ls-sub muted-small" id="linesListSub">—</div>
                </div>
                <div class="rowBtns">
                  <button class="sbtn" id="btnLinesClearSearch">清空搜索</button>
                </div>
              </div>
              <div class="linesList" id="linesList"></div>
            </div>

            <div class="linesRight box">
              <div class="linesEdHead">
                <div>
                  <div class="ls-title">编辑台词</div>
                  <div class="ls-sub muted-small">直接修改内容即可；点击保存生效（支持新增/删除）。</div>
                </div>
              </div>

              <div class="field">
                <label>标题（可编辑）</label>
                <div id="linesEdTitle" class="edTitle" contenteditable="true" spellcheck="false">未选择</div>
              </div>

              <div class="form-grid" style="margin-top:10px">
                <div class="field">
                  <label>分类</label>
                  <select id="linesEdCat"></select>
                </div>
                <div class="field">
                  <label>关键词（用逗号隔开）</label>
                  <input id="linesEdTags" class="input" placeholder="例如：开场,新人,父母,敬酒" />
                </div>
              </div>

              <div class="field" style="margin-top:10px">
                <label>正文</label>
                <textarea id="linesEdBody" class="ta" rows="14" placeholder="在这里写台词内容…"></textarea>
              </div>

              <div class="rowBtns" style="justify-content:flex-end; margin-top:10px">
                <button class="sbtn" id="btnLinesCopy">复制</button>
                <button class="sbtn danger" id="btnLinesDelete">删除</button>
                <button class="sbtn primary" id="btnLinesSave">保存</button>
              </div>

              <div class="muted-small" style="margin-top:10px">
                提示：默认库里的台词你也可以改（会作为“覆盖层”保存到本地）；想恢复默认，可在台词列表里点“恢复默认”。
              </div>
            </div>
          </div>
        </section>
      </main>
</div>
  </section>


<section class="view active" id="viewSchedule">
    
<div class="schedule" id="scheduleWrap">
  <div class="sched-main">
  <div class="sched-top">
    <div class="sched-title">
      <h2 style="margin:0">档期记录</h2>
      <div class="sub2">一屏联动：<b>月历 + 当月列表</b>。上方显示<b>本月单量</b>与<b>有单日期</b>（点一下筛选）。</div>
    </div>
    <div class="sched-actions">
      <button class="btn primary" id="btnAddBooking">＋ 新增档期</button>
      <button class="btn" id="btnToday">今天</button>
      <button class="btn" id="btnPrevMonth">◀ 上月</button>
      <button class="btn" id="btnNextMonth">下月 ▶</button>
      <button class="btn ghost" id="btnOpenYearSummary" title="切换到年度总结（与档期记录互斥）">年度总结</button>
    </div>
  </div>

  <div class="sched-summary">
    <div class="stat">
      <div class="label">本月单量</div>
      <div class="value" id="statMonthCount">0</div>
      <div class="small" id="statMonthLabel">—</div>
    </div>
    <div class="stat">
      <div class="label">有单天数</div>
      <div class="value" id="statDayCount">0</div>
      <div class="small">= 有单日期数量</div>
    </div>
    <div class="stat">
      <div class="label">最近一场</div>
      <div class="value" id="statNext">—</div>
      <div class="small" id="statNextSub">—</div>
    </div>
    <div class="stat wide">
      <div class="label">哪一天有单？（点一下筛选）</div>
      <div class="days" id="orderDays"></div>
      <div class="small">提示：点“某天”会在右侧列表只显示这一天；点“全部”恢复。</div>
    </div>
  </div>

  <div class="sched-split">
    <div class="cal-card">
      <div class="cal-title">
        <div class="month" id="calMonthTitle">—</div>
        <div class="mini">点击日期：新增档期 / 点击卡片：编辑档期</div>
      </div>
      <div class="cal-head" id="calHead"></div>
      <div class="cal-body" id="calBody"></div>
    </div>

    <div class="list-card">
      <div class="list-title">
        <div class="month">当月列表</div>
        <div class="mini">默认只显示当前月；搜索支持：姓名/电话/酒店/日期</div>
      </div>
      <div class="list-toolbar">
        <input id="listSearch" placeholder="搜索客户：姓名/电话/酒店/日期…"/>
        <button class="btn" id="btnClearFilter">清空筛选</button>
      </div>
      <div class="list-wrap" id="listWrap"></div>
    </div>
  </div>
</div>
  <div class="ys-page hidden" id="yearSummaryPage">
  <div class="ys-topbar">
    <div class="muted-small">年度总结与档期记录互斥显示。这里按年份统计单量/收入/合作酒店。</div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <button class="btn" id="btnBackToSchedule">返回档期记录</button>
    </div>
  </div>

<div class="ys-card" id="yearSummaryCard">
    <div class="ys-head">
      <div>
        <div class="ys-title">年度总结</div>
        <div class="ys-sub">收入按<b>服务费用</b>统计；合作单按<b>婚宴酒店</b>归类。</div>
      </div>
      <div class="ys-actions">
        <select id="ysYear" class="ys-select" title="选择年份"></select>
        <button class="btn" id="btnYsThisYear">今年</button>
      </div>
    </div>

    <div class="ys-stats">
      <div class="ys-stat">
        <div class="k">全年单量</div>
        <div class="v" id="ysTotalCount">0</div>
      </div>
      <div class="ys-stat">
        <div class="k">全年收入</div>
        <div class="v" id="ysTotalIncome">0</div>
      </div>
      <div class="ys-stat">
        <div class="k">合作单</div>
        <div class="v" id="ysCollabCount">0</div>
      </div>
      <div class="ys-stat">
        <div class="k">直客单</div>
        <div class="v" id="ysDirectCount">0</div>
      </div>
    </div>
    <div class="ys-grid">
      <div class="ys-panel ys-notes">
        <div class="ys-panel-title">年度总结要点（可编辑，自动保存）</div>
        <textarea id="ysNotes" class="ys-notes-ta" placeholder="这里会按当前数据自动生成一份年度总结；你也可以自己改，系统会按年份自动保存。"></textarea>
        <div class="ys-note-actions">
          <button class="sbtn" id="btnYsAutoNote" type="button">重生成（按当前数据）</button>
          <button class="sbtn primary" id="btnYsCopyNote" type="button">复制总结</button>
          <button class="sbtn" id="btnYsClearNote" type="button">清空</button>
        </div>
        <div class="muted-small" style="margin-top:8px">提示：服务费/合作单/酒店信息越完整，年度总结越准确。</div>
      </div>
<div class="ys-panel">
        <div class="ys-panel-title">每月单量</div>
        <canvas id="ysChartOrders" height="160"></canvas>
      </div>
      <div class="ys-panel">
        <div class="ys-panel-title">每月收入（元）</div>
        <canvas id="ysChartIncome" height="160"></canvas>
      </div>
      <div class="ys-panel">
        <div class="ys-panel-title">合作单 vs 直客单</div>
        <canvas id="ysChartMix" height="190"></canvas>
      </div>
      <div class="ys-panel">
        <div class="ys-panel-title">合作酒店统计（按单量）</div>
        <div id="ysHotelList" class="ys-hotel-list"></div>
      </div>
    </div>

    <div class="ys-table-wrap">
      <div class="ys-panel-title">月度明细</div>
      <div id="ysTable" class="ys-table"></div>
    </div>
  </div>


<!-- Booking Modal -->

  </div>
</div>

  <div class="modal" id="bookingModal" aria-hidden="true">
  <div class="modal-backdrop" data-close="1"></div>
  <div class="modal-panel" role="dialog" aria-modal="true">
    <div class="modal-head">
      <div>
        <div class="modal-title" id="modalTitle">新增档期</div>
        <div class="modal-sub" id="modalSub">填写客户信息，并选择关联环节（可写客户专属台词）。</div>
      </div>
      <button class="iconbtn" data-close="1" title="关闭">✕</button>
    </div>

    <div class="modal-body">
      <div class="form-grid">
        <div class="field">
          <label>婚期（日期）</label>
          <input type="date" id="f_date"/>
        </div>
        <div class="field">
          <label>时间（可选）</label>
          <input type="time" id="f_time"/>
        </div>

        <div class="field">
          <label>客户姓名</label>
          <input type="text" id="f_clientName" placeholder="例如：张三"/>
        </div>
        <div class="field">
          <label>联系方式</label>
          <input type="text" id="f_phone" placeholder="手机号/微信"/>
        </div>

        <div class="field">
          <label>新郎名字（可选）</label>
          <input type="text" id="f_groom" placeholder="用于替换台词里的【新郎】"/>
        </div>
        <div class="field">
          <label>新娘名字（可选）</label>
          <input type="text" id="f_bride" placeholder="用于替换台词里的【新娘】"/>
        </div>

        <div class="field">
          <label>婚宴酒店</label>
          <input type="text" id="f_hotel" placeholder="例如：XX大酒店"/>
        </div>
        <div class="field">
          <label>宴会厅/场地（可选）</label>
          <input type="text" id="f_hall" placeholder="例如：一号厅"/>
        </div>


        <div class="field">
          <label>服务费用（元）</label>
          <input type="number" id="f_serviceFee" placeholder="例如：3000" min="0" step="1"/>
        </div>
        <div class="field">
          <label>定金（元）</label>
          <input type="number" id="f_deposit" placeholder="例如：500" min="0" step="1"/>
        </div>
        <div class="field">
          <label>尾款（元）</label>
          <input type="number" id="f_balance" placeholder="例如：2500" min="0" step="1"/>
        </div>
        <div class="field">
          <label>是否合作单</label>
          <div class="checkRow">
            <input type="checkbox" id="f_isCollab"/>
            <span>合作单（按婚宴酒店统计）</span>
          </div>
        </div>

        <div class="field" style="grid-column:1/-1">
          <label>备注（可选）</label>
          <textarea id="f_notes" rows="3" placeholder="例如：中式/户外/证婚人是谁/需要手捧花环节等"></textarea>
        </div>
      </div>

      <div class="divider"></div>

      <div class="link-sections">
        <div class="ls-head">
          <div>
            <div class="ls-title">关联婚礼环节</div>
            <div class="ls-sub">勾选该客户要用到的环节（之后可在下方编辑“客户专属台词”）。</div>
          </div>
          <div class="ls-actions">
            <button class="sbtn" id="btnAllSections">全选</button>
            <button class="sbtn" id="btnClearSections">清空</button>
          </div>
        </div>
        <div class="chip-grid" id="sectionChips"></div>
      </div>

      <div class="divider"></div>

      <div class="timelineBox">
        <div class="ls-head">
          <div>
            <div class="ls-title">环节时间轴</div>
            <div class="ls-sub muted-small">把“基础婚礼环节”变成可执行的时间节点（支持新增/改名/排序/删除）。</div>
          </div>
          <div class="rowBtns">
            <button class="sbtn" id="btnGenTimeline">一键生成基础时间轴</button>
            <button class="sbtn" id="btnAddTimelineRow">＋ 添加节点</button>
            <button class="sbtn" id="btnPrintCue">打印 Cue Sheet</button>
                <button class="sbtn danger" id="btnClearTimeline">清空</button>
          </div>
        </div>

        <div class="timelineWrap">
          <div class="timelineHead">
            <div>时间</div>
            <div>环节</div>
            <div>备注</div>
            <div style="text-align:right">操作</div>
          </div>
          <div class="timelineList" id="timelineList"></div>
        </div>

        <div class="muted-small" style="margin-top:8px">
          规则：默认以“主持人开场”作为起点；“暖场”自动提前；其余按常见节奏预填，你可以随时调整。
        </div>
      </div>

      <div class="client-scripts">
        <div class="cs-head">
          <div>
            <div class="ls-title">客户专属台词（可选）</div>
            <div class="ls-sub">只对当前客户生效；未编辑的环节会默认使用“通用台词库”。</div>
          </div>
          <div class="cs-actions">
            <button class="sbtn" id="btnGenPreview">用客户信息预览替换</button>
          </div>
        </div>
        <div class="cs-wrap" id="clientScriptsWrap">
          <div class="muted-small">提示：先在上面勾选“关联婚礼环节”，这里才会显示对应环节的专属台词编辑器。</div>
        </div>
      </div>
    </div>

    <div class="modal-foot">
      <div class="left">
        <button class="btn danger" id="btnDeleteBooking" style="display:none">删除</button>
      </div>
      <div class="right">
        <button class="btn" data-close="1">取消</button>
        <button class="btn primary" id="btnSaveBooking">保存档期</button>
      </div>
    </div>
  </div>
</div>

  </section>

  <section class="view" id="viewSocial">
    <div class="grid onecol">
      <main class="cards" id="hostSocialCards">
        <section class="card" style="padding:0; overflow:hidden">
          <div style="padding:14px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap">
            <div style="min-width:220px">
              <div style="font-weight:800; font-size:16px; letter-spacing:.2px">📱 主持人自媒体入门与进阶（工作台）</div>
              <div class="sub2" style="margin-top:6px">已内嵌：小红书 × 抖音 · 专业工作台 v6.3（主题/圆角/配色跟随主程序，不新开窗口）。</div>
            </div>
            <div style="display:flex; gap:10px; align-items:center">
              <button class="btn" id="btnReloadHostSocial" type="button" title="重新加载工作台">🔄 重载</button>
            </div>
          </div>

          <iframe
            id="hostSocialFrame"
            title="主持人自媒体入门与进阶"
            style="width:100%; height:72vh; border:0; display:block; background:transparent"
          ></iframe>
        </section>
      </main>
    </div>

    <template id="hostSocialTpl">
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<base href="about:srcdoc">
<title>主持人自媒体入门与进阶手册（小红书 × 抖音）</title>
<meta name="description" content="离线单页HTML：平台算法拆解、内容体系、对标库、爆款方法、标题/文案/脚本生成器、拍摄日历、数据复盘与执行SOP。">
<style>
:root{
  --bg:#0b0f17; --panel:#121a2a; --panel2:#0f1626; --text:#e8edf7; --muted:#a8b3c7;
  --line:rgba(255,255,255,.08); --accent:#6ea8ff; --good:#51d19a; --warn:#ffcc66; --bad:#ff6b6b;
  --shadow: 0 10px 30px rgba(0,0,0,.28);
  --radius:18px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  --sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, "Noto Sans CJK SC", sans-serif;
}
[data-theme="light"]{
  --bg:#f7f9fc; --panel:#ffffff; --panel2:#ffffff; --text:#0c1220; --muted:#5b6476;
  --line:rgba(15,20,35,.10); --accent:#2f6bff; --shadow: 0 12px 32px rgba(20,35,80,.12);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:var(--sans);
  background: radial-gradient(1200px 600px at 20% -10%, rgba(110,168,255,.25), transparent 60%),
              radial-gradient(900px 500px at 100% 0%, rgba(81,209,154,.18), transparent 55%),
              var(--bg);
  color:var(--text);
}
a{color:var(--accent); text-decoration:none}
a:hover{text-decoration:underline}
kbd{
  font-family:var(--mono);
  border:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  padding:.1rem .35rem;
  border-radius:8px;
  font-size:.9em;
}
.wrapper{
  display:grid;
  grid-template-columns: 320px 1fr;
  height:100%;
}
header{
  position:sticky; top:0; z-index:5;
  display:flex; gap:10px; align-items:center; justify-content:space-between;
  padding:14px 16px;
  border-bottom:1px solid var(--line);
  background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0));
  backdrop-filter: blur(10px);
}
[data-theme="light"] header{
  background: linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.45));
}
.brand{
  display:flex; flex-direction:column; gap:3px;
}
.brand h1{
  margin:0; font-size:16px; letter-spacing:.2px;
}
.brand .sub{
  font-size:12px; color:var(--muted);
}
.top-actions{
  display:flex; gap:8px; align-items:center;
}
.btn{
  appearance:none; border:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  color:var(--text);
  padding:9px 10px;
  border-radius:12px;
  cursor:pointer;
  font-size:13px;
}
.btn:hover{border-color:rgba(110,168,255,.35)}
.btn:active{transform:translateY(1px)}
.iconbtn{
  display:inline-flex; align-items:center; gap:8px;
}
.input{
  border:1px solid var(--line);
  background:rgba(0,0,0,.12);
  color:var(--text);
  padding:9px 10px;
  border-radius:12px;
  width: 100%;
  outline:none;
}

[data-theme="light"] .input{background:rgba(15,20,35,.04)}
.nav{
  border-right:1px solid var(--line);
  background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.00));
}
.nav-inner{
  padding:14px 14px 18px;
  height:calc(100% - 64px);
  overflow:auto;
}
.nav .group{margin:10px 0 16px}
.nav .group-title{
  font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.14em;
  margin:12px 10px 8px;
}
.nav a{
  display:flex; gap:10px; align-items:center;
  padding:10px 12px;
  border-radius:14px;
  color:var(--text);
  border:1px solid transparent;
}
.nav a:hover{background:rgba(110,168,255,.10); border-color:rgba(110,168,255,.18)}
.nav a.active{background:rgba(110,168,255,.16); border-color:rgba(110,168,255,.28)}
.badge{
  margin-left:auto;
  font-size:12px;
  color:var(--muted);
  border:1px solid var(--line);
  padding:2px 8px;
  border-radius:999px;
}
.main{
  overflow:auto;
}
.content{
  max-width: 1040px;
  margin: 0 auto;
  padding: 14px 18px 80px;
}
.card{
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid var(--line);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 16px;
  margin: 12px 0;
}
.grid{
  display:grid; gap:12px;
}
.grid-2{grid-template-columns:1fr 1fr}
.grid-3{grid-template-columns:1fr 1fr 1fr}
@media (max-width: 980px){
  .wrapper{grid-template-columns: 1fr}
  .nav{position:fixed; left:0; top:0; bottom:0; width:320px; transform:translateX(-105%); transition:.25s; z-index:10}
  .nav.open{transform:translateX(0)}
  .input{width: 170px}
  .grid-2,.grid-3{grid-template-columns:1fr}
}
h2{margin:10px 0 0; font-size:20px}
h3{margin:14px 0 8px; font-size:16px}
p{margin:10px 0; color:var(--text); line-height:1.65}
.small{font-size:13px; color:var(--muted)}

label{
  display:flex;
  flex-direction:column;
  gap:6px;
  font-size:13px;
  color:var(--muted);
}
label input, label select{
  font-size:14px;
}
input[type="number"]{font-variant-numeric: tabular-nums;}

hr{border:0; border-top:1px solid var(--line); margin:16px 0}
.pill{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 10px;
  border:1px solid var(--line);
  border-radius:999px;
  background:rgba(0,0,0,.10);
  font-size:13px;
  color:var(--muted);
}
[data-theme="light"] .pill{background:rgba(15,20,35,.04)}
.callout{
  border-left:4px solid rgba(110,168,255,.8);
  background: rgba(110,168,255,.10);
  padding:12px 12px;
  border-radius: 14px;
}
.formula .card{background:rgba(0,0,0,.10)}
.formula .pill{background:rgba(0,0,0,.14)}
.formula ol{padding-left:14px}
.callout.good{border-left-color:rgba(81,209,154,.9); background:rgba(81,209,154,.10)}
.callout.warn{border-left-color:rgba(255,204,102,.95); background:rgba(255,204,102,.12)}
.callout.bad{border-left-color:rgba(255,107,107,.95); background:rgba(255,107,107,.10)}
details{
  border:1px solid var(--line);
  border-radius: 14px;
  background: rgba(0,0,0,.08);
  padding: 10px 12px;
}
[data-theme="light"] details{background:rgba(15,20,35,.03)}
details summary{
  cursor:pointer;
  font-weight:700;
  list-style:none;
}
details summary::-webkit-details-marker{display:none}
details .inner{padding:10px 2px 2px}
table{width:100%; border-collapse:collapse; overflow:hidden; border-radius: 14px; border:1px solid var(--line)}
th,td{padding:10px 10px; border-bottom:1px solid var(--line); vertical-align:top; font-size:13px}
th{background:rgba(0,0,0,.12); text-align:left; color:var(--muted); font-weight:700}
[data-theme="light"] th{background:rgba(15,20,35,.05)}
tr:last-child td{border-bottom:0}
.mono{font-family:var(--mono)}
.flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
textarea{
  width:100%;
  min-height: 120px;
  resize: vertical;
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px 12px;
  background: rgba(0,0,0,.10);
  color: var(--text);
  outline:none;
  line-height:1.55;
}
[data-theme="light"] textarea{background:rgba(15,20,35,.04)}
select{
  border:1px solid var(--line);
  border-radius:12px;
  padding:9px 10px;
  background: rgba(0,0,0,.10);
  color: var(--text);
  width: 100%;
  outline:none;
}

[data-theme="light"] select{background:rgba(15,20,35,.04)}
input[type="text"],input[type="date"],input[type="number"]{
  border:1px solid var(--line);
  border-radius:12px;
  padding:9px 10px;
  background: rgba(0,0,0,.10);
  color: var(--text);
  outline:none;
}
[data-theme="light"] input[type="text"],[data-theme="light"] input[type="date"],[data-theme="light"] input[type="number"]{background:rgba(15,20,35,.04)}
.split{
  display:grid; gap:12px; grid-template-columns: 1.1fr .9fr;
}
@media (max-width: 980px){ .split{grid-template-columns:1fr} }
.tag{
  display:inline-block;
  font-size:12px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid var(--line);
  color:var(--muted);
  margin:2px 6px 0 0;
}
.copy{
  float:right;
  font-size:12px;
}
.sticky-tools{
  position:fixed;
  right:14px;
  bottom:14px;
  display:flex;
  gap:10px;
  z-index: 20;
}
.toast{
  position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
  background:rgba(0,0,0,.65);
  border:1px solid rgba(255,255,255,.10);
  color:#fff;
  padding:10px 12px;
  border-radius:14px;
  backdrop-filter: blur(10px);
  display:none;
  z-index: 30;
}
[data-theme="light"] .toast{background:rgba(20,30,50,.70)}
.print-hide{display:block}
@media print{
  body{background:#fff}
  header,.nav,.sticky-tools,.print-hide{display:none !important}
  .wrapper{grid-template-columns:1fr}
  .content{max-width: 100%; padding: 0}
  .card{box-shadow:none}
}

.pill input{margin:0; accent-color: var(--accent);}

/* --------- v6 Workspace upgrades --------- */

/* v6: metrics layout tighten */
.metrics-grid{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
@media (max-width:980px){.metrics-grid{grid-template-columns:1fr}}
.metrics-grid input[type="number"], .metrics-grid input[type="text"]{width:100%}

.wizard{
  display:flex; flex-direction:column; gap:10px;
}
.stepbar{
  display:flex; gap:8px; flex-wrap:wrap; align-items:center;
}
.stepchip{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 10px;
  border:1px solid var(--line);
  border-radius:999px;
  background:rgba(0,0,0,.08);
  color:var(--muted);
  font-size:13px;
}
[data-theme="light"] .stepchip{background:rgba(15,20,35,.03)}
.stepchip.active{
  border-color:rgba(110,168,255,.35);
  background:rgba(110,168,255,.10);
  color:var(--text);
}
.stepbox{
  border:1px solid var(--line);
  border-radius: var(--radius);
  background:rgba(0,0,0,.06);
  padding:12px;
}
[data-theme="light"] .stepbox{background:rgba(15,20,35,.03)}
.stepbox h4{margin:0 0 8px; font-size:14px}
.row2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
.row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
@media (max-width:980px){ .row2,.row3{grid-template-columns:1fr} }

.kv{
  display:flex; justify-content:space-between; gap:10px; align-items:center;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:14px;
  background:rgba(0,0,0,.06);
}
[data-theme="light"] .kv{background:rgba(15,20,35,.03)}
.kv b{font-size:13px}
.kv span{font-size:12px; color:var(--muted)}
.cardhead{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  margin-bottom:8px;
}
.cardhead h3{margin:0}
.mini{
  font-size:12px; color:var(--muted);
}
.btn.primary{
  border-color: rgba(110,168,255,.35);
  background: rgba(110,168,255,.12);
}
.btn.primary:hover{border-color: rgba(110,168,255,.55)}
.btn.ghost{
  background:transparent;
}
.output-grid{
  display:grid; gap:12px;
}
.outcard{
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid var(--line);
  border-radius: var(--radius);
  padding: 14px;
}
.outcard textarea{min-height:120px}
.outcard textarea.compact{min-height:86px}
.toolbar{
  display:flex; gap:8px; flex-wrap:wrap; align-items:center;
}
.presetlist{
  display:flex; gap:8px; flex-wrap:wrap;
}
.presetpill{
  display:inline-flex; gap:8px; align-items:center;
  padding:8px 10px;
  border:1px solid var(--line);
  border-radius:999px;
  background:rgba(0,0,0,.06);
  cursor:pointer;
  font-size:13px;
  color:var(--text);
}
[data-theme="light"] .presetpill{background:rgba(15,20,35,.03)}
.presetpill:hover{border-color:rgba(110,168,255,.35)}
.smallhelp{font-size:12px; color:var(--muted); line-height:1.55}


/* status bar */
#statusBar{position:sticky; top:10px; z-index:2}
#statusBar b{font-size:13px}
#statusBar #statusSub{font-size:12px; color:var(--muted)}

</style>
<style id="__host_embed_tweaks">
/* === Embedded in 主持人学习手册：目录默认收起（右侧小按钮打开） === */
body{ background: transparent !important; }
.wrapper{ grid-template-columns: 1fr !important; }

/* 隐藏工作台自身顶部栏，避免“导航套导航” */
main#main > header, main.main > header{ display:none !important; }
#openNavBtn, #closeNavBtn{ display:none !important; }
.sticky-tools{ display:none !important; }

/* 目录：改为右侧抽屉（默认收起） */
aside#nav, aside.nav{
  display:block !important;
  position: fixed !important;
  top: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  width: min(320px, 86vw) !important;
  transform: translateX(110%) !important;
  transition: transform .22s ease !important;
  z-index: 9999 !important;
  background: var(--panel) !important;
  border-left: 1px solid var(--line) !important;
  box-shadow: var(--shadow) !important;
  overflow: auto !important;
  padding-bottom: 14px !important;
}

/* 抽屉打开 */
body.hostNavOpen aside#nav,
body.hostNavOpen aside.nav{
  transform: translateX(0) !important;
}

/* 背景遮罩 */
#hostEmbedCatalogBackdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.28);
  opacity: 0;
  pointer-events: none;
  transition: opacity .18s ease;
  z-index: 9998;
}
body.hostNavOpen #hostEmbedCatalogBackdrop{
  opacity: 1;
  pointer-events: auto;
}

/* 右侧“目录”小按钮 */
#hostEmbedCatalogBtn{
  position: fixed;
  right: 14px;
  top: 14px;
  z-index: 10000;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: color-mix(in oklab, var(--panel) 92%, transparent);
  color: var(--text);
  font-size: 12px;
  line-height: 1;
  box-shadow: 0 10px 30px rgba(0,0,0,.10);
  cursor: pointer;
  user-select: none;
}
#hostEmbedCatalogBtn:active{ transform: translateY(1px); }
#hostEmbedCatalogBtn .dot{
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 20%, transparent);
}
body.hostNavOpen #hostEmbedCatalogBtn{
  border-color: color-mix(in oklab, var(--accent) 45%, var(--line));
}

/* 内容更贴合主程序容器 */
.content{ max-width: 100% !important; padding: 0 0 80px !important; margin: 0 auto !important; }
.card{ border-radius: 16px !important; }

/* 小屏优化：按钮不遮挡搜索栏 */
@media (max-width: 560px){
  #hostEmbedCatalogBtn{ top: 10px; right: 10px; padding: 8px 10px; }
}
</style>
</head>

<body data-theme="dark" class="hostEmbed">
<div class="wrapper">

  <aside class="nav" id="nav">
    <header>
      <div class="brand">
        <h1>主持人自媒体手册</h1>
        <div class="sub">入门 → 进阶 → 稳定增长（离线可用）</div>
      </div>
      <button class="btn print-hide" id="closeNavBtn" title="关闭菜单">✕</button>
    </header>
    <div class="nav-inner" id="navInner">
      <div class="group">
        <div class="group-title">快速开始</div>
        <a href="#start" class="navlink">开局路线图 <span class="badge">30天</span></a>
        <a href="#positioning" class="navlink">定位与人设 <span class="badge">IP</span></a>
      </div>
      <div class="group">
        <div class="group-title">平台机制</div>
        <a href="#douyin" class="navlink">抖音推送机制拆解 <span class="badge">推荐</span></a>
        <a href="#xhs" class="navlink">小红书推送机制拆解 <span class="badge">搜索</span></a>
        <a href="#rules" class="navlink">合规与避坑 <span class="badge">安全</span></a>
      </div>
      <div class="group">
        <div class="group-title">内容系统</div>
        <a href="#pillars" class="navlink">内容支柱与栏目 <span class="badge">持续</span></a>
        <a href="#formats" class="navlink">爆款形式与拍法 <span class="badge">模板</span></a>
        <a href="#xuehui-wulang" class="navlink">薛辉×小五狼方法融合 <span class="badge">进阶</span></a>
        <a href="#anxiansheng" class="navlink">安先生：新媒体导演思维（主持人版） <span class="badge">导演</span></a>
        <a href="#benchmark" class="navlink">对标库与拆解表 <span class="badge">对标</span></a>
      </div>
      <div class="group">
        <div class="group-title">工具箱</div>
        <a href="#generator" class="navlink">标题/文案/脚本生成器 <span class="badge">一键</span></a>
        <a href="#launch-restart" class="navlink">新号起号 & 老号重启 <span class="badge">SOP</span></a>
        <a href="#calendar" class="navlink">拍摄日历生成器 <span class="badge">排期</span></a>
        <a href="#review" class="navlink">数据复盘与诊断 <span class="badge">迭代</span></a>
      </div>
      <div class="group">
        <div class="group-title">资料</div>
        <a href="#resources" class="navlink">素材与SOP清单 <span class="badge">执行</span></a>
        <a href="#sources" class="navlink">参考来源（链接） <span class="badge">引用</span></a>
      </div>
      <div class="group">
        <div class="group-title">数据存档</div>
        <a href="#backup" class="navlink">导出/导入（本地保存） <span class="badge">local</span></a>
      </div>
      <p class="small" style="padding:6px 10px 0;">
        提示：本页面支持本地保存（浏览器 localStorage），可导出 JSON 备份；也可直接打印成纸质手册。
      </p>
    </div>
  </aside>

  <main class="main" id="main">
    <header>
      <div class="brand">
        <h1>主持人自媒体入门与进阶手册</h1>
        <div class="sub">小红书 × 抖音｜算法拆解｜内容体系｜对标库｜爆款工具｜拍摄日历</div>
      </div>
      <div class="top-actions print-hide">
        <button class="btn" id="openNavBtn" title="打开菜单">☰</button>
        <input class="input" id="searchBox" type="text" placeholder="搜索：例如「完播」「婚礼流程」「对标」「日历」">
        <button class="btn" id="themeBtn" title="切换主题">🌗</button>
        <button class="btn" id="printBtn" title="打印/导出PDF">🖨️</button>
      </div>
    </header>

    <div class="content" id="content">

      <section id="start" class="card">
        <div class="flex">
          <span class="pill">🎯 目标：持续稳定输出 → 提升知名度 → 提升咨询/单量</span>
          <span class="pill">⏱️ 适用：0-1万粉起号 & 1-10万粉提效</span>
          <span class="pill">🧩 方法：内容系统 + 算法适配 + 复盘迭代</span>
        </div>
        <h2>30 天开局路线图（照着做就能跑起来）</h2>
        <p class="small">你只需要做三件事：<b>选定 5 个栏目</b>、<b>批量生产 30 条</b>、<b>每周复盘 1 次</b>。下面是“最稳”的安排：</p>

        <div class="grid grid-3">
          <div class="card" style="margin:0">
            <h3>第 1 周：建模</h3>
            <ul>
              <li>确定定位：你解决谁的什么问题？</li>
              <li>做 5 个固定栏目（见后文）</li>
              <li>拍 7 条「同一风格」内容，训练算法识别</li>
              <li>建立评论话术与私信引导</li>
            </ul>
          </div>
          <div class="card" style="margin:0">
            <h3>第 2–3 周：放量</h3>
            <ul>
              <li>每周 10–14 条：2 条干货 + 2 条故事 + 2 条避坑 + 2 条现场切片 + 2 条同城</li>
              <li>每条都写「可复用标题公式」</li>
              <li>同主题做 A/B：标题、开头、封面只改 1 项</li>
              <li>开始做「搜索词布局」（小红书更关键）</li>
            </ul>
          </div>
          <div class="card" style="margin:0">
            <h3>第 4 周：稳定转化</h3>
            <ul>
              <li>把爆款拆成系列：同一个主题连发 3 条（上中下）</li>
              <li>直播/连麦/评论区答疑（至少 1 次）</li>
              <li>把“业务入口”固定化：主页置顶 + 评论置顶</li>
              <li>做一次「复盘诊断」：看留存/转粉/搜索</li>
            </ul>
          </div>
        </div>

        <div class="callout good">
          <b>最关键的认知：</b>爆款不是运气，是「选题命中 + 开头留人 + 结构清晰 + 互动引导」的结果。你只要把每一条都当作一次“小实验”，复盘就会越来越准。
        </div>
      </section>

      <section id="positioning" class="card">
        <h2>定位与人设：主持人最容易做大的 3 条路</h2>
        <div class="grid grid-3">
          <div class="card" style="margin:0">
            <h3>① 备婚“结果导向”</h3>
            <p class="small">核心：给新人一个可抄作业的方案。</p>
            <div>
              <span class="tag">流程清单</span><span class="tag">避坑</span><span class="tag">主持稿</span><span class="tag">仪式设计</span>
            </div>
            <ul>
              <li>“一场婚礼最容易翻车的 7 个点”</li>
              <li>“新人不尴尬的誓词模板”</li>
              <li>“父母致辞怎么说不俗？”</li>
            </ul>
          </div>
          <div class="card" style="margin:0">
            <h3>② 现场“掌控感”</h3>
            <p class="small">核心：你能救场、能控场，给观众情绪爽感。</p>
            <div>
              <span class="tag">救场</span><span class="tag">控场</span><span class="tag">临场话术</span><span class="tag">反差</span>
            </div>
            <ul>
              <li>“宾客起哄/冷场我怎么救？”</li>
              <li>“伴郎伴娘抢麦怎么办？”</li>
              <li>“新人哭到说不出话，我怎么接？”</li>
            </ul>
          </div>
          <div class="card" style="margin:0">
            <h3>③ 同城“信任资产”</h3>
            <p class="small">核心：把你做成“本地婚礼百科 + 口碑入口”。</p>
            <div>
              <span class="tag">同城</span><span class="tag">案例</span><span class="tag">供应链</span><span class="tag">探店</span>
            </div>
            <ul>
              <li>“本地婚宴酒店怎么选不踩雷”</li>
              <li>“婚礼预算 2w/5w/10w 怎么分配”</li>
              <li>“XX风格婚礼，本地哪里最适合办”</li>
            </ul>
          </div>
        </div>

        <div class="callout warn">
          <b>建议你只选 1 条主线 + 2 条副线。</b>起号阶段“内容越聚焦越容易被算法识别”。当你稳定起量后，再扩展到第二条主线。
        </div>
      </section>

      <section id="douyin" class="card">
        <h2>抖音推送机制拆解：你要抓住的不是“玄学”，是指标</h2>
        <p>抖音/短视频推荐的通用逻辑可以用一句话概括：<b>先小范围测试 → 数据达标就进入更大的流量池 → 反复迭代</b>。系统会根据用户互动信号与视频信息进行匹配与排序（点赞/评论/关注/转发、标题/话题、观看行为等）。</p>

        <div class="split">
          <div class="card" style="margin:0">
            <h3>你必须理解的 4 层指标（从强到弱）</h3>
            <table>
              <thead>
                <tr><th>层级</th><th>指标（更强的信号权重大）</th><th>你该怎么做</th></tr>
              </thead>
              <tbody>
                <tr>
                  <td><b>留存</b></td>
                  <td>2 秒/5 秒留存、平均观看时长、完播/复看</td>
                  <td>开头 1 句话就给“冲突/结果/反差”；脚本每 5–8 秒给一个转折；结尾留悬念让人复看</td>
                </tr>
                <tr>
                  <td><b>互动</b></td>
                  <td>评论、转发、收藏、点赞</td>
                  <td>每条内容必须设计 1 个“评论点”：让观众站队/补充/提问</td>
                </tr>
                <tr>
                  <td><b>转粉</b></td>
                  <td>关注、主页访问、私信</td>
                  <td>把“你是谁+你能解决什么”固定写进简介和置顶；评论区置顶：领取清单/模板</td>
                </tr>
                <tr>
                  <td><b>匹配</b></td>
                  <td>标题/话题/文案关键词、同城、兴趣相似</td>
                  <td>标题里放核心词；话题不要堆；同城内容要“场景化+地点信息”</td>
                </tr>
              </tbody>
            </table>
            <p class="small">补充：公开解释中提到，完播等强兴趣信号权重更高，而设备/地区等设置权重较低；粉丝数本身不是直接因素（但粉丝会带来更多初始观看）。</p>
          </div>

          <div class="card" style="margin:0">
            <h3>主持人抖音的“最稳爆”三件套</h3>
            <ol>
              <li><b>现场切片</b>：10–30 秒一个“高能点”（哭、笑、反转、掌控）</li>
              <li><b>避坑清单</b>：新人/父母最怕的坑，给到“可执行”句子或流程</li>
              <li><b>反差故事</b>：失败→转机→方法（让人相信你真的打过仗）</li>
            </ol>
            <details>
              <summary>抖音脚本模板（30–45 秒口播）</summary>
              <div class="inner">
                <p class="mono">0–3s：一句话戳痛点/结果（“别再让司仪背锅了，翻车就这 3 个坑”）</p>
                <p class="mono">3–10s：场景（“我主持了 500+ 场，最多的翻车现场是…”）</p>
                <p class="mono">10–35s：方法/清单（分 3 点，每点一句结论 + 一句例子）</p>
                <p class="mono">35–45s：引导互动（“你最担心哪一个？评论我发模板”）</p>
              </div>
            </details>
            <div class="callout good">
              <b>起量秘诀：</b>同一主题连发 3 条（上/中/下），让算法更快“确定你是谁”，也让观众更愿意关注追更。
            </div>
          </div>
        </div>
      </section>

      <section id="xhs" class="card">
        <h2>小红书推送机制拆解：搜索 + 收录 + 标签 + 阶梯推荐</h2>
        <p>小红书更像“社交搜索引擎”：你的笔记会经历 <b>审核 → 收录 → 标签分类 → 小流量测试 → 阶梯放大</b>。要稳定拿流量，你必须把内容做成“能被搜到、能被收藏、能被讨论”的形态。</p>

        <div class="grid grid-2">
          <div class="card" style="margin:0">
            <h3>小红书的关键：关键词与收录</h3>
            <ul>
              <li><b>标题关键词</b>：决定你是谁、能不能被搜到；标题是平台识别内容属性的重要入口。</li>
              <li><b>正文关键词</b>：在正文/分点/评论里自然出现（不要堆砌）。</li>
              <li><b>热词与联想</b>：搜索框默认提示词、热搜、联想词，就是你要“借力”的词库。</li>
            </ul>
            <details>
              <summary>关键词选取方法（3 步）</summary>
              <div class="inner">
                <ol>
                  <li>去搜索框输入你的主题前缀，记录自动联想词（用户真实搜索）。</li>
                  <li>看“热门”里哪些词长期在（长期流量）。</li>
                  <li>反推：新人会用什么词搜到你？把它放进标题与首段。</li>
                </ol>
              </div>
            </details>
          </div>

          <div class="card" style="margin:0">
            <h3>互动价值：你要把观众“留在笔记里”</h3>
            <p class="small">行业常用的解释是：平台会根据点赞/收藏/评论/转发/关注等行为给笔记打分（例如 CES 评分体系），并阶梯式扩大推荐。评论、转发、关注通常被认为权重更高。</p>
            <details>
              <summary>小红书笔记结构模板（收藏型）</summary>
              <div class="inner">
                <p class="mono">标题：核心关键词 + 结果导向（例：“婚礼流程清单：不走冤枉路”）</p>
                <p class="mono">开头 2 行：我是谁 + 你能得到什么（“主持 500+ 场，整理了…”）</p>
                <p class="mono">正文：分点清单（每点一句结论 + 一句示例）</p>
                <p class="mono">结尾：评论引导（“你要哪种风格的主持稿？评论我发模板”）</p>
              </div>
            </details>
            <div class="callout warn">
              <b>关键动作：</b>小红书很多笔记是“二次推流”起来的。发布后 24–72 小时内，持续回复评论、补充细节，往往更容易把互动做上去。
            </div>
          </div>
        </div>
      </section>

      <section id="rules" class="card">
        <h2>合规与避坑（越早做到越省事）</h2>
        <div class="grid grid-2">
          <div class="card" style="margin:0">
            <h3>内容层面</h3>
            <ul>
              <li>不要夸大承诺（“包你…”“必然…”）。用“更大概率”“更稳”的表达。</li>
              <li>案例要可验证：尽量用“现场细节/过程”而不是虚构。</li>
              <li>避免引战：婚礼话题天然容易对立，尽量把冲突落到“解决方案”。</li>
            </ul>
          </div>
          <div class="card" style="margin:0">
            <h3>运营层面</h3>
            <ul>
              <li>不要标题党到“货不对板”（短期起量，长期掉权）。</li>
              <li>不要频繁大改笔记（尤其小红书），改一次即可。</li>
              <li>不要刷量/互赞群（极易产生“无效互动”，伤账号画像）。</li>
            </ul>
          </div>
        </div>
        <div class="callout bad">
          <b>一句话：</b>你做的是“信任生意”。平台最终也会用“长期价值信号”（复访、收藏、关注、评论质量）来奖励你。
        </div>
      </section>

      <section id="pillars" class="card">
        <h2>内容支柱与栏目：让你永远不缺选题</h2>
        <p class="small">建议用“5 支柱 × 4 栏目”，每周轮播。支柱是主题，栏目是形式。这样既不枯竭，也更容易稳定输出。</p>

        <table>
          <thead>
            <tr>
              <th>支柱（主题）</th>
              <th>栏目 A（清单/干货）</th>
              <th>栏目 B（故事/反差）</th>
              <th>栏目 C（现场切片）</th>
              <th>栏目 D（同城/转化）</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><b>婚礼流程</b></td>
              <td>流程清单/时间轴</td>
              <td>我见过最翻车的流程</td>
              <td>高能片段：誓词/交换戒指</td>
              <td>本地婚宴“流程适配”建议</td>
            </tr>
            <tr>
              <td><b>话术台词</b></td>
              <td>誓词/致辞模板</td>
              <td>一句话救场</td>
              <td>现场氛围带动</td>
              <td>评论领取模板/私信关键词</td>
            </tr>
            <tr>
              <td><b>控场救场</b></td>
              <td>7 个救场动作</td>
              <td>冷场到爆笑的瞬间</td>
              <td>突发情况处理切片</td>
              <td>同城客户常见问题答疑</td>
            </tr>
            <tr>
              <td><b>新人心理</b></td>
              <td>紧张/尴尬解决方案</td>
              <td>新人真实情绪故事</td>
              <td>“哭点”现场片段</td>
              <td>本地新人预算规划</td>
            </tr>
            <tr>
              <td><b>行业认知</b></td>
              <td>婚礼预算拆解</td>
              <td>从 0 到 500 场的成长</td>
              <td>幕后工作流</td>
              <td>合作商家/场地探店</td>
            </tr>
          </tbody>
        </table>

        <details style="margin-top:12px">
          <summary>把“你现成素材”变成 30 条内容（最省力）</summary>
          <div class="inner">
            <ol>
              <li>把你手头的：流程、主持稿、救场话术、音频/现场片段、客户问答 —— 全部列出来。</li>
              <li>每一项都做 3 种形态：<b>清单</b>（收藏）、<b>故事</b>（情绪）、<b>切片</b>（证明）。</li>
              <li>同一个主题的 3 条连发，会比 3 个不同主题更容易起量。</li>
            </ol>
          </div>
        </details>
      </section>

      <section id="formats" class="card">
        <h2>爆款形式与拍法：主持人最适配的 10 种“可复制”</h2>
        <div class="grid grid-2">
          <div class="card" style="margin:0">
            <h3>形式库（你只要挑一种一直拍）</h3>
            <ol>
              <li><b>POV 现场切片</b>：观众视角 + 高能点</li>
              <li><b>反差/翻车复盘</b>：失败→原因→方法</li>
              <li><b>“一句话”台词</b>：一句就够，极易转发</li>
              <li><b>清单/模板</b>：流程/誓词/致辞</li>
              <li><b>站队话题</b>：礼金/彩礼/流程争议（注意别引战）</li>
              <li><b>新人模拟训练</b>：你带着新人练走位/练誓词</li>
              <li><b>三段式讲解</b>：你说→示范→对比</li>
              <li><b>同城攻略</b>：场地/酒店/预算</li>
              <li><b>幕后工作流</b>：备场→对音→走台→临场</li>
              <li><b>评论区答疑</b>：挑高赞问题做下一条</li>
            </ol>
          </div>
          <div class="card" style="margin:0">
            <h3>拍摄手法（小成本也能出质感）</h3>
            <ul>
              <li><b>开头 3 秒：</b>大字标题 + 你直视镜头 + 结果导向一句话</li>
              <li><b>镜头：</b>固定机位 + 轻微推拉；现场切片多用近景（情绪）</li>
              <li><b>收音：</b>领夹麦优先；室内开降噪；现场切片保留一点环境声更真实</li>
              <li><b>剪辑：</b>每句话一刀；无意义停顿删掉；关键句加大字幕</li>
              <li><b>封面：</b>“核心词 + 结果” 8–12 字；不堆太多元素</li>
            </ul>
            <details>
              <summary>主持人专用：现场切片挑选标准（10 秒内）</summary>
              <div class="inner">
                <ul>
                  <li>观众能听懂：一句话就知道发生了什么。</li>
                  <li>情绪明确：笑点/泪点/反转点。</li>
                  <li>你有“掌控感”：你一句话让全场安静或爆笑。</li>
                  <li>画面干净：尽量稳定、主体清晰。</li>
                </ul>
              </div>
            </details>
          </div>
        </div>
      </section>

      
      <section id="xuehui-wulang" class="card">
        <h2>薛辉 × 小五狼：两套方法论怎么用在「主持人」身上</h2>
        <p class="small">
          你可以把它理解成两种“增长引擎”：<b>薛辉</b>更像“爆款按钮”（更快拿曝光），<b>小五狼</b>更像“认知IP”（更快拿信任与转化）。
          最稳的做法是：<b>用薛辉起量</b> → <b>用小五狼沉淀</b> → <b>用主持人专业完成成交</b>。
        </p>

        <div class="grid grid-2">
          <div class="card" style="margin:0">
            <h3>薛辉：8 大爆款元素 × 4 大脚本结构（更像“爆款按钮”）</h3>

            <div class="callout">
              <b>8 大爆款元素（选题角度）</b>
              <div class="small">用其中 1 个元素当“标题按钮”，让人点进来；进来之后必须给可执行方案。</div>
              <ul class="small">
                <li><b>猎奇的</b>：少见/反常识/“竟然还能这样”</li>
                <li><b>最差的</b>：翻车/踩雷/最容易毁现场（一定要给解决法）</li>
                <li><b>头牌的</b>：标杆/权威/高端标准（用细节支撑）</li>
                <li><b>荷尔蒙的</b>：情绪张力/心动瞬间（注意克制、避免擦边）</li>
                <li><b>反差的</b>：抽象脑洞/反转/漫画感（更偏“情绪+反转”的内容）</li>
                <li><b>人群的</b>：只对某类人说话（新娘/新郎/父母/二婚/远嫁等）</li>
                <li><b>成本的</b>：省钱/省时间/省精力，立刻可用的收益</li>
                <li><b>怀旧的</b>：旧时光/年代感/共鸣（易转发）</li>
              </ul>
              <div class="small">提示：不同讲法里元素名称会略有差异（例如“人群的”也常被叫“特定人群/圈层”。）</div>
            </div>

            <div class="callout" style="margin-top:12px">
              <b>4 大脚本结构（内容组织）</b>
              <ul class="small">
                <li><b>讲故事</b>：背景 → 冲突 → 转折 → 复盘方法</li>
                <li><b>晒过程</b>：我怎么做 → 每步做什么 → 用到的细节/工具 → 结果</li>
                <li><b>教知识</b>：结论先给 → 三点清单 → 反例提醒 → 互动要资料</li>
                <li><b>说观点</b>：站队观点 → 3 个理由 → 标准/替代方案 → 引导讨论</li>
              </ul>
              <div class="small">主持人最稳：<b>晒过程</b>（专业感） + <b>教知识</b>（可收藏）</div>
            </div>

            
            <div class="callout formula" style="margin-top:10px">
              <b>主持人怎么套用（极简公式）</b>
              <div class="grid grid-2" style="margin-top:10px">
                <div class="card" style="margin:0">
                  <div class="pill">📌 标题公式</div>
                  <div class="small" style="margin-top:8px">
                    <b>爆款元素（按钮）</b> + <b>具体场景（婚礼环节）</b> + <b>可量化承诺</b>（3步 / 7句 / 12个问题）
                  </div>
                  <div class="small" style="margin-top:6px; color:var(--muted)">
                    示例：<b>“敬酒最容易翻车的点：3句救场话术”</b> / <b>“{city}备婚：婚礼流程时间表（建议收藏）”</b>
                  </div>
                </div>

                <div class="card" style="margin:0">
                  <div class="pill">🎤 脚本公式（60秒）</div>
                  <ol class="small" style="margin:8px 0 0 18px; line-height:1.7">
                    <li><b>0–3秒</b>：一句钩子（痛点/反差/结果）</li>
                    <li><b>3–10秒</b>：背书 + 场景（你是谁/发生在哪）</li>
                    <li><b>10–45秒</b>：三点清单（每点都给“真实例子/台词”）</li>
                    <li><b>45–60秒</b>：评论关键词领模板（置顶转化）</li>
                  </ol>
                </div>
              </div>
              <div class="small" style="margin-top:10px">主持人最稳组合：<b>晒过程</b>（专业感） + <b>教知识</b>（可收藏）</div>
            </div>

          </div>

          <div class="card" style="margin:0">
            <h3>小五狼：认知口播 × 系列化表达（更像“信任引擎”）</h3>

            <div class="callout">
              <b>公开内容与课程宣传里反复强调的方向</b>
              <ul class="small">
                <li><b>系统学做 IP</b>：用“定位 → 选题 → 表达 → 节奏 → 复盘”的闭环，解决“不会开始/没节奏/卡瓶颈”。</li>
                <li><b>观点/认知驱动</b>：输出“为什么”，再给“怎么做”，让观众愿意长期追更。</li>
                <li><b>高密度口播</b>：用更完整的逻辑链条建立信任（并不只追求 15 秒爆点）。</li>
              </ul>
              <div class="small">
                你可以把“小五狼风格”理解为：<b>用更长的逻辑把观众“留下来”</b>，再用模板/清单把他们“带走”。  
              </div>
            </div>

            <div class="grid" style="grid-template-columns: 1fr; gap:10px; margin-top:10px">
              <div class="card" style="margin:0">
                <h4 style="margin:0 0 6px 0">可复刻的“认知口播”结构（主持人版）</h4>
                <ol class="small">
                  <li><b>一句大结论（先给结果）</b>：把你想说的结论写成一句“标准”。</li>
                  <li><b>三段支撑（讲清为什么）</b>：3 个理由，每个理由都配一个“婚礼现场例子”。</li>
                  <li><b>类比/比喻（让人秒懂）</b>：把婚礼流程类比成“导航/节拍器/剧本”。</li>
                  <li><b>行动清单（让人能做）</b>：给 3–5 条可以直接执行的步骤/话术。</li>
                  <li><b>固定承接（让人愿意关注）</b>：评论关键词领清单 + 系列第 2/3 集预告。</li>
                </ol>
              </div>

              <div class="card" style="margin:0">
                <h4 style="margin:0 0 6px 0">小五狼 vs 薛辉：你该怎么选？</h4>
                <table class="table small">
                  <thead>
                    <tr>
                      <th>维度</th>
                      <th>薛辉（爆款按钮）</th>
                      <th>小五狼（信任引擎）</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>最优化目标</td>
                      <td>点击/停留/互动，快速放量</td>
                      <td>理解/认可/追更，稳定转化</td>
                    </tr>
                    <tr>
                      <td>更适合</td>
                      <td>新号起量、卡播放量时</td>
                      <td>想做个人品牌、做咨询与客单时</td>
                    </tr>
                    <tr>
                      <td>内容形态</td>
                      <td>短、狠、明确，强钩子</td>
                      <td>逻辑链更长，观点+方法</td>
                    </tr>
                    <tr>
                      <td>主持人落地</td>
                      <td>“救场/避坑/成本/圈层”爆点</td>
                      <td>“高级感/控场/沟通心理学”体系</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <details style="margin-top:10px">
              <summary>主持人一条视频怎么“融合”两套体系？</summary>
              <div class="inner small">
                <div><b>外壳（薛辉）：</b>用一个爆款元素当标题按钮（最差/成本/人群）。</div>
                <div><b>内核（小五狼）：</b>用“结论先行 + 三点支撑 + 类比 + 清单”讲透。</div>
                <div><b>成交（主持人专业）：</b>把清单做成“可复制模板”（沟通清单/话术/流程表），评论领。</div>
              </div>
            </details>
          </div>
        </div>
      </section>


      <section id="anxiansheng" class="card">
        <h2>安先生：把短视频当“导演课”来做（主持人落地版）</h2>
        <p class="small">
          注：本页只整理<strong>公开介绍/公开视频中可验证的模块方向</strong>，并把它翻译成「主持人能直接执行」的SOP与模板；
          不复刻付费课程逐字内容。
        </p>

        <div class="callout">
          <b>安先生课程体系对外公开常见的三条主线</b>
          <ul class="small" style="margin-top:8px">
            <li><b>平台机制 → 内容结构：</b>先理解“为什么会热门”，再用结构把人留下（开头/骨架/情绪/信息密度）。</li>
            <li><b>选题：从「普世」到「陌生化」：</b>同样的需求，换一种更有画面、更有反差、更有张力的讲法。</li>
            <li><b>叙事与影像：</b>用“视点与距离、时间与节奏、画面讲故事”去提升质感，而不是只拼口播。</li>
          </ul>
          <div class="small" style="margin-top:8px">
            你做主持人天然有优势：<b>现场素材</b>（画面/声音/情绪）+ <b>控场话术</b>（结论/节奏/反转）= 很适配“导演式短视频”。
          </div>
        </div>

        <div class="grid grid-2">
          <div class="card" style="margin:0">
            <h3>① 选题：普世 → 陌生化（主持人怎么用）</h3>
            <p class="small">“普世”是所有新人都会遇到的需求；“陌生化”是你把它讲得<strong>更具体、更反直觉、更有画面</strong>。</p>
            <table class="table small">
              <thead>
                <tr>
                  <th style="width:120px">普世需求</th>
                  <th>主持人陌生化切法（可直接拍）</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>婚礼流程不顺</td>
                  <td>「同一流程」为什么有的像电影、有的像开会？我只改了 3 个“节拍点”。</td>
                </tr>
                <tr>
                  <td>现场尴尬/冷场</td>
                  <td>别硬cue！我用 1 句“空间调度句”让全场从发呆变跟着笑。</td>
                </tr>
                <tr>
                  <td>誓词/致辞难写</td>
                  <td>写誓词别从“我爱你”开始：用“第一人称的小证据”开头更抓人。</td>
                </tr>
                <tr>
                  <td>预算超支</td>
                  <td>同样花钱，为什么有的“显贵”有的“显廉”？把钱从 2 个位置挪走。</td>
                </tr>
              </tbody>
            </table>
            <details style="margin-top:10px">
              <summary>一键套用：陌生化 6 招（写完就能拍）</summary>
              <div class="inner small">
                <ol>
                  <li><b>并置：</b>A 和 B 放一起（同预算两种效果）。</li>
                  <li><b>反直觉：</b>“大家以为…其实…”。</li>
                  <li><b>细节证据：</b>用一个小物件/一句话证明“我在现场”。</li>
                  <li><b>空间调度：</b>谁站哪、灯打哪、音乐切哪（画面马上不一样）。</li>
                  <li><b>时间语法：</b>快/慢/停顿/重复（节奏就是情绪）。</li>
                  <li><b>立场：</b>明确你站谁（新人/父母/伴郎伴娘/酒店）。</li>
                </ol>
              </div>
            </details>
          </div>

          <div class="card" style="margin:0">
            <h3>② 结构：钩子 × 骨架 × 情绪刺点 × 信息密度</h3>
            <p class="small">你可以把它当成“导演分镜”：每 5–8 秒必须有一个<strong>推进点</strong>。</p>
            <div class="grid" style="grid-template-columns:1fr; gap:10px">
              <div class="card" style="margin:0">
                <div class="pill">🎬 60 秒导演版脚本（主持人最稳）</div>
                <ol class="small" style="margin:8px 0 0 18px; line-height:1.7">
                  <li><b>0–3s 钩子：</b>给结果/反差（“你以为…其实…”）</li>
                  <li><b>3–10s 立场+场景：</b>我是谁 + 发生在哪（现场感）</li>
                  <li><b>10–40s 骨架：</b>3 个点，每点都给一句“你能照抄的话术/动作”</li>
                  <li><b>40–55s 情绪刺点：</b>一个“人会在意”的瞬间（紧张/尴尬/泪点/反转）</li>
                  <li><b>55–60s 转化：</b>评论关键词领模板/系列预告</li>
                </ol>
              </div>

              <div class="card" style="margin:0">
                <h4 style="margin:0 0 6px 0">信息密度自检（把“废话”删掉）</h4>
                <ul class="small" style="margin:0 0 0 18px; line-height:1.7">
                  <li>一句话里只放一个动作：不解释太多背景。</li>
                  <li>每个观点都要落到“主持人会怎么说/怎么做”。</li>
                  <li>能用画面说的就别用口播说：用 B-roll 代替描述。</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-2" style="margin-top:12px">
          <div class="card" style="margin:0">
            <h3>③ 影像与叙事美学：让你的视频更“高级”</h3>
            <p class="small">你不需要专业器材，用手机也能做：关键是“视点/距离/节奏”。</p>
            <table class="table small">
              <thead>
                <tr>
                  <th style="width:120px">要素</th>
                  <th>怎么拍（主持人场景）</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>视点</td>
                  <td>第一人称：我在台上看到什么/听到什么（用“我”把观众拉进来）。</td>
                </tr>
                <tr>
                  <td>距离</td>
                  <td>近景讲情绪（眼神/手抖）；中景讲动作（控场手势）；远景讲气氛（全场反应）。</td>
                </tr>
                <tr>
                  <td>时间与节奏</td>
                  <td>关键句前留 0.5 秒停顿；高潮处快切；结尾慢下来给“总结”。</td>
                </tr>
                <tr>
                  <td>画面讲故事</td>
                  <td>用 3 个镜头完成因果：现场问题 → 你处理 → 结果反应。</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="card" style="margin:0">
            <h3>主持人专用：导演式拍摄清单（手机即可）</h3>
            <ol class="small" style="margin:0 0 0 18px; line-height:1.7">
              <li><b>主叙述镜头：</b>稳定正面口播（10–20s）。</li>
              <li><b>证据镜头：</b>现场 2–3 个短切片（每段 1–2s）。</li>
              <li><b>空间调度镜头：</b>舞台/灯光/动线（建立“场面”）。</li>
              <li><b>声音镜头：</b>收一段干净人声 + 一段现场环境声（更真实）。</li>
              <li><b>字幕策略：</b>只强调关键动词/数字/结果，不把整段话写满。</li>
              <li><b>结尾动作：</b>评论关键词领《流程/话术/清单》+ 下一条预告（系列化）。</li>
            </ol>
            <details style="margin-top:10px">
              <summary>口播表达训练（更像“舞台表演”的声音控制）</summary>
              <div class="inner small">
                <ul>
                  <li><b>节拍：</b>每句话结尾收住，给观众 0.3–0.7 秒“消化”。</li>
                  <li><b>重音：</b>只在“动作词/结果词/数字”上加重，别全程用力。</li>
                  <li><b>情绪弧线：</b>先冷静给结论 → 中段加速推进 → 情绪刺点拉高 → 结尾回落。</li>
                </ul>
              </div>
            </details>
          </div>
        </div>

        <details style="margin-top:12px">
          <summary>7 天训练：把“导演思维”练成肌肉（每天 30 分钟）</summary>
          <div class="inner small">
            <ol>
              <li><b>Day1 选题库：</b>写 30 个“普世需求”，每个做 1 个陌生化标题。</li>
              <li><b>Day2 结构：</b>用“钩子-骨架-情绪-转化”写 10 个 60 秒分镜脚本。</li>
              <li><b>Day3 镜头：</b>同一脚本拍 3 个距离（近/中/远）练“距离感”。</li>
              <li><b>Day4 节奏：</b>同一素材剪 2 版（快切/慢讲）对比完播。</li>
              <li><b>Day5 声音：</b>做 5 条“重音/停顿/语速”练习，找到最舒服的口播腔调。</li>
              <li><b>Day6 系列：</b>把 1 个主题拆成上/中/下（三条连发）。</li>
              <li><b>Day7 复盘：</b>只看 3 个指标：3 秒留存、完播率、评论关键词触发率；写下一条改动。</li>
            </ol>
          </div>
        </details>
      </section>

<section id="benchmark" class="card">
        <h2>对标库与拆解表（可保存/可编辑）</h2>
        <p class="small">“对标”不是抄，是<b>拆结构</b>：他们怎么选题、怎么开头、怎么做系列、怎么转化。你只要把对标信息填满 10 个账号，就会越来越会做内容。</p>

        <div class="card" style="margin:0">
          <div class="flex">
            <button class="btn" id="addBenchBtn">＋ 添加一条对标</button>
            <button class="btn" id="saveBenchBtn">💾 保存对标库</button>
              <button class="btn" id="resetBenchBtn">↩ 恢复预设</button>
            <button class="btn" id="clearBenchBtn">🧹 清空对标库</button>
          </div>
          <div class="small" style="margin-top:8px">
            建议对标三类：<b>婚礼主持人（同赛道）</b>｜<b>婚礼策划/导演（近赛道）</b>｜<b>情绪口播强者（形式对标）</b>
          </div>
          <div style="overflow:auto; margin-top:10px">
            <table id="benchTable">
              <thead>
                <tr>
                  <th style="width:120px">平台</th>
                  <th>账号/链接</th>
                  <th style="width:90px">粉丝</th>
                  <th style="width:110px">主打栏目</th>
                  <th>爆款标题习惯</th>
                  <th style="width:140px">转化方式</th>
                  <th style="width:70px">删除</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <p class="small">小技巧：每次刷到一个爆款，立刻复制链接到这里，并写下“它的开头一句是什么？”“它的评论引导是什么？”</p>
        </div>

        <details style="margin-top:12px">
          <summary>对标拆解 7 问（你只要回答就能学会）</summary>
          <div class="inner">
            <ol>
              <li>这一条命中的“人群是谁”？（新人/父母/同行/同城）</li>
              <li>标题里哪一个词是核心词？（能搜到的词）</li>
              <li>开头 3 秒说了什么？（痛点/结果/冲突/反差）</li>
              <li>中段是清单还是故事？（结构）</li>
              <li>结尾怎么引导互动？（站队/提问/要模板）</li>
              <li>评论区有没有“置顶转化”？</li>
              <li>这条能不能拆成 3 条系列？怎么拆？</li>
            </ol>
          </div>
        
        <details style="margin-top:12px">
          <summary>如何快速找到“头部/对标账号”（抖音 & 小红书通用）</summary>
          <div class="inner">
            <ol>
              <li><b>关键词组合：</b>「婚礼主持人 / 婚庆主持人 / 中式司仪 / 救场 / 主持话术 / 城市名+婚礼主持」</li>
              <li><b>只看两类内容：</b>①长期爆（系列化）；②近期爆（热点承接）。把链接立刻填进上方对标库。</li>
              <li><b>用榜单工具补一刀：</b>小红书可用“新红数据/新榜”等公开榜单产品的关键词分析；抖音可用“巨量算数/星图”等（不一定免费，但方向最清晰）。</li>
              <li><b>拆结构别抄话：</b>重点记录他们的：开头一句、分点结构、评论引导、置顶转化。</li>
            </ol>
            <p class="small">本手册预填的示例账号名来自公开搜索结果的账号名称片段（用于你快速“搜到并加入对标库”，不代表官方排名）。</p>
          </div>
        </details>

      </section>

      
<section id="generator" class="card">
  <h2>标题 / 文案 / 标签 / 评论引导 工作台（一步到位可发布）</h2>
  <p class="small">思路：左侧分步选项把“账号画像”喂给系统；右侧一次生成四张卡片（标题/文案脚本/标签/评论引导）。你只改真实细节就能发。</p>

  <div class="split">
    <!-- LEFT: Wizard -->
    <div class="card" style="margin:0">
      <div class="cardhead">
        <h3>输入（分步引导）</h3>
        <div class="toolbar">
          <button class="btn ghost" id="wizardPrev">← 上一步</button>
          <button class="btn ghost" id="wizardNext">下一步 →</button>
        </div>
      </div>

      <div class="stepbar" id="stepbar">
        <div class="stepchip active" data-step="1">1 平台</div>
        <div class="stepchip" data-step="2">2 风格</div>
        <div class="stepchip" data-step="3">3 体系</div>
        <div class="stepchip" data-step="4">4 主题&痛点</div>
        <div class="stepchip" data-step="5">5 生成</div>
      </div>

      <div class="wizard" id="wizard">

        <div class="stepbox" data-step="1">
          <h4>选择平台（决定“推荐/搜索”的写法）</h4>
          <div class="row2">
            <label>平台
              <select id="gPlatform">
                <option value="douyin">抖音（钩子更强）</option>
                <option value="xhs">小红书（搜索词+清单）</option>
              </select>
            </label>
            <label>城市（可空）
              <input type="text" id="gCity" placeholder="例：连云港 / 赣榆">
            </label>
          </div>
          <div class="smallhelp">抖音更看“停留/互动”；小红书更看“收录关键词+收藏”。平台不同，标题与结构就不一样。</div>
        </div>

        <div class="stepbox" data-step="2" style="display:none">
          <h4>选择内容风格（决定你“怎么讲”）</h4>
          <div class="row2">
            <label>内容形式（风格）
              <select id="gStyle">
                <option value="干货清单">干货清单（收藏型）</option>
                <option value="避坑反差">避坑反差（冲突型）</option>
                <option value="现场救场">现场救场（专业型）</option>
                <option value="情绪故事">情绪故事（共情型）</option>
                <option value="同城攻略">同城攻略（转化型）</option>
              </select>
            </label>
            <label>目标人群（可空）
              <input type="text" id="gAudience" placeholder="例：备婚新人 / 新娘 / 新郎 / 父母">
            </label>
          </div>

          <div class="presetlist" style="margin-top:10px">
            <div class="presetpill" data-preset="douyin_fast">⚡ 抖音起量：救场/避坑</div>
            <div class="presetpill" data-preset="xhs_save">📌 小红书收藏：清单/模板</div>
            <div class="presetpill" data-preset="city_convert">🏙️ 同城转化：攻略/案例</div>
          </div>
          <div class="smallhelp">建议新号：先固定 1–2 个风格连发 7–10 条，让算法更快识别“你是谁”。</div>
        </div>

        <div class="stepbox" data-step="3" style="display:none">
          <h4>选择方法体系（可选：薛辉 / 小五狼 / 自动融合）</h4>
          <div class="row3">
            <label>体系选择
              <select id="gFramework">
                <option value="auto" selected>自动融合（推荐）</option>
                <option value="xuehui">薛辉（爆款按钮）</option>
                <option value="xiaowulang">小五狼（信任引擎）</option>
              </select>
            </label>
            <label>脚本结构（薛辉）
              <select id="gDyStructure">
                <option value="auto" selected>自动匹配</option>
                <option value="story">讲故事（背景→冲突→转折→复盘）</option>
                <option value="process">晒过程（我怎么做→步骤→细节→结果）</option>
                <option value="teach">教知识（结论先给→三点清单→提醒→要资料）</option>
                <option value="view">说观点（站队→3理由→方案→引讨论）</option>
              </select>
            </label>
            <label>表达增强（小五狼）
              <select id="gXWLBoost">
                <option value="off" selected>关闭</option>
                <option value="pyramid">结论先行 + 三点支撑</option>
                <option value="pyramid_analogy">三点支撑 + 类比/比喻</option>
                <option value="pyramid_checklist">三点支撑 + 行动清单</option>
              </select>
            </label>
          </div>
          <div class="smallhelp">薛辉更像“强钩子按钮”，适合起量；小五狼更像“观点+方法+系列”，适合长期信任与转化。</div>
        </div>

        <div class="stepbox" data-step="4" style="display:none">
          <h4>填写主题与痛点（越具体越好）</h4>
          <div class="row2">
            <label>主题（你要讲什么）
              <input type="text" id="gTopic" placeholder="例：婚礼流程 / 敬酒环节 / 父母致辞 / 冷场救场">
            </label>
            <label>痛点（观众最怕什么）
              <input type="text" id="gPain" placeholder="例：流程混乱 / 尴尬冷场 / 台词土 / 父母发言俗">
            </label>
          </div>

          <div class="row2" style="margin-top:10px">
            <label>业务入口（可空）
              <input type="text" id="gCTAKey" placeholder="例：评论关键词：流程 / 模板 / 同城">
            </label>
            <label>账号固定标签（可改）
              <input type="text" id="gTagFixed" value="#主持人安宁">
            </label>
          </div>

          <div class="smallhelp">小红书请把“主题关键词”写得更明确（可被搜索）；抖音请把“痛点/冲突”写得更狠（更能停留）。</div>
        </div>

        <div class="stepbox" data-step="5" style="display:none">
          <h4>一键生成（四卡同步输出）</h4>
          <div class="toolbar">
            <button class="btn primary" id="genPackBtn">🚀 生成一整套（标题+文案+标签+评论）</button>
            <button class="btn" id="genTitlesBtn">✨ 只生成标题（15个）</button>
            <button class="btn" id="genScriptBtn">🎬 只生成文案脚本</button>
            <button class="btn" id="genCommentsBtn">💬 只生成评论引导</button>
            <button class="btn" id="genSeriesBtn">📚 生成 3 条系列（上/中/下）</button>
          </div>

          <div class="toolbar" style="margin-top:10px">
            <button class="btn" id="savePresetBtn">💾 保存为常用模板</button>
            <button class="btn" id="loadPresetBtn">📌 载入常用模板</button>
            <button class="btn" id="clearPresetBtn">🧹 清除常用模板</button>
          </div>

          <div class="callout" style="margin-top:10px">
            <b>发布前 30 秒检查：</b>标题是否有核心词？开头一句是否给“结果/冲突”？中段是否每点给例子？结尾是否有评论入口？
          </div>
        </div>

      </div>

      <hr>
      <div class="kv">
        <div>
          <b>一键复制发布格式</b><br>
          <span>把四卡内容合并成“可直接粘贴发布”的抖音/小红书版式</span>
        </div>
        <div class="toolbar">
          <button class="btn" id="copyDyBtn">复制抖音发布稿</button>
          <button class="btn" id="copyXhsBtn">复制小红书发布稿</button>
        </div>
      </div>

      <div class="smallhelp" style="margin-top:10px">
        提示：抖音发布稿更短更狠（强钩子+节奏）；小红书发布稿更像“搜索词+清单+收藏提示”。  
        你也可以把“评论关键词”写进置顶，做转化入口。
      </div>
    </div>

    <!-- RIGHT: Outputs -->
    <div class="card" style="margin:0">
      <div class="cardhead">
        <h3>输出（分卡片）</h3>
        <div class="toolbar">
          <button class="btn" id="copyAllBtn">复制全部</button>
          <button class="btn" id="clearOutBtn">清空输出</button>
        </div>
      
      <div class="kv" id="statusBar" style="margin-bottom:12px">
        <div>
          <b id="statusTitle">状态：待生成</b><br>
          <span id="statusSub">按左侧步骤选择参数，然后点击“生成”。</span>
          <div class="mini" id="statusMore" style="margin-top:6px"></div>
        </div>
        <div class="toolbar">
          <button class="btn ghost" id="statusGuideBtn">一键复制“下一条建议”</button>
        </div>
      </div>
</div>

      <div class="output-grid">
        <div class="outcard">
          <div class="cardhead">
            <h3>标题</h3>
            <button class="btn" data-copy="outTitle">复制</button>
          </div>
          <textarea id="outTitle" class="compact" placeholder="标题会出现在这里…"></textarea>
          <div class="mini">抖音：更像“钩子”；小红书：更像“搜索词+清单”。</div>
        </div>

        <div class="outcard">
          <div class="cardhead">
            <h3>文案 & 脚本</h3>
            <button class="btn" data-copy="outScript">复制</button>
          </div>
          <textarea id="outScript" placeholder="文案与脚本会出现在这里…"></textarea>
          <div class="mini">建议：每 5–8 秒给一个转折/例子/画面切换。</div>
        </div>

        <div class="outcard">
          <div class="cardhead">
            <h3>标签 / 关键词</h3>
            <button class="btn" data-copy="outTags">复制</button>
          </div>
          <textarea id="outTags" class="compact" placeholder="标签会出现在这里…"></textarea>
          <div class="mini">默认会带上固定标签（可在左侧修改）。</div>
        </div>

        <div class="outcard">
          <div class="cardhead">
            <h3>评论引导（置顶用）</h3>
            <button class="btn" data-copy="outCmt">复制</button>
          </div>
          <textarea id="outCmt" class="compact" placeholder="评论引导会出现在这里…"></textarea>
          <div class="mini">推荐：评论关键词领清单/模板 + 预告系列第 2/3 集。</div>
        </div>
      </div>
    </div>
  </div>

  <hr>
  <details>
    <summary>我想更快：给我“新号起号 / 老号重启”的一键打法</summary>
    <div class="inner">
      <div class="grid grid-2">
        <div class="card" style="margin:0">
          <h3>新号起号（抖音）7 天最稳</h3>
          <ol>
            <li>只做 1 个主线（例如：救场/避坑），连发 7–10 条，让算法快速识别。</li>
            <li>每条固定结构：0–3s 给结果/冲突 → 10–35s 三点清单（带例子）→ 结尾评论入口。</li>
            <li>评论置顶给“清单/模板入口”，引导互动与转粉。</li>
          </ol>
        </div>
        <div class="card" style="margin:0">
          <h3>老号重启（抖音）14 天回正</h3>
          <ol>
            <li>先停 3–7 天“断尾”，再回归后保持连续 10–14 天稳定输出。</li>
            <li>删掉/隐藏极低质量旧作品（可选），让主页“统一定位”。</li>
            <li>用系列化：同主题上/中/下三条连发，重新建立画像。</li>
          </ol>
        </div>
        <div class="card" style="margin:0">
          <h3>新号起号（小红书）10 篇起步</h3>
          <ol>
            <li>标题必须含核心搜索词（婚礼流程/致辞/誓词/敬酒/救场）。</li>
            <li>正文用清单化（可收藏）：每点一句结论 + 一句示例。</li>
            <li>发布后 24–72 小时高频回复评论，争取二次推流。</li>
          </ol>
        </div>
        <div class="card" style="margin:0">
          <h3>老号重启（小红书）7 天系列回归</h3>
          <ol>
            <li>先发 3 篇“收藏清单”（把账号定位打回去）。</li>
            <li>再发 2 篇“案例复盘”（证明你打过仗）。</li>
            <li>最后发 2 篇“同城攻略/资源”（接咨询/客单）。</li>
          </ol>
        </div>
      </div>
    </div>
  </details>
</section>

<section id="launch-restart" class="card">
  <h2>新号起号 & 老号重启（按平台规则的可执行 SOP）</h2>
  <p class="small">你看到的“流量”其实是平台在试探：用户会不会停留、互动、收藏、转粉。你要做的不是碰运气，而是用可复用的结构，让平台更快识别你的内容价值。</p>

  <div class="grid grid-2">
    <div class="card" style="margin:0">
      <h3>抖音｜新号起号（7 天）</h3>
      <ol>
        <li><b>只喂 1 个主线：</b>例如「救场/避坑」或「流程清单」，连续 7–10 条，让算法快速定类。</li>
        <li><b>每条固定节奏：</b>0–3s 结果/冲突 → 10–35s 三点清单（每点给例子）→ 结尾评论入口。</li>
        <li><b>评论置顶做入口：</b>统一关键词（如【模板/清单/流程】），让互动与转粉稳定可控。</li>
        <li><b>连爆策略：</b>同主题做“上/中/下”三条系列，连发 3 天（平台更爱可追更内容）。</li>
      </ol>
      <div class="callout"><b>主持人最稳起量：</b>「晒过程（专业感）」+「教知识（可收藏）」组合。</div>
    </div>

    <div class="card" style="margin:0">
      <h3>抖音｜老号重启（14 天）</h3>
      <ol>
        <li><b>先断尾 3–7 天：</b>停止乱发/低质输出，让账号“重置节奏”。</li>
        <li><b>主页统一定位：</b>隐藏/删除明显跑偏的旧内容（可选），让新访客一眼看懂你做什么。</li>
        <li><b>连续 10–14 天稳定输出：</b>每天 1 条或隔天 1 条，但要稳定同赛道同结构。</li>
        <li><b>用系列回正画像：</b>优先发「清单/模板」+「案例复盘」，再上「同城转化」。</li>
      </ol>
      <div class="callout"><b>重启核心：</b>先把“你是谁”讲清楚，再谈“你有多厉害”。</div>
    </div>

    <div class="card" style="margin:0">
      <h3>小红书｜新号起号（10 篇）</h3>
      <ol>
        <li><b>标题=搜索词：</b>必须包含核心词（婚礼流程/誓词/致辞/敬酒/救场/主持词）。</li>
        <li><b>正文=清单化：</b>每点“结论一句 + 示例一句”，让用户能收藏/截图。</li>
        <li><b>48–72 小时积极互动：</b>高频回复评论，帮助二次推流与收录稳定。</li>
        <li><b>固定栏目：</b>10 篇里至少 6 篇是同栏目（比如《婚礼流程避坑清单》系列）。</li>
      </ol>
      <div class="callout"><b>小红书最稳：</b>清单/模板/对照表（用户收藏就是“价值证明”）。</div>
    </div>

    <div class="card" style="margin:0">
      <h3>小红书｜老号重启（7 天）</h3>
      <ol>
        <li><b>先发 3 篇收藏清单：</b>把账号定位重新打回用户心智。</li>
        <li><b>再发 2 篇案例复盘：</b>证明你“打过仗”（现场问题→你怎么救→结果）。</li>
        <li><b>最后 2 篇转化内容：</b>同城攻略/服务流程/报价逻辑（不硬广，留入口）。</li>
        <li><b>置顶评论固定入口：</b>关键词领清单/模板，把咨询引导到私域/联系方式。</li>
      </ol>
      <div class="callout"><b>重启要点：</b>先把“收藏/搜索”跑通，再追曝光。</div>
    </div>
  </div>

  <hr>
  <div class="grid grid-2">
    <div class="card" style="margin:0">
      <h3>主持人专用：三条系列（直接照抄）</h3>
      <ul>
        <li>《婚礼流程（上）》：流程 6 行怎么写（给模板）</li>
        <li>《婚礼流程（中）》：过渡句怎么写（给 10 句）</li>
        <li>《婚礼流程（下）》：救场句怎么用（给 10 句+场景）</li>
      </ul>
      <p class="small">你也可以在工作台里点「生成 3 条系列（上/中/下）」一键生成。</p>
    </div>

    <div class="card" style="margin:0">
      <h3>发布前 30 秒自检（万能）</h3>
      <ol>
        <li>标题是否有核心词？（小红书更重要）</li>
        <li>开头一句是否给“结果/冲突”？（抖音更重要）</li>
        <li>中段每点是否给具体例子？（能不能照做）</li>
        <li>结尾是否有评论入口？（关键词领模板）</li>
      </ol>
    </div>
  </div>
</section>


<section id="calendar" class="card">
        <h2>拍摄日历生成器（7/14/30 天）</h2>
        <p class="small">你只要决定：周期、频次、主线（主题）。系统会给你排出“每天拍什么 + 用什么形式 + 建议发布时间”。你可以再按实际工作档期调整。</p>

        <div class="card" style="margin:0">
          <div class="grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px">
            <label>开始日期
              <input type="date" id="cStart">
            </label>
            <label>周期
              <select id="cDays">
                <option value="7">7 天</option>
                <option value="14">14 天</option>
                <option value="30" selected>30 天</option>
              </select>
            </label>
            <label>每日发布数
              <select id="cPerDay">
                <option value="1" selected>1 条/天</option>
                <option value="2">2 条/天</option>
              </select>
            </label>
            <label>平台
              <select id="cPlatform">
                <option value="douyin" selected>抖音</option>
                <option value="xhs">小红书</option>
              </select>
            </label>
            <label style="grid-column:1/-1">你的主线主题（用逗号分隔 3–5 个）
              <input type="text" id="cPillars" placeholder="例如：婚礼流程, 话术台词, 救场控场, 同城攻略, 预算拆解">
            </label>
          </div>

          <div class="flex" style="margin-top:10px">
            <button class="btn" id="genCalBtn">📅 生成日历</button>
            <button class="btn" id="dlCsvBtn">⬇️ 导出 CSV</button>
            <button class="btn" id="copyCalBtn">复制日历文本</button>
            <button class="btn" id="saveCalBtn">💾 保存日历</button>
            <button class="btn" id="clearCalBtn">🧹 清空</button>
          </div>

          <div style="overflow:auto; margin-top:12px">
            <table id="calTable">
              <thead>
                <tr>
                  <th style="width:120px">日期</th>
                  <th style="width:90px">条目</th>
                  <th style="width:140px">主题</th>
                  <th style="width:130px">形式</th>
                  <th>标题方向</th>
                  <th style="width:120px">建议发布</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <p class="small">提示：建议发布时间是“通用参考”，最终以你账号数据为准（看你的视频什么时候更容易被推上第二波）。</p>
        </div>
      </section>

      <section id="review" class="card">
        <h2>数据复盘与诊断（把问题定位到“下一条怎么改”）</h2>
        <p class="small">把你某条作品的数据填进来，系统会给出“最可能卡住的环节”和“下一条怎么改”。（数值是通用参考，目的是帮你诊断方向。）</p>

        <div class="grid grid-2">
          <div class="card" style="margin:0">
            <h3>输入数据</h3>
            <div class="metrics-grid">
              <label>播放量
                <input type="number" id="mPlays" placeholder="例如 5000">
              </label>
              <label>点赞
                <input type="number" id="mLikes" placeholder="例如 120">
              </label>
              <label>评论
                <input type="number" id="mComments" placeholder="例如 35">
              </label>
              <label>收藏
                <input type="number" id="mSaves" placeholder="例如 40">
              </label>
              <label>转发
                <input type="number" id="mShares" placeholder="例如 10">
              </label>
              <label>新增关注
                <input type="number" id="mFollows" placeholder="例如 20">
              </label>
              <label style="grid-column:1/-1">平均观看时长（秒，可空）
                <input type="number" id="mAvgWatch" placeholder="例如 9">
              </label>
            </div>
            <div class="flex" style="margin-top:10px">
              <button class="btn" id="calcBtn">📈 生成诊断</button>
              <button class="btn" id="clearMetricsBtn">清空</button>
            </div>
          </div>

          <div class="card" style="margin:0">
            <h3>诊断建议</h3>
            <div id="diag" class="callout" style="min-height:160px">
              填入数据后点击“生成诊断”…
            </div>
            <div class="small">
              你要记住：数据只是“信号”。真正能改变结果的是：<b>选题</b>、<b>开头</b>、<b>节奏</b>、<b>评论点</b>、<b>转化入口</b>。
            </div>
          </div>
        </div>

        <details style="margin-top:12px">
          <summary>复盘模板（每周 30 分钟）</summary>
          <div class="inner">
            <ol>
              <li>本周最高播放 3 条：各自的“开头一句”是什么？</li>
              <li>本周最高转粉 3 条：评论区是怎么引导的？</li>
              <li>本周收藏最高 3 条：是不是清单/模板？关键词是什么？</li>
              <li>下一周只做 2 个动作：<b>复制最高效结构</b> + <b>替换主题</b>。</li>
            </ol>
          </div>
        </details>
      </section>

      <section id="resources" class="card">
        <h2>素材与 SOP 清单（把拍摄变成流水线）</h2>
        <div class="grid grid-2">
          <div class="card" style="margin:0">
            <h3>你需要准备的“固定资产”</h3>
            <ul>
              <li>一份「婚礼流程清单」：4 套（中式/西式/户外/晚宴）</li>
              <li>一份「话术模板库」：誓词、父母致辞、敬酒串词、救场句</li>
              <li>一份「同城资源清单」：场地/摄影/跟妆/策划（先做 10 家）</li>
              <li>一份「案例卡」：每场婚礼 3 个亮点 + 1 个问题 + 1 个解决</li>
            </ul>
          </div>
          <div class="card" style="margin:0">
            <h3>一条内容的标准工序（20 分钟版本）</h3>
            <ol>
              <li>选题：从评论区/私信/现场问题中选 1 个</li>
              <li>标题：套公式，放核心词</li>
              <li>脚本：30–45 秒三段式</li>
              <li>拍摄：固定机位，三遍拿一遍</li>
              <li>剪辑：每句一刀，关键句加大字幕</li>
              <li>发布：评论置顶（模板/清单/咨询入口）</li>
            </ol>
          </div>
        </div>

        <details style="margin-top:12px">
          <summary>“爆一条 → 连爆三条”的复制法</summary>
          <div class="inner">
            <p class="small">当你出现一条明显高于平均的数据（播放/收藏/转粉任意一项），立刻做：</p>
            <ol>
              <li>同主题续集：上/中/下（把清单拆细）</li>
              <li>同结构换主题：保留开头节奏，换另一个常见问题</li>
              <li>同标题换案例：把“方法”换成另一个现场细节</li>
            </ol>
          </div>
        </details>
      </section>

      <section id="sources" class="card">
        <h2>参考来源（你可以自己点开核对）</h2>
        <p class="small">注：平台不会公开全部算法细节；这里列的是公开解释与行业常见分析，用于理解“方向”和“抓手”。</p>
        <ul>
          <li><a href="https://newsroom.tiktok.com/how-tiktok-recommends-videos-for-you?lang=en" target="_blank" rel="noreferrer">TikTok Newsroom：How TikTok recommends videos #ForYou</a></li>
          <li><a href="https://kawo.com/en/blog/five-key-metrics-that-help-brands-get-on-douyins-algorithm-and-gain-more-traffic" target="_blank" rel="noreferrer">KAWO：Five Key Metrics that Help Brands Get On Douyin's Algorithm</a></li>
          <li><a href="https://www.woshipm.com/operate/6086370.html" target="_blank" rel="noreferrer">人人都是产品经理：一文讲清小红书推荐算法的秘密</a></li>
          <li><a href="https://www.opp2.com/377683.html" target="_blank" rel="noreferrer">青瓜传媒：2026小红书推荐算法！一文讲清</a></li>
          <li><a href="https://xh.newrank.cn/product/article/article-detail/f17a2cabb44e4bdc" target="_blank" rel="noreferrer">新红数据：小红书推荐机制是怎样的？</a></li>
        
          <li><a href="https://www.douyin.com/search/%E8%96%9B%E8%BE%89%E5%9B%9B%E5%A4%A7%E8%84%9A%E6%9C%AC%E5%85%AB%E5%A4%A7%E7%88%86%E6%AC%BE%E5%85%83%E7%B4%A0" target="_blank" rel="noreferrer">抖音搜索：薛辉（8大爆款元素/4大脚本）</a></li>
          <li><a href="https://www.youtube.com/%40chenzuixiaowulang" target="_blank" rel="noreferrer">YouTube：沉醉的小五狼（公开内容目录）</a></li>
          <li><a href="https://mi.qtfm.cn/vchannels/411697/programs/18412554" target="_blank" rel="noreferrer">蜻蜓FM：小五狼思维研习社相关课程页（示例）</a></li>

          <li><a href="https://www.douyin.com/user/MS4wLjABAAAAkzWHrOb9pgCBETkFM6RLp0GLDmfqrtz31YOJJrfHbAxH9gk3tGEEpke43cLZDgE-" target="_blank" rel="noreferrer">抖音主页：亲爱的安先生（账号信息）</a></li>
          <li><a href="https://www.douyin.com/video/7384795853011029286" target="_blank" rel="noreferrer">抖音视频：15分钟讲明白人设——网红、博主和IP区别</a></li>
          <li><a href="https://www.douyin.com/video/7460532628261752127" target="_blank" rel="noreferrer">抖音视频：短视频教学对比讨论（安先生/薛辉）</a></li>
          <li><a href="https://zhuanlan.zhihu.com/p/673105668" target="_blank" rel="noreferrer">知乎专栏：安先生创作大课解析（公开讨论）</a></li>
        </ul>
        <div class="callout">
          <b>建议：</b>不要把“公式”当答案，把它当提示。最有效的是：对标拆解 + A/B 小测试 + 每周复盘。
        </div>
      </section>

      <section id="backup" class="card">
        <h2>导出 / 导入（本地保存你的对标库与日历）</h2>
        <p class="small">你的数据默认保存在浏览器本地（localStorage）。建议定期导出 JSON，换电脑也能导入继续用。</p>
        <div class="grid grid-2">
          <div class="card" style="margin:0">
            <h3>导出</h3>
            <button class="btn" id="exportBtn">⬇️ 导出 JSON 备份</button>
            <p class="small">将会下载一个 .json 文件（包含：对标库、拍摄日历、主题设置）。</p>
          </div>
          <div class="card" style="margin:0">
            <h3>导入</h3>
            <input type="file" id="importFile" accept="application/json">
            <button class="btn" id="importBtn">⬆️ 导入并覆盖</button>
            <p class="small">导入后会覆盖本地同名数据，请先导出备份。</p>
          </div>
        </div>
      </section>

      <footer class="card">
        <p class="small">
          版本：v1（离线单页）｜你可以直接把本 HTML 放到电脑桌面，双击打开使用。<br>
          如果你希望我按你的城市、你的个人风格、你的目标（涨粉/接单/课程）做“定制版”，告诉我 3 件事：主做城市、想做的主线（备婚/现场/同城）、你目前粉丝区间。
        </p>
      </footer>

    </div>
  </main>
</div>

<div class="sticky-tools print-hide">
  <button class="btn" id="toTopBtn" title="回到顶部">↑</button>
</div>

<div class="toast" id="toast">已复制</div>

<script>
/* ---------- Utilities ---------- */
const $ = (sel, root=document)=>root.querySelector(sel);
const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));
const toast = (msg="已完成")=>{
  const t=$("#toast");
  t.textContent=msg;
  t.style.display="block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer=setTimeout(()=>t.style.display="none", 1400);
};
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
const todayISO = ()=>{ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); };
const on = (id, ev, fn)=>{ const el = typeof id==="string" ? $("#"+id) : id; if(el) el.addEventListener(ev, fn); };


const STORE_KEY = "host_media_handbook_v1";


const DEFAULT_BENCH = [
  {platform:"抖音", account:"（示例）婚礼主持人/婚礼策划/情绪口播强者（先填你常刷到的爆款）", fans:"", pillar:"", title:"", conv:""},
  {platform:"抖音", account:"婚礼诗人刘允乐（关键词搜索）", fans:"", pillar:"情绪+台词", title:"", conv:""},
  {platform:"抖音", account:"主持人何晴（关键词搜索）", fans:"", pillar:"现场切片", title:"", conv:""},
  {platform:"抖音", account:"中式婚礼司仪李佳岷（关键词搜索）", fans:"", pillar:"中式流程", title:"", conv:""},
  {platform:"抖音", account:"中式婚礼主持人张博（关键词搜索）", fans:"", pillar:"现场+口播", title:"", conv:""},
  {platform:"抖音", account:"主持人智杰（武汉教主持）（关键词搜索）", fans:"", pillar:"教学", title:"", conv:""},
  {platform:"小红书", account:"（建议对标）本地婚礼主持人TOP：用「城市+婚礼主持人」搜索并填入", fans:"", pillar:"同城转化", title:"", conv:""}
];


/* ---------- Theme ---------- */
function applyTheme(theme){
  document.body.setAttribute("data-theme", theme);
  const state = loadState();
  state.theme = theme;
  saveState(state);
}
on("themeBtn","click", ()=>{
  const cur = document.body.getAttribute("data-theme") || "dark";
  applyTheme(cur==="dark" ? "light" : "dark");
});

/* ---------- Nav ---------- */
const nav = $("#nav");
on("openNavBtn","click", ()=> nav.classList.add("open"));
on("closeNavBtn","click", ()=> nav.classList.remove("open"));
window.addEventListener("hashchange", ()=>highlightNav());
function highlightNav(){
  const hash = location.hash || "#start";
  $$(".navlink").forEach(a=>{
    a.classList.toggle("active", a.getAttribute("href")===hash);
  });
}
highlightNav();
$$(".navlink").forEach(a=>{
  a.addEventListener("click", ()=>{ nav.classList.remove("open"); });
});

/* ---------- Search ---------- */
on("searchBox","input", (e)=>{
  const q = e.target.value.trim().toLowerCase();
  const cards = $$(".content section.card, .content footer.card");
  if(!q){ cards.forEach(c=>c.style.display=""); return; }
  cards.forEach(c=>{
    const txt = c.innerText.toLowerCase();
    c.style.display = txt.includes(q) ? "" : "none";
  });
});

/* ---------- Print ---------- */
on("printBtn","click", ()=>window.print());

/* ---------- To top ---------- */
on("toTopBtn","click", ()=>window.scrollTo({top:0, behavior:"smooth"}));

/* ---------- State ---------- */
function loadState(){
  try{
    return JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
  }catch(e){ return {}; }
}
function saveState(state){
  localStorage.setItem(STORE_KEY, JSON.stringify(state));
}
function boot(){
  const st = loadState();
  if(st.theme) document.body.setAttribute("data-theme", st.theme);
  bootBench(st);
  bootCal(st);
}
boot();

/* ---------- Benchmark table ---------- */
function benchRowHTML(row){
  const platform = row.platform || "抖音";
  return `
  <tr>
    <td>
      <select class="benchPlatform">
        <option ${platform==="抖音"?"selected":""}>抖音</option>
        <option ${platform==="小红书"?"selected":""}>小红书</option>
      </select>
    </td>
    <td><input type="text" class="benchAccount" placeholder="账号名或链接" value="${escapeHtml(row.account||"")}"></td>
    <td><input type="text" class="benchFans" placeholder="如 3w / 12万" value="${escapeHtml(row.fans||"")}"></td>
    <td><input type="text" class="benchPillar" placeholder="主打栏目" value="${escapeHtml(row.pillar||"")}"></td>
    <td><input type="text" class="benchTitle" placeholder="标题习惯/公式" value="${escapeHtml(row.title||"")}"></td>
    <td><input type="text" class="benchConv" placeholder="评论置顶/私信关键词/直播等" value="${escapeHtml(row.conv||"")}"></td>
    <td><button class="btn benchDel">删</button></td>
  </tr>`;
}
function escapeHtml(s){
  return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
function readBenchFromDOM(){
  const rows = $$("#benchTable tbody tr");
  return rows.map(tr=>({
    platform: $(".benchPlatform", tr).value,
    account: $(".benchAccount", tr).value.trim(),
    fans: $(".benchFans", tr).value.trim(),
    pillar: $(".benchPillar", tr).value.trim(),
    title: $(".benchTitle", tr).value.trim(),
    conv: $(".benchConv", tr).value.trim(),
  }));
}
function renderBench(rows){
  const tb = $("#benchTable tbody");
  tb.innerHTML = rows.map(r=>benchRowHTML(r)).join("");
  $$(".benchDel", tb).forEach((btn, idx)=>{
    btn.addEventListener("click", ()=>{
      const cur = readBenchFromDOM();
      cur.splice(idx, 1);
      renderBench(cur);
      persistBench(cur);
    });
  });
}
function persistBench(rows){
  const st = loadState();
  st.bench = rows;
  saveState(st);
  toast("已保存对标库");
}
function bootBench(st){
  const rows = Array.isArray(st.bench) ? st.bench : [];
  renderBench(rows.length ? rows : DEFAULT_BENCH.map(r=>({...r})));
  $("#addBenchBtn").addEventListener("click", ()=>{
    const cur = readBenchFromDOM();
    cur.push({platform:"抖音", account:"", fans:"", pillar:"", title:"", conv:""});
    renderBench(cur);
  });
  $("#saveBenchBtn").addEventListener("click", ()=>persistBench(readBenchFromDOM()));
  $("#clearBenchBtn").addEventListener("click", ()=>{
    renderBench([]);
    persistBench([]);
  });
  const resetBtn = $("#resetBenchBtn");
  if(resetBtn){
    resetBtn.addEventListener("click", ()=>{
      const fresh = DEFAULT_BENCH.map(r=>({...r}));
      renderBench(fresh);
      persistBench(fresh);
      toast("已恢复预设");
    });
  }
}

/* ---------- Generator (v6 workspace) ---------- */
// v6.1: missing helpers + template bank (keep generator self-contained)
const randint = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
const fillTemplate = (tpl, ctx)=>String(tpl)
  .replace(/\{topic\}/g, ctx.topic)
  .replace(/\{pain\}/g, ctx.pain)
  .replace(/\{city\}/g, ctx.city || "同城")
  .replace(/\{aud\}/g, ctx.aud || "备婚新人")
  .replace(/\{cta\}/g, ctx.ctaKey || "模板");

const BANK = {
  dyTitle: [
    "你以为{topic}很简单？其实90%新人翻车在“{pain}”",
    "主持人不告诉你的{topic}真相：先解决{pain}",
    "{topic}别照网上抄！这样做才不会{pain}",
    "新郎新娘最怕的不是尴尬，是{pain}（我见太多了）",
    "婚礼现场一旦{pain}，我只用这3句话救回来",
    "做对这一步，{topic}立刻稳（避免{pain}）",
    "{topic}最容易踩的3个坑：第2个很多人中招",
    "同城{city}备婚新人：{topic}这样排，基本不会{pain}",
    "别再背长台词了：{topic}用“结构”就够了",
    "{topic}想高级：别堆词，先把{pain}掐掉"
  ],
  xhsTitle: [
    "【{topic}清单】避免{pain}的 6 步（建议收藏）",
    "{topic}怎么做才不{pain}｜我整理了可直接照抄的模板",
    "备婚必看：{topic}最容易{pain}的 7 个细节",
    "{city}备婚新人｜{topic}流程模板（可截图）",
    "{topic}避坑指南：把{pain}从源头掐掉（清单版）",
    "主持人视角：{topic}这样写，现场更稳（收藏）",
    "别再临场硬扛：{topic}救场句/过渡句整理（模板）",
    "{topic}怎么讲不土？我把结构拆成了 3 段（收藏）",
    "{topic}对照表：这样做=稳，那样做=容易{pain}",
    "一篇讲透：{topic}从0到1怎么准备（清单+示例）"
  ],
  hooks: [
    "你以为{topic}只要背台词？真正让人慌的是“{pain}”。",
    "我主持了很多场，翻车最多的就是“{pain}”。",
    "如果你担心{pain}，这条一定要看完。",
    "{topic}想稳，不靠运气，只靠这3件事。",
    "别再照网上流程抄了，{topic}这样做更稳。"
  ],
  keys: [
    "先把流程写成 6 行",
    "每段话控制 15–20 秒",
    "关键句写在主持稿第 1 页",
    "每个环节准备一句过渡句",
    "冷场准备一句救场句",
    "把“时间点”写成清单",
    "用“三点结构”讲清楚",
    "结尾留评论入口引导互动"
  ]
};

const PRESET_KEY = STORE_KEY + "_preset_v6";

function setOutputs({title="", script="", tags="", cmt=""}){
  $("#outTitle").value = title.trim();
  $("#outScript").value = script.trim();
  $("#outTags").value = tags.trim();
  $("#outCmt").value = cmt.trim();
}

function platformBias(ctx){
  // Output a human-friendly bias line
  if(ctx.platform==="douyin") return "偏抖音（强钩子+节奏）";
  return "偏小红书（关键词+清单）";
}

function nextSeriesSuggestion(ctx){
  const base = (ctx.topic || "这个主题").replace(/[（(].*?[）)]/g,"").trim();
  const ep2 = `第2集：${base} 的“过渡句怎么写”（给 5 句可直接套用）`;
  const ep3 = `第3集：${base} 的“救场句怎么用”（冷场/超时/尴尬各 1 句）`;
  return { base, ep2, ep3, text:`下一条建议：做系列化\n- ${ep2}\n- ${ep3}\n置顶评论入口：评论【${ctx.ctaKey}】领《${base}清单/模板》` };
}

function updateStatus(kind, ctx){
  const titleEl = $("#statusTitle");
  const subEl = $("#statusSub");
  const moreEl = $("#statusMore");
  if(!titleEl || !subEl || !moreEl) return;

  const bias = platformBias(ctx);
  const {ep2, ep3} = nextSeriesSuggestion(ctx);

  const map = {
    pack: "✅ 已生成：一整套",
    titles: "✅ 已生成：标题（15个）",
    script: "✅ 已生成：脚本",
    cmt: "✅ 已生成：评论引导",
    series: "✅ 已生成：3条系列（上/中/下）",
    dycopy: "📋 已复制：抖音发布稿",
    xhscopy: "📋 已复制：小红书发布稿"
  };
  const label = map[kind] || "状态已更新";

  titleEl.textContent = `${label}｜${bias}`;
  subEl.textContent = `建议下一条：${ep2}`;
  moreEl.textContent = `备选第3条：${ep3}｜（评论关键词：${ctx.ctaKey}）`;
  // store for guide copy
  window.__lastGuide = nextSeriesSuggestion(ctx).text;
}

function wireStatusGuide(){
  const btn = $("#statusGuideBtn");
  if(!btn) return;
  btn.addEventListener("click", ()=>{
    const txt = window.__lastGuide || "先生成一次内容，我才能给你更精准的“下一条建议”。";
    copyText(txt);
  });
}

function clearOutputs(){
  setOutputs({title:"", script:"", tags:"", cmt:""});
  toast("已清空输出");
}

function getCtxV6(){
  const platform = $("#gPlatform").value;
  const style = $("#gStyle").value;
  const city = $("#gCity").value.trim();
  const aud = $("#gAudience").value.trim() || "备婚新人";
  const topic = $("#gTopic").value.trim() || "婚礼流程";
  const pain = $("#gPain").value.trim() || "流程混乱";
  const framework = $("#gFramework").value;
  const dyStruct = $("#gDyStructure").value;
  const boost = $("#gXWLBoost").value;
  const ctaKey = $("#gCTAKey").value.trim() || (platform==="xhs" ? "清单" : "模板");
  const fixedTag = $("#gTagFixed").value.trim() || "#主持人安宁";
  return { platform, style, city, aud, topic, pain, framework, dyStruct, boost, ctaKey, fixedTag,
           n: randint(100, 800), m: randint(3, 9) };
}

function buildTags(ctx){
  const base = [];
  if(ctx.platform==="xhs"){
    base.push(`#${ctx.topic}`, "#备婚", "#婚礼主持人", "#婚礼流程");
    if(ctx.city) base.push(`#${ctx.city}`);
  }else{
    base.push(`#${ctx.topic}`, "#婚礼主持人", "#婚礼现场", "#主持人干货", "#救场话术");
    if(ctx.city) base.push(`#${ctx.city}`);
  }
  // add style
  const map = { "干货清单":"#婚礼干货", "避坑反差":"#婚礼避坑", "现场救场":"#救场", "情绪故事":"#婚礼故事", "同城攻略":"#同城婚礼" };
  if(map[ctx.style]) base.push(map[ctx.style]);
  // ensure fixed tag
  if(ctx.fixedTag){
    ctx.fixedTag.split(/\s+/).filter(Boolean).forEach(t=>{ if(!base.includes(t)) base.push(t); });
  }
  return base.join(" ");
}

function pickStructure(ctx){
  if(ctx.dyStruct && ctx.dyStruct!=="auto") return ctx.dyStruct;
  // simple heuristic
  if(ctx.style==="干货清单") return "teach";
  if(ctx.style==="现场救场") return "process";
  if(ctx.style==="情绪故事") return "story";
  if(ctx.style==="避坑反差") return "view";
  return "teach";
}

function makeTitleList(ctx, count=15){
  const pool = (ctx.platform==="xhs") ? BANK.xhsTitle : BANK.dyTitle;
  const list = [];
  for(let i=0;i<count;i++){
    list.push(`${i+1}. ` + fillTemplate(pick(pool), ctx));
  }
  return list.join("\n");
}

function makeHook(ctx){
  // strengthen hook depending on framework
  let hook = fillTemplate(pick(BANK.hooks), ctx);
  if(ctx.framework==="xuehui"){
    // push "爆款按钮" style
    hook = hook.replace("你以为","很多人以为").replace("其实","但真正");
  }else if(ctx.framework==="xiaowulang"){
    // more rational and trustful
    hook = `先给结论：${ctx.topic}想避免“${ctx.pain}”，关键就 3 个点。`;
  }
  return hook;
}

function makeScript(ctx){
  const isXhs = ctx.platform==="xhs";
  const struct = pickStructure(ctx);

  // XWL boost helpers
  const usePyramid = ctx.boost!=="off" || ctx.framework==="xiaowulang" || ctx.framework==="auto";
  const withAnalogy = ctx.boost==="pyramid_analogy";
  const withChecklist = ctx.boost==="pyramid_checklist";

  const analogy = withAnalogy ? `\n类比一下：${ctx.topic}就像“导航”，你不先设路线，开再快也会绕路。` : "";

  let bodyPoints = [
    `1）${pick(BANK.keys)}。例子：把关键句写在主持稿的第 1 页，现场不慌。`,
    `2）${pick(BANK.keys)}。例子：每段话控制在 15–20 秒，观众更跟得上。`,
    `3）${pick(BANK.keys)}。例子：提前准备一句“救场句”，冷场也能拉回来。`
  ];

  const actionList = withChecklist ? `\n行动清单（照做就行）：\n- 先把流程写成 6 行\n- 每行配一句“过渡句”\n- 现场只盯时间点\n- 评论置顶放入口（${ctx.ctaKey}）` : "";

  // structure templates
  const hook = makeHook(ctx);
  let script = [];

  if(struct==="story"){
    script = [
      `【${isXhs?"小红书":"抖音"}口播脚本｜讲故事｜${ctx.style}】`,
      `0–3秒：${hook}`,
      `3–10秒：背景：我主持过很多场，最常见的翻车就是“${ctx.pain}”。`,
      `10–25秒：冲突：新人一紧张就把顺序打乱，现场越解释越乱。`,
      `25–45秒：转折：我后来用一套“先流程后台词”的方法，几乎不再出事。`,
      `45–60秒：复盘方法：\n${bodyPoints.join("\n")}${analogy}${actionList}`,
      `结尾：评论关键词【${ctx.ctaKey}】，我把《${ctx.topic}清单》放置顶。`
    ];
  }else if(struct==="process"){
    script = [
      `【${isXhs?"小红书":"抖音"}口播脚本｜晒过程｜${ctx.style}】`,
      `0–3秒：${hook}`,
      `3–10秒：我现场通常这样做：先把${ctx.topic}拆成 6 个时间点。`,
      `10–40秒：每一步我会做什么：\n${bodyPoints.join("\n")}`,
      `${analogy}${actionList}`,
      `结尾：要我现场用的“过渡句/救场句”，评论【${ctx.ctaKey}】。`
    ];
  }else if(struct==="teach"){
    script = [
      `【${isXhs?"小红书":"抖音"}口播脚本｜教知识｜${ctx.style}】`,
      `0–3秒：${usePyramid ? `先给结论：${ctx.topic}要稳，先解决“${ctx.pain}”这 3 件事。` : hook}`,
      `3–10秒：很多人以为是台词不够华丽，其实是结构没搭好。`,
      `10–45秒：三点清单：\n${bodyPoints.join("\n")}${analogy}${actionList}`,
      `结尾：想要模板，评论【${ctx.ctaKey}】，我放置顶。`
    ];
  }else{ // view
    script = [
      `【${isXhs?"小红书":"抖音"}口播脚本｜说观点｜${ctx.style}】`,
      `0–3秒：观点：${ctx.topic}别追“复杂”，越复杂越容易${ctx.pain}。`,
      `3–10秒：站队：我更支持“短、清、稳”。`,
      `10–45秒：3 个理由：\n${bodyPoints.join("\n")}${analogy}${actionList}`,
      `结尾：你站哪边？评论区聊聊，评论【${ctx.ctaKey}】我发清单。`
    ];
  }

  // XHS adaptation: add more "收藏提示" and keywords
  if(isXhs){
    script.push(`\n（小红书提示）建议收藏/截图：把这套“${ctx.topic}”当检查表用。`);
  }else{
    script.push(`\n（抖音提示）节奏：每 5–8 秒加一个例子/画面切换。`);
  }

  return script.join("\n");
}

function makeCommentGuide(ctx){
  const seriesHint = `我会把这个主题做成系列：第2集讲“怎么写过渡句”，第3集讲“现场救场句”。`;
  return [
    `置顶评论模板：评论【${ctx.ctaKey}】，我把《${ctx.topic}清单/模板》放置顶（可直接照抄）。`,
    `你最担心的是“${ctx.pain}”的哪个瞬间？把细节写出来，我给你一句现场话术。`,
    `想看${ctx.city?ctx.city:"同城"}版本的，评论【同城】，我做本地案例。`,
    `你更喜欢中式/西式/户外哪种？评论我做对应流程。`,
    seriesHint
  ].join("\n");
}

function makePack(ctx, mode="pack"){
  const titleCount = mode==="titles" ? 15 : (mode==="series" ? 9 : 5);
  const titles = makeTitleList(ctx, titleCount);

  let script = makeScript(ctx);
  let cmt = makeCommentGuide(ctx);
  let tags = buildTags(ctx);

  if(mode==="titles"){
    // still fill other cards with helpful defaults
    script = `【提示】你选择一个最顺口的标题后，再点“只生成文案脚本”。\n\n建议：抖音强钩子；小红书强关键词+清单。`;
    cmt = makeCommentGuide(ctx);
  }else if(mode==="script"){
    // keep titles shorter
    const t5 = makeTitleList(ctx, 5);
    return { title:`【标题备选】\n${t5}`, script, tags, cmt };
  }else if(mode==="cmt"){
    const t5 = makeTitleList(ctx, 5);
    script = `【提示】评论引导通常配合“清单/模板入口”使用。\n建议你把“${ctx.ctaKey}”做成固定关键词。`;
    return { title:`【标题备选】\n${t5}`, script, tags, cmt };
  }else if(mode==="series"){
    // generate 3 episode scripts quickly
    const base = ctx.topic;
    const epTopics = [`${base}（上）：结构怎么搭`, `${base}（中）：过渡句怎么写`, `${base}（下）：救场句怎么用`];
    const epOut = [];
    for(let i=0;i<3;i++){
      const c2 = {...ctx, topic: epTopics[i]};
      epOut.push(`—— 第${i+1}集 ——\n${makeScript(c2)}\n`);
    }
    script = epOut.join("\n");
    cmt = `置顶：评论【${ctx.ctaKey}】领《${base}系列清单》，我放置顶。\n` + cmt;
  }

  return { title:`【标题】\n${titles}`, script, tags, cmt };
}

/* Copy helpers for output cards */
async function copyText(txt){
  try{
    await navigator.clipboard.writeText(txt);
    toast("已复制到剪贴板");
  }catch(e){
    // fallback
    const ta = document.createElement("textarea");
    ta.value = txt;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    toast("已复制（兼容模式）");
  }
}

function joinPublish(ctx, kind){
  const title = $("#outTitle").value.trim();
  const script = $("#outScript").value.trim();
  const tags = $("#outTags").value.trim();
  const cmt = $("#outCmt").value.trim();

  if(kind==="douyin"){
    // Douyin: compact
    return [
      title ? title.split("\n").slice(0,6).join("\n") : "",
      "",
      script ? script.replace(/\n{3,}/g,"\n\n") : "",
      "",
      cmt ? `【置顶评论】\n${cmt.split("\n")[0]}` : "",
      "",
      tags ? tags : ""
    ].join("\n").trim();
  }
  // XHS: structured note
  const firstTitle = title.split("\n").find(l=>l && !l.startsWith("【") && !/^\d+\./.test(l)) || (ctx.topic + "清单（建议收藏）");
  const bullets = script.split("\n").filter(l=>/^\d+）/.test(l) || l.startsWith("- ")).slice(0,8).join("\n");
  return [
    `标题：${firstTitle.replace(/^\d+\.\s*/,"")}`,
    ``,
    `我是谁：婚礼主持人｜专做${ctx.aud}${ctx.city?("｜"+ctx.city):""}`,
    ``,
    `你会得到：一套“${ctx.topic}”可直接照抄的结构，避免“${ctx.pain}”。（建议收藏/截图）`,
    ``,
    `正文清单：`,
    bullets || script,
    ``,
    `评论区：评论【${ctx.ctaKey}】领《${ctx.topic}清单/模板》（我放置顶）`,
    ``,
    `#标签：${tags}`
  ].join("\n").trim();
}

/* Wizard navigation */
let wizardStep = 1;
function showStep(n){
  wizardStep = clamp(n,1,5);
  $$("[data-step]", $("#wizard")).forEach(box=>{
    const s = Number(box.getAttribute("data-step"));
    box.style.display = (s===wizardStep) ? "" : "none";
  });
  $$(".stepchip", $("#stepbar")).forEach(ch=>{
    const s = Number(ch.getAttribute("data-step"));
    ch.classList.toggle("active", s===wizardStep);
  });
}
$("#wizardPrev").addEventListener("click", ()=>showStep(wizardStep-1));
$("#wizardNext").addEventListener("click", ()=>showStep(wizardStep+1));
$$(".stepchip", $("#stepbar")).forEach(ch=>{
  ch.addEventListener("click", ()=>showStep(Number(ch.getAttribute("data-step"))));
});
showStep(1);

/* Presets */
const PRESETS = {
  douyin_fast: { platform:"douyin", style:"现场救场", framework:"xuehui", boost:"off", aud:"备婚新人", ctaKey:"模板" },
  xhs_save: { platform:"xhs", style:"干货清单", framework:"auto", boost:"pyramid_checklist", aud:"备婚新人", ctaKey:"清单" },
  city_convert: { platform:"douyin", style:"同城攻略", framework:"xiaowulang", boost:"pyramid", aud:"同城新人", ctaKey:"同城" }
};
$$(".presetpill").forEach(p=>{
  p.addEventListener("click", ()=>{
    const key = p.getAttribute("data-preset");
    const pr = PRESETS[key];
    if(!pr) return;
    $("#gPlatform").value = pr.platform;
    $("#gStyle").value = pr.style;
    $("#gFramework").value = pr.framework;
    $("#gXWLBoost").value = pr.boost;
    $("#gAudience").value = pr.aud;
    $("#gCTAKey").value = pr.ctaKey;
    toast("已应用预设");
  });
});

/* Pack buttons */
function gen(mode){
  try{
    const ctx = getCtxV6();
    const pack = makePack(ctx, mode);
    setOutputs(pack);
  }catch(err){
    console.error(err);
    toast("生成失败：请检查输入或刷新页面");
  }
}

$("#genPackBtn").addEventListener("click", ()=>{ gen("pack"); toast("已生成一整套"); });
$("#genTitlesBtn").addEventListener("click", ()=>{ gen("titles"); toast("已生成标题"); });
$("#genScriptBtn").addEventListener("click", ()=>{ gen("script"); toast("已生成脚本"); });
$("#genCommentsBtn").addEventListener("click", ()=>{ gen("cmt"); toast("已生成评论引导"); });
$("#genSeriesBtn").addEventListener("click", ()=>{ gen("series"); toast("已生成系列"); });

/* Copy single cards */
$$("button[data-copy]").forEach(btn=>{
  btn.addEventListener("click", ()=>copyText($("#"+btn.getAttribute("data-copy")).value || ""));
});

/* Copy all */
$("#copyAllBtn").addEventListener("click", ()=>{
  const all = [
    "【标题】", $("#outTitle").value.trim(),
    "\n【文案&脚本】", $("#outScript").value.trim(),
    "\n【标签】", $("#outTags").value.trim(),
    "\n【评论引导】", $("#outCmt").value.trim()
  ].join("\n");
  copyText(all);
});
$("#clearOutBtn").addEventListener("click", clearOutputs);

/* Copy publish format */
$("#copyDyBtn").addEventListener("click", ()=>{
  const ctx = getCtxV6();
  copyText(joinPublish(ctx, "douyin"));
  updateStatus("dycopy", ctx);
});
$("#copyXhsBtn").addEventListener("click", ()=>{
  const ctx = getCtxV6();
  copyText(joinPublish(ctx, "xhs"));
  updateStatus("xhscopy", ctx);
});

/* Save / Load preset */
function savePreset(){
  const ctx = getCtxV6();
  const data = {
    platform: ctx.platform, style: ctx.style, city: ctx.city, aud: ctx.aud,
    framework: ctx.framework, dyStruct: ctx.dyStruct, boost: ctx.boost,
    topic: ctx.topic, pain: ctx.pain, ctaKey: ctx.ctaKey, fixedTag: ctx.fixedTag
  };
  localStorage.setItem(PRESET_KEY, JSON.stringify(data));
  toast("已保存常用模板");
}
function loadPreset(){
  try{
    const data = JSON.parse(localStorage.getItem(PRESET_KEY) || "null");
    if(!data) return toast("还没有保存模板");
    $("#gPlatform").value = data.platform || "douyin";
    $("#gStyle").value = data.style || "干货清单";
    $("#gCity").value = data.city || "";
    $("#gAudience").value = data.aud || "";
    $("#gFramework").value = data.framework || "auto";
    $("#gDyStructure").value = data.dyStruct || "auto";
    $("#gXWLBoost").value = data.boost || "off";
    $("#gTopic").value = data.topic || "";
    $("#gPain").value = data.pain || "";
    $("#gCTAKey").value = data.ctaKey || "";
    $("#gTagFixed").value = data.fixedTag || "#主持人安宁";
    toast("已载入模板");
  }catch(e){
    toast("载入失败");
  }
}
function clearPreset(){
  localStorage.removeItem(PRESET_KEY);
  toast("已清除模板");
}
$("#savePresetBtn").addEventListener("click", savePreset);
$("#loadPresetBtn").addEventListener("click", loadPreset);
$("#clearPresetBtn").addEventListener("click", clearPreset);

/* Auto-load preset once */
setTimeout(loadPreset, 150);
wireStatusGuide();

/* ---------- Calendar ---------- */
function bootCal(st){
  $("#cStart").value = (st.calStart || todayISO());
  $("#cPillars").value = st.calPillars || "婚礼流程, 话术台词, 救场控场, 同城攻略, 预算拆解";
  if(st.calRows) renderCal(st.calRows);
}

function suggestTime(platform){
  // 通用参考：抖音偏晚间，小红书偏中午+晚间
  if(platform==="douyin"){
    return pick(["12:00-13:30","19:30-22:30","21:00-23:00"]);
  }
  return pick(["11:30-13:30","18:30-20:30","20:00-22:00"]);
}
function genCalRows(){
  const start = new Date($("#cStart").value || todayISO());
  const days = parseInt($("#cDays").value, 10);
  const per = parseInt($("#cPerDay").value, 10);
  const platform = $("#cPlatform").value;
  const pillars = ($("#cPillars").value || "").split(/[,，]/).map(s=>s.trim()).filter(Boolean);
  const forms = platform==="douyin"
    ? ["现场切片","口播清单","避坑反差","幕后流程","评论区答疑","同城一条"]
    : ["收藏清单","图文步骤","对比避坑","模板分享","关键词笔记","同城攻略"];
  const rows = [];
  for(let d=0; d<days; d++){
    const date = new Date(start); date.setDate(start.getDate()+d);
    const dateStr = date.toISOString().slice(0,10);
    for(let i=1; i<=per; i++){
      const pillar = pillars.length ? pillars[(d+i)%pillars.length] : "婚礼流程";
      const form = pick(forms);
      const ctx = {
        platform,
        style: form,
        city:"",
        aud:"备婚新人",
        topic:pillar,
        pain: pick(["流程混乱","台词尴尬","冷场","父母致辞太俗","预算超支","敬酒环节乱"])
      };
      const title = fillTemplate(pick(platform==="douyin"?BANK.dyTitle:BANK.xhsTitle), ctx);
      rows.push({date: dateStr, idx: i, pillar, form, title, time: suggestTime(platform)});
    }
  }
  return rows;
}
function renderCal(rows){
  const tb = $("#calTable tbody");
  tb.innerHTML = rows.map(r=>`
    <tr>
      <td>${r.date}</td>
      <td>第 ${r.idx} 条</td>
      <td>${escapeHtml(r.pillar)}</td>
      <td>${escapeHtml(r.form)}</td>
      <td>${escapeHtml(r.title)}</td>
      <td>${escapeHtml(r.time)}</td>
    </tr>
  `).join("");
}
function persistCal(rows){
  const st = loadState();
  st.calRows = rows;
  st.calStart = $("#cStart").value;
  st.calPillars = $("#cPillars").value;
  saveState(st);
  toast("已保存日历");
}
$("#genCalBtn").addEventListener("click", ()=>{
  const rows = genCalRows();
  renderCal(rows);
  toast("已生成日历");
});
$("#copyCalBtn").addEventListener("click", async ()=>{
  const rows = $$("#calTable tbody tr").map(tr=>$$("td", tr).map(td=>td.innerText.trim()).join("\t")).join("\n");
  if(!rows) return toast("日历为空");
  try{
    await navigator.clipboard.writeText(rows);
    toast("已复制日历");
  }catch(e){
    toast("复制失败，请手动选中复制");
  }
});
$("#saveCalBtn").addEventListener("click", ()=>{
  const st = loadState();
  const rows = st.calRows || genCalRows();
  persistCal(rows);
});
$("#clearCalBtn").addEventListener("click", ()=>{
  $("#calTable tbody").innerHTML = "";
  const st = loadState();
  st.calRows = [];
  saveState(st);
  toast("已清空日历");
});
function rowsToCSV(rows){
  const header = ["date","index","pillar","format","title","time"];
  const esc = (v)=>('"'+String(v??"").replaceAll('"','""')+'"');
  const lines = [header.join(",")].concat(rows.map(r=>[
    esc(r.date), esc(r.idx), esc(r.pillar), esc(r.form), esc(r.title), esc(r.time)
  ].join(",")));
  return lines.join("\n");
}
$("#dlCsvBtn").addEventListener("click", ()=>{
  const rows = genCalRows();
  const csv = rowsToCSV(rows);
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "拍摄日历.csv";
  a.click();
  URL.revokeObjectURL(a.href);
  toast("已导出 CSV");
});

/* ---------- Metrics diagnostics ---------- */
function rate(part, total){
  total = Number(total||0);
  part = Number(part||0);
  if(total<=0) return 0;
  return part/total;
}
function pct(x){ return (x*100).toFixed(2)+"%"; }

$("#calcBtn").addEventListener("click", ()=>{
  const plays = Number($("#mPlays").value||0);
  const likes = Number($("#mLikes").value||0);
  const comments = Number($("#mComments").value||0);
  const saves = Number($("#mSaves").value||0);
  const shares = Number($("#mShares").value||0);
  const follows = Number($("#mFollows").value||0);
  const avg = Number($("#mAvgWatch").value||0);

  if(plays<=0){
    $("#diag").innerHTML = "请先填写播放量。";
    return;
  }

  const likeR = rate(likes, plays);
  const comR  = rate(comments, plays);
  const saveR = rate(saves, plays);
  const shareR= rate(shares, plays);
  const followR=rate(follows, plays);

  let issues = [];
  // heuristic thresholds (general)
  if(likeR < 0.01) issues.push({k:"点赞偏低", v:`点赞率 ${pct(likeR)}（建议≥1%）`, fix:"开头更直接：给结果/冲突；中段每点给具体例子；封面标题更聚焦核心词"});
  if(comR < 0.003) issues.push({k:"评论偏低", v:`评论率 ${pct(comR)}（建议≥0.3%）`, fix:"每条必须设计“评论点”：站队/提问/让人补充；评论区用追问把线程拉长"});
  if(saveR < 0.004) issues.push({k:"收藏偏低", v:`收藏率 ${pct(saveR)}（建议≥0.4%）`, fix:"把内容改成清单/模板；用“建议收藏/截图”引导；把步骤写得更细"});
  if(followR < 0.002) issues.push({k:"转粉偏低", v:`转粉率 ${pct(followR)}（建议≥0.2%）`, fix:"主页定位一句话更清晰；结尾固定一句“关注我拿系列”；评论置顶给清单/模板入口"});
  if(avg && avg < 7) issues.push({k:"平均观看偏短", v:`平均观看 ${avg.toFixed(1)}s（建议≥7–10s 起）`, fix:"脚本每 5–8 秒给转折；删停顿；关键句提前；字幕更大更短"});

  if(!issues.length){
    $("#diag").className="callout good";
    $("#diag").innerHTML = `<b>状态良好：</b>你的互动/转化信号不差。下一步建议：<br>1）把这条拆成系列连发 3 条；<br>2）只做一个 A/B（标题或开头），继续放量。<br><span class="small">（点赞率 ${pct(likeR)}｜评论率 ${pct(comR)}｜收藏率 ${pct(saveR)}｜转粉率 ${pct(followR)}）</span>`;
    return;
  }

  issues = issues.slice(0,3);
  $("#diag").className="callout warn";
  $("#diag").innerHTML =
    `<b>最可能卡住的 3 个点：</b><br>` +
    issues.map((it, idx)=>`<div style="margin-top:8px"><b>${idx+1}. ${it.k}</b>：${it.v}<br><span class="small">下一条怎么改：${it.fix}</span></div>`).join("");

});

$("#clearMetricsBtn").addEventListener("click", ()=>{
  ["mPlays","mLikes","mComments","mSaves","mShares","mFollows","mAvgWatch"].forEach(id=>$("#"+id).value="");
  $("#diag").className="callout";
  $("#diag").innerHTML="填入数据后点击“生成诊断”…";
});

/* ---------- Export / Import ---------- */
$("#exportBtn").addEventListener("click", ()=>{
  const st = loadState();
  // ensure newest DOM state is saved
  st.bench = readBenchFromDOM();
  saveState(st);

  const blob = new Blob([JSON.stringify(st, null, 2)], {type:"application/json;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "主持人自媒体手册_备份.json";
  a.click();
  URL.revokeObjectURL(a.href);
  toast("已导出备份");
});

$("#importBtn").addEventListener("click", async ()=>{
  const f = $("#importFile").files?.[0];
  if(!f) return toast("请选择 JSON 文件");
  try{
    const txt = await f.text();
    const obj = JSON.parse(txt);
    localStorage.setItem(STORE_KEY, JSON.stringify(obj));
    toast("已导入，刷新生效");
    setTimeout(()=>location.reload(), 600);
  }catch(e){
    toast("导入失败：JSON 不合法");
  }
});
</script>

<script>/*__HOST_EMBED_CATALOG_SCRIPT__*/
(function(){
  const BTN_ID='hostEmbedCatalogBtn';
  const BACK_ID='hostEmbedCatalogBackdrop';
  const OPEN_CLS='hostNavOpen';

  function ensure(){
    // Backdrop
    let back = document.getElementById(BACK_ID);
    if(!back){
      back = document.createElement('div');
      back.id = BACK_ID;
      document.body.appendChild(back);
      back.addEventListener('click', ()=> document.body.classList.remove(OPEN_CLS));
    }
    // Button
    let btn = document.getElementById(BTN_ID);
    if(!btn){
      btn = document.createElement('button');
      btn.id = BTN_ID;
      btn.type = 'button';
      btn.className = 'btn';
      btn.innerHTML = '📑 目录';
      document.body.appendChild(btn);
      btn.addEventListener('click', ()=> document.body.classList.toggle(OPEN_CLS));
    }
    // Close button inside nav (optional)
    const nav = document.querySelector('aside#nav, aside.nav');
    if(nav && !nav.querySelector('#hostEmbedCatalogClose')){
      nav.style.position = 'fixed';
      nav.style.right = '0';
      const close = document.createElement('button');
      close.id = 'hostEmbedCatalogClose';
      close.type = 'button';
      close.className = 'btn';
      close.textContent = '✕';
      close.setAttribute('aria-label','关闭目录');
      close.style.cssText = 'position:absolute;top:10px;left:10px;z-index:2;padding:6px 10px;border-radius:12px;';
      nav.appendChild(close);
      close.addEventListener('click', ()=> document.body.classList.remove(OPEN_CLS));
    }

    // Intercept in-page anchor so it never navigates parent
    document.addEventListener('click', (e)=>{
      const a = e.target && e.target.closest ? e.target.closest('a[href^="#"]') : null;
      if(!a) return;
      const href = a.getAttribute('href') || '#';
      if(href === '#' ) return;
      const id = href.slice(1);
      if(!id) return;
      const el = document.getElementById(id);
      if(el){
        e.preventDefault();
        try{ el.scrollIntoView({behavior:'smooth', block:'start'}); }catch(_){
          el.scrollIntoView(true);
        }
        try{ history.replaceState(null,'', '#'+id); }catch(_){
          location.hash = id;
        }
        document.body.classList.remove(OPEN_CLS);
      }
    }, true);

    // Esc closes drawer
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape') document.body.classList.remove(OPEN_CLS);
    });
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ensure);
  else ensure();
})();
</script>
</body>
</html>

    </template>
  </section>

  <section class="view" id="viewMusic">
    <div class="grid">
      <main class="cards">
        
        <section class="card" id="musicSystem" data-sec>
          <h3><span class="num">M</span> 音频播放系统（P1/酷狗风）</h3>
          <div class="sub2">
            支持：<b>PC 拖入</b> / <b>上传</b> / <b>改名（不弹窗）</b> / <b>播放列表拖拽排序</b> / <b>裁剪片段（可保存为新曲目）</b> / <b>单曲循环 / 顺序播放 / 播完暂停</b>。
          </div>

          
          <div class="msModeBar">
            <div class="seg" role="tablist" aria-label="播放器模式">
              <button class="segbtn" id="btnMusicBuiltin" type="button">内置播放器</button>
              <button class="segbtn" id="btnMusicP1" type="button">P1 播控台</button>
              <button class="segbtn" id="btnMusicExtTools" type="button" title="外部工具入口">外部工具</button>
            </div>
            <button class="btn small" id="btnMusicUvrPage" type="button" title="打开伴奏制作（UVR）">伴奏制作</button>
            <button class="btn small" id="btnMusicKtv" type="button" title="打开KTV歌词投放">KTV歌词</button>
            <div class="hint" id="musicModeHint">当前：内置播放器</div>
          <div class="row" id="p1SizeBar" aria-label="P1 播控台大小控制">
            <span class="small muted">界面高度</span>
            <input type="range" id="p1HeightRange" min="360" max="1600" step="10" value="980" />
            <span class="mono small" id="p1HeightLabel">—</span>
            <button class="btn small" id="btnP1Full" type="button" title="让 P1 播控台占据满屏/退出">满屏</button>
            <button class="btn small" id="btnP1ResetH" type="button" title="恢复默认高度">重置</button>
          </div>

          </div>

          <details class="ktvDetails" id="ktvDetails">
            <summary><span class="ktvSumTitle">🎤 KTV 歌词投放</span><span class="ktvSumRight"><span class="ktvSumStatus" id="ktvSumStatus">未加载</span><span class="muted small">导入/粘贴 → 同步高亮 → 全屏/投放</span></span></summary>
            <div class="ktvBody">
              <div class="ktvTools">
                <button class="btn small" id="btnKtvLoadLrc" type="button">导入 LRC</button>
                <button class="btn small" id="btnKtvEdit" type="button">粘贴/编辑</button>
                <button class="btn small ghost" id="btnKtvClear" type="button">清空</button>
                <span class="muted small">｜</span>
                <button class="btn small" id="btnKtvSaveSong" type="button" title="将当前歌词绑定并保存到正在播放的歌曲">保存到当前歌曲</button>
                <button class="btn small ghost" id="btnKtvLoadSong" type="button" title="从已保存的歌词库中加载当前歌曲的歌词">加载当前歌曲歌词</button>
                <span class="muted small">｜</span>
                <button class="btn small primary" id="btnKtvCast" type="button" title="打开独立投放窗口（可拖到第二屏/电视）">投放窗口</button>
                <button class="btn small" id="btnKtvFull" type="button" title="在本页面全屏覆盖显示歌词">全屏覆盖</button>
                <button class="btn small danger" id="btnKtvStopCast" type="button" style="display:none">关闭投放</button>
                <input id="ktvPickLrc" type="file" accept=".lrc,text/plain" style="display:none"/>
              </div>

              <div class="ktvGrid">
                <div>
                  <div class="muted small" style="margin:0 0 8px">歌词预览（点击某行可跳转到该时间）</div>
                  <div class="ktvViewer" id="ktvViewer"></div>
                </div>
                <div class="ktvMeta">
                  <div class="twoCol">
                    <div class="field">
                      <label>歌词偏移（秒） <span class="muted">（+ 延后 / - 提前）</span></label>
                      <input type="range" id="ktvOffsetRange" min="-8" max="8" step="0.05" value="0">
                      <div class="muted mono" id="ktvOffsetLabel">0.00s</div>
                    </div>
                    <div class="field">
                      <label>投放字号</label>
                      <input type="range" id="ktvFontRange" min="28" max="120" step="1" value="56">
                      <div class="muted mono" id="ktvFontLabel">56px</div>
                    </div>
                  </div>
                  <div class="field">
                    
<div class="ktvTogGrid" id="ktvTogGrid">
  <button class="ktvTog" type="button" data-kid="ktvAutoScroll" aria-pressed="true" title="当前行自动居中">
    <span class="ico">🧲</span>
    <span class="tt">跟随滚动</span>
    <span class="dd">当前行居中</span>
  </button>
  <button class="ktvTog" type="button" data-kid="ktvFxOn" aria-pressed="true" title="描边/渐变/唱过变色">
    <span class="ico">✨</span>
    <span class="tt">视觉增强</span>
    <span class="dd">描边 + 渐变</span>
  </button>
  <button class="ktvTog" type="button" data-kid="ktvWordMode" aria-pressed="true" title="增强 LRC 才生效">
    <span class="ico">🔤</span>
    <span class="tt">逐字高亮</span>
    <span class="dd">增强 LRC</span>
  </button>
  <button class="ktvTog" type="button" data-kid="ktvShowRole" aria-pressed="true" title="男/女/合/和声">
    <span class="ico">🎭</span>
    <span class="tt">伴唱提示</span>
    <span class="dd">男/女/合/和声</span>
  </button>
</div>
<div class="ktvHiddenInputs" aria-hidden="true">
  <input type="checkbox" id="ktvAutoScroll" checked>
  <input type="checkbox" id="ktvFxOn" checked>
  <input type="checkbox" id="ktvWordMode" checked>
  <input type="checkbox" id="ktvShowRole" checked>
</div>
</div>
                    </div>
                  <div class="field">
                    <label>当前歌曲</label>
                    <div class="mono" id="ktvSongLabel">—</div>
                  </div>
                  <div class="field">
                    <label>状态</label>
                    <div class="muted" id="ktvStatus">未加载歌词</div>
                  </div>
                  <div class="field">
                    <label>播放监测</label>
                    <div class="muted mono" id="ktvPbInfo">—</div>
                  </div>
                  <div class="field">
                    <label>提示</label>
                    <div class="muted small">支持标准 LRC（[mm:ss.xx]）与增强 LRC（逐字：<mm:ss.xx>）。增强 LRC 可实现逐字高亮，更像真实 KTV。</div>
                  </div>
                </div>
              </div>

              <div id="ktvEditorWrap" style="display:none; margin-top:12px">
                <div class="muted small" style="margin:0 0 8px">粘贴/编辑 LRC（示例：<span class="mono">[00:12.34]这一句歌词</span>）</div>
                <textarea class="inp" id="ktvEditor" style="width:100%; height:190px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; line-height:1.35"></textarea>
                <div class="ktvTools" style="margin-top:10px">
                  <button class="btn small primary" id="btnKtvApply" type="button">应用歌词</button>
                  <button class="btn small" id="btnKtvCancelEdit" type="button">取消</button>
                </div>
              </div>
            </div>
          </details>

          <div id="ktvOverlay" aria-label="KTV 全屏歌词覆盖">
            <div class="ktvOverlayTop">
              <div class="ktvOverlayTitle">🎤 KTV 歌词投放</div>
              <div class="ktvTools">
                <button class="btn small" id="btnKtvOverlayExit" type="button">退出</button>
              </div>
            </div>
            <div class="ktvOverlayBody">
              <div class="ktvRoleBadge" id="ktvOverlayRole" style="display:none"><i></i><span>—</span></div>
              <div class="ktvBigLine ktvKLine" id="ktvOverlayLine1">—</div>
              <div class="ktvProgress" id="ktvOverlayProg"><i></i></div>
              <div class="ktvNextLine" id="ktvOverlayLine2"></div>
              <div class="ktvHintLine" id="ktvOverlayHint">Esc / 点击退出</div>
            </div>
          </div>


          <div id="msBuiltinWrap">
          <div class="p1Player" id="p1Player">
            <div class="p1Row">
              <div class="p1Now">
                <div class="p1Title" id="nowTitle">未选择音乐</div>
                <div class="p1Meta" id="nowMeta">—</div>
              </div>
              <div class="p1Btns">
                <button class="iconbtn" id="btnPrev" title="上一首">⏮</button>
                <button class="iconbtn primary" id="btnPlay" title="播放/暂停">▶</button>
                <button class="iconbtn" id="btnNext" title="下一首">⏭</button>
              </div>
            </div>

            <div class="p1Row" style="gap:12px">
              <div class="p1Time" id="timeLeft">0:00</div>
              <input class="p1Seek" id="seekBar" type="range" min="0" max="1000" value="0"/>
              <div class="p1Time" id="timeRight">0:00</div>
              <input class="p1Vol" id="volBar" type="range" min="0" max="1" step="0.01" value="0.85" title="音量"/>
            </div>

            <div class="p1Row p1Modes">
              <div class="pill" id="modeHint">模式：顺序播放（单曲循环，按片段末尾触发）</div>
              <div class="pill muted">提示：点击队列卡片可播放/暂停；双击打开裁剪</div>
            </div>
          </div>

          
          <div class="kgBar">
            <div class="pill muted">布局：拖拽竖条调宽</div>
            <div class="kgBarBtns">
              <button class="sbtn" id="btnUndo" title="返回上一步（撤销误操作）">↩ 返回上一步</button>
              <button class="sbtn" id="btnToggleLib" title="向左侧收起/展开音乐库">⟪ 收起音乐库</button>
              <button class="sbtn" id="btnResetPanes" title="恢复默认宽度">重置宽度</button>
            </div>
          </div>

          <div class="kgWrap" id="kgWrap">
<div class="kgGrid kgResizable" id="kgGrid">
<div class="kgCol kgColLib" id="kgColLib">
              <div class="kgHead">
                <div class="kgTitle">音乐库</div>
                <div class="kgHeadRight">
                  <input class="kgSearch" id="libSearch" placeholder="搜索名称…"/>
                  <button class="sbtn" id="btnCatsToggle" title="隐藏/显示分类">隐藏分类</button>
                  <button class="sbtn" id="btnAddCatQuick" title="新增分类（直接生成，可改名）">＋分类</button>
            <button class="sbtn primary" id="btnUpload">上传/拖入</button>
                </div>
              </div>

              <div class="kgCats" id="libCats"></div>

              <div class="dropZone" id="libDrop">
                <div class="dzBig">把音频拖到这里</div>
                <div class="muted">支持 mp3 / wav / m4a / ogg（离线保存）</div>
              </div>

              <div class="kgList" id="libList"></div>
              <div class="kgVResizer" id="libVResizer" title="拖动调整：音乐列表高度"></div>
              <div class="kgScroll"><div class="lab">快速浏览</div><input id="libScroll" type="range" min="0" max="1000" value="0"/></div>
            </div>
              <div class="kgResizer" data-resize="lib" title="拖拽调整：音乐库 ↔ 播放列表"></div>
<div class="kgCol kgColPl" id="kgColPl">
              <div class="kgHead">
                <div class="kgTitle">播放列表</div>
                <button class="sbtn" id="btnNewPl">+ 新建</button>
              </div>
              <div class="kgList" id="plList"></div>
              <div class="kgTip muted">拖曲目到列表可添加；列表名可直接改。</div>
            </div>
              <div class="kgResizer" data-resize="pl" title="拖拽调整：播放列表 ↔ 当前队列"></div>
<div class="kgCol kgColQueue" id="kgColQueue">
              <div class="kgHead">
                <div class="kgTitle" id="queueTitle">当前队列</div>
                <div class="kgHeadRight"><button class="sbtn" id="btnClearQueue">清空</button>
                </div>
              </div>

              <div class="dropZone" id="queueDrop">
                <div class="dzBig">把音乐拖进队列</div>
                <div class="muted">支持从音乐库拖入 / PC 文件拖入</div>
              </div>

              <div class="kgList kgQueueList" id="queueList"></div>
            
              <div class="kgQueueFoot">
                <button class="sbtn" id="btnQueueSmaller" title="队列卡片变小">▭−</button>
                <button class="sbtn" id="btnQueueGrid" title="切换：条形/方块">≡</button>
                <button class="sbtn" id="btnQueueBigger" title="队列卡片变大">▭＋</button>
              </div>
</div>
            </div>
          </div>

          
          <!-- === v2.6.24: UVR 引擎（伴奏制作） === -->
          

          <div class="clipDrawer" id="clipDrawer" style="display:none">
            <div class="clipHead">
              <div class="clipTitle">裁剪片段（可保存为新曲目）</div>
              <button class="sbtn" id="btnCloseClip">完成</button>
            </div>
            <div class="clipBody">
              <div class="clipHandle" id="clipHandle"><div><div class="h">拖动移动裁剪窗口</div><div class="m">在波形上拖拽选择片段；也可直接输入开始/结束时间</div></div><div class="rowBtns"><button class="sbtn" id="btnSaveClipAs">保存为新曲目</button></div></div>
              <div class="clipWaveWrap"><canvas class="clipWave" id="clipWave" width="1200" height="240"></canvas><div class="clipWaveHint"><span>拖动选择：开始/结束</span><span>双击波形：整段</span></div></div>

              <div class="clipRow">
                <div class="clipLab">开始</div>
                <input type="range" id="clipStart" min="0" max="0" value="0" step="0.01"/>
                <input class="clipNum" id="clipStartNum" type="number" min="0" step="0.1" value="0"/>
              </div>
              <div class="clipRow">
                <div class="clipLab">结束</div>
                <input type="range" id="clipEnd" min="0" max="0" value="0" step="0.01"/>
                <input class="clipNum" id="clipEndNum" type="number" min="0" step="0.1" value="0"/>
              </div>
              <div class="clipRow">
                <div class="clipLab">片段</div>
                <div class="clipSeg" id="clipSegLabel">0:00 — 0:00</div>
                <div class="clipSeg muted">到结束点会按模式：下一首 / 循环 / 暂停（严格按片段末尾触发）</div>
              </div>
            </div>
          </div>


          
          <details class="soft" style="margin-top:14px" id="extTools">
            <summary>🔗 外部工具入口（点击跳转）</summary>
            <div class="sub2" style="margin-top:10px">
              这里仅做 <b>外部网页/本地工具</b> 的快捷入口：填写链接后点击“打开工具”会在新标签页跳转。
              支持 <b>https://</b> 或 <b>file://</b>（部分浏览器可能会拦截 file://，如遇阻拦请直接在浏览器地址栏打开该路径，或换用允许本地文件跳转的浏览器设置）。
            </div>

            <div class="boxgrid" style="margin-top:10px">
              <div class="box">
                <h4 style="margin:0 0 10px">工具 ①（KGM/KGMA）</h4>
                <div class="form-grid">
                  <div class="field">
                    <label>名称</label>
                    <input class="inp" id="extTool1Name" placeholder="例如：酷狗 KGM/KGMA 转换工具" />
                  </div>
                  <div class="field" style="grid-column:1/-1">
                    <label>链接（URL）</label>
                    <input class="inp" id="extTool1Url" placeholder="粘贴 https:// 或 file:// 路径" />
                  </div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
                  <button class="btn" id="btnOpenTool1">打开工具</button>
                </div>
              </div>

              <div class="box">
                <h4 style="margin:0 0 10px">工具 ②（NCM）</h4>
                <div class="form-grid">
                  <div class="field">
                    <label>名称</label>
                    <input class="inp" id="extTool2Name" placeholder="例如：网易云 NCM 转换工具" />
                  </div>
                  <div class="field" style="grid-column:1/-1">
                    <label>链接（URL）</label>
                    <input class="inp" id="extTool2Url" placeholder="粘贴 https:// 或 file:// 路径" />
                  </div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
                  <button class="btn" id="btnOpenTool2">打开工具</button>
                </div>
              </div>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
              <button class="btn ghost" id="btnSaveExtTools">保存入口</button>
              <button class="btn ghost" id="btnResetExtTools">恢复默认</button>
              <button class="btn ghost" id="btnClearExtTools">清空</button>
            </div>
            <div class="muted" style="margin-top:8px">提示：保存后会记住入口，下次打开仍可用。</div>
          </details>


          <input id="audioFile" type="file" accept="audio/*" multiple style="display:none"/>
          <audio id="audioEl" preload="metadata"></audio>
        
          </div><!-- /msBuiltinWrap -->

          <div id="msP1Wrap">
            <div id="p1MiniBar" class="p1MiniBar" aria-label="P1 满屏极简顶栏">
              <div class="p1MiniLeft">
                <button class="btn small" id="btnP1ExitToBuiltin" type="button" title="返回内置播放器">← 内置</button>
                <div class="p1MiniTitle">P1 播控台</div>
              </div>
              <div class="p1MiniRight">
                <button class="btn small" id="btnP1MiniExitFull" type="button" title="退出满屏">退出满屏</button>
              </div>
            </div>
            <div class="muted" style="margin:0 0 10px">
              P1 播控台与内置播放器<strong>互斥</strong>：切换会自动停止另一边。此模式下建议使用 <b>↑↓ 调主音量</b>、<b>左右/多媒体键 切上下曲</b>、<b>字母热键 秒播</b>。
            </div>
            <iframe id="p1ConsoleFrame" title="P1 播控台"></iframe>
          </div>


          <div id="msUvrPage" aria-label="伴奏制作（UVR）">
            <div class="msUvrTop">
              <button class="btn small" id="btnUvrBack" type="button" title="返回音乐系统">← 返回</button>
              <div class="muted small" id="uvrPageHint">伴奏制作（离线）</div>
            </div>
<div class="kgCol uvrCol" id="uvrCol">
            <div class="kgHead">
              <div>
                <div class="kgTitle">UVR 引擎</div>
                <div class="uvrMeta">分离 → 试听 → 导出 → 自动入库 → 队列联动 → 立即播放（可选）</div>
              </div>
              <div class="kgHeadRight">
                <span class="uvrBadge" id="uvrStatus">ONNX：未检测到（将使用快速离线）</span>
              </div>
            </div>

            <div class="kgBody" style="padding:12px">
              <div class="uvrGrid">
                <div>
                                    <div class="uvrRow" style="margin-bottom:8px">
                    <div class="muted" style="min-width:64px">来源</div>
                    <select class="inp" id="uvrSourceType" title="选择源曲目来源" style="min-width:160px">
                      <option value="builtin">内置音乐库</option>
                      <option value="p1">P1 全库 CUE</option>
                    </select>
                    <input class="inp" id="uvrSourceFilter" placeholder="搜索曲目 / CUE…" style="min-width:180px"/>
                    <select class="inp" id="uvrSourceSel" title="选择要分离的曲目"></select>
                    <button class="sbtn" id="btnUvrUseNow" type="button" title="用当前正在播放的曲目">用正在播放</button>
                  </div>

                  <div class="uvrRow" style="margin-bottom:8px">
                    <div class="muted" style="min-width:64px">入库到</div>
                    <select class="inp" id="uvrDestPlayer" title="选择入库 / 入队列 / 播放目标" style="min-width:160px">
                      <option value="builtin">内置播放器</option>
                      <option value="p1">P1 播控台</option>
                    </select>
                    <span class="muted-small">分类默认：<b>UVR 输出</b></span>
                  </div><div class="uvrRow" style="margin-bottom:8px">
                    <div class="muted" style="min-width:64px">引擎</div>
                    <label class="checkRow" style="gap:8px"><input type="radio" name="uvrEngine" value="onnx" checked> <span>ONNX（推荐）</span></label>
                    <label class="checkRow" style="gap:8px"><input type="radio" name="uvrEngine" value="quick"> <span>快速离线（近似）</span></label>
                  </div>

                  <details class="uvrDetails" style="margin:6px 0 8px">
                    <summary class="muted" style="cursor:pointer">高级引擎（Demucs / MDX23C）</summary>
                    <div class="muted-small" style="margin-top:6px; line-height:1.6">
                      需要桌面端（Electron）内置推理后端后才可启用。当前已预留开关与调用接口，不影响其他功能。
                    </div>
                    <div class="uvrRow" style="margin-top:8px">
                      <label class="checkRow" style="gap:8px"><input type="checkbox" id="uvrAdvEnable" disabled> <span>启用高级引擎</span></label>
                      <select class="inp" id="uvrAdvSel" disabled>
                        <option value="demucs">Demucs</option>
                        <option value="mdx23c">MDX23C</option>
                      </select>
                    </div>
                  </details>

                  <div class="uvrRow" style="margin-bottom:8px">
                    <div class="muted" style="min-width:64px">预设</div>
                    <div class="uvrPresetRow">
                      <button class="sbtn" id="btnUvrPresetStd" type="button">标准</button>
                      <button class="sbtn" id="btnUvrPresetStrong" type="button">更强去人声</button>
                      <button class="sbtn" id="btnUvrPresetGentle" type="button">更自然</button>
                      <button class="sbtn" id="btnUvrPresetVocal" type="button">人声提取</button>
                    </div>
                  </div>

                  <div class="uvrRow" style="margin-bottom:8px">
                    <div class="muted" style="min-width:64px">强度</div>
                    <input type="range" id="uvrStrength" min="0" max="1" step="0.01" value="0.85" style="flex:1; min-width:180px">
                    <span class="mono" id="uvrStrengthVal" style="min-width:56px; text-align:right">0.85</span>
                  </div>

                  <div class="uvrRow" style="margin-top:10px">
                    <button class="btn primary" id="btnUvrRun" type="button">开始分离</button>
                    <button class="btn" id="btnUvrCancel" type="button" style="display:none">取消</button>
                    <input id="uvrPickFile" type="file" accept="audio/*" style="display:none"/>
                    <button class="btn ghost" id="btnUvrPickFile" type="button">选择本地文件</button>
                    <div class="muted-small" id="uvrMsg" style="margin-left:auto"></div>
                  </div>

                  <div class="uvrProgress" style="margin-top:10px">
                    <div id="uvrProgressBar"></div>
                  </div>
                </div>

                <div>
                  <div class="uvrPreview" id="uvrPreview">
                    <div class="uvrRow" style="justify-content:space-between; margin-bottom:8px">
                      <div style="font-weight:800">试听</div>
                      <div class="uvrRow" style="gap:8px">
                        <span class="muted-small">人声</span>
                        <input type="range" id="uvrVolVoc" min="0" max="1" step="0.01" value="1" style="width:120px">
                        <span class="muted-small">伴奏</span>
                        <input type="range" id="uvrVolInst" min="0" max="1" step="0.01" value="1" style="width:120px">
                      </div>
                    </div>

                    <div class="uvrRow" style="margin-bottom:8px; flex-direction:column; align-items:stretch">
                      <div class="muted-small">人声（Vocal）</div>
                      <audio id="uvrAudioVoc" controls></audio>
                    </div>
                    <div class="uvrRow" style="margin-bottom:10px; flex-direction:column; align-items:stretch">
                      <div class="muted-small">伴奏（Instrumental）</div>
                      <audio id="uvrAudioInst" controls></audio>
                    </div>

                    <div class="uvrRow" style="flex-wrap:wrap; gap:10px">
                      <button class="btn" id="btnUvrExportVoc" type="button">导出人声</button>
                      <button class="btn" id="btnUvrExportInst" type="button">导出伴奏</button>
                      <button class="btn ghost" id="btnUvrToLib" type="button">自动入库</button>
                      <button class="btn ghost" id="btnUvrToQueue" type="button">入库并入队列</button>
                      <button class="btn primary" id="btnUvrToPlay" type="button">入库并播放伴奏</button>
                    </div>

                    <div class="muted-small" style="margin-top:8px">
                      提示：ONNX 引擎未就绪时，会自动使用“快速离线（近似）”算法；桌面端可接入真正 UVR 推理后端以获得更高质量。
                    </div>
                  </div>

                  <div class="muted-small" style="line-height:1.6">
                    <b>说明：</b>这是你现有音乐系统的“原生扩展点”。UI 与操作习惯保持一致，且不会影响原有播放/剪裁/入库/队列逻辑。<br>
                    <b>推荐：</b>桌面端启用 ONNX 推理（内置轻量模型）后，可做到真正 UVR 级别的离线分轨。
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>


        </section>

      </main>

      
    </div>
  </section>

<script type="application/json" id="defaultScripts">{"sec1": ["各位来宾，欢迎来到【地点】，见证【新郎】与【新娘】的婚礼。", "请大家先找到座位，把手机调至静音，目光交给舞台中央。", "仪式马上开始，感谢大家的配合。"], "sec2": ["各位来宾，大家好！欢迎来到【地点】。", "我是今天的主持人【你的名字】，请大家把手机调至静音，把目光交给舞台中央。", "此刻，让我们用最热烈的掌声，开启今天的幸福时刻！"], "sec3": ["接下来，请大家把目光交给通道与舞台中央。", "让我们用掌声欢迎今天的男主角——【新郎名字】登场！", "掌声再热烈一点，欢迎他走向属于他的幸福时刻。"], "sec4": ["此刻，请把掌声准备好，把目光交给通道尽头。", "我们一起倒数迎接她的到来：3、2、1！", "掌声送上，欢迎今天的女主角——【新娘名字】入场！"], "sec5": ["请【交接人称谓】带着【新娘】走向舞台中央。（停顿）", "此刻，把她的手交到【新郎】手中，也把嘱托交给他。（停顿）", "请两位新人牵起手，面向来宾，给大家一个定格的画面。"], "sec6": ["此刻，请两位新人牵手，共同走向舞台中央。（停顿）", "步子慢一点，把这一段路走成一生的开始。（停顿）", "掌声送上，欢迎他们站到属于他们的位置！"], "sec7": ["接下来，我们把掌声先放一放，把安静留给两位新人。", "【新郎】，看着【新娘】，用一句话说出你此刻最想给她的承诺。（递话筒）", "【新娘】，也请你用一句话回应他。（停顿）"], "sec8": ["接下来进入交换戒指的时刻。", "请【新郎】为【新娘】戴上戒指——动作慢一点，让大家看清这份承诺。（停顿）", "也请【新娘】为【新郎】戴上戒指，掌声送上！"], "sec9": ["此刻，请两位新人先给彼此一个拥抱，感谢对方的选择。（停顿）", "接下来，在掌声与祝福中——新郎，你可以亲吻你的新娘了。", "掌声送上！请定格三秒，给大家留一张幸福的照片。"], "sec10": ["接下来邀请今天的证婚人【姓名/称谓】上台，掌声欢迎。", "他/她将为两位新人送上见证与祝福。（递话筒）", "谢谢证婚人的祝福，掌声送上！"], "sec11": ["接下来邀请双方父母代表上台发言，掌声欢迎。", "请用最短的几句话，把祝福送给新人，也送给现场来宾。（递话筒）", "谢谢父母的祝福，掌声送上！"], "sec12": ["接下来邀请新人及双方父母共同举杯，向各位来宾致意。", "也请现场朋友们举杯，祝福他们从此相伴相爱。（停顿）", "干杯！请定格三秒，我们留一张全家幸福合影。"], "sec13": ["接下来是送手捧花的环节，邀请想接祝福的朋友来到【指定区域】。（停顿）", "提醒大家注意安全，不推不挤，把快乐留在镜头里。（停顿）", "我们一起倒数：3、2、1——祝福送出！掌声！"], "sec14": ["接下来我们进行全场大合影，请大家把目光看向摄影师的镜头。（停顿）", "微笑准备好——请定格三秒！1、2、3！（停顿）", "再来一张！谢谢大家，掌声送上！"], "sec15": ["各位来宾，感谢今天的到来与见证。", "愿【新郎】与【新娘】从此相伴相爱，把日子过成彼此的依靠。（停顿）", "掌声送新人退场——婚礼仪式圆满礼成！"]}</script>
<script type="application/json" id="sectionsMeta">[{"id": "sec1", "name": "暖场", "tag": "把人坐稳"}, {"id": "sec2", "name": "主持人开场", "tag": "立场开门"}, {"id": "sec3", "name": "新郎入场", "tag": "第一位主角"}, {"id": "sec4", "name": "新娘入场", "tag": "主角登场"}, {"id": "sec5", "name": "迎接交接仪式", "tag": "牵手交接"}, {"id": "sec6", "name": "共同入场", "tag": "双主角画面"}, {"id": "sec7", "name": "宣誓告白", "tag": "安静承诺"}, {"id": "sec8", "name": "佩戴戒指", "tag": "关键画面"}, {"id": "sec9", "name": "拥抱亲吻", "tag": "情绪落点"}, {"id": "sec10", "name": "证婚人入场发言", "tag": "权威确认"}, {"id": "sec11", "name": "父母入场发言", "tag": "家庭祝福"}, {"id": "sec12", "name": "全家敬酒", "tag": "合家举杯"}, {"id": "sec13", "name": "送手捧花", "tag": "互动高潮"}, {"id": "sec14", "name": "全场大合影", "tag": "最大画面"}, {"id": "sec15", "name": "新人退场礼成", "tag": "体面收口"}]</script>
<script>

(() => {
  // 沿用旧 key，避免你之前录入的档期/台词丢失
  const LS_KEY = "host_handbook_major_upgrade_v1";
  const defaultState = { checks: {}, scripts: {}, bookings: {}, theme: "cream", lastExport: null };
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const h = (s)=> String(s??"")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/\'/g,"&#39;");
  const clone = (o) => JSON.parse(JSON.stringify(o));
  const defaults = JSON.parse($("#defaultScripts").textContent || "{}");
  const secMeta = JSON.parse($("#sectionsMeta").textContent || "[]");

  const pad2 = (n) => String(n).padStart(2,"0");
  const todayISO = () => {
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  };
  const ymKey = (iso) => (iso||"").slice(0,7);
  const parseISO = (iso) => {
    const [y,m,d] = (iso||"").split("-").map(Number);
    if (!y||!m||!d) return null;
    return new Date(y, m-1, d);
  };

  const load = () => {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return clone(defaultState);
      const obj = JSON.parse(raw) || {};
      const st = Object.assign(clone(defaultState), obj);
      if (st.scripts && typeof st.scripts !== "object") st.scripts = {};
      if (st.bookings && typeof st.bookings !== "object") st.bookings = {};
      if (st.checks && typeof st.checks !== "object") st.checks = {};
      if (!Array.isArray(st.socialIdeas)) st.socialIdeas = [];
      if (!st.theme) st.theme = "cream";
      return st;
    } catch (e) {
      return clone(defaultState);
    }
  };
  const save = (st) => localStorage.setItem(LS_KEY, JSON.stringify(st));
  let state = load();

  function toast(msg) {
    const t = document.createElement("div");
    t.textContent = msg;
    t.style.position = "fixed";
    t.style.right = "18px";
    t.style.bottom = "18px";
    t.style.padding = "10px 12px";
    t.style.border = "1px solid rgba(127,127,160,.25)";
    t.style.background = "rgba(255,255,255,.92)";
    t.style.color = "#1b1d2a";
    t.style.borderRadius = "16px";
    t.style.boxShadow = "0 16px 40px rgba(20,20,40,.16)";
    t.style.zIndex = "99999";
    t.style.fontSize = "12px";
    document.body.appendChild(t);
    setTimeout(() => { t.style.opacity = "0"; t.style.transition = "opacity .2s ease"; }, 900);
    setTimeout(() => { t.remove(); }, 1200);
  }

  // Theme switch
  function applyTheme(theme) {
    const t = (theme === "neon") ? "neon" : "cream";
    document.documentElement.setAttribute("data-theme", t);
    $("#themeCream").classList.toggle("active", t==="cream");
    $("#themeNeon").classList.toggle("active", t==="neon");
    state.theme = t;
    save(state);
    try{ syncHostSocialTheme(); }catch(e){}
  
    try{ const f = document.getElementById("hostHandbookFrame"); f && f.contentWindow && f.contentWindow.postMessage({type:"__theme_sync__"}, "*"); }catch(e){}
}
  $("#themeCream").addEventListener("click", ()=> applyTheme("cream"));
  $("#themeNeon").addEventListener("click", ()=> applyTheme("neon"));
  applyTheme(state.theme || "cream");
  try{ syncHostSocialTheme(); }catch(e){}

  // Tabs
    // Handbook: scripts editor
  function isValidLines(x) {
    return Array.isArray(x) && x.every(v => typeof v === "string");
  }

  function getLines(secId) {
    const user = state.scripts && state.scripts[secId];
    if (isValidLines(user) && user.length) return user;
    const def = defaults[secId];
    if (isValidLines(def) && def.length) return def;
    return ["（默认台词加载失败，可点“恢复默认”或刷新页面）"];
  }

  function setButtons(secId, mode) {
    const tools = document.querySelector(`.script-tools[data-tools-for="${secId}"]`);
    if (!tools) return;
    const edit = tools.querySelector('[data-action="edit"]');
    const saveBtn = tools.querySelector('[data-action="save"]');
    const cancel = tools.querySelector('[data-action="cancel"]');
    const add = tools.querySelector('[data-action="add"]');
    const reset = tools.querySelector('[data-action="reset"]');
    if (mode==="edit") {
      edit.style.display="none"; saveBtn.style.display=""; cancel.style.display=""; add.style.display=""; reset.style.display="none";
    } else {
      edit.style.display=""; saveBtn.style.display="none"; cancel.style.display="none"; add.style.display="none"; reset.style.display="";
    }
  }

  function renderScript(secId) {
    const box = document.querySelector(`.scriptbox[data-script-id="${secId}"]`);
    if (!box) return;
    box.innerHTML = "";
    box.classList.remove("edit-mode");
    const lines = getLines(secId);
    (lines.length ? lines : [""]).forEach(t=> {
      const row = document.createElement("div");
      row.className = "script-line";
      const text = document.createElement("div");
      text.className = "script-text";
      text.textContent = t ?? "";
      text.setAttribute("contenteditable","false");
      const del = document.createElement("button");
      del.className = "delbtn";
      del.type="button";
      del.title="删除这一句";
      del.textContent="✕";
      del.addEventListener("click", ()=> row.remove());
      row.appendChild(text); row.appendChild(del);
      box.appendChild(row);
    });
    setButtons(secId,"view");
  }

  function collectLinesFromBox(box) {
    const lines = [];
    box.querySelectorAll(".script-line .script-text").forEach(t=> {
      lines.push((t.textContent||"").replace(/\s+$/g,""));
    });
    while (lines.length && lines[lines.length-1].trim()==="") lines.pop();
    if (!lines.length) lines.push("");
    return lines;
  }

  function cancelEdit(secId) { renderScript(secId); toast("已取消编辑"); }

  function enterEdit(secId) {
    $$(".scriptbox.edit-mode").forEach(b=> {
      const id = b.getAttribute("data-script-id");
      if (id && id!==secId) cancelEdit(id);
    });
    const box = document.querySelector(`.scriptbox[data-script-id="${secId}"]`);
    if (!box) return;
    box.classList.add("edit-mode");
    box.querySelectorAll(".script-line").forEach(row=> {
      row.classList.add("editing");
      const t = row.querySelector(".script-text");
      t.setAttribute("contenteditable","true");
      t.spellcheck = false;
    });
    setButtons(secId,"edit");
    const first = box.querySelector(".script-text"); if (first) first.focus();
  }

  function saveEdit(secId) {
    const box = document.querySelector(`.scriptbox[data-script-id="${secId}"]`);
    if (!box) return;
    const lines = collectLinesFromBox(box);
    state.scripts = state.scripts || {};
    state.scripts[secId] = lines;
    save(state);
    renderScript(secId);
    toast("已保存通用台词 ✅");
  }

  function addLine(secId) {
    const box = document.querySelector(`.scriptbox[data-script-id="${secId}"]`);
    if (!box) return;
    const row = document.createElement("div");
    row.className = "script-line editing";
    const text = document.createElement("div");
    text.className="script-text";
    text.textContent="";
    text.setAttribute("contenteditable","true");
    text.spellcheck=false;
    const del = document.createElement("button");
    del.className="delbtn"; del.type="button"; del.title="删除这一句"; del.textContent="✕";
    del.addEventListener("click", ()=> row.remove());
    row.appendChild(text); row.appendChild(del);
    box.appendChild(row);
    box.classList.add("edit-mode");
    setButtons(secId,"edit");
    text.focus();
  }

  function resetScript(secId) {
    /* no confirm */
    if (state.scripts && state.scripts[secId]) delete state.scripts[secId];
    save(state);
    renderScript(secId);
    toast("已恢复默认 ✅");
  }

  function bindScriptToolbars() {
    $$(".script-tools").forEach(tb=> {
      const secId = tb.getAttribute("data-tools-for");
      tb.addEventListener("click", (e)=> {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;
        const action = btn.getAttribute("data-action");
        if (action==="edit") return enterEdit(secId);
        if (action==="save") return saveEdit(secId);
        if (action==="cancel") return cancelEdit(secId);
        if (action==="add") return addLine(secId);
        if (action==="reset") return resetScript(secId);
      });
    });
  }

  function initScripts() {
    $$("div.scriptbox[data-script-id]").forEach(box=> renderScript(box.getAttribute("data-script-id")));
    bindScriptToolbars();
  }

  // progress + nav + search
  function applyChecks() {
    $$("input[data-check]").forEach(cb=> {
      if (state.checks[cb.id] != null) cb.checked = !!state.checks[cb.id];
    });
  }
  function updateProgress() {
    const cbs = $$("input[data-check]");
    const total = cbs.length;
    const done = cbs.filter(x=>x.checked).length;
    $("#progText").textContent = `${done} / ${total}`;
    $("#progBar").style.width = (total ? Math.round(done/total*100) : 0) + "%";
  }
  function bindChecks() {
    $$("input[data-check]").forEach(cb=> {
      cb.addEventListener("change", ()=> {
        state.checks[cb.id]=cb.checked; save(state); updateProgress();
      });
    });
  }
  function bindNavActive() {
    const links = $$("#nav a");
    const map = new Map(links.map(a=>[a.dataset.id, a]));
    const secs = $$("[data-sec]");
    const io = new IntersectionObserver((entries)=> {
      entries.forEach(en=> {
        if (en.isIntersecting) {
          links.forEach(a=>a.classList.remove("active"));
          map.get(en.target.id)?.classList.add("active");
        }
      });
    }, { threshold: 0.25 });
    secs.forEach(s=>io.observe(s));
  }
  function bindSearch() {
    const input = $("#searchInput");
    const btnClear = $("#btnClear");
    const cards = $$("#cards .card");
    const doSearch = ()=> {
      const kw = input.value.trim().toLowerCase();
      if (!kw) { cards.forEach(c=>c.style.display=""); return; }
      cards.forEach(c=> {
        c.style.display = c.innerText.toLowerCase().includes(kw) ? "" : "none";
      });
    };
    input.addEventListener("input", doSearch);
    btnClear.addEventListener("click", ()=> { input.value=""; doSearch(); input.focus(); });
  }

  // export/import/reset/print
  function download(name, text) {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([text], { type: "application/json" }));
    a.download = name;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }
  $("#btnExport").addEventListener("click", ()=> {
    const payload = clone(state);
    payload.lastExport = new Date().toISOString();
    download("主持人学习手册_v1.1_导出.json", JSON.stringify(payload, null, 2));
    toast("已导出 ✅");
  });
  $("#btnImport").addEventListener("click", ()=> {
    const input = document.createElement("input");
    input.type="file"; input.accept="application/json";
    input.onchange = async ()=> {
      const file = input.files && input.files[0];
      if (!file) return;
      const txt = await file.text();
      try {
        const obj = JSON.parse(txt);
        state = Object.assign(clone(defaultState), obj || {});
        save(state);
        location.reload();
      } catch(e) {
        alert("导入失败：文件不是正确的JSON。");
      }
    };
    input.click();
  });
  $("#btnReset").addEventListener("click", ()=> {
    /* no confirm */
    localStorage.removeItem(LS_KEY);
    location.reload();
  });
  $("#btnPrint").addEventListener("click", ()=> window.print());

  // Schedule
  const weekNames = ["一","二","三","四","五","六","日"];
  const calHead = $("#calHead");
  const calBody = $("#calBody");
  const calMonthTitle = $("#calMonthTitle");
  const listWrap = $("#listWrap");
  const listSearch = $("#listSearch");
  const btnClearFilter = $("#btnClearFilter");

  const statMonthCount = $("#statMonthCount");
  const statMonthLabel = $("#statMonthLabel");
  const statDayCount = $("#statDayCount");
  const statNext = $("#statNext");
  const statNextSub = $("#statNextSub");
  const orderDays = $("#orderDays");

  let cursor = (()=> {
    const d = new Date();
    return new Date(d.getFullYear(), d.getMonth(), 1);
  })();
  let dayFilter = "all";

  function bookingList() {
    const b = state.bookings || {};
    return Object.values(b).sort((a,b)=> (a.date||"").localeCompare(b.date||"") || (a.time||"").localeCompare(b.time||""));
  }
  function bookingsInMonth(ym) {
    return bookingList().filter(b=> ymKey(b.date||"") === ym);
  }
  function bookingsByDate(list) {
    const map = new Map();
    list.forEach(x=> {
      const k = x.date;
      if (!k) return;
      if (!map.has(k)) map.set(k, []);
      map.get(k).push(x);
    });
    return map;
  }

  function renderMonthStats() {
    const ym = `${cursor.getFullYear()}-${pad2(cursor.getMonth()+1)}`;
    const list = bookingsInMonth(ym);
    const byDate = bookingsByDate(list);

    statMonthCount.textContent = list.length;
    statMonthLabel.textContent = ym;
    statDayCount.textContent = byDate.size;

    const today = parseISO(todayISO());
    const future = bookingList()
      .filter(b=> b.date && parseISO(b.date))
      .sort((a,b)=> (a.date||"").localeCompare(b.date||"") || (a.time||"").localeCompare(b.time||""));
    const next = future.find(b=> {
      const d = parseISO(b.date);
      if (!d) return false;
      return d.getTime() >= today.getTime();
    });
    if (next) {
      statNext.textContent = (next.date||"") + (next.time ? " " + next.time : "");
      statNextSub.textContent = (next.clientName||"未命名客户") + (next.weddingHotel ? " · " + next.weddingHotel : "");
    } else {
      statNext.textContent = "—";
      statNextSub.textContent = "暂无未来档期";
    }

    orderDays.innerHTML = "";
    const allPill = document.createElement("button");
    allPill.className = "daypill all" + (dayFilter==="all" ? " active" : "");
    allPill.textContent = "全部";
    allPill.addEventListener("click", ()=> {
      dayFilter = "all";
      renderList();
      renderMonthStats();
    });
    orderDays.appendChild(allPill);

    const dates = Array.from(byDate.keys()).sort();
    dates.forEach(d=> {
      const cnt = byDate.get(d).length;
      const pill = document.createElement("button");
      pill.className = "daypill" + (dayFilter===d ? " active" : "");
      pill.textContent = `${d.slice(5)} · ${cnt}场`;
      pill.addEventListener("click", ()=> {
        dayFilter = d;
        renderList();
        renderMonthStats();
      });
      orderDays.appendChild(pill);
    });
  }

  function renderCalendar() {
    if (!calHead || !calBody) return;
    calHead.innerHTML = weekNames.map(w=>`<div style="padding:0 6px">${w}</div>`).join("");

    const y = cursor.getFullYear();
    const m = cursor.getMonth();
    const ym = `${y}-${pad2(m+1)}`;
    calMonthTitle.textContent = ym;

    const first = new Date(y, m, 1);
    const last = new Date(y, m+1, 0);
    const firstDay = (first.getDay() + 6) % 7;
    const daysInMonth = last.getDate();
    const prevLast = new Date(y, m, 0).getDate();

    const monthBookings = bookingsInMonth(ym);
    const bmap = bookingsByDate(monthBookings);
    const today = todayISO();

    calBody.innerHTML = "";
    const totalCells = 42;

    for (let i=0; i<totalCells; i++) {
      const cell = document.createElement("div");
      cell.className = "day";
      let dayNum, cellMonth = m, muted=false;

      if (i < firstDay) {
        dayNum = prevLast - (firstDay - 1 - i);
        muted=true; cellMonth = m-1;
      } else if (i >= firstDay + daysInMonth) {
        dayNum = i - (firstDay + daysInMonth) + 1;
        muted=true; cellMonth = m+1;
      } else {
        dayNum = i - firstDay + 1;
      }

      const dateObj = new Date(y, cellMonth, dayNum);
      const iso = `${dateObj.getFullYear()}-${pad2(dateObj.getMonth()+1)}-${pad2(dateObj.getDate())}`;

      if (muted) cell.classList.add("muted");
      if (iso === today) cell.classList.add("today");

      const events = bmap.get(iso) || [];
      if (events.length === 1) cell.classList.add("has1");
      if (events.length === 2) cell.classList.add("has2");
      if (events.length >= 3) cell.classList.add("has3");

      cell.innerHTML = `
        <div class="dnum">${dayNum}</div>
        <div class="events"></div>
        ${events.length ? `<div class="badge">${events.length}场</div>` : ""}
      `;

      const evWrap = cell.querySelector(".events");
      events.slice(0,3).forEach(ev=> {
        const el = document.createElement("div");
        el.className = "ev";
        el.innerHTML = `<div class="t">${(ev.time? ev.time+" " : "") + (ev.clientName||"未命名客户")}</div>
                        <div class="s">${ev.weddingHotel||""}</div>`;
        el.addEventListener("click", (e)=> {
          e.stopPropagation();
          openBooking(ev.id);
        });
        evWrap.appendChild(el);
      });

      cell.addEventListener("click", ()=> {
        const inThisMonth = ymKey(iso) === ym;
        if (inThisMonth && events.length) {
          dayFilter = iso;
          renderList();
          renderMonthStats();
          toast("已筛选该日档期");
        } else {
          openBooking(null, { presetDate: iso });
        }
      });

      calBody.appendChild(cell);
    }
  }

  function renderList() {
    const ym = `${cursor.getFullYear()}-${pad2(cursor.getMonth()+1)}`;
    const q = (listSearch.value || "").trim().toLowerCase();
    const list = bookingsInMonth(ym).filter(b=> {
      const hay = `${b.date||""} ${b.time||""} ${b.clientName||""} ${b.phone||""} ${b.weddingHotel||""} ${b.hall||""} ${b.notes||""} ${b.groomName||""} ${b.brideName||""}`.toLowerCase();
      const matchQ = !q || hay.includes(q);
      const matchD = (dayFilter==="all") || (b.date === dayFilter);
      return matchQ && matchD;
    });

    if (!list.length) {
      listWrap.innerHTML = `<div class="muted-small">本月暂无符合筛选的档期。你可以点“＋新增档期”添加。</div>`;
      return;
    }

    listWrap.innerHTML = "";
    list.forEach(b=> {
      const el = document.createElement("div");
      el.className = "item";
      const linked = (b.linkedSections || []).map(id=> secMeta.find(s=>s.id===id)?.name).filter(Boolean);
      const chips = linked.slice(0,6).map(x=>`<span class="chip">${x}</span>`).join("");
      el.innerHTML = `
        <div class="top">
          <div class="title">${b.date || ""}${b.time? " "+b.time : ""} · ${b.clientName||"未命名客户"}</div>
          <div class="meta">${b.weddingHotel||"未填写酒店"}${b.hall? " / "+b.hall : ""}</div>
        </div>
        <div class="meta" style="margin-top:6px">联系方式：${b.phone||"未填写"} · 新郎/新娘：${(b.groomName||"—")} / ${(b.brideName||"—")}</div>
        <div class="chips">${chips || '<span class="chip">未关联环节</span>'}</div>
      `;
      el.addEventListener("click", ()=> openBooking(b.id));
      listWrap.appendChild(el);
    });
  }

  listSearch.addEventListener("input", renderList);
  btnClearFilter.addEventListener("click", ()=> {
    listSearch.value = "";
    dayFilter = "all";
    renderList();
    renderMonthStats();
    toast("已清空筛选");
  });

  $("#btnToday").addEventListener("click", ()=> {
    const d = new Date();
    cursor = new Date(d.getFullYear(), d.getMonth(), 1);
    dayFilter = "all";
    renderCalendar(); renderList(); renderMonthStats();
  });
  $("#btnPrevMonth").addEventListener("click", ()=> {
    cursor = new Date(cursor.getFullYear(), cursor.getMonth()-1, 1);
    dayFilter = "all";
    renderCalendar(); renderList(); renderMonthStats();
  });
  $("#btnNextMonth").addEventListener("click", ()=> {
    cursor = new Date(cursor.getFullYear(), cursor.getMonth()+1, 1);
    dayFilter = "all";
    renderCalendar(); renderList(); renderMonthStats();
  });
  $("#btnAddBooking").addEventListener("click", ()=> openBooking(null, { presetDate: todayISO() }));

  // Booking modal + per-client overrides
  const modal = $("#bookingModal");
  const modalTitle = $("#modalTitle");
  const modalSub = $("#modalSub");

  const f = {
    date: $("#f_date"),
    time: $("#f_time"),
    clientName: $("#f_clientName"),
    phone: $("#f_phone"),
    groom: $("#f_groom"),
    bride: $("#f_bride"),
    hotel: $("#f_hotel"),
    hall: $("#f_hall"),
    serviceFee: $("#f_serviceFee"),
    deposit: $("#f_deposit"),
    balance: $("#f_balance"),
    isCollab: $("#f_isCollab"),
    notes: $("#f_notes"),
  };

  const sectionChips = $("#sectionChips");
  const clientScriptsWrap = $("#clientScriptsWrap");
  clientScriptsWrap && clientScriptsWrap.addEventListener("input", ()=> markDirty());

  const btnDeleteBooking = $("#btnDeleteBooking");
  const btnSaveBooking = $("#btnSaveBooking");
  const btnAllSections = $("#btnAllSections");
  const btnClearSections = $("#btnClearSections");
  const btnGenPreview = $("#btnGenPreview");

  // Timeline refs
  const timelineList = $("#timelineList");
  const btnGenTimeline = $("#btnGenTimeline");
  const btnAddTimelineRow = $("#btnAddTimelineRow");
  const btnClearTimeline = $("#btnClearTimeline");

  function timeToMin(t){
    const m = /^(\d{1,2}):(\d{2})$/.exec(t||"");
    if (!m) return null;
    return parseInt(m[1],10)*60 + parseInt(m[2],10);
  }
  function minToTime(n){
    n = Math.max(0, Math.min(24*60-1, n|0));
    const h = String(Math.floor(n/60)).padStart(2,"0");
    const m = String(n%60).padStart(2,"0");
    return `${h}:${m}`;
  }

  function buildDefaultTimeline(startTimeStr){
    const baseStart = timeToMin(startTimeStr) ?? (18*60);
    const map = {
      "暖场": -10,
      "主持人开场": 0,
      "新郎入场": 2,
      "新娘入场": 5,
      "迎接交接仪式": 8,
      "共同入场": 11,
      "宣誓告白": 15,
      "佩戴戒指": 20,
      "拥抱亲吻": 23,
      "证婚人入场发言": 26,
      "父母入场发言": 32,
      "全家敬酒": 38,
      "送手捧花": 45,
      "全场大合影": 52,
      "新人退场礼成": 58
    };
    const items = secMeta.map(s=>{
      const off = (map[s.name]!==undefined) ? map[s.name] : 0;
      return { time: minToTime(baseStart + off), name: s.name, note: "" };
    });
    items.sort((a,b)=> (timeToMin(a.time)||0)-(timeToMin(b.time)||0));
    return items;
  }

  function ensureTimeline(){
    draft.timeline = draft.timeline || [];
    if (!draft.timeline.length){
      draft.timeline = buildDefaultTimeline(draft.time||"");
    }
  }

  function renderTimeline(){
    if (!timelineList) return;
    ensureTimeline();
    draft.timeline.sort((a,b)=> (timeToMin(a.time)||0)-(timeToMin(b.time)||0));
    timelineList.innerHTML = "";
    draft.timeline.forEach((it, idx)=>{
      const row = document.createElement("div");
      row.className = "timelineRow";
      row.draggable = true;
      row.dataset.idx = String(idx);

      row.innerHTML = `
        <input type="time" class="input" value="${h(it.time||"")}" data-t="time"/>
        <div class="tname" contenteditable="true" data-t="name" spellcheck="false">${h(it.name||"")}</div>
        <input class="tnote" value="${h(it.note||"")}" data-t="note" placeholder="例如：音乐点位/走位/镜头提示"/>
        <div class="tact">
          <span class="drag" title="拖动排序">⇅ 拖动</span>
          <button class="sbtn danger" data-act="del">删</button>
        </div>
      `;

      row.querySelectorAll("[data-t]").forEach(el=>{
        const k = el.getAttribute("data-t");
        if (k==="name"){
          el.addEventListener("input", ()=>{ it.name = el.innerText.trim(); markDirty(); });
          el.addEventListener("blur", ()=>{ it.name = el.innerText.trim(); markDirty(); });
        } else {
          el.addEventListener("input", ()=>{ it[k] = el.value; markDirty(); });
        }
      });

      row.querySelector('[data-act="del"]').addEventListener("click", ()=>{
        draft.timeline.splice(idx,1);
        markDirty();
        renderTimeline();
        toast("已删除节点 ✅");
      });

      row.addEventListener("dragstart", (e)=>{
        e.dataTransfer.setData("text/plain", row.dataset.idx);
        row.classList.add("dragging");
      });
      row.addEventListener("dragend", ()=>{
        row.classList.remove("dragging");
      });

      timelineList.appendChild(row);
    });

    timelineList.querySelectorAll(".timelineRow").forEach(r=>{
      r.addEventListener("dragover", (e)=>{
        e.preventDefault();
        const dragging = timelineList.querySelector(".timelineRow.dragging");
        if (!dragging || dragging===r) return;
        const rect = r.getBoundingClientRect();
        const after = (e.clientY - rect.top) > rect.height/2;
        timelineList.insertBefore(dragging, after ? r.nextSibling : r);
      });
      r.addEventListener("drop", (e)=>{
        e.preventDefault();
        const newOrder = [];
        timelineList.querySelectorAll(".timelineRow").forEach(el=>{
          const oldIdx = parseInt(el.dataset.idx,10);
          newOrder.push(draft.timeline[oldIdx]);
        });
        draft.timeline = newOrder.filter(Boolean);
        markDirty();
        renderTimeline();
        toast("已排序 ✅");
      });
    });
  }

  btnGenTimeline?.addEventListener("click", ()=>{
    draft.timeline = buildDefaultTimeline(draft.time||"");
    markDirty();
    renderTimeline();
    toast("已生成基础时间轴 ✅");
  });

  btnAddTimelineRow?.addEventListener("click", ()=>{
    draft.timeline = draft.timeline || [];
    draft.timeline.push({ time: draft.time || "18:00", name: "新增环节（点我改名）", note: "" });
    markDirty();
    renderTimeline();
  });

  btnClearTimeline?.addEventListener("click", ()=>{
    draft.timeline = [];
    markDirty();
    renderTimeline();
    toast("已清空时间轴 ✅");
  });



  let editingId = null;
  let draft = null;

  function uid() {
    return "b_" + Math.random().toString(36).slice(2,9) + "_" + Date.now().toString(36);
  }

  
  const savePrompt = $("#savePrompt");
  const promptSave = $("#promptSave");
  const promptDiscard = $("#promptDiscard");
  const promptCancel = $("#promptCancel");

  let modalDirty = false;
  function markDirty(){ modalDirty = true; }

  function openModal() {
    modal.classList.add("show");
    modal.setAttribute("aria-hidden","false");
    modalDirty = false;
    hidePrompt();
  }

  function hardCloseModal() {
    modal.classList.remove("show");
    modal.setAttribute("aria-hidden","true");
    editingId = null;
    draft = null;
    modalDirty = false;
    hidePrompt();
  }

  function showPrompt(){
    if (!savePrompt) return;
    savePrompt.classList.add("show");
    savePrompt.setAttribute("aria-hidden","false");
  }
  function hidePrompt(){
    if (!savePrompt) return;
    savePrompt.classList.remove("show");
    savePrompt.setAttribute("aria-hidden","true");
  }

  function requestCloseModal(){
    if (!modalDirty) return hardCloseModal();
    showPrompt();
  }

  promptCancel?.addEventListener("click", ()=> hidePrompt());
  promptDiscard?.addEventListener("click", ()=> { hidePrompt(); hardCloseModal(); });
  promptSave?.addEventListener("click", ()=> { hidePrompt(); commitDraftAndClose(); });

modal.addEventListener("click", (e)=> {
    if (e.target && e.target.getAttribute("data-close")==="1") requestCloseModal();
  });
  document.addEventListener("keydown", (e)=> {
    if (e.key==="Escape" && modal.classList.contains("show")) requestCloseModal();
  });

  function makeEmptyBooking(presetDate) {
    const iso = presetDate || todayISO();
    return {
      id: uid(),
      date: iso,
      time: "",
      clientName: "",
      phone: "",
      groomName: "",
      brideName: "",
      weddingHotel: "",
      hall: "",
      serviceFee: "",
      deposit: "",
      balance: "",
      isCollab: false,
      notes: "",
      linkedSections: [],
      timeline: [],
      overrides: {},
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    };
  }

  function fillFormFromDraft() {
    f.date.value = draft.date || "";
    f.time.value = draft.time || "";
    f.clientName.value = draft.clientName || "";
    f.phone.value = draft.phone || "";
    f.groom.value = draft.groomName || "";
    f.bride.value = draft.brideName || "";
    f.hotel.value = draft.weddingHotel || "";
    f.hall.value = draft.hall || "";
    f.serviceFee.value = (draft.serviceFee!==undefined && draft.serviceFee!==null && draft.serviceFee!=="") ? String(draft.serviceFee) : "";
    f.deposit.value = (draft.deposit!==undefined && draft.deposit!==null && draft.deposit!=="") ? String(draft.deposit) : "";
    f.balance.value = (draft.balance!==undefined && draft.balance!==null && draft.balance!=="") ? String(draft.balance) : "";
    f.isCollab.checked = !!draft.isCollab;
    f.notes.value = draft.notes || "";
  }

  function readFormToDraft() {
    draft.date = f.date.value || "";
    draft.time = f.time.value || "";
    draft.clientName = f.clientName.value || "";
    draft.phone = f.phone.value || "";
    draft.groomName = f.groom.value || "";
    draft.brideName = f.bride.value || "";
    draft.weddingHotel = f.hotel.value || "";
    draft.hall = f.hall.value || "";
    const _num = (v)=> {
      const n = parseFloat(String(v||"").replace(/,/g,"").trim());
      return Number.isFinite(n) ? n : "";
    };
    draft.serviceFee = _num(f.serviceFee.value);
    draft.deposit = _num(f.deposit.value);
    draft.balance = _num(f.balance.value);
    draft.isCollab = !!f.isCollab.checked;
    draft.notes = f.notes.value || "";
    draft.updatedAt = new Date().toISOString();
  }

  // mark dirty on inputs
  Object.values(f).forEach(el=> {
    if (!el) return;
    el.addEventListener("input", ()=>{ readFormToDraft(); markDirty(); });
    el.addEventListener("change", ()=>{ readFormToDraft(); markDirty(); });
  });

  function renderSectionChips() {
    sectionChips.innerHTML = "";
    secMeta.forEach(s=> {
      const chip = document.createElement("button");
      chip.type="button";
      chip.className = "schip" + (draft.linkedSections.includes(s.id) ? " on" : "");
      chip.textContent = s.name;
      chip.addEventListener("click", ()=> {
        const on = draft.linkedSections.includes(s.id);
        if (on) draft.linkedSections = draft.linkedSections.filter(x=>x!==s.id);
        else draft.linkedSections.push(s.id);
        renderSectionChips();
        renderClientScripts();
      });
      sectionChips.appendChild(chip);
    });
  }

  btnAllSections.addEventListener("click", ()=> {
    draft.linkedSections = secMeta.map(s=>s.id);
    renderSectionChips(); renderClientScripts();
  });
  btnClearSections.addEventListener("click", ()=> {
    draft.linkedSections = [];
    renderSectionChips(); renderClientScripts();
  });

  function getBaseLines(secId) {
    const user = state.scripts && state.scripts[secId];
    if (isValidLines(user) && user.length) return user;
    const def = defaults[secId];
    if (isValidLines(def) && def.length) return def;
    return [""];
  }
  function getClientLines(secId) {
    if (draft.overrides && isValidLines(draft.overrides[secId]) && draft.overrides[secId].length) return draft.overrides[secId];
    return getBaseLines(secId);
  }
  function placeholderReplace(line) {
    const map = {
      "【新郎】": draft.groomName || "【新郎】",
      "【新郎名字】": draft.groomName || "【新郎名字】",
      "【新娘】": draft.brideName || "【新娘】",
      "【新娘名字】": draft.brideName || "【新娘名字】",
      "【地点】": draft.weddingHotel || "【地点】",
      "【酒店】": draft.weddingHotel || "【酒店】",
      "【婚宴酒店】": draft.weddingHotel || "【婚宴酒店】",
      "【宴会厅】": draft.hall || "【宴会厅】",
    };
    let out = line;
    Object.keys(map).forEach(k=> { out = out.split(k).join(map[k]); });
    return out;
  }

  function setClientButtons(secId, mode) {
    const tools = clientScriptsWrap.querySelector(`.cs-tools[data-cs-tools="${secId}"]`);
    if (!tools) return;
    const edit = tools.querySelector('[data-action="edit"]');
    const saveBtn = tools.querySelector('[data-action="save"]');
    const cancel = tools.querySelector('[data-action="cancel"]');
    const add = tools.querySelector('[data-action="add"]');
    const reset = tools.querySelector('[data-action="reset"]');
    if (mode==="edit") {
      edit.style.display="none"; saveBtn.style.display=""; cancel.style.display=""; add.style.display=""; reset.style.display="none";
    } else {
      edit.style.display=""; saveBtn.style.display="none"; cancel.style.display="none"; add.style.display="none"; reset.style.display="";
    }
  }

  function renderClientScriptBox(secId) {
    const box = clientScriptsWrap.querySelector(`.scriptbox[data-cs-script="${secId}"]`);
    if (!box) return;
    box.innerHTML = "";
    box.classList.remove("edit-mode");
    const lines = getClientLines(secId);
    (lines.length ? lines : [""]).forEach(t=> {
      const row = document.createElement("div");
      row.className="script-line";
      const text = document.createElement("div");
      text.className="script-text";
      text.textContent = t ?? "";
      text.setAttribute("contenteditable","false");
      const del = document.createElement("button");
      del.className="delbtn"; del.type="button"; del.title="删除这一句"; del.textContent="✕";
      del.addEventListener("click", ()=> row.remove());
      row.appendChild(text); row.appendChild(del);
      box.appendChild(row);
    });
    setClientButtons(secId,"view");
  }

  function enterClientEdit(secId) {
    $$(".cs-block .scriptbox.edit-mode", clientScriptsWrap).forEach(b=> {
      const id = b.getAttribute("data-cs-script");
      if (id && id!==secId) renderClientScriptBox(id);
    });

    const box = clientScriptsWrap.querySelector(`.scriptbox[data-cs-script="${secId}"]`);
    if (!box) return;
    box.classList.add("edit-mode");
    box.querySelectorAll(".script-line").forEach(row=> {
      row.classList.add("editing");
      const t = row.querySelector(".script-text");
      t.setAttribute("contenteditable","true");
      t.spellcheck=false;
    });
    setClientButtons(secId,"edit");
    const first = box.querySelector(".script-text"); if (first) first.focus();
  }

  function saveClientEdit(secId) {
    const box = clientScriptsWrap.querySelector(`.scriptbox[data-cs-script="${secId}"]`);
    if (!box) return;
    const lines = collectLinesFromBox(box);
    draft.overrides = draft.overrides || {};
    const base = getBaseLines(secId);
    const same = JSON.stringify(lines) === JSON.stringify(base);
    if (same) delete draft.overrides[secId];
    else draft.overrides[secId] = lines;
    renderClientScripts();
    toast("已保存客户专属台词 ✅");
  }

  function addClientLine(secId) {
    const box = clientScriptsWrap.querySelector(`.scriptbox[data-cs-script="${secId}"]`);
    if (!box) return;
    const row = document.createElement("div");
    row.className="script-line editing";
    const text = document.createElement("div");
    text.className="script-text";
    text.textContent="";
    text.setAttribute("contenteditable","true");
    text.spellcheck=false;
    const del = document.createElement("button");
    del.className="delbtn"; del.type="button"; del.title="删除这一句"; del.textContent="✕";
    del.addEventListener("click", ()=> row.remove());
    row.appendChild(text); row.appendChild(del);
    box.appendChild(row);
    box.classList.add("edit-mode");
    setClientButtons(secId,"edit");
    text.focus();
  }

  function resetClient(secId) {
    /* no confirm */
    if (draft.overrides && draft.overrides[secId]) delete draft.overrides[secId];
    renderClientScripts();
    toast("已恢复通用 ✅");
  }

  function bindClientToolbar(block, secId) {
    const tools = block.querySelector(`.cs-tools[data-cs-tools="${secId}"]`);
    tools.addEventListener("click", (e)=> {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      if (action==="edit") return enterClientEdit(secId);
      if (action==="save") return saveClientEdit(secId);
      if (action==="cancel") return renderClientScriptBox(secId);
      if (action==="add") return addClientLine(secId);
      if (action==="reset") return resetClient(secId);
    });
  }

  function renderClientScripts() {
    clientScriptsWrap.innerHTML = "";
    const ids = draft.linkedSections || [];
    if (!ids.length) {
      clientScriptsWrap.innerHTML = `<div class="muted-small">提示：先勾选“关联婚礼环节”，这里才会显示对应环节的专属台词编辑器。</div>`;
      return;
    }
    ids.forEach(secId=> {
      const sec = secMeta.find(s=>s.id===secId);
      const name = sec ? sec.name : secId;
      const hasOverride = !!(draft.overrides && draft.overrides[secId]);
      const block = document.createElement("div");
      block.className="cs-block";
      block.innerHTML = `
        <div class="top">
          <div>
            <div class="name">${name} <span class="tag">${hasOverride ? "客户专属" : "使用通用"}</span></div>
            <div class="mini">只对当前客户生效；你也可以“恢复通用”。</div>
          </div>
          <div class="cs-tools" data-cs-tools="${secId}">
            <button class="sbtn" data-action="edit">编辑</button>
            <button class="sbtn primary" data-action="save" style="display:none">保存</button>
            <button class="sbtn" data-action="cancel" style="display:none">取消</button>
            <button class="sbtn" data-action="add" style="display:none">新增一句</button>
            <button class="sbtn" data-action="pick">插入台词</button>
            <button class="sbtn danger" data-action="reset">${hasOverride ? "恢复通用" : "清空并用通用"}</button>
          </div>
        </div>
        <div class="script scriptbox" data-cs-script="${secId}"></div>
      `;
      clientScriptsWrap.appendChild(block);
      renderClientScriptBox(secId);
      bindClientToolbar(block, secId);
    });
  }

  btnGenPreview.addEventListener("click", ()=> {
    const ids = draft.linkedSections || [];
    if (!ids.length) return toast("先勾选关联环节");
    ids.forEach(secId=> {
      const box = clientScriptsWrap.querySelector(`.scriptbox[data-cs-script="${secId}"]`);
      if (!box) return;
      box.querySelectorAll(".script-text").forEach(el=> {
        el.textContent = placeholderReplace(el.textContent || "");
      });
    });
    toast("已用客户信息预览替换（仅当前界面）");
  });

  function openBooking(id, opts={}) {
    const presetDate = opts.presetDate || null;
    if (id && state.bookings && state.bookings[id]) {
      editingId = id;
      draft = clone(state.bookings[id]);
      modalTitle.textContent="编辑档期";
      modalSub.textContent="你可以更新客户信息、关联环节，并编辑客户专属台词。";
      btnDeleteBooking.style.display="";
    } else {
      editingId = null;
      draft = makeEmptyBooking(presetDate);
      modalTitle.textContent="新增档期";
      modalSub.textContent="填写客户信息，并选择关联环节（可写客户专属台词）。";
      btnDeleteBooking.style.display="none";
    }
    fillFormFromDraft();
    modalDirty = false;
    renderSectionChips();
    renderClientScripts();
    renderTimeline();
    openModal();
  }
  window.openBooking = openBooking;

  btnDeleteBooking.addEventListener("click", ()=> {
    if (!editingId) return;
    if (state.bookings && state.bookings[editingId]) delete state.bookings[editingId];
    save(state);
    hardCloseModal();
    renderCalendar(); renderList(); renderMonthStats();
    toast("已删除 ✅");
  });


  function commitDraft(){
    readFormToDraft();
    ensureTimeline();
    if (!draft.date) { toast("请先选择婚期（日期）"); return false; }
    if (!draft.clientName) draft.clientName = "未命名客户";
    draft.updatedAt = new Date().toISOString();
    state.bookings = state.bookings || {};
    state.bookings[draft.id] = draft;
    save(state);
    modalDirty = false;
    return true;
  }

  function commitDraftAndClose(){
    const ok = commitDraft();
    if (!ok) return;
    hardCloseModal();
    renderCalendar(); renderList(); renderMonthStats();
    toast("已保存档期 ✅");
  }

  btnSaveBooking.addEventListener("click", commitDraftAndClose);

  // (patched)
  // -------------------------
  // Yearly summary (Schedule)
  // -------------------------
  const ysYear = $("#ysYear");
  const btnYsThisYear = $("#btnYsThisYear");
  const ysTotalCount = $("#ysTotalCount");
  const ysTotalIncome = $("#ysTotalIncome");
  const ysCollabCount = $("#ysCollabCount");
  const ysDirectCount = $("#ysDirectCount");
  const ysChartOrders = $("#ysChartOrders");
  const ysChartIncome = $("#ysChartIncome");
  const ysChartMix = $("#ysChartMix");
  const ysHotelList = $("#ysHotelList");
  const ysTable = $("#ysTable");

const ysNotes = $("#ysNotes");
const btnYsAutoNote = $("#btnYsAutoNote");
const btnYsCopyNote = $("#btnYsCopyNote");
const btnYsClearNote = $("#btnYsClearNote");
const YS_NOTES_KEY = "mc_year_summary_notes_v1_";
let _ysAutoNoteText = "";
let _ysNoteTimer = null;

function loadYsNotes(year){
  try { return localStorage.getItem(YS_NOTES_KEY + year) || ""; } catch(e){ return ""; }
}
function saveYsNotes(year, text){
  try { localStorage.setItem(YS_NOTES_KEY + year, text || ""); } catch(e){}
}
function buildAutoYsNote(year, pack){
  const total = pack.total || 0;
  const collab = pack.collab || 0;
  const direct = pack.direct || 0;
  const income = pack.totalIncome || 0;
  const topCnt = pack.topCount || {month:"—", value:0};
  const topInc = pack.topIncome || {month:"—", value:0};
  const hotels = pack.hotels || [];
  const hotelTxt = hotels.length ? hotels.map(h=>`- ${h.name}：${h.c}单`).join("\n") : "-（暂无合作单）";
  const avg = total ? Math.round(income/total) : 0;

  return [
    `【${year} 年度档期总结】`,
    `- 全年单量：${total}（合作${collab} / 直客${direct}）`,
    `- 全年收入（服务费）：${Math.round(income).toLocaleString("zh-CN")} 元`,
    `- 均单价：${avg.toLocaleString("zh-CN")} 元`,
    `- 单量最高：${topCnt.month}月（${topCnt.value}单）`,
    `- 收入最高：${topInc.month}月（${Math.round(topInc.value).toLocaleString("zh-CN")} 元）`,
    ``,
    `【合作酒店 TOP】`,
    hotelTxt,
    ``,
    `【下年度目标（可改）】`,
    `- 目标单量：`,
    `- 目标均单价：`,
    `- 重点合作酒店：`,
    `- 内容曝光/获客动作：`,
  ].join("\n");
}

// notes binding (auto-save by year)
if (ysNotes){
  ysNotes.addEventListener("input", ()=>{
    const y = ysNotes.getAttribute("data-year") || (ysYear?.value || String(new Date().getFullYear()));
    clearTimeout(_ysNoteTimer);
    _ysNoteTimer = setTimeout(()=> saveYsNotes(y, ysNotes.value), 350);
  });
}
btnYsAutoNote?.addEventListener("click", ()=>{
  const y = ysYear?.value || String(new Date().getFullYear());
  if (!ysNotes) return;
  ysNotes.value = _ysAutoNoteText || ysNotes.value;
  ysNotes.setAttribute("data-year", y);
  saveYsNotes(y, ysNotes.value);
  toast("已重生成并保存 ✅");
});
btnYsCopyNote?.addEventListener("click", ()=>{
  if (!ysNotes) return;
  copyText(ysNotes.value || "");
  toast("年度总结已复制 ✅");
});
btnYsClearNote?.addEventListener("click", ()=>{
  const y = ysYear?.value || String(new Date().getFullYear());
  if (!ysNotes) return;
  ysNotes.value = "";
  ysNotes.setAttribute("data-year", y);
  saveYsNotes(y, "");
  toast("已清空并保存");
});

  function _toNum(v){
    const n = parseFloat(String(v||"").replace(/,/g,"").trim());
    return Number.isFinite(n) ? n : 0;
  }
  function escapeHtml(s){
    return String(s??"").replace(/[&<>"']/g, (c)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function _fmtMoney(n){
    const x = Math.round((n||0));
    return x.toLocaleString("zh-CN");
  }
  function _yearsFromBookings(){
    const set = new Set();
    bookingList().forEach(b=>{
      if (b.date && String(b.date).length>=4) set.add(String(b.date).slice(0,4));
    });
    const yNow = String(new Date().getFullYear());
    set.add(yNow);
    return Array.from(set).sort().reverse();
  }
  function ensureYearOptions(){
    if (!ysYear) return;
    const years = _yearsFromBookings();
    const cur = ysYear.value || String(new Date().getFullYear());
    ysYear.innerHTML = years.map(y=>`<option value="${y}">${y} 年</option>`).join("");
    if (years.includes(cur)) ysYear.value = cur;
  }

  function _prepCanvas(c){
    if (!c) return null;
    const dpr = window.devicePixelRatio || 1;
    const rect = c.getBoundingClientRect();
    const cssW = Math.max(10, rect.width);
    const cssH = Math.max(10, rect.height || c.height || 200);
    c.width = Math.round(cssW * dpr);
    c.height = Math.round(cssH * dpr);
    const ctx = c.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,cssW,cssH);
    return {ctx, w: cssW, h: cssH};
  }

  
function _ysTheme(){
    const cs = getComputedStyle(document.documentElement);
    const pick = (k, fb)=> (cs.getPropertyValue(k) || "").trim() || fb;
    return {
      text: pick("--text", "#1b1d2a"),
      muted: pick("--muted", "rgba(27,29,42,.65)"),
      line: pick("--line", "rgba(30,35,60,.12)"),
    };
  }

  function drawBars(canvas, values, opts){
    const pack = _prepCanvas(canvas);
    if (!pack) return;
    const {ctx,w,h} = pack;
    const theme = _ysTheme();

    const padX = 24;
    const padTop = 38;
    const padBottom = 28;
    const baseY = h - padBottom;

    const vals = (values||[]).map(v=> Number(v||0));
    const n = Math.max(1, vals.length);
    const maxV = Math.max(1, ...vals);
    const bw = (w - padX*2) / n;

    const labels = (opts && opts.labels) ? opts.labels : null;
    const fmt = (opts && typeof opts.valueFormatter==="function") ? opts.valueFormatter : (v)=> String(v);

    const hasData = vals.some(v=> v > 0);

    // axis
    ctx.globalAlpha = 1;
    ctx.strokeStyle = theme.line;
    ctx.beginPath(); ctx.moveTo(padX, baseY); ctx.lineTo(w-padX, baseY); ctx.stroke();

    // header (title + legend) — inside chart
    const title = (opts && opts.title) ? String(opts.title) : "";
    const legendLabel = (opts && opts.legendLabel) ? String(opts.legendLabel) : "";
    const legendColor = (opts && opts.color) ? opts.color : "rgba(124,92,255,.75)";
    const perColors = (opts && Array.isArray(opts.colors)) ? opts.colors : null;
    const legendParts = (opts && Array.isArray(opts.legendParts)) ? opts.legendParts : null;

    ctx.font = "12px system-ui, -apple-system, Segoe UI, sans-serif";
    ctx.textAlign = "left";
    if (title){
      ctx.fillStyle = theme.text;
      ctx.fillText(title, 10, 16);
    }

    // legend (single or multi)
    if (legendParts && legendParts.length){
      const box = 10, gap = 6, pad = 10;
      ctx.font = "12px system-ui, -apple-system, Segoe UI, sans-serif";
      const items = legendParts.map(p=>({
        label: String(p.label||""),
        color: p.color || legendColor,
        w: box + gap + ctx.measureText(String(p.label||"")).width + pad
      }));
      const totalW = items.reduce((s,x)=> s+x.w, 0);
      let x = Math.max(padX, w - padX - totalW);
      const y = 16;
      items.forEach(it=>{
        ctx.fillStyle = it.color;
        ctx.fillRect(x, y-10, box, box);
        ctx.fillStyle = theme.text;
        ctx.fillText(it.label, x + box + gap, y);
        x += it.w;
      });
    } else if (legendLabel){
      ctx.textAlign = "left";
      const box = 10, gap = 6;
      const tw = ctx.measureText(legendLabel).width;
      const x = Math.max(padX, w - padX - tw - box - gap);
      const y = 16;
      ctx.fillStyle = legendColor;
      ctx.fillRect(x, y-10, box, box);
      ctx.fillStyle = theme.text;
      ctx.fillText(legendLabel, x + box + gap, y);
    }

    if (!hasData){
      // still show x labels so user knows axis
      if (labels){
        ctx.fillStyle = theme.muted;
        ctx.font = "11px system-ui, -apple-system, Segoe UI, sans-serif";
        ctx.textAlign = "center";
        labels.forEach((lb,i)=>{
          const x = padX + i*bw + bw*0.5;
          ctx.fillText(lb, x, h-8);
        });
      }
      ctx.fillStyle = theme.muted;
      ctx.font = "12px system-ui, -apple-system, Segoe UI, sans-serif";
      ctx.textAlign = "center";
      ctx.fillText("暂无数据", w/2, h/2);
      return;
    }

    vals.forEach((v,i)=>{
      const x = padX + i*bw + bw*0.15;
      const barW = bw*0.7;
      const barH = (v/maxV) * (h - padTop - padBottom - 10);
      const y = baseY - barH;

      // bar
      ctx.fillStyle = perColors ? (perColors[i%perColors.length] || legendColor) : legendColor;
      ctx.fillRect(x, y, barW, barH);

      // value label (number)
      ctx.fillStyle = theme.text;
      ctx.font = "11px system-ui, -apple-system, Segoe UI, sans-serif";
      ctx.textAlign = "center";
      const ty = Math.max(padTop-2, y - 6);
      ctx.fillText(fmt(v), x + barW/2, ty);

      // x label
      if (labels){
        ctx.fillStyle = theme.muted;
        ctx.font = "11px system-ui, -apple-system, Segoe UI, sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(labels[i] ?? "", x + barW/2, h-8);
      }
    });
  }

  // grouped bars: multiple series per month (合作 vs 直客)
  function drawGroupedBars(canvas, series, opts){
    const pack = _prepCanvas(canvas);
    if (!pack) return;
    const {ctx,w,h} = pack;
    const theme = _ysTheme();

    const padX = 24;
    const padTop = 38;
    const padBottom = 28;
    const baseY = h - padBottom;

    const ser = Array.isArray(series) ? series.filter(s=> s && Array.isArray(s.values)) : [];
    const S = Math.max(1, ser.length);
    const N = Math.max(1, ...(ser.map(s=> s.values.length || 0)));

    const labels = (opts && opts.labels) ? opts.labels : Array.from({length:N}, (_,i)=> String(i+1));
    const title = (opts && opts.title) ? String(opts.title) : "";
    const fmt = (opts && typeof opts.valueFormatter==="function") ? opts.valueFormatter : (v)=> String(v);

    const allVals = [];
    ser.forEach(s=> (s.values||[]).forEach(v=> allVals.push(Number(v||0))));
    const hasData = allVals.some(v=> v>0);
    const maxV = Math.max(1, ...allVals);

    // axis
    ctx.strokeStyle = theme.line;
    ctx.beginPath(); ctx.moveTo(padX, baseY); ctx.lineTo(w-padX, baseY); ctx.stroke();

    // title
    if (title){
      ctx.fillStyle = theme.text;
      ctx.font = "12px system-ui, -apple-system, Segoe UI, sans-serif";
      ctx.textAlign = "left";
      ctx.fillText(title, 10, 16);
    }

    // legend (top-right)
    if (ser.length){
      ctx.font = "12px system-ui, -apple-system, Segoe UI, sans-serif";
      const box = 10, gap = 6, pad = 10;
      const items = ser.map(s=>({
        label: String(s.label||""),
        color: s.color || "rgba(124,92,255,.75)",
        w: box + gap + ctx.measureText(String(s.label||"")).width + pad
      }));
      const totalW = items.reduce((a,b)=> a+b.w, 0);
      let x = Math.max(padX, w - padX - totalW);
      const y = 16;
      items.forEach(it=>{
        ctx.fillStyle = it.color;
        ctx.fillRect(x, y-10, box, box);
        ctx.fillStyle = theme.text;
        ctx.fillText(it.label, x + box + gap, y);
        x += it.w;
      });
    }

    const bw = (w - padX*2) / N;
    const innerW = bw*0.78;
    const barW = Math.max(2, innerW / S);
    const leftPadIn = (bw - innerW)/2;

    if (!hasData){
      // show labels
      ctx.fillStyle = theme.muted;
      ctx.font = "11px system-ui, -apple-system, Segoe UI, sans-serif";
      ctx.textAlign = "center";
      for (let i=0;i<N;i++){
        const cx = padX + i*bw + bw*0.5;
        ctx.fillText(labels[i] ?? "", cx, h-8);
      }
      ctx.fillStyle = theme.muted;
      ctx.font = "12px system-ui, -apple-system, Segoe UI, sans-serif";
      ctx.textAlign = "center";
      ctx.fillText("暂无数据", w/2, h/2);
      return;
    }

    for (let i=0;i<N;i++){
      const groupStart = padX + i*bw + leftPadIn;
      for (let s=0;s<S;s++){
        const v = Number((ser[s].values||[])[i] || 0);
        const barH = (v/maxV) * (h - padTop - padBottom - 10);
        const x = groupStart + s*barW + barW*0.08;
        const wBar = barW*0.84;
        const y = baseY - barH;
        ctx.fillStyle = ser[s].color || "rgba(124,92,255,.75)";
        ctx.fillRect(x, y, wBar, barH);

        // value label
        if (v>0){
          ctx.fillStyle = theme.text;
          ctx.font = "10.5px system-ui, -apple-system, Segoe UI, sans-serif";
          ctx.textAlign = "center";
          ctx.fillText(fmt(v), x + wBar/2, Math.max(padTop-2, y-6));
        }
      }
      // x label (month)
      ctx.fillStyle = theme.muted;
      ctx.font = "11px system-ui, -apple-system, Segoe UI, sans-serif";
      ctx.textAlign = "center";
      const cx = padX + i*bw + bw*0.5;
      ctx.fillText(labels[i] ?? "", cx, h-8);
    }
  }


  function drawPie(canvas, parts, opts){
    const pack = _prepCanvas(canvas);
    if (!pack) return;
    const {ctx,w,h} = pack;
    const theme = _ysTheme();

    const cx = w/2, cy = h/2;
    const r = Math.min(w,h)*0.32;
    const sum = parts.reduce((s,p)=> s + (p.value||0), 0);
    const hasData = sum > 0;
    const total = hasData ? sum : 1;

    const title = (opts && opts.title) ? String(opts.title) : "";
    const unit = (opts && opts.unit) ? String(opts.unit) : "";
    const colors = parts.map(p=> p.color).filter(Boolean);
    const useColors = colors.length ? colors : ["rgba(124,92,255,.80)","rgba(255,120,168,.78)"];

    // title
    ctx.font = "12px system-ui, -apple-system, Segoe UI, sans-serif";
    ctx.textAlign = "left";
    if (title){
      ctx.fillStyle = theme.text;
      ctx.fillText(title, 10, 16);
    }

    // base ring
    ctx.strokeStyle = theme.line;
    ctx.lineWidth = 10;
    ctx.beginPath();
    ctx.arc(cx,cy,r*0.78,0,Math.PI*2);
    ctx.stroke();

    if (!hasData){
      ctx.fillStyle = theme.muted;
      ctx.font = "12px system-ui, -apple-system, Segoe UI, sans-serif";
      ctx.textAlign = "center";
      ctx.fillText("暂无数据", cx, cy+4);
      return;
    }

    let ang = -Math.PI/2;
    parts.forEach((p,idx)=>{
      const a = (p.value||0)/total * Math.PI*2;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.fillStyle = useColors[idx%useColors.length];
      ctx.arc(cx,cy,r,ang,ang+a);
      ctx.closePath();
      ctx.fill();
      ang += a;
    });

    // donut hole
    ctx.globalCompositeOperation = "destination-out";
    ctx.beginPath(); ctx.arc(cx,cy,r*0.55,0,Math.PI*2); ctx.fill();
    ctx.globalCompositeOperation = "source-over";

    // legend (inside chart)
    ctx.font = "12px system-ui, -apple-system, Segoe UI, sans-serif";
    ctx.textAlign = "left";
    let ly = 38;
    parts.forEach((p,idx)=>{
      const v = p.value || 0;
      const pct = total ? Math.round(v/total*100) : 0;
      ctx.fillStyle = useColors[idx%useColors.length];
      ctx.fillRect(12, ly-10, 10, 10);
      ctx.fillStyle = theme.text;
      ctx.fillText(`${p.label}：${v}${unit}（${pct}%）`, 28, ly);
      ly += 18;
    });
  }

  function renderYearSummary(forceYear){
    if (!ysYear || !ysTotalCount) return;
    ensureYearOptions();
    const year = forceYear || ysYear.value || String(new Date().getFullYear());

    const months = Array.from({length:12}, (_,i)=> i+1);
    const cnt = Array(12).fill(0);
    const income = Array(12).fill(0);
    const collabM = Array(12).fill(0);
    const directM = Array(12).fill(0);

    let collab = 0, direct = 0, totalIncome = 0;
    const hotelMap = new Map();

    bookingList().forEach(b=>{
      if (!b.date || String(b.date).slice(0,4)!==year) return;
      const mm = parseInt(String(b.date).slice(5,7), 10);
      if (!mm || mm<1 || mm>12) return;
      const i = mm-1;
      cnt[i] += 1;
      const fee = _toNum(b.serviceFee);
      income[i] += fee;
      totalIncome += fee;

      const isC = !!b.isCollab;
      if (isC){ collab++; collabM[i]++; }
      else { direct++; directM[i]++; }

      if (isC){
        const hotel = String(b.weddingHotel||"未填酒店").trim() || "未填酒店";
        hotelMap.set(hotel, (hotelMap.get(hotel)||0) + 1);
      }
    });

    ysTotalCount.textContent = (collab + direct);
    ysTotalIncome.textContent = _fmtMoney(totalIncome);
    ysCollabCount.textContent = collab;
    ysDirectCount.textContent = direct;

// build notes + pick tops (so year summary isn't "empty")
const topCntVal = Math.max(...cnt);
const topCntIdx = cnt.indexOf(topCntVal);
const topIncVal = Math.max(...income);
const topIncIdx = income.indexOf(topIncVal);

const hotelArr = Array.from(hotelMap.entries()).sort((a,b)=> b[1]-a[1]).map(([name,c])=>({name, c}));
_ysAutoNoteText = buildAutoYsNote(year, {
  total: (collab + direct),
  collab, direct,
  totalIncome,
  topCount: {month: (topCntIdx>=0? (topCntIdx+1) : "—"), value: (topCntVal||0)},
  topIncome:{month: (topIncIdx>=0? (topIncIdx+1) : "—"), value: (topIncVal||0)},
  hotels: hotelArr.slice(0,3)
});

if (ysNotes){
  const saved = loadYsNotes(year);
  ysNotes.setAttribute("data-year", year);
  ysNotes.value = saved || _ysAutoNoteText;
}


    // charts
    const labels = months.map(m=> `${m}月`);
    drawBars(ysChartOrders, cnt, {labels, color:"rgba(124,92,255,.80)", title: year + "年", legendLabel:"单量（单）"});
    drawBars(ysChartIncome, income.map(x=> Math.round(x)), {labels, color:"rgba(255,193,7,.78)", title: year + "年", legendLabel:"收入（元）", valueFormatter: (v)=> _fmtMoney(v)});
    drawGroupedBars(ysChartMix, [
      {label:"合作单", values: collabM, color:"rgba(124,92,255,.80)"},
      {label:"直客单", values: directM, color:"rgba(255,120,168,.78)"},
    ], {title: year + "年", labels});

    // hotels
    if (ysHotelList){
      const arr = hotelArr;
      ysHotelList.innerHTML = arr.length ? "" : `<div class="muted-small">暂无合作单（勾选“合作单”后会在此统计）</div>`;
      arr.slice(0,12).forEach(({name, c})=>{
        const row = document.createElement("div");
        row.className = "ys-hotel-item";
        row.innerHTML = `<div class="name">${escapeHtml(name)}</div><div class="cnt">${c} 单</div>`;
        ysHotelList.appendChild(row);
      });
    }

    // table
    if (ysTable){
      const rows = months.map((m,i)=>({
        month: m,
        count: cnt[i],
        income: Math.round(income[i]),
        collab: collabM[i],
        direct: directM[i],
      }));
      ysTable.innerHTML = `
        <table>
          <thead>
            <tr>
              <th style="width:90px">月份</th>
              <th>单量</th>
              <th>收入（元）</th>
              <th>合作单</th>
              <th>直客单</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr>
                <td>${r.month} 月</td>
                <td>${r.count}</td>
                <td>${_fmtMoney(r.income)}</td>
                <td>${r.collab}</td>
                <td>${r.direct}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }
  }

  ysYear?.addEventListener("change", ()=> renderYearSummary());
  btnYsThisYear?.addEventListener("click", ()=>{
    const y = String(new Date().getFullYear());
    if (ysYear) ysYear.value = y;
    renderYearSummary(y);
  });


  // Schedule ↔ Year Summary (mutually exclusive)
  let _schedUxBound = false;
  function setScheduleMode(mode){
    const wrap = $("#scheduleWrap");
    const ysPage = $("#yearSummaryPage");
    if (!wrap || !ysPage) return;
    const isYS = mode === "ys";
    wrap.classList.toggle("ysMode", isYS);
    ysPage.classList.toggle("hidden", !isYS);
    $("#btnOpenYearSummary")?.classList.toggle("active", isYS);
    if (isYS){
      requestAnimationFrame(()=>{ try{ renderYearSummary(); }catch(e){ console.error(e); } });
    }
  }


function initSchedule() {
    if (!calHead) return;
    if (!_schedUxBound){
      _schedUxBound = true;
      $("#btnOpenYearSummary")?.addEventListener("click", ()=> setScheduleMode("ys"));
      $("#btnBackToSchedule")?.addEventListener("click", ()=> setScheduleMode("schedule"));
    }
    // default: show schedule
    setScheduleMode("schedule");
    calHead.innerHTML = weekNames.map(w=>`<div style="padding:0 6px">${w}</div>`).join("");
    renderCalendar(); renderList(); renderMonthStats(); renderYearSummary();
  }

  // -------------------------
  // Social module (Douyin/XHS)
  // -------------------------
  const SOCIAL_DATA = {"platforms": {"douyin": {"name": "抖音", "why": ["强推荐流：先给你一小波推荐，再用数据决定要不要继续推。", "更吃“前3秒抓人 + 节奏密度 + 完播/互动”。", "适合：口播干货、强情绪故事、现场反转、清单三连。"], "signals": ["前3秒留存（开头钩子）", "完播率/平均观看时长（节奏与信息密度）", "互动率（评论/收藏/转发/关注）", "负反馈（划走、点不感兴趣）"], "ops": ["一条视频只讲一个“核心结论”，其余做成系列。", "把“互动点”埋在第15秒左右：抛选择题/提问。", "结尾别只喊点赞：用“收藏/评论关键词”驱动高价值动作。"]}, "xhs": {"name": "小红书", "why": ["搜索+推荐双入口：标题/正文关键词决定你能不能被搜到。", "更吃“收藏/停留/实用性”：越像教程越容易被收藏。", "适合：清单攻略、避坑指南、预算拆解、模板话术、对比评测。"], "signals": ["关键词匹配（标题/正文/话题/评论）", "收藏率与停留时长（内容是否“值得存”）", "互动质量（评论深度、二次讨论）", "账号垂直度与内容一致性"], "ops": ["标题先给结果：‘【收藏】…清单/模板/避坑’", "正文用小标题+编号，让人一眼能扫完。", "评论区补关键词与补充案例，延长生命周期。"]}}, "templates": {"douyin": {"A": ["3秒钩子：一句反常识/一句恐吓式结果", "30秒干货：3条要点（每条≤8秒）", "10秒示范：给一句可直接念的台词/动作", "5秒互动：让观众在评论区选A/B或打关键词"], "B": ["开头抛事故：‘现场突然…’", "复盘：为什么会翻车（1句）", "解决：三步救场（按时间线）", "结尾：一句‘保命口令’+引导收藏"], "C": ["对比开场：‘做/不做’两个画面", "结果对比：氛围/效率/效果", "方法拆解：2-3步", "结尾：给模板/表格口令"], "D": ["直接给清单：‘婚礼当天最重要的5件事’", "逐条解释：每条一个镜头", "最后一条加爆点：反直觉建议", "结尾：评论区发‘清单’送模板"]}, "xhs": {"X": ["标题：关键词+【收藏】+清单/避坑", "开头：先给结论（1-2句）", "正文：编号清单+每条1句解释", "附：可复制模板话术/表格", "结尾：引导收藏+评论关键词"], "Y": ["标题：‘我做了X场…总结’", "背景：一句身份背书+适用人群", "核心：3个真相/3个步骤", "举例：1个真实场景", "结尾：收藏/关注+系列预告"], "Z": ["标题：预算/费用拆解（关键词）", "先给总预算区间", "拆3-5项：钱花在哪+替代方案", "给一张‘优先级’排序", "结尾：评论区发‘预算表’"], "W": ["标题：问答式（新人最常问…）", "问题复述：还原真实提问", "回答：一句结论+3条理由", "补充：一句‘现场怎么说’模板", "结尾：收藏+留言你的城市/预算"]}}, "personas": {"couple": {"title": "新郎新娘视角", "need": ["怕翻车、怕尴尬、怕超预算", "想要流程顺、氛围高级、家长满意", "需要可直接照抄的‘话术/清单/表格’"], "forms": ["避坑清单", "模板话术（誓言/致谢/证婚）", "婚礼当天时间轴", "预算拆解与替代方案"], "topics": [{"id": 1, "topic": "婚礼当天最容易翻车的3个细节：提前一天就能解决", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 2, "topic": "誓言怎么说不尬？3句模板直接照念", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 3, "topic": "新娘入场怎么走才高级：站位+节奏+眼神", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 4, "topic": "戒指戴不上怎么办？主持人现场救场三步", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 5, "topic": "父母讲话太长怎么办？一句话把时长控住", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 6, "topic": "证婚人发言怎么写？30秒体面版本（含开头结尾）", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 7, "topic": "迎接交接仪式怎么不乱：谁站哪、手怎么递", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 8, "topic": "共同入场怎么拍更好看：步速与停点提示", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 9, "topic": "宣誓告白怎么引导：主持人提问式模板", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 10, "topic": "拥抱亲吻怎么不尴尬：‘提示语’与音乐点位", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 11, "topic": "全家敬酒怎么安排：顺序不乱、时间不超", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 12, "topic": "送手捧花怎么玩更有氛围：两种不尬玩法", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 13, "topic": "全场大合影怎么站队：3分钟搞定的排队口令", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 14, "topic": "新人退场怎么收口：一句话结束全场掌声", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 15, "topic": "婚礼当天24小时清单：照着做就稳", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 16, "topic": "预算有限也想高级：3个‘替代方案’省钱不降质", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 17, "topic": "户外婚礼下雨预案：不慌的三套方案", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 18, "topic": "新人迟到怎么办？流程怎么改不露馅", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 19, "topic": "冷场怎么办？新人可以做的3个小动作", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 20, "topic": "婚礼后朋友圈怎么发更体面：3种文案模板", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}]}, "guests": {"title": "来宾视角", "need": ["怕尴尬、怕做错礼仪", "想要祝福体面、合影好看", "想知道参加婚礼的‘潜规则’"], "forms": ["礼仪避坑", "祝福话术模板", "穿搭&随礼指南", "朋友圈发文模板"], "topics": [{"id": 1, "topic": "参加婚礼穿什么不踩雷：颜色/材质/鞋子一条讲清", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 2, "topic": "随礼怎么给更体面：金额区间与回礼潜规则", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 3, "topic": "上台祝福说什么？30秒万能祝福模板（不尬）", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 4, "topic": "婚礼迟到怎么进场不尴尬：3步‘潜入式’操作", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 5, "topic": "敬酒怎么拒酒不伤人：三句温柔但有边界的话术", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 6, "topic": "合影站哪儿最好看：站位小技巧（显瘦显高）", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 7, "topic": "抢手捧花到底要不要：参与/不参与都体面的做法", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 8, "topic": "带孩子参加婚礼注意什么：不打扰又不委屈娃", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 9, "topic": "婚礼上这些行为最招人烦：来宾礼仪避坑", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 10, "topic": "收到请柬怎么回复更体面：3种场景回复模板", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 11, "topic": "婚礼现场拍视频的礼仪：别挡机位、别开闪光", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 12, "topic": "吃席如何不尴尬：上菜节奏与落座小技巧", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 13, "topic": "婚礼互动游戏怎么参与：不社死的参与方式", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 14, "topic": "伴郎伴娘朋友怎么帮忙：来宾也能做的5件事", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 15, "topic": "婚礼当天有哪些时间点别乱跑：避开关键时刻", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 16, "topic": "新人敬酒来了你怎么说：一句祝福+一句夸赞模板", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 17, "topic": "婚礼后怎么发朋友圈不油腻：3种文案风格", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 18, "topic": "临时被点名发言怎么办：1分钟结构救急", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 19, "topic": "送什么礼物更走心：3类不踩雷礼物清单", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 20, "topic": "看见新人吵架怎么办：来宾的‘不添乱’原则", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}]}, "hotel": {"title": "酒店视角", "need": ["怕投诉、怕节奏乱、怕安全事故", "想提升好评与复购", "想要可执行的‘对接SOP/口令/排班’"], "forms": ["宴会厅动线与上菜节奏", "主持/策划对接清单", "音响灯光应急预案", "服务细节提升好评"], "topics": [{"id": 1, "topic": "酒店婚宴最怕的5个投诉点：提前布防就没事", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 2, "topic": "上菜节奏怎么跟敬酒不冲突：一张表对齐", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 3, "topic": "宴会厅动线怎么规划：不堵、不乱、服务更顺", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 4, "topic": "音响灯光最容易出事的3个点：备份清单", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 5, "topic": "婚礼流程怎么和主持/策划对齐：酒店版对接SOP", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 6, "topic": "同一天多场婚礼怎么排班：岗位最小配置", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 7, "topic": "新人迟到/流程延误怎么办：酒店应急处理话术", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 8, "topic": "户外转室内的备用方案：雨天也能稳住", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 9, "topic": "停电/设备故障怎么办：5分钟应急流程", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 10, "topic": "酒店如何提升婚宴好评：3个容易被夸的细节", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 11, "topic": "婚宴销售怎么谈单：‘套餐+加购’不反感话术", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 12, "topic": "仪式区与餐区切换：什么时候收椅子最不突兀", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 13, "topic": "如何读懂主持人的Cue Sheet：酒店配合要点", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 14, "topic": "上菜口令怎么统一：前厅/后厨/宴会三方口令", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 15, "topic": "场布与消防怎么兼顾：现场必查清单", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 16, "topic": "宾客引导怎么做：指示牌与迎宾台的黄金位置", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 17, "topic": "宴会厅灯光怎么配合拍摄：让新人更好看", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 18, "topic": "婚礼现场出现争执怎么办：酒店的降温SOP", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 19, "topic": "供应商管理怎么做：合作名单与准入标准", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 20, "topic": "婚宴结束如何复盘：3个数据决定下次口碑", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}]}, "host": {"title": "主持人视角", "need": ["新手怕忘词/怕冷场/怕控不住时长", "想快速提升专业感与成交率", "想要台词结构、控场口令、复盘方法"], "forms": ["45-60秒口播结构", "环节台词模板", "控场/救场口令", "私信咨询→成交SOP"], "topics": [{"id": 1, "topic": "新手主持第一场怎么不翻车：一张流程表救命", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 2, "topic": "婚礼开场前3秒怎么抓人：3种钩子模板", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 3, "topic": "暖场怎么做不尬：3个互动点位（可复制台词）", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 4, "topic": "忘词怎么办：主持人现场‘三段式’自救", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 5, "topic": "控场口令合集：一句话让全场安静/站起/转头", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 6, "topic": "父母讲话控时：既体面又能收住的引导话术", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 7, "topic": "证婚人发言怎么带：递话筒+收尾+掌声点", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 8, "topic": "宣誓告白怎么问：提问式让新人自然说出真话", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 9, "topic": "戒指环节怎么抬氛围：一句提示+一个停点", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 10, "topic": "拥抱亲吻怎么不油：提示语与音乐点位", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 11, "topic": "敬酒怎么缩时：路线+口令+酒店配合", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 12, "topic": "大合影怎么调度：3分钟排队话术（含站位）", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 13, "topic": "应急口令10条：设备坏/小孩闹/冷场都能用", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 14, "topic": "台词怎么去AI化：把‘句式’改成‘说话习惯’", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 15, "topic": "主持人穿搭怎么选：三套万能搭配（稳重不老）", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 16, "topic": "报价怎么谈：让客户接受你的价值的3句话", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 17, "topic": "问诊表怎么问：问对了婚礼就赢一半", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 18, "topic": "和五大金刚怎么配合：一句话对齐节奏", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 19, "topic": "复盘怎么做：一场婚礼提升一次的指标表", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 20, "topic": "私信咨询→成交SOP：四步把流量变订单", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}]}, "team": {"title": "五大金刚视角", "need": ["怕机位冲突、怕流程对不齐、怕临时改动", "想提高协作效率与成片质量", "想通过联合内容出圈接单"], "forms": ["岗位Cue对齐", "机位与灯光协同", "当天事故预案", "团队联合自媒体栏目"], "topics": [{"id": 1, "topic": "五大金刚最怕遇到的3种临时改动：怎么提前锁流程", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 2, "topic": "当天Cue怎么对齐：一张共享表让所有人不卡壳", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 3, "topic": "摄影/摄像互挡机位怎么办：站位规则一口讲清", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 4, "topic": "化妆师出场时间怎么卡：不耽误也不催命", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 5, "topic": "场布灯光怎么配合拍摄：让新人‘显贵’的布光法", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 6, "topic": "策划与主持如何共用流程表：谁负责什么一目了然", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 7, "topic": "交接仪式机位怎么站：保证特写+不挡视线", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 8, "topic": "戒指佩戴怎么拍：特写、反打、情绪三镜头", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 9, "topic": "大合影怎么拍不乱：主持口令+摄影站位", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 10, "topic": "退场礼成怎么做氛围：灯光/BGM/喷花节奏", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 11, "topic": "Afterparty转场怎么拍：三段式镜头不丢情绪", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 12, "topic": "酒店对接怎么省沟通：三句话让宴会经理秒懂", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 13, "topic": "当天最常见事故TOP5：每个都有预案", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 14, "topic": "物料清单怎么带：备用电池/胶带/别针/应急包", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 15, "topic": "成片更高级的细节：‘停点’与‘回头’的配合", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 16, "topic": "团队如何联合出圈：一个婚礼切10条内容", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}, {"id": 17, "topic": "如何拍主持：给主持的镜头提示与收声技巧", "dy_tpl": "A", "xhs_tpl": "X", "keywords": []}, {"id": 18, "topic": "如何拍父母：不煽情也能有泪点的镜头点", "dy_tpl": "D", "xhs_tpl": "W", "keywords": []}, {"id": 19, "topic": "团队如何提高好评：交付与回访的统一话术", "dy_tpl": "C", "xhs_tpl": "Y", "keywords": []}, {"id": 20, "topic": "同城团队怎么涨价：用‘可见价值’包装服务", "dy_tpl": "B", "xhs_tpl": "Z", "keywords": []}]}}};

  let socialInited = false;

  function copyToClipboard(text) {
    if (!text) return;
    const t = String(text);
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(t).then(()=>toast("已复制 ✅")).catch(()=>fallbackCopy(t));
    } else {
      fallbackCopy(t);
    }
  }

  // alias for older helpers
  function copyText(text){ copyToClipboard(text); }

  function fallbackCopy(t) {
    const ta = document.createElement("textarea");
    ta.value = t;
    ta.setAttribute("readonly","readonly");
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    try {
      document.execCommand("copy");
      toast("已复制 ✅");
    } catch(e) {
      toast("复制失败，请手动复制");
    }
    document.body.removeChild(ta);
  }

  function initSocial() {
    if (socialInited) return;
    socialInited = true;

    // platform blocks
    const dy = SOCIAL_DATA.platforms.douyin;
    const xh = SOCIAL_DATA.platforms.xhs;
    if ($("#dySignals")) $("#dySignals").innerHTML = dy.signals.map(s=>`<li>${s}</li>`).join("");
    if ($("#dyOps")) $("#dyOps").innerHTML = dy.ops.map(s=>`<li>${s}</li>`).join("");
    if ($("#xhsSignals")) $("#xhsSignals").innerHTML = xh.signals.map(s=>`<li>${s}</li>`).join("");
    if ($("#xhsOps")) $("#xhsOps").innerHTML = xh.ops.map(s=>`<li>${s}</li>`).join("");

    // persona needs & forms
    Object.keys(SOCIAL_DATA.personas).forEach((k)=>{
      const p = SOCIAL_DATA.personas[k];
      const needEl = $("#need_"+k);
      const formEl = $("#forms_"+k);
      if (needEl) needEl.innerHTML = p.need.map(x=>`<li>${x}</li>`).join("");
      if (formEl) formEl.innerHTML = p.forms.map(x=>`<li>${x}</li>`).join("");
      try{ renderTopics(k); }catch(e){ console.error(e); }
    });

    // nav + search + generator
    try{ buildSocialNav(); }catch(e){ console.error(e); }
    try{ bindSocialSearch(); }catch(e){ console.error(e); }
    bindGenerator();
    try{ bindViralContentGen(); }catch(e){ console.error(e); }
    try{ bindTopicAnalyzer(); }catch(e){ console.error(e); }
  }

  function renderTopics(key) {
    const wrap = $("#topic_"+key);
    if (!wrap) return;
    const p = SOCIAL_DATA.personas[key];
    const dyT = SOCIAL_DATA.templates.douyin;
    const xhT = SOCIAL_DATA.templates.xhs;

    wrap.innerHTML = p.topics.map((o)=>{
      const dySteps = (dyT[o.dy_tpl]||[]).map(x=>`<li>${x}</li>`).join("");
      const xhSteps = (xhT[o.xhs_tpl]||[]).map(x=>`<li>${x}</li>`).join("");
      const title = o.topic;
      const copyTitle = title;
      const copyHint = `【${p.title}】${title}\n推荐：抖音${o.dy_tpl} / 小红书${o.xhs_tpl}`;
      return `
        <div class="topicrow" data-topic-row>
          <div class="tno">${String(o.id).padStart(2,"0")}</div>
          <div class="tmain">
            <div class="tt">${title}</div>
            <div class="tmeta">
              <span class="tag">抖音 ${o.dy_tpl}</span>
              <span class="tag">小红书 ${o.xhs_tpl}</span>
              <button class="sbtn" data-copy="${copyTitle.replace(/"/g,'&quot;')}">复制标题</button>
              <button class="sbtn primary" data-copy="${copyHint.replace(/"/g,'&quot;')}">复制提示</button>
            </div>

            <details class="soft">
              <summary>展开：脚本结构（按模板）</summary>
              <div class="tplgrid">
                <div class="box">
                  <h4 style="margin:0 0 6px">抖音模板 ${o.dy_tpl}</h4>
                  <ol>${dySteps}</ol>
                </div>
                <div class="box">
                  <h4 style="margin:0 0 6px">小红书模板 ${o.xhs_tpl}</h4>
                  <ol>${xhSteps}</ol>
                </div>
              </div>
            </details>
          </div>
        </div>
      `;
    }).join("");
  }

  function buildSocialNav() {
    const nav = $("#socialNav");
    const root = $("#viewSocial");
    if (!nav || !root) return;
    const secs = $$("[data-sm-sec]", root);
    nav.innerHTML = secs.map(s=>{
      const title = s.getAttribute("data-sm-title") || (s.querySelector("h3")?.innerText || s.id);
      return `<a class="navitem" href="#${s.id}" data-sm-link="${s.id}">${title}</a>`;
    }).join("");

    const linkById = {};
    $$("[data-sm-link]", nav).forEach(a=> linkById[a.getAttribute("data-sm-link")] = a);

    const obs = new IntersectionObserver((entries)=>{
      entries.forEach(en=>{
        if (!en.isIntersecting) return;
        const id = en.target.id;
        $$("a.navitem", nav).forEach(a=>a.classList.remove("active"));
        if (linkById[id]) linkById[id].classList.add("active");
      });
    }, {threshold: 0.35});

    secs.forEach(s=>obs.observe(s));
  }

  function bindSocialSearch() {
    const input = $("#socialSearch");
    const btn = $("#btnSocialClear");
    const root = $("#viewSocial");
    if (!input || !btn || !root) return;

    const doSearch = ()=>{
      const q = input.value.trim().toLowerCase();
      const secs = $$("[data-sm-sec]", root);
      secs.forEach(sec=> {
        const txt = sec.innerText.toLowerCase();
        sec.style.display = (!q || txt.includes(q)) ? "" : "none";
      });
    };

    input.addEventListener("input", doSearch);
    btn.addEventListener("click", ()=>{ input.value=""; doSearch(); input.focus(); });
  }

  // Generator
  const GEN = {
    pains: ["翻车","尴尬","冷场","流程乱","台词卡壳","站位不对","走位乱","镜头找不到人","音乐点位错","话筒啸叫/没声","灯光不跟","上菜打断","敬酒太久","父母讲话超时","证婚人跑题","伴郎伴娘不配合","戒指戴不上","手捧花忘了","誓言太干","情绪起不来","宾客不入座","签到混乱","合影排队炸裂","迟到","新人临场改流程","换衣/补妆拖延","天气下雨预案","户外风太大","小孩闹场","长辈起哄","喝醉闹事","道具失灵","背景音乐太吵","场控不听指挥","酒店催流程","摄影摄像抢位","婚礼管家失联","五大金刚各做各的","主持人节奏飘","主持过度油腻","新人害羞不敢说","新郎紧张忘词","新娘哭妆花","父母情绪失控","彩排不到位","时间轴缺失","cue sheet缺失","点位表缺失","关键口令没有","对接群没人回应","微信群信息爆炸","预算低但要求高","酒店套餐限制","舞台太小","通道太窄","音响位置不佳","投影故障","短视频素材拍不到","客户转化难","私信不回","同城竞争卷","被比价压价","临时加项","尾款拖延","合同不清","返场音乐找不到","退场卡点失败","全家敬酒站位乱","证婚人入场顺序错","送花环节找不到人","大合影没人组织","新人退场没人带路","串场太多信息密度低","BGM音量忽大忽小","开场白太长宾客走神","司仪口头禅太多","酒店临时改菜上菜节奏乱","新人走位挡镜头","伴郎伴娘站位不齐","父母入场没扶好","花童抢镜","现场手机铃声干扰","来宾敬酒抢麦","证婚词太长","拍照时间拖到吃饭","灯光没切到追光","主持与DJ没对齐"],
    benefits: ["避雷","省钱","显高级","控场稳","好评更多","氛围拉满","效率更高","不尬不油","更好拍","更好看","更体面","流程更顺","节奏更稳","让父母放心","让新人省心","让酒店配合","让五大金刚顺滑","现场少扯皮","镜头更漂亮","台词更有温度","情绪更到位","宾客更投入","掌声更密","出片率更高","收藏转发更多","私信咨询更多","同城曝光更高","客单价更高","转介绍更多","成交更快","对接更清楚","不被临时改崩","不被酒店催爆","遇雨也能稳","新人更敢表达","长辈更满意","现场更有仪式感","音乐更踩点","灯光更跟手","合影更快更整齐","敬酒不拖","讲话不超时","一眼就专业","模板一套就能用","可复制可交付","现场更省力","整场更像大片","把控全局","小问题秒解决","避免冷场","避免尴尬","不被抢镜","不被抢位","更会引导互动","更适合抖音爆","更适合小红书收藏","更容易涨粉","更容易接单","更容易被收藏","更容易被转发","更容易被搜索到","更容易形成系列内容","更容易在同城出圈","更容易做出爆款封面","更容易把线索引到私信"],
    titlePatterns: {
      douyin: [
        "别再{pain}了！{style}{stage}这样做，直接{benefit}",
        "{stage}{pain}最容易翻车：我做过{n}场婚礼总结的{m}条",
        "{style}婚礼想{benefit}：先把{pain}搞明白",
        "新人必看：{pain}不处理，{stage}必翻车",
        "主持人真话：{pain}这一步，90%新人都忽略"
      ],
      xhs: [
        "【收藏】{style}{stage}{pain}避坑清单：{m}条",
        "我把{pain}整理成{m}步，{benefit}又体面",
        "{style}婚礼{stage}怎么{benefit}？{m}个关键点",
        "新人最常问：{pain}怎么办？一篇讲透",
        "婚礼{pain}模板（可复制）：照着做就稳"
      ]
    },
    hooks: {
      狠: [
        "我见过太多婚礼因为{pain}直接翻车，真的不夸张。",
        "别等到现场才发现：{pain}一出问题，全场都尴尬。",
        "如果你正在{stage}，这条不看，容易踩坑。"
      ],
      藏: [
        "建议先收藏：{style}{stage}关于{pain}，你一定用得上。",
        "给正在备婚的人：{pain}怎么处理，我给你一份可抄作业。",
        "这条是‘模板型’：看完就能直接照做。"
      ],
      故: [
        "上周一场{style}婚礼，现场突然{pain}，我用三步稳住了。",
        "有一场婚礼因为{pain}差点冷场，最后反而成了高光。",
        "我把一线遇到的{pain}，拆成了能照抄的流程。"
      ]
    },
    ctas: ["评论区打“模板”我把话术发你","评论区打“清单”我把表格发你","想要对应环节台词，评论区打“台词”","需要你们的情况我给你改一版，评论区留“城市+酒店”"]
  };

  function rnd(arr) { return arr[Math.floor(Math.random()*arr.length)] }

  function formatTpl(tpl, vars) {
    return tpl.replace(/\{(\w+)\}/g, (_,k)=> (vars[k]!==undefined ? vars[k] : ""));
  }

  function pickToneHook(tone) {
    if (tone.includes("情绪")) return rnd(GEN.hooks.狠);
    if (tone.includes("故事")) return rnd(GEN.hooks.故);
    return rnd(GEN.hooks.藏);
  }

  function clampLen(s, minLen=260, maxLen=320) {
    let out = s;
    const extra = [
      "最后提醒：把这条内容收藏起来，临场真的用得上。",
      "如果你想让我按你的酒店流程改一版，评论区留信息我来帮你调整。",
      "别只看完就划走，收藏=你真的会用到。"
    ];
    while (out.length < minLen) out += rnd(extra);
    if (out.length > maxLen) out = out.slice(0, maxLen-1) + "…";
    return out;
  }

  function genTitles(platform, vars) {
    const patterns = GEN.titlePatterns[platform] || GEN.titlePatterns.douyin;
    const set = new Set();
    let guard = 0;
    while (set.size < 10 && guard < 60) {
      guard++;
      const tpl = rnd(patterns);
      const t = formatTpl(tpl, vars);
      set.add(t);
    }
    return Array.from(set);
  }

  function genStructure(platform) {
    if (platform === "douyin") {
      const letter = rnd(Object.keys(SOCIAL_DATA.templates.douyin));
      const steps = SOCIAL_DATA.templates.douyin[letter];
      return `推荐模板：抖音${letter}\n\n` + steps.map((s,i)=>`${i+1}. ${s}`).join("\n");
    } else {
      const letter = rnd(Object.keys(SOCIAL_DATA.templates.xhs));
      const steps = SOCIAL_DATA.templates.xhs[letter];
      return `推荐模板：小红书${letter}\n\n` + steps.map((s,i)=>`${i+1}. ${s}`).join("\n");
    }
  }

  
  function genCopy(vars) {
    const tone = vars.tone;
    const hookTpl = pickToneHook(tone);
    const hook = formatTpl(hookTpl, vars);

    const scene = rnd([
      `今天就讲一个很具体的场景：${vars.stage}卡在“${vars.pain}”上，现场会发生什么？`,
      `你别把“${vars.pain}”当小事，它往往是导致冷场/翻车的第一张多米诺。`,
      `如果你只想${vars.benefit}，那就只做这一件事：把“${vars.pain}”提前对齐。`,
      `很多人以为婚礼靠感觉，其实靠的是“口令+时间轴+点位表”。${vars.pain}一旦失控，后面全乱。`
    ]);

    const stepsA = [
      `① 先定义标准：${vars.pain}到底谁负责、什么时候做、做到什么程度（别含糊）。`,
      `② 现场一句口令对齐：把“人/物/音乐/镜头”卡在同一个点位上，氛围立刻稳。`,
      `③ 备一个B计划：真出问题时直接切换，不解释、不慌张。`
    ];

    const stepsB = [
      `① 先把“关键人”叫到一起：主持/酒店/摄影摄像/管家，30秒说清楚下一步。`,
      `② 把节点写在手机备忘录：到点就执行，不临场改到崩。`,
      `③ 每个环节只保留一个“高光动作”：镜头更漂亮，节奏也更稳。`
    ];

    const stepsC = [
      `① 先用一句话稳住新人情绪：告诉他们“我来控场，你只管享受”。`,
      `② 立刻收紧流程：删掉可有可无的内容，保住关键仪式感。`,
      `③ 把音乐点位改成“稳妥版”：宁可简单，也别错。`
    ];

    const steps = rnd([stepsA, stepsB, stepsC]).join("\n");

    const templatePool = [
      `“我们把${vars.pain}先对齐：现在做A（谁负责），下一步做B（到点开始），如果出问题就按C走（备用方案）。”`,
      `“现在我只确认三件事：音乐点位、镜头位置、站位走位。确认完我们立刻开始。”`,
      `“我来报节点：${vars.stage}下一步是——（环节名），到点我会给口令，大家跟口令走。”`
    ];
    const template = `\n\n给你一句可直接用的口令模板：\n${rnd(templatePool)}`;

    const endPool = [
      `\n\n最后提醒：把这条先收藏，婚礼当天翻出来照着做，真的省心。`,
      `\n\n如果你想要“对应酒店的时间轴+台词+音乐点位”，评论区留“城市+酒店”，我给你改一版。`,
      `\n\n想要更具体的清单模板？评论区打“模板”，我把表格格式发你。`
    ];

    const cta = `\n\n${rnd(GEN.ctas)}`;

    const body = `${hook}\n\n${scene}\n\n一线实操给你三步：\n${steps}${template}${cta}${rnd(endPool)}`;
    return clampLen(body, 520, 820);
  }


  function bindGenerator() {
    const btn = $("#genBtn");
    const btnR = $("#genRandom");
    if (!btn || !btnR) return;

    const run = ()=>{
      try{
      const platform = $("#genPlatform").value;
      const personaKey = $("#genPersona").value;
      const stage = $("#genStage").value;
      const style = $("#genStyle").value;
      const tone = $("#genTone").value;
      const pain = ($("#genPain").value || "").trim() || rnd(GEN.pains);
      const benefit = ($("#genBenefit").value || "").trim() || rnd(GEN.benefits);

      const personaName = SOCIAL_DATA.personas[personaKey]?.title || "婚礼视角";
      const vars = {
        platform,
        persona: personaName,
        stage,
        style,
        tone,
        pain,
        benefit,
        n: String(20 + Math.floor(Math.random()*80)),
        m: String(3 + Math.floor(Math.random()*5))
      };

      const titles = genTitles(platform, vars);
      const structure = genStructure(platform);
      const copy = genCopy(vars);

      $("#outTitles").value = titles.map((t,i)=>`${i+1}. ${t}`).join("\n");
      $("#outStructure").value = structure;
      $("#outCopy").value = copy;
      if ($("#outCount")) $("#outCount").textContent = `（${copy.length}字）`;
        toast("已生成 ✅");
      } catch(err){
        console.error(err);
        toast("生成失败：" + (err?.message || err));
      }
    };

    btn.addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); run(); });
    btn.onclick = run;
    btnR.addEventListener("click", ()=>{
      $("#genPain").value = rnd(GEN.pains);
      $("#genBenefit").value = rnd(GEN.benefits);
      toast("已随机一组灵感 ✨");
    });

    $("#btnCopyAll")?.addEventListener("click", ()=> copyToClipboard($("#outCopy").value || ""));
    $("#btnSaveIdea")?.addEventListener("click", saveIdea);
    $("#btnClearIdeas")?.addEventListener("click", ()=>{
      /* no confirm */
      state.socialIdeas = [];
      save(state);
      renderIdeas();
      toast("已清空 🧹");
    });
  }

  function saveIdea() {
    const titles = ($("#outTitles").value || "").trim();
    const structure = ($("#outStructure").value || "").trim();
    const copy = ($("#outCopy").value || "").trim();
    if (!copy) { toast("先生成一条再保存"); return; }

    const idea = {
      id: "idea_" + Date.now(),
      ts: new Date().toISOString(),
      platform: $("#genPlatform").value,
      persona: $("#genPersona").value,
      stage: $("#genStage").value,
      style: $("#genStyle").value,
      pain: ($("#genPain").value||"").trim(),
      benefit: ($("#genBenefit").value||"").trim(),
      tone: $("#genTone").value,
      titles, structure, copy
    };
    state.socialIdeas = state.socialIdeas || [];
    state.socialIdeas.push(idea);
    save(state);
    renderIdeas();
    toast("已保存到素材库 ✅");
  }

  function renderIdeas() {
    const wrap = $("#ideaList");
    if (!wrap) return;
    const list = (state.socialIdeas || []).slice().reverse();
    if (!list.length) {
      wrap.innerHTML = `<div class="muted">暂无素材。去上面生成一条，然后点“保存到素材库”。</div>`;
      return;
    }
    wrap.innerHTML = list.map((it)=>{
      const platformName = it.platform === "xhs" ? "小红书" : "抖音";
      const personaName = SOCIAL_DATA.personas[it.persona]?.title || it.persona;
      const when = new Date(it.ts).toLocaleString();
      const blob = `${platformName}｜${personaName}｜${it.stage}｜${it.style}\n\n【标题】\n${it.titles}\n\n【脚本结构】\n${it.structure}\n\n【文案】\n${it.copy}`;
      return `
        <div class="idea" data-idea-id="${it.id}">
          <div class="top">
            <div>
              <div style="font-weight:850">${platformName} · ${personaName} · ${it.stage} · ${it.style}</div>
              <div class="meta">${when}</div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="sbtn" data-idea-copy="${blob.replace(/"/g,'&quot;')}">复制整条</button>
              <button class="sbtn" data-idea-del="${it.id}">删除</button>
            </div>
          </div>
          <pre>${blob}</pre>
        </div>
      `;
    }).join("");

    wrap.querySelectorAll("[data-idea-copy]").forEach(btn=>{
      btn.addEventListener("click", ()=> copyToClipboard(btn.getAttribute("data-idea-copy")||""));
    });
    wrap.querySelectorAll("[data-idea-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-idea-del");
        state.socialIdeas = (state.socialIdeas||[]).filter(x=>x.id !== id);
        save(state);
        renderIdeas();
        toast("已删除");
      });
    });
  }

  // copy buttons in Social view
  $("#viewSocial")?.addEventListener("click", (e)=>{
    const btn = e.target.closest("[data-copy]");
    if (!btn) return;
    const val = btn.getAttribute("data-copy") || "";
    // decode HTML entities
    const tmp = document.createElement("textarea");
    tmp.innerHTML = val;
    copyToClipboard(tmp.value || tmp.textContent || val);
  });

    /* =========================================================
     Social Module Upgrade (Generator Full Version + Fix Buttons)
     ========================================================= */

  function enc64(str){
    try { return btoa(unescape(encodeURIComponent(String(str||"")))); }
    catch(e){ return ""; }
  }
  function dec64(b64){
    try { return decodeURIComponent(escape(atob(String(b64||"")))); }
    catch(e){ return String(b64||""); }
  }

  // Ensure generator template state exists
  if (!state.socialGenTpl) state.socialGenTpl = { dy:"auto", xhs:"auto" };
  if (!state.socialLastTopic) state.socialLastTopic = null;

  function setTplActive(barId, attr, val){
    const bar = document.getElementById(barId);
    if (!bar) return;
    bar.querySelectorAll(".pillbtn").forEach(b=> b.classList.remove("active"));
    const btn = bar.querySelector(`.pillbtn[${attr}="${val}"]`);
    if (btn) btn.classList.add("active");
  }

  function setDyTpl(v){
    state.socialGenTpl = state.socialGenTpl || {dy:"auto", xhs:"auto"};
    state.socialGenTpl.dy = v;
    save(state);
    setTplActive("dyTplBar", "data-set-dy", v);
    toast(`抖音模板已选：${v==="auto"?"自动":("A/B/C/D 中的 "+v)}`);
  }
  function setXhsTpl(v){
    state.socialGenTpl = state.socialGenTpl || {dy:"auto", xhs:"auto"};
    state.socialGenTpl.xhs = v;
    save(state);
    setTplActive("xhsTplBar", "data-set-xhs", v);
    toast(`小红书模板已选：${v==="auto"?"自动":("X/Y/Z/W 中的 "+v)}`);
  }

  function tplStepsText(platform, letter){
    if (platform === "douyin") {
      const steps = SOCIAL_DATA.templates.douyin[letter] || [];
      return `抖音模板 ${letter}\n` + steps.map((s,i)=>`${i+1}. ${s}`).join("\n");
    } else {
      const steps = SOCIAL_DATA.templates.xhs[letter] || [];
      return `小红书模板 ${letter}\n` + steps.map((s,i)=>`${i+1}. ${s}`).join("\n");
    }
  }

  // Override: render topics with functional buttons (dy/xhs pills + copy)
  function renderTopics(key) {
    const wrap = $("#topic_"+key);
    if (!wrap) return;
    const p = SOCIAL_DATA.personas[key];
    const dyT = SOCIAL_DATA.templates.douyin;
    const xhT = SOCIAL_DATA.templates.xhs;

    wrap.innerHTML = p.topics.map((o)=>{
      const dySteps = (dyT[o.dy_tpl]||[]).map(x=>`<li>${x}</li>`).join("");
      const xhSteps = (xhT[o.xhs_tpl]||[]).map(x=>`<li>${x}</li>`).join("");
      const title = o.topic;
      const hint = `【${p.title}】${title}\n推荐：抖音${o.dy_tpl} / 小红书${o.xhs_tpl}\n（小技巧：点“抖音A/小红书X”可复制模板结构；点“带入生成器”可一键填参）`;

      return `
        <div class="topicrow" data-topic-row data-persona="${key}" data-topic64="${enc64(title)}" data-dy="${o.dy_tpl}" data-xhs="${o.xhs_tpl}">
          <div class="tno">${String(o.id).padStart(2,"0")}</div>
          <div class="tmain">
            <div class="tt">${title}</div>
            <div class="tmeta">
              <button class="pillbtn" data-tpl="dy:${o.dy_tpl}">抖音 ${o.dy_tpl}</button>
              <button class="pillbtn" data-tpl="xhs:${o.xhs_tpl}">小红书 ${o.xhs_tpl}</button>
              <button class="sbtn" data-copy64="${enc64(title)}">复制标题</button>
              <button class="sbtn primary" data-copy64="${enc64(hint)}">复制提示</button>
</div>

            <details class="soft">
              <summary>展开：脚本结构（按模板）</summary>
              <div class="tplgrid">
                <div class="box">
                  <h4 style="margin:0 0 6px">抖音模板 ${o.dy_tpl}</h4>
                  <ol>${dySteps}</ol>
                </div>
                <div class="box">
                  <h4 style="margin:0 0 6px">小红书模板 ${o.xhs_tpl}</h4>
                  <ol>${xhSteps}</ol>
                </div>
              </div>
            </details>
          </div>
        </div>
      `;
    }).join("");
  }

  // Universal copy handler (works offline)
  function bindCopyDelegation(){
    document.addEventListener("click", (e)=>{
      const fromBtn = e.target.closest("[data-copy-from]");
      if (fromBtn){
        const sel = fromBtn.getAttribute("data-copy-from");
        const el = sel ? document.querySelector(sel) : null;
        const val = el ? (el.value ?? el.textContent ?? "") : "";
        copyToClipboard(val);
        e.preventDefault(); e.stopPropagation();
        return;
      }
      const b64Btn = e.target.closest("[data-copy64]");
      if (b64Btn){
        copyToClipboard(dec64(b64Btn.getAttribute("data-copy64")||""));
        e.preventDefault(); e.stopPropagation();
        return;
      }
      const old = e.target.closest("[data-copy]");
      if (old){
        const val = old.getAttribute("data-copy") || "";
        const tmp = document.createElement("textarea");
        tmp.innerHTML = val;
        copyToClipboard(tmp.value || tmp.textContent || val);
        e.preventDefault(); e.stopPropagation();
        return;
      }
    }, true);
  }
  bindCopyDelegation();

  // Social view click delegation: tpl pills + bring-to-generator
  $("#viewSocial")?.addEventListener("click", (e)=>{
    const tplBtn = e.target.closest("[data-tpl]");
    if (tplBtn){
      const raw = tplBtn.getAttribute("data-tpl") || "";
      const [p, letter] = raw.split(":");
      if (p === "dy" && letter) {
        copyToClipboard(tplStepsText("douyin", letter));
        // also set generator template
        setDyTpl(letter);
      } else if (p === "xhs" && letter){
        copyToClipboard(tplStepsText("xhs", letter));
        setXhsTpl(letter);
      }
      return;
    }

    const fillBtn = e.target.closest("[data-fill-gen]");
    if (fillBtn){
      const row = e.target.closest("[data-topic-row]");
      if (!row) return;
      const personaKey = row.getAttribute("data-persona") || "host";
      const topic = dec64(row.getAttribute("data-topic64")||"");
      const dy = row.getAttribute("data-dy") || "auto";
      const xhs = row.getAttribute("data-xhs") || "auto";
      state.socialLastTopic = { personaKey, topic, dy, xhs };
      save(state);
      fillGeneratorFromTopic(state.socialLastTopic, true);
      return;
    }
  });

  function fillGeneratorFromTopic(t, toastIt=false){
    if (!t) { toast("先在选题库里点一次“带入生成器”"); return; }
    const pSel = $("#genPersona");
    const pain = $("#genPain");
    if (pSel) pSel.value = t.personaKey || "host";
    if (pain) pain.value = t.topic || "";
    // set templates if present
    if (t.dy) setDyTpl(t.dy);
    if (t.xhs) setXhsTpl(t.xhs);
    if (toastIt) toast("已带入生成器 ✅（你可以直接点“生成完整版”）");
    // scroll to generator
    const gen = document.getElementById("smGen");
    if (gen) gen.scrollIntoView({behavior:"smooth", block:"start"});
  }

  // -------- Generator FULL --------
  function pickTpl(platform, preferred){
    const bag = platform === "douyin" ? SOCIAL_DATA.templates.douyin : SOCIAL_DATA.templates.xhs;
    const keys = Object.keys(bag);
    if (preferred && preferred !== "auto" && bag[preferred]) return preferred;
    return rnd(keys);
  }

  function personaNameByKey(k){
    return (SOCIAL_DATA.personas[k]?.title) || "婚礼视角";
  }

  function buildCover(platform, vars){
    const pain = vars.pain;
    const benefit = vars.benefit;
    const style = vars.style;
    const stage = vars.stage;

    const selTitle = String(state.socialSelectedTitleText||"").trim();
    const selPlat  = String(state.socialSelectedTitlePlatform||"").trim();
    const useSel = selTitle && (!selPlat || selPlat===platform);

    if (useSel){
      const line1 = selTitle;
      const line2 = platform==="douyin" ? `1分钟给你：${benefit || "把控全流程不翻车"}` : `收藏备用：${benefit || "婚礼当天更稳更出片"}`;
      return [line1, line2].join("\n");
    }

    const dy = [
      `别再让「${pain}」毁了氛围`,
      `1分钟教你：${benefit}`
    ];
    const xh = [
      `${style}${stage}｜${pain}避雷清单`,
      `收藏：${benefit}的关键点`
    ];
    return (platform==="douyin" ? dy : xh).join("\n");
  }

  function buildHookLine(vars){
    const tone = vars.tone;
    const pain = vars.pain;
    const benefit = vars.benefit;
    const stage = vars.stage;

    const hooks = [];
    const selTitle = String(state.socialSelectedTitleText||"").trim();
    const selPlat  = String(state.socialSelectedTitlePlatform||"").trim();
    if (selTitle){
      hooks.push(`如果你婚礼当天也担心「${selTitle}」，先把这1分钟听完。`);
      hooks.push(`别等翻车才后悔：${selTitle}，这样做更稳。`);
    }

    hooks.push(`婚礼${stage}最容易翻车的，往往不是大事，是“${pain}”这种小细节。`);
    hooks.push(`我见过太多人在“${pain}”上踩坑，结果想${benefit}反而更尴尬。`);
    hooks.push(`如果你只记住一句话：${pain}先对齐，后面90%都顺。`);
    if (tone.includes("情绪")) hooks.push(`别装了，${pain}一出问题，现场立刻尬到脚趾抠地。`);
    if (tone.includes("专业")) hooks.push(`我把${pain}拆成一个标准动作，照做就稳。`);
    return rnd(hooks);
  }

  function buildStructure(platform, letter){
    const steps = platform==="douyin" ? SOCIAL_DATA.templates.douyin[letter] : SOCIAL_DATA.templates.xhs[letter];
    const prefix = platform==="douyin" ? `推荐模板：抖音${letter}` : `推荐模板：小红书${letter}`;
    return prefix + "\n\n" + steps.map((s,i)=>`${i+1}. ${s}`).join("\n");
  }

  function buildScript(platform, vars, letter){
    const len = vars.len;
    const form = vars.form;
    const goal = vars.goal;
    const pain = vars.pain;
    const benefit = vars.benefit;
    const persona = vars.persona;
    const stage = vars.stage;
    const tone = vars.tone;

    // 标题驱动：如果从标题库带入，则本次输出按标题“角度”写逐字稿
    const selTitle = String(state.socialSelectedTitleText||"").trim();
    const selPlat  = String(state.socialSelectedTitlePlatform||"").trim();
    const useSel = selTitle && (!selPlat || selPlat===platform);
    const angle = useSel ? (String(state.socialSelectedTitleAngle||"").trim() || inferAngleFromTitle(selTitle, platform))
                         : inferAngleFromTitle(`${pain}${benefit}`, platform);

    const cta = (goal==="收藏") ? "这条先收藏，婚礼当天真的用得上。" :
                (goal==="评论互动") ? "你们最怕哪一步翻车？评论区写出来，我按你家流程给你改一版口令。" :
                (goal==="关注") ? "关注我，婚礼全流程控场细节我每天拆一条。" :
                (goal==="私信咨询") ? "想按你家酒店流程定制一版，私信我“流程”，我发你模板。" :
                "同城的朋友定位我这座城市，评论区我给你更贴合本地酒店节奏的版本。";

    const timeMap = {
      "45秒": ["[0–03s]","[03–10s]","[10–33s]","[33–45s]"],
      "60秒": ["[0–03s]","[03–12s]","[12–20s]","[20–48s]","[48–60s]"],
      "90秒": ["[0–03s]","[03–15s]","[15–28s]","[28–55s]","[55–75s]","[75–90s]"]
    }[len] || ["[0–03s]","[03–12s]","[12–20s]","[20–48s]","[48–60s]"];

    const hook = (()=>{
      if (useSel) return rnd([
        `别等翻车才后悔：${selTitle}，1分钟把它讲明白。`,
        `你以为是小事？${selTitle}一翻车，整场氛围直接掉线。`,
        `同城婚礼最常见的尴尬：${selTitle}，今天教你稳住。`
      ]);
      return rnd([
        `婚礼${stage}最容易翻车的，往往不是大事，是“${pain}”这种小细节。`,
        `我见过太多人在“${pain}”上踩坑，结果想${benefit}反而更尴尬。`,
        `如果你只记住一句话：${pain}先对齐，后面90%都顺。`
      ]);
    })();

    const trust = (()=>{
      const base = [
        `我给你一个“可照读”的控场写法：一句话把人、音乐、灯光、镜头拉到同一个点。`,
        `新手最怕临场乱：今天给你一套“责任人 + 时间点 + 口令”的固定模板。`,
        `别靠灵感，靠流程。你只要照做，就能更${benefit || "稳"}。`
      ];
      if (tone.includes("情绪")) base.unshift(`说实话，${pain}一出问题，现场真的尬到脚趾抠地。`);
      if (tone.includes("专业")) base.unshift(`我把${pain}拆成标准动作，照做就稳。`);
      return rnd(base);
    })();

    const stepsByAngle = {
      "避雷清单": [
        {k:"坑1：责任人不清", say:`不要问“谁来一下”，直接点名：酒店经理/灯光师/摄影主机位。`, line:`口令示范：酒店老师麻烦“现在关主灯”，灯光老师准备“追光跟新人”，摄影老师“机位锁定通道”。`, sub:`字幕：先点名，再下口令`},
        {k:"坑2：时间点不锁", say:`所有动作都要带“时间点”：音乐起前/人上场前/灯光切前。`, line:`口令示范：音乐前3秒就位，门帘一开立刻走；我数“3、2、1”，灯光切。`, sub:`字幕：动作=时间点+口令`},
        {k:"坑3：口令太长", say:`口令越长越乱。记住：一句给结果，两句给方法，三句就收。`, line:`口令示范：现在“就位—停—看我手势”。听到“走”，立刻推进。`, sub:`字幕：短口令=更稳`},
      ],
      "口令模板": [
        {k:"口令1：新人入场", say:`目标：让音乐/灯光/镜头同时到位。`, line:`口令示范：音乐起——追光跟通道——摄影推到中景——我数3秒，门开。`, sub:`字幕：入场=音乐+灯光+镜头+门`},
        {k:"口令2：戒指/誓言", say:`目标：把“情绪”留给新人，把“节奏”交给你。`, line:`口令示范：音乐降到30%，摄影给手部特写；我停2秒，让新人说完再上音乐。`, sub:`字幕：誓言=停顿+降噪+特写`},
        {k:"口令3：合影收场", say:`目标：不排队炸裂，一次到位。`, line:`口令示范：家长站两侧，新人中间，伴郎伴娘靠后；摄影老师“3、2、1”抓拍，我用手势统一看镜头。`, sub:`字幕：合影=站位+手势+倒数`},
      ],
      "时间轴拆解": [
        {k:"节点1：开场前5分钟", say:`把“签到/入座/灯光/音乐”统一到一个开关。`, line:`口令示范：现在请酒店“提示入座”，音乐换暖场BGM，灯光切到暖色，摄影先拍宾客表情。`, sub:`字幕：开场前=入座+氛围`},
        {k:"节点2：入场前30秒", say:`只做一件事：确认“通道/门/机位/音乐起点”。`, line:`口令示范：通道清空—门帘准备—机位锁定—音乐从00:12起。`, sub:`字幕：入场前=四确认`},
        {k:"节点3：礼成前1分钟", say:`提前把“退场曲/合影/敬酒路线”说清。`, line:`口令示范：礼成掌声后切退场曲，摄影转到大合影位；酒店安排敬酒动线从主桌开始。`, sub:`字幕：礼成=退场+合影+动线`},
      ],
      "对比案例": [
        {k:"错误做法", say:`主持人一直讲话，音乐/灯光/镜头各做各的。`, line:`结果：新人尴尬、宾客没反应、出片全废。`, sub:`字幕：错=多说+不对齐`},
        {k:"正确做法", say:`你只说“一个口令”，把全场拉到同一点。`, line:`口令示范：音乐降，追光跟，新人停两秒；我说“现在，看彼此”。`, sub:`字幕：对=短口令+停顿`},
        {k:"加分细节", say:`每个情绪点都留“空白”。`, line:`做法：说完一句话停1秒，让掌声自己起来。`, sub:`字幕：留白=氛围`},
      ],
      "行业真话": [
        {k:"真话1", say:`90%的翻车不是新人，是“对接没写清”。`, line:`做法：把责任人/时间点/口令写在备忘录，现场直接读。`, sub:`字幕：写下来=不翻车`},
        {k:"真话2", say:`酒店最怕拖时，你越犹豫越被催。`, line:`做法：提前给酒店一个“可执行时间轴”，你就能控场。`, sub:`字幕：时间轴=底气`},
        {k:"真话3", say:`摄影摄像抢位不是故意，是你没给“主机位规则”。`, line:`口令示范：主机位固定在通道正前，其他机位左右不跨线。`, sub:`字幕：规则=不打架`},
      ],
      "酒店协同": [
        {k:"一句话对齐", say:`先给酒店“结果”，再给“时间”。`, line:`沟通模板：我们按60分钟走完仪式，关键节点我会提前30秒提示你。`, sub:`字幕：先结果后时间`},
        {k:"催场怎么办", say:`别解释，直接给替代方案。`, line:`口令示范：上菜先走前两道，仪式到戒指后再上主菜。`, sub:`字幕：被催=给方案`},
        {k:"最强一句", say:`把“配合”变成“好处”。`, line:`沟通模板：流程顺，宾客满意，酒店口碑也更好，我们一起把现场做漂亮。`, sub:`字幕：共赢=更配合`},
      ],
      "五大金刚协同": [
        {k:"先定主机位", say:`主机位不定，镜头就乱。`, line:`口令示范：主机位通道正前不动，副机位左右补，灯光跟主机位方向。`, sub:`字幕：主机位=标准`},
        {k:"统一口令", say:`谁都别用“我觉得”，只用“口令”。`, line:`口令示范：我说“走”，摄影推进；我说“停”，灯光定格；我说“切”，音乐切点。`, sub:`字幕：口令=统一语言`},
        {k:"备选方案", say:`任何环节都要有B计划。`, line:`做法：麦坏了就切手麦；音乐找不到就切备用歌单；下雨就切室内位。`, sub:`字幕：B计划=稳`},
      ],
      "新人视角": [
        {k:"别硬背誓言", say:`把誓言改成“3句话结构”。`, line:`模板：谢谢你（回忆）→ 我选择你（承诺）→ 我们一起（未来）。`, sub:`字幕：誓言=3句话`},
        {k:"情绪起不来", say:`用一个“问题”把情绪打开。`, line:`主持引导：你最想对TA说的那句话是什么？说完我们停2秒。`, sub:`字幕：问题=情绪开关`},
        {k:"怕尴尬", say:`把互动交给动作，不交给话。`, line:`动作：牵手—看彼此—拥抱—再说一句。`, sub:`字幕：动作=不尬`},
      ],
      "来宾视角": [
        {k:"来宾不入座", say:`你要给“明确指令+收益”。`, line:`口令：请大家先入座，入座后我们马上开始新人入场，错过就拍不到精彩。`, sub:`字幕：指令+收益`},
        {k:"掌声不上来", say:`你要先“示范”。`, line:`口令：如果你也为他们开心，给他们一个掌声——我先带头！`, sub:`字幕：示范=掌声`},
        {k:"合影太乱", say:`把来宾当“队伍”管理。`, line:`口令：请第一排起立到舞台前，第二排往后半步，第三排站椅子后。`, sub:`字幕：合影=分层`},
      ],
    };

    const steps = stepsByAngle[angle] || stepsByAngle["口令模板"];

    // 根据时长决定展开程度
    const maxSteps = (len==="45秒") ? 2 : (len==="60秒") ? 3 : 3;
    const extraLine = (len==="90秒") ? `补充：把“责任人+时间点+口令”写到 Cue Sheet，临场照读就不乱。` : "";

    const body = steps.slice(0, maxSteps).map((s, idx)=>{
      const head = `第${idx+1}点：${s.k}。${s.say}`;
      const line = s.line ? `
— ${s.line}` : "";
      const sub = s.sub ? `
（字幕：${s.sub}）` : "";
      return head + line + sub;
    }).join("\n\n");

    const closeLine = `结尾一句话：${pain}先对齐，氛围就稳。${cta}`;

    // 拼装逐字稿（带时间轴）
    let script = "";
    if (len==="45秒"){
      script = [
        `${timeMap[0]} ${hook}`,
        `${timeMap[1]} ${trust}`,
        `${timeMap[2]} ${body}`,
        `${timeMap[3]} ${closeLine}`
      ].join("\n\n");
    } else if (len==="90秒"){
      script = [
        `${timeMap[0]} ${hook}`,
        `${timeMap[1]} ${trust}`,
        `${timeMap[2]} 先给你一个原则：责任人+时间点+口令，三样齐了就不乱。`,
        `${timeMap[3]} ${body}`,
        `${timeMap[4]} ${extraLine}`,
        `${timeMap[5]} ${closeLine}`
      ].join("\n\n");
    } else {
      script = [
        `${timeMap[0]} ${hook}`,
        `${timeMap[1]} ${trust}`,
        `${timeMap[2]} 记住：口令要短，动作要清，停顿要敢。`,
        `${timeMap[3]} ${body}`,
        `${timeMap[4]} ${closeLine}`
      ].join("\n\n");
    }

    // 形态适配
    if (form.includes("现场切片")) {
      script += `

（画面建议：用现场素材做“错误/正确对比”，同一段音乐点位对比最有效。）`;
    } else if (form.includes("对话短剧")) {
      script += `

（短剧结构：A乱指挥→B一句口令对齐→全场立刻稳→结尾抛问题引评论。）`;
    } else if (form.includes("清单图文")) {
      script += `

（图文结尾：把每点浓缩成“清单截图”，提示“收藏备用”。）`;
    }

    // 加一点长度（避免看起来像“只换标题”）
    if (script.length < 520 && len !== "45秒") {
      script += "\n\n补一句：临场不要拼“话术”，拼“指挥”。你越短越稳，越稳越高级。";
    }

    return script;
  }

  function buildShots(vars){
    const form = vars.form;
    const pain = vars.pain;
    const benefit = vars.benefit;
    const style = vars.style;

    const shots = [];
    if (form.includes("口播")) {
      shots.push("1) 近景正脸：前三秒直接抛痛点（字幕大字：别让「"+pain+"」毁氛围）");
      shots.push("2) 中景：讲“翻车画面”一句话（可配B-roll：现场走位/合影/敬酒）");
      shots.push("3) 近景：三步法第1步（字幕：谁负责）");
      shots.push("4) 近景：三步法第2步（字幕：什么时候做）");
      shots.push("5) 近景：三步法第3步（字幕：一句口令）");
      shots.push("6) 结尾：给观众动作（收藏/评论/私信），补一句收益（"+benefit+"）");
    } else if (form.includes("现场切片")) {
      shots.push("1) 现场“翻车瞬间”2秒：字幕【错误示范："+pain+"】");
      shots.push("2) 主持/工作人员旁白：解释为什么尬");
      shots.push("3) 切正确做法：字幕【正确做法：先对齐责任+时间】");
      shots.push("4) 口令出现：字幕大字显示口令");
      shots.push("5) 氛围回稳镜头：掌声/笑声/灯光切换");
      shots.push("6) 结尾清单截图：三步法+提醒收藏");
    } else if (form.includes("对话短剧")) {
      shots.push("1) 角色A：临场乱指挥（字幕：你先这样…）");
      shots.push("2) 角色B：打断（字幕：停！先对齐"+pain+"）");
      shots.push("3) B三句口令：责任人/时间点/动作标准");
      shots.push("4) A尴尬：原来要这样（字幕：学到了）");
      shots.push("5) B总结：三步法清单");
      shots.push("6) 结尾：评论区留“你在哪一步最怕翻车”");
    } else {
      shots.push("1) 封面："+style+"｜"+pain+"避雷清单");
      shots.push("2) 卡片1：翻车原因（1句话）");
      shots.push("3) 卡片2：三步法（责任人/时间点/口令）");
      shots.push("4) 卡片3：备用方案（B计划）");
      shots.push("5) 卡片4："+benefit+"的加分细节");
      shots.push("6) 结尾：收藏+评论关键词领取模板");
    }

    return shots.join("\n");
  }

  function buildSubtitles(vars){
    const pain = vars.pain;
    const benefit = vars.benefit;
    const stage = vars.stage;
    const list = [
      `婚礼${stage}最容易翻车：${pain}`,
      `想${benefit}，别靠运气，靠流程`,
      `① 谁负责（别互相甩锅）`,
      `② 什么时候做（节点卡死）`,
      `③ 一句口令（人/物/音乐/镜头对齐）`,
      `备用方案：切B计划，不解释不犹豫`,
      `现场说话：短、准、收`,
      `收藏=婚礼当天直接用`
    ];
    return list.map((x,i)=>`${i+1}. ${x}`).join("\n");
  }

  function buildTags(platform, vars){
    const base = ["#婚礼", "#备婚", "#婚礼流程", "#婚礼避雷", "#婚礼主持", "#婚礼控场", "#婚礼干货", "#同城婚礼"];
    const persona = vars.persona;
    const style = vars.style;
    const stage = vars.stage;
    const pain = vars.pain;
    const city = (vars.city||"").trim();

    const extra = [
      "#"+style, "#"+stage, "#"+persona.replace(/\s+/g,""),
      "#"+pain.replace(/[^\u4e00-\u9fa5A-Za-z0-9]/g,"")
    ];

    const out = [];
    (base.concat(extra)).forEach(t=>{
      if (!t || t.length<2) return;
      if (!out.includes(t)) out.push(t);
    });

    if (platform === "xhs") {
      // XHS prefers keyword phrases
      if (city) out.push("#"+city);
      out.push("#婚礼清单");
      out.push("#备婚清单");
    } else {
      if (city) out.push("#"+city+"婚礼");
      out.push("#婚礼现场");
    }
    return out.slice(0, 12).join(" ");
  }

  function buildLocation(vars){
    const city = (vars.city||"").trim();
    const venue = (vars.venue||"").trim();
    if (city && venue) return `定位：${city} · ${venue}\n（同城建议：发布时再二次确认酒店定位是否可搜）`;
    if (city) return `定位：${city}\n（同城建议：尽量用“城市+婚礼/酒店”可检索的地点）`;
    if (venue) return `定位：${venue}\n（建议：能搜到的商家/场地更容易同城触达）`;
    return "定位：发布所在城市 + 真实酒店/宴会厅（能搜到的地点优先）";
  }

  function buildComments(vars){
    const goal = vars.goal;
    const pain = vars.pain;
    const benefit = vars.benefit;

    const pin = (goal==="私信咨询")
      ? `置顶：想要【${pain}】的“口令模板+清单”，私信我：流程`
      : (goal==="评论互动")
      ? `置顶：你最怕哪一步翻车？评论区打“${pain}”，我按你情况给你改一版。`
      : (goal==="关注")
      ? `置顶：关注我，婚礼全流程控场细节每天拆一条（新人/酒店/摄影都能用）。`
      : (goal==="同城引流")
      ? `置顶：同城的朋友评论“同城”，我按本地酒店节奏给你更贴合的版本。`
      : `置顶：这条先收藏，婚礼当天真的用得上（${benefit}）。`;

    const replies = [
      `回复1：你说的这个情况很常见，关键是把“责任人+时间点+口令”写出来，临场照做就稳。`,
      `回复2：如果你们是${vars.style}风格，我建议音乐点位也一起对齐，氛围会更高级。`,
      `回复3：要不要我按你家酒店流程改？把“城市+酒店+时间”发我。`
    ];

    return [pin].concat(replies.map((x,i)=>`回复${i+1}：${x}`)).join("\n");
  }

  function buildDeliverable(pkg){
    const head = `【${pkg.platformName}】${pkg.meta}\n模板：${pkg.tplName}\n\n`;
    const block = [
      `【封面钩子】\n${pkg.cover}`,
      `【标题】\n${pkg.titles}`,
      `【前三秒】\n${pkg.hook}`,
      `【爆款结构】\n${pkg.structure}`,
      `【逐字稿】\n${pkg.copy}`,
      `【镜头脚本】\n${pkg.shots}`,
      `【字幕要点】\n${pkg.subtitles}`,
      `【标签】\n${pkg.tags}`,
      `【定位】\n${pkg.location}`,
      `【评论引导】\n${pkg.comments}`
    ].join("\n\n");
    return head + block;
  }

  function buildPackage(platform, vars){
    const preferred = platform==="douyin" ? (state.socialGenTpl?.dy || "auto") : (state.socialGenTpl?.xhs || "auto");
    const letter = pickTpl(platform, preferred);
    const cover = buildCover(platform, vars);
    let titlesArr = genTitles(platform, vars);

    // 如果你从“标题库”带入，则优先把该标题放进输出，并让后续内容跟着角度走
    const selTitle = String(state.socialSelectedTitleText||"").trim();
    const selPlat  = String(state.socialSelectedTitlePlatform||"").trim();
    const useSel = selTitle && (!selPlat || selPlat===platform);
    if (useSel){
      const more = [
        selTitle,
        selTitle.replace(/：/g,"｜"),
        selTitle + "（直接照做）",
        selTitle + "（模板版）",
        selTitle + "：一句口令搞定",
        "别再" + selTitle.replace(/^别再/,""),
      ];
      const set = new Set();
      more.forEach(x=>x && set.add(x));
      titlesArr.forEach(x=>set.add(x));
      titlesArr = Array.from(set).slice(0,10);
    }
    const titles = titlesArr.map((t,i)=>`${i+1}. ${t}`).join("\n");
    const hook = buildHookLine(vars);
    const structure = buildStructure(platform, letter);
    const copy = buildScript(platform, vars, letter);
    const shots = buildShots(vars);
    const subtitles = buildSubtitles(vars);
    const tags = buildTags(platform, vars);
    const location = buildLocation(vars);
    const comments = buildComments(vars);

    const platformName = platform==="douyin" ? "抖音" : "小红书";
    const tplName = platform==="douyin" ? `抖音${letter}` : `小红书${letter}`;
    const meta = `${vars.persona} · ${vars.stage} · ${vars.style} · ${vars.len} · 目标：${vars.goal}`;

    const pkg = { platform, platformName, tplName, meta, cover, titles, hook, structure, copy, shots, subtitles, tags, location, comments };
    pkg.deliverable = buildDeliverable(pkg);
    return pkg;
  }

  function setOutputs(pkgOrBoth){
    const both = Array.isArray(pkgOrBoth) ? pkgOrBoth : [pkgOrBoth];
    const join = (key)=>{
      return both.map(p=>`【${p.platformName}】\n${p[key]}`).join("\n\n");
    };
    $("#outCover").value = join("cover");
    $("#outTitles").value = join("titles");
    $("#outHook").value = join("hook");
    $("#outStructure").value = join("structure");
    $("#outCopy").value = join("copy");
    $("#outShots").value = join("shots");
    $("#outSubtitles").value = join("subtitles");
    $("#outTags").value = join("tags");
    $("#outLocation").value = join("location");
    $("#outComments").value = join("comments");

    const allCopy = both.map(p=>p.deliverable).join("\n\n========================\n\n");
    // counts
    const txt = $("#outCopy").value || "";
    $("#outCopyCount").textContent = `（约${txt.length}字）`;
    $("#outTitleCount").textContent = `（共${($("#outTitles").value||"").split("\n").filter(Boolean).length}条）`;

    // store last package for save/copy
    window.__LAST_SOCIAL_PKG__ = { both, allCopy };
  }

  // Override bindGenerator (full version)
  function bindGenerator(){
    // template bar binding
    const dyBar = $("#dyTplBar");
    const xhBar = $("#xhsTplBar");
    dyBar?.addEventListener("click", (e)=>{
      const b = e.target.closest("[data-set-dy]");
      if (!b) return;
      const v = b.getAttribute("data-set-dy");
      dyBar.querySelectorAll(".pillbtn").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      setDyTpl(v);
    });
    xhBar?.addEventListener("click", (e)=>{
      const b = e.target.closest("[data-set-xhs]");
      if (!b) return;
      const v = b.getAttribute("data-set-xhs");
      xhBar.querySelectorAll(".pillbtn").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      setXhsTpl(v);
    });

    // restore active
    setTplActive("dyTplBar", "data-set-dy", state.socialGenTpl?.dy || "auto");
    setTplActive("xhsTplBar", "data-set-xhs", state.socialGenTpl?.xhs || "auto");

    $("#genFromTopic")?.addEventListener("click", ()=> fillGeneratorFromTopic(state.socialLastTopic, true));

    const run = ()=>{
      const platformSel = $("#genPlatform").value;
      const personaKey = $("#genPersona").value;
      const vars = {
        platform: platformSel,
        persona: personaNameByKey(personaKey),
        stage: $("#genStage").value,
        style: $("#genStyle").value,
        tone: $("#genTone").value,
        pain: ($("#genPain").value || "").trim() || rnd(GEN.pains),
        benefit: ($("#genBenefit").value || "").trim() || rnd(GEN.benefits),
        goal: $("#genGoal").value,
        len: $("#genLen").value,
        form: $("#genForm").value,
        city: ($("#genCity").value || "").trim(),
        venue: ($("#genVenue").value || "").trim()
      };

      let pkgs = [];
      if (platformSel === "both"){
        pkgs = [ buildPackage("douyin", vars), buildPackage("xhs", vars) ];
      } else if (platformSel === "xhs"){
        pkgs = [ buildPackage("xhs", vars) ];
      } else {
        pkgs = [ buildPackage("douyin", vars) ];
      }
      setOutputs(pkgs);
      toast("已生成完整版 ✅");
    };

    $("#genBtn")?.addEventListener("click", run);
    $("#genRandom")?.addEventListener("click", ()=>{
      $("#genPain").value = rnd(GEN.pains);
      $("#genBenefit").value = rnd(GEN.benefits);
      toast("已随机一组灵感 ✨");
    });

    $("#btnCopyAll")?.addEventListener("click", ()=>{
      const allCopy = window.__LAST_SOCIAL_PKG__?.allCopy || "";
      if (!allCopy) { toast("先生成一条再复制"); return; }
      copyToClipboard(allCopy);
    });

    $("#btnSaveIdea")?.addEventListener("click", saveIdea);

    $("#btnClearIdeas")?.addEventListener("click", ()=>{
      /* no confirm */
      state.socialIdeas = [];
      save(state);
      renderIdeas();
      toast("已清空 🧹");
    });

    $("#btnExportIdeas")?.addEventListener("click", exportIdeas);
    $("#btnImportIdeas")?.addEventListener("click", ()=> $("#ideaImportFile")?.click());
    $("#ideaImportFile")?.addEventListener("change", importIdeasFromFile);

    // selected title
    $("#btnClearSelTitle")?.addEventListener("click", ()=>{
      state.socialSelectedTitleText = "";
      state.socialSelectedTitlePlatform = "";
      state.socialSelectedTitleAngle = "";
      save(state);
      updateSelTitleUI();
      toast("已清除已选标题");
    });

    // initial render
    updateSelTitleUI();
    renderIdeas();
  }

  function saveIdea(){
    const last = window.__LAST_SOCIAL_PKG__?.both;
    const allCopy = window.__LAST_SOCIAL_PKG__?.allCopy || "";
    if (!last || !last.length) { toast("先生成一条再保存"); return; }

    const idea = {
      id: "idea_" + Date.now(),
      ts: new Date().toISOString(),
      inputs: {
        platform: $("#genPlatform").value,
        persona: $("#genPersona").value,
        stage: $("#genStage").value,
        style: $("#genStyle").value,
        pain: ($("#genPain").value||"").trim(),
        benefit: ($("#genBenefit").value||"").trim(),
        tone: $("#genTone").value,
        goal: $("#genGoal").value,
        len: $("#genLen").value,
        form: $("#genForm").value,
        city: ($("#genCity").value||"").trim(),
        venue: ($("#genVenue").value||"").trim(),
        tpl: {...(state.socialGenTpl||{dy:"auto", xhs:"auto"})}
      },
      packages: last,
      allCopy
    };

    state.socialIdeas = state.socialIdeas || [];
    state.socialIdeas.push(idea);
    save(state);
    renderIdeas();
    toast("已保存到素材库 ✅");
  }

  function ideaMetaText(idea){
    const inp = idea.inputs || {};
    const platformName = inp.platform==="both" ? "抖音+小红书" : (inp.platform==="xhs" ? "小红书" : "抖音");
    const personaName = SOCIAL_DATA.personas[inp.persona]?.title || inp.persona || "婚礼视角";
    return `${platformName} · ${personaName} · ${inp.stage||""} · ${inp.style||""} · ${inp.len||""} · 目标：${inp.goal||""}`;
  }

  function exportIdeas(){
    const data = {
      version: 2,
      exportedAt: new Date().toISOString(),
      ideas: state.socialIdeas || []
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `自媒体素材库_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
    toast("已导出 ✅");
  }

  function importIdeasFromFile(e){
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const obj = JSON.parse(String(reader.result||"{}"));
        const ideas = Array.isArray(obj.ideas) ? obj.ideas : (Array.isArray(obj) ? obj : []);
        if (!ideas.length) { toast("导入失败：文件里没有素材"); return; }
        const mode = true; /* default merge */
        if (mode){
          // merge (avoid id collision)
          const existed = new Set((state.socialIdeas||[]).map(x=>x.id));
          ideas.forEach(it=>{
            if (!it.id || existed.has(it.id)) it.id = "idea_" + Date.now() + "_" + Math.floor(Math.random()*9999);
            state.socialIdeas.push(it);
          });
        } else {
          state.socialIdeas = ideas;
        }
        save(state);
        renderIdeas();
        toast("导入成功 ✅");
      } catch(err){
        toast("导入失败：不是有效JSON");
      } finally{
        e.target.value = "";
      }
    };
    reader.readAsText(file, "utf-8");
  }

  let __EDIT_IDEA_ID__ = null;
  function openIdeaModal(idea){
    __EDIT_IDEA_ID__ = idea?.id || null;
    $("#ideaModal").classList.add("show");
    $("#ideaEditTitles").value = (idea?.allCopy ? extractBlock(idea.allCopy, "【标题】") : "") || (idea?.packages?.[0]?.titles || "");
    $("#ideaEditCopy").value = (idea?.allCopy ? extractBlock(idea.allCopy, "【逐字稿】") : "") || (idea?.packages?.[0]?.copy || "");
    $("#ideaEditShots").value = (idea?.allCopy ? extractBlock(idea.allCopy, "【镜头脚本】") : "") || (idea?.packages?.[0]?.shots || "");
    $("#ideaEditTags").value = (idea?.allCopy ? extractBlock(idea.allCopy, "【标签】") : "") || (idea?.packages?.[0]?.tags || "");
  }
  function closeIdeaModal(){
    __EDIT_IDEA_ID__ = null;
    $("#ideaModal").classList.remove("show");
  }

  function extractBlock(text, header){
    // tries to extract between header and next 【
    const i = text.indexOf(header);
    if (i<0) return "";
    const rest = text.slice(i + header.length);
    const j = rest.search(/\n\s*\n【/);
    const block = (j>=0 ? rest.slice(0, j) : rest).trim();
    return block.replace(/^\s*\n/, "");
  }

  $("#ideaModalClose")?.addEventListener("click", closeIdeaModal);
  $("#ideaEditCancel")?.addEventListener("click", closeIdeaModal);
  $("#ideaModal")?.addEventListener("click", (e)=>{
    if (e.target && (e.target.classList?.contains("modal-backdrop") || e.target.hasAttribute?.("data-idea-close"))) closeIdeaModal();
  });

  $("#ideaEditSave")?.addEventListener("click", ()=>{
    if (!__EDIT_IDEA_ID__) return closeIdeaModal();
    const idx = (state.socialIdeas||[]).findIndex(x=>x.id===__EDIT_IDEA_ID__);
    if (idx<0) return closeIdeaModal();
    const it = state.socialIdeas[idx];

    // Update the first package fields (best-effort)
    const titles = $("#ideaEditTitles").value.trim();
    const copy = $("#ideaEditCopy").value.trim();
    const shots = $("#ideaEditShots").value.trim();
    const tags = $("#ideaEditTags").value.trim();

    // If it has packages, update all packages titles/copy/shots/tags (keep platform labels)
    if (Array.isArray(it.packages)){
      it.packages = it.packages.map(p=>({
        ...p,
        titles: titles || p.titles,
        copy: copy || p.copy,
        shots: shots || p.shots,
        tags: tags || p.tags
      }));
      // rebuild allCopy
      it.allCopy = it.packages.map(p=>{
        const pkg2 = {...p};
        pkg2.deliverable = buildDeliverable(pkg2);
        return pkg2.deliverable;
      }).join("\n\n========================\n\n");
    } else if (it.allCopy) {
      // fallback: just replace blocks in allCopy
      let txt = it.allCopy;
      const replace = (hdr, val)=>{
        if (!val) return;
        const re = new RegExp(hdr + "[\\s\\S]*?(?=\\n\\s*\\n【|$)", 'm');
        txt = txt.replace(re, hdr + "\n" + val + "\n");
      };
      replace("【标题】", titles);
      replace("【逐字稿】", copy);
      replace("【镜头脚本】", shots);
      replace("【标签】", tags);
      it.allCopy = txt;
    }

    state.socialIdeas[idx] = it;
    save(state);
    renderIdeas();
    toast("已保存修改 ✅");
    closeIdeaModal();
  });

  function fillGeneratorFromIdea(idea){
    const inp = idea.inputs || {};
    if ($("#genPlatform")) $("#genPlatform").value = inp.platform || "douyin";
    if ($("#genPersona")) $("#genPersona").value = inp.persona || "host";
    if ($("#genStage")) $("#genStage").value = inp.stage || "婚礼当天";
    if ($("#genStyle")) $("#genStyle").value = inp.style || "轻奢";
    if ($("#genPain")) $("#genPain").value = inp.pain || "";
    if ($("#genBenefit")) $("#genBenefit").value = inp.benefit || "";
    if ($("#genTone")) $("#genTone").value = inp.tone || "情绪更狠（抖音适配）";
    if ($("#genGoal")) $("#genGoal").value = inp.goal || "收藏";
    if ($("#genLen")) $("#genLen").value = inp.len || "60秒";
    if ($("#genForm")) $("#genForm").value = inp.form || "口播（最稳）";
    if ($("#genCity")) $("#genCity").value = inp.city || "";
    if ($("#genVenue")) $("#genVenue").value = inp.venue || "";

    if (inp.tpl?.dy) setDyTpl(inp.tpl.dy);
    if (inp.tpl?.xhs) setXhsTpl(inp.tpl.xhs);

    toast("已回填到生成器 ✅");
    const gen = document.getElementById("smGen");
    if (gen) gen.scrollIntoView({behavior:"smooth", block:"start"});
  }

  function renderIdeas(){
    const wrap = $("#ideaList");
    if (!wrap) return;
    const list = (state.socialIdeas || []).slice().reverse();

    if (!list.length) {
      wrap.innerHTML = `<div class="muted">暂无素材。去上面“生成完整版”→“保存到素材库”。</div>`;
      return;
    }

    wrap.innerHTML = list.map((it)=>{
      const when = new Date(it.ts || Date.now()).toLocaleString();
      const meta = ideaMetaText(it);
      return `
        <div class="idea" data-idea-id="${it.id}">
          <div class="top">
            <div>
              <div style="font-weight:900">${meta}</div>
              <div class="meta">${when}</div>
            </div>
            <div class="act">
              <button class="sbtn" data-idea-act="copy">复制整条</button>
              <button class="sbtn" data-idea-act="fill">回填生成器</button>
              <button class="sbtn" data-idea-act="edit">编辑</button>
              <button class="sbtn" data-idea-act="del">删除</button>
            </div>
          </div>
          <pre>${(it.allCopy || it.packages?.map(p=>p.deliverable).join("\n\n========================\n\n") || "").replace(/</g,"&lt;")}</pre>
        </div>
      `;
    }).join("");

    wrap.querySelectorAll("[data-idea-act]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const act = btn.getAttribute("data-idea-act");
        const card = btn.closest("[data-idea-id]");
        const id = card?.getAttribute("data-idea-id");
        const idea = (state.socialIdeas||[]).find(x=>x.id===id);
        if (!idea) return;

        if (act==="copy"){
          copyToClipboard(idea.allCopy || "");
        } else if (act==="fill"){
          fillGeneratorFromIdea(idea);
        } else if (act==="edit"){
          openIdeaModal(idea);
        } else if (act==="del"){
          /* no confirm */
          state.socialIdeas = (state.socialIdeas||[]).filter(x=>x.id!==id);
          save(state);
          renderIdeas();
          toast("已删除");
        }
      });
    });
  }


  /* =========================================================
     Upgrade vNext: More Inspirations + Title Library + Music System
     ========================================================= */

  // ---- 1) Expand random inspirations (pain/benefit) ----
  (function expandInspirations(){
    const addP = ["新人紧张忘词", "主持卡壳", "话筒啸叫/炸麦", "音响延迟", "音乐起错/提前", "灯光切错", "追光找不到人", "大屏/LED失灵", "入场走位乱", "新人站位不对", "裙摆踩住", "头纱勾住", "戒指盒打不开", "戒指戴不上", "手捧花丢了", "花童乱跑", "誓词太长", "告白尴尬", "证婚人迟到", "父母发言太长", "父母情绪失控", "来宾起哄", "红包环节拖沓", "敬酒路线乱", "上菜太快/太慢", "酒店催流程", "台上太挤", "合影排队乱", "合影站位尬", "嘉宾迟到", "车队堵车", "接亲延误", "下雨预案缺失", "户外风大", "温度太冷/太热", "烟花/礼炮不响", "香槟塔洒了", "蛋糕切不动", "摄影抢位影响仪式", "摄像遮挡新人", "跟拍没沟通", "机位不够", "无人机临时禁飞", "主持和策划不同步", "总控不在场", "对讲机没电", "流程单没更新", "临时加环节", "长辈坚持旧习俗", "亲戚插话", "伴郎伴娘不配合", "小朋友哭闹", "时间超时", "现场冷场", "音乐节奏不对", "氛围拉不起来", "台词太油", "互动失控", "收口不体面", "背景噪音大", "舞台回声", "宾客走动频繁", "迎宾区拥堵", "签到混乱", "座位找不到", "敬酒时间太久", "开席太晚", "新人饿/渴", "妆花了", "临时补妆找不到人", "礼物/回礼缺失", "手卡丢了", "U盘坏了", "备用麦克风没准备"];
    const addB = ["不翻车", "省心省力", "全程丝滑", "控场更稳", "气氛拉满", "更高级更体面", "父母满意", "宾客不无聊", "流程更顺", "更出片", "更好拍", "视频更高级", "节奏更舒服", "更好听", "更有仪式感", "更有记忆点", "互动刚刚好", "不尬不油", "时间更准", "效率更高", "不被酒店催", "不超时", "省预算", "不加价", "好评更多", "转化更高", "私信更多", "同城更容易爆", "评论更活跃", "收藏更多", "新人更安心", "长辈更有面子", "团队协作更顺", "现场更专业", "细节更周到", "临场更从容"];
    if (typeof GEN !== "undefined") {
      GEN.pains = Array.from(new Set((GEN.pains||[]).concat(addP)));
      GEN.benefits = Array.from(new Set((GEN.benefits||[]).concat(addB)));
      // Extra title patterns (more variation)
      GEN.titlePatterns.douyin = (GEN.titlePatterns.douyin||[]).concat([
        "{role}现场真相：{pain}一发生，立刻掉档次（{m}秒解决）",
        "婚礼想{benefit}？先别急着花钱，把{pain}这一步做到位",
        "别被酒店牵着走：{style}{stage}控场口令（解决{pain}）",
        "{role}教你一句话压住场：专治{pain}",
        "{stage}最怕的不是贵，是{pain}（{m}个动作稳住）",
        "我靠这套流程，{pain}几乎不再出现（{role}必学）"
      ]);
      GEN.titlePatterns.xhs = (GEN.titlePatterns.xhs||[]).concat([
        "【模板】{style}{stage}避免{pain}的对齐话术（可直接用）",
        "婚礼{stage}想{benefit}：{m}个细节（建议收藏）",
        "{role}工作流：如何避免{pain}（一张清单搞定）",
        "婚礼现场{pain}怎么办？我给你{m}步解决方案",
        "把{pain}写进流程单：{benefit}又省心"
      ]);
      // More hook lines
      GEN.hooks.狠 = (GEN.hooks.狠||[]).concat([
        "你以为是小事？{pain}一出问题，氛围瞬间塌。",
        "别拿婚礼当试错：{pain}踩一次就难看。",
        "真的，{pain}这一步，80%的人会翻。"
      ]);
      GEN.hooks.藏 = (GEN.hooks.藏||[]).concat([
        "这条是“婚礼当天救命卡”：关于{pain}，建议收藏。",
        "我把{pain}整理成清单，你们照着做就稳。"
      ]);
    }
  })();

  // ---- 2) Title Library (search / favorite / fill generator) ----
  const TITLE_LIB = {
    inited: false,
    pool: [], // {id, platform, personaKey, persona, stage, style, tone, tpl, text}
    showFavs: false
  };

  function suggestTpl(platform, tone){
    const t = String(tone||"");
    if (platform==="douyin"){
      if (t.includes("情绪")) return "A";
      if (t.includes("故事")) return "C";
      if (t.includes("专业")) return "D";
      return "B";
    } else {
      if (t.includes("收藏")) return "X";
      if (t.includes("故事")) return "Z";
      if (t.includes("专业")) return "Y";
      return "W";
    }
  }

  function getRoleName(personaKey, platform){
    const title = SOCIAL_DATA?.personas?.[personaKey]?.title || "婚礼视角";
    if (platform==="douyin") return title;
    return title + "视角";
  }

  function makeTitle(platform, personaKey, stage, style, tone){
    const role = getRoleName(personaKey, platform);
    const pain = rnd(GEN.pains);
    const benefit = rnd(GEN.benefits);
    const n = 10 + Math.floor(Math.random()*120);
    const m = 3 + Math.floor(Math.random()*9);
    const tpl = suggestTpl(platform, tone);

    const patterns = (GEN.titlePatterns?.[platform] || []);
    const p = rnd(patterns);

    const text = p
      .replaceAll("{role}", role)
      .replaceAll("{pain}", pain)
      .replaceAll("{benefit}", benefit)
      .replaceAll("{stage}", stage)
      .replaceAll("{style}", style)
      .replaceAll("{n}", String(n))
      .replaceAll("{m}", String(m));

    return {
      id: "ttl_" + Date.now() + "_" + Math.floor(Math.random()*99999),
      platform, personaKey,
      persona: SOCIAL_DATA?.personas?.[personaKey]?.title || personaKey,
      stage, style, tone, tpl,
      pain, benefit,
      text
    };
  }

  function extractPainBenefitFromText(text){
    const t = String(text||"");
    let pain = "";
    let benefit = "";
    for (const p of (GEN.pains||[])) {
      if (p && t.includes(p)) { pain = p; break; }
    }
    for (const b of (GEN.benefits||[])) {
      if (b && t.includes(b)) { benefit = b; break; }
    }
    return {pain, benefit};
  }

  function inferAngleFromTitle(title, platform){
    const t = String(title||"");
    const pick = (arr)=> arr[Math.floor(Math.random()*arr.length)];
    const angles = ["避雷清单","口令模板","时间轴拆解","对比案例","行业真话","酒店协同","五大金刚协同","新人视角","来宾视角"];
    if (!t) return pick(angles);
    if (t.includes("避雷") || t.includes("别再") || t.includes("千万") || t.includes("不要")) return "避雷清单";
    if (t.includes("口令") || t.toLowerCase().includes("cue") || t.includes("点位") || t.includes("音乐")) return "口令模板";
    if (t.includes("时间轴") || t.includes("时间表") || t.includes("流程")) return "时间轴拆解";
    if (t.includes("对比") || t.includes("前后") || t.includes("翻车") || t.includes("尴尬")) return "对比案例";
    if (t.includes("真相") || t.includes("真话") || t.includes("内幕") || t.includes("别被")) return "行业真话";
    if (t.includes("酒店") || t.includes("厅") || t.includes("宴会")) return "酒店协同";
    if (t.includes("五大金刚") || t.includes("摄影") || t.includes("摄像") || t.includes("灯光") || t.includes("婚礼管家")) return "五大金刚协同";
    if (t.includes("新郎") || t.includes("新娘") || t.includes("新人")) return "新人视角";
    if (t.includes("来宾") || t.includes("宾客") || t.includes("亲友")) return "来宾视角";
    return pick(angles);
  }

  function updateSelTitleUI(){
    const box = $("#selTitleBox");
    const txt = $("#selTitleText");
    if (!box || !txt) return;
    const t = String(state.socialSelectedTitleText||"").trim();
    const p = String(state.socialSelectedTitlePlatform||"").trim();
    if (t){
      box.style.display = "block";
      txt.textContent = p ? `【${p==="douyin"?"抖音":"小红书"}】${t}` : t;
    } else {
      box.style.display = "none";
      txt.textContent = "";
    }
  }

  function titleFavs(){
    state.socialTitleFavs = state.socialTitleFavs || [];
    return state.socialTitleFavs;
  }

  function isFav(id){
    return titleFavs().some(x=>x.id===id);
  }

  function toggleFav(item){
    const favs = titleFavs();
    const i = favs.findIndex(x=>x.id===item.id);
    if (i>=0) favs.splice(i,1);
    else favs.push(item);
    state.socialTitleFavs = favs;
    save(state);
    updateFavCount();
  }

  function updateFavCount(){
    const el = $("#titleFavCount");
    if (el) el.textContent = String(titleFavs().length);
  }

  function getTitleFilters(){
    return {
      platform: $("#titlePlatform")?.value || "douyin",
      personaKey: $("#titlePersona")?.value || "host",
      stage: $("#titleStage")?.value || "婚礼当天",
      style: $("#titleStyle")?.value || "轻奢",
      tone: $("#titleTone")?.value || "情绪更狠（抖音适配）",
      q: ($("#titleSearch")?.value || "").trim()
    };
  }

  function getVisibleTitleList(){
    const f = getTitleFilters();
    const q = f.q;
    let list = TITLE_LIB.pool.slice();

    if (TITLE_LIB.showFavs) {
      list = titleFavs();
      // 收藏模式：只按平台/视角筛选，避免把收藏“藏起来”
      list = list.filter(x=>x.platform===f.platform && x.personaKey===f.personaKey);
    } else {
      // 普通模式：按当前筛选条件展示
      list = list.filter(x=>
        x.platform===f.platform &&
        x.personaKey===f.personaKey &&
        x.stage===f.stage &&
        x.style===f.style &&
        x.tone===f.tone
      );
    }

    if (q) {
      list = list.filter(x=> (x.text||"").includes(q) || (x.pain||"").includes(q) || (x.benefit||"").includes(q));
    }
    return list;
  }

  function renderTitleList(){
    const wrap = $("#titleList");
    if (!wrap) return;
    const list = getVisibleTitleList();

    $("#titleCount").textContent = `（当前 ${list.length} 条）`;

    if (!list.length) {
      wrap.innerHTML = `<div class="muted">暂无标题。点左侧“生成 50 条”，或取消“只看收藏”。</div>`;
      return;
    }

    wrap.innerHTML = list.map((it, idx)=>{
      const starOn = isFav(it.id) ? "on" : "";
      const platformName = it.platform==="douyin" ? "抖音" : "小红书";
      const hint = `【${platformName}｜${h(it.persona)}】${h(it.text)}\n推荐模板：${platformName}${it.tpl}\n痛点：${h(it.pain)}｜收益：${h(it.benefit)}`;
      return `
        <div class="titleItem" data-title-id="${it.id}">
          <div class="titleTop">
            <div style="flex:1; min-width:0">
              <div class="titleText">${h(it.text)}</div>
              <div class="titleMeta">
                <span class="tchip">平台：${platformName}</span>
                <span class="tchip">视角：${h(it.persona)}</span>
                <span class="tchip">模板：${platformName}${it.tpl}</span>
                <span class="tchip">痛点：${h(it.pain)}</span>
                <span class="tchip">收益：${h(it.benefit)}</span>
              </div>
            </div>
            <div class="titleActions">
              <button class="sbtn" data-copy64="${enc64(it.text)}">复制标题</button>
              <button class="sbtn primary" data-copy64="${enc64(hint)}">复制提示</button>
<button class="sbtn star ${starOn}" data-title-fav="1" title="收藏/取消">★</button>
            </div>
          </div>
        </div>
      `;
    }).join("");

    wrap.querySelectorAll("[data-title-fill]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const card = btn.closest("[data-title-id]");
        const id = card?.getAttribute("data-title-id");
        const all = TITLE_LIB.showFavs ? titleFavs() : TITLE_LIB.pool;
        const it = all.find(x=>x.id===id);
        if (!it) return;
        fillGeneratorFromTitle(it);
      });
    });

    wrap.querySelectorAll("[data-title-fav]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const card = btn.closest("[data-title-id]");
        const id = card?.getAttribute("data-title-id");
        const all = TITLE_LIB.showFavs ? titleFavs() : TITLE_LIB.pool;
        const it = all.find(x=>x.id===id);
        if (!it) return;
        toggleFav(it);
        btn.classList.toggle("on");
      });
    });
  }

  function fillGeneratorFromTitle(it){
    if ($("#genPlatform")) $("#genPlatform").value = it.platform;
    if ($("#genPersona")) $("#genPersona").value = it.personaKey;
    if ($("#genStage")) $("#genStage").value = it.stage;
    if ($("#genStyle")) $("#genStyle").value = it.style;
    if ($("#genTone")) $("#genTone").value = it.tone;

    const pb = extractPainBenefitFromText(it.text);
    if ($("#genPain")) $("#genPain").value = pb.pain || it.pain || "";
    if ($("#genBenefit")) $("#genBenefit").value = pb.benefit || it.benefit || "";

    if (it.platform==="douyin") setDyTpl(it.tpl || "auto");
    else setXhsTpl(it.tpl || "auto");

    // 关键：记住“选中标题”，逐字稿会随标题角度变化
    state.socialSelectedTitleText = it.text || "";
    state.socialSelectedTitlePlatform = it.platform || "";
    state.socialSelectedTitleAngle = inferAngleFromTitle(it.text || "", it.platform || "");
    save(state);
    updateSelTitleUI();

    toast("已从标题库带入生成器 ✅（逐字稿会随标题角度变化）");
    const gen = document.getElementById("smGen");
    if (gen) gen.scrollIntoView({behavior:"smooth", block:"start"});
  }

  function generateTitleBatch(n=50, append=true){
    const f = getTitleFilters();
    const maxTry = n*6;
    const set = new Set();
    if (append) {
      TITLE_LIB.pool
        .filter(x=>x.platform===f.platform && x.personaKey===f.personaKey && x.stage===f.stage && x.style===f.style && x.tone===f.tone)
        .forEach(x=>set.add(x.text));
    }
    const out = [];
    let tries = 0;
    while (out.length < n && tries < maxTry){
      const it = makeTitle(f.platform, f.personaKey, f.stage, f.style, f.tone);
      if (!set.has(it.text)) {
        set.add(it.text);
        out.push(it);
      }
      tries++;
    }
    if (append) TITLE_LIB.pool = TITLE_LIB.pool.concat(out);
    else TITLE_LIB.pool = out;
    renderTitleList();
  }

  function bindTitleLibrary(){
    if (TITLE_LIB.inited) return;
    TITLE_LIB.inited = true;

    updateFavCount();

    ["titlePlatform","titlePersona","titleStage","titleStyle","titleTone"].forEach(id=>{
      $("#" + id)?.addEventListener("change", ()=>{ TITLE_LIB.showFavs = false; renderTitleList(); });
    });

    $("#titleSearch")?.addEventListener("input", ()=> renderTitleList());

    $("#btnGenTitleBatch")?.addEventListener("click", ()=>{ TITLE_LIB.showFavs = false; generateTitleBatch(50, true); toast("已生成 50 条 ✅"); });
    $("#btnGenTitleMore")?.addEventListener("click", ()=>{ TITLE_LIB.showFavs = false; generateTitleBatch(50, true); toast("再来 50 条 ✅"); });

    $("#btnShowTitleFavs")?.addEventListener("click", ()=>{
      TITLE_LIB.showFavs = !TITLE_LIB.showFavs;
      toast(TITLE_LIB.showFavs ? "只看收藏" : "返回全部");
      renderTitleList();
    });

    $("#btnCopyTop10")?.addEventListener("click", ()=>{
      const list = getVisibleTitleList().slice(0,10);
      if (!list.length) return toast("没有可复制的标题");
      const txt = list.map((x,i)=>`${i+1}. ${x.text}`).join("\n");
      copyToClipboard(txt);
    });

    $("#btnClearTitlePool")?.addEventListener("click", ()=>{
      /* no confirm */
      TITLE_LIB.pool = [];
      renderTitleList();
    });

    renderTitleList();
  }

  // ---- 2.9) Social: Viral Content Generator (title + copy + tags) ----
  let viralGenInited = false;
  const SOCIAL_MAIN_TAG_KEY = "mc_social_main_tag_v1";
  const EXT_TOOLS_KEY = "mc_ext_tools_v1";

  const EXT_TOOLS_DEFAULT = {
    t1: { name: "酷狗 KGM/KGMA 转换工具", url: "file:///Users/mac/Desktop/%E5%A9%9A%E7%A4%BC/%E9%9F%B3%E4%B9%90%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2/%E3%80%90%E8%8B%B9%E6%9E%9CMAC%E3%80%91%E9%85%B7%E7%8B%97KGM,KGMA%E8%BD%AC%E6%8D%A2%E5%B7%A5%E5%85%B7%EF%BC%88%E5%85%88%E8%A7%A3%E5%8E%8B%E4%BD%BF%E7%94%A8%EF%BC%89/1.%E8%A7%A3%E5%AF%86%E5%B7%A5%E5%85%B7.v1.10.8/%E8%A7%A3%E5%AF%86%E5%B7%A5%E5%85%B7index.html" },
    t2: { name: "网易云 NCM 转换工具", url: "file:///Users/mac/Desktop/%E5%A9%9A%E7%A4%BC/%E9%9F%B3%E4%B9%90%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2/%E7%BD%91%E6%98%93%E4%BA%91NCM%E8%BD%AC%E6%8D%A2mac%E8%8B%B9%E6%9E%9C%E7%94%B5%E8%84%91%E4%BD%BF%E7%94%A8/%E7%BD%91%E6%98%93%E4%BA%91NCM%E8%BD%AC%E6%8D%A2/%E7%82%B9%E6%88%91%E5%BC%80%E5%A7%8B%E7%94%A8%E8%B0%B7%E6%AD%8C%E6%88%96%E8%80%85360%20%E7%81%AB%E7%8B%90%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%93%E5%BC%80.html" }
  };

  function normTag(t){
    t = (t||"").trim();
    if (!t) return "";
    t = t.replace(/^#+/,"").trim();
    return t ? ("#"+t) : "";
  }

  function uniq(arr){
    const out=[]; const set=new Set();
    (arr||[]).forEach(x=>{
      const v=(x||"").trim();
      if (!v) return;
      if (set.has(v)) return;
      set.add(v); out.push(v);
    });
    return out;
  }

  function loadMainTag(){
    try{ return (localStorage.getItem(SOCIAL_MAIN_TAG_KEY)||"").trim(); }catch(e){ return ""; }
  }
  function saveMainTag(v){
    try{ localStorage.setItem(SOCIAL_MAIN_TAG_KEY, (v||"").trim()); }catch(e){}
  }

  function loadExtTools(){
    try{
      const raw = localStorage.getItem(EXT_TOOLS_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    }catch(e){ return null; }
  }
  function saveExtTools(obj){
    try{ localStorage.setItem(EXT_TOOLS_KEY, JSON.stringify(obj||{})); }catch(e){}
  }

  function openUrl(url){
    url = (url||"").trim();
    if (!url) { toast("请先填写链接"); return; }
    try{
      window.open(url, "_blank", "noopener");
      if (url.startsWith("file://")) {
        toast("已尝试打开 file://（如被浏览器拦截，请在浏览器地址栏直接打开）");
      }
    }catch(e){ toast("打开失败：浏览器拦截或链接无效"); }
  }

  function bindExternalToolsUI(){
    const n1 = $("#extTool1Name"), u1 = $("#extTool1Url");
    const n2 = $("#extTool2Name"), u2 = $("#extTool2Url");
    if (!n1 || !u1 || !n2 || !u2) return;

    const apply = (o)=>{
      const data = o && (o.t1 || o.t2) ? o : EXT_TOOLS_DEFAULT;
      n1.value = (data.t1 && data.t1.name) ? data.t1.name : EXT_TOOLS_DEFAULT.t1.name;
      u1.value = (data.t1 && data.t1.url)  ? data.t1.url  : EXT_TOOLS_DEFAULT.t1.url;
      n2.value = (data.t2 && data.t2.name) ? data.t2.name : EXT_TOOLS_DEFAULT.t2.name;
      u2.value = (data.t2 && data.t2.url)  ? data.t2.url  : EXT_TOOLS_DEFAULT.t2.url;
    };

    apply(loadExtTools());

    $("#btnOpenTool1")?.addEventListener("click", ()=> openUrl(u1.value));
    $("#btnOpenTool2")?.addEventListener("click", ()=> openUrl(u2.value));

    $("#btnSaveExtTools")?.addEventListener("click", ()=>{
      const obj = {
        t1: { name: (n1.value||"").trim() || EXT_TOOLS_DEFAULT.t1.name, url: (u1.value||"").trim() },
        t2: { name: (n2.value||"").trim() || EXT_TOOLS_DEFAULT.t2.name, url: (u2.value||"").trim() }
      };
      saveExtTools(obj);
      toast("已保存入口 ✅");
    });

    $("#btnResetExtTools")?.addEventListener("click", ()=>{
      apply(EXT_TOOLS_DEFAULT);
      saveExtTools(EXT_TOOLS_DEFAULT);
      toast("已恢复默认入口 ✅");
    });

    $("#btnClearExtTools")?.addEventListener("click", ()=>{
      n1.value=""; u1.value="";
      n2.value=""; u2.value="";
      saveExtTools({});
      toast("已清空入口");
    });
  }

  const VIRAL_ELEM = {
    avoid:   {name:"避坑清单", dy:"避坑", xhs:"避坑清单"},
    contrast:{name:"反差对比", dy:"反差", xhs:"反差对比"},
    script:  {name:"高情商话术", dy:"话术", xhs:"话术模板"},
    panic:   {name:"社恐救命", dy:"救命", xhs:"社恐救命"},
    ritual:  {name:"仪式感", dy:"氛围", xhs:"仪式感"},
    money:   {name:"预算省钱", dy:"省钱", xhs:"预算省钱"},
    secret:  {name:"幕后揭秘", dy:"内幕", xhs:"幕后揭秘"},
    taboo:   {name:"雷区禁忌", dy:"别踩", xhs:"雷区禁忌"},
  };

  function personaPrefix(platform, persona){
    if (platform==="xhs") {
      if (persona==="couple") return "备婚人";
      if (persona==="host") return "主持人";
      if (persona==="guest") return "宾客视角";
      return "婚礼人";
    }
    // douyin
    if (persona==="couple") return "新娘新郎";
    if (persona==="host") return "主持人";
    if (persona==="guest") return "来宾";
    return "婚礼现场";
  }

  function genTitle(platform, persona, elemKey, topic, scene, tone){
    const elem = VIRAL_ELEM[elemKey] || VIRAL_ELEM.avoid;
    const w = platform==="xhs" ? elem.xhs : elem.dy;
    const pref = personaPrefix(platform, persona);

    const dy = [
      `${pref}${w}：${topic}这一步做错，现场会尬到发抖`,
      `别再${topic}了！90%的人婚礼当天都踩这个${w}坑`,
      `${topic}最容易翻车的3个点，我一次说清（${w}版）`,
      `如果重来一次，我一定把${topic}提前做对（${w}）`,
      `${topic}这件事：做对=高级，做错=灾难（${w}反差）`
    ];
    const xhs = [
      `【${topic}】${w}清单（${scene}版）｜${pref}建议收藏`,
      `${topic}怎么做才不尴尬？${pref}的${w}一页讲明白`,
      `${topic}流程&${w}模板（${scene}）｜直接抄就够`,
      `${topic}反差对比：这样做=高级，那样做=翻车（${w}）`,
      `${topic}的${w}底线：这3句话别说（${scene}）`
    ];

    const pool = platform==="xhs" ? xhs : dy;
    let t = pool[Math.floor(Math.random()*pool.length)];
    if (tone==="warm") t = t.replace("灾难","尴尬").replace("发抖","不舒服").replace("别再","别急着");
    if (tone==="fun") t = t.replace("灾难","翻车").replace("尬到发抖","尬到脚趾扣地");
    return t;
  }

  function genCopy(platform, persona, elemKey, topic, scene, tone){
    const elem = VIRAL_ELEM[elemKey] || VIRAL_ELEM.avoid;
    const w = platform==="xhs" ? elem.xhs : elem.dy;

    const hookMap = {
      couple: `备婚的你注意：${topic}这一步一旦没想好，${scene}真的会“卡住”。`,
      host: `我当主持最怕现场卡壳：${topic}是翻车高发区，尤其是${scene}。`,
      guest: `作为宾客我最怕尴尬瞬间：${topic}一乱，全场气氛立刻降温。`
    };
    const hook = hookMap[persona] || `关于${topic}：${scene}最容易出现尴尬点。`;

    const tips = {
      avoid: [
        `先把“${topic}”拆成 3 个动作：谁来做 / 什么时候做 / 一句话怎么说。`,
        `准备 A/B 两套方案：人多/音乐起/摄影机位变动时，立刻切换。`,
        `现场判断标准：宾客看得懂、新人不尴尬、镜头有重点。`
      ],
      contrast: [
        `高级做法：给${topic}一个“明确动作+明确站位+明确音乐点”。`,
        `翻车做法：临场临时想、大家各说各的、镜头不知道拍谁。`,
        `只要你把“谁是主角”写死，气场立刻稳（尤其${scene}）。`
      ],
      script: [
        `给你一套可直接抄的${w}：先“感谢”→再“点名”→最后“给行动指令”。`,
        `一句话结构：事实（发生了什么）+情绪（我们感受）+动作（现在请…）。`,
        `别堆形容词，越短越有力，镜头也更好剪。`
      ],
      panic: [
        `社恐救命：${topic}别硬扛，先做“提前声明”，现场就不会慌。`,
        `把最尴尬的环节提前彩排 30 秒：你只需要记住 1 个动作口令。`,
        `真的卡住了：停 1 秒、笑一下、把话抛给另一位关键人物。`
      ],
      ritual: [
        `仪式感不是花钱，是“节奏”：${topic}要有起→承→转→合。`,
        `音乐点很关键：让${scene}的情绪在 5 秒内被带起来。`,
        `留一个“全场一起做”的动作，氛围立刻拉满。`
      ],
      money: [
        `省钱思路：${topic}别买一堆道具，把预算用在“关键1处”。`,
        `把“可替代项”和“不可替代项”分开：可替代=租/借/简化。`,
        `省到位的标准：不影响镜头、不影响新人体验。`
      ],
      secret: [
        `幕后真相：${topic}翻车不是偶然，是“信息不对称”。`,
        `把主持/摄影/场控的分工写在一张纸上，现场就稳了。`,
        `${scene}只要有一个人“控节奏”，全场都顺。`
      ],
      taboo: [
        `${w}提醒：${topic}有3个雷区，踩一个就会让人不舒服。`,
        `雷区1：强迫式互动；雷区2：让新人难堪；雷区3：公开比较。`,
        `替代做法：给选择题、给台阶、给一句“可拒绝”的话术。`
      ],
    };

    const arr = tips[elemKey] || tips.avoid;
    const endMap = {
      douyin: `想要我把“${topic}”的【流程清单+一句话话术】发你？评论/私信“${topic}”。`,
      xhs: `✅我把“${topic}”整理成一页模板（流程+话术+站位提示），需要的评论“${topic}”，我发你可复制版本。`
    };
    let end = endMap[platform] || endMap.douyin;

    let body = "";
    if (platform==="xhs") {
      body = `${hook}\n\n📌 ${w}结论：先“定主角”再“定动作”，最后“定音乐点/镜头点”。\n\n✅ ${arr[0]}\n✅ ${arr[1]}\n✅ ${arr[2]}\n\n${end}\n\n（建议收藏，婚礼当天翻出来照做就行）`;
    } else {
      body = `${hook}\n${arr.map((x,i)=>`${i+1}. ${x}`).join("\n")}\n\n${end}`;
    }

    if (tone==="warm") body = body.replace(/翻车/g,"失误").replace(/灾难/g,"尴尬").replace(/雷区/g,"注意点");
    if (tone==="fun") body = body.replace(/尴尬/g,"社死").replace(/不舒服/g,"不对劲");
    return body;
  }

  function genTags(platform, persona, elemKey, topic, scene, mainTag){
    const elem = VIRAL_ELEM[elemKey] || VIRAL_ELEM.avoid;
    const base = ["#婚礼", "#备婚", "#婚礼流程"];
    const plat = platform==="xhs" ? ["#小红书", "#收藏干货"] : ["#抖音", "#口播"];
    const per = persona==="couple" ? ["#新娘", "#新郎"] : (persona==="host" ? ["#婚礼主持"] : ["#宾客"]);
    const el  = [ "#"+(elem.name||"").replace(/\s/g,"") ];
    const sc  = scene ? ["#"+scene.replace(/\s/g,"")] : [];
    const tp  = (topic && topic.length<=10) ? ["#"+topic.replace(/\s/g,"")] : [];
    const main = mainTag ? [normTag(mainTag)] : [];
    return uniq([ ...base, ...plat, ...per, ...el, ...sc, ...tp, ...main ].filter(Boolean));
  }

  function renderViralOut(items){
    const wrap = $("#smGenOut");
    if (!wrap) return;
    if (!items || !items.length) {
      wrap.innerHTML = '<div class="muted">这里会显示生成结果。先在左侧填关键词，然后点“生成内容”。</div>';
      return;
    }
    wrap.innerHTML = items.map((it, i)=>{
      const tagsTxt = (it.tags||[]).join(" ");
      const plat = it.platform==="xhs" ? "小红书" : (it.platform==="douyin" ? "抖音" : it.platform);
      return `
        <div class="topicrow">
          <div class="tno">${i+1}</div>
          <div class="tmain">
            <div class="tt">${plat}｜${it.title}</div>
            <div class="tmeta">
              <span class="tag">${tagsTxt}</span>
              <button class="sbtn" data-copy="title" data-i="${i}">复制标题</button>
              <button class="sbtn" data-copy="copy" data-i="${i}">复制文案</button>
              <button class="sbtn" data-copy="tags" data-i="${i}">复制标签</button>
            </div>
            <details class="soft">
              <summary>展开文案</summary>
              <div class="field" style="margin-top:10px">
                <textarea class="inp" rows="7" style="min-height:160px; font-size:13px; line-height:1.65">${it.copy}</textarea>
              </div>
            </details>
          </div>
        </div>
      `;
    }).join("");
  }

  
  function bindTopicAnalyzer(){
    if (state._taInited) return;
    state._taInited = true;

    const kw = $("#taKeyword");
    const out = $("#taOut");
    const btn = $("#btnTaGen");
    const btnCopy = $("#btnTaCopyAll");
    const btnToGen = $("#btnTaToGen");
    if (!kw || !out || !btn) return;

    const pickElem = (elemKey)=>{
      if (elemKey !== "random") return elemKey;
      const ks = Object.keys(VIRAL_ELEM);
      return ks[Math.floor(Math.random()*ks.length)];
    };

    
const render = (items)=>{
      out.classList.add("ta");
      out.innerHTML = items.map((t, idx)=>{
        const no = String(idx+1).padStart(2,"0");
        const esc = escapeHtml(t);
        return `
          <div class="taItem">
            <div class="taHead">
              <div class="taNo">${no}</div>
              <button class="sbtn" type="button" data-copy="${encodeURIComponent(t)}">复制</button>
            </div>
            <div class="taTitle" data-copy="${encodeURIComponent(t)}">${esc}</div>
          </div>
        `;
      }).join("");

      out.querySelectorAll("[data-copy]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const txt = decodeURIComponent(el.getAttribute("data-copy") || "");
          copyText(txt);
          toast("已复制 ✅");
        });
      });
    };

    const gen = ()=>{
      const keyword = (kw.value||"").trim();
      if (!keyword) { toast("请先输入关键词"); return; }
      const platform = ($("#taPlatform")?.value || "douyin");
      const persona  = ($("#taPersona")?.value || "couple");
      const elemRaw  = ($("#taElement")?.value || "avoid");
      const count    = Math.max(1, Math.min(60, parseInt($("#taCount")?.value || "20", 10)));
      const scene    = "婚礼当天";
      const tone     = platform==="xhs" ? "save" : "strong";

      const titles = [];
      for (let i=0;i<count;i++){
        const ek = pickElem(elemRaw);
        titles.push(genTitle(platform, persona, ek, keyword, scene, tone));
      }
      state._taLast = {keyword, platform, persona, elemRaw, count, titles};
      save(state);
      render(titles);
      toast("标题已生成 ✅");
    };

    btn.addEventListener("click", gen);
    btnCopy?.addEventListener("click", ()=>{
      const titles = (state._taLast?.titles)||[];
      if (!titles.length) { toast("先生成再复制"); return; }
      copyText(titles.map((t,i)=>`${i+1}. ${t}`).join("\n"));
      toast("已复制全部");
    });
    btnToGen?.addEventListener("click", ()=>{
      const keyword = (kw.value||"").trim();
      if (!keyword) { toast("先输入关键词"); return; }
      const topic = $("#smGenTopic");
      if (topic) topic.value = keyword;
      toast("已带入生成器");
      // scroll to generator
      document.getElementById("smViralGen")?.scrollIntoView({behavior:"smooth", block:"start"});
    });

    // restore
    if (state._taLast?.titles?.length){
      kw.value = state._taLast.keyword || "";
      render(state._taLast.titles);
    }
  }


function bindViralContentGen(){
    if (viralGenInited) return;
    viralGenInited = true;

    const btn = $("#btnSmGen");
    const btnR = $("#btnSmGenRandom");
    const btnC = $("#btnSmGenClear");
    const out = $("#smGenOut");
    if (!btn || !out) return;

    const mt = $("#smMainTag");
    if (mt) mt.value = loadMainTag();

    $("#btnSaveMainTag")?.addEventListener("click", ()=>{
      saveMainTag((mt?.value||"").trim());
      toast("已记住主标签 ✅");
    });
    $("#btnClearMainTag")?.addEventListener("click", ()=>{
      if (mt) mt.value="";
      saveMainTag("");
      toast("主标签已清空");
    });

    const pickElem = (elemKey)=>{
      if (elemKey !== "random") return elemKey;
      const ks = Object.keys(VIRAL_ELEM);
      return ks[Math.floor(Math.random()*ks.length)];
    };

    const run = ()=>{ try{
      const platform = ($("#smGenPlatform")?.value || "douyin");
      const persona  = ($("#smGenPersona")?.value || "couple");
      const elemRaw  = ($("#smGenElement")?.value || "avoid");
      const scene    = ($("#smGenScene")?.value || "婚礼当天");
      const tone     = ($("#smGenTone")?.value || "strong");
      const topic    = (($("#smGenTopic")?.value || "").trim());
      if (!topic) { toast("请先填写：主题关键词"); return; }

      const mainTag  = loadMainTag();
      const count    = parseInt($("#smGenCount")?.value || "3", 10);
      const items = [];

      const pushOne = (plat)=>{
        const ek = pickElem(elemRaw);
        const title = genTitle(plat, persona, ek, topic, scene, tone);
        const copy  = genCopy(plat, persona, ek, topic, scene, tone);
        const tags  = genTags(plat, persona, ek, topic, scene, mainTag);
        items.push({ platform: plat, title, copy, tags });
      };

      if (platform==="both") {
        const n = Math.max(1, Math.min(5, count));
        for (let i=0;i<n;i++){ pushOne("douyin"); pushOne("xhs"); }
      } else {
        const n = Math.max(1, Math.min(5, count));
        for (let i=0;i<n;i++) pushOne(platform);
      }

      state.socialViralLast = items;
      save(state);
      renderViralOut(items);
      toast("已生成 ✅");
    }catch(e){ console.error(e); toast("生成失败：" + (e?.message || e)); }
    };

    btn.addEventListener("click", run);

    btnR?.addEventListener("click", ()=>{
      const topics = ["站位","誓言","敬酒","合影","进场","退场","婚礼歌单","氛围音乐","互动游戏","证婚词"];
      const scenes = ["婚礼当天","订婚/迎亲","敬酒/合影","仪式/誓言","晚宴/年会"];
      $("#smGenTopic").value = topics[Math.floor(Math.random()*topics.length)];
      $("#smGenScene").value = scenes[Math.floor(Math.random()*scenes.length)];
      $("#smGenElement").value = "random";
      toast("已随机一组 ✨");
    });

    btnC?.addEventListener("click", ()=>{
      state.socialViralLast = [];
      save(state);
      renderViralOut([]);
      toast("已清空输出");
    });

    if (state.socialViralLast && state.socialViralLast.length) {
      renderViralOut(state.socialViralLast);
    } else {
      renderViralOut([]);
    }

    out.addEventListener("click", (e)=>{
      const b = e.target.closest("[data-copy]");
      if (!b) return;
      const i = parseInt(b.getAttribute("data-i")||"0",10);
      const items = state.socialViralLast || [];
      const it = items[i];
      if (!it) return;
      const kind = b.getAttribute("data-copy");
      if (kind==="title") copyToClipboard(it.title);
      else if (kind==="copy") copyToClipboard(it.copy);
      else if (kind==="tags") copyToClipboard((it.tags||[]).join(" "));
      toast("已复制 ✅");
    });

    $("#btnSmCopyAll")?.addEventListener("click", ()=>{
      const items = state.socialViralLast || [];
      if (!items.length) { toast("暂无内容可复制"); return; }
      const txt = items.map((it,idx)=>`【${idx+1}｜${it.platform==="xhs"?"小红书":"抖音"}】\n标题：${it.title}\n标签：${(it.tags||[]).join(" ")}\n文案：\n${it.copy}\n`).join("\n———\n\n");
      copyToClipboard(txt);
      toast("已复制全部 ✅");
    });

    $("#btnSmCopyTags")?.addEventListener("click", ()=>{
      const items = state.socialViralLast || [];
      if (!items.length) { toast("暂无标签可复制"); return; }
      const tags = uniq(items.flatMap(it=>it.tags||[])).join(" ");
      copyToClipboard(tags);
      toast("标签已复制 ✅");
    });
  }


  // ---- 3) Music System (P1/Kugou player + library + playlists + queue + clip) ----
  const MUSIC = {
    inited:false,
    db:null,
    tracks:[],
    playlists:[],
    activePlId:null,
    queue:[],
    currentIndex:-1,
    loopOne:true,
    mode:"next", // next | pause
    segTriggered:false,
    segStart:0,
    segEnd:null,
    srcUrl:null,
    playedIds:new Set(),
  };
  // -------- Undo (返回上一步) --------
  const MUSIC_UNDO = { stack: [] };

  function deepClone(obj){
    try{ return JSON.parse(JSON.stringify(obj)); }catch(e){ return null; }
  }
  function pushMusicUndo(label){
    const snap = {
      label: label || "上一步",
      ts: Date.now(),
      state: {
        tracks: deepClone(MUSIC.tracks) || [],
        playlists: deepClone(MUSIC.playlists) || [],
        queue: deepClone(MUSIC.queue) || [],
        activePlId: MUSIC.activePlId,
        currentIndex: MUSIC.currentIndex,
        loopOne: !!MUSIC.loopOne,
        mode: MUSIC.mode || "next",
      }
    };
    MUSIC_UNDO.stack.push(snap);
    if (MUSIC_UNDO.stack.length > 30) MUSIC_UNDO.stack.shift();
    updateUndoBtn();
  }

  function updateUndoBtn(){
    const b = document.getElementById("btnUndo");
    if (!b) return;
    b.disabled = MUSIC_UNDO.stack.length === 0;
  }

  async function syncStoreById(store, arr){
    if (!MUSIC.db) return;
    const existing = await dbGetAll(store);
    const wanted = new Set((arr||[]).map(x=>x.id));
    for (const it of existing){
      if (!wanted.has(it.id)) await dbDel(store, it.id);
    }
    for (const it of (arr||[])){
      await dbPut(store, it);
    }
  }

  async function undoMusicLast(){
    const item = MUSIC_UNDO.stack.pop();
    updateUndoBtn();
    if (!item) return;
    const st = item.state || {};
    // stop audio to avoid dangling state
    try{ document.getElementById("audioEl")?.pause(); }catch(e){}
    MUSIC.tracks = st.tracks || [];
    MUSIC.playlists = st.playlists || [];
    MUSIC.queue = st.queue || [];
    MUSIC.activePlId = st.activePlId ?? null;
    MUSIC.currentIndex = Number.isFinite(st.currentIndex) ? st.currentIndex : -1;
    MUSIC.loopOne = !!st.loopOne;
    MUSIC.mode = st.mode || "next";
    // render
    try{ renderLibrary(); }catch(e){}
    try{ renderPlaylists(); }catch(e){}
    try{ renderQueue(); }catch(e){}
    try{ setNowPlaying(); }catch(e){}
    try{ updateTimeUI(); }catch(e){}
    // persist best-effort
    try{
      await syncStoreById("tracks", MUSIC.tracks);
      await syncStoreById("playlists", MUSIC.playlists);
    }catch(e){}
    toast(`已返回：${item.label || "上一步"} ✅`);
  }


  const MUSIC_DB = "mc_music_db_v2";

  function fmtTime(t){
    if (!isFinite(t) || t < 0) t = 0;
    const m = Math.floor(t/60);
    const s = Math.floor(t%60);
    return `${m}:${String(s).padStart(2,"0")}`;
  }

  function loadMusicPrefs(){
    try{
      const raw = localStorage.getItem("mc_music_prefs");
      const p = raw ? JSON.parse(raw) : {};
      // 默认：单曲循环开启
      MUSIC.loopOne = (p.loopOne===undefined) ? true : !!p.loopOne;
      MUSIC.mode = p.mode || "next";
      const vol = (typeof p.vol==="number") ? p.vol : 0.85;
      const v = Math.min(1, Math.max(0, vol));
      const a = $("#audioEl");
      if (a) a.volume = v;
      const vb = $("#volBar");
      if (vb) vb.value = String(v);

      // layout defaults (v2.1)
      const lp = ensureMusicLayoutDefaults(p);
      MUSIC.layout = MUSIC.layout || {libW: lp.libW, plW: lp.plW, leftCollapsed: lp.leftCollapsed, libCollapsed: lp.libCollapsed, qSize: lp.qSize};
      // v2.6.27: 重新启用“收起音乐库”（仅折叠音乐库，不折叠播放列表/当前队列）
}catch(e){
      MUSIC.loopOne = true;
      MUSIC.mode = "next";
    }
  }
  
  // ===== Player Mode Switcher (Built-in vs P1 Console) =====
  const MUSIC_PLAYER_MODE_KEY = "mc_music_player_mode";
  let MUSIC_PLAYER_MODE = "builtin";
  let __p1ConsoleLoaded = false;
  let __p1KeyBridgeInstalled = false;

  function readMusicPlayerMode(){
    let m = "builtin";
    try{ m = (localStorage.getItem(MUSIC_PLAYER_MODE_KEY) || "builtin").toLowerCase(); }catch(e){}
    return (m === "p1") ? "p1" : "builtin";
  }

  function stopBuiltinAudio(){
    try{
      const a = $("#audioEl");
      if (a){ a.pause(); }
    }catch(e){}
  }

  function stopP1Audio(){
    const fr = $("#p1ConsoleFrame");
    if (!fr) return;
    try{
      const w = fr.contentWindow;
      if (w && typeof w.stopAll === "function"){
        w.stopAll({fade:false});
      }else if (w && w.document){
        const btn = w.document.querySelector("#btnStop, [data-act='stop']");
        btn && btn.click();
      }
    }catch(e){}
  }

  function ensureP1ConsoleLoaded(){
    if (__p1ConsoleLoaded) return;
    const fr = $("#p1ConsoleFrame");
    const tpl = $("#tplP1ConsoleSrcdoc");
    if (!fr || !tpl) return;

    __p1ConsoleLoaded = true;
    fr.__p1ready = false;
    fr.addEventListener("load", ()=>{ fr.__p1ready = true; }, {once:true});
    fr.srcdoc = tpl.innerHTML;
  }

  function setMusicPlayerMode(mode, opts={}){
    const silent = !!opts.silent;
    mode = (mode === "p1") ? "p1" : "builtin";
    MUSIC_PLAYER_MODE = mode;
    try{ localStorage.setItem(MUSIC_PLAYER_MODE_KEY, mode); }catch(e){}
    document.body.dataset.musicMode = mode;
    if (mode !== "p1") document.body.dataset.p1Fullscreen = "0";
    // If P1 fullscreen used browser Fullscreen API, ensure we also exit it when switching modes
    try{ if (document.fullscreenElement && document.exitFullscreen) document.exitFullscreen().catch(()=>{}); }catch(e){}


    const b0 = $("#btnMusicBuiltin");
    const b1 = $("#btnMusicP1");
    b0 && b0.classList.toggle("on", mode==="builtin");
    b1 && b1.classList.toggle("on", mode==="p1");
    const hint = $("#musicModeHint");
    if (hint) hint.textContent = "当前：" + (mode==="p1" ? "P1 播控台" : "内置播放器");

    if (mode === "p1"){
      
      stopBuiltinAudio();
      ensureP1ConsoleLoaded();
      setTimeout(()=>{ try{ $("#p1ConsoleFrame")?.contentWindow?.focus(); }catch(e){} }, 30);
      if (!silent) toast("已切换：P1 播控台 ✅");
    } else {
      
      
      stopP1Audio();
      if (!silent) toast("已切换：内置播放器 ✅");
    }
  }

  
  // --- helper: current music mode (builtin / p1) ---
  function getCurrentMusicMode(){
    try{
      if (typeof MUSIC_PLAYER_MODE === "string" && MUSIC_PLAYER_MODE) return MUSIC_PLAYER_MODE;
      const m = document.body && document.body.dataset ? document.body.dataset.musicMode : "";
      return (m === "p1") ? "p1" : "builtin";
    }catch(e){
      return "builtin";
    }
  }

function isTextInputFocusedMain(el){
    if (!el) return false;
    const tag = (el.tagName || "").toLowerCase();
    return tag === "input" || tag === "textarea" || tag === "select" || el.isContentEditable;
  }

  function forwardKeyToP1(e){
    ensureP1ConsoleLoaded();
    const fr = $("#p1ConsoleFrame");
    if (!fr || !fr.contentWindow) return;
    try{
      const w = fr.contentWindow;
      // 关键：在父页面真实按键回调里先尝试解锁 iframe 内音频上下文（Chrome 更稳）
      try{ (typeof w.ensureAudioUserGesture === "function") && w.ensureAudioUserGesture(); }catch(_){}
      const doc = w.document;
      if (!doc) return;
      const evt = new w.KeyboardEvent("keydown", {
        key: e.key, code: e.code,
        ctrlKey: e.ctrlKey, shiftKey: e.shiftKey, altKey: e.altKey, metaKey: e.metaKey,
        repeat: e.repeat,
        bubbles: true, cancelable: true
      });
      doc.dispatchEvent(evt);
    }catch(err){}
  }

  function installP1KeyBridge(){
    if (__p1KeyBridgeInstalled) return;
    __p1KeyBridgeInstalled = true;

    // capture-phase: block built-in hotkeys when P1 mode is active
    document.addEventListener("keydown", (e)=>{
      if (MUSIC_PLAYER_MODE !== "p1") return;

      const v = $("#viewMusic");
      if (!v || !v.classList.contains("active")) return;

      // don't hijack when typing
      if (isTextInputFocusedMain(document.activeElement) || isTextInputFocusedMain(e.target)) return;

      const k = e.key || "";
      const isMedia = k.startsWith("Media") || k==="PageUp" || k==="PageDown";
      const isNav = k==="ArrowLeft" || k==="ArrowRight" || k==="ArrowUp" || k==="ArrowDown";
      const isSpace = (k===" " || k==="Spacebar" || k==="Space");
      const isEsc = (k==="Escape");
      const isChar = (k.length===1);

      if (!(isMedia || isNav || isSpace || isEsc || isChar)) return;

      e.preventDefault();
      e.stopImmediatePropagation();
      forwardKeyToP1(e);
    }, true);
  }

  function initMusicModeSwitcher(){
    const b0 = $("#btnMusicBuiltin");
    const b1 = $("#btnMusicP1");
    if (!b0 || !b1) return;
    if (b0.__bound) return;
    b0.__bound = b1.__bound = true;

    b0.addEventListener("click", ()=> setMusicPlayerMode("builtin"));
    b1.addEventListener("click", ()=> setMusicPlayerMode("p1"));

    // External tools entry (placed next to P1)
    const b2 = $("#btnMusicExtTools");
    const d = $("#extTools");
    if (b2 && d){
      const sync = ()=>{ b2.classList.toggle("on", !!d.open); };
      b2.addEventListener("click", ()=>{
        d.open = !d.open;
        sync();
        if (d.open){
          try{ d.scrollIntoView({behavior:"smooth", block:"start"}); }catch(e){}
        }
      });
      d.addEventListener("toggle", sync);
      sync();
    }

    // init
    setMusicPlayerMode(readMusicPlayerMode(), {silent:true});
    installP1KeyBridge();
  }

function saveMusicPrefs(){
    try{
      localStorage.setItem("mc_music_prefs", JSON.stringify({
        loopOne: MUSIC.loopOne,
        mode: MUSIC.mode,
        vol: ($("#audioEl")?.volume ?? 0.85),
        libW: (MUSIC.layout?.libW ?? 340),
        plW:  (MUSIC.layout?.plW  ?? 240),
        leftCollapsed: !!(MUSIC.layout?.leftCollapsed),
        libCollapsed:  !!(MUSIC.layout?.libCollapsed),
        qSize: (MUSIC.layout?.qSize ?? 2),
        catsHidden: !!(MUSIC.layout?.catsHidden),
        libListH: (MUSIC.layout?.libListH ?? null)
      }));
    }catch(e){}
  }

  // ---- Music Layout (v2.1): resizable panes + collapse + queue card size ----
  function clampNum(n, min, max){
    n = Number(n);
    if (!isFinite(n)) return min;
    return Math.max(min, Math.min(max, n));
  }

  function ensureMusicLayoutDefaults(p){
    p = p || {};
    // pane widths (px)
    p.libW = clampNum(p.libW ?? 340, 180, 760);
    p.plW  = clampNum(p.plW  ?? 240, 140, 720);
    // collapse states
    p.leftCollapsed = false;
    p.libCollapsed = false;
    // queue size step 0..4
    p.qSize = clampNum(p.qSize ?? 2, 0, 4);
    // categories hidden (music library)
    p.catsHidden = !!p.catsHidden;
    // library list height (px), 0/undefined means auto
    if (p.libListH !== undefined && p.libListH !== null){
      p.libListH = clampNum(p.libListH, 220, 980);
    }
    return p;
  }

  function applyQueueSize(step){
    const q = $("#queueList");
    if (!q) return;
    const sizes = [
      {pad:8,  name:12, sub:11, btnFont:11, by:7,  bx:9},
      {pad:9,  name:12.5, sub:11.5, btnFont:11.5, by:7.5, bx:9.5},
      {pad:10, name:13, sub:12, btnFont:12, by:8,  bx:10},
      {pad:12, name:14, sub:13, btnFont:12.5, by:8.5, bx:10.5},
      {pad:14, name:15, sub:13.5, btnFont:13, by:9,  bx:11},
    ];
    const s = sizes[Math.round(clampNum(step,0,4))] || sizes[2];
    q.style.setProperty("--qPad", s.pad+"px");
    q.style.setProperty("--qName", s.name+"px");
    q.style.setProperty("--qSub", s.sub+"px");
    q.style.setProperty("--qBtnFont", s.btnFont+"px");
    q.style.setProperty("--qBtnPadY", s.by+"px");
    q.style.setProperty("--qBtnPadX", s.bx+"px");
  }

  function updateMusicLayoutButtons(){
    const bLeft = $("#btnToggleLeft");
    const bLib  = $("#btnToggleLib");
    const grid  = $("#kgGrid");
    if (!grid) return;
    const libCollapsed  = grid.classList.contains("kgLibCollapsed");
    const leftCollapsed = false; // legacy disabled

    if (bLib)  bLib.textContent  = libCollapsed ? "⟫ 展开音乐库" : "⟪ 收起音乐库";
    if (bLeft) bLeft.textContent = bLib ? bLib.textContent : (libCollapsed ? "⟫ 展开音乐库" : "⟪ 收起音乐库");

    const wrap = $("#kgWrap");
    if (wrap) wrap.classList.toggle("libCollapsed", libCollapsed);

    const reopen = $("#btnReopenLeft");
    if (reopen) reopen.style.display = "none";
  }

  function setMusicPaneVars(libW, plW){
    const grid = $("#kgGrid");
    if (!grid) return;

    // keep "当前队列" always readable: auto-shrink left panes if queue becomes too narrow
    const minLib   = 180, maxLib = 760;
    const minPl    = 140, maxPl  = 720;
    const resW1    = 44,  resW2  = 44;
    const minQueue = 420;

    let L = clampNum(libW, minLib, maxLib);
    let P = clampNum(plW,  minPl,  maxPl);

    // compute available width (fallback to viewport)
    const total = (grid.getBoundingClientRect && grid.getBoundingClientRect().width) || window.innerWidth || 1200;
    const maxLeft = Math.max(minLib + minPl, total - resW1 - resW2 - minQueue);

    if (L + P > maxLeft){
      let over = (L + P) - maxLeft;

      // shrink playlist first
      const canP = Math.max(0, P - minPl);
      const decP = Math.min(over, canP);
      P -= decP;
      over -= decP;

      // then shrink library
      if (over > 0){
        L = Math.max(minLib, L - over);
      }
    }

    grid.style.setProperty("--kgLibW", L + "px");
    grid.style.setProperty("--kgPlW",  P + "px");
  }

  function initMusicLayout(){
    const grid = $("#kgGrid");
    if (!grid) return;

    // 1) load saved prefs (reuse mc_music_prefs)
    let p = {};
    try{
      const raw = localStorage.getItem("mc_music_prefs");
      p = raw ? JSON.parse(raw) : {};
    }catch(e){}
    p = ensureMusicLayoutDefaults(p);

    // v2.6.3 patch: "收起音乐库" 只折叠音乐库（不再折叠播放列表/当前队列）
    if (p.leftCollapsed){
      p.leftCollapsed = false;
      p.libCollapsed = true;
    }

    // keep in memory for saveMusicPrefs to include
    MUSIC.layout = {
      libW: p.libW,
      plW: p.plW,
      leftCollapsed: p.leftCollapsed,
      libCollapsed: p.libCollapsed,
      qSize: p.qSize,
      catsHidden: !!p.catsHidden,
      libListH: (p.libListH ?? null)
    };

    setMusicPaneVars(MUSIC.layout.libW, MUSIC.layout.plW);
      if (typeof applyLibListH === "function"){ try{ applyLibListH(); }catch(_e){} }

    // apply cats hidden
    const colLib = $("#kgColLib");
    const btnCatsToggle = $("#btnCatsToggle");
    const applyCatsHidden = ()=>{
      const hidden = !!(MUSIC.layout?.catsHidden);
      if (colLib) colLib.classList.toggle("catsHidden", hidden);
      if (btnCatsToggle) btnCatsToggle.textContent = hidden ? "显示分类" : "隐藏分类";
    };
    applyCatsHidden();
    if (btnCatsToggle){
      btnCatsToggle.addEventListener("click", ()=>{
        MUSIC.layout.catsHidden = !MUSIC.layout.catsHidden;
        applyCatsHidden();
        saveMusicPrefs();
        if (typeof applyLibListH === "function"){ try{ applyLibListH(); }catch(_e){} }
      });
    }

    // apply library list height
    const libListEl = $("#libList");
    const libVRes = $("#libVResizer");

    // Keep library content inside the fixed-height grid even when the pane becomes very narrow
    // (avoid overflow stacking on modules below).
    const calcLibListMaxH = ()=>{
      const col = $("#kgColLib");
      if (!col || !libListEl) return 980;

      const colRect = col.getBoundingClientRect();
      const colStyle = getComputedStyle(col);
      const padT = parseFloat(colStyle.paddingTop)||0;
      const padB = parseFloat(colStyle.paddingBottom)||0;
      const innerH = Math.max(0, colRect.height - padT - padB);

      let fixed = 0;
      Array.from(col.children).forEach(ch=>{
        if (ch === libListEl) return;
        const st = getComputedStyle(ch);
        if (st.display === "none") return;
        const r = ch.getBoundingClientRect();
        fixed += r.height;
        fixed += (parseFloat(st.marginTop)||0) + (parseFloat(st.marginBottom)||0);
      });

      const max = innerH - fixed - 4;
      return clampNum(max, 120, 980);
    };

    const applyLibListH = ()=>{
      if (!libListEl) return;
      const desired = (MUSIC.layout?.libListH && typeof MUSIC.layout.libListH === "number") ? MUSIC.layout.libListH : null;
      const max = calcLibListMaxH();
      if (desired != null){
        libListEl.style.height = Math.min(desired, max) + "px";
      } else {
        // default fill remaining space
        libListEl.style.height = max + "px";
      }
    };
    applyLibListH();
    window.addEventListener("resize", ()=>{ try{ applyLibListH(); }catch(_e){} }, {passive:true});

    if (libVRes && libListEl){
      libVRes.addEventListener("pointerdown", (e)=>{
        if (e.button!==0 && e.pointerType!=="touch") return;
        e.preventDefault();
        libVRes.classList.add("dragging");
        libVRes.setPointerCapture?.(e.pointerId);
        const startY = e.clientY;
        const startH = libListEl.getBoundingClientRect().height || (MUSIC.layout?.libListH ?? 420);
        const onMove = (ev)=>{
          const dy = (ev.clientY - startY);
          const max = calcLibListMaxH();
          const nh = clampNum(startH + dy, 120, Math.max(120, max));
          MUSIC.layout.libListH = nh;
          libListEl.style.height = nh + "px";
        };
        const onUp = ()=>{
          libVRes.classList.remove("dragging");
          window.removeEventListener("pointermove", onMove);
          window.removeEventListener("pointerup", onUp);
          window.removeEventListener("pointercancel", onUp);
          saveMusicPrefs();
          applyLibListH();
        };
        window.addEventListener("pointermove", onMove);
        window.addEventListener("pointerup", onUp);
        window.addEventListener("pointercancel", onUp);
      });
    }

    // apply saved collapse states
    grid.classList.toggle("kgLeftCollapsed", !!(MUSIC.layout && MUSIC.layout.leftCollapsed));
    grid.classList.toggle("kgLibCollapsed",  !!(MUSIC.layout && MUSIC.layout.libCollapsed));
    // inline var overrides for collapsed library (class vars can't override inline vars)
    if (grid.classList.contains("kgLibCollapsed")){
      grid.style.setProperty("--kgRes1", "0px");
      grid.style.setProperty("--kgLibW", "56px");
    } else {
      grid.style.setProperty("--kgRes1", "44px");
    }


    applyQueueSize(MUSIC.layout.qSize);
    updateMusicLayoutButtons();

    // 2) buttons
    const btnToggleLeft = $("#btnToggleLeft");
    const btnReopenLeft = $("#btnReopenLeft");
    const btnToggleLib  = $("#btnToggleLib");
    const btnReset      = $("#btnResetPanes");
    const btnQS         = $("#btnQueueSmaller");
    const btnQB         = $("#btnQueueBigger");

    const setLeftCollapsed = (on)=>{
      MUSIC.layout.leftCollapsed = !!on;
      if (MUSIC.layout.leftCollapsed){
        // collapse all left
        grid.classList.add("kgLeftCollapsed");
      } else {
        grid.classList.remove("kgLeftCollapsed");
      }
      // if left is collapsed, libCollapsed becomes visually irrelevant
      updateMusicLayoutButtons();
      saveMusicPrefs();
    };

    const setLibCollapsed = (on)=>{
      // expanding left if needed
      if (grid.classList.contains("kgLeftCollapsed")){
        grid.classList.remove("kgLeftCollapsed");
        MUSIC.layout.leftCollapsed = false;
      }
      // let playlist expand a bit when library collapses (restore on reopen)
      if (!!on){
        if (MUSIC.layout && MUSIC.layout._plWBeforeLibCollapse==null){
          MUSIC.layout._plWBeforeLibCollapse = MUSIC.layout.plW;
          const inc = Math.min(220, Math.max(120, Math.round((MUSIC.layout.libW||340)*0.45)));
          MUSIC.layout.plW = clampNum((MUSIC.layout.plW||240) + inc, 140, 720);
          setMusicPaneVars(MUSIC.layout.libW, MUSIC.layout.plW);
      if (typeof applyLibListH === "function"){ try{ applyLibListH(); }catch(_e){} }
        }
      }else{
        if (MUSIC.layout && MUSIC.layout._plWBeforeLibCollapse!=null){
          MUSIC.layout.plW = clampNum(MUSIC.layout._plWBeforeLibCollapse, 140, 720);
          MUSIC.layout._plWBeforeLibCollapse = null;
          setMusicPaneVars(MUSIC.layout.libW, MUSIC.layout.plW);
      if (typeof applyLibListH === "function"){ try{ applyLibListH(); }catch(_e){} }
        }
      }

      MUSIC.layout.libCollapsed = !!on;
      grid.classList.toggle("kgLibCollapsed", !!on);

      // IMPORTANT: Chrome/inline-CSS vars. Inline style vars override class vars.
      // Force the collapsed width via inline vars so the layout always responds.
      if (!!on){
        grid.style.setProperty("--kgRes1", "0px");
        grid.style.setProperty("--kgLibW", "56px");
      } else {
        grid.style.setProperty("--kgRes1", "44px");
        // restore actual widths for lib + playlist
        setMusicPaneVars(MUSIC.layout.libW, MUSIC.layout.plW);
      }

      updateMusicLayoutButtons();
      saveMusicPrefs();
};

    if (btnToggleLeft) btnToggleLeft.addEventListener("click", ()=>{
      setLibCollapsed(!grid.classList.contains("kgLibCollapsed"));
    });
    if (btnReopenLeft) btnReopenLeft.addEventListener("click", ()=>{
      setLeftCollapsed(false);
    });
    if (btnToggleLib) btnToggleLib.addEventListener("click", ()=>{
      setLibCollapsed(!grid.classList.contains("kgLibCollapsed"));
    });
    // click the collapsed library strip to reopen
    const colLibClick = $("#kgColLib");
    if (colLibClick) colLibClick.addEventListener("click", (ev)=>{
      if (grid.classList.contains("kgLibCollapsed")){
        setLibCollapsed(false);
        ev.preventDefault();
        ev.stopPropagation();
      }
    });

    if (btnReset) btnReset.addEventListener("click", ()=>{
      MUSIC.layout.libW = 340;
      MUSIC.layout.plW  = 240;
      MUSIC.layout.leftCollapsed = false;
      MUSIC.layout.libCollapsed  = false;
      setMusicPaneVars(MUSIC.layout.libW, MUSIC.layout.plW);
      if (typeof applyLibListH === "function"){ try{ applyLibListH(); }catch(_e){} }
      grid.classList.remove("kgLeftCollapsed");
      grid.classList.remove("kgLibCollapsed");
      MUSIC.layout.qSize = 2;
      applyQueueSize(MUSIC.layout.qSize);
      updateMusicLayoutButtons();
      saveMusicPrefs();
      toast("已重置布局 ✅");
    });

    if (btnQS) btnQS.addEventListener("click", ()=>{
      MUSIC.layout.qSize = clampNum(MUSIC.layout.qSize - 1, 0, 4);
      applyQueueSize(MUSIC.layout.qSize);
      saveMusicPrefs();
    });
    if (btnQB) btnQB.addEventListener("click", ()=>{
      MUSIC.layout.qSize = clampNum(MUSIC.layout.qSize + 1, 0, 4);
      applyQueueSize(MUSIC.layout.qSize);
      saveMusicPrefs();
    });

    // 3) drag resize (pointer)
    const resizers = grid.querySelectorAll(".kgResizer[data-resize]");
    resizers.forEach(res=>{
      res.addEventListener("pointerdown", (e)=>{
        // only left button
        if (e.button!==0 && e.pointerType!=="touch") return;
        e.preventDefault();

        // expand panes if collapsed
        if (grid.classList.contains("kgLeftCollapsed")){
          grid.classList.remove("kgLeftCollapsed");
          MUSIC.layout.leftCollapsed = false;
        }
        if (res.getAttribute("data-resize")==="lib" && grid.classList.contains("kgLibCollapsed")){
          grid.classList.remove("kgLibCollapsed");
          MUSIC.layout.libCollapsed = false;
        }
        updateMusicLayoutButtons();

        const startX = e.clientX;
        const startLib = MUSIC.layout.libW;
        const startPl  = MUSIC.layout.plW;
        res.classList.add("dragging");
        res.setPointerCapture?.(e.pointerId);

        const onMove = (ev)=>{
          const dx = (ev.clientX - startX);
          const type = res.getAttribute("data-resize");
          if (type==="lib"){
            MUSIC.layout.libW = clampNum(startLib + dx, 180, 760);
          } else {
            MUSIC.layout.plW = clampNum(startPl + dx, 140, 720);
          }
          setMusicPaneVars(MUSIC.layout.libW, MUSIC.layout.plW);
      if (typeof applyLibListH === "function"){ try{ applyLibListH(); }catch(_e){} }
        };
        const onUp = ()=>{
          res.classList.remove("dragging");
          window.removeEventListener("pointermove", onMove);
          window.removeEventListener("pointerup", onUp);
          window.removeEventListener("pointercancel", onUp);
          saveMusicPrefs();
        };

        window.addEventListener("pointermove", onMove);
        window.addEventListener("pointerup", onUp);
        window.addEventListener("pointercancel", onUp);
      });
    });
  }


  function openMusicDB(){
    return new Promise((resolve, reject)=>{
      const req = indexedDB.open(MUSIC_DB, 1);
      req.onupgradeneeded = (e)=>{
        const db = req.result;
        if (!db.objectStoreNames.contains("tracks")){
          const st = db.createObjectStore("tracks", { keyPath: "id" });
          st.createIndex("name", "name", { unique:false });
          st.createIndex("createdAt", "createdAt", { unique:false });
        }
        if (!db.objectStoreNames.contains("playlists")){
          const sp = db.createObjectStore("playlists", { keyPath: "id" });
          sp.createIndex("name", "name", { unique:false });
          sp.createIndex("updatedAt", "updatedAt", { unique:false });
        }
      };
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error);
    });
  }

  function idNow(prefix){ return `${prefix}_${Date.now()}_${Math.floor(Math.random()*1e6)}`; }

  function tx(store, mode="readonly"){
    return MUSIC.db.transaction(store, mode).objectStore(store);
  }

  async function dbGetAll(store){
    return new Promise((resolve,reject)=>{
      const req = tx(store).getAll();
      req.onsuccess = ()=> resolve(req.result || []);
      req.onerror = ()=> reject(req.error);
    });
  }
  async function dbPut(store, obj){
    return new Promise((resolve,reject)=>{
      const req = tx(store, "readwrite").put(obj);
      req.onsuccess = ()=> resolve(true);
      req.onerror = ()=> reject(req.error);
    });
  }
  async function dbDel(store, id){
    return new Promise((resolve,reject)=>{
      const req = tx(store, "readwrite").delete(id);
      req.onsuccess = ()=> resolve(true);
      req.onerror = ()=> reject(req.error);
    });
  }

  function trackById(id){ return MUSIC.tracks.find(t=>t.id===id); }
  function playlistById(id){ return MUSIC.playlists.find(p=>p.id===id); }

  function getQueueItemLabel(q){
    return (q.title || "").trim() || (trackById(q.trackId)?.name || "未命名");
  }
  function getQueueSeg(q){
    const tr = trackById(q.trackId);
    const dur = tr?.duration || 0;
    const s = (typeof q.start==="number") ? q.start : 0;
    const e = (typeof q.end==="number") ? q.end : null;
    const end = (e===null) ? dur : Math.min(dur, e);
    return {start: Math.max(0, s), end: (end<=0? null : end), dur};
  }

  function syncModeHint(){
    const el = $("#modeHint");
    if (!el) return;
    const loop = MUSIC.loopOne ? "单曲循环" : "不循环";
    const mode = MUSIC.mode==="pause" ? "播完暂停" : "顺序播放";
    el.textContent = `模式：${mode}（${loop}，严格按片段末尾触发）`;
    $("#btnLoop")?.classList.toggle("active", MUSIC.loopOne);
  }

  function setNowPlaying(){
    const t = MUSIC.queue[MUSIC.currentIndex];
    const title = t ? getQueueItemLabel(t) : "未选择音乐";
    const seg = t ? getQueueSeg(t) : null;
    $("#nowTitle").textContent = title;
    $("#nowMeta").textContent = t ? `片段：${fmtTime(seg.start)} — ${seg.end===null? fmtTime(seg.dur):fmtTime(seg.end)} ｜ 点击队列卡片可播放/暂停` : "—";
  }

  function updateTimeUI(){
    const a = $("#audioEl");
    const t = MUSIC.queue[MUSIC.currentIndex];
    if (!a || !t) {
      $("#timeLeft").textContent = "0:00";
      $("#timeRight").textContent = "0:00";
      $("#seekBar").value = "0";
      return;
    }
    const seg = getQueueSeg(t);
    const cur = Math.max(seg.start, Math.min(a.currentTime, seg.end===null? seg.dur : seg.end));
    const left = cur - seg.start;
    const total = (seg.end===null? seg.dur : seg.end) - seg.start;
    $("#timeLeft").textContent = fmtTime(left);
    $("#timeRight").textContent = fmtTime(Math.max(0, total - left));
    const p = total>0 ? Math.round((left/total)*1000) : 0;
    $("#seekBar").value = String(p);
  }

  function clearSrcUrl(){
    if (MUSIC.srcUrl){
      URL.revokeObjectURL(MUSIC.srcUrl);
      MUSIC.srcUrl = null;
    }
  }

  
  function ensureAudioAttrs(a){
    if (!a) return;
    try{
      a.setAttribute("playsinline", "");
      a.setAttribute("webkit-playsinline", "");
      a.playsInline = true;
      a.preload = "auto";
    }catch(_e){}
  }

  async function safePlay(a){
    if (!a) return false;
    ensureAudioAttrs(a);
    try{
      const p = a.play();
      if (p && typeof p.then === "function") await p;
      return true;
    }catch(err){
      // Fallback: muted unlock trick (still requires a user gesture)
      try{
        const prevMuted = !!a.muted;
        a.muted = true;
        const p2 = a.play();
        if (p2 && typeof p2.then === "function") await p2;
        a.pause();
        a.muted = prevMuted;
        const p3 = a.play();
        if (p3 && typeof p3.then === "function") await p3;
        return true;
      }catch(err2){
        try{ a.muted = false; }catch(_e){}
        console.warn("play blocked", err2 || err);
        toast("播放被浏览器拦截：请先点击一次「▶ 播放」解锁（只需一次）");
        return false;
      }
    }
  }
async function playTrack(index, forcePlay=true){
    if (index < 0 || index >= MUSIC.queue.length) return;
    try{ if (MUSIC.currentIndex !== -1 && MUSIC.currentIndex !== index){ const prev = MUSIC.queue[MUSIC.currentIndex]; if (prev && MUSIC.playedIds) MUSIC.playedIds.add(prev.id); } }catch(e){}
    MUSIC.currentIndex = index;
    MUSIC.segTriggered = false;
    const a = $("#audioEl");
    const q = MUSIC.queue[index];
    const tr = trackById(q.trackId);
    if (!a || !tr) return;

    clearSrcUrl();
    ensureAudioAttrs(a);
    try{ a.pause(); }catch(_e){}
    MUSIC.srcUrl = URL.createObjectURL(tr.blob);
    a.src = MUSIC.srcUrl;
    try{ a.load && a.load(); }catch(_e){}
    // keep play() inside the user gesture stack; safePlay provides feedback on block
    if (forcePlay){ safePlay(a); }

    const seg = getQueueSeg(q);
    const onMeta = ()=>{
      a.removeEventListener("loadedmetadata", onMeta);
      const realDur = a.duration || seg.dur || 0;
      const end = (seg.end===null) ? realDur : Math.min(realDur, seg.end);
      MUSIC.segStart = seg.start;
      MUSIC.segEnd = end;
      a.currentTime = Math.max(0, Math.min(MUSIC.segStart, end || realDur || 0));
      setNowPlaying();
      updateTimeUI();
            // playback already requested in the user gesture stack
      syncPlayBtn();
    };
    a.addEventListener("loadedmetadata", onMeta);

    setNowPlaying();
    syncPlayBtn();
    renderQueue();
  }

  function syncPlayBtn(){
    const a = $("#audioEl");
    const btn = $("#btnPlay");
    if (!btn) return;
    const playing = a && !a.paused && !a.ended;
    btn.textContent = playing ? "⏸" : "▶";
  }

  function togglePlay(){
    const a = $("#audioEl");
    if (!a) return;
    if (MUSIC.currentIndex === -1){
      if (MUSIC.queue.length) playTrack(0, true);
      return;
    }
    if (a.paused) safePlay(a);
    else a.pause();
    syncPlayBtn();
  }

  function playPrevNext(dir){
    if (!MUSIC.queue.length) return;
    let idx = MUSIC.currentIndex;
    if (idx === -1) idx = 0;
    idx = idx + dir;
    if (idx < 0) idx = 0;
    if (idx >= MUSIC.queue.length) idx = MUSIC.queue.length - 1;
    playTrack(idx, true);
  }

  function handleSegmentEnd(){
    const a = $("#audioEl");
    if (!a) return;
    const curItem = MUSIC.queue[MUSIC.currentIndex];

    // 每个队列条目独立：顺序 / 单曲循环 / 播完暂停
    const mode = (curItem && (curItem.loopOne===true || curItem.behavior==="loop")) ? "loop"
               : (curItem && (curItem.endMode==="pause" || curItem.behavior==="pause")) ? "pause"
               : "next";

    try{
      if (mode !== "loop"){
        if (curItem && MUSIC.playedIds) MUSIC.playedIds.add(curItem.id);
      }
    }catch(e){}

    if (mode === "loop"){
      MUSIC.segTriggered = false;
      a.currentTime = MUSIC.segStart || 0;
      safePlay(a);
      return;
    }
    if (mode === "pause"){
      a.pause();
      syncPlayBtn();
      return;
    }

    const next = MUSIC.currentIndex + 1;
    if (next < MUSIC.queue.length){
      playTrack(next, true);
    } else {
      if (MUSIC.loopAll){
        playTrack(0, true);
      } else {
        a.pause(); syncPlayBtn();
      }
    }
  }

  function bindPlayerEvents(){
    const a = $("#audioEl");
    if (!a) return;

    a.addEventListener("timeupdate", ()=>{
      updateTimeUI();
      const q = MUSIC.queue[MUSIC.currentIndex];
      if (!q) return;
      const end = MUSIC.segEnd;
      if (end!==null && isFinite(end) && !MUSIC.segTriggered && a.currentTime >= (end - 0.03)){
        MUSIC.segTriggered = true;
        a.currentTime = end;
        handleSegmentEnd();
      }
    });

    a.addEventListener("ended", ()=>{
      MUSIC.segTriggered = true;
      handleSegmentEnd();
    });

    a.addEventListener("play", syncPlayBtn);
    a.addEventListener("pause", syncPlayBtn);
  }

  function bindPlayerUI(){
    $("#btnPlay")?.addEventListener("click", togglePlay);
    $("#btnPrev")?.addEventListener("click", ()=> playPrevNext(-1));
    $("#btnNext")?.addEventListener("click", ()=> playPrevNext(1));
    $("#btnLoop")?.addEventListener("click", ()=>{
      MUSIC.loopOne = !MUSIC.loopOne;
      syncModeHint();
      saveMusicPrefs();
      toast(MUSIC.loopOne ? "单曲循环：开" : "单曲循环：关");
    });
    $("#btnMode")?.addEventListener("click", ()=>{
      MUSIC.mode = (MUSIC.mode==="next") ? "pause" : "next";
      syncModeHint();
      saveMusicPrefs();
      toast(MUSIC.mode==="pause" ? "模式：播完暂停" : "模式：顺序播放");
    });

    $("#seekBar")?.addEventListener("input", (e)=>{
      const a = $("#audioEl");
      const q = MUSIC.queue[MUSIC.currentIndex];
      if (!a || !q) return;
      const seg = getQueueSeg(q);
      const total = (seg.end===null? seg.dur : seg.end) - seg.start;
      const p = Number(e.target.value||0)/1000;
      const target = seg.start + total * p;
      MUSIC.segTriggered = false;
      a.currentTime = Math.max(seg.start, Math.min(target, seg.end===null? seg.dur : seg.end));
      updateTimeUI();
    });

    $("#volBar")?.addEventListener("input", (e)=>{
      const a = $("#audioEl");
      if (!a) return;
      a.volume = Number(e.target.value||0.85);
      saveMusicPrefs();
    });
  }

  async function getDurationFromBlob(blob){
    return new Promise((resolve)=>{
      const au = document.createElement("audio");
      const url = URL.createObjectURL(blob);
      au.src = url;
      const done = (d)=>{ try{URL.revokeObjectURL(url);}catch(e){} resolve(isFinite(d)? d : 0); };
      au.addEventListener("loadedmetadata", ()=> done(au.duration||0), { once:true });
      au.addEventListener("error", ()=> done(0), { once:true });
    });
  }

  async function addFilesToLibrary(files, alsoAddToQueue=false){
    const arr = Array.from(files||[]);
    if (!arr.length) return;

    for (const f of arr){
      const blob = f instanceof Blob ? f : null;
      if (!blob) continue;
      const id = idNow("trk");
      const name = (f.name||"未命名").replace(/\.[^.]+$/,"");
      const duration = await getDurationFromBlob(blob);
      const item = { id, name, blob, duration, createdAt: Date.now() };
      MUSIC.tracks.push(item);
      await dbPut("tracks", item);
      if (alsoAddToQueue){
        MUSIC.queue.push({ id: idNow("q"), trackId: id, title:"", start:0, end:null, loopOne:false, endMode:"next", behavior:"next" });
      }
    }
    renderLibrary();
    renderQueue();
    if (alsoAddToQueue) persistActivePlaylistFromQueue();
    toast("已添加到音乐库 ✅");
  }

  function renderPlaylists(){
    const wrap = $("#plList");
    if (!wrap) return;
    const list = MUSIC.playlists.slice().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
    if (!list.length){
      wrap.innerHTML = `<div class="muted">暂无播放列表，点“新建”。</div>`;
      return;
    }
    wrap.innerHTML = list.map(pl=>{
      const active = (pl.id===MUSIC.activePlId) ? "active" : "";
      const count = pl.items?.length || 0;
      return `
        <div class="kgItem kgPlItem ${active}" data-pl-id="${pl.id}">
          <div class="kgLeft">
            <div class="kgName" contenteditable="true" data-pl-name="1">${h(pl.name||"未命名")}</div>
            <div class="kgSub">${count} 首 · 拖曲目到这里可添加</div>
          </div>
          <div class="kgRight">
            <button class="sbtn danger" data-pl-del="1">删</button>
          </div>
        </div>
      `;
    }).join("");

    
    // click playlist card to load (no "载入" button)
    wrap.querySelectorAll("[data-pl-id]").forEach(card=>{
      card.addEventListener("click", (e)=>{
        if (e.target && (e.target.getAttribute("data-pl-del")==="1" || e.target.getAttribute("data-pl-name")==="1")) return;
        const id = card.getAttribute("data-pl-id");
        if (!id) return;
        loadPlaylist(id);
      });
    });
wrap.querySelectorAll("[data-pl-del]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const card = btn.closest("[data-pl-id]");
        const id = card?.getAttribute("data-pl-id");
        if (!id) return;
        /* no confirm */
        pushMusicUndo("删除播放列表");
        MUSIC.playlists = MUSIC.playlists.filter(x=>x.id!==id);
        if (MUSIC.activePlId===id) MUSIC.activePlId=null;
        await dbDel("playlists", id);
        renderPlaylists();
        toast("已删除");
      });
    });
    wrap.querySelectorAll("[data-pl-name]").forEach(el=>{
      el.addEventListener("blur", async ()=>{
        const card = el.closest("[data-pl-id]");
        const id = card?.getAttribute("data-pl-id");
        const pl = playlistById(id);
        if (!pl) return;
        pl.name = (el.textContent||"").trim() || "未命名";
        pl.updatedAt = Date.now();
        await dbPut("playlists", pl);
        renderPlaylists();
      });
    });

    wrap.querySelectorAll("[data-pl-id]").forEach(card=>{
      card.addEventListener("dragover", (e)=>{ e.preventDefault(); card.classList.add("dragover"); });
      card.addEventListener("dragleave", ()=> card.classList.remove("dragover"));
      card.addEventListener("drop", async (e)=>{
        e.preventDefault(); card.classList.remove("dragover");
        const id = card.getAttribute("data-pl-id");
        const pl = playlistById(id);
        if (!pl) return;
        const data = e.dataTransfer.getData("text/plain");
        let obj=null;
        try{ obj=JSON.parse(data);}catch(e){}
        if (obj?.type==="track"){
          pl.items = pl.items || [];
          pl.items.push({ id:idNow("pi"), trackId: obj.id, title:"", start:0, end:null });
          pl.updatedAt = Date.now();
          await dbPut("playlists", pl);
          toast("已加入播放列表");
          renderPlaylists();
          if (MUSIC.activePlId===pl.id) loadPlaylistToQueue(pl.id, false);
        }
      });
    });
  }

  async function loadPlaylistToQueue(plId, scroll=false){
    const pl = playlistById(plId);
    if (!pl) return;
    MUSIC.activePlId = pl.id;
    try{ window.applyPlaylistPlayback && window.applyPlaylistPlayback(pl); }catch(e){}
        MUSIC.queue = (pl.items||[]).map(it=>{
      const q = {
        id: it.id || idNow("q"),
        trackId: it.trackId,
        title: it.title || "",
        start: (typeof it.start==="number") ? it.start : 0,
        end: (typeof it.end==="number") ? it.end : null
      };
      if (typeof it.loopOne === "boolean") q.loopOne = it.loopOne;
      if (it.endMode==="next" || it.endMode==="pause") q.endMode = it.endMode;

      // backward compat: old behavior field
      if (!Object.prototype.hasOwnProperty.call(q,"loopOne") && !Object.prototype.hasOwnProperty.call(q,"endMode") && it.behavior){
        if (it.behavior==="loop"){ q.loopOne = true; }
        else if (it.behavior==="pause"){ q.loopOne = false; q.endMode = "pause"; }
        else if (it.behavior==="next"){ q.loopOne = false; q.endMode = "next"; }
      }

      // default per-item behavior (每条独立)
      if (typeof q.loopOne !== "boolean") q.loopOne = false;
      if (q.loopOne===true){
        q.endMode = null;
        q.behavior = "loop";
      }else{
        if (q.endMode!=="pause" && q.endMode!=="next") q.endMode = "next";
        q.behavior = (q.endMode==="pause") ? "pause" : "next";
      }

      return q;
    });
MUSIC.currentIndex = -1;
    renderPlaylists();
    renderQueue();
    setNowPlaying();
    updateTimeUI();
    toast(`已载入：${pl.name}`);
    /* 已关闭：点击播放列表不自动滚动页面 */
}

  async function persistActivePlaylistFromQueue(){
    if (!MUSIC.activePlId) return;
    const pl = playlistById(MUSIC.activePlId);
    if (!pl) return;
        pl.items = MUSIC.queue.map(q=>{
      const mode = (q && q.loopOne===true) ? "loop" : (q && q.endMode==="pause") ? "pause" : "next";
      return {
        id: q.id,
        trackId: q.trackId,
        title: q.title||"",
        start: q.start||0,
        end: (q.end===undefined? null : q.end),
        loopOne: (typeof q.loopOne==="boolean") ? q.loopOne : null,
        endMode: (q.endMode==="next" || q.endMode==="pause") ? q.endMode : null,
        behavior: mode
      };
    });
pl.updatedAt = Date.now();
    await dbPut("playlists", pl);
    renderPlaylists();
  }

  function renderLibrary(){
    const wrap = $("#libList");
    if (!wrap) return;
    const q = String($("#libSearch")?.value||"").trim().toLowerCase();
    const list = MUSIC.tracks.slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)).filter(t=>!q || String(t.name||"").toLowerCase().includes(q));
    if (!list.length){
      wrap.innerHTML = `<div class="muted">暂无音乐。点“上传/拖入”或把文件拖到上面区域。</div>`;
      return;
    }
    wrap.innerHTML = list.map(tr=>{
      return `
        <div class="kgItem" data-track-id="${tr.id}">
          <div class="kgGrip" draggable="true" data-drag-track="${tr.id}" title="拖拽：加入队列/播放列表">⋮⋮</div>
          <div class="kgLeft">
            <div class="kgName" contenteditable="true" data-tr-name="1">${h(tr.name||"未命名")}</div>
            <div class="kgSub">${fmtTime(tr.duration||0)} · 拖到队列/播放列表 · 或点右侧“+队列”</div>
          </div>
          <div class="kgRight">
            <button class="sbtn" data-addq="1">+队列</button>
            <button class="sbtn danger" data-del="1">删</button>
          </div>
        </div>
      `;
    }).join("");

    wrap.querySelectorAll("[data-drag-track]").forEach(grip=>{
      grip.addEventListener("dragstart", (e)=>{
        const id = grip.getAttribute("data-drag-track");
        e.dataTransfer.effectAllowed = "copy";
        const payload = JSON.stringify({type:"track", id});
        e.dataTransfer.setData("text/plain", payload);
        try{ e.dataTransfer.setData("application/json", payload); }catch(_e){}
      });
    });

    wrap.querySelectorAll("[data-addq]").forEach(btn=>{
      btn.setAttribute("draggable","false");
      btn.addEventListener("dragstart", (e)=>{ e.preventDefault(); e.stopPropagation(); });
      btn.addEventListener("mousedown", (e)=>{ e.stopPropagation(); });
      btn.addEventListener("click", (e)=>{
        e.stopPropagation();
        const card = btn.closest("[data-track-id]");
        const id = card?.getAttribute("data-track-id");
        if (!id) return;
        MUSIC.queue.push({ id:idNow("q"), trackId:id, title:"", start:0, end:null, loopOne:false, endMode:"next", behavior:"next" });
        renderQueue();
        persistActivePlaylistFromQueue();
        toast("已加入队列");
      });
    });
    wrap.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const card = btn.closest("[data-track-id]");
        const id = card?.getAttribute("data-track-id");
        if (!id) return;
        /* no confirm */
        pushMusicUndo("删除音乐");
        MUSIC.tracks = MUSIC.tracks.filter(x=>x.id!==id);
        MUSIC.queue = MUSIC.queue.filter(q=>q.trackId!==id);
        MUSIC.playlists.forEach(pl=>{
          pl.items = (pl.items||[]).filter(it=>it.trackId!==id);
        });
        await dbDel("tracks", id);
        for (const pl of MUSIC.playlists) await dbPut("playlists", pl);
        renderLibrary(); renderQueue(); renderPlaylists();
        toast("已删除");
      });
    });
    wrap.querySelectorAll("[data-tr-name]").forEach(el=>{
      el.addEventListener("blur", async ()=>{
        const card = el.closest("[data-track-id]");
        const id = card?.getAttribute("data-track-id");
        const tr = trackById(id);
        if (!tr) return;
        tr.name = (el.textContent||"").trim() || "未命名";
        await dbPut("tracks", tr);
        renderLibrary();
        setNowPlaying();
      });
    });
  }

  function renderQueue(){
    const wrap = $("#queueList");
    if (!wrap) return;
    const qsize = (MUSIC.layout?.qSize ?? "md");
    wrap.classList.toggle("qSm", qsize==="sm");
    wrap.classList.toggle("qLg", qsize==="lg");

    const played = MUSIC.playedIds || new Set();
    wrap.innerHTML = (MUSIC.queue||[]).map((q, idx)=>{
      const t = MUSIC.tracks.find(x=>x.id===q.trackId) || {};
      const name = escapeHtml(q.title || t.name || "未命名");
      const dur = (typeof t.duration==="number") ? t.duration : 0;
      const seg = (q.end!==null && isFinite(q.end)) ? `${fmtTime(q.start||0)} - ${fmtTime(q.end)}` : `${fmtTime(q.start||0)} - ${fmtTime(dur)}`;
      const active = (idx===MUSIC.currentIndex);
      const playedCls = played.has(q.id) ? " played" : "";

      const mode = (q.loopOne===true || q.behavior==="loop") ? "loop" : (q.endMode==="pause" || q.behavior==="pause") ? "pause" : "next";
      const modeIcon = (mode==="loop") ? "🔁" : (mode==="pause") ? "⏸" : "⏭";
      const modeText = (mode==="loop") ? "单曲循环" : (mode==="pause") ? "播完暂停" : "顺序播放";

      return `
        <div class="kgItem ${active?"active":""}${playedCls}" data-q-idx="${idx}">
          <div class="kgLeft">
            <div class="kgName" title="${name}">${name}</div>
            <div class="kgSub">
              <span class="mono">${seg}</span>
              <span class="qModeBadge" title="播放结束动作">${modeIcon} ${modeText}</span>
            </div>
          </div>
          <div class="kgRight">
            <div class="qModeWrap" title="每首歌独立：顺序 / 单曲循环 / 播完暂停">
              <button class="sbtn qMode ${mode==="next"?"on":""}" data-q-mode="next" data-q-idx="${idx}" title="顺序播放">⏭</button>
              <button class="sbtn qMode ${mode==="loop"?"on":""}" data-q-mode="loop" data-q-idx="${idx}" title="单曲循环">🔁</button>
              <button class="sbtn qMode ${mode==="pause"?"on":""}" data-q-mode="pause" data-q-idx="${idx}" title="播放完暂停">⏸</button>
            </div>
            <button class="sbtn" data-q-up="${idx}" title="上移">↑</button>
            <button class="sbtn" data-q-down="${idx}" title="下移">↓</button>
            <button class="sbtn" data-q-clip="${idx}" title="裁剪">✂</button>
            <button class="sbtn danger" data-q-del="${idx}" title="移除">✕</button>
          </div>
        </div>
      `;
    }).join("") || `<div class="small muted">暂无。把音乐拖入队列，或在左侧音乐库点击“＋”加入。</div>`;

    // queue actions
    wrap.querySelectorAll("[data-q-clip]").forEach(b=>b.addEventListener("click",(e)=>{
      e.stopPropagation();
      const idx = Number(b.dataset.qClip);
      openClip(idx);
    }));
    wrap.querySelectorAll("[data-q-del]").forEach(b=>b.addEventListener("click",(e)=>{
      e.stopPropagation();
      const idx = Number(b.dataset.qDel);
      MUSIC.queue.splice(idx,1);
      if (MUSIC.currentIndex >= MUSIC.queue.length) MUSIC.currentIndex = MUSIC.queue.length-1;
      persistActivePlaylistFromQueue();
      renderQueue();
      setNowPlaying();
    }));
    wrap.querySelectorAll("[data-q-up]").forEach(b=>b.addEventListener("click",(e)=>{
      e.stopPropagation();
      const idx = Number(b.dataset.qUp);
      if (idx<=0) return;
      const [it] = MUSIC.queue.splice(idx,1);
      MUSIC.queue.splice(idx-1,0,it);
      if (MUSIC.currentIndex===idx) MUSIC.currentIndex = idx-1;
      else if (MUSIC.currentIndex===idx-1) MUSIC.currentIndex = idx;
      persistActivePlaylistFromQueue();
      renderQueue();
    }));
    wrap.querySelectorAll("[data-q-down]").forEach(b=>b.addEventListener("click",(e)=>{
      e.stopPropagation();
      const idx = Number(b.dataset.qDown);
      if (idx>=MUSIC.queue.length-1) return;
      const [it] = MUSIC.queue.splice(idx,1);
      MUSIC.queue.splice(idx+1,0,it);
      if (MUSIC.currentIndex===idx) MUSIC.currentIndex = idx+1;
      else if (MUSIC.currentIndex===idx+1) MUSIC.currentIndex = idx;
      persistActivePlaylistFromQueue();
      renderQueue();
    }));

    // per-item mode buttons
    wrap.querySelectorAll("[data-q-mode]").forEach(b=>b.addEventListener("click",(e)=>{
      e.stopPropagation();
      const idx = Number(b.dataset.qIdx);
      const mode = b.dataset.qMode;
      const it = MUSIC.queue[idx];
      if (!it) return;
      if (mode==="loop"){
        it.loopOne = true;
        it.endMode = null;
        it.behavior = "loop";
      }else if (mode==="pause"){
        it.loopOne = false;
        it.endMode = "pause";
        it.behavior = "pause";
      }else{
        it.loopOne = false;
        it.endMode = "next";
        it.behavior = "next";
      }
      persistActivePlaylistFromQueue();
      renderQueue();
      setNowPlaying();
    }));
  }

  // Clip editor
  let CLIP_IDX = -1;

  function openClip(idx){
    const q = MUSIC.queue[idx];
    if (!q) return;
    CLIP_IDX = idx;
    const tr = trackById(q.trackId);
    const dur = tr?.duration || 0;

    const seg = getQueueSeg(q);
    const drawer = $("#clipDrawer");
    if (!drawer) return;
    drawer.style.display = "block";

    const cs = $("#clipStart"); const ce = $("#clipEnd");
    const csn = $("#clipStartNum"); const cen = $("#clipEndNum");
    cs.max = String(dur); ce.max = String(dur);
    cs.value = String(seg.start); ce.value = String(seg.end===null? dur : seg.end);
    csn.max = String(dur); cen.max = String(dur);
    csn.value = String(seg.start.toFixed(2)); cen.value = String((seg.end===null? dur:seg.end).toFixed(2));
    updateClipLabel();

    const sync = ()=>{
      let s = Number(cs.value||0), e = Number(ce.value||0);
      if (e < s) [s,e] = [e,s];
      q.start = Math.max(0, s);
      q.end = Math.max(q.start, e);
      csn.value = String(q.start.toFixed(2));
      cen.value = String(q.end.toFixed(2));
      updateClipLabel();
      persistActivePlaylistFromQueue();
      if (MUSIC.currentIndex===idx){
        MUSIC.segStart = q.start;
        MUSIC.segEnd = q.end;
        MUSIC.segTriggered = false;
      }
      renderQueue();
      setNowPlaying();
    };

    const syncFromNum = ()=>{
      let s = Number(csn.value||0), e = Number(cen.value||0);
      if (e < s) [s,e] = [e,s];
      cs.value = String(s); ce.value = String(e);
      sync();
    };

    cs.oninput = sync;
    ce.oninput = sync;
    csn.onchange = syncFromNum;
    cen.onchange = syncFromNum;
  }

  function updateClipLabel(){
    const q = MUSIC.queue[CLIP_IDX];
    if (!q) return;
    const tr = trackById(q.trackId);
    const dur = tr?.duration || 0;
    const seg = getQueueSeg(q);
    $("#clipSegLabel").textContent = `${fmtTime(seg.start)} — ${seg.end===null? fmtTime(dur):fmtTime(seg.end)}`;
  }

  function closeClip(){
    $("#clipDrawer").style.display = "none";
    CLIP_IDX = -1;
  }

  function bindClipUI(){
    $("#btnCloseClip")?.addEventListener("click", closeClip);
  }

  function bindDropZones(){
    const libDrop = $("#libDrop");
    const queueDrop = $("#queueDrop");
    const queueList = $("#queueList");

    const bindZone = (zone, onFiles, onObj)=>{
      if (!zone) return;
      zone.addEventListener("dragover", (e)=>{ e.preventDefault(); zone.classList.add("dragover"); });
      zone.addEventListener("dragleave", ()=> zone.classList.remove("dragover"));
      zone.addEventListener("drop", async (e)=>{
        e.preventDefault(); zone.classList.remove("dragover");
        if (e.dataTransfer.files && e.dataTransfer.files.length){
          await onFiles(e.dataTransfer.files);
          return;
        }
        const data = e.dataTransfer.getData("application/json") || e.dataTransfer.getData("text/plain");
        let obj=null; try{ obj=JSON.parse(data);}catch(e){}
        if (obj) onObj(obj);
      });
    };

    bindZone(libDrop, async (files)=> addFilesToLibrary(files, false), (obj)=>{});
    bindZone(queueDrop, async (files)=> addFilesToLibrary(files, true), (obj)=>{
      if (obj.type==="track"){
        MUSIC.queue.push({ id:idNow("q"), trackId: obj.id, title:"", start:0, end:null });
        renderQueue(); persistActivePlaylistFromQueue(); toast("已加入队列");
      }
    });
    bindZone(queueList, async (files)=> addFilesToLibrary(files, true), (obj)=>{
      if (obj.type==="track"){
        MUSIC.queue.push({ id:idNow("q"), trackId: obj.id, title:"", start:0, end:null });
        renderQueue(); persistActivePlaylistFromQueue(); toast("已加入队列");
      }
    });
  }




  // === v2.6.1 fix: make music library items reliably clickable (+队列/删) and draggable ===
  function installMusicLibraryInteractionFix(){
    if (installMusicLibraryInteractionFix._done) return;
    installMusicLibraryInteractionFix._done = true;

    const libWrap = $("#libList");
    if (!libWrap) return;

    // Ensure rows are draggable (not only the grip), keep updating on re-render.
    const applyDraggable = ()=>{
      libWrap.querySelectorAll(".kgItem[data-track-id]").forEach(row=>{
        row.setAttribute("draggable","true");
      });
      // Prevent accidental drag from controls / editable text
      libWrap.querySelectorAll("button, input, textarea, select, [contenteditable='true']").forEach(el=>{
        el.setAttribute("draggable","false");
      });
    };
    applyDraggable();
    try{
      const mo = new MutationObserver(()=>applyDraggable());
      mo.observe(libWrap, {childList:true, subtree:false});
    }catch(e){}

    // Capture click on +队列 / 删 regardless of bubbling stops
    document.addEventListener("click", async (e)=>{
      const addBtn = e.target?.closest?.("#libList [data-addq]");
      const delBtn = e.target?.closest?.("#libList [data-del]");
      if (!addBtn && !delBtn) return;

      if (e.__kgLibHandled) return;
      e.__kgLibHandled = true;
      e.preventDefault(); e.stopPropagation();

      const btn = addBtn || delBtn;
      const card = btn.closest("[data-track-id]");
      const id = card?.getAttribute("data-track-id");
      if (!id) return;

      try{
        if (addBtn){
          MUSIC.queue.push({ id:idNow("q"), trackId:id, title:"", start:0, end:null, loopOne:false, endMode:"next", behavior:"next" });
          renderQueue(); persistActivePlaylistFromQueue(); toast("已加入队列");
          return;
        }

        // delete
        MUSIC.tracks = MUSIC.tracks.filter(x=>x.id!==id);
        MUSIC.queue = MUSIC.queue.filter(q=>q.trackId!==id);
        MUSIC.playlists.forEach(pl=>{
          pl.items = (pl.items||[]).filter(it=>it.trackId!==id);
        });
        await dbDel("tracks", id);
        for (const pl of MUSIC.playlists) await dbPut("playlists", pl);
        renderLibrary(); renderQueue(); renderPlaylists();
        toast("已删除");
      }catch(err){
        console.error(err);
        toast((addBtn ? "加入失败" : "删除失败") + (err?.message ? "："+err.message : ""));
      }
    }, true);

    // Capture dragstart inside library rows (drag to 队列 / 播放列表)
    document.addEventListener("dragstart", (e)=>{
      const row = e.target?.closest?.("#libList .kgItem[data-track-id]");
      if (!row) return;

      // Ignore drag from controls / editable
      if (e.target?.closest?.("button, input, textarea, select, [contenteditable='true']")) return;

      const id = row.getAttribute("data-track-id");
      if (!id || !e.dataTransfer) return;

      e.dataTransfer.effectAllowed = "copy";
      const payload = JSON.stringify({type:"track", id});
      try{ e.dataTransfer.setData("application/json", payload); }catch(_e){}
      e.dataTransfer.setData("text/plain", payload);
    }, true);
  }

  // === Embedded format tools (KGM/KGMA / NCM) ===
  function toolBlobUrl(htmlText){
    const blob = new Blob([htmlText], {type:"text/html;charset=utf-8"});
    return URL.createObjectURL(blob);
  }
  function restoreTool(key, frameId){
    const fr = $("#"+frameId);
    if (!fr) return;
    let txt = "";
    try{ txt = localStorage.getItem(key) || ""; }catch(e){}
    if (!txt) return;
    fr.src = toolBlobUrl(txt);
  }
  function loadToolFromFile(key, fileInputId, frameId){
    const fi = $("#"+fileInputId);
    const fr = $("#"+frameId);
    if (!fi || !fr) return;
    const file = fi.files && fi.files[0];
    if (!file){ toast("请先选择一个 HTML 文件"); return; }
    const r = new FileReader();
    r.onload = ()=>{
      const txt = String(r.result||"");
      try{ localStorage.setItem(key, txt); }catch(e){}
      fr.src = toolBlobUrl(txt);
      toast("已加载转换工具 ✅");
    };
    r.readAsText(file, "utf-8");
  }
  function clearTool(key, frameId){
    try{ localStorage.removeItem(key); }catch(e){}
    const fr = $("#"+frameId);
    if (fr) fr.src = "about:blank";
    toast("已清除");
  }

  function bindLibraryUI(){
    $("#btnUpload")?.addEventListener("click", ()=> $("#audioFile")?.click());
    $("#audioFile")?.addEventListener("change", async (e)=>{
      const files = e.target.files;
      await addFilesToLibrary(files, false);
      e.target.value = "";
    });
    $("#libSearch")?.addEventListener("input", renderLibrary);
    // quick add category (no prompt)
    $("#btnAddCatQuick")?.addEventListener("click", ()=>{
      try{
        // ensure cats visible
        if (MUSIC.layout && MUSIC.layout.catsHidden){
          MUSIC.layout.catsHidden = false;
          $("#kgColLib")?.classList.remove("catsHidden");
          $("#btnCatsToggle") && ($("#btnCatsToggle").textContent = "隐藏分类");
          saveMusicPrefs();
        }
        renderCats();
        // trigger the inline "＋ 分类" chip
        const catWrap = $("#libCats");
        if (!catWrap) return;
        const btns = Array.from(catWrap.querySelectorAll("button.chipBtn"));
        const addBtn = btns.find(b => (b.textContent||"").includes("＋") && (b.textContent||"").includes("分类"));
        addBtn?.click();
      }catch(e){
        console.error(e);
        toast("新增分类失败");
      }
    });

  }

  function bindPlaylistUI(){
    $("#btnNewPl")?.addEventListener("click", async ()=>{
      const n = MUSIC.playlists.length + 1;
      const maxOrder = Math.max(-1, ...(MUSIC.playlists||[]).map(p=> (p.order===undefined||p.order===null)?-1:p.order));
      const pl = { id:idNow("pl"), name:`播放列表${n}`, items:[], createdAt:Date.now(), updatedAt:Date.now(), order: maxOrder+1, loopOne:true, loopAll:false, mode:"next" };
      MUSIC.playlists.push(pl);
      await dbPut("playlists", pl);
      renderPlaylists();
      toast("已新建播放列表");
    });
  }

  
  function bindQueueTapPlay(){
    const wrap = document.getElementById("queueList");
    if (!wrap || wrap.__tapBound) return;
    wrap.__tapBound = true;

    let downX=0, downY=0;

    function enableNameEdit(card){
      const nameEl = card.querySelector("[data-q-name]");
      if (!nameEl) return;
      try{ nameEl.setAttribute("contenteditable","true"); }catch(_e){}
      try{ nameEl.focus(); }catch(_e){}
      try{
        const r = document.createRange();
        r.selectNodeContents(nameEl);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(r);
      }catch(_e){}
    }

    wrap.addEventListener("pointerdown", (e)=>{
      downX = e.clientX || 0;
      downY = e.clientY || 0;
    }, {passive:true});

    // Chrome: use click (activation event) so audio playback is allowed
    wrap.addEventListener("click", (e)=>{
      // ignore if it was a scroll/drag
      const dx = Math.abs((e.clientX||0) - downX);
      const dy = Math.abs((e.clientY||0) - downY);
      if (dx > 8 || dy > 8) return;

      // ignore button clicks / inputs / while renaming
      if (e.target?.closest?.("button, input, textarea, select, a, [contenteditable='true']")) return;

      const card = e.target?.closest?.("[data-q-idx]");
      if (!card) return;

      const idx = Number(card.getAttribute("data-q-idx"));
      if (!isFinite(idx)) return;

      // single click = play/pause
      if (MUSIC.currentIndex === idx){
        togglePlay();
      } else {
        playTrack(idx, true);
      }
    });

    // double click on title = rename (does not toggle play/pause)
    wrap.addEventListener("dblclick", (e)=>{
      const card = e.target?.closest?.("[data-q-idx]");
      if (!card) return;
      if (!e.target?.closest?.("[data-q-name]")) return;
      e.preventDefault();
      e.stopPropagation();
      enableNameEdit(card);
    });
  }

function bindQueueUI(){
    $("#btnClearQueue")?.addEventListener("click", ()=>{
      /* no confirm */
      pushMusicUndo("清空当前队列");
      MUSIC.queue = [];
      MUSIC.currentIndex = -1;
      try{ MUSIC.playedIds && MUSIC.playedIds.clear(); }catch(e){}
      $("#audioEl")?.pause();
      renderQueue();
      setNowPlaying();
      updateTimeUI();
      persistActivePlaylistFromQueue();
    });
  }

  async function initMusic(){
    if (MUSIC.inited) return;
    MUSIC.inited = true;

    if (!("indexedDB" in window)){
      toast("你的浏览器不支持 IndexedDB，音乐系统无法离线保存。");
      return;
    }

    try{
      MUSIC.db = await openMusicDB();
      MUSIC.tracks = await dbGetAll("tracks");
      MUSIC.playlists = await dbGetAll("playlists");
      if (!MUSIC.playlists.length){
        const pl = { id:idNow("pl"), name:"默认列表", items:[], createdAt:Date.now(), updatedAt:Date.now() };
        MUSIC.playlists.push(pl);
        await dbPut("playlists", pl);
      }
      MUSIC.activePlId = MUSIC.playlists[0].id;

      bindPlayerEvents();
      bindPlayerUI();
      bindLibraryUI();
      bindPlaylistUI();
      bindQueueUI();
      bindQueueTapPlay();
          // Undo button
    const _ub = document.getElementById("btnUndo");
    if (_ub && !_ub.__bound){ _ub.__bound = true; _ub.addEventListener("click", ()=>{ undoMusicLast(); }); }
    updateUndoBtn();
bindDropZones();
      installMusicLibraryInteractionFix();
      // external tools entry
      try{ bindExternalToolsUI(); }catch(e){ console.error(e); }

      bindClipUI();
      bindUvrUI();
      loadMusicPrefs();
      initMusicLayout();
      initMusicModeSwitcher();
      initKtvUI();
      syncModeHint();

      renderPlaylists();
      renderLibrary();
      renderQueue();
      setNowPlaying();
      updateTimeUI();

      toast("音乐系统已就绪 ✅");
    }catch(e){
      console.error(e);
      toast("音乐系统初始化失败（可能是浏览器阻止离线存储）");
    }
  }

  

  // -------------------------
  // UVR Engine (伴奏制作) v2.6.24
  // 目标：不改动现有播放/剪裁/队列逻辑，仅新增一张“UVR 引擎”卡片和工作流
  // 默认：ONNX（若未检测到则自动降级到快速离线算法）
  // 高级：Demucs/MDX23C 预留（桌面端 Native Bridge）
  // -------------------------

  const UVR = {
    inited:false,
    busy:false,
    abort:false,
    engine:"onnx",      // onnx | quick
    preset:"std",       // std | strong | gentle | vocal
    strength:0.85,
    source: { kind:"track", id:null, name:"", blob:null }, // or kind:"file"
    out: { voc:null, inst:null, vocUrl:"", instUrl:"", baseName:"" }
  };


  
  // ===== KTV Lyrics (LRC) =====
  const KTV_STORE_KEY = "mc_ktv_lrc_map_v1";
  const KTV_UI_KEY    = "mc_ktv_lrc_ui_v1";

  const KTVL = {
    inited:false,
    songKey:"",
    songTitle:"",
    raw:"",
    lines:[],
    lineEls:[],
    activeIdx:-1,
    activeWord:-1,
    offset:0,     // seconds; + means lyrics later
    fontSize:56,  // px
    autoScroll:true,
    fxOn:true,    // 渐变/描边/唱过变色
    wordMode:true,// 逐字（增强 LRC）
    showRole:true,// 伴唱提示（男/女/合/和声）
    castWin:null,
    timer:null,
    raf:null,
    lastTs:0,
    lastLineSent:-1,
  };

  function ktvSafeJSON(raw, fallback){
    try{ return raw ? JSON.parse(raw) : (fallback||{}); }catch(e){ return (fallback||{}); }
  }
  function ktvFmtTS(sec){
    sec = Math.max(0, Number(sec)||0);
    const m = Math.floor(sec/60);
    const s = Math.floor(sec%60);
    const ms = Math.round((sec - Math.floor(sec))*100);
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}.${String(ms).padStart(2,"0")}`;
  }
  function ktvClamp(n,a,b){
    n = Number(n)||0; a=Number(a)||0; b=Number(b)||0;
    return Math.max(a, Math.min(n, b));
  }

  function parseLRC(raw){
    raw = String(raw||"").replace(/\uFEFF/g,"").trim();
    const out = [];
    const meta = {};
    const lines = raw.split(/\r?\n/);

    const parseTS = (mm, ss, frac)=>{
      const m = Number(mm||0);
      const s = Number(ss||0);
      const f = frac ? String(frac).padEnd(3,"0") : "000";
      return m*60 + s + (Number(f)/1000);
    };

    const detectRole = (txt)=>{
      let role = "";
      let t = (txt||"").trim();

      // ASCII role prefix: M:/F:/D:/BG:/B:
      const m1 = t.match(/^(BG|B|M|F|D)\s*:\s*(.*)$/i);
      if (m1){
        const r = (m1[1]||"").toUpperCase();
        role = (r==="B") ? "BG" : r;
        t = (m1[2]||"").trim();
        return {role, text:t};
      }

      // Chinese short prefix: 男:/女:/合:/和:
      const m2 = t.match(/^(男|女|合|和|和声)\s*[:：]\s*(.*)$/);
      if (m2){
        const r = m2[1];
        role = (r==="男")?"M":(r==="女")?"F":(r==="合")?"D":"BG";
        t = (m2[2]||"").trim();
        return {role, text:t};
      }

      // Brackets at start: (男)/(女)/(合)/(和声)/(伴唱)
      const m3 = t.match(/^[（(]\s*(男|女|合|和声|伴唱)\s*[）)]\s*(.*)$/);
      if (m3){
        const r = m3[1];
        role = (r==="男")?"M":(r==="女")?"F":(r==="合")?"D":"BG";
        t = (m3[2]||"").trim();
        return {role, text:t};
      }

      return {role:"", text:t};
    };

    const parseEnhancedWords = (payload)=>{
      // Enhanced LRC: <mm:ss.xx>word <mm:ss.xx>word ...
      const tags = [...payload.matchAll(/<(\d{1,2}):(\d{2})(?:\.(\d{1,3}))?>/g)];
      if (!tags.length) return null;
      const words = [];
      for (let i=0;i<tags.length;i++){
        const tag = tags[i];
        const t = parseTS(tag[1], tag[2], tag[3]);
        const segStart = (tag.index||0) + tag[0].length;
        const segEnd = (i+1<tags.length) ? (tags[i+1].index||payload.length) : payload.length;
        const seg = payload.slice(segStart, segEnd);
        if (seg && seg.replace(/\s+/g,"").length){
          words.push({t, txt: seg});
        }else if (seg && seg.length){
          // keep pure spaces as separators
          words.push({t, txt: seg});
        }
      }
      if (!words.length) return null;
      const plain = words.map(w=>w.txt).join("").trim();
      return {words, plain: plain || "…"};
    };

    for (let ln of lines){
      ln = ln.trim();
      if (!ln) continue;

      // meta tags: [ti:...], [ar:...], [offset:...]
      const mm = ln.match(/^\[([a-zA-Z]+)\s*:\s*(.*?)\s*\]$/);
      if (mm && mm[1]){
        meta[mm[1].toLowerCase()] = (mm[2]||"").trim();
        continue;
      }

      const timeTags = [...ln.matchAll(/\[(\d{1,2}):(\d{2})(?:\.(\d{1,3}))?\]/g)];
      if (!timeTags.length) continue;

      // remove all [..] tags
      let payload = ln.replace(/\[[^\]]+\]/g, "");
      // role detect
      const rr = detectRole(payload);
      payload = rr.text;

      // enhanced words?
      const ew = parseEnhancedWords(payload);
      const plainText = ew ? ew.plain : payload.replace(/<[^>]+>/g,"").trim();
      const words = ew ? ew.words : null;

      for (const t of timeTags){
        const sec = parseTS(t[1], t[2], t[3]);
        out.push({t: sec, text: plainText || "…", role: rr.role || "", words: words});
      }
    }

    // apply [offset] (ms) if present: shift timestamps
    let metaOffset = 0;
    if (meta.offset != null){
      const v = Number(meta.offset);
      if (Number.isFinite(v)) metaOffset = v/1000;
    }

    out.sort((a,b)=>a.t-b.t);

    // apply offset and dedup
    const dedup = [];
    let lastT = -999;
    for (const it of out){
      const t = Math.max(0, it.t - metaOffset);
      const words = Array.isArray(it.words) ? it.words.map(w=>({t: Math.max(0, w.t - metaOffset), txt: w.txt})) : null;

      if (Math.abs(t - lastT) < 0.001 && dedup.length){
        dedup[dedup.length-1] = {t, text: it.text, role: it.role||"", words};
      }else{
        dedup.push({t, text: it.text, role: it.role||"", words});
      }
      lastT = t;
    }
    return {raw, meta, lines: dedup};
  }

  

  // ---- Karaoke render helpers (word-level, gradient, role cue) ----
  function ktvEscHtml(s){
    return String(s||"")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  function ktvRoleLabel(role){
    const r = (role||"").toUpperCase();
    if (r==="M") return "男声";
    if (r==="F") return "女声";
    if (r==="D") return "合唱";
    if (r==="BG") return "和声/伴唱";
    return "";
  }
  function ktvRoleClass(role){
    const r = (role||"").toUpperCase();
    if (r==="F") return "role-f";
    if (r==="D") return "role-d";
    if (r==="BG") return "role-bg";
    if (r==="M") return "role-m";
    return "role-m";
  }

  function ktvGetLineEnd(i, pb){
    const arr = KTVL.lines;
    const cur = arr[i];
    if (!cur) return 0;
    const next = arr[i+1];
    if (next && Number.isFinite(next.t) && next.t > cur.t + 0.02) return next.t;
    const dur = pb && Number.isFinite(pb.dur) ? pb.dur : 0;
    if (dur && dur > cur.t) return dur;
    return cur.t + 6; // fallback
  }

  function ktvPickWordIndex(line, t){
    const w = line && Array.isArray(line.words) ? line.words : null;
    if (!w || !w.length) return -1;
    // last word with time <= t
    let lo=0, hi=w.length-1, ans=-1;
    while (lo<=hi){
      const mid=(lo+hi)>>1;
      if (w[mid].t <= t){ ans=mid; lo=mid+1; }
      else hi=mid-1;
    }
    return ans;
  }

  function ktvRenderKaraokeHTML(line, t, lineEnd){
    if (!line) return {html:"—", pct:0, role:""};
    const text = line.text || "—";
    const role = line.role || "";
    const total = Math.max(0.001, (lineEnd||0) - (line.t||0));
    const pct = ktvClamp(((t - (line.t||0)) / total) * 100, 0, 100);

    const words = (KTVL.wordMode && line.words && Array.isArray(line.words) && line.words.length) ? line.words : null;
    if (!KTVL.fxOn){
      // plain line (FX disabled)
      return {html: ktvEscHtml(text), pct, role};
    }
    if (!words){
      // 标准 LRC：逐行“唱过变色”兜底
      const et = ktvEscHtml(text);
      return {html: `<span class="ktvLineFx" style="--p:${pct.toFixed(2)}%" data-text="${et}">${et}</span>`, pct, role};
    }

    const wi = ktvPickWordIndex(line, t);
    let htmlStr = "";
    for (let i=0;i<words.length;i++){
      const w = words[i];
      const txt = w.txt || "";
      // Determine word end
      const nextT = (i+1<words.length) ? words[i+1].t : (lineEnd||((line.t||0)+6));
      const isHot = (i===wi) && (t < nextT);
      const isSung = (t >= nextT);
      const cls = ["ktvWord"];
      if (KTVL.fxOn){
        if (isHot) cls.push("hot");
        else if (isSung) cls.push("sung");
      }
      htmlStr += `<span class="${cls.join(" ")}">${ktvEscHtml(txt)}</span>`;
    }
    // If enhanced LRC had trims, ensure fallback spaces not lost:
    if (!htmlStr) htmlStr = ktvEscHtml(text);
    return {html: htmlStr, pct, role};
  }

  function ktvOverlayRender(i, t, pb){
    const ov = $("#ktvOverlay");
    if (!ov || !ov.classList.contains("show")) return;

    const l1 = $("#ktvOverlayLine1");
    const l2 = $("#ktvOverlayLine2");
    const roleEl = $("#ktvOverlayRole");
    const prog = $("#ktvOverlayProg");
    const progI = prog ? prog.querySelector("i") : null;

    const cur = (i>=0) ? (KTVL.lines[i] || null) : null;
    const next = (i>=0) ? (KTVL.lines[i+1] || null) : null;
    const end = (i>=0) ? ktvGetLineEnd(i, pb) : 0;

    // size
    if (l1) l1.style.fontSize = KTVL.fontSize + "px";
    if (l2) l2.style.fontSize = Math.max(18, Math.round(KTVL.fontSize*0.55)) + "px";

    // role cue
    const role = cur ? (cur.role||"") : "";
    const rLabel = ktvRoleLabel(role);
    if (roleEl){
      if (KTVL.showRole && rLabel){
        roleEl.style.display = "";
        roleEl.classList.remove("role-m","role-f","role-d","role-bg");
        roleEl.classList.add(ktvRoleClass(role));
        const sp = roleEl.querySelector("span");
        if (sp) sp.textContent = rLabel;
      }else{
        roleEl.style.display = "none";
      }
    }

    // current line (word-level)
    if (l1){
      if (cur){
        const r = ktvRenderKaraokeHTML(cur, t, end);
        l1.innerHTML = r.html;
      }else{
        l1.textContent = "—";
      }
    }
    // next line plain
    if (l2) l2.textContent = next ? (next.text||"") : "";

    // progress
    if (progI){
      const pct = (cur && end>cur.t) ? ktvClamp(((t-cur.t)/(end-cur.t))*100,0,100) : 0;
      progI.style.width = pct.toFixed(2) + "%";
    }
  }
function ktvGetP1Bridge(){
    try{
      ensureP1ConsoleLoaded();
      const fr = $("#p1ConsoleFrame");
      const w = fr && fr.contentWindow;
      if (w && w.__ktvBridge && typeof w.__ktvBridge.getPlayback === "function") return w.__ktvBridge;
    }catch(e){}
    return null;
  }

  function ktvGetPlayback(){
    const mode = getCurrentMusicMode();
    if (mode === "p1"){
      const b = ktvGetP1Bridge();
      if (b){
        const p = b.getPlayback();
        p.key = p.cueId ? ("p1:"+p.cueId) : "";
        p.title = p.title || "";
        return p;
      }
      return {mode:"p1", playing:false, t:0, dur:0, key:"", title:""};
    }
    // builtin
    const a = $("#audioEl");
    const t = (MUSIC && MUSIC.queue && MUSIC.currentIndex>=0) ? MUSIC.queue[MUSIC.currentIndex] : null;
    const title = t ? getQueueItemLabel(t) : ($("#nowTitle")?.textContent||"");
    // Use stable per-track key (avoid using queue item id/title which can repeat)
    const key = (t && t.trackId) ? ("builtin:track:" + t.trackId) : ("builtin:title:" + (title||""));
    const legacyKeys = [];
    try{
      if (t && t.id) legacyKeys.push("builtin:id:" + t.id);
      if (title) legacyKeys.push("builtin:title:" + title);
    }catch(e){}
    return {
      mode:"builtin",
      playing: !!(a && !a.paused),
      t: (a && Number.isFinite(a.currentTime)) ? a.currentTime : 0,
      dur: (a && Number.isFinite(a.duration)) ? a.duration : 0,
      key,
      legacyKeys,
      title: title || ""
    };
  }

  function ktvSeekAbs(sec){
    sec = Number(sec)||0;
    const mode = getCurrentMusicMode();
    if (mode === "p1"){
      const b = ktvGetP1Bridge();
      if (b && typeof b.seekFocus === "function") return b.seekFocus(sec);
      return false;
    }
    const a = $("#audioEl");
    if (!a) return false;
    const dur = Number.isFinite(a.duration) ? a.duration : 0;
    a.currentTime = dur>0 ? ktvClamp(sec, 0, dur) : Math.max(0, sec);
    try{ updateTimeUI(); }catch(e){}
    return true;
  }

  function ktvLoadStore(){
    return ktvSafeJSON(localStorage.getItem(KTV_STORE_KEY), {});
  }
  function ktvSaveStore(store){
    try{ localStorage.setItem(KTV_STORE_KEY, JSON.stringify(store||{})); }catch(e){}
  }
  function ktvLoadUI(){
    const u = ktvSafeJSON(localStorage.getItem(KTV_UI_KEY), {});
    if (Number.isFinite(u.offset)) KTVL.offset = u.offset;
    if (Number.isFinite(u.fontSize)) KTVL.fontSize = u.fontSize;
    if (typeof u.autoScroll === "boolean") KTVL.autoScroll = u.autoScroll;
    if (typeof u.fxOn === "boolean") KTVL.fxOn = u.fxOn;
    if (typeof u.wordMode === "boolean") KTVL.wordMode = u.wordMode;
    if (typeof u.showRole === "boolean") KTVL.showRole = u.showRole;
  }
  function ktvSaveUI(){
    try{
      localStorage.setItem(KTV_UI_KEY, JSON.stringify({
        offset: KTVL.offset,
        fontSize: KTVL.fontSize,
        autoScroll: KTVL.autoScroll,
        fxOn: KTVL.fxOn,
        wordMode: KTVL.wordMode,
        showRole: KTVL.showRole
      }));
    }catch(e){}
  }

  function ktvSetStatus(msg){
    const el = $("#ktvStatus");
    if (el) el.textContent = msg || "";

    // summary badge (compact)
    const sum = $("#ktvSumStatus");
    if (sum){
      let badge = String(msg||"").trim();
      badge = badge
        .replace(/^已自动加载：/,"")
        .replace(/^已加载歌词：/,"歌词 ")
        .replace(/^已加载草稿（未保存）\s*·\s*/,"草稿 ")
        .replace(/^已加载/,"已加载 ")
        .replace(/^当前歌曲未绑定歌词.*$/,"未绑定歌词")
        .replace(/^未检测到正在播放的歌曲.*$/,"未检测到歌曲");
      if (!badge) badge = "未加载";
      if (badge.length > 18) badge = badge.slice(0,18) + "…";
      sum.textContent = badge;
    }
  }

  function ktvSetLines(parsed){
    KTVL.raw = parsed.raw || "";
    KTVL.lines = parsed.lines || [];
    KTVL.activeIdx = -1;
    KTVL.activeWord = -1;
    KTVL.lastLineSent = -1;
    ktvRenderViewer();
    ktvSetStatus(KTVL.lines.length ? `已加载歌词：${KTVL.lines.length} 行` : "歌词为空（未解析到时间戳）");
  }

  function ktvRenderViewer(){
    const box = $("#ktvViewer");
    if (!box) return;
    box.innerHTML = "";
    KTVL.lineEls = [];
    const frag = document.createDocumentFragment();
    for (let i=0;i<KTVL.lines.length;i++){
      const it = KTVL.lines[i];
      const row = document.createElement("div");
      row.className = "ktvLine";
      row.dataset.i = String(i);
      row.dataset.t = String(it.t);
      row.innerHTML = `<div class="t">${ktvFmtTS(it.t)}</div><div class="tx"></div>`;
      row.querySelector(".tx").textContent = it.text || "";
      row.addEventListener("click", ()=>{
        ktvSeekAbs(it.t);
        try{ toast("已跳转到歌词时间"); }catch(e){}
      });
      frag.appendChild(row);
      KTVL.lineEls.push(row);
    }
    box.appendChild(frag);
  }

  function ktvSetActive(i){
    if (i === KTVL.activeIdx) return;
    const prev = KTVL.lineEls[KTVL.activeIdx];
    if (prev) prev.classList.remove("active");
    KTVL.activeIdx = i;
    const cur = KTVL.lineEls[i];
    if (cur) cur.classList.add("active");

    if (cur && KTVL.autoScroll){
      try{ cur.scrollIntoView({block:"center", behavior:"smooth"}); }catch(e){ cur.scrollIntoView(); }
    }
  }

  function ktvPickIndex(t){
    // t is playback seconds (already offset-adjusted)
    const arr = KTVL.lines;
    if (!arr.length) return -1;
    // binary search last <= t
    let lo=0, hi=arr.length-1, ans=-1;
    while (lo<=hi){
      const mid=(lo+hi)>>1;
      if (arr[mid].t <= t){
        ans=mid; lo=mid+1;
      }else hi=mid-1;
    }
    return ans;
  }

  function ktvOverlaySet(_line1, _line2){
    // legacy wrapper (v2.6.34): keep calls harmless
    const pb = ktvGetPlayback();
    const pbInfo = $("#ktvPbInfo");
    if (pbInfo){
      const t = Number(pb.t)||0;
      const d = Number(pb.dur)||0;
      pbInfo.textContent = `${pb.mode||""} ${pb.playing?"▶":"⏸"}  t=${t.toFixed(2)}s / ${d.toFixed(1)}s  key=${pb.key||"—"}`;
    }

    const tForLyric = Math.max(0, (pb.t || 0) - (KTVL.offset || 0));
    const i = ktvPickIndex(tForLyric);
    ktvOverlayRender(i>=0?i:0, tForLyric, pb);
  }

  function ktvCastEnsure(){
    if (KTVL.castWin && !KTVL.castWin.closed) return true;
    return false;
  }

  function ktvSendCast(payload){
    if (!ktvCastEnsure()) return;
    try{ KTVL.castWin.postMessage(payload, "*"); }catch(e){}
  }

    function ktvLoadDraftStore(){
    try{
      const raw = localStorage.getItem("mc_ktv_drafts_v1");
      const obj = raw ? JSON.parse(raw) : {};
      return (obj && typeof obj === "object") ? obj : {};
    }catch(e){ return {}; }
  }
  function ktvSaveDraftStore(store){
    try{ localStorage.setItem("mc_ktv_drafts_v1", JSON.stringify(store||{})); }catch(e){}
  }
  let __ktvDraftSaveT = null;
  function ktvDraftSet(songKey, raw){
    if (!songKey) return;
    const store = ktvLoadDraftStore();
    store[songKey] = { raw: String(raw||""), updatedAt: Date.now() };
    ktvSaveDraftStore(store);
  }
  function ktvDraftGet(songKey){
    if (!songKey) return null;
    const store = ktvLoadDraftStore();
    const rec = store[songKey];
    if (rec && typeof rec.raw === "string") return rec.raw;
    return null;
  }

  function ktvTick(){
    // only tick after init
    if (!KTVL.inited) return;
    try{
      const pb = ktvGetPlayback();
      const pbInfo = $("#ktvPbInfo");
      if (pbInfo){
        const tt = Number(pb.t)||0;
        const dd = Number(pb.dur)||0;
        pbInfo.textContent = `${pb.mode||""} ${pb.playing?"▶":"⏸"}  t=${tt.toFixed(2)}s / ${dd.toFixed(1)}s  key=${pb.key||"—"}`;
      }

      const songKey = pb.key || "";
      const title = pb.title || "";

      // song switch
      if (songKey !== KTVL.songKey){
        // persist previous editor draft (per-song)
        try{
          const oldKey = KTVL.songKey || "";
          const edOld = $("#ktvEditor");
          if (oldKey && edOld) ktvDraftSet(oldKey, edOld.value || "");
        }catch(e){}

        KTVL.songKey = songKey;
        KTVL.songTitle = title;
        $("#ktvSongLabel") && ($("#ktvSongLabel").textContent = title || "—");

        // auto-load from store if exists (per-song); if not found, clear applied lyrics so it won't follow other songs
        if (songKey){
          const store = ktvLoadStore();
          let rec = store[songKey];

          // migrate from older keys (title / queue id) if present
          try{
            if ((!rec || !rec.raw) && pb.legacyKeys && pb.legacyKeys.length){
              for (const k of pb.legacyKeys){
                if (store[k] && store[k].raw){ rec = store[k]; break; }
              }
              if (rec && rec.raw){
                store[songKey] = { raw: rec.raw, offset: Number.isFinite(rec.offset)?rec.offset:undefined, title: rec.title||pb.title||"", updatedAt: Date.now() };
                ktvSaveStore(store);
              }
            }
          }catch(e){}

          // prefer draft (制作/打轴习惯): if draft exists, load draft first; otherwise load saved
          let draftRaw = null;
          try{ draftRaw = ktvDraftGet(songKey); }catch(e){ draftRaw = null; }

          if (draftRaw && draftRaw.trim()){
            const parsed = parseLRC(draftRaw);
            KTVL.raw = draftRaw;
            KTVL.lines = parsed.lines || [];
            KTVL.activeIdx = -1;
            KTVL.activeWord = -1;
            KTVL.lastLineSent = -1;
            ktvRenderViewer();
            ktvSetStatus(`已加载草稿（未保存） · ${KTVL.lines.length} 行`);
            const ed = $("#ktvEditor"); if (ed) ed.value = KTVL.raw;

            // notify cast preview (avoid black screen)
            if (ktvCastEnsure()){
              const cur = (KTVL.lines[0] || null);
              const next = (KTVL.lines[1] || null);
              ktvSendCast({type:"ktv_line", line: cur, next, title: title||"", fontSize:KTVL.fontSize, fxOn:KTVL.fxOn, wordMode:KTVL.wordMode, showRole:KTVL.showRole, dur: pb.dur||0, preview:true});
              ktvSendCast({type:"ktv_time", t: Math.max(0,(pb.t||0)-(KTVL.offset||0)), dur: pb.dur||0});
            }
          } else if (rec && rec.raw){
            const parsed = parseLRC(rec.raw);
            KTVL.raw = rec.raw;
            KTVL.lines = parsed.lines || [];
            KTVL.activeIdx = -1;
            KTVL.activeWord = -1;
            KTVL.lastLineSent = -1;

            // load per-song offset if any
            if (Number.isFinite(rec.offset)){
              KTVL.offset = rec.offset;
              const r = $("#ktvOffsetRange");
              const l = $("#ktvOffsetLabel");
              if (r) r.value = String(KTVL.offset);
              if (l) l.textContent = (KTVL.offset>=0?"+":"") + KTVL.offset.toFixed(2) + "s";
            }

            ktvRenderViewer();
            ktvSetStatus(`已自动加载：当前歌曲歌词（${KTVL.lines.length} 行）`);
            const ed = $("#ktvEditor"); if (ed) ed.value = KTVL.raw;

            // notify cast preview (avoid black screen)
            if (ktvCastEnsure()){
              const cur = (KTVL.lines[0] || null);
              const next = (KTVL.lines[1] || null);
              ktvSendCast({type:"ktv_line", line: cur, next, title: title||"", fontSize:KTVL.fontSize, fxOn:KTVL.fxOn, wordMode:KTVL.wordMode, showRole:KTVL.showRole, dur: pb.dur||0, preview:true});
              ktvSendCast({type:"ktv_time", t: Math.max(0,(pb.t||0)-(KTVL.offset||0)), dur: pb.dur||0});
            }
          } else {
            // clear applied lyrics + editor (KTV-like: switch song => switch lyrics)
            KTVL.raw = "";
            KTVL.lines = [];
            KTVL.activeIdx = -1;
            KTVL.activeWord = -1;
            KTVL.lastLineSent = -1;
            $("#ktvViewer") && ($("#ktvViewer").innerHTML="");
            ktvSetStatus("当前歌曲未绑定歌词（已清空；可导入/加载后再保存）");
            const ed = $("#ktvEditor"); if (ed) ed.value = "";

            // notify cast to clear
            if (ktvCastEnsure()){
              ktvSendCast({type:"ktv_line", line:null, next:null, title: title||"", fontSize:KTVL.fontSize, fxOn:KTVL.fxOn, wordMode:KTVL.wordMode, showRole:KTVL.showRole, dur: pb.dur||0, preview:true});
              ktvSendCast({type:"ktv_time", t: Math.max(0,(pb.t||0)-(KTVL.offset||0)), dur: pb.dur||0});
            }
          }
        } else {
          // no song detected -> clear applied lyrics
          KTVL.raw = "";
          KTVL.lines = [];
          KTVL.activeIdx = -1;
          KTVL.activeWord = -1;
          KTVL.lastLineSent = -1;
          $("#ktvViewer") && ($("#ktvViewer").innerHTML="");
          ktvSetStatus("未检测到正在播放的歌曲");
          const ed0 = $("#ktvEditor"); if (ed0) ed0.value = "";
          if (ktvCastEnsure()){
            ktvSendCast({type:"ktv_line", line:null, next:null, title:"", fontSize:KTVL.fontSize, fxOn:KTVL.fxOn, wordMode:KTVL.wordMode, showRole:KTVL.showRole, dur: pb.dur||0, preview:true});
            ktvSendCast({type:"ktv_time", t:0, dur: pb.dur||0});
          }
        }
      }

      if (!KTVL.lines.length){
        // keep time updates for cast even when no lyrics
        if (ktvCastEnsure()){
          const tForLyric0 = Math.max(0, (pb.t || 0) - (KTVL.offset || 0));
          ktvSendCast({type:"ktv_time", t: tForLyric0, dur: pb.dur||0});
        }
        return;
      }

      // Offset rule: + 延后 / - 提前 => use (t - offset) to pick lyric time
      const tForLyric = Math.max(0, (pb.t || 0) - (KTVL.offset || 0));
      const i = ktvPickIndex(tForLyric);

      if (i>=0){
        ktvSetActive(i);
        KTVL.activeWord = ktvPickWordIndex(KTVL.lines[i], tForLyric);
      }

      // overlay
      const ov = $("#ktvOverlay");
      if (ov && ov.classList.contains("show")){
        ktvOverlayRender(i>=0?i:0, tForLyric, pb);
      }

      // cast (2nd screen)
      if (ktvCastEnsure()){
        if (i !== KTVL.lastLineSent){
          KTVL.lastLineSent = i;
          const cur = (i>=0) ? (KTVL.lines[i] || null) : null;
          const next = (i>=0) ? (KTVL.lines[i+1] || null) : null;
          ktvSendCast({type:"ktv_line", line: cur, next, title: KTVL.songTitle||"", fontSize:KTVL.fontSize, fxOn:KTVL.fxOn, wordMode:KTVL.wordMode, showRole:KTVL.showRole, dur: pb.dur||0});
        }
        ktvSendCast({type:"ktv_time", t: tForLyric, dur: pb.dur||0});
      }
    }catch(e){}
  }

  function initKtvUI(){
    const btnOpen = $("#btnMusicKtv");
    const details = $("#ktvDetails");
    if (!details) return;
    if (KTVL.inited) return;
    KTVL.inited = true;

    // open KTV panel
    if (btnOpen && !btnOpen.__bound){
      btnOpen.__bound = true;
      btnOpen.addEventListener("click", ()=>{
        details.open = true;
        try{ details.scrollIntoView({behavior:"smooth", block:"start"}); }catch(e){}
      });
    }

    // load persisted UI prefs
    ktvLoadUI();
    const offsetRange = $("#ktvOffsetRange");
    const offsetLabel = $("#ktvOffsetLabel");
    const fontRange = $("#ktvFontRange");
    const fontLabel = $("#ktvFontLabel");
    const autoScroll = $("#ktvAutoScroll");
    const fxOn = $("#ktvFxOn");
    const wordMode = $("#ktvWordMode");
    const showRole = $("#ktvShowRole");

    // Modern toggle buttons (map to hidden checkboxes)
    const ktvTogGrid = $("#ktvTogGrid");
    const ktvSyncTogButtons = ()=>{
      if (!ktvTogGrid) return;
      const pairs = [
        ["ktvAutoScroll", autoScroll],
        ["ktvFxOn", fxOn],
        ["ktvWordMode", wordMode],
        ["ktvShowRole", showRole],
      ];
      for (const [id, el] of pairs){
        const btn = ktvTogGrid.querySelector(`.ktvTog[data-kid="${id}"]`);
        if (!btn || !el) continue;
        const on = !!el.checked;
        btn.setAttribute("aria-pressed", on ? "true" : "false");
        btn.classList.toggle("on", on);
      }
    };
    const ktvBindTogButton = (id, el)=>{
      if (!ktvTogGrid || !el) return;
      const btn = ktvTogGrid.querySelector(`.ktvTog[data-kid="${id}"]`);
      if (!btn) return;
      btn.addEventListener("click", (ev)=>{
        ev.preventDefault();
        ev.stopPropagation();
        el.checked = !el.checked;
        el.dispatchEvent(new Event("change", {bubbles:true}));
        ktvSyncTogButtons();
      });
      el.addEventListener("change", ktvSyncTogButtons);
    };
    ktvBindTogButton("ktvAutoScroll", autoScroll);
    ktvBindTogButton("ktvFxOn", fxOn);
    ktvBindTogButton("ktvWordMode", wordMode);
    ktvBindTogButton("ktvShowRole", showRole);
    setTimeout(ktvSyncTogButtons, 0);

    const applyKtvStyleNow = ()=>{
      const pb = ktvGetPlayback();
      const tForLyric = Math.max(0, (pb.t || 0) - (KTVL.offset || 0));
      const i0 = ktvPickIndex(tForLyric);
      const hasLines = !!(KTVL.lines && KTVL.lines.length);
      const idx = (i0>=0) ? i0 : (hasLines ? 0 : -1);

      // overlay in this page
      ktvOverlayRender(idx>=0?idx:0, tForLyric, pb);

      // cast window (2nd screen)
      if (ktvCastEnsure()){
        ktvSendCast({type:"ktv_style", fontSize:KTVL.fontSize, fxOn:KTVL.fxOn, wordMode:KTVL.wordMode, showRole:KTVL.showRole});
        // keep progress moving even if we're in intro (before first line)
        ktvSendCast({type:"ktv_time", t: tForLyric, dur: pb.dur||0});
        if (idx>=0){
          ktvSendCast({
            type:"ktv_line",
            line: KTVL.lines[idx]||null,
            next: KTVL.lines[idx+1]||null,
            title: KTVL.songTitle||"",
            fontSize:KTVL.fontSize, fxOn:KTVL.fxOn, wordMode:KTVL.wordMode, showRole:KTVL.showRole,
            dur: pb.dur||0,
            preview: (i0<0)
          });
        }else{
          ktvSendCast({
            type:"ktv_line",
            line: null, next: null,
            title: KTVL.songTitle||"",
            fontSize:KTVL.fontSize, fxOn:KTVL.fxOn, wordMode:KTVL.wordMode, showRole:KTVL.showRole,
            dur: pb.dur||0,
            preview: true
          });
        }
      }
    };

    if (offsetRange){
      offsetRange.value = String(KTVL.offset || 0);
      if (offsetLabel) offsetLabel.textContent = (KTVL.offset>=0?"+":"") + Number(offsetRange.value).toFixed(2) + "s";
      offsetRange.addEventListener("input", ()=>{
        KTVL.offset = Number(offsetRange.value)||0;
        if (offsetLabel) offsetLabel.textContent = (KTVL.offset>=0?"+":"") + KTVL.offset.toFixed(2) + "s";
        ktvSaveUI();
        applyKtvStyleNow();
      });
    }
    if (fontRange){
      fontRange.value = String(KTVL.fontSize || 56);
      if (fontLabel) fontLabel.textContent = String(KTVL.fontSize) + "px";
      fontRange.addEventListener("input", ()=>{
        KTVL.fontSize = Math.round(Number(fontRange.value)||56);
        if (fontLabel) fontLabel.textContent = String(KTVL.fontSize) + "px";
        ktvSaveUI();
        applyKtvStyleNow();
      });
    }
    if (autoScroll){
      autoScroll.checked = !!KTVL.autoScroll;
      autoScroll.addEventListener("change", ()=>{
        KTVL.autoScroll = !!autoScroll.checked;
        ktvSaveUI();
      
        try{ applyKtvStyleNow(); }catch(e){}
      });
    }
    if (fxOn){
      fxOn.checked = !!KTVL.fxOn;
      fxOn.addEventListener("change", ()=>{
        KTVL.fxOn = !!fxOn.checked;
        ktvSaveUI();
        applyKtvStyleNow();
      });
    }
    if (wordMode){
      wordMode.checked = !!KTVL.wordMode;
      wordMode.addEventListener("change", ()=>{
        KTVL.wordMode = !!wordMode.checked;
        ktvSaveUI();
        applyKtvStyleNow();
      });
    }
    if (showRole){
      showRole.checked = !!KTVL.showRole;
      showRole.addEventListener("change", ()=>{
        KTVL.showRole = !!showRole.checked;
        ktvSaveUI();
        applyKtvStyleNow();
      });
    }

    // buttons
    const pick = $("#ktvPickLrc");
    $("#btnKtvLoadLrc")?.addEventListener("click", ()=>{
      try{ pick && pick.click(); }catch(e){}
    });
    if (pick){
      pick.addEventListener("change", ()=>{
        const f = pick.files && pick.files[0];
        if (!f) return;
        const rd = new FileReader();
        rd.onload = ()=>{
          const raw = String(rd.result||"");
          const parsed = parseLRC(raw);
          ktvSetLines(parsed);
          // keep editor in sync
          const ed = $("#ktvEditor");
          if (ed) ed.value = parsed.raw || raw;
        };
        rd.readAsText(f, "utf-8");
        pick.value = "";
      });
    }

    // editor draft autosave (per-song) — keeps "草稿" when you切歌回来
    try{
      const edDraft = $("#ktvEditor");
      if (edDraft && !edDraft.__draftBound){
        edDraft.__draftBound = true;
        edDraft.addEventListener("input", ()=>{
          if (!KTVL.songKey) return;
          if (__ktvDraftSaveT) clearTimeout(__ktvDraftSaveT);
          __ktvDraftSaveT = setTimeout(()=>{
            try{ ktvDraftSet(KTVL.songKey, edDraft.value || ""); }catch(e){}
          }, 250);
        });
      }
    }catch(e){}

    const editorWrap = $("#ktvEditorWrap");
    $("#btnKtvEdit")?.addEventListener("click", ()=>{
      if (!editorWrap) return;
      editorWrap.style.display = (editorWrap.style.display==="none" || !editorWrap.style.display) ? "block" : "none";
      const ed = $("#ktvEditor");
      if (ed && !ed.value) ed.value = KTVL.raw || "";
    });
    $("#btnKtvCancelEdit")?.addEventListener("click", ()=>{
      if (editorWrap) editorWrap.style.display = "none";
    });
    $("#btnKtvApply")?.addEventListener("click", ()=>{
      const ed = $("#ktvEditor");
      const raw = ed ? ed.value : "";
      const parsed = parseLRC(raw);
      ktvSetLines(parsed);
      if (editorWrap) editorWrap.style.display = "none";
    });

    $("#btnKtvClear")?.addEventListener("click", ()=>{
      KTVL.raw = "";
      KTVL.lines = [];
      KTVL.activeIdx = -1;
      KTVL.songKey = "";
      $("#ktvViewer") && ($("#ktvViewer").innerHTML="");
      ktvSetStatus("已清空歌词");
    });

    $("#btnKtvSaveSong")?.addEventListener("click", ()=>{
      const pb = ktvGetPlayback();
      if (!pb.key){
        toast("请先播放一首歌，再保存歌词");
        return;
      }
      if (!KTVL.raw || !KTVL.lines.length){
        toast("当前没有可保存的歌词（先导入/粘贴并应用）");
        return;
      }
      const store = ktvLoadStore();
      store[pb.key] = { raw: KTVL.raw, offset: KTVL.offset, title: pb.title || "", updatedAt: Date.now() };
      ktvSaveStore(store);
      KTVL.songKey = pb.key;
      KTVL.songTitle = pb.title || "";
      ktvSetStatus("✅ 已保存并绑定到当前歌曲");
      toast("歌词已保存 ✅");
      try{ ktvDraftSet(pb.key, KTVL.raw); }catch(e){}
    });

    $("#btnKtvLoadSong")?.addEventListener("click", ()=>{
      const pb = ktvGetPlayback();
      if (!pb.key){
        toast("请先播放一首歌，再加载歌词");
        return;
      }
      const store = ktvLoadStore();
      if (store[pb.key] && store[pb.key].raw){
        const parsed = parseLRC(store[pb.key].raw);
        KTVL.raw = store[pb.key].raw;
        KTVL.lines = parsed.lines || [];
        KTVL.activeIdx = -1;
        ktvRenderViewer();
        if (Number.isFinite(store[pb.key].offset)){
          KTVL.offset = store[pb.key].offset;
          if (offsetRange) offsetRange.value = String(KTVL.offset);
          if (offsetLabel) offsetLabel.textContent = (KTVL.offset>=0?"+":"") + KTVL.offset.toFixed(2) + "s";
        }
        const ed = $("#ktvEditor"); if (ed) ed.value = KTVL.raw;
        ktvSetStatus(`已加载当前歌曲歌词（${KTVL.lines.length} 行）`);
        toast("已加载歌词 ✅");
      }else{
        toast("当前歌曲未找到已保存歌词");
      }
    });

    // Fullscreen overlay in this page
    const ov = $("#ktvOverlay");
    const btnFull = $("#btnKtvFull");
    const btnExit = $("#btnKtvOverlayExit");
    const hideOv = ()=>{
      if (!ov) return;
      ov.classList.remove("show");
      try{ document.exitFullscreen && document.exitFullscreen(); }catch(e){}
    };
    btnFull?.addEventListener("click", ()=>{
      if (!ov) return;
      ov.classList.add("show");
      // fill text immediately
      const i = KTVL.activeIdx>=0 ? KTVL.activeIdx : 0;
      const line1 = KTVL.lines[i]?.text || "—";
      const line2 = KTVL.lines[i+1]?.text || "";
      ktvOverlaySet(line1, line2);
      // request fullscreen (best-effort)
      try{ ov.requestFullscreen && ov.requestFullscreen(); }catch(e){}
    });
    btnExit?.addEventListener("click", hideOv);
    ov?.addEventListener("click", (e)=>{
      if (e.target === ov) hideOv();
    });
    window.addEventListener("keydown", (e)=>{
      if (!ov || !ov.classList.contains("show")) return;
      if (e.key === "Escape"){
        e.preventDefault();
        hideOv();
      }
    }, true);

    // Cast window (2nd screen)
    const btnCast = $("#btnKtvCast");
    const btnStop = $("#btnKtvStopCast");

    function openCastWin(){
      const w = window.open("", "ktv_cast", "width=980,height=680");
      if (!w){
        toast("弹窗被浏览器拦截：请允许弹窗后重试");
        return null;
      }
      const doc = w.document;
      doc.open();
      doc.write(`<!doctype html>
<html lang="zh-CN"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KTV 歌词投放</title>
<style>
  :root{
    --bg:#000; --fg:#fff; --muted:rgba(255,255,255,.7);
    --ktv-outline: rgba(0,0,0,.88);
    --ktv-unsung: rgba(255,255,255,.92);
    --ktv-sung: rgba(120,255,220,.95);
    --ktv-hot-a:#ffe27a; --ktv-hot-b:#ff7a18; --ktv-hot-c:#ff3b6b;
    --ktv-role-m:#6cf; --ktv-role-f:#ff6aa5; --ktv-role-d:#ffb0ff; --ktv-role-bg:#a6ff6a;
  }
  body{ margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial; overflow:hidden; }
  .top{ position:fixed; left:0; right:0; top:0; padding:10px 14px; display:flex; gap:12px; align-items:center; justify-content:space-between;
        background:linear-gradient(to bottom, rgba(0,0,0,.72), rgba(0,0,0,0)); z-index:10; }
  .title{ font-weight:900; letter-spacing:.5px; }
  .hint{ font-size:12px; color:var(--muted); }
  .wrap{ height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:14px; padding:24px; text-align:center; }
  .role{
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
    border:1px solid rgba(255,255,255,.18); background:rgba(0,0,0,.35); color:rgba(255,255,255,.9); font-size:12px; letter-spacing:.5px;
  }
  .role i{ width:8px; height:8px; border-radius:50%; display:inline-block; background:var(--ktv-role-m); }
  .role.role-f i{ background:var(--ktv-role-f); }
  .role.role-d i{ background:var(--ktv-role-d); }
  .role.role-bg i{ background:var(--ktv-role-bg); }

  .l1{ font-weight:1000; line-height:1.18; text-shadow:0 8px 26px rgba(0,0,0,.6); white-space:pre-wrap; transform:translateZ(0); backface-visibility:hidden; -webkit-font-smoothing:antialiased; contain:paint; }
  .l2{ opacity:.50; line-height:1.2; white-space:pre-wrap; color:rgba(255,255,255,.60); }

  .prog{ width:min(86vw,980px); height:10px; border-radius:999px; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.14); overflow:hidden; }
  .prog > i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--ktv-hot-a),var(--ktv-hot-b),var(--ktv-hot-c)); filter:drop-shadow(0 10px 18px rgba(0,0,0,.55)); }

  .ktvWord{
    display:inline-block; padding:0 .04em; color:var(--ktv-unsung);
    -webkit-text-stroke:2px var(--ktv-outline);
    text-shadow:0 4px 18px rgba(0,0,0,.55), 0 0 1px rgba(0,0,0,.6);
  }
  .ktvWord.sung{ color:var(--ktv-sung); filter:saturate(1.08); }
  .ktvWord.hot{
    color:transparent;
    background:linear-gradient(90deg,var(--ktv-hot-a),var(--ktv-hot-b),var(--ktv-hot-c),var(--ktv-hot-a));
    background-size:100% 100%;
    -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
    filter:drop-shadow(0 8px 16px rgba(0,0,0,.50));
    animation:none;
  }
  @keyframes ktvShine{ 0%{background-position:0% 50%} 100%{background-position:100% 50%} }

  .ktvLineFx{
    display:inline-block;
    white-space:pre-wrap;
    -webkit-text-stroke:2px var(--ktv-outline);
    text-shadow:0 4px 18px rgba(0,0,0,.55), 0 0 1px rgba(0,0,0,.6);
    color:transparent;
    background:
      linear-gradient(90deg,var(--ktv-hot-a),var(--ktv-hot-b),var(--ktv-hot-c)) 0 0 / var(--p,0%) 100% no-repeat,
      linear-gradient(90deg,var(--ktv-unsung),var(--ktv-unsung)) 0 0 / 100% 100% no-repeat;
    -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
  }
</style>
</head><body>
  <div class="top">
    <div>
      <div class="title" id="t">🎤 KTV 歌词投放</div>
      <div class="hint" id="h">拖到第二屏/电视后，按主窗口播放即可</div>
    </div>
    <div class="hint" id="s">等待歌词…</div>
  </div>

  <div class="wrap">
    <div class="role" id="role" style="display:none"><i></i><span>—</span></div>
    <div class="l1" id="l1">—</div>
    <div class="prog" id="prog"><i></i></div>
    <div class="l2" id="l2"></div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);
  const clamp = (n,a,b)=>Math.max(a,Math.min(n,b));
  const esc = (s)=>String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");

  const roleLabel = (r)=>{
    r = (r||"").toUpperCase();
    if (r==="M") return "男声";
    if (r==="F") return "女声";
    if (r==="D") return "合唱";
    if (r==="BG") return "和声/伴唱";
    return "";
  };
  const roleClass = (r)=>{
    r = (r||"").toUpperCase();
    if (r==="F") return "role-f";
    if (r==="D") return "role-d";
    if (r==="BG") return "role-bg";
    return "role-m";
  };

  let st = {
    line:null, next:null,
    t:0, dur:0,
    title:"",
    fontSize:${KTVL.fontSize},
    fxOn:${KTVL.fxOn},
    wordMode:${KTVL.wordMode},
    showRole:${KTVL.showRole}
  };

  function lineEnd(){
    if (st.next && typeof st.next.t === "number" && st.line && st.next.t > st.line.t + 0.02) return st.next.t;
    if (st.dur && st.line && st.dur > st.line.t) return st.dur;
    return st.line ? (st.line.t + 6) : 0;
  }

  function pickWordIndex(line, t){
    const w = line && Array.isArray(line.words) ? line.words : null;
    if (!w || !w.length) return -1;
    let lo=0, hi=w.length-1, ans=-1;
    while (lo<=hi){
      const mid=(lo+hi)>>1;
      if (w[mid].t <= t){ ans=mid; lo=mid+1; } else hi=mid-1;
    }
    return ans;
  }

    function renderLineHTML(line, t, end){
    if (!line) return st.title ? ("♪ "+esc(st.title)+" ♪") : "—";
    const text = line.text || "—";
    if (!st.fxOn) return esc(text);
    const words = (st.wordMode && line.words && Array.isArray(line.words) && line.words.length) ? line.words : null;
    if (!words){
      const total = Math.max(0.001, (end||0) - (line.t||0));
      const pct = clamp(((t - (line.t||0)) / total) * 100, 0, 100);
      const et = esc(text);
      return '<span class="ktvLineFx" style="--p:'+pct.toFixed(2)+'%" data-text="'+et+'">'+et+'</span>';
    }

    const wi = pickWordIndex(line, t);
    let h = "";
    for (let i=0;i<words.length;i++){
      const w = words[i];
      const txt = w.txt || "";
      const nextT = (i+1<words.length) ? words[i+1].t : (end || (line.t+6));
      const isHot = (i===wi) && (t < nextT);
      const isSung = (t >= nextT);
      let cls = "ktvWord";
      if (isHot) cls += " hot";
      else if (isSung) cls += " sung";
      h += '<span class="'+cls+'">'+esc(txt)+'</span>';
    }
    return h || esc(text);
  }

  function applySize(){
    $("l1").style.fontSize = st.fontSize + "px";
    $("l2").style.fontSize = Math.max(18, Math.round(st.fontSize*0.55)) + "px";
  }

  function render(){
    applySize();
    const end = lineEnd();

    // role cue
    const r = st.line ? (st.line.role||"") : "";
    const lab = roleLabel(r);
    const roleEl = $("role");
    if (st.showRole && lab){
      roleEl.style.display = "";
      roleEl.classList.remove("role-m","role-f","role-d","role-bg");
      roleEl.classList.add(roleClass(r));
      roleEl.querySelector("span").textContent = lab;
    }else{
      roleEl.style.display = "none";
    }

    // lines
    $("l1").innerHTML = renderLineHTML(st.line, st.t, end);
    $("l2").textContent = st.next ? (st.next.text||"") : "";

    // progress
    const bar = $("prog").querySelector("i");
    if (st.line && end > st.line.t){
      const pct = clamp(((st.t - st.line.t)/(end - st.line.t))*100, 0, 100);
      bar.style.width = pct.toFixed(2) + "%";
    }else{
      bar.style.width = "0%";
    }

    // status
    $("s").textContent = st.title ? ("正在播放："+st.title) : "投放中…";
  }

  let raf = 0;
  function schedule(){
    if (raf) return;
    raf = requestAnimationFrame(()=>{ raf = 0; render(); });
  }
  render();

  window.addEventListener("message", (ev)=>{
    const d = ev.data || {};
    if (d.type === "ktv_line"){
      st.line = d.line || null;
      st.next = d.next || null;
      st.title = d.title || "";
      if (typeof d.fontSize === "number") st.fontSize = d.fontSize;
      if (typeof d.fxOn === "boolean") st.fxOn = d.fxOn;
      if (typeof d.wordMode === "boolean") st.wordMode = d.wordMode;
      if (typeof d.showRole === "boolean") st.showRole = d.showRole;
      if (typeof d.dur === "number") st.dur = d.dur;
      schedule();
    } else if (d.type === "ktv_time"){
      st.t = Number(d.t)||0;
      if (typeof d.dur === "number") st.dur = d.dur;
      schedule();
    } else if (d.type === "ktv_style"){
      if (typeof d.fontSize === "number") st.fontSize = d.fontSize;
      if (typeof d.fxOn === "boolean") st.fxOn = d.fxOn;
      if (typeof d.wordMode === "boolean") st.wordMode = d.wordMode;
      if (typeof d.showRole === "boolean") st.showRole = d.showRole;
      schedule();
    }
  });
<\/script>
</body></html>`);
      doc.close();
      return w;
    }

    // Expose helpers for fallback handlers (in case dynamic UI causes listeners to drop)
    try{ window.__ktvOpenCastWin = openCastWin; }catch(e){}
    try{ window.__ktvCloseCastWin = ()=>{
      try{ if (KTVL.castWin && !KTVL.castWin.closed) KTVL.castWin.close(); }catch(e){}
      KTVL.castWin = null;
      const bs = $("#btnKtvStopCast"); if (bs) bs.style.display = "none";
    }; }catch(e){}

    btnCast?.addEventListener("click", ()=>{
      const w = openCastWin();
      if (!w) return;
      KTVL.castWin = w;
      btnStop && (btnStop.style.display = "");
      try{ applyKtvStyleNow(); }catch(e){}
      toast("投放窗口已打开（可拖到第二屏）");
    });

    btnStop?.addEventListener("click", ()=>{
      try{ if (KTVL.castWin && !KTVL.castWin.closed) KTVL.castWin.close(); }catch(e){}
      KTVL.castWin = null;
      btnStop.style.display = "none";
      toast("已关闭投放窗口");
    });
    // mark controls as bound (for fallback detector)
    try{
      ["btnMusicKtv","btnKtvLoadLrc","btnKtvEdit","btnKtvCancelEdit","btnKtvApply","btnKtvClear","btnKtvSaveSong","btnKtvLoadSong","btnKtvFull","btnKtvCast","btnKtvStopCast","btnKtvOverlayExit"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.dataset.ktvBound = "1";
      });
      ["ktvOffsetRange","ktvFontRange","ktvAutoScroll","ktvFxOn","ktvWordMode","ktvShowRole","ktvPickLrc","ktvEditor"].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.dataset.ktvBound = "1";
      });
    }catch(e){}

    // start tick
    if (!KTVL.timer){
      KTVL.timer = setInterval(ktvTick, 50);
    }
    // immediate tick once
    setTimeout(ktvTick, 50);
  }

  // --- KTV fallback (self-heal): if UI gets re-rendered and listeners drop, keep KTV buttons usable ---
  (function installKtvFallback(){
    if (window.__ktvFallbackInstalled) return;
    window.__ktvFallbackInstalled = true;

    function isKtvBtnId(id){
      return id === "btnMusicKtv" || (id && id.startsWith("btnKtv"));
    }

    document.addEventListener("click", (e)=>{
      const btn = e.target && e.target.closest ? e.target.closest("button") : null;
      if (!btn) return;
      const id = btn.id || "";
      if (!isKtvBtnId(id)) return;

      // If already bound by init, do nothing.
      if (btn.dataset && btn.dataset.ktvBound === "1") return;

      // Try init once (best-effort)
      try{ initKtvUI(); }catch(err){ console.error(err); }

      try{
        const details = document.getElementById("ktvDetails");
        const editorWrap = document.getElementById("ktvEditorWrap");
        const ov = document.getElementById("ktvOverlay");
        const offsetRange = document.getElementById("ktvOffsetRange");
        const offsetLabel = document.getElementById("ktvOffsetLabel");
        const fontRange = document.getElementById("ktvFontRange");
        const fontLabel = document.getElementById("ktvFontLabel");

        const stop = ()=>{
          e.preventDefault();
          e.stopImmediatePropagation();
          e.stopPropagation();
        };

        if (id === "btnMusicKtv"){
          if (details){
            details.open = true;
            try{ details.scrollIntoView({behavior:"smooth", block:"start"}); }catch(_){}
          }
          stop(); return;
        }

        if (id === "btnKtvLoadLrc"){
          const pick = document.getElementById("ktvPickLrc");
          try{ pick && pick.click(); }catch(_){}
          stop(); return;
        }

        if (id === "btnKtvEdit"){
          if (editorWrap){
            editorWrap.style.display = (editorWrap.style.display==="none" || !editorWrap.style.display) ? "block" : "none";
            const ed = document.getElementById("ktvEditor");
            if (ed && !ed.value) ed.value = KTVL.raw || "";
          }
          stop(); return;
        }

        if (id === "btnKtvCancelEdit"){
          if (editorWrap) editorWrap.style.display = "none";
          stop(); return;
        }

        if (id === "btnKtvApply"){
          const ed = document.getElementById("ktvEditor");
          const raw = ed ? ed.value : "";
          const parsed = parseLRC(raw);
          ktvSetLines(parsed);
          if (editorWrap) editorWrap.style.display = "none";
          stop(); return;
        }

        if (id === "btnKtvClear"){
          KTVL.raw = "";
          KTVL.lines = [];
          KTVL.activeIdx = -1;
          KTVL.activeWord = -1;
          KTVL.lastLineSent = -1;
          const v = document.getElementById("ktvViewer"); if (v) v.innerHTML = "";
          const ed = document.getElementById("ktvEditor"); if (ed) ed.value = "";
          ktvSetStatus("已清空歌词");
          try{ toast("已清空"); }catch(_){}
          stop(); return;
        }

        if (id === "btnKtvSaveSong"){
          const pb = ktvGetPlayback();
          if (!pb.key){ try{ toast("请先播放一首歌，再保存歌词"); }catch(_){} stop(); return; }
          if (!KTVL.raw || !KTVL.lines.length){ try{ toast("当前没有可保存的歌词（先导入/粘贴并应用）"); }catch(_){} stop(); return; }
          const store = ktvLoadStore();
          store[pb.key] = { raw: KTVL.raw, offset: KTVL.offset, title: pb.title || "", updatedAt: Date.now() };
          ktvSaveStore(store);
          KTVL.songKey = pb.key;
          KTVL.songTitle = pb.title || "";
          ktvSetStatus("✅ 已保存并绑定到当前歌曲");
          try{ toast("歌词已保存 ✅"); }catch(_){}
          stop(); return;
        }

        if (id === "btnKtvLoadSong"){
          const pb = ktvGetPlayback();
          if (!pb.key){ try{ toast("请先播放一首歌，再加载歌词"); }catch(_){} stop(); return; }
          const store = ktvLoadStore();
          const rec = store[pb.key];
          if (rec && rec.raw){
            const parsed = parseLRC(rec.raw);
            KTVL.raw = rec.raw;
            KTVL.lines = parsed.lines || [];
            KTVL.activeIdx = -1;
            KTVL.activeWord = -1;
            KTVL.lastLineSent = -1;
            ktvRenderViewer();
            if (Number.isFinite(rec.offset)){
              KTVL.offset = rec.offset;
              if (offsetRange) offsetRange.value = String(KTVL.offset);
              if (offsetLabel) offsetLabel.textContent = (KTVL.offset>=0?"+":"") + KTVL.offset.toFixed(2) + "s";
            }
            const ed = document.getElementById("ktvEditor"); if (ed) ed.value = KTVL.raw;
            ktvSetStatus(`已加载当前歌曲歌词（${KTVL.lines.length} 行）`);
            try{ toast("已加载歌词 ✅"); }catch(_){}
          }else{
            try{ toast("当前歌曲未找到已保存歌词"); }catch(_){}
          }
          stop(); return;
        }

        if (id === "btnKtvFull"){
          if (ov){
            ov.classList.add("show");
            const pb = ktvGetPlayback();
            const tForLyric = Math.max(0, (pb.t||0) - (KTVL.offset||0));
            const i0 = ktvPickIndex(tForLyric);
            ktvOverlayRender(i0>=0?i0:0, tForLyric, pb);
            try{ ov.requestFullscreen && ov.requestFullscreen(); }catch(_){}
          }
          stop(); return;
        }

        if (id === "btnKtvOverlayExit"){
          if (ov) ov.classList.remove("show");
          try{ document.exitFullscreen && document.exitFullscreen(); }catch(_){}
          stop(); return;
        }

        if (id === "btnKtvCast"){
          const w = (window.__ktvOpenCastWin ? window.__ktvOpenCastWin() : null);
          if (w){
            KTVL.castWin = w;
            const bs = document.getElementById("btnKtvStopCast"); if (bs) bs.style.display = "";
            try{ toast("投放窗口已打开（可拖到第二屏）"); }catch(_){}
          }
          stop(); return;
        }

        if (id === "btnKtvStopCast"){
          try{ window.__ktvCloseCastWin && window.__ktvCloseCastWin(); }catch(_){}
          try{ toast("已关闭投放窗口"); }catch(_){}
          stop(); return;
        }

      }catch(err){
        console.error(err);
        try{ toast("KTV 按钮执行出错：请刷新后重试"); }catch(_){}
        e.preventDefault();
        e.stopImmediatePropagation();
        e.stopPropagation();
      }
    }, true);
  })();




  // --- UVR <-> P1 Bridge helpers ---
  async function uvrGetP1Bridge(){
    ensureP1ConsoleLoaded();
    const fr = $("#p1ConsoleFrame");
    if (!fr) throw new Error("P1 播控台未找到");
    // wait iframe load
    if (!fr.__p1ready){
      await new Promise((resolve, reject)=>{
        const tm = setTimeout(()=>reject(new Error("P1 载入超时")), 8000);
        fr.addEventListener("load", ()=>{ clearTimeout(tm); fr.__p1ready = true; resolve(); }, {once:true});
      });
    }
    const w = fr.contentWindow;
    if (!w) throw new Error("P1 未就绪");
    // retry until bridge appears (bootstrap is async)
    for (let i=0;i<16;i++){
      const b = w.__UVR_P1__;
      if (b) return b;
      await new Promise(r=>setTimeout(r, 120));
    }
    throw new Error("P1 Bridge 未就绪（请先打开一次 P1 播控台）");
  }

  async function uvrGetP1CueBlob(cueId){
    const b = await uvrGetP1Bridge();
    if (!b || typeof b.getCueBlob !== "function") throw new Error("P1 Bridge 缺少 getCueBlob");
    return await b.getCueBlob(cueId);
  }

  function uvrSetMusicPage(p){
    if (p) document.body.dataset.musicPage = p;
    else delete document.body.dataset.musicPage;
  }

  function uvrScrollIntoView(){
    try{ $("#musicSystem")?.scrollIntoView({behavior:"smooth", block:"start"}); }catch(e){}
  }

  function bindUvrUI(){
    const col = document.getElementById("uvrCol");
    if (!col || col.__bound) return;
    col.__bound = true;

    const sel = document.getElementById("uvrSourceSel");
    const srcType = document.getElementById("uvrSourceType");
    const srcFilter = document.getElementById("uvrSourceFilter");
    const destSel = document.getElementById("uvrDestPlayer");
    const btnBack = document.getElementById("btnUvrBack");
    const btnGo = document.getElementById("btnMusicUvrPage");
    const status = document.getElementById("uvrStatus");
    const msg = document.getElementById("uvrMsg");
    const prog = document.getElementById("uvrProgressBar");

    const btnNow = document.getElementById("btnUvrUseNow");
    const btnRun = document.getElementById("btnUvrRun");
    const btnCancel = document.getElementById("btnUvrCancel");
    const btnPick = document.getElementById("btnUvrPickFile");
    const fileIn = document.getElementById("uvrPickFile");

    const strength = document.getElementById("uvrStrength");
    const strengthVal = document.getElementById("uvrStrengthVal");

    const preview = document.getElementById("uvrPreview");
    const aVoc = document.getElementById("uvrAudioVoc");
    const aInst = document.getElementById("uvrAudioInst");
    const volVoc = document.getElementById("uvrVolVoc");
    const volInst = document.getElementById("uvrVolInst");

    const btnExpVoc = document.getElementById("btnUvrExportVoc");
    const btnExpInst = document.getElementById("btnUvrExportInst");
    const btnToLib = document.getElementById("btnUvrToLib");
    const btnToQueue = document.getElementById("btnUvrToQueue");
    const btnToPlay = document.getElementById("btnUvrToPlay");

    const setMsg = (t)=>{ if (msg) msg.textContent = String(t||""); };
    const setProg = (p)=>{ if (!prog) return; prog.style.width = `${clampNum(p,0,1)*100}%`; };

    // init sources
    async function refreshSourceSelect(keepId=null){
      if (!sel) return;
      const type = (srcType && srcType.value === "p1") ? "p1" : "builtin";
      const kw = ((srcFilter && srcFilter.value) ? srcFilter.value : "").trim().toLowerCase();
      const cur = keepId || sel.value || "";

      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = (type==="p1") ? "— 选择 P1 CUE —" : "— 选择音乐库曲目 —";
      sel.appendChild(opt0);

      if (type === "builtin"){
        const list = (MUSIC.tracks||[]).slice().sort((a,b)=> (a.name||"").localeCompare(b.name||"","zh-Hans-CN"));
        list.filter(t=>{
          if (!kw) return true;
          const n = (t.name||"").toLowerCase();
          const c = (t.cat||"").toLowerCase();
          return n.includes(kw) || c.includes(kw);
        }).forEach(t=>{
          const o = document.createElement("option");
          o.value = t.id;
          o.textContent = `${t.name||"未命名"}${t.cat?("  ·  "+t.cat):""}`;
          sel.appendChild(o);
        });
        sel.value = cur && list.some(t=>t.id===cur) ? cur : "";
        return;
      }

      // P1 cues (full library)
      try{
        const b = await uvrGetP1Bridge();
        const got = (b && typeof b.listAllCues === "function") ? await b.listAllCues() : [];
        UVR.p1Cues = Array.isArray(got) ? got : [];
      }catch(e){
        UVR.p1Cues = [];
      }

      const list = (UVR.p1Cues||[]).slice().sort((a,b)=> (a.name||"").localeCompare(b.name||"","zh-Hans-CN"));
      list.filter(c=>{
        if (!kw) return true;
        const n = (c.name||"").toLowerCase();
        const cn = (c.catName||"").toLowerCase();
        return n.includes(kw) || cn.includes(kw);
      }).forEach(c=>{
        const o = document.createElement("option");
        o.value = c.id;
        o.textContent = `${c.name||"未命名"}${c.catName?("  ·  "+c.catName):""}`;
        sel.appendChild(o);
      });
      sel.value = cur && list.some(c=>c.id===cur) ? cur : "";
    }

    refreshSourceSelect();
    // keep refreshed after library changes
    const _oldRenderLib = window.renderLibrary;
    try{
      if (typeof _oldRenderLib === "function" && !_oldRenderLib.__uvrPatched){
        window.renderLibrary = function(){
          const r = _oldRenderLib.apply(this, arguments);
          try{ refreshSourceSelect(sel.value); }catch(e){}
          return r;
        };
        window.renderLibrary.__uvrPatched = true;
      }
    }catch(e){}

    // engine radio
    col.querySelectorAll('input[name="uvrEngine"]').forEach(r=>{
      r.addEventListener("change", ()=>{
        UVR.engine = r.value;
        syncUvrStatus();
      });
    });

    // presets
    const preset = (k)=>{
      UVR.preset = k;
      if (k==="std"){ UVR.strength = 0.85; }
      if (k==="strong"){ UVR.strength = 0.95; }
      if (k==="gentle"){ UVR.strength = 0.70; }
      if (k==="vocal"){ UVR.strength = 0.35; }
      if (strength){ strength.value = String(UVR.strength); }
      if (strengthVal){ strengthVal.textContent = UVR.strength.toFixed(2); }
      setMsg(k==="vocal" ? "预设：人声提取（伴奏削弱）" : "预设已应用");
    };
    const bStd = document.getElementById("btnUvrPresetStd");
    const bStrong = document.getElementById("btnUvrPresetStrong");
    const bGentle = document.getElementById("btnUvrPresetGentle");
    const bVocal = document.getElementById("btnUvrPresetVocal");
    bStd && bStd.addEventListener("click", ()=>preset("std"));
    bStrong && bStrong.addEventListener("click", ()=>preset("strong"));
    bGentle && bGentle.addEventListener("click", ()=>preset("gentle"));
    bVocal && bVocal.addEventListener("click", ()=>preset("vocal"));

    // strength slider
    strength && strength.addEventListener("input", ()=>{
      UVR.strength = clampNum(Number(strength.value||0.85), 0, 1);
      if (strengthVal) strengthVal.textContent = UVR.strength.toFixed(2);
    });

    // source select
    sel && sel.addEventListener("change", async ()=>{
      const id = sel.value;
      if (!id){
        UVR.source = { kind:"track", id:null, name:"", blob:null };
        setMsg("");
        return;
      }
      const type = (srcType && srcType.value === "p1") ? "p1" : "builtin";
      if (type === "p1"){
        const cue = (UVR.p1Cues||[]).find(c=>c.id===id);
        if (!cue){ toast("CUE 不存在"); return; }
        UVR.source = { kind:"p1cue", id:cue.id, name:cue.name||"未命名", blob:null };
        setMsg(`已选择：P1 · ${UVR.source.name}`);
        return;
      }
      const tr = trackById(id);
      if (!tr){ toast("曲目不存在"); return; }
      UVR.source = { kind:"track", id:tr.id, name:tr.name||"未命名", blob:tr.blob };
      setMsg(`已选择：${UVR.source.name}`);
    });

    // use now playing
    btnNow && btnNow.addEventListener("click", async ()=>{
      const mode = (document.body.dataset.musicMode === "p1") ? "p1" : "builtin";
      try{
        if (mode === "p1"){
          if (srcType) srcType.value = "p1";
          const b = await uvrGetP1Bridge();
          const cueId = (b && typeof b.getNowCueId==="function") ? b.getNowCueId() : null;
          if (!cueId){ toast("P1 当前没有正在播放的 CUE"); return; }
          await refreshSourceSelect(cueId);
          if (sel) sel.value = cueId;
          const cue = (UVR.p1Cues||[]).find(c=>c.id===cueId);
          UVR.source = { kind:"p1cue", id:cueId, name:(cue?.name||"未命名"), blob:null };
          setMsg(`已选择：正在播放（P1） · ${UVR.source.name}`);
          return;
        }

        // builtin
        if (srcType) srcType.value = "builtin";
        const q = MUSIC.queue?.[MUSIC.currentIndex];
        const tr = q ? trackById(q.trackId) : null;
        if (!tr){ toast("当前没有正在播放的曲目"); return; }
        await refreshSourceSelect(tr.id);
        if (sel) sel.value = tr.id;
        UVR.source = { kind:"track", id:tr.id, name:tr.name||"未命名", blob:tr.blob };
        setMsg(`已选择：正在播放 · ${UVR.source.name}`);
      }catch(e){
        toast("读取正在播放失败");
        console.warn(e);
      }
    });

    // pick local file
    btnPick && btnPick.addEventListener("click", ()=> fileIn && fileIn.click());
    fileIn && fileIn.addEventListener("change", async ()=>{
      const f = fileIn.files && fileIn.files[0];
      if (!f) return;
      UVR.source = { kind:"file", id:null, name:f.name, blob:f };
      if (sel) sel.value = "";
      setMsg(`已选择：本地文件 · ${f.name}`);
    });

    // volumes
    volVoc && volVoc.addEventListener("input", ()=>{ if (aVoc) aVoc.volume = clampNum(Number(volVoc.value||1),0,1); });
    volInst && volInst.addEventListener("input", ()=>{ if (aInst) aInst.volume = clampNum(Number(volInst.value||1),0,1); });

    // exports
    btnExpVoc && btnExpVoc.addEventListener("click", ()=>{
      if (!UVR.out.voc) return toast("还没有分离结果");
      downloadBlob(UVR.out.voc, `${UVR.out.baseName}_人声.wav`);
    });
    btnExpInst && btnExpInst.addEventListener("click", ()=>{
      if (!UVR.out.inst) return toast("还没有分离结果");
      downloadBlob(UVR.out.inst, `${UVR.out.baseName}_伴奏.wav`);
    });

    // library actions
    btnToLib && btnToLib.addEventListener("click", async ()=>{
      if (!UVR.out.voc || !UVR.out.inst) return toast("还没有分离结果");
      await uvrAutoToLibrary({toQueue:false, play:false});
    });
    btnToQueue && btnToQueue.addEventListener("click", async ()=>{
      if (!UVR.out.voc || !UVR.out.inst) return toast("还没有分离结果");
      await uvrAutoToLibrary({toQueue:true, play:false});
    });
    btnToPlay && btnToPlay.addEventListener("click", async ()=>{
      if (!UVR.out.voc || !UVR.out.inst) return toast("还没有分离结果");
      await uvrAutoToLibrary({toQueue:true, play:true});
    });


    // source type / filter
    srcType && srcType.addEventListener("change", async ()=>{
      if (sel) sel.value = "";
      UVR.source = { kind:"track", id:null, name:"", blob:null };
      preview && (preview.style.display = "none");
      setMsg("");
      await refreshSourceSelect();
    });
    srcFilter && srcFilter.addEventListener("input", ()=>{ refreshSourceSelect(sel?.value||""); });

    // open / close UVR page
    async function openUvrPage(){
      uvrSetMusicPage("uvr");
      const mode = (document.body.dataset.musicMode === "p1") ? "p1" : "builtin";
      if (srcType) srcType.value = mode;         // 跟随当前模式
      if (destSel) destSel.value = mode;         // 跟随当前模式
      if (srcFilter) srcFilter.value = "";
      if (sel) sel.value = "";                   // 不自动预选
      UVR.source = { kind:"track", id:null, name:"", blob:null };
      UVR.out = { voc:null, inst:null, baseName:"" };
      preview && (preview.style.display = "none");
      setProg(0); setMsg("请选择源曲目 / 本地文件");
      if (mode === "p1"){ try{ ensureP1ConsoleLoaded(); }catch(e){} }
      await refreshSourceSelect();
      try{ $("#msUvrPage")?.scrollIntoView({behavior:"smooth", block:"start"}); }catch(e){}
    }
    function closeUvrPage(){
      uvrSetMusicPage("");
      uvrScrollIntoView();
    }
    btnGo && btnGo.addEventListener("click", ()=>{ openUvrPage(); });
    btnBack && btnBack.addEventListener("click", ()=>{ closeUvrPage(); });

    // run / cancel
    btnRun && btnRun.addEventListener("click", async ()=>{
      if (UVR.busy) return;
      if (!UVR.source || (!UVR.source.blob && !UVR.source.id)){
        toast("请先选择源曲目 / 本地文件");
        return;
      }

      UVR.busy = true;
      UVR.abort = false;
      btnRun.disabled = true;
      if (btnCancel){ btnCancel.style.display = "inline-flex"; btnCancel.disabled = false; }
      preview && (preview.style.display = "none");
      setProg(0); setMsg("准备中…");

      try{
        UVR.out = await uvrSeparate(UVR.source, {
          engine: UVR.engine,
          strength: UVR.strength,
          onProgress: (p, t)=>{ setProg(p); if (t) setMsg(t); },
          isAborted: ()=>UVR.abort
        });

        // preview
        uvrApplyPreview(UVR.out);
        if (preview) preview.style.display = "block";
        toast("分离完成 ✅");
      }catch(e){
        console.error(e);
        toast(String(e?.message || "分离失败"));
      }finally{
        UVR.busy = false;
        btnRun.disabled = false;
        if (btnCancel){ btnCancel.style.display = "none"; }
        setProg(0);
        syncUvrStatus();
      }
    });

    btnCancel && btnCancel.addEventListener("click", ()=>{
      UVR.abort = true;
      btnCancel.disabled = true;
      setMsg("正在取消…");
    });

    function syncUvrStatus(){
      const hasNative = !!(window.__UVR_NATIVE__ && typeof window.__UVR_NATIVE__.separate === "function");
      const hasOrt = !!(window.ort || window.onnxruntime || window.__ORT__);
      if (!status) return;
      if (hasNative){
        status.textContent = "ONNX：已就绪（Native）";
      }else if (hasOrt){
        status.textContent = "ONNX：运行时已检测到（需模型文件）";
      }else{
        status.textContent = "ONNX：未检测到（将使用快速离线）";
      }
    }
    syncUvrStatus();
  }

  function uvrApplyPreview(out){
    const aVoc = document.getElementById("uvrAudioVoc");
    const aInst = document.getElementById("uvrAudioInst");
    // cleanup
    try{
      if (UVR.out.vocUrl) URL.revokeObjectURL(UVR.out.vocUrl);
      if (UVR.out.instUrl) URL.revokeObjectURL(UVR.out.instUrl);
    }catch(e){}

    UVR.out.vocUrl = out.voc ? URL.createObjectURL(out.voc) : "";
    UVR.out.instUrl = out.inst ? URL.createObjectURL(out.inst) : "";

    if (aVoc) aVoc.src = UVR.out.vocUrl || "";
    if (aInst) aInst.src = UVR.out.instUrl || "";
  }

  async function uvrAutoToLibrary({toQueue=false, play=false}){
    const base = UVR.out.baseName || "UVR_输出";
    const cat = "UVR 输出";
    const dest = (document.getElementById("uvrDestPlayer")?.value === "p1") ? "p1" : "builtin";

    if (!UVR.out || !UVR.out.voc || !UVR.out.inst){
      toast("没有可入库的分离结果"); 
      return;
    }

    // push an undo checkpoint
    try{ pushMusicUndo("UVR 输出入库"); }catch(e){}

    if (dest === "p1"){
      // --- Import to P1 ---
      try{
        const b = await uvrGetP1Bridge();

        const vocCueId = await b.importBlobAsCue(UVR.out.voc, {
          name: `${base}_人声`,
          fileName: `${base}_人声.wav`,
          catName: cat
        });
        const instCueId = await b.importBlobAsCue(UVR.out.inst, {
          name: `${base}_伴奏`,
          fileName: `${base}_伴奏.wav`,
          catName: cat
        });

        if (toQueue){
          await b.enqueueCue(instCueId);
          toast("已入库到 P1 并加入队列");
        }else{
          toast("已入库到 P1 ✅");
        }

        if (play){
          // auto jump back to musicSystem + switch to P1
          setMusicPlayerMode("p1", {silent:true});
          uvrSetMusicPage("");
          uvrScrollIntoView();
          await b.playCue(instCueId);
        }
      }catch(e){
        console.warn(e);
        toast("入库到 P1 失败：请先打开一次 P1 播控台");
      }
      return;
    }

    // --- Import to builtin library ---
    try{
      const cats = loadCats();
      if (!cats.includes(cat)){
        cats.push(cat);
        saveCats(cats);
      }
    }catch(e){}

    const vocId = await addBlobAsTrack({
      blob: UVR.out.voc,
      name: `${base}_人声.wav`,
      cat
    });
    const instId = await addBlobAsTrack({
      blob: UVR.out.inst,
      name: `${base}_伴奏.wav`,
      cat
    });

    renderCats(); renderLibrary();

    if (toQueue){
      // add inst to queue by default
      MUSIC.queue.push({ id:idNow("q"), trackId: instId, title:"", start:0, end:null });
      renderQueue(); persistActivePlaylistFromQueue();
      toast("已入库并加入队列");
      if (play){
        MUSIC.currentIndex = MUSIC.queue.length-1;
        // auto jump back to musicSystem + switch to builtin
        setMusicPlayerMode("builtin", {silent:true});
        uvrSetMusicPage("");
        uvrScrollIntoView();
        await playTrack(MUSIC.currentIndex, true);
      }
    }else{
      toast("已自动入库 ✅");
    }
  }

  async function addBlobAsTrack({blob, name, cat}){
    const id = idNow("trk");
    const dur = await getDurationFromBlob(blob);
    const item = {
      id,
      name: name || ("UVR_"+id+".wav"),
      blob,
      duration: dur || 0,
      cat: cat || "未分类",
      createdAt: Date.now()
    };
    MUSIC.tracks.push(item);
    try{ await dbPut("tracks", item); }catch(e){ console.error(e); }
    return id;
  }

  async function uvrSeparate(source, {engine="onnx", strength=0.85, onProgress=null, isAborted=null}={}){
    const baseName = uvrBaseName(source?.name || "");
    const report = (p, t)=>{ try{ onProgress && onProgress(p, t); }catch(_e){} };
    const aborted = ()=> (isAborted && isAborted()) ? true : false;

    report(0.02, "读取音频…");
    let blob = source?.blob || null;
    if (!blob && source && source.kind === "p1cue" && source.id){
      try{
        report(0.03, "从 P1 读取音频…");
        blob = await uvrGetP1CueBlob(source.id);
      }catch(e){
        console.warn(e);
        throw new Error("无法从 P1 读取音频（请确认该 CUE 已导入且可播放）");
      }
    }
    if (!blob) throw new Error("请先选择源曲目 / 本地文件");

    // ONNX first (if available), else fallback
    if (engine==="onnx"){
      try{
        const out = await uvrSeparateONNX(blob, {strength, onProgress, isAborted});
        out.baseName = baseName;
        return out;
      }catch(e){
        console.warn("ONNX not ready, fallback to quick:", e);
        report(0.08, "ONNX 未就绪：已切换到快速离线…");
      }
    }

    if (aborted()) throw new Error("已取消");

    const out2 = await uvrSeparateQuick(blob, {strength, onProgress, isAborted});
    out2.baseName = baseName;
    return out2;
  }

  async function uvrSeparateONNX(blob, {strength=0.85, onProgress=null, isAborted=null}={}){
    const report = (p, t)=>{ try{ onProgress && onProgress(p, t); }catch(_e){} };

    // 1) Desktop Native Bridge (Electron preload) — recommended
    if (window.__UVR_NATIVE__ && typeof window.__UVR_NATIVE__.separate === "function"){
      report(0.1, "ONNX（Native）推理中…");
      // expected result: {vocals:ArrayBuffer|Uint8Array|Blob, instrumental:ArrayBuffer|Uint8Array|Blob}
      const res = await window.__UVR_NATIVE__.separate(blob, {strength});
      if (!res) throw new Error("ONNX 引擎返回空结果");
      const voc = (res.vocals instanceof Blob) ? res.vocals : new Blob([res.vocals], {type:"audio/wav"});
      const inst = (res.instrumental instanceof Blob) ? res.instrumental : new Blob([res.instrumental], {type:"audio/wav"});
      report(0.98, "完成");
      return { voc, inst, baseName:"" };
    }

    // 2) Web ONNX runtime path (needs local onnxruntime-web + model)
    // To keep this file fully offline + easy packaging, we do NOT auto-download anything here.
    // If you drop onnxruntime-web and a model into local assets, you can implement the runner below.
    throw new Error("ONNX 引擎未就绪：请在桌面端启用 Native UVR，或放置本地 onnxruntime-web + 模型文件。");
  }

  async function uvrSeparateQuick(blob, {strength=0.85, onProgress=null, isAborted=null}={}){
    const report = (p, t)=>{ try{ onProgress && onProgress(p, t); }catch(_e){} };
    const aborted = ()=> (isAborted && isAborted()) ? true : false;

    report(0.12, "解码音频…");
    const arr = await blob.arrayBuffer();

    // Use a dedicated AudioContext for decode
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) throw new Error("当前环境不支持 AudioContext（无法分离）");
    const ctx = new AC();
    let audioBuf;
    try{
      audioBuf = await ctx.decodeAudioData(arr.slice(0));
    }catch(e){
      console.error(e);
      throw new Error("音频解码失败（格式不支持或文件损坏）");
    }finally{
      try{ ctx.close(); }catch(_e){}
    }

    if (aborted()) throw new Error("已取消");
    report(0.28, "快速离线分离（近似）…");

    const sr = audioBuf.sampleRate || 44100;
    const len = audioBuf.length || 0;
    const ch = Math.max(1, audioBuf.numberOfChannels||1);

    const L = audioBuf.getChannelData(0);
    const R = (ch>1) ? audioBuf.getChannelData(1) : null;

    // Prepare outputs
    const outVocL = new Float32Array(len);
    const outVocR = new Float32Array(len);
    const outInstL = new Float32Array(len);
    const outInstR = new Float32Array(len);

    const k = clampNum(Number(strength||0.85), 0, 1);
    const step = Math.max(8192, Math.floor(len/120)); // progress granularity

    for (let i=0;i<len;i++){
      if (aborted()) throw new Error("已取消");
      const l = L[i];
      const r = R ? R[i] : L[i];
      const mid = (l + r) * 0.5; // center
      // vocals ≈ center
      outVocL[i] = mid;
      outVocR[i] = mid;
      // instrumental ≈ remove center
      outInstL[i] = l - mid * k;
      outInstR[i] = r - mid * k;

      if (i % step === 0){
        report(0.28 + 0.52*(i/len), "处理中…");
        // allow UI breathing
        await new Promise(r=>setTimeout(r,0));
      }
    }

    report(0.82, "归一化…");
    normalizeStereo(outVocL, outVocR);
    normalizeStereo(outInstL, outInstR);

    if (aborted()) throw new Error("已取消");
    report(0.90, "编码 WAV…");
    const voc = encodeWAVFromChannels([outVocL, outVocR], sr);
    const inst = encodeWAVFromChannels([outInstL, outInstR], sr);

    report(0.99, "完成");
    return { voc, inst, baseName:"" };
  }

  function uvrBaseName(name){
    const n = String(name||"").trim();
    if (!n) return "UVR_输出";
    return n.replace(/\.[a-z0-9]+$/i, "").slice(0, 80) || "UVR_输出";
  }

  function normalizeStereo(L, R){
    let mx = 0;
    for (let i=0;i<L.length;i++){
      const a = Math.abs(L[i]); if (a>mx) mx=a;
      const b = Math.abs(R[i]); if (b>mx) mx=b;
    }
    if (mx>1){
      const s = 0.99/mx;
      for (let i=0;i<L.length;i++){ L[i]*=s; R[i]*=s; }
    }
  }

  function encodeWAVFromChannels(channels, sampleRate){
    const numCh = channels.length;
    const length = channels[0].length;
    const bytesPerSample = 2;
    const blockAlign = numCh * bytesPerSample;
    const byteRate = sampleRate * blockAlign;
    const dataSize = length * blockAlign;

    const buffer = new ArrayBuffer(44 + dataSize);
    const view = new DataView(buffer);

    // RIFF header
    writeString(view, 0, "RIFF");
    view.setUint32(4, 36 + dataSize, true);
    writeString(view, 8, "WAVE");
    writeString(view, 12, "fmt ");
    view.setUint32(16, 16, true);        // PCM
    view.setUint16(20, 1, true);         // PCM
    view.setUint16(22, numCh, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, byteRate, true);
    view.setUint16(32, blockAlign, true);
    view.setUint16(34, 16, true);        // 16-bit
    writeString(view, 36, "data");
    view.setUint32(40, dataSize, true);

    let offset = 44;
    for (let i=0;i<length;i++){
      for (let ch=0; ch<numCh; ch++){
        let s = channels[ch][i];
        s = Math.max(-1, Math.min(1, s));
        view.setInt16(offset, s<0 ? s*0x8000 : s*0x7FFF, true);
        offset += 2;
      }
    }
    return new Blob([view], {type:"audio/wav"});
  }

  function downloadBlob(blob, filename){
    try{
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename || "download.bin";
      a.click();
      setTimeout(()=>{ try{ URL.revokeObjectURL(a.href); }catch(e){} }, 1200);
    }catch(e){
      console.error(e);
      toast("导出失败");
    }
  }


  // -------------------------
  // Host Social Workbench (嵌入：主持人自媒体入门与进阶工作台 v6.3)
  // 说明：使用 iframe + srcdoc + sandbox 隔离运行，避免样式/存储互相影响
  // -------------------------
  let __hostSocialInited = false;

  function __getHostSocialHTML(){
    const tpl = document.getElementById("hostSocialTpl");
    return (tpl ? tpl.innerHTML : "").trim();
  }

  function __fitHostSocialFrame(){
    const view = document.getElementById("viewSocial");
    const frame = document.getElementById("hostSocialFrame");
    if (!view || !frame) return;
    if (!view.classList.contains("active")) return;
    const rect = frame.getBoundingClientRect();
    const pad = 14;
    const h = Math.max(520, window.innerHeight - rect.top - pad);
    frame.style.height = h + "px";
  }

  function initHostSocial(opts={}){
    const frame = document.getElementById("hostSocialFrame");
    if (!frame) return;
    const html = __getHostSocialHTML();
    if (!html){ console.warn("hostSocial html empty"); return; }

    if (!__hostSocialInited || opts.force){
      frame.srcdoc = html;
      __hostSocialInited = true;
    }

    // 让工作台配色/圆角跟随主程序（不新开窗口）
    try{
      frame.addEventListener("load", ()=>{ try{ syncHostSocialTheme(); }catch(e){} }, {once:true});
      setTimeout(()=>{ try{ syncHostSocialTheme(); }catch(e){} }, 80);
    }catch(e){}

    const btnReload = document.getElementById("btnReloadHostSocial");
    if (btnReload && !btnReload.__bound){
      btnReload.__bound = true;
      btnReload.addEventListener("click", ()=> initHostSocial({force:true}));
    }

    __fitHostSocialFrame();
    if (!window.__hostSocialResizeBound){
      window.__hostSocialResizeBound = true;
      window.addEventListener("resize", __fitHostSocialFrame, {passive:true});
    }
  }

  function syncHostSocialTheme(){
    const frame = document.getElementById("hostSocialFrame");
    if (!frame) return;
    let doc = null;
    try{ doc = frame.contentDocument; }catch(e){ doc = null; }
    if (!doc) return;

    const host = document.documentElement;
    const cs = getComputedStyle(host);
    const get = (v, fb="") => (cs.getPropertyValue(v) || fb).trim();

    const map = {
      "--bg": get("--bg", "#f6f4ff"),
      "--panel": get("--card", "#ffffff"),
      "--panel2": get("--card", "#ffffff"),
      "--text": get("--text", "#1b1d2a"),
      "--muted": get("--muted", "#667085"),
      "--line": get("--line", "rgba(30,30,60,.12)"),
      "--accent": get("--accent", "#6b5cff"),
      "--good": get("--good", "#51d19a"),
      "--warn": get("--warn", "#ffcc66"),
      "--bad": get("--bad", "#ff6b6b"),
      "--shadow": get("--shadow", "0 18px 50px rgba(0,0,0,.14)"),
      "--radius": get("--radius", "18px"),
    };

    try{
      const root = doc.documentElement;
      Object.entries(map).forEach(([k,v])=>{ if(v) root.style.setProperty(k, v); });

      // 主程序奶油白 -> 工作台 light；霓虹暗夜 -> 工作台 dark
      const t = host.getAttribute("data-theme") || "cream";
      if (t === "cream") root.setAttribute("data-theme", "light");
      else root.removeAttribute("data-theme");

      // 去掉工作台自己的渐变底，避免“像新开一套皮肤”
      const stId = "__hostSocialThemeBridge";
      if (!doc.getElementById(stId)){
        const st = doc.createElement("style");
        st.id = stId;
        st.textContent = `
          body{ background: transparent !important; }
          header{ background: transparent !important; border-bottom: 1px solid var(--line) !important; }
          .wrap{ max-width: 1200px; margin: 0 auto; padding: 14px 14px 18px; }
          .card, .panel, .box{ border-radius: var(--radius) !important; box-shadow: var(--shadow) !important; }
          .btn, button{ border-radius: 14px !important; }
        `;
        (doc.head || doc.documentElement).appendChild(st);
      }
    }catch(e){}
  }



  // -------------------------
  // Host handbook (学习手册 教学版 v1.9) - iframe + srcdoc
  // -------------------------
  let __hostHandbookInited = false;

  function __getHostHandbookHTML(){
    const tpl = document.getElementById("hostHandbookTpl");
    return (tpl ? tpl.innerHTML : "").trim();
  }

  function __fitHostHandbookFrame(){
    const view = document.getElementById("viewHandbook");
    const frame = document.getElementById("hostHandbookFrame");
    if (!view || !frame) return;
    if (!view.classList.contains("active")) return;
    const rect = frame.getBoundingClientRect();
    const pad = 14;
    const h = Math.max(520, window.innerHeight - rect.top - pad);
    frame.style.height = h + "px";
  }

  function initHostHandbook(opts={}){
    const frame = document.getElementById("hostHandbookFrame");
    if (!frame) return;
    const html = __getHostHandbookHTML();
    if (!html){ console.warn("hostHandbook html empty"); return; }

    if (!__hostHandbookInited || opts.force){
      frame.srcdoc = html;
      __hostHandbookInited = true;
    try{ frame.addEventListener("load", ()=>{ try{ frame.contentWindow && frame.contentWindow.postMessage({type:"__theme_sync__"}, "*"); }catch(e){} }, {once:true}); }catch(e){}
}

    const btnReload = document.getElementById("btnReloadHostHandbook");
    if (btnReload && !btnReload.__bound){
      btnReload.__bound = true;
      btnReload.addEventListener("click", ()=> initHostHandbook({force:true}));
    }

    __fitHostHandbookFrame();
    if (!window.__hostHandbookResizeBound){
      window.__hostHandbookResizeBound = true;
      window.addEventListener("resize", __fitHostHandbookFrame, {passive:true});
    }
  }


// ---- 4) Override setTab to include music + bind title lib ----
  
  function setTab(which){
    const tSchedule = $("#tabSchedule");
    const tHandbook = $("#tabHandbook");
    const tLines = $("#tabLines");
    const tSocial = $("#tabSocial");
    const tMusic = $("#tabMusic");

    const vSchedule = $("#viewSchedule");
    const vHandbook = $("#viewHandbook");
    const vLines = $("#viewLines");
    const vSocial = $("#viewSocial");
    const vMusic = $("#viewMusic");

    const tabs = [
      ["schedule", tSchedule, vSchedule],
      ["handbook", tHandbook, vHandbook],
      ["lines", tLines, vLines],
      ["social", tSocial, vSocial],
      ["music", tMusic, vMusic],
    ];

    tabs.forEach(([key, tab, view])=>{
      tab && tab.classList.remove("active");
      tab && tab.setAttribute("aria-selected","false");
      view && view.classList.remove("active");
    });

    const hit = tabs.find(x=>x[0]===which) || tabs[0];
    const [key, tab, view] = hit;
    tab && tab.classList.add("active");
    tab && tab.setAttribute("aria-selected","true");
    view && view.classList.add("active");
    document.body.classList.toggle("musicWideHeader", key==="music");

    if (key==="schedule"){
      initSchedule();
      renderCalendar(); renderList(); renderMonthStats();
    } else if (key==="social"){
      try{ initHostSocial(); }catch(e){ console.error(e); toast("自媒体工作台初始化失败"); }
    } else if (key==="music"){
      initMusic();
    } else if (key==="lines"){
      initLines();
    } else {
      try{ initHostHandbook(); }catch(e){ console.error(e); toast("学习手册初始化失败"); }
      applyChecks(); updateProgress();
    }
  }

  $("#tabSchedule")?.addEventListener("click", ()=>setTab("schedule"));
  $("#tabHandbook")?.addEventListener("click", ()=>setTab("handbook"));
  $("#tabLines")?.addEventListener("click", ()=>setTab("lines"));
  $("#tabSocial")?.addEventListener("click", ()=>setTab("social"));
  $("#tabMusic")?.addEventListener("click", ()=>setTab("music"));
// -------------------------
  // Lines module (主持台词库) v2.0
  // -------------------------
  const LINES_BASE = [{"id": "l_a935df46ef", "cat": "节日节气", "title": "01 元旦/新年通用婚礼开场台词", "body": "(公历 1 ⽉ 1 ⽇)\n尊敬的各位嘉宾，女士们先生们大家新年好。今天是 1 ⽉ 1 号，从时光来讲， 这一刻没有什么特别，无非就像是过去的几十亿年中普通的一个白天和黑夜。从  生活来讲 ，却代表着我 们将要告别一段承载着记忆的过去 ，迎来一个新的开  始。 也打开了一个全新的一年。\n从小明和小兰的眼中来看，这一天当然也很特别，因为新年的第一天，要走  进了他们新的生活，会有一个新的身份，开始一段新的关系，建立一个新的家庭， 以及对明天的份新的期待和憧憬。1 ⽉ 1 号，一切的一切都是崭新的。和这个熟  悉的爱人 ，历经了风雨洗礼的感情，也依旧历久弥新。\n人们常把新年的第一天叫做跨年， 所以这场婚礼其中的一个很重要的意义， 也代表着他们从今天起，将要跨过了青春和稚嫩，要跨进了成熟的行列。要带着  在昨日缤纷烟火中许下的愿望，和深爱的彼此跨进未来余生的岁岁年年。各位亲  爱的家人，让我们共同来祝福小明和小兰新年第一天开始的婚姻和爱，风月常新， 愿他们新婚快乐!", "tags": ["元旦", "台词", "开场", "新年通用婚礼开场台词", "祝福", "节日节气"]}, {"id": "l_9d52a676c4", "cat": "节日节气", "title": "02 小寒节气通用婚礼开场词", "body": "(公历 1 ⽉ 5-7 ⽇)\n尊敬的各位嘉宾，大家冬天好。虽然外面的世界寒风刺骨，却依旧不会阻挡 我们在这个凛冽的季节，温暖的奔赴。今天恰逢农历 24个节气中的小寒，也开 启了一年中最冷的模式。冬味渐浓，腊梅初香，新年和岁末交汇于此，这桩婚事 也让诸位家人和嘉宾欢聚一堂。\n隆冬时节，虽不见百花，但是小明依旧很幸福，因为在他心里最美的那一朵  花，正在为他骄傲的绽放着。初见小兰，就像一粒种子被埋进了土里 ， 日益增多  的好感，让这粒种子扎根生长，发出新芽。而爱情的浸润也让它变得越发的茁壮， 含苞待放。他们认真的呵护与小心的照料， 曾经那一粒无意中埋下的小种子，此  刻终于开出了花。\n回顾这朵花的生长，小兰的温柔是水分，小明的包容是温度，他们的爱就是 一朵花开不可或缺的阳光。虽然当下已是小寒时节，但是有爱的人不会冷，被爱 的人不怕冷。小寒再寒，也终会融化于他们彼此相爱的热烈。谢谢各位风雪中的 赴约， 请大家响起一点轻轻的掌声，算是我们给他们的祝福，给他们的温暖， 给他们这个冬日 ，幸福的陪伴。\n小寒是中国农历 24个节气中的第 23 个，由此可见 ，寒冬腊月 ，已经进入了一年中最冷的一段时间。而\n\n在农历节气的释义中说道，小寒是冷气积久而寒，但却未寒冷到极点。小寒结束大寒来，一年节气轮流转。 由于中国地大物博，南北纬度跨越较大 ，所以节气与温度常常因不同地区而有不同的差别所以使用时要根  据所在城市的纬度，温度，来斟酌选择。\n每年的小寒时节都是公历 1 ⽉ 5-7 日 ，如果婚礼那天刚好是节气当日 ，这段词可以无需修改而直接使用。 如果节气和婚礼日期不同，则可简单修改。如第一自然段:今天恰逢农历 24个节气中的小寒。其中今天恰逢， 可以换做昨天，前天，或明天，后天就到了 24 个节气中的小寒等等。\n\n腊八节，是每年的农历十二月初儿，又称为“法宝节”、“佛成道节”。是典型的北方节日 。在古代，腊八 节本为佛教纪念释迦牟尼佛成道的节日 ，后来逐渐成为民间节日 。腊八粥的习俗来源于佛教，又因为腊月 初八是释迦牟尼成佛之日 ，所以寺院在腊八这天，会做粥赠送给门徒和来拜香的人们，所以腊八粥也叫佛 粥。此外还有泡腊八蒜和腊八醋的习俗。腊八这个节日 ，就是春节将至的前兆，过了今天，就开始有年味 了。\n在这段词当中并未特别突出宗教元素，毕竟腊八节做为中国绝大部分地区的传统节日 ，巳经脱离了宗  教的传说桎梏。而是用熬粥的方法和材料，引申和联想爱情的意义，和陪伴的美好。温粥听雪盼过年，将  冬的寒冷，熬成生活的清甜。腊八节，不仅飘散着粥的味道，还有无数的身在异乡的游子 ，对家乡的想念。 而在婚礼台词当中，特别的突出了将恋爱的浪漫和甜，熬成婚姻中的柴米油盐。人间百味，只有最爱的人， 才懂得自己的口味。", "tags": ["台词", "开场", "祝福", "节日节气"]}, {"id": "l_6d4751d7a9", "cat": "节日节气", "title": "03 腊八节通用婚礼开场词", "body": "(农历腊月初八)\n今天是农历的腊月初八 ，腊八粥的香气弥散了寒冬，温暧了四季的尾声，这 第一缕年味，也拉开了阖家团圆的序幕。为 什么腊八节一定要喝粥呢?有一个答 案让我特别喜欢，他说，腊八粥中蕴含着日子的香甜，也温暖了年轮的碎片，所 以小明和小兰，要在这样的飘散着浓浓烟火气的日子里，让他们所有的甜，在今 天圆满。\n其实回顾他们这段恋爱的过程，也如同是在熬一碗粥，不同个性的两个人 ， 带着不同的习惯，不同的个性，不同的认知和三观。就好像是锅里面不同味道的  米，各种颜色的豆，用水的浸润，用冰糖的甘甜，用小火的温度慢慢的煮成一碗  清 香可口的腊八粥。这不仅让小明和小兰他们明白融合与接纳才是好味的根本， 也让他们懂得，生活里面所有的幸福和美好，都要用小火不疾不徐，慢慢的熬。\n有人说，人们最爱的味道，都是由最爱的人制造，他们二位从今天起要将恋 爱的浪漫和甜，熬成婚姻中的柴米油盐，在人间百味中，去品尝他们为对方煮的 最合自己口味的那一碗热粥。祝各位来宾，岁末欣喜，腊八快乐。祝福他们，年\n\n年如意，新婚快乐。", "tags": ["开场", "来宾", "祝福", "腊八节通用婚礼开场词", "节日节气"]}, {"id": "l_f3a681aa25", "cat": "节日节气", "title": "04 中国人民警察节婚礼开场词", "body": "(公历 1 ⽉ 10 ⽇)\n各位来宾 ，大家好 ，欢迎参加小明和小兰的婚礼 。今天是  1 ⽉ 10 号 ， 110 这组数字好像对于每一个中国人来说，都有着极强的安全感。遇到困难，我们会 想到 110，遭遇侵害，也一定会拨打 110，甚至生活里面一些鸡零狗碎的小事，110 都是我们最强大的依托和靠山。正是这群默默无闻的英雄们，使得我们能够在这 个安定繁荣的国度里安心笃定的安居乐业，今天是中国人民警察节，所以不仅要 祝福新郎小明新婚快乐，还要祝福身为警察的他，节日快乐。谢谢各位的掌声， 谢谢。\n恋爱之初，小兰深信这个作为警察的爱人，一定会带给她数之不尽的安全感， 可是(两年)的恋爱似乎跟她当初想象的不太一样 ， 不仅是因为这个男朋友把安  全感都给了别人，没有说走就走的旅行，没有节假日里的陪伴，甚至连自己遇到  解决不了的问题，他都因为工作无法陪在自己的身边。从开始有抱怨和牢强，慢  慢的接受和理解，再到后来的心疼和帮他分担，小兰知道爱人选择这项事业，他  必须要守护他的使命，也知道自己选择了这个爱人 ，就要去接受他的一切。\n每一个光荣的警察背后都是一整个家庭的付出，他也许认为自己不是称职一 个好儿子，不是一个称职的好丈夫，不是一个称职好爸爸，但是每个人都相信他 会做一个称职的好警察。全家人都理解和支持他，就像小兰，两年的恋爱过程不 止是让他们彼此更加的了解，也让她做好了成为一名警嫂的准备。 你肩上的荣 耀我们一起分享， 日子里的琐碎，我自己面对。这才是爱，所以各位，给他们一 份热烈的掌声吧，祝福他们幸福美满，也祝每个警察和警嫂，平安快乐。掌声响 起，有请新郎。\n“中国人民警察节”是在国家层面专门为人民警察队伍设立的节日 ，是对人民警察队伍为党和人民利益  英勇奋斗的充分肯定。自 2021 年起，将每年 1 ⽉ 10 日设立为“中国人民警察节” 。这是一个新兴的节日 ，新  到才设立一两年的时间。而 1 ⽉ 10 号也代表着报警电话 110 的寓意。这里面不仅做为一个节日 ，还用了很  多关于警察的元素在词里 。在实际应用中也可以根据实际使用习惯，将警察这份职业属性和性质的描写， 通用于警察的婚礼。如第二和第三自然段，并没有太多关于节日的表述，可应用于新人是警察的任何场景。\n如果这一天结婚的新人 ，并非警察的职业，这篇台词并不适用。\n\n大寒是中国二十四节气中的最后一个，过了大寒又立春，即迎来新一年的节气的开始。一年终章，至 此轮回。大寒时，已经进入腊月 。年一天天的近了。“大寒迎年” ，人们开始准备春节的到来。\n\n每一年的大寒都是在公历的 1 ⽉ 20-21 日 ，如婚礼恰逢这个日子，则本篇台词可以直接套用。若婚礼日   期和节气的时间有偏差，可以稍微修改。如第一自然段，今天是大寒，可以改为昨天，前天，或明天等等。 灵活使用可让这篇台词应用于大寒节气附近的很多日子 。也可以增加一些对寒冷时节天气的描写，以增进  与宾客的共鸣如可在这段词最前面加上这几句所有相聚的温暖都能让人忘却室外严寒，天地纵然萧瑟，春  风即将到来。各位好，欢迎参加小明和小兰的婚礼。", "tags": ["台词", "开场", "新郎", "来宾", "祝福", "节日节气"]}, {"id": "l_badb3a850d", "cat": "节日节气", "title": "05 大寒节气通用婚礼开场词", "body": "(公历 1 ⽉ 20-21 ⽇)\n相信大家出了家门来的路上已经到了感受这个冬天带给我们的颜色。这颜色  不仅是天空的蓝，积雪的白 ，还有凛冽的风吹透身体的那种，冷到无处躲藏的无  奈。今天是大寒，24 个节气终于又走完了一圈。有老人讲，寒极必暖，否极泰来， 熬过这一段，冬天就算过去了。就像小明和小兰选择在今天结婚，不知道是不是  也预示着他们，从这里开始的旅程，也会一天比一天更加明媚，迈向通往春天的  脚步，也会越走越温暧。\n古话说，过了大寒，又是一年，过了这一年，小明和小兰已经在一起走过 X 年的时间。那么多寒来暑往的经历，看起来就像一段四季的缩影，春天充满着生 机勃勃，夏天热烈的满载欢喜，秋天他们理性又成熟，冬天不仅象征着包容和收 敛，还有他们婚姻生活的开始，他们爱情转折的纪念。\n大寒时节，滴水成冰，就让今天他们许下的这句诺言瞬间冻结为永恒，将它  收好，细心照料。然后在和所有的家人和亲友们在这里温一壶岁月的酒，敬幸福， 敬圆满，敬给如约而至的新年，敬给即将到来的春天!掌声祝他们幸福快乐，祝  新婚美满!", "tags": ["开场", "节日节气"]}, {"id": "l_84d64f515c", "cat": "节日节气", "title": "06 小年通用婚礼开场词", "body": "(农历腊月二十三-二十四)\n尊敬的各位来宾，今天是农历的腊月二十三(二十四)，首先祝大家小年快乐。 人间小年夜，阖家大团圆，扫屋祭灶，剪纸备料，从今天起，将要正式的开启了  过年的节奏。所以能在百忙之中莅临婚礼现场的朋友，真的要感谢大家这份真挚  和陪伴，让今天的仪式不仅幸福甜甜，而且年味满满。\n小的时候我们无比的盼望着过年，穿衣新，放鞭炮，大团圆、收红包。虽然 小明和小兰可能已经好久没有体会这样浓浓的年味，可是今天对他们来说，就像 过年一样， 同样穿着崭新的白纱西装，踩着噼里啪啦的鞭炮的节奏，邀请所有 他们喜欢的家人和朋友欢聚一堂， 在一只只红包里面感受着这份浓烈又真诚的 祝福。只是这样的年，一生只能过一次，曾经他们盼望这一天，今天他们享受这\n\n一切，未来他们会用生的时间来回味这一场喜乐的小圆满。\n小年虽然小，但是幸福很大，在国家团圆的春节到来前，让我们首先祝福他 们新婚美满，快乐平安，各位，掌声可以热烈一点。谢谢大家。\n幅员辽阔的中国，各地风俗有很大的差异。被称为“小年”的日子也都不一样。中国南方大多数地区以 腊月二十四为“小年”，中国北方大多数地区以腊月二十三为“小年”。但不管是南方还是北方，小年通常都被 视为忙年的开始，意味着人们开始准备年货 、扫尘 、祭灶等，准备干干净净过个好年，表达了人们一种辞 旧迎新、迎祥纳福的美好愿望，是中国百姓对“衣食有余”梦想追求的反映。\n这段词用了很多的篇幅描写了小年和过年的场景，所以不太适用于小年以外的日子 。如果婚礼刚好赶 在农历的腊月二十三或二十四，都可以用这段完整的开场词做为小年的内容。\n\n这段词没有指定的具体日期，写它的的初衷是因为每年春节前后是一个婚礼的高峰。出门在外工作的 年轻人都愿意选择在春节前后举办婚礼。也许因为平时工作 太紧张，不好请假。而且很多的家人朋友都会 从外地赶回。所以这一整段台词可 以用在小年后到春节之间的一段时间，是一段通用的年前婚礼的文案。", "tags": ["仪式", "台词", "小年通用婚礼开场词", "开场", "来宾", "祝福", "节日节气"]}, {"id": "l_3f74caadba", "cat": "节日节气", "title": "07 春节前通用婚礼开场词", "body": "(农历腊月二十四-除夕)\n尊敬的各位嘉宾，女士们先生大家中午好，欢迎参加小明和小兰的婚礼，春 节的脚步已渐行渐近，虽然人们总是抱怨着 年味越来越淡，但还是一年一年的 盼着这个阖家团圆的节日 ，属于中国人心里最隆重的年。它就像是我们生活的里 程碑，用来计量岁月的单位，这一年我们都得到了多少，失去了什么，这一年我 们的愿望实现了多少，还有一个怎样的梦想要在下一年去出发和拼搏。这一年的 年终岁尾，小明和小兰收获了婚姻，拥有了他们自己的家庭，那些等待和盼望， 付出和努力 ，这一刻全都尘埃落定。\n之所以要选在春节前来举办婚礼，他们说，那些出门在外的亲人朋友，都要  回来过年，他们想自己的婚礼不仅能收到大家的祝福，还希望在如此重要的日子， 让每一个爱他们的，和他们爱的人都能陪在身边，不让心里留下太多的遗憾。虽  然临近春节，天气寒冷，但有你们，他们由内而外的感受到了温暖。此刻他们拥  有的幸福，是终成眷属的爱情，是爸妈祝福的婚姻，是家人陪伴的婚礼，是跟一  一个称心如意的良人 ， 去共赴余生的岁岁年年。各位嘉宾，婚礼开始了，掌声  可以响起了。谢谢。", "tags": ["开场", "春节前通用婚礼开场词", "祝福", "节日节气"]}, {"id": "l_ad2e994464", "cat": "节日节气", "title": "08 春节期间通用婚礼开场词", "body": "(农历正月初一-正月初七)\n尊敬的各位来宾，女士们先生们大家过年好，今天是农历的正月初(X) ，春 节的第(X)天。家家户户贴满的红红的春联福字，为这个料峭的春寒天送来了一 抹热情。夜空缤纷闪耀的灿烂烟花，又开启了新一年的春秋和冬夏。如约而至的 春节，我们收到了太多的祝福，就像今天在这里 ，我们也要给您 句新春快乐的 问候。 不过您的到来，也为他们准备的最好的-份新婚快乐的礼物。\n春节的意义是辞旧迎新，而婚礼的意义则象征着他们将要告别一个旧的身份， 会拥有一个新的更加亲密的关系。 成长就是这样，我们总是一边得到，边失去， 一边对过往念念不忘，一边憧憬来日可期。虽然一切都会变旧，但爱永不老去。  所以内心装满爱的他们不会畏惧岁月的侵蚀和时光的氧化，在那些平淡如水的日    复一日中，始终记得这份白头偕老的初心。\n春节是我们用一年的时间盼望的一场人间小团圆，而婚姻，是他们用生的时 光，等待的一场生命的小圆满。刚好赶在春节期间的婚礼，就祝福每一个人，喜 乐团圆，幸福圆满吧!\n这段词适用于春节刚过的婚礼，从初一到初六左右，浓浓的年味还没有散去， 回家过年的亲朋友好友还没有返程回去。没有指定具体的日子，根据新人婚期来  填上日期即可。每年的春节都是婚礼的高峰期，在此期间结婚的新人大多都是因  为工作等等的原因，刚好趁着回家过春节的间隙来结婚。可用此段台词套用。\n\n立春，为二十四节气之首 ，又名正月节 、岁节 、改岁 、岁旦等。立是“开端”的意思:春代表着温暖 、生 长 。立春作为二十四节气之一 ，与立夏 、立秋 、立冬一样，反应着一年四季的更替。立春标示着万物闭藏 的冬季已过去，开始进入风和日暖、 万物生长的春季。立春正是阳气初生之时，万物至此，渐次复苏。故 《立春》诗云:  “东风带雨逐西风 ，大地阳和暖气生。”春天如期而至 ，一起静待花开。每一次幸福的新生， 都值得被深情以待。\n在我国北方的大部分地区，立春并不是真正意义上的春天来了，而只是春天的前奏已经响起。公历的 2 月初，北方仍处于隆冬时节，只有华南部分地区已经可以感受到春天的气息。所以台词里面加入了这样一 句，北方的大地仍被冰雪掩 埋而没有苏醒，使得这一段词可以应用于无论南方北方的各个地区。每年立春 的日期在公历 2 ⽉ 3.4.5 日 ，无论新人婚礼日期是不是立春当天，也可以按照之前的方法，稍微修改时间名 词，更改“今天”为明天，后天，或者还有2 天等等，使本段台词增加更多可应用范围。", "tags": ["台词", "开场", "来宾", "祝福", "节日节气"]}, {"id": "l_f34cc5fddf", "cat": "节日节气", "title": "09 立春节气通用婚礼开场词", "body": "(公历 2 ⽉ 3/4/5 ⽇)\n尊敬的各位来宾，女士们先生们大家上午好，尽管花草树木依然沉睡在冬眠 中而没有苏醒，但是季节却已经悄然开启新的一个轮回。今天是 24个节气中的 第一个，立春。北风吹来仍然带着三分寒意，但是春的这个字眼却已经让我们似 乎触摸到生命的力量在悄悄的孕育。把一份希望种在心底，万物开始复苏在脚下 的这片土地。\n有人说一年之计在于春，许多的人要开始了这一年的打算。而小明小兰也要  在此刻开始他们一生的计划了。一个崭新的小家庭成立于四季之首的立春光景， 就像土里的种子，扎根孕育，新芽初放，沐浴着阳光的温暖，经受着风雨的洗礼。 相信几十年后这棵种子会长成一棵枝繁叶茂的参天大树，那一道道年轮就是他们  共同经历的每一个春夏秋冬，那一片片叶子，就是他们相濡以沫的每一个日升月  落，那一条条枝芽就是他们共同承载的爱和希望。而我们的祝福就是春天里的第  一缕阳光，第一滴雨露。愿他们这个婚姻和家庭的小种子，欣欣向荣，茁壮生长， 各位，请为他们鼓鼓吧!", "tags": ["开场", "来宾", "祝福", "节日节气"]}, {"id": "l_1d477fef3f", "cat": "节日节气", "title": "10 元宵节通用婚礼开场词", "body": "(农历正月十四/十五/十六)\n尊敬的各位来宾，女士们先生们大家中午好，今天是正月十五元宵节，浓浓 的年味正在慢慢的消散，生活正渐渐恢复如常，可是元宵佳节的到来还是在提醒 着我们，不是只有过年才会有仪式感。就比如这一天，舞龙舞狮，祈福送灯，踩 高跷，猜灯谜，煮元宵，吃汤圆，热热闹闹的迎来了春节后第一个带有团圆色彩 的节日 。小明和小兰会比任何人都期待这天，因为他们今天的婚礼，意味着两个 人终于完成了恋爱的使命，拥有了自己的小家庭。\n尽管有人说, 出了十五，年就过完，可是身边有个美好的人，每天都像在过年。 恋爱的(X)年中他们深刻的感受到一个合格的恋人在身边，究竟是种怎样甜蜜的  体验。 就像我们元宵节吃的汤圆， 白白的汤圆皮就像小明对小兰的一份纯净无  暇的爱，紧紧的包裹着，保护着，但却柔软又温暖。汤圆里面的馅儿就像是小兰  的心情，不同的味道代表恋爱中不同的状态，或惊喜或感动，或幸福或美满，可  是每一种味道，都有着不一样的香甜。\n春节的烟火闪耀着他们来时的路，元宵的花灯却照亮他们未来的旅程，今晚， 全城都将会为他们燃起灯光，祝他们的明天，欢乐祥和，祝他们的未来，锦绣前  程。祝大家元宵节快乐，祝福他们新婚快乐。掌声有请新郎登场。\n\n每年的阴历正月十五是中国人很重视的传统节日 ，元宵节元宵节也叫上元节”，是很多家庭团圆的节日 。 正月十五日是一年中第一个月圆之夜，加上吃元宵的习俗，这个节日就和团圆两个字牢牢的联系起来。\n按照中国人的选择婚礼日期，选双不选单的习惯，正月十五元宵节当天结婚的新人其实并不多见 ，但 是元宵节的前后却也是婚礼举办的高峰期，如正月十四，正月十六。而这些日期因为临近元宵节，所以都 可以按照元宵节的文案来进行表述。可以按照更改时间名词的方法，将今天改成明天或昨天。第三自然段“今 晚，全城都将会为他们燃起灯光”，可以修改为”昨夜，全城都在为他们燃起灯光“，或”明晚，全城都将会为 他们燃起灯光“。\n\n情人节是每年的公历 2 ⽉ 14 ⽇ ,是西方国家的传统节日之一,起源于基督教。这是一个关于爱 、浪漫以 及花 、巧克力的节日男女在这一天互送礼物用以表达爱意。情人节的晚餐约会通常代表了情侣关系的发展 关键。现已成为欧美各国青年人喜爱的节日 ，其他国家也已开始流行 。而在中国，传统节日之一的七夕节 也是姑娘们重视的日子 ，因此而被称为中国的情人节。由于能表达共同的人类情怀，各国各地纷纷发掘了 自身的“情人节”。\n由于这个节日有它独特的日期专属性，所以非情人节当天的婚礼并不是特别适用于这段台词。记忆中 每年都会有新人选择在情人节这一天来领证或举办仪式，希望这个充满着甜蜜的节日能够成为他们婚姻永 恒的纪念。第二 自然段有两句台词。“每天上下班的接送，每个纪念日的礼物” ，需要和新人进行沟通后自 行确定是吾可用 。通用版的合词也需结合真实情况，否则会产生嘴尬，用出笑话。", "tags": ["仪式", "元宵节通用婚礼开场词", "台词", "开场", "新郎", "来宾", "祝福", "节日节气"]}, {"id": "l_b03fbc81a8", "cat": "节日节气", "title": "11 情人节通用婚礼开场词", "body": "(公历 2 ⽉ 14 ⽇)\n尊敬的各位来宾，女士们先生们大家中午好，欢迎来到小明和小兰的婚礼。\n各位有没有发现，原本平凡无奇的日子一旦拥有了一个名字，被贴上了标签， 似乎一下子就变得有了灵魂，因为它的与众不同而显得满满的仪式感。就像今天， 2 ⽉ 14 号，它的名字叫情人节，无数相爱的年轻人用玫瑰装扮了这座城市，就连  空气中都飘满了香甜的味道，而小明和小兰在情人节里的这一场婚礼，也被更多  浪漫的氛围所笼罩。\n其实很多的恋人过的不是情人节，而是寻求有人疼爱，和被人疼爱的感觉。 就像小明和小兰，他们之间的那份爱，根本 无需非要找个一个特定的时间节点 去表达，那些平常平淡又平凡的过往日子，每天上下班的接送，每个纪念日的礼 物，每个心照不宣的默契和每个细枝末节的在乎，这些都是他们不常说出口的爱 意。\n情人节里面最浪漫的礼物不是玫瑰花，不是巧克力，而是小明和小兰他们给\n\n彼此的这场以余生来作为条件的婚礼。就在此刻也许无数的情侣们正在电影院， 西餐厅里交换着承诺，而我们将会在这间宴会厅，见证他们用实际行动，用今天 的这一场仪式来把各自的人生 ，连接在一起。祝每个有爱的人 ，情人节快乐。有 爱的他们，每一天都是情人节，每刻，都会幸福快乐。\n\n雨水，是春的开始，奉雨至，万物生。雨水润泽万物。此时大地回暖，天地间最开春气象。如果说立春 是春天的“序由”，只是刚春意萌发，还会乍暖还案的话，那么雨水便进入了春天的第二乐章“变奏”，人们会 明显感到春回大地，田野一片生机，正是九歌中的“七九河开、八九雁来”时节，农民们快要闹春耕了。俗话 说，“春雨贵如油”，雨水的到来，提醒人们该为一年的好收成谋划了。雨水落在枯木上得以逢春，落在干裂 的黄土地上，种子得以发芽。“春雨贵如油” ，万物都渴望着这一场甘霖，等待新生。\n雨水节气的日期是每年的公历 2 ⽉ 18-19 日 ，第一自然段里面有一句带有明显地域性质的文字表述，如 “北方的我们仍在春寒料峭中等待着日渐回归的温暖” 。南方的小伙伴可以将这句话稍微修改加工而使用。 如“北方的大地仍在春寒料峭中等待着日渐回归的温暖，而身处华南(江南/中原)的我们，已经在暖阳的漫润 下，心里装满了春天归来的喜悦“ 。地理位置可以根据自身所在地城选择适合用的词语。如，天府之国，齐 鲁大地，燕山脚下等等。", "tags": ["仪式", "开场", "情人节通用婚礼开场词", "来宾", "节日节气"]}, {"id": "l_0ddb1468bc", "cat": "节日节气", "title": "12 雨水节气通用婚礼开场词", "body": "(公历 2 ⽉ 18-19 ⽇)\n尊敬的各位来宾，女士们先生们大家中午好，2 月已经过半，北方的我们仍  在春寒料峭中等待着日渐回归的温暖 。不知道大家有没有注意 ，今天是农历 24  个节气中的第二个雨水。如果说立春代表的是四季轮回的开始，那雨水则象征着  春天正式的拉开了序幕。春水归来，万物初生，初生的不仅是根植于地下的生命， 还有我们今天来共同祝福的这个于此刻成立的小家庭。\n虽然节气的名字叫雨水，可是这样的季节却并不一定真的会下雨，只是象征 着冬天正在渐行渐远，春天即将要回归这个世界。所以小明小兰的婚礼，是证明 他们已经有了足够充足的决心和准备，要和对方这一生都不离不弃。而未来毕竟 还很长，决心和信心也需要化作坚持和努力 ，以及他们共同的目标和梦想，才能 够在这个纷纷扰扰的年代，践行初心 ，将婚姻进行到底。\n好雨知时节，当春乃发生。春雨浸润万物，也一定会滋润着他们甜蜜的爱情， 他们幸福的婚姻和美满的家庭。各位，雨水可以润物细无声，但是我们的掌声还  是要大一点才会让他们听到我们大家的热情。谢谢各位，掌声祝他们新婚快乐。", "tags": ["开场", "来宾", "祝福", "节日节气"]}, {"id": "l_f498283e44", "cat": "节日节气", "title": "13 二月二通用婚礼开场词", "body": "(农历二月初二)\n尊敬的各位嘉宾，女士们先生们大家节日好。春节和元宵节的喜庆还余味缭 绕，一转眼又到了一个属于中国人的传统节日 ，二月二。二月初二龙抬头，龙是 中华民间传说中的祥瑞之物，而龙拍头的日子自然也算的上是祥瑞之日 。相传这 天要剃龙头，预示着辞旧迎新，鸿运当头。既然是祥瑞之日 ，这一天结婚也一定 有美好的预示，比如他们，龙凤呈祥，相约白头。\n二月初二 ，中国人喜欢好事成双，这又叫双喜临门。而这个谱音与爱有关的 日子，好像本身就带着些许的浪漫格调。除了这些，还有好多好多关于二月初二 的美好。这一天人们都去 理发，这一天这对小两口在这里结发;这一天人们都要 吃饺子 ， 叫食龙耳，这天他们也吃饺子 ， 预示着他们会早生贵子。二月初二又 叫春龙节，他们今天用爱和承诺编织的同心结，象征他们两个人会白头借老，同 心永结。\n春风得意二月二，翘首以盼好彩头，感谢各位家人朋友在这样一个节日里来 陪件和帮忙见证一份爱情，祝愿今天婚礼圆满，祝愿小两口喜乐平安。祝愿各位 在这个龙抬头的日子 ，抬头皆美好，所见皆温柔。\n“二月二 ，龙抬头，千家万户始耕牛 。”二月二又叫春耕节。上古时代的人们认识到星辰运行与农耕文 化有关，那时人们出于对自然天象的崇拜就有了二\n月二这个民间节日 。龙是指二十八星宿的东方苍龙七宿星象，每年的正春，卯月初，龙角星就从东方 的地平线升起，是为龙抬头。根据《易经》挂相显示，龙离开了\n潜伏状态，出现在大地上，崭露头脚，是生发的大象。二月二正好是惊蛰节气的前后，百虫复苏，故 引龙去驱逐。\n农历的二月初二一直是一个婚礼较多的日子 ，“春风得意二月二 ，翘首以盼好彩头” ，气温正慢慢的回 暖，到处充满着春天的气息。这段词里面用到很多的韵脚。如，剃龙头，鸿运当头，相约白头。春龙节，同 心结，同心永结。以此增加了这段台词的趣味性，合理性，及完整性。听起来舒服，说起来顺溜。\n\n惊蛰，古称“启蛰”，是农历二十四节气中的第三个节气，标志着天气回暖，春雷始鸣。“蛰”是指整个冬 天都潜伏在地下的动物，它们不食不动。顾名思义，惊蛰就是惊醒这些长眠在地下的虫兽。事实上，春雷 并不能唤醒这些昆虫 ，春回大地，气温攀升才是动物们逐渐苏醒的原因。惊蛰时节，绿意盎然的大地已经 吹起了和煦的暖风 ，带着桃花刚吐露的芬芳，轻缓地从脸上拂过，空气都有了几分醉人的味道，我们在阳 春三月里，尽情享受万物依随，时节变迁。这是春暖花开的时节，田野上，农民播种希望，树林里，阵阵鸟\n\n语花香。\n\n惊蛰节气是每年的 3 ⽉ 5-6 日 ，对于我国大多数地区来说，真正的春天已经到来了。“气温日渐回暖， 万物生机盎然\"。虽然三月早春的风仍还有丝丝缕缕的凉意。但是这样的日子来举办婚礼，似乎也象征着新 人的幸福同春天一道，伴随着滚滚的春雷，来到这个世界。这段词也同样可以将日期的名词进行更换从而 获得更大的便用范围。或“此刻正值中国农历 24个节气中的惊蛰时节” 。在春分到来前都可以使用。", "tags": ["二月二通用婚礼开场词", "台词", "开场", "节日节气"]}, {"id": "l_afd42c84c8", "cat": "节日节气", "title": "14 惊蛰节气通用婚礼开场词", "body": "(公历 3 ⽉ 5-6 ⽇)\n各位来宾，大家中午好，今天是农历二十四个节气中的惊蛰，气温日渐回暖， 万物生机盎然。惊蛰的寓意是春雷惊醒了蛰伏于冬天里的生命，唤醒了这个世界  的北半球，对于温暖的期盼。和万物一同被唤醒的，还有小明和小兰，因为婚礼  梦想的实现而生的满满的幸福感。\n许多人说恋爱是结婚的伏笔，蛰伏在看似平凡的故事段落中的那些心动和欣 喜，为爱情抹上了如同蜜糖一般的甜，和不停生长的动力。蛰伏在时光森林中的 那些心安和笃定，就像是根植土里的大树，任凭风吹雨打也无法动摇他们向往婚 姻的初心。\n虽然这个日子的名字叫惊蛰，但是这个春天带给他们的惊喜却没有丝毫的打  折，他们共同经历的坎坷与曲折也终究成就了如今美满的这一刻。春雷再响，也  比不过万物对春天的向往和对生长的渴望。春雨再贵，也贵不过和一个一往情深  的爱人，和一群温暖有爱的朋友及家人，共赴这场春天的约会。谢谢各位的光临， 让我们用一次春雷一样的掌声， 扫尽冬日的清冷和阴霾，愿所有的小美好，同  春天一同为他们醒来。掌声来送给今天的这一场婚礼吧 。", "tags": ["开场", "故事", "来宾", "节日节气"]}, {"id": "l_3aa3004ded", "cat": "节日节气", "title": "15 三八女人节通用婚礼开场词", "body": "(公历 3 ⽉ 8 ⽇)\n\n尊敬的各位嘉宾，女士们先生们大家好。欢迎在这样的一个特别的日子里来   参加小明和小兰的婚礼。我觉得今天算得上是整个 3 月里面最柔情又温暖的一天， 南方的城市已经绿草如茵，鲜花烂漫。北方多地还冰雪未融，乍暖还寒。不管是   南方还是北方，今天都是同一朵花开的日子，这朵花的名字，就叫女人花。对于   今天举办婚礼的小兰来说，原本这个属于她的节日 ，又增添了一抹幸福的仪式感。\n三八节的意义是提醒所有的女士们不要囿于生活的琐碎，要记得优雅和灿烂，\n\n记得阳光与明娟。而这一天的婚礼更像是提醒着小明，属于他的这朵美丽的花， 今天开始将要和他一起走进平凡的生活，你为她遮风挡雨 ，她便为你惊艳盛放， 你给她阳光雨露，她便会让你的生活飘满芳香。\n说到三八节。我们为它取了很多好听的名字，但是新娘小兰说她不喜欢把自 己看成是什么女王，或女神，而更愿意去做一个懂得被疼爱的女人。会有一个和 她般配又合拍的先生 ，跟她一起面对鸡毛蒜皮的琐事，会欣赏她的优雅而精致， 把每一个普通的日子都过成像今天样的节日 。真的就像歌词里唱的，能这样一起 慢慢变老，这是他们能想到的最浪漫的事。今天的这一场婚礼，愿能成为他们终 身浪漫的开始，各位来宾，掌声为他们响起一次，送去我们的祝福吧!\n国际劳动妇女节，又被称为“国际妇女节”、“三八节”和“三八妇女节”。是在每年的 3 ⽉ 8 日为庆祝妇女 在经济 、政治和社会等领域作出的重要贡献和取得的巨大成就而设立的节日 。三八妇女节的意义在于致敬 女性劳动者，认可女性为社会进步做出的贡献，让女性与男性一样获得平等的权利 、平等的机会 、可以共 同进步。\n三八节也是婚礼常见的日期，所以这段台词的应用频率应不算小 。在第一自然段加上了一段南北不同 温度和时节的表述，目的是让南方北方的小伙伴用起来都不会有不合适的感觉。究竟是“绿草如茵，鲜花烂 漫” ，还是“冰雪未融，乍暖还寒”听众可以自行对号入座，以增加这段台词的画面感和代入感。\n\n1979 年 2 ⽉ 23 日 ，在邓小平提议下，以 3 ⽉ 12 日为中国的植树节，以鼓励全国各族人民植树造林，绿 化祖国，改善环境，造福子孙后代。1981 年 12 ⽉ 13 日 ，第五届全国人大四次会议讨论通过了《关于开展全 民义务植树运动的决议》。这是建国以来国家最高权力机关对绿化祖国作出的第一个重大决议。1982 年 2 ⽉ 27 日 ，国务院常务会议通过《关于开展全民义务植树运动的实施办法》，规定植树义务劳动。1984 年 9 ⽉ 20 日通过的《中华人民共和国森林法》第 9 条规定，植树造林，保护森林是公民应尽的义务;各级人民政 府有责任组织全民义务植树，开展植树造林活动。(来自知乎百科)\n经常可以听到把婚姻和爱情当做大树的比喻。如“婚姻之树长青”，“婚姻如松柏”等等。所以植树节的婚 礼台词可以加入一些植树的元素进来。同时也给新人们“松柏长青”的美好祝福。台词里面也应用了很多树 的名字，如木棉，松柏合欢。更加休现了植树节婚礼的主题。植树节是每年固定日期，公历的 3 ⽉ 12 日 。", "tags": ["仪式", "台词", "开场", "新娘", "来宾", "祝福", "节日节气"]}, {"id": "l_65f07d017e", "cat": "节日节气", "title": "16 植树节通用婚礼开场词", "body": "(公历 3 ⽉ 12 ⽇)\n\n尊敬的各位嘉宾，女士们先生们大家中午好。老话里面讲，春种一粒粟，秋 收万颗子。很多年前种下的那一棵树苗，想必如今也一定已经挺拔参天，枝繁叶 茂。今天是小明和小兰的婚礼，刚巧又是 3 ⽉ 12 号植树节，在我们大家共同的 见证下，一棵婚姻的小树苗，将会就此根植在这片土地。生活的曲折考验，是风 雨和寒冬，他们对彼此的信任和爱，是阳光和雨露，每一个亲爱的家人和朋友的 祝福与陪伴，就是一大片森林，给这一棵小树苗最温柔的守护。\n其实爱情也跟植树一样，无非是根和土壤的交汇，越是向下扎根，便越有向  上的力量，越是懂得包容迁，便越能获得相爱的彼此，更多的理解和尊重。还记  得三年前初见对方，就像两棵种子埋进了黑暗的土里，历经一个又一个春华秋实， 爱慢慢发芽，小树慢慢长大。紧握在地下的根，是各自的独立和坚强，相触在云  里的叶子，是互相的关爱和支持。他们就像是两棵木棉，彼此互相守护，并肩而  立。这份爱情就像是一株合欢，忠贞不渝而又灿烂热烈。即将开始的婚姻像一棵  松柏，无惧时光的冲刷，也不怕风雪的考验。原来，一切的美好都像是树，追求  幸福的每一步，都算数。植树节开始的婚姻，把一份期待栽进心里，让喜悦和圆  满，茂密成林。请为他们响起一份掌声吧。", "tags": ["开场", "植树节通用婚礼开场词", "祝福", "节日节气"]}, {"id": "l_ef9c98cafe", "cat": "节日节气", "title": "17 白色情人节通用婚礼开场词", "body": "(公历 3 ⽉ 14 ⽇)\n对于很多朋友来说今天可能只是很普通的一天(周末) ，可是今天除了这一场 婚礼，它还有另一个名字，叫“白色情人节” 。相传在 2 ⽉ 14 号收到礼物的人，这 一天要回赠给爱人一份礼物，以表达心里对 TA 的一份同样炽热的爱意。和大家 一样，对这个节日我也很陌生 ，不知道是商家的噱头还是个别地域的小众习俗， 但我觉得，既然是一个有爱的日子，还刚好赶上了这一场婚礼，是不是也能够为 小明和小兰的故事增添一 抹浪漫，也为今天的婚礼增添一份节日的色彩。\n其实节日的意义只是在提醒着我们生活不要过的平淡又枯燥，把普通的日子 装扮的有仪式感，漫长的人生才会有更多的美好值得纪念。就像今天，白色情人 节，听起来浪漫又纯净，就像待会我们看到的小兰，穿着白色的婚纱，庄重又圣 洁。在三月温暖的春风里 ，在早春明媚的阳光下(或早春缠绵的小雨中) ，那一张 沾满了期待的笑脸会和煦小明，这个幸福的男人一生中最难忘的一天。 无论是 红色情人节，还是白色情人节，无非都是浪漫中开出的不同颜色的小花，不过都 是在提醒着有情人相爱的仪式感。但对于心中有爱的人来说，只要爱对了人，在 一起的每天都是情人节。\n白色情人节订于 3 ⽉ 14 日 ，一般认为是对于西方情人节的延续，最早起源于公元三世纪时的罗马。相\n\n传罗马皇帝设立情人节是为了纪念自己在 2 ⽉ 14 日救了一对因违反恋爱结婚禁令而要被处死的恋人。一个 月后，也就是 3 ⽉ 14 日 ，这对情侣宣誓至死不渝，后来便成为白色情人节开始流传到其他国家。普遍认为 日本最早接受并推广这个节日 ，由于日本强大的文化软实力使得亚洲国家纷纷效仿,于是这个没有准确史料 记载的情人节也成为年轻情侣看重的另一个“情人节” 。白色情人节流行于日本 、中国台湾等地区，在送礼 方面也不同：具体为 2 ⽉ 14 日男方送女方一份礼物,主要是玫瑰花或者巧克力(只是中国大陆和英美法)\n3 ⽉ 14 日白色情人节，就该轮到女方送男方礼物了，(日本，中国台湾是刚好相反的，2 ⽉ 14 日是女生 送巧克力 ，3 ⽉ 14 日是男生回礼)在日本，通常欲告白的女方会在情人节(2 ⽉ 14 ⽇)的时候送礼给心仪的对 象,而收到礼物的一方，则会在 3 ⽉ 14 日回礼并告诉女方自己的心意。亚洲部分地区的年轻人亦会庆祝这个 节日 。\n突然在日历上看到了这个日子 ，于是简单的了解了一下，其实我并未听过这个节日 。(手动尴尬脸)\n\n每年的 3 ⽉ 15 日都是统称为“国际消费者权益日”这是为了更多扩大保护消费者权益的一一个意识，使  之在业内能够得到一个重视，让消费者的权益得到更 多的保护，也促进与之各地消费者之间的合作与交往。 并在这一天将会无偿的去帮助消费者去维权，与之消费者购买到假货将会进行严厉打击，在行内业称“315  国际打假日”所以在 315 的时候消费者购买到假货投诉到 12315,都会得到非常有效的回复效率和处理结果。\n在中国老百姓的意识里面 ，315 还有个名字叫“打假日 ”，这样的节日主题跟婚礼看似没有任何关联，但 却能找到他们共同的关键词，就是真，真诚，真实。而通过这个关键词将这个节日的属任和婚礼巧妙地结 合起来，会让新人 ，家人及现场来宾听到主持人的联想能力 ，应变能力 ，逻辑思维能力 。同时也再次印证 了“万物皆可词”的理论。\n\n18“315”” 通用婚礼开场词\n\n(公历 3 ⽉ 15 ⽇)\n尊敬的各位来宾，女士们先生们大家好，欢迎在这个特别的日子来参加婚礼， 代表小明和小兰及他们的家人感谢各位到来。\n今天是 3 ⽉ 15 号，简称叫“315”  ，全称叫消费者权益日 ，好像以前还有个名 字叫打假日 。小明和小兰能选在这一天来举办他们的婚礼足以看出他们对这份爱 情的质量有着坚定的信心 ，还有对彼此的真心能经得起任何的鉴定。\n我们都生活在一个靠滤镜和美颜才能见人的时代，总是担心自己过于真实会 跟这个社会格格不人。但是从小明和小兰第一次见面到今天，他们却始终保持着 一份真实和坦荡，没有掩饰和做作，有刻意也没有伪装，而这反倒让他们因为对\n\n方的真诚而使这份爱变得更加的踏实妥帖和笃定，让他们没有丝毫防备的将自己 所有的过去，和全部的未来统统都交给对方。\n这段恋爱成功的走向今天的圆满，也为他们做了最好的诠释，两个足够真实 的爱人，一份足够真实的爱情，真的比任何的美颜滤镜下的照片，都更加令人羡 慕和被吸引。有人说真金不怕大练，我想说，真爱无惧考验。他们的承诺无需在 315 这一天来辨别真假， 因为 365 天，他们都如同今天样，心中一份虔诚，天地 可鉴。各位，他们即将走上舞台接受大家的祝福，我们大家的拿声就是给他们的 婚礼最好的一份礼物。\n\n春分，太阳黄经 0 度，[分者半也]是说春分是春天三个月即九十天的一半，此日也是昼夜平分。夏手和 冬季不说夏分。冬分，而是夏至 、冬至 。春分的分是草寒与温暖的分界。春分之前，杨柳风虽已青绿,却春 寒料峭,东风无力 ，欲说还休。春分一过。杨柳风就变成了桃李风 ，二月春风似剪刀 ，春犹浅，青犹短,草色 带朝而，卷帘花万重，春风似乎被染成红粉色，淡粉飘处，杏花烟迷，桃花雾浓，红深红浅之间。春色烘衣 暖。春分与秋分都是昼夜平分，冷热均街，一年中最好的气候。平分昼夜和心事，一半捣碎成雨 ，一半消 逝如云。每一年，燕子都会望春而归，春分来秋分去，总是在追逐温暖。\n因为只有春分和秋分的当天，太阳直射赤道，地球昼夜均等。所以无论早一天或晚一天都无法准确表 述春分这个节气的特别。 因此这段词应该只适合应用于春分当天。每年春分的日期是公历 3 ⽉ 19-21 日 。", "tags": ["仪式", "告白", "开场", "故事", "来宾", "祝福", "节日节气"]}, {"id": "l_c7841f5d36", "cat": "节日节气", "title": "19 春分节气通用婚礼开场词", "body": "(公历 3 ⽉ 19-21 ⽇)\n尊敬的各位嘉宾女士们先生们大家中午好，欢迎大家来见证一份婚礼的幸福。 阳春三月 ，不管是江南的艳阳天，还是北方的桃花雪，随着春分节气的到来，都   预示着春天被平均的一分两半。前一半是对于冬天的不舍和眷恋，后一半在张开   怀抱准备迎接夏天的到来。虽然春天可以被分成两半，但是对小明和小兰来说，  有关家庭婚姻的义务和责任，却必须要一起扛起，共同承担。\n春分的这一天太阳直射在赤道上，整个星球的任何一个角落都拥有了等长的 昼夜。然后阳光会慢慢的向北半球倾斜，让这里的人们开始拥抱更多的温暖。这 很像他们从今天开始的婚姻生活，站在起跑线，用爱，让家的热度点点的燃烧起 来。尽管也一定会经历秋冬春夏的季节变换，但生活就是如此，起起伏伏，磕磕 绊绊，却让人有了更多向往和希望，也更多梦想和期待。\n春分是春天正当时，既有姹紫嫣红，又有草色如烟，虽然只有五分的春意，\n\n但让我们拥有满载的祝福，让爸妈拥有满心的欢喜，让小明和小兰拥有了满分的 爱情。", "tags": ["开场", "祝福", "节日节气"]}, {"id": "l_7f5289c9b8", "cat": "节日节气", "title": "20 愚人节通用婚礼开场词", "body": "(公历 4 ⽉ 1 ⽇)\n尊敬的各位来宾，女士们先生们大家中午好。欢迎各位在四月的第一天来共 同参加他们的婚礼，这原本是一个很可爱的日子，名字叫愚人节，而今年的愚人 节，却因为他们婚礼的举办而变成了一个很有爱的日子。人们都喜欢在这一天跟 身边的朋友，开一些善意有趣的玩笑，而他们却选择在这一天跟他们最亲爱的家 人 ，来分享他们成家的喜悦。\n可能小兰也会觉得这样的日子跟小明很有缘分吧，因为在她的眼中，小明就 是一个有点愚钝，有点憨憨的家伙。总是傻里傻气的不解风情，稀里糊涂的惹她 生气。其实啊，一个男人能够用他的勇气和智慧去面对外面的千军万马，风雨和 压力 ， 又怎么会看不透一个小女生的心思。只不过他希望在爱人的面前可以做 一个傻傻的小孩，用最清澈的眼神最纯净的内心让姑娘感受到他的毫无掩饰，甘 愿在爱人面前做一个没有任何心机的小透明。\n他们选择在愚人节这一天举办婚礼会不会也有这个用意，希望未来婚姻中的 每天，彼此都能笨笨的相爱，傻傻的守在一起。没有猜忌也不用怀疑，但却有真 实简单的陪伴，能够让他们，将浪漫的爱情进行到底。\n愚人节，也称万愚节、曲默节，时间为 4 ⽉ 1 日 ，并未被任何国家认定为法定节日 。\n\n愚人节较普遍的说法是起源于法国。1564 年，法国首先采用新改革的纪年法一格里历(即通用的阳历)， 以 1 ⽉ 1 日为一年的开端，改变了过去以 4 ⽉ 1 日作为新年开端的历法。\n\n该节在十八世纪流传到英国，后来又被英国早期移民带到了美国，并随着英国的殖民运动和移民活动 被带到了美洲大陆,于是成为了欧美流行的节日 。(来自百度百科)\n这一段词有很多对新人性格的描写，所以应用之前一定要充分的了解新人的性格特点后再斟酌是否适 合使用 。如新郎的性格特点与本段台词不符，可以直接删减掉第二 自然段，把第一和第三自然段的愚人节 的元素放进台词里 ，再加上一些新人的故事背景，从而变成一段完整的，既有节日特色 ，又有定制风格的 婚礼开场词。\n\n清明节又称踏青节、行清节、三月节、祭祖节等，清明节是我国传统节日 ，与端午节、春节、中秋节并\n\n称为中国四大传统节日 。清明节是我国最重要的祭祀节日 ，是祭祖和扫墓的日子 。扫墓俗称上坟，祭祀死 者的一种活动。汉族和一些少数民族大多都是在清明节扫墓。清明节祭祖扫墓等习俗究竟始于何时，现在 恐怕谁也不能给出准确答案。相传，最早出现于周朝，但真正确定为法定假日 ，则是民国政府于民国二十 四年(1930 年)明确规定每年的 4 ⽉ 5 日为国定假日清明节。清明最开始的时候，只是一个很重要的节气，故 有植树造林，莫过清明的农谚，后来由于清明与寒食的日子比较接近，而寒食呢是民间禁火扫墓的日子， 那渐渐的寒食与清明就合二为一了。寒食的意思，就是在这一天只能不动烟火 ，只吃冷的凉，食物。\n清明节举办婚礼的新人不会很多，但是我却遇见过在清明小长假期间来举办婚礼的，如 4 ⽉ 6 日 。写 这篇台词的目的是为了补齐 24 个节气。而清明除了是一个传统节日以外，还是一个节气。清明是反映自然 界物候变化的节气 ，这个时节阳光 明媚 、草木萌动 、百花盛开， 自然界呈现派生 机勃勃的景象。中国南 方地区，此时已呈气清景明之象:北方地区开始断雪，气温上升，春意融融。", "tags": ["台词", "开场", "愚人节通用婚礼开场词", "故事", "新郎", "来宾", "节日节气"]}, {"id": "l_2f052fb7f9", "cat": "节日节气", "title": "21 清明小长假通用婚礼开场词", "body": "(公历 4 ⽉ 4/6 ⽇)\n尊敬的各位来宾，女士们先生们大家节日安康，今天是 202X年 4 ⽉ X 日 ， 清明小长假的第 X 天 ，欢迎大家与我们相聚于此 ，一同分享这一份婚礼的圆满 和幸福。\n一直以来都单纯的认为清明只是一个礼敬先祖的传统节日 ，原来它还是农历 24 个节气中的重要一环。 春天过去了一大半，阳光越来越充足 ，气温越来越温 暖，这一天植树插柳，出游踏青，万物呈现着一片生机盎然。在这个勃勃生机的 仲春和暮春的交界，小明和小兰也把自己的婚礼选在了这个四月的开端。让团圆 与春天同行 ，让思念与希望为伴。\n清明同时承载着自然节气，和人文节日两种不同的含义。而婚礼，也同时兼 具着爱情果实和亲情融合两个不同的重要意义。节气时节去踏春，意味着一个新 的四季，我们要春风得意，而清明假期用一场婚事来告慰先祖，承蒙其福荫，家 中人丁兴旺，枝繁叶茂，子孙昌盛，幸福有余。这样的日子 ，不止有怀念，还要 有期许，有清风，有明日 ，有春日里的光芒，还有四月里，有情人婚姻之路的开 始。各位来宾，谢谢大家的祝福见证，送给一份掌声，给今天的婚礼吧!", "tags": ["开场", "来宾", "祝福", "节日节气"]}, {"id": "l_33c1a26f47", "cat": "节日节气", "title": "22 复活节通用婚礼开场词", "body": "(春分月圆之后的第一一个星期日)\n各位来宾大家周末好，欢迎大家参加小明和小兰的这一场婚礼。对于大多数 的朋友来说，今天这个日子只是普通的一个礼拜天吧，但是对于基督教的信徒来\n\n说，今天是一个特别重要的一个节日 ，来自西方文化中的复活节。每年春分月圆 后的第一个礼拜天，人们来庆祝耶稣的重生。虽然在很多普通的中国民众看来这 个节日有点陌生，但是它却象征着生命的升华和希望。而今天这一场婚礼的日子 刚好遇见了复活节，注定了他们的婚姻，会得到更多的祝福。\n回顾他们从恋爱到结婚，爱情就像复活节里面的彩蛋，外表看起来五颜六色， 缤纷美丽，里面却清清白白 ，悄悄孕育着婚姻的生命。在他们共同精心的孵化与  照料下，这个叫做婚姻的小生命破壳而出，诞生于此。\n每一个美好的瞬间，都是生活的彩蛋，用一些惊喜，一些期待，一些认真来 让平淡的日子增添些许的仪式感。复活节是为了庆祝一个伟大的生命的重生，而 复活节里面的婚礼则是代表着份沾染了美满好运的幸福，全新的开始。所以在今 天，祝福每一个天父的孩子，节日快乐，祝福各位拥有一个喜乐的周末，祝福今 天的婚礼温暖而浪漫，祝福今天的新人 ，新婚幸福，一生美满!\n复活节是一个西方的重要节日 ，在每年春分月圆之后第一个星期日 。是基督教纪念耶稣被钉十字架受 死后第三日复活的节日 。亦称耶稣复活节 、主复活节，天主教亦称耶稣复活瞻礼。复活节的节日象征有复 活节彩蛋和复活节兔。节日期间人们互赠复活节彩蛋，象征生命和繁荣。由于每年的春分日都不固定，所 以每年复活节的具体日期也不确定。但节期大致在 3 ⽉ 22 ⽇⾄ 4 ⽉ 25 日之间。\n许多婚礼会与复活节重合，一是因为三四月的春季，新人们喜欢在这样不冷不热的日子里举办婚礼。 二是因为复活节是周日 ，又是很多新人选择婚礼日期的一个重要的考量条件。如果婚礼恰好与复活节重合， 这段台词会给老师们提供一些思路参考。尤其是基督徒，在复活节结婚，若能为他们加入圣经和基督教的  元素，相信他们定会为主持人的用心而幸福和感动。\n\n春雨绵绵滋养万物，百花盛开，生机盎然，正是最美人间四月天。关于谷雨节的来历，据《淮南子》记 载，仓颉造字，是一件惊天动地的大事，黄帝于春末夏初发布诏令，宣布仓颉造字成功，并号召天下臣民 共习之。这一天，下了一场不平常的雨 ，落下无数的谷米 ，后人因此把这天定名谷雨 ，成为二十四节气中 的一个。谷雨是每年的公历 4 ⽉ 19-21 日 ，节气时长为 15 天左右。所以这段台词不仅可以应用于谷雨节气 前后的日子 ，也可以在谷雨节气的任何一天，而无需过多修改。", "tags": ["仪式", "台词", "复活节通用婚礼开场词", "开场", "来宾", "祝福", "节日节气"]}, {"id": "l_0fb1341c7f", "cat": "节日节气", "title": "23 谷雨节气通用婚礼开场词", "body": "(公历 4 ⽉ 19-21 ⽇)\n各位好，欢迎大家来见证婚礼的幸福。时光如流水，不觉已春深。24 个节气 周而往复着季节的轮回，如今已是第六个，也是春天的最后一个节气 ，谷雨。雨 生百谷，谷养万物，一代代的生命就此得以延续，也让希望和爱得以传承。有人\n\n说谷雨是春天的一场盛大的告别，是为夏天拉开了帷幕。有人说婚礼是对于恋爱 的总结，要迈向婚姻的旅途。谷雨和婚礼的相同之处，就是所有的美好正在孕育 发生 ，一切向好，静待繁盛。\n虽然谷雨是春天的落幕，但那些春天开的花，依然可以继续的盛放在夏天里  面。如同小明和小兰虽然将要告别恋爱，但是未来的婚姻生活中也一定会继续保  留着恋爱的那一份甜。 就像他们共同陪伴和牵手走过的这 X 年的人生路，不仅  有阳光灿烂的日子，还有风的洗礼和雨的浸润，能让他们的爱更加的茂盛和挺拔， 从容面对明天未知的挑战。\n谷雨是 4 月的云朵落下的滴泪， 云朵就是今天的小兰。那一滴晶莹包含着 对父母的感谢，包含着成家的喜悦，也包含着她和爱的人曾经所有付出的青春， 种下的期待，许过的心愿，在此刻终得圆满。幸福的泪水没有悲伤，就像谷雨的 天空，洒落的每一滴都是希望。希望他们婚姻的果园，枝繁叶茂，硕果累累，希 望他们的爱，奔腾不息，源远流长。", "tags": ["开场", "父母", "节日节气", "证婚"]}, {"id": "l_269586bb10", "cat": "节日节气", "title": "24 五一劳动节通用婚礼开场词", "body": "(公历 5 ⽉ 1 ⽇)\n各位好，今天是五月一号劳动节， 祝愿所有的劳动者们节日快乐，今天也 是小明和小兰结婚的日子 ，祝这对幸福的小两口新婚快乐。所以五月的第天，我 们全部的心愿，就是围绕着两个字，快乐。\n人们似乎都很喜欢在这样的日子去做一些快乐的事情，比如这一天，有人从  远方来，有人到远方去，有人倾听了一段终成眷属的故事，有人欣赏山清水秀的  风景，有人等待一场花期，有人有幸见证一场婚姻的开启。五月带给大家的都是  不一样感受，但是美好却都万种如一 。除了快乐，每一年的五一，似乎还充满了  爱意，我问小明和小兰为什么也要选在五一来结婚，他们讲，暮春和立夏的交界， 有春天的希望也有夏天的繁茂,在这个万花盛放的五月 ，想让自己的婚姻也沾满  香气。\n今天是劳动节，婚姻生活其实也像是一场劳作，两个人用自己的汗水去建设 他们的家园，一砖一瓦，用双手去创造。每一份劳动，都是点亮幸福的光芒。不 过有一句老话讲，男女搭配，干活不累，一个对外，一个主内。愿他们这对小夫 妻能安排好各自的角色，勤劳奋进，互相配合，过好幸福的小日子，开创美满的 新生活。各位来宾，掌声祝福他们吧。", "tags": ["开场", "故事", "来宾", "祝福", "节日节气"]}, {"id": "l_21382b10e0", "cat": "节日节气", "title": "19 世纪中叶，美国资本主义不断发生经济危机，几万家工厂倒闭，数百万工人失业。在业工人的工资 不断下降，而工作时间却一再延长，最多达到 18 个小时。因此，1886 年 5 ⽉ 1 日 ，美国 40余万名工人规模 空前的大罢工 ，要求实行 8 小时工作制。罢工在美国和国际工人运动中引起的强烈的反响并最终取得了胜 利。", "body": "1889 年 7 月 ，在恩格斯组织召开的第二国际在巴黎召开成立大会上通过了一项具有历史意义的决议： 把“5 ⽉ 1 ⽇ ”定为“国际劳动节” ，简称“五一 ”。\n从此每逢这一天，世界各国的劳动人民都要集会 、游行 ，以示庆祝。五月一日成为一个具有国际意义 的日子。\n每一年的“五一”期间都是全国各地扎堆结婚的旺季。不仅因为五月的小长假，大家都不用工作，婚礼 可以收到更多的祝福，可以热热闹闹。更因为五月不冷不热的天气非常适合举办婚礼。春暖花开,万物新生, 许多的地方已经开始有了夏天的景象。整个五月都是结婚的好时节，尤其以 5 ⽉ 1 日当天更是无数新人选 择婚期的热门日期。\n\n五四青年节源于中国 1919 年反帝爱国的“五四运动”，五四爱国运动是”次彻底的反对帝国主义和封建主 义的爱国运动，也是中国新民主主义革命的开始。1939 年，陕甘宁边区西北青年救国联合会规定 5 ⽉ 4 ⽇ 为中国青年节。\n青年节期间，中国各地都要举行丰富多彩的纪念活动，青年们还要集中进行各种社会志愿和社会实践 活动，还有许多地方在青年节期间举行成人仪式。\n五四青年节也因为沾染了五一黄金周的热度， 成为了婚礼的一个大火的日子 ， 但由 于这个节日与革 命和抗争有关，所以婚礼台词唯一可用的主题元素， 也仅限青春，年轻等等。", "tags": ["不断下降", "世纪中叶", "仪式", "几万家工厂倒闭", "台词", "最多达到", "祝福", "空前的大罢工", "美国", "而工作时间却一再延长", "节日节气", "要求实行"]}, {"id": "l_a096e679ad", "cat": "节日节气", "title": "25 五四青年节通用婚礼开场词", "body": "(公历 5 ⽉ 4 ⽇)\n大家好。今天是 5 ⽉ 4 号青年节，祝愿大家节日快乐，年长的朋友觉得这个 节日跟自己无关，其实不然。五月处在春夏的交界，季节的变换并不是意味着春 天将要准备离场，而是它把自己的温暖融进了夏天的炙热里面 。对很多人来说， 青春的不复其实并非它已远去，只要经历过青春，它就是组成你人生不可替代的 一部分，就像小明和小兰一样，他们开始了婚姻，并不是宣告着恋爱的结束，是 爱变成了另一种方式融进彼此之间，融进了他们的家庭。\n五四青年节，两个年轻人在这个日子宣告对对方一生不变的承诺，真的很有  一种特别的意义。这是他们最好的年纪，有承担，有愿景，有能力为美好的生活  去努力，也有信心经营好爱和家庭。因为年轻，他们不怕未来多风浪，因为年轻， 他们无惧岁月多磨砺，因为年轻，他们还有更多的心愿和梦想，要找一个互相深  爱，志同道合的人一起去打拼和追逐。\n\n五月本就是一个象征着年轻的月份，不止因为有青年节，还有那么多充满勃 勃生机的花草树木，装扮着这个美丽的世界。 青年节的这一天， 也不仅是我们 所有人永远的节日 ，还是小明和小兰，永远的幸福纪念。祝大家节日欢乐，祝小 明和小兰，幸福美满。", "tags": ["开场", "节日节气"]}, {"id": "l_f6c3ec0c9f", "cat": "节日节气", "title": "26 母亲节通用婚礼开场词", "body": "(公历 5 月的第二个星期日)\n各位来宾大家好，欢迎您在这样一个温暖的周末来见证一份爱情。说它温暖 并不因为五月的阳光和立夏的到来，而是这个日子里飘散着康乃馨的花香，这个 日子洋溢着比鲜花还要灿烂的笑脸，这个日子充满着温情和爱，这个日子，是母 亲节。\n我没有问过小明小兰为什么选在这个日子结婚，我猜他们是想给妈妈一份节 日的礼物吧。毕竟这个世界没有什么东西能比，看到自己孩子的幸福更让妈妈觉 得欣慰的事情。同样，这个世界也没有什么能比看到妈妈的快乐，更让孩子们觉 得开心的东西。\n母亲节对妈妈来说只是一个普通的礼拜天，她们在意的不是自己哪天过节， 心里装着的永远都是孩子的冷暖。就像今天的两位妈妈，她们没考虑属于自己的  节日快不快乐，她们担心的是孩子的婚礼今天是否顺利和圆满。还在操心着每一  个亲友能不能吃好饭。所以我要对两位妈妈讲，今天是您的节日 ，孩子结婚也是  您的节日 ，今天是两个家庭的结合，更是一个节日 。同一个节日 ，却有三倍的快  乐，希望您可以好好的享受这个过程。一直以来妈妈最大的心愿就是孩子们能有  自己的家，今天一切美好的期待都有了结果。所以这里邀请我们大家，响起掌声， 送给妈妈，送给今天的婚礼，送给所有人，祝我们大家都都在属于妈妈的节日里， 感到快乐。\n母亲节起源于美国，这个节日的发起人是费城人安娜.贾维斯，这个女子终生未嫁，膝下无儿无女。1906 年 5 ⽉ 9 日 ，安娜.贾维斯的母亲不幸去世，她悲痛万分。在次年母亲逝世的周年忌日 ，贾维斯组织了追思 母亲的活动，并鼓励他人也以类似方式来表达对各自慈母的感激之情。\n她的呼吁获得热烈响应。1913 年 5 ⽉ 10 日 ，美国参众两院通过决议案，由威尔逊总统签署公告，决定 每年 5 月的第二个星期日为母亲节。\n之所以母亲节这一天也会是很多新人选择婚期的热门 ，有以下几个原因。第一 ，五月是结婚的高峰月 ;    第二 ，母亲节是礼拜天;第三，孩子也想借着这一场婚礼为节日里的母亲送上一份自己的礼物，表达一份心   中的感谢。所以在台词中加入了“这个世界没有什么东西能比看到自己孩子的幸福更让妈妈觉得欣慰的事情” 相信每一个为人母者都能感同身受,每一个为人子女的人都会深有同感，每一个听众都会有感知，有共鸣。\n\n立夏来临，昭示着春天的结束，夏天的开始。历经了四月的繁花似锦，即将迎来“夏木阴阴正可人”的 初夏时节。因此又称“春尽日 ”。春生 、夏长 、秋收、冬藏。“立夏”节气到来， 自此风暖昼长 ，万物繁茂。虽 是进入夏季的第一个节气 ，但“绿树荫浓夏日长”的夏日景象，仅存在于中国南岭以南，对于全国的大部， 依旧处于红紫斗芳菲的仲春与暮春。时至立夏，万物至此皆长大 。孟夏之日 ，天地始交，万物并秀。\n立夏的日期是每年公历的 5 月上旬，阳光温暖，夏风和煦。真的很适合举办婚礼。婚礼逢立夏，仿若 锦上添花。为这个初来乍到的夏天又增添了些许的爱意。也预示新人的婚姻和幸福如夏季的勃勃生机，充 满了美好与缤纷的彩色 ，和热烈的真情。", "tags": ["台词", "开场", "来宾", "母亲节通用婚礼开场词", "节日节气"]}, {"id": "l_a1c43175d0", "cat": "节日节气", "title": "27 立夏节气通用婚礼开场词", "body": "(公历 5 ⽉ 5-7 ⽇)\n尊敬的各位来宾，欢迎大家参加小明和小兰的婚礼。尽管春风春雨和春日的 阳光还徘徊眷恋着不肯走，但此时的季节却已翻开了新的一页。就像杨万里的诗 句，小荷才露尖尖角，早有蜻蜓立上头。农历节气中的立夏，是季节中夏天的置 顶，小明和小兰的婚姻生活，也跟着夏天一起，盛大的开幕了。\n春生 ，夏长 ，秋收，冬藏。想到夏天似乎自然就会浮现着处处繁盛的景象。 仔细的形容一下爱情似乎也跟季节相差不多。初见彼此时眼中的温柔火苗，刚好  可以融化积攒了一个冬天的雪，欢喜日渐萌生，仿佛春风细细，又好似春雨绵绵。 当爱变得炙热浓烈时，就像时光来到了夏天，用一场盛大的婚礼，让所有的花都  为他们的幸福而盛放。而秋天就像他们的感情，褪去了花团锦簇的缤纷，却多了  些许的理性与成熟，还有硕果累累的收获。冬天他们一起抵御风雪，刻画着年复.  年他们相守于岁月的标签，还有雪落于头上时，他们牵手白头的心愿。\n立夏以后的日子 ，会一天比一天更加的灿烂明媚。愿他们结婚以后的生活， 也会一年比一年更加喜乐与和美。各位，夏天到了，到了一年中最好的季节，婚 礼到了，到了他们一生中最值得纪念的一天。", "tags": ["开场", "来宾", "节日节气"]}, {"id": "l_4a98a6c00d", "cat": "节日节气", "title": "28 护士节通用婚礼开场词", "body": "(公历 5 ⽉ 12 ⽇)\n各位好，欢迎大家参加小明和小兰的婚礼。今天是 5 ⽉ 12 号，一个初夏的 5 月里，看似平凡普通又平淡无奇的天。可能很多的家人朋友并不了解，今天是一 个节日 。 有人叫它南丁格尔节，有人叫它提灯女神节，有人叫它白衣天使节， 面叫的最多的，是国际护士节。所以在今天我们首先要向每一位可爱的白衣天使 们，送上一份节日的祝福与问候，你们辛苦了。\n今天的新娘小兰就是一名美丽的护士 ， 而她的美丽又不仅体现在她的颜值。 从投身于这份工作的那一刻起， 她似乎就变成了一个天使的化身，用爱和关怀  去抚慰着那些被病痛折磨的陌生人。在没有硝烟的战役中，用娇弱的身躯和坚定  的使命，替无数人挡住那一扇被瘟疫和病魔不断冲击的大门。小明说，老婆的工  作是用爱去温暖病患，我能够为她做的，就是给她更多的爱，让她能感受到在身  后的那一缕温暖。一个满分的爱人真的不是看他有多帅多好看，不是他的事业多  大多精彩，而是能够对你的选择有共情有理解，能够与你合力的扛着使命，并热  爱你的热爱。\n今天的小明把爱人的燕帽换成了王冠，把爱人的白衣换成了白纱，把爱人从 天使换成了公主。用这场婚礼，许给她一句承诺，许给她一生幸福。 在这一个 特别的日子 ， 请大家一起来祝福他们吧，掌声热情一点，可以吗?\n英法联军与沙俄发生激战的期间，英国的一位护士主任南丁格尔，带领 38 名护士奔走前线，参加护理  伤病员的工作。因当时医疗管理混乱，护理质量很差，伤病员死亡率很高 。在这种情况下，南丁格尔下定  决心潜心改善病室的卫生条件，并加强对病人的护理和营养。半年之后，医院的伤病员死亡率下降到了 2.2%。 这一事迹传遍全欧。1860 年，她在英国伦敦创办了世界上第一所正规护士学校。她的护士工作专著也成了  医院管理 、护士教育的基础教材。鉴于南丁格尔推动了世界各地护理工作和护士教育的发展，因此其被誉  为“近代护理创始人”。在南丁格尔逝世后，国际护士理事会为纪念南丁格尔为护理事业做出的贡献，于 1912  年将她的生日 5 ⽉ 12 日定为“国际护士节” ，最初称“医院日 ”，也称“南丁格尔日 ”。\n这段词有着明显的职业属性，所以 5 ⽉ 12 日结婚的新人 ，又刚好是护士 ，相信这一段台词和表达定会 给 TA 留下深刻印象。如果当天婚礼的新人不是护士，本篇开场词并不适用。但是第二，三自然段。可以当 做是护士职业的通用版台词，适用于任何新人是护士的婚礼。\n\n2013 年 5 ⽉ 15 日 ，是联合国确立的第 20 个“国际家庭日 ”。“ 国家家庭日的主题为“推进社会融合和代际 团结”。然而，兼顾工作与家庭的压力导致的生育养育问题、少子化和老龄化带来的家庭养老问题以及流动 带来的外来家庭多重发展问题已经成为上中国很多家庭面临的三大主要问题。\n\n提醒社会大众重视、关爱家人及重视家庭问题;家人能否团结一心 、互相扶持与鼓励，已关系到整个社 会能否融合。如儒家倡导“天下之本在国，国之本在家，家之本在身” 。(来自百度百科)\n国际家庭日并非常见的节日 ，只是写这一篇台词时那天刚好是 5 ⽉ 15 日 ，于是就有了随性的一篇婚礼 开场白 。如果你的婚礼也刚好赶上了 5 ⽉ 15 日 ，本篇台词便可应用。", "tags": ["台词", "开场", "护士节通用婚礼开场词", "新娘", "祝福", "节日节气"]}, {"id": "l_e351f27ac7", "cat": "节日节气", "title": "29 国际家庭日通用婚礼开场词", "body": "(公历 5 ⽉ 15 ⽇)\n各位好，欢迎大家来参加小明和小兰的婚礼。今天是 S ⽉ 15 号。这个日子  可能大家看起来普通又平凡，好像没什么特别的意义。但我却觉得这个日子像一  把小刀 ， 把一个美好的初夏五月 ，平均的一分两半。 这个日子也像是一座小桥， 把两个曾经毫无关联的小家庭，完美的合二为一。\n虽然五月才刚刚过去了一半，但是我们却经历过了好多值得纪念的日子，五  一劳动节，五四青年节，五月有属于妈妈的节日 ，还有立夏的开始。而今天也是  一个节日 ，也许大家没有注意到或者有的朋友并不是很了解，今天叫做国际家庭  日 ，设立的初衷，是要提醒社会各界关注家庭的幸福与和睦，让家更温暖，让家  人团结一心。在这样的日子里小明和小兰成立一个小家庭，好像更特别，更美好， 更有一种不同的幸福意义。\n在这个五月的下半场的开场时间，他们即将要走进了婚姻的城堡，即将要走 进人生另一个新的篇章。前半月埋下的伏笔，后半月要变成了故事的主线，曾经 过往中如果有遗憾，那也是为下半月的惊喜和圆满到来，做的铺垫。五月过半， 美好的季节，正在赶来，欢迎大家，参加小明和小兰的婚礼。请用掌声，为他们 祝福，谢谢各位。", "tags": ["开场", "故事", "祝福", "节日节气"]}, {"id": "l_32062a3db1", "cat": "节日节气", "title": "30 520 通用婚礼开场词", "body": "(公历 5 ⽉ 20 ⽇)\n各位好，欢迎大家来参加婚礼，今天是“520”，翻遍了国内外所有已造册的传  统节日当中，好像都没有关于这个日子的记载。但是最近的几年，他已经变成了  无数相爱的情侣们如朝圣日般重要的存在。520 的谐音是我爱你，想要让这个日  子跟自己有关，你必须要心中有爱，身边有伴，愿意在平凡的生活里为心爱的人， 去制造温暖和浪漫。因此小明和小兰把他们的婚礼选在了 520 这个日子，他们以  此向时光保证，我爱你，不止是一时一刻的承诺，也是他们婚姻开始的初心。\n\n520 是一个怎样的日子呢?有人喜欢在这一天表白 ，有人喜欢在这天互送礼物 来表达爱。有人会在这个日子去登记领证，让 520 的浪漫永远的印在他们的结婚 证书的上面。其实这个日子在365 天当中并没有多么的特别，只是普通的三个阿 拉伯数字。但是我们就生活在一个数字的时代，并不是每一串连在起的数字都能 巧合的与爱有关，所以，既然赶上了，就好好的在这一天去分享，去感受，去创 造，去发现。正如我们今天堂在这里，共赶这场以爱之名的道约。对于今天这里 的所有人来说。520 不是串冰冷的数字，而是人生旅途中遇见的一场盟暖。祝福 大家 520 快乐。祝福小明和小兰幸福美满。\n曾几何时，网络上出现了一个“网络情人节” ，那就是在每年的 5 ⽉ 20 日 。取 520谐音“我爱你” ，加上 了 1314 谐音“一生一世”，成为了充满浪漫气息、美好愿望的 5201315“我爱你一生一世”，这段由一些单调乏 味的数字，被人们赋以了特别內涵之后，成为了人间又一道美意附含的爱意密码，而越来越被人喜欢。因 此，这个 520“ 网络情人节”，除传统的西洋情人节 2 ⽉ 14 日 、中国传统正月十五元宵情人节、七月初七七夕 情人节之后，又为人们增添了一个情人节可过了。毕竟，在这个人类情感丰富的人间，有多一个节日过也 好，那也是好事吧。\n520 当天是结婚登记和举办婚礼的大热的日子。无数的小情侣们希望他们爱情的纪念册，上面可以永远 镌刻着这个特别的日子 ，以此来铭记他们想要和对方终身相爱的决心。\n\n小满期间的天气渐渐炎热，雨水增多。南方暖湿气流活跃，与从北方南下的 冷空气在华南一带交汇， 华南地区往往会出现大范围降水，天气慢慢变得闷热潮湿，而在北方，西风带在东北和华北形成温带气旋， 也让北方的雨量开始有所增加，同时,北方的高温天气也开始逐渐增多，与南方的温差进一步缩小 。在二十  四节气中，小满被称为“最有智慧”的节气, 因为古人认为月满则亏,物极必反,所以不倡“大满” ，只要“小满” 。 在北方 ，小满是指谷物开始饱满 ，但是还没有成熟 ，所以有“小满小满 ，麦粒渐满”的说法 。在南方 ，“满” 则被用来形容雨水充沛，所以人们常说“小满江河满”。\n上一篇关于 5 ⽉ 20 日的婚礼台词，有时会与小满节气重合，所以可以根据自己的喜好，新人定婚期的 初衷，来决定用哪篇更适合当天的婚礼。小满节气一般力每年公历 5 ⽉ 20-22 号，节气时长 15 天，在此期 间，都可以使用小满的婚礼文案。扩大本篇台词的可用范围。", "tags": ["台词", "开场", "祝福", "节日节气", "通用婚礼开场词"]}, {"id": "l_121ed133e2", "cat": "节日节气", "title": "31 小满节气通用婚礼开场词", "body": "(公历 5 ⽉ 20-22 ⽇)\n\n各位好，欢迎大家在这个暖风十里百花，江河日渐盈满的小满时节，来参加  今天的这一场婚礼。小满是夏季的第二个节气，暖却并不炙热，麦穗也并未饱和， 它为那些在夏天里成熟的谷物拉开了收获的前奏，预示着一切向好， 欣欣向荣， 未来可期。\n婚礼遇小满，似乎更显恰逢其时，预示幸福未到极致，他们尚有动力在漫漫 婚姻中去追逐更多的幸福。也预示着人生未到巅峰，他们还要夫妻同心，互相帮 扶，才能取得更多更大和更好的成就。就说小明和小兰的爱情和他们一路走来的 经历，虽然两人并非天造地设的完美，但是朝着完美契合的方向去努力，才是他 们这段恋爱的意义。尽管他们还不是世界上最好的丈夫和妻子，但是那么漫长的 婚姻，其实就是让他们能够慢慢锻造，慢慢的打磨和慢慢的学习。\n有人说小满是一种智慧，不去过分的追求极致，只让一切都恰到好处，渐入  佳境。婚礼是生活的大团圆，也是人生的小圆满，因为岁月的路还有很长，我们  必须要拥抱更多的希望，要给梦想多留空白 ，更多书写的空间，还要给未来以更  多的期待。所以，我们追求的不是一个，人生大到极致的幸福，而是一个又一个， 小小的圆满。祝大家有梦有期待，祝他们有爱有未来。\n\n国际儿童节又称儿童节，定于每年的 6 ⽉ 1 日 。为了悼念利迪策惨案和全世界所有在战争中死难的儿 童，反对虐杀和毒害儿童，以及保障儿童权利。\n1949 年 11 月 ，国际民主妇女联合会在莫斯科举行理事会议，中国和其他国家的代表愤怒地揭露了帝国 主义分子和各国反动派残杀 、毒害儿童的罪行 。会议决定以每年的 6 ⽉ 1 日为国际儿童节。它是为了保障 世界各国儿童的生存权 、保健权和受教育权，抚养权，为了改善儿童的生活，为了反对虐杀儿童和毒害儿 童而设立的节日 。世界上许多国家都将 6 ⽉ 1 日定为儿童的节日 。\n这段台词有一点长 ，所以并不会建议把它当做是全部的开场。可以选择其中的 1 到 2 自然段，其他的 内容可以根据新人提供的信息进行填充。其他的台可没有应用到开场的，也可以放在如新人入场后，或者 誓言部分等等。", "tags": ["入场", "台词", "开场", "节日节气", "誓言"]}, {"id": "l_e4b96a8b18", "cat": "节日节气", "title": "32 儿童节通用婚礼开场词", "body": "(公历 6 ⽉ 1 ⽇)\n大家好，首先要祝我们现场的各位大朋友和小朋友们，儿童节快乐，也许有 人会想，我们已经告别这个节日很久了。怎么还要祝我节日快乐?其实，快乐与 年龄无关，只要内心中还有清澈和纯净，没有完全的丢掉曾经的天真与无邪，不 管年龄多大，我们都可以在胸口中跳动着一颗未泯的童心，让自己活的像个孩子\n\n一样的快乐简单。\n小时候的小明和小兰也许也玩过家家，也扮演过新郎和新娘，模仿过爸爸和 妈妈。长大后的这一个特别的儿童节，他们不是在扮演了，而是把曾经游戏里面 的场景带到了现实的世界， 他们真正的成为一个新郎和新娘， 真正的有了属于 自己的家。当我们还是小孩子的时候对大人们的世界充满了想象和好奇，可是当 如今我们一不小心成为了大人 ，却发现成长的事，仅仅只是弹指一挥间。\n所以，儿童节快乐其实是说给大人听的，因为孩子们不需要祝福，他们每天  都是儿童节，每天都很快乐。只是我们这些过了期的小朋友，好像也把好多的快  乐留在那个过了期的年少时光，所以小明和小兰把自己婚礼的纪念日放在儿童节  的这一天。目的就是为了将来的生活里面时刻的提醒彼此，尽管生活，百般琐碎， 但别忘了，快乐万岁。\n小时候的儿童节，快乐的源泉也许只是一次公园，和一块糖果的甜，今天的 儿童节，快乐却来自于婚礼的浪漫和他们即将要约好生的誓言 。 各位来宾，鼓 掌的全都会快乐，祝福他们节日开心 ，婚姻美满。\n\n端午节是流行于中国以及汉字文化圈诸国的传统文化节日 ，传说战国时期的楚国诗人屈原在五月初五 跳汨罗江自尽，后人亦将端午节作为纪念屈原的节日;也有纪念伍子胥、曹娥及介子推等说法。端午节的起 源涵盖了古老星象文化 、人文哲学等方面内容，蕴含着深邃丰厚的文化内涵，在传承发展中杂糅了多种民 俗为一体，各地因地域文化不同而又存在着习俗内容或细节上的差异。\n尽管有人觉得端午节并不适合结婚，但其实每年在端午节期间结婚的新人也不再少数。因为资料显示 这个日子上古时代的由来是和天象有关。后来的传说中才加入了对于屈原等的纪念。如果婚礼逢端午，这 段台词很适合，可以拿来即用。", "tags": ["儿童节通用婚礼开场词", "台词", "开场", "新娘", "新郎", "来宾", "祝福", "节日节气", "誓言"]}, {"id": "l_c310bd5292", "cat": "节日节气", "title": "33 端午节通用婚礼开场词", "body": "(农历五月初五)\n尊敬的各位来宾，欢迎大家前来参加小明和小兰的婚礼。今天是端午小长假 的第二天，祝各位节日安康，阖家团圆。端午节，是中华文明的四大传统节日之 一 ， 它起源于古人对天象的崇拜，要在这一天祈福辟邪。后来的历史传说中又 加入对爱国诗人屈原的纪念，因此融合进了许多的人文情感。\n小明和小兰他们觉得这一天好多的元素都像是在为他们的婚礼送上祝福。比\n\n如说，家家户户门上挂着散发清香的艾叶，仿佛象征着他们的爱情也翻开了全新  的一页。大街小巷里面挂满的葫芦，预示着他们会早生贵子 ，多子多福。男女老  少手腕上系着的红线，代表月老牵线的好姻缘，有的系着五彩绳，是在期盼他们  未来的生活能多姿多彩。端午节吃粽子，无论是南方肉粽的咸还是北方蜜棕的甜， 一层一层粽叶的包裹，像拥抱，像团聚，像圆满，又像是他们的婚后的日子，扎  扎实实，不愁吃穿。\n端午在古时叫端阳，意味着一年的盛夏就此到来。结婚在古时叫成亲，他们 将要成为亲人，一辈子不离不弃的陪伴。愿他们在岁月的海浪中，无惧人生变化 多端，踏浪前行迎风起舞，顺顺利利平平安安。幸福吉祥快乐健康。用这首藏尾 诗，祝大家，端午安康。", "tags": ["开场", "来宾", "祝福", "端午节通用婚礼开场词", "节日节气"]}, {"id": "l_a2e502c600", "cat": "节日节气", "title": "34 芒种节气通用婚礼开场词", "body": "(公历 6 ⽉ 5-7 ⽇) 各位，欢迎大家来走进今天的婚礼。\n来到这间宴会厅，听到的最多句问候， 最近怎么样，忙不忙?怎么会不忙呢? 肩上的重担，生活的压力，让人们怎敢轻易的停下匆匆忙忙的脚步。于是，我们 变得有一点茫然，究竟了为了什么，要整天像个陀螺一样的忙来忙去。但我们听 到孩子们的欢笑声，我们看到爱人脸上幸福的笑意，我们欣慰着父母老有所依， 这些温暖的画面把忙乱的忙和茫然的茫，都变成了光芒的芒。今天是 24个节气 中的芒种，小明和小兰也在忙着收获他们爱情的果实，忙着种下婚姻的种子。\n芒种时节，麦芒见长，北方才刚刚人夏，南方已青梅泛黄。梅雨将至，浸润着大地，滥溉着江河，滋养 着麦苗，一派蓬勃生机。一幅欣欣向荣的景象。勤劳的人们开始为了秋天的收成而忙于劳作，今天这对新 婚的小两口 ，从这个时节起，也将会投身于他们未来的平平淡淡，却又忙碌的小生活。愿他们的忙，不是 忙乱，不是茫然，而是在彼此的共同的努力和相互的成就下，越来越好，步登高 ，在这个芒种时节开始的 梦想，星芒璀璨，光芒万丈。\n芒种,是二十四节气之第九个节气 ，夏季的第三个节气 ，干支历午月的起始。斗指巳 ，于每年公历 6 ⽉  5-7 日交节。“芒种”含义是“有芒之谷类作物可种，过此即失效” 。这个时节气温显著升高 、雨量充沛、空气 湿度大 ，适宜晚稻等谷类作物种植。农事耕种以“芒种”这节气为界，过此之后种植成活率就越来越低。 它 是古代农耕文化对于节令的反映。民谚 “芒种不种，再种无用”讲的就是这个道理。芒种是一个耕种忙碌的 节气 ，民间也称其为“忙种” 。这个时节，正是南方种稻与北方收麦之时。\n芒种繁忙，一派盛夏的火热景象。本篇台词借用了芒种的“芒”的谐音 ，而衍生出很多对生活忙乱的感 慨，及对他们未来前途光芒的祝愿。\n\n普通高等学校招生全国统一考试， 简称“高考”，是中华人民共和国大陆地区合格的高中毕业生或具有\n同等学力的考生参加的选拔性考试。\n\n普通高等学校根据考生成绩，按已确定的招生计划，德、智、体全面街量， 择优录取。高考由教育部\n统一调度， 教育部考试中心或实行自主命题的省级教育考试院命制试题。\n\n考试日期为每年 6 ⽉ 7 日 、8 ⽇(部分地区含 6 ⽉ 9 ⽇) ，各省市考试科目之称与全国统考科目名称相同 的必须与全国统考时间安排一致。\n\n如果新人的新婚日期与高考重合，这一段通用版开场词便可适用 。 而日期长可以根据婚礼进行更改， 如今天是 6 ⽉ 8 号，高考的第二天。或者今天是 6 ⽉ 5 日明天就是高考的第一天了。 高考是一个关注度极 高的公众事件，所以高考的话题也一定会引发相对较多的共鸣。尤其是将高考与婚姻联系在一起，如高考 是一个人单枪匹马的技荆斩棘，婚姻是两个人甘苦与共的迎风接雨 ，相信会让人觉得有理有据，会收获新 人 ，家人 ，及来宾的肯定。", "tags": ["台词", "开场", "来宾", "父母", "节日节气"]}, {"id": "l_dde854274e", "cat": "节日节气", "title": "35 高考期间通用婚礼开场词", "body": "(公历 6 ⽉ 7-9 ⽇)\n大家好，欢迎各位来参加婚礼。今天是 6 ⽉ 7 号，高考的第一天，莘莘学子  十年寒窗，即将揭晓的不止是试卷和分数，还要为青春里的坚持，书写一份答案。 今天也是小明和小兰结婚的日子，相爱三年，有情人终成眷属，即将开始的不止  是生活的柴米油盐，还有他们为漫漫余生共赴的旅行而准备的行囊，里面装满了  期待。\n若要把恋爱当做是婚姻开始前的一次考试，那相遇之前的成长，就是他们各 自学习的过程。两个人在不同的人生课堂，慢慢积累着习惯，塑造着不同的价值 观，学习着独立和坚强，感受着爱和被爱。当成熟遇见了恰到好处的温柔，就如 同铅笔遇见了试卷。他们虽不是为彼此而生，但却搭配的天衣无缝，一个提出的 问题，另一个书写着完美的答案。\n不管是结婚还是高考，都是命运的转折，高考是一个人单枪匹马的披荆斩棘， 婚姻是两个人甘苦与共的迎风接雨。高考决定一个人的前程，婚姻则改变两个人  的人生。不管过去的成绩有多好，未来都要继续刻苦与努力。如同不管曾经他们  的恋爱有多甜，结婚后两个人都需要用心的呵护认真的经营，才能让婚姻，历久  弥新。各位，掌声送给他们即将开始的，婚姻的大学吧!", "tags": ["开场", "节日节气"]}, {"id": "l_2a5e3415bb", "cat": "节日节气", "title": "36 父亲节通用婚礼开场词", "body": "(公历 6 月第三个周日) 大家好，欢迎各位来参加婚礼。\n今天是 6 ⽉ 18 号星期天。原本一个极其普通平常的周末，因为赋予了对于 爸爸的感恩和爱，从而把这个日子变得暖心又温热。父亲节快乐是我们今天说的 最多的话，但是却少见大街小巷飘香的鲜花，甚至都没有准备特别的礼物给到他 们。不过爸爸并不在意这些，他只希望自己的孩子健康快乐，尤其今天的两位父 亲，节日里的他们感受到更多的不是自己过节，他们今天的幸福，是看到他们深 爱的孩子 ，终于不负他的期待，拥有了属于自己的家。\n婚礼和父亲节，似乎是两种完全不同的氛围。一边是鞭炮喧天，热热闹闹， 一边是无声内敛，静静悄悄。正如婚礼和婚姻其实也是完全不同的两种感觉。当 今天婚礼的繁华落尽，归于平静，开始的生活就是平淡如水 ， 日复一年。就像爸 爸的那种润物细无声的爱，虽然淡淡的，却藏不住一个男人从不爱表露的深情款 款。\n今天的婚礼只是属于小明和小兰，但是今天的节日却属于每一个人。也许你 暂时还不是一个爸爸，但是你一定因为拥有一个爸才能来到这个世界。爸爸陪我 们长大，给我们保护，带给我们那么多的安全感。愿这份厚重如山的父爱，能被 我们记在心底，传承下去。愿在父亲节开始的婚姻，也如同父爱的那份深情，无 需灿烂热烈，却永不褪色 ，历久弥坚。\n父亲节最广泛的日期是每年 6 月的第三个星期日 。父亲节起源于二十世纪初的美国，是由布鲁斯.多德 夫人提议发起的，当地州政府采纳了这一建议并将节日 日期定为 6 月第三个星期日 。我国官方没有设立正 式父亲节，但大多将 6 月第三个星期日作为父亲节。\n婚礼遇父亲节特别常见 ，因为这是一个周末的节日 。我也经常会收到新人希望突出一下婚礼和节日的 属性的要求，希望在自己的婚礼上表达一份对父亲，不易启齿的爱和感谢。\n\n夏至，是二十四节气的第 10 个节气。于公历 6 ⽉ 21~22 日交节。夏至这天， 太阳直射地面的位置到达 一年的最北端， 几乎直射北回归线，此时，北半球各地的白昼时间达到全年最长。对于北回归线及其以北 的地区来说，夏至也是一年中正午大阳高度最高的一天。 气温高 、湿度大、不时出现雷阵雨 ，是夏至后的 天气特点。夏至在中夏之位，即午位，午属阳;夏至虽然阳气较盛，且白昼最长 ，但却未必是一年中最热的 一天，因此时接近地表的热量仍在积蓄，并没有达到最多的时候。\n\n本段台词的第三自然段仅限于夏至当天的婚礼，其他的自然段则可以用在整个夏至的节气过程中。", "tags": ["台词", "开场", "父亲节通用婚礼开场词", "节日节气"]}, {"id": "l_c3506f1e3c", "cat": "节日节气", "title": "37 夏至节气通用婚礼开场词", "body": "(公历 6 ⽉ 21-23 ⽇)    各位来宾，欢迎光临今天这一场幸福的婚礼。\n岁月如风，轻轻浅浅的吹过后，与我们渐行渐远。时光如歌谣，悠扬的传唱， 又不紧不慢的打着节拍。那些我们曾经期盼的未来，转眼已成回忆的昨日 ，记得  春天才刚刚飞走 ，夏至就已来到眼前。记得有人讲，夏花生于夏，幸福源于家。 夏至到来之际，感谢大家来见证一个崭新的小家，载着我们的祝福，载着父母的  心愿，载着他们的期待，向着心中幸福的方向出发。\n夏至并非是终止，而是夏天已到了极致。热浪难耐的酷暑即将要光顾我们的  生活了。也把小明和小兰对彼此的这份爱，照的更加的热烈。夏至这一天，夜晚  最短，似乎也象征他们婚姻的旅程，情长纸短。夏至这一天，白天最长，仿佛也  预示他们的婚姻，地久天长。虽然昼夜的长短，总是随着太阳的远近而无法固定， 但是我们相信他们之间的这份永远相爱，一生相伴的誓言 ，定会像恒星一般，永  不改变。\n这份小爱情历经了x 年时光的打磨，就像一棵小树在烈日寒风中坚定的成长， 通过了重重的磨砺和考验，变得挺拔而茂密参天。在夏至时令的季节绽放希望。  这是一个多好的时间，世界的光亮因夏至而长久，婚姻的温暖，因他们的相爱而   不朽。 相信他们定会扛得住夏日的热浪，守得住一份幸福理想，让婚姻的生活   过的鲜活而敞亮。愿我们和他们一起，在夏至的明媚里，与所有的美好，撞个满   怀。希望各位的掌声比夏至的热浪更热烈，有请新郎，热情登场。\n\n中国共产党于 1921 年 7 ⽉ 23 日成立后，在反动军阀政府的残暴统治之下，只能处于秘密状态，没有公 开进行活动的环境。在大革命时期，党忙于国共合作 、开展工农运动和支援北伐战争，没有条件对党的诞 生进行纪念。把 7 ⽉ 1 日作为中国共产党的诞展纪念日 ，是毛泽东同志于 1938 年 5 月提出来的。当时，毛 泽东在《论持久战》一文中提出:“今年七月一日 ，是中国共产党建立的十七周 年纪念日 ”。这是中央领导同 志第一次明确提出“七一 ”  是党的诞生纪念日 。\n7 ⽉ 1 号的婚礼台词，从建党，香港回归，引申出整个日子的特别，然后又 加入婚礼的元素， 以及两\n\n位新人小家诞生的纪念。还有 7 ⽉ 1 号开始了一年的下半场， 而结婚，也意味着两个有爱人的， 开始了\n人生另外一个重要的诗篇。", "tags": ["台词", "开场", "新郎", "来宾", "父母", "祝福", "节日节气", "誓言"]}, {"id": "l_b470c8ba3c", "cat": "节日节气", "title": "38 七一通用婚礼开场词(公历 7 ⽉ 1 ⽇)", "body": "各位好，欢迎大家来参加婚礼。\n对于我们这一颗美丽的蓝色星球来说， 每天，都只不过是一次普通的日升 月落。可是对于不同的国家，不同的历史文化的角度来讲，有一些日子 ， 会因 为一些不平凡的故事的发生 ，使它变得与众不同。就像在现代中国人的心里 ，7 ⽉ 1 号，就显得伟大而神圣。\n1921 年 7 ⽉ 1 号，诞生了伟大的中国共产党，带领着伟大的中国人民开创了 一番伟大的事业。 1997 年 7 ⽉ 1 号，在神圣的国歌声中，神圣的国土香港回归 了神圣的祖国母亲的怀抱。而今天 202X年 7 ⽉ 1 号，这个伟大神圣的日子又多 了一份喜乐和温暖，我们在这里见证一个小家庭的成立 ， 他们的身份，他们的 关系，和他们的爱，从这个日子起，又上了一个新的台阶。其实 7 ⽉ 1 号不仅从 历史的角度看是一个纪念日 ，从时间的维度来讲，它也象征着这一年的下半场已 经缓缓的拉开了帷幕。不管上半年我们有多少的遗憾或是不完美的经历，都希望 是给下半年的收获与惊喜做的铺垫。\n7 ⽉ 1 号，一个全新的小家，一对充满了期待的小两口也要开创他们幸福但 又平淡的婚姻事业 。我们对他们充满了信心. 因为这个日子诞生的中国共产党， 取得了如此伟大的成功， 这个日子成立的家庭，也一定会拥有更 多的支持和认 可，更多的肯定和希望。祝福党的生日快乐，祝福他们幸福快乐。祝愿今天的婚 礼，大家都快乐。这份掌声，送给我们共同的快乐。\n\n小暑，是二十四节气之第十一个节气 ，于每年公历 7 ⽉ 6-8 日交节。暑，是炎热的意思，小暑为小热， 还不十分热。小暑虽不是一年中最炎热的时节，但紧接着就是一年中最热的节气大暑，民间有“小暑大暑， 上蒸下煮”之说。中国多地自小暑起进入雷暴最多的时节。\n小暑开始进入伏天，所谓“热在三伏” ，三伏天通常出现在小暑与处暑之间，是一年中气温最高且又潮 湿 、闷热的时段。季风气候是中国气候的主要特点，夏季受来自海洋暖湿气流的影响，中国多地高温潮湿 多雨 。小暑这个时节虽然阳光猛烈、高温潮湿多雨 ，但对于农作物来讲，雨热同期有利于成长。\n在南方的很多地方 7 月开始逐渐进入婚礼淡季，因为天气过于炎热，或个别地区对阴历的月份有结婚\n\n的禁忌。而北方大多数地方 ，比如我的家乡 7 月就是婚礼的高峰期，这一段适用于小暑节气的婚礼， 如果 刚好赶上节气的时令可直接套用 ，或者在节气以内都可以简单修改后套用 。全国各地都已经到了暑热的阶 段，所以这篇台词，加入了很多夏天的的元素，也可以通用很多举办在夏天的婚礼。", "tags": ["七一通用婚礼开场词", "公历", "台词", "开场", "故事", "祝福", "节日节气"]}, {"id": "l_f6f45db70c", "cat": "节日节气", "title": "39 小暑节气通用婚礼开场词", "body": "(公历 7 ⽉ 6-8 ⽇)\n各位好，欢迎大家来参加小明和小兰的婚礼，见证他们这份炙热的爱情。\n当然，这样的季节，炙热的哪会只有爱情，还有天气。二十四个节气中我们 迎来了这一个，小暑。书上说，小暑是盛夏季节的开端。万物渐盛，暑气蒸腾。 躲在树梢里的蝉儿开始深情的演奏着悠扬又盛大的交响曲，午后的长椅，在墙角 的影子中惬意的等待着不经意溜过的穿堂风。冰镇的西瓜，爽口的凉茶，挂着霜 珠的啤酒，不停歌唱的青蛙。这些专属于夏日里的美好，今天在小明和小兰的眼 中都变得不值一提。因为这些每年的夏天都会出现，可是结婚的日子，是他们所 有过往经历过的时光里面 ，最美好的一天。\n虽然说小暑还没有到夏天最热的时段，可是空气中的热浪会变得一天比一天  更强烈一点。 就好比结婚成家的小明和小兰，二十儿岁的他们，其实还没有到  一个人最成熟的年龄，可是这一缕萦绕生活的人间烟火，会让他们一天比天更加  理解什么才是心中有责任，肩上有承担。 小暑天的热度点都不会小 ，小两口的  美满和琐碎也同样一点都不会少。 既然鸡毛葫皮和明晴冷暖都是让人避无可避。 那就让我们努力的让家，因为有我们和爱，寒冬有温度，酷暑有清风长路两相伴， 欢笑满归途。", "tags": ["开场", "节日节气"]}, {"id": "l_9d633ba5ed", "cat": "节日节气", "title": "40 大暑节气通用婚礼开场词", "body": "(公历 7 ⽉ 22-24 ⽇) 各位好，欢迎大家来参加婚礼。\n这场婚礼的关键词，我只想到一个字，热!大暑的节气的阳光很热烈 。这场 阳光下的婚礼很热闹。来参加和见证婚礼的亲友很热情。因此这样热的时间里开 始小明小兰婚姻的新生活，我们有充分的理由相信，小两口的日子一定会过得热 火朝天。\n今天的他们心里也一定很热，除了七月翻滚着火一样的盛夏，还有这段历经 X 年的滚烫的爱情。初见那一刻眼中的火苗点燃了彼此心里相爱的火种，如今已\n\n经熊熊燃烧成了一团不熄的火焰。幸福不是突如其来，而是在那些平凡又平淡的 日子里，在漫长又琐碎的时光中，他们用包容和理解不停地添柴加薪，守护着持 续升温的爱，所以越是炙热的考验，越能彰显他们感情的热烈。\n大暑时节，热之极盛，骄阳似火 ，照亮光年。太阳风的拥抱让北半球像着了 火一样，今天他们站在这里 ，终成眷属的这个拥抱，定会让每个爱他们的家人， 和他们一起，热泪盈眶。一年最热的夏天，留住了他们幸福相爱的纪念。这个夏 天，滚更的不是星河，而是他们的百年好合，这个夏天，美好的不是人问理想， 面是全世界都在祝他们，新婚快乐。\n\n大暑，是二十四节气中的第十二个节气 ，也是夏季最后一个节气 。于公历 7 ⽉ 22 ⽇ - 24 日交节。“暑” 是炎热的意思，大暑，指炎热之极。大暑相对小暑， 更加炎热,是一年中阳光最猛烈、 最炎热的节气，“湿  热交蒸”在此时到达顶点。大暑气候特征:高温酷热、雷暴、台风频繁。\n大暑节气正值“三伏天”里的“中伏”前后，是一年中最热的时段。大暑时节阳光猛烈、高温潮湿多雨，虽 不免有湿热难熬之苦，却十分有利于农作物成长 ，农作物在此期间成长最快。\n这段词可以在大暑节气的任意一天来使用 。 也可以稍事修改后应用于酷暑盛夏的婚礼。\n\n八一建军节是中国人民解放军建军纪念日 ，定为每年的八月一日 ，由中国人民革命军事委员会设立， 为纪念中国工农红军成立的节日 。\n1933 年 7 ⽉ 11 日 ，中华苏维埃共和国临时中央政府根据中央革命军事委员会 6 ⽉ 30 日的建议，决定  8 ⽉ 1 日为中国工农红军成立纪念日 。 1949 年 6 ⽉ 15 日 ，中国人民革命军事委员会发布命令，以“⼋⼀ ”两 字作为中国人民解放军军旗和军徽的主要标志。中华人民共和国成立后，将此纪念日改称为中国人民解放 军建军节。\n根据《中华人民共和国军人地位和权益保障法》，每年 8 ⽉ 1 日为中国人民解放军建军节。各级人民 政府和军队单位应当在建军节组织开展庆祝、纪念等活动。\n这一场婚礼词可以用于 8 ⽉ 1 日结婚的新人是军人身份的婚礼。如果新人身份与军人无关，则这一段 词对于婚礼来说并没有太大的意义。如果新人两人都是军人 ，可以在第一自然段中更改。如:它的特别之处 在于，今天的(男/⼥/两位)主角 ，就(都)是光荣的人民解放军。这-场婚礼预示着未来的每年八月一日 ，将不 仅是他(们)的节日 ，也要成为他(们)婚姻中最重要的纪念日 。本篇台词的后两个自然还可以适用其他非 8 ⽉ 1 号结婚的军婚新人。", "tags": ["台词", "开场", "节日节气", "证婚"]}, {"id": "l_4e18d3421b", "cat": "节日节气", "title": "41 八一建军节通用婚礼开场词", "body": "(公历 8 ⽉ 1 ⽇)\n尊敬的各位来宾，女士们先生们大家中午好，今天是八月一日建军节，首先 要向所有的军人 ，军属，和曾经有过峥嵘岁月的战友们送上一份节日的问候，建 军节快乐。欢迎大家来参加今天这场特别的婚礼。它的特别之处在于，今天的主 角 ， 就是光荣的人民解放军。这一场婚礼预示着未来的每年八月一日 ，将不仅 是他的节日 ，也要成为他婚姻中最重要的纪念日 。\n军人的使命让他们将自己的宝贵青春和一腔孤勇全部都倾注于保家卫国的 神圣事业上，而军人的工作让他们无法像其他的小情侣们那样整日的陪伴于对方 的身旁，军人身上的荣光让他们从不后悔自己对事业和爱情的选择，军人的职责 让他们把自己的家庭和家人都放在了身后。却将祖国和人民的平安放在胸前，都 扛在肩上。\n我们总是喜欢用神圣来形容军婚，可他们都知道，神圣的是军人这个职业和  身份。他们也只是一对普通的恋人，想要陪伴，也会常常想念，偶尔还会斗斗气， 也渴望能有些小浪漫。可是小兰知道，既然选择了军人，就是要学会在生活里独  立和 勇敢，祖国需要他，她就在心里放飞一份牵挂。 不管他去的地方有多远， 任务会不会有危险，她都会点亮家里的一盏灯，告诉爱人家里永远有人等，永远  为凯旋的英雄，照亮回家的旅程。 各位，让我们响起一份热烈的掌声， 送给他  们，和那些最可爱的人吧!\n\n七夕节，又称七巧节、七姐节、女儿节、乞巧节、七娘会、七夕祭、 牛公牛婆日 、巧夕等,是中国民间  的传统节日 。七夕节由星宿崇拜演化而来,为传统意义上的七姐诞，因拜祭“七姐”活动在七月七晚上举行 ， 故名“七夕” 。拜七姐，祈福许愿、乞求巧艺坐看牵牛织女星、祈祷姻缘、储七夕水等，是七夕的传统习俗。 经历史发展，七夕被赋予了“牛郎织女”的美丽爱情传说，使其成为了象征爱情的节日 ，从而被认为是中国  最具浪漫色彩的传统节日 ，在当代更是产生了“中国情人节”的文化含义。\n关于七夕节是否适合结婚各有不同定论，有人觉得牛郎织女的爱情因为受到了阻力 ，不很美满，而且 每年仅能见一次面 ，似乎情路过于坎坷，并不是一幕皆大欢喜的剧情，所以不喜欢在这个日子来举办他们 圆圆满满的婚礼。还有人觉得牛郎织女的爱情代表着一份忠贞不渝,想借着他们团圆的日子,也沾染他们刻骨 铭心的爱。如果新人决定在七夕这一天来结婚，做为主持人 ，有责任和义务去帮助新人向各位宾客来介绍 和解释他们选择这个日子的初心 。所以这一段词，完美契合七夕的婚礼初六和初八 ，也可以微调使用。", "tags": ["开场", "来宾", "节日节气"]}, {"id": "l_f9c383bc2e", "cat": "节日节气", "title": "42 七夕节通用婚礼开场词", "body": "(农历七月初七)\n尊敬的各位来宾，女士们先生们，大家中午好。感谢大家前来参加小明和小 兰的婚礼。\n每到农历的七月 ，一定会有一个属于中国人的浪漫节日 ，就是七夕节。在古  老的神话传说中，牛郎和织女因为触犯了天条而被隔在银河的两端，仅仅会在每  年的七月初七，团聚于喜鹊搭成的桥上，互诉衷肠，互道想念。虽然这并不是一  个完美而无憾的故事，但无数的现代人却沉醉于他们之间的那份痴心和深情，向  往他们对彼此的忠贞不渝，于是每年的七月初七，就变成了中国人的浪漫情人节。\n小明和小兰的故事不同于牛郎织女，他们没有受到惩罚，反而是得到了老天 的成全和眷顾。在人潮如海的世界遇见了同步又合拍的另一半。\n之所以他们把婚礼选在七夕节(的期间) ，他们说第一是 因为喜欢这个季节， 一派盛夏的景象， 既有灿烂又有热烈，隐隐之中似乎还在酝酿着成熟和丰收的  喜悦。还有是因为他们喜欢牛郎织女的故事，喜欢他们不畏压力，为爱坚守的态  度。而我猜，一定还有这样一个原因，他们想把婚礼安排在属于中国人自己的情  人节，让这个节日 ，为他们开始的婚姻，增加些许的浪漫和幸福感。希望他们此 刻开始的婚礼，会拥有一个完美的开端。那就让我们各位掌声热烈一点吧。\n\n二十四节气有“三暑”，即小暑、大暑、处暑，按顺序分别为初暑、中暑、末暑。“三暑”中间还夹一个“⽴  秋”节气 ，立秋之后才是处暑(末暑) ，“三暑”与“三伏”均代表高温酷热天气 ，二十四节气中的暑天比较长 。 暑天长对于农作物长势和产量有利，作物要有足够的生长时间和热量，如果暑热时间短，作物生长时间和  热量都不充足，长势和产量会受影响。二十四节气是古代农耕文明的产物，它是农耕文化对于节令的反映。\n立秋标志着孟秋时节正式开始，它是仅次于大暑 、小暑的第三热节气 ，立秋之后天气还是很热，中医 将立秋至秋分前这时段称之为“长夏” 。立秋后，在自然界中，阴阳之气开始转变，万物随阳气下沉从而开 始从繁茂生长趋向成熟。在中国古代农业社会，立秋具有重要的意义，民间在立秋祭祀土地，庆祝丰收。 这篇台词可用在立秋节气的当天，也可以简单修改后用在整个立秋的节气过程里面。", "tags": ["七夕节通用婚礼开场词", "台词", "开场", "故事", "来宾", "节日节气"]}, {"id": "l_a0b35f551a", "cat": "节日节气", "title": "43 立秋节气通用婚礼开场词", "body": "(公历 8 ⽉ 7-8 ⽇)\n各位来宾，欢迎大家来参加这一场婚礼。一年中总是有很多特殊的日子，为  这些看不见的时光和季节打上标签，比如今天。日历上写着 8 ⽉ 7 号，貌似平凡。 但这一天是农历节气的立秋，尽管拥抱我们的依旧是夏日里无处躲藏的酷热，可  一场秋天里的风 ，此刻正轻轻晃动着西伯利亚的冷杉树上，挂满了针叶的枝干 。 正轻轻的拂过贝加尔湖的湖面 ，正闲庭信步的向我们赶来。\n各位有没有想过 8 月有什么特别，8 月 ，跨过了夏秋两个季节。比如小明和 小兰在爱情中经历的阶段，8 月的夏天，是他们恋爱的热情浓烈，即将开始更长 的秋天，则代表他们成熟的沉静和内敛。立秋不是意味着天气会马上就变凉，同 样结婚也并不会证明他们立刻会像一对老夫妻一样。 日子总是要一天一天的过， 婚姻也需要一点一点的打磨和成长 。只不过，立秋吹响的是收获的号角 ，结婚， 拉开的是他们相伴到老的篇章。\n如果你喜欢炎热，立秋之后，还有一个伏天要过，如果你喜欢清凉，立秋之 后，每一天都是值得期待的好时光。如果你喜欢故事，小明和小兰会用他们的亲 身经历来跟你分享，如果你喜欢浪漫，今天的这一场婚礼， 今天这里的一切， 一定会满足你对浪漫所有美好的想象。各位，他们此刻非常想要听到，我们的祝 福，在这个美好的秋天，为他们鼓鼓掌吧。\n\n2017 年 11 ⽉ 3 日 ，国务院通过了卫计委(今卫健委)关于“设立中国医师节\"的申请，同意自 2018 年起， 将每年的 8 ⽉ 19 日设立为“中国医师节” 。中国医师节是经国务院同意设立的卫生与健康工作者的节日 ，\n\n2021 年 8 ⽉ 20 日举行的十三届全国人大常委会第三十次会议表决通过《中华人民共和国医师法》,其中 明确规定每年 8 ⽉ 19 日为中国医师节。(来自百度百科)如在婚礼当中的新人职业是医生 ，中国医师节整段 开场词便可应用于其婚礼。医生以外的其他职业不适用于本段开场词。", "tags": ["开场", "故事", "来宾", "节日节气"]}, {"id": "l_bbf808fce3", "cat": "节日节气", "title": "44 中国医师节通用婚礼开场词", "body": "(公历 8 ⽉ 19 ⽇)\n尊敬的各位来宾，女士们先生们大家中午好，今天是小明和小兰结婚的日子， 所以首先我们要祝他们新婚快乐。同时今天还是一个很特别的节日 ，只是这个节\n\n日只属于我们中国人自己 ，而且它还很年轻 ，从 2017 年才刚刚设立 。 目的是为 了肯定，感谢和致敬那一群，在高尚的工作岗位上为人们的生命和健康，兢兢业 业保驾护航的人 ，他们是光荣的中国医生 。在中国医师 节的这个日子 ，祝福每 一名医务工作者们，节日快乐。\n我们今天的新郎小明就是一名医生 ， 这份职业让这个普通的年轻人变得很 特殊，这份使命和仁心 ，让这个平凡的工作变得伟大而神圣。只是越重任在肩， 越容易会对家庭和爱的人有亏欠。工作性质很特殊，所以他们恋爱的过程，没有 那么多假期，那么多时间，也没那么多浪漫。但好在小兰却有很多对他的支持和 理解。虽然爱人缺席了很多陪伴自己的时光，但却为更多的人，带去了健康和新 生的希望。\n每一个医生都是上帝遗漏在人间的天使，小病小灾时，他们护佑着病患的健 康，大疫肆虐时， 他们治愈了这个世界， 那一身白衣 ， 薄如蝉翼，当病魔蜂 拥而至 ，这就是勇土们的铠甲。\n和平的年代，有他们的呵护守候，让我们得以安心的与这世间的美好，环环 相扣。各位，让我们一起致敬中国医生 ，祝福他们幸福一生。\n\n处暑，是二十四节气之第十四个节气，也是秋季的第二个节气，于每年公历 8 ⽉ 22-24 日交节。时至处 暑，已到了高温酷热天气\"三暑\"之\"末暑\" ，意味着酷热难熬的天气到了尾声。中国民间有一句谚语“立秋不 是秋,秋在处暑后” ，这是民众对处暑前后气象变化的总结。\n之前后退的副热带高压随着处暑的到来再度回归，这时会出现秋老虎天气 ，这段时间会连日晴朗， 日 照也会很强烈，虽然已经进入秋季，但是天气仍然是问热的。此时节\n白天热，早晚凉，昼夜温差较大,不时有秋雨降临。可谓是“一场秋雨一场寒\" 。应用于处暑节气的婚礼 通用开场词。也可用在整个处暑时节。", "tags": ["开场", "新郎", "来宾", "祝福", "节日节气"]}, {"id": "l_cfd89a75ed", "cat": "节日节气", "title": "45 处暑节气通用婚礼开场词", "body": "(公历 8 ⽉ 22- -24 ⽇)\n今天是 8 ⽉ 23 号，一个普通的星期 x,雨后清凉的初秋(或阳光依旧不减热度)， 也刚好是农历二十四个节气的处暑。意味着我们正深情的告别炎夏，正温柔的拥  抱秋天。季节改了名字，但是风景却依然如故。三伏数到了尾声，但人间的美好  和幸福，却依旧数不胜数。\n\n老人们讲，处暑的节气刚好是秋老虎当家，但是我们的小明却并不关心这个， 他关心的是从这个处暑开始，将会有一只母老虎当家，这只老虎有时候很可爱， 有时候很奇怪，时而温顺的像只大猫，时而厉害的像要把他吃掉。但却让他喜欢  的无以复加，甚至有点神魂颠倒。从相识到现在已经在一起 X 年了，似乎让他越  来越爱，也越来越怕，但小明又不肯承认这是怕，他说别看我对老婆言听计从， 我这叫尊重。不是我不敢和老婆顶嘴，因为我有男人的胸怀，不跟女人见识，所  以，我这是让着她。\n没错，一段合适的恋爱是会让男人变得日渐成熟，而成熟的表现，就是他会 给自己的爱人更多宠溺包容，忍让和体贴。就像此刻处暑的节气，天空变得更高 更蓝，云也变轻变淡，好像在用它的深邃和宽广拥抱这个地球的每个人。北下的 风让这个秋天不再火热，却拥有了一团恰到好处的温暖。处暑至 ，宜嫁要，宜成 家，宜相爱。更适宜我们为他们送出祝福与陪件、各位，掌声为他们响起吧。\n\n财神节，中国传统节日 ，农历七月廿二 ，是财帛星君李诡祖和天财星君柴荣的祭祀纪念日 。中国的民 间习俗是正月初五拜财神，七月廿二祭祀财神生日 ，又叫财神节。该习俗遍及整个中国大陆，港澳台，南 亚国家及华人聚居之地。财神节这天，所有的经商业户，都要大宴宾朋，感谢财神的到来，感谢亲戚朋友 的大力支持。\n财神节为每年的农历七月二十二 ，每年的这一天，我的家乡会从早到晚络绎不停的响着鞭炮声。一些 城市由于禁燃令的因素，财神节的庆祝活动也许会改为其他。但是庆祝财神生日 ，是每一个中国人喜闻乐 见的活动，体现出了人们对追求财富，幸福生活的美好心愿。如婚礼的日期恰逢财神节，这一段词既符合 节日的主题，又能表达出新人的心意。", "tags": ["开场", "祝福", "节日节气"]}, {"id": "l_5cc8a1125e", "cat": "节日节气", "title": "46 财神节通用婚礼开场词", "body": "(农历七月二十二)\n\n各位好，欢迎大家来参加婚礼，祝各位节日快乐。是不是会有人觉得奇怪， 因为不知道为什么要祝大家今天节日快乐。今天这个节日并没有写在日历当中， 而是在很多人心里面。今天这个日子不是一个传统的节日 ，但却是每个人都喜闻 乐见。\n今天是农历的七月二十二 ，相传这一天是文财神李诡祖得道成仙的日子，还\n\n有人说是武财神赵公明的出生降世的日子 ， 所以人们把这一天当做财神节。 用  各种各样的方式来庆祝，表达着人们对发福生财的希望，对美好生活的期待。在 众多的庆祝形式当中，有一种显得尤为特别，就是把婚礼定在财神节的这一天。 中国人有句祝福叫恭喜发财，我们向他们恭喜新婚，新人祝我们发福生财。我们 来参加婚礼叫做出门见喜，他们今天结婚，叫做双喜临门。祝福今天这里的每个 人，见喜发财，财运滚滚。主持人就不要大家的红包了，只是希望你们祝福的掌 声，能够大声一点为他们响起来。\n今天是财神节，那就意味着以后每一年财神的生日都是他们婚姻开始的幸福  纪念，虽然十里不同风，尽管百里不同俗，财神节的这一天，有的人要燃放鞭炮， 有的人要大摆宴席，有的人烧香析福，还有的人张灯结彩，图个吉利。这些不同  的纪念活动。他们今天的婚礼全都做到了。所以他们不仅会拥有新感之界，这个  小家也定会被时神保估未来生活的每年，每一天，都会幸福安康。财源广进，大  家同意吗?好了，就在各位的掌声中，让婚礼开始吧。有请新郎，登场。\n\n1912 年，中国近代伟大的民主革命先行者孙中山先生郑重宣布:将老一套的农历改为如今的公历，同年， 《壬子葵丑学制》又新鲜出炉。这个学制第一次将全国中小学的开学时间定为 9 ⽉ 1 日 。公历的九月是中  国农历的初秋，这时暑气渐消，天气逐渐凉爽，人更能静下心读书。学生们经过了暑假两个月的休息调整， 充满了活力 ，可谓是开学的最好时间。而选择一号开学，有重新开始的意思，也能方便计算课时。\n正因如此,9 ⽉ 1 号开始的婚礼就特别的适合开学这样的话题。而说到开学， 记得有人曾把婚烟比作一  所大学， 在本篇开场词当中，也把即将走进婚姻的他们比喻成为即将走进大学的两个学生。漫长的婚烟旅  途，他们会一起学习和进步，其中第三自然段可以当做是 9 月的通用开场词，应用到 9 月的其他日子当中。", "tags": ["开场", "新郎", "祝福", "节日节气", "财神节通用婚礼开场词"]}, {"id": "l_e167e3a3d0", "cat": "节日节气", "title": "47 开学日通用婚礼开场词", "body": "(公历 9 ⽉ 1 ⽇)\n各位好，今天是 9 ⽉ 1 号，在我们的认知里面这一天仿佛有着一个特别的意  义。全新的一天，全新的 9 月 ，全新的学期，正在读书的孩子们又踏上一个新的  台阶。9 月的骄阳还有点盛夏的余温，夜晚和清晨，还远不及冬天那样冷。9 ⽉  的婚礼，也算是适逢其会，在这不冷不热的天，让这幸福的事，来的不早也不晚。\n9 ⽉ 1 日一直都是一个开学的日子 ，但刚好有人说婚姻其实是也一座大学。 他们不仅要做生活里的夫妻，还是大学里彼此的老师，能够互相学习，更是彼此  的同学，能够互相帮助和努力。这座大学学科很杂考试很多，学期还很长 ，只能  人学却不管毕业。尽管如此，他们却比任何一次求学都更期待这个新学年的开启。\n\n我总觉得 9 月是一个风华正茂的月份，因为它就像是二十几岁的年轻人，收 敛了青春里的滚烫，热烈，长在秋风里的理性和温柔，让人有一种被成熟宽厚的 臂膀，轻轻拥抱的感觉。就像此刻正在举办婚礼的他们，回味着曾经那一段 7 分 甜的恋爱，怀抱着今天 8分满的开心和喜悦，在 9 月伊始的日子 ，出发向新的征 程。给一点掌声吧各位， 为今天的婚礼，也为即将登场的新郎，小明。", "tags": ["开场", "开学日通用婚礼开场词", "新郎", "节日节气"]}, {"id": "l_ab9657adb6", "cat": "节日节气", "title": "48 白露节气通用婚礼开场词", "body": "(公历 9 ⽉ 7-9 ⽇)\n诗经，是中国古代最早的诗歌总集，里面记录了很多先民的诗歌艺术作品， 并有很多经典的诗句流传至今。其中有几句大家一定耳熟能详，蒹葭苍苍，白露 为霜，所谓伊人，在水一方。满满的对于爱人的痴情和想念，对爱情的期待和向 往。蒹茛苍苍，一片片茂盛的芦苇在随着秋风起伏摇晃，白露为霜，叶子上的露 水就像是结满了白霜。一派秋色天成的景象。为什么会想到这句诗呢?不只是因 为他描写了爱情，还因为它描写了我们此刻的节气 ， 白露时节。\n虽然秋天不浪漫，但是白露很浪漫，因为它就像是秋风在向叶子求婚，一颗   颗晶莹的露珠伴者晨光闪着光芒，真的好像颗颗的钻石戒指被秋风带在了叶子上。 虽然生活不浪漫，但是斯礼很浪漫。这是小明和小兰恋爱的果实，穿着洁白婚妙   的站朗就像是在叶子上跳舞的白色精灵，纯洁剔透，璨若水晶。民间的老话讲，  白露节，北风降， 一夜更比一夜凉。夏日的喧嚣终将会融入秋色 ，凝结成霜，\n归于平静，正如恋爱的激情注定会慢慢的藏入人心底，时光温热、经久不息。今 天这一场浪漫的仪式，便是这个秋日的白露时节，最浓郁的风情，掌声有请，新 郎人场。\n白露，是“二十四节气”中的第 15 个节气，秋季第 3 个节气，于公历 9 ⽉ 7-9 日交节。“白露”是反映自然 界寒气增长的重要节气 。由于冷空气转守为攻，白昼有阳光尚热，但傍晚后气温便很快下降，昼夜温差逐 渐拉大。\n时至白露，夏季风逐渐为冬季风所代替，冷空气转守为攻，加上太阳直射点南移，北半球日照时间变 短，光照强度减弱，地面辐射散热快，所以温度下降速度也逐渐加快。白露基本结束了暑天的闷热，天气 渐渐转凉，寒生露凝。古人以四时配五行 ，秋属金 ，金色白 ，以白形容秋露，故名“白露”\n本段台词结合了诗经里面脍炙人口的经典段落，蒹葭苍苍，白露为霜，与白露时节的婚礼特别契合。 用现代人的理解，以及对婚姻和恋爱的解读，做为婚礼开场词的切入点。中间加入了一段对白露为霜的联 想，让台词更有画面感。最后的一段，通过对于婚姻和生活的感悟做以总结，让台词更完整，显得更加的 丰满有内容。\n\n中秋节，又称祭月节、仲秋节、月亮节、团圆节等，是中国民间传统节日 。中秋节源自对天象的崇拜， 由上古时代秋乡祭月演变而来。中秋节自古便有祭月 、赏月 、吃月饼、看花灯、赏桂花、饮桂花酒等民俗， 流传至今，经久不息。中秋节起源于上古时代，普及于汉代，定型于唐代。中秋节是秋季时令习俗的综合， 其所包含的节俗因素，大都有古老的渊源。祭月作为民间过节的重要习俗之一 ，逐渐演化为赏月 、颂月等  活动。中秋节以月之圈兆人之团圆，为寄托思念故乡，思念亲人之情，祈盼丰收、幸福，成为丰富多彩、弥  足珍贵的文化遗产。\n中秋节当天举办婚礼并不常见 ，但是农历的八月十四和八月十六始终是一个很受欢迎的婚期。本段台 词结合中秋明月所象征的意义，来引出中秋与婚礼的联系，以及节日与婚礼有哪些相同的属性。说到中秋 与爱情，不能不提的就是苏东坡的这首传唱千年的《水调歌头》，大家耳熟能详，喜闻乐见。其中的两句“但 愿人长久，千里共蝉娟” ，既是对他们终成眷属的歌颂，也是对未来他们携手白头的祝福。", "tags": ["仪式", "台词", "开场", "戒指", "祝福", "节日节气"]}, {"id": "l_4b0f607586", "cat": "节日节气", "title": "49 中秋节通用婚礼开场词", "body": "(农历八月十四/十五/十六)\n尊敬的各位嘉宾，女士们先生们大家中午好，今天是农历的八月十四(六)， 中秋节的前一天(第二天) ，一个丹桂馥郁的仲秋，阖家团聚的时节，恭祝大家， 节日快乐。感谢您来参加小明和小兰的婚礼。\n在中国人的文化里面 ，月亮被我们寄托了太多的情感，爱的人在远方 ，中秋 的明月就意味着着相思。爱的人在身边，这轮明月则象征着团圆。爱的人终成眷 属，那中秋的月亮，则代表着月满爱也满， 月圆家更圆。\n当中秋遇见了婚礼，就像圆满遇见了美满。圆满的不只是夜空的明月 ，还有 这一段 X 年进行到底的爱情 。美满的不仅是婚礼的仪式 ，还有婚姻中平淡的流 年。当中秋遇见了婚礼，同样是良辰美景，同样是花好月圆，同样是幸福喜乐， 同样是团团圆圆。\n苏东坡的水调歌头里面写，明月儿时有，把酒问青天，这句经典诗词已传唱 古今，岁月也已经流转千载，可当年的明月 ，现在却依旧柔美而皎洁，和中秋时 节里的美酒交相辉映，人们把酒言欢，庆祝这段美满的好姻缘。千年已过，桑田 沧海，时过境迁，但是这两句团圆美好的祝愿却会一直传唱下去，我们用它，来 祝福小明和小兰，还有每一个有爱的人们，但愿人长久，千里共婵娟。各位，掌 声有请新郎，小明人场。\n\n教师节，旨在肯定教师为教育事业所做的贡献。在中国近现代史上有多个日期曾作为教师节。直至 1985\n\n年，第六届全国人大常委会第九次会议通过了国务院关于建立教师节的议案，才真正确定了 1985 年 9 ⽉ 10  日为中国第一个教师节。由于教师节并非中国传统节日 ，所以各地每年都会有不同的庆祝活动，没有统一、 固定的形式。\n如果新人其中一位或两位都是教师的身份， 而他们的婚礼又刚好选在了教师节，这篇台词看起来既紧 扣主题又切合时宜。从他们的关系和相处的状态来进行切入 ，用他们的职业性质和属性做以总结。让教师 节进行的婚礼特别的温肇又用心 。非教师身份在教师节的婚礼本篇台词并不适用。", "tags": ["中秋节通用婚礼开场词", "仪式", "台词", "开场", "新郎", "祝福", "节日节气"]}, {"id": "l_9b900ee363", "cat": "节日节气", "title": "50 教师节通用婚礼开场词", "body": "(公历 9 ⽉ 10 ⽇)\n各位来宾，大家好，欢迎您来参加小明和小兰的婚礼。九月的美好总是一个 接着一个。刚刚迎来了孩子们的新学期，刚刚走过蒹葭苍苍的白露节气，时光带 着我们来到了今天，9 ⽉  10 号教师节。首先要祝每一位辛勤可爱的园丁，工作 顺心 ，节日快乐。今天这样的一个日子，恰逢一场婚礼的举行，也为此刻浪漫幸 福的场景，增加了一点温馨和书香气。\n婚礼和教师节，原本这是两个毫无关联的日子，可是既然遇到了，就一定可  以有相同的话题。正如相爱的他们共同沐浴爱情里 x 年的时间，在这个过程里两  人既是朋友，是伙伴，是恋人，也真的算是各自的老师。教会了彼此理性和宽容， 付出和接受。也教会了彼此成熟跟成长 ，共情和沟通。\n今天恋爱故事里的男(⼥)主人公就是一名老师， 伟大的职业，平凡的工作。 在自己专业的学科和领城里面看起来严谨，镇密，富有原则。但是在谈情说爱这  方面难免就少了几分感性和浪漫色彩。不过幸运的是他遇见了一个给予他充分理  解的爱人，体谅他的辛苦，也感同身受他工作中的烦恼和压力，愿意宽慰和倾听， 让他感受到被一个这样的人爱着， 是件多么幸福和幸运的事情。今天是他的节  日 ，是他们两个人的节日 ，是他们全家人的节日 ，是每个他们爱的，爱他们的人， 都铭记于心的纪念日 。祝他们教师节快乐，婚礼日快乐，往后余生 ，每时每刻， 都甜蜜如今，快快乐乐。\n\n秋分曾是传统的“祭月节” 。现在的中秋节则由传统的秋分“祭月 ”而来。据考证，最初“祭月节”定在“秋 分”这天，不过由于这天不一定都有圆月 ，后来就将“祭月节”由二十四节气“秋分”调至农历八月十五日 。“分” 示昼夜平 分之意，同春分一样， 此日阳光直射地球赤道，昼夜相等。此后白天渐短，夜晚渐长 。(春秋繁  露.阴阳出入上下篇》中说:“秋分者，阴阳相半也，故昼夜均而寒暑平。”秋分这天正好在秋季90 天的中间， 有着“平分秋色”的意思，所以叫“秋分”。\n\n从秋天这个季节进行入手和解读，用画面感来增加这段台词的整体效果 和美感。用秋分节气的特点引 出他们新生活的开端。用一些谱音梗，来加入秋天这个季节的元素，让人产生更多感同身受的共鸣。用平 分秋色这个成语来概括 他们在秋分这一天的婚礼。 最后加以升华总结。", "tags": ["台词", "开场", "故事", "教师节通用婚礼开场词", "来宾", "节日节气"]}, {"id": "l_03e83ad962", "cat": "节日节气", "title": "51 秋分节气通用婚礼开场词", "body": "(公历 9 ⽉ 22-24 ⽇) 各位好，欢迎大家光临今天的婚礼。\n在你看来，秋天是一个怎样的季节呢?我的答案是，夏天还不想走 ，冬天还 不想来。在拉拉扯扯中，就是秋天的存在感。漫步在夏花与冬雪之间的这一段时 光， 就像是一幅渐变的油画，从青绿慢慢的泛黄 ，叶子一片片的把家从枝条间 搬到了土地上，一排排齐齐整整的飞在天上的大雁，就像是夏天未完待续的省略 号吧。虽然画中的颜色变了，但画里的景色却依然美好。秋天平分了冬夏，而秋 分，则平分了秋天。今(昨/明)天是二十四个节气中的第十六个，昼夜的长度在秋 分的时节里，又重新回到了同样的水平线。小明和小兰的爱情，也在这个特别的 日子 ，带着他们站在了一个新生活的起点。\n秋分的分是芬芳的芬，稻谷的香气藏在微凉的风中，给人以幸福的成就感。 此刻婚礼中，欣喜等待着的小明和小兰，从容自信的微笑，让这两张年轻的脸庞， 也焕发着些许成熟的味道。有人用平分秋色来形容这个节气，我觉得这个词也可  以用来形容生活里的小明和小兰，他们同样的杰出和优秀，也同样努力和进取。 因为他们懂得一段好的关系绝不是谁的依附和谁的迁就，面是两个人能够放鼓相  当、能势均力效，随够在各自的世界里独自为王，也能够在共同的生活里天下无  双。\n在这个秋分节气特别的日子里，祝福这一对小夫妻平分幸福和美满，平分喜 乐和甜蜜。祝我们大家平分今天的美酒佳肴，平分生活的安宁和如意。请大家想 起掌声，有请今天的男主人公，首先人场。\n\n1949 年 12 ⽉ 2 日 ，中央人民政府委员会第四次会议接受全国政协的建议，通过了《关于中华人民共和  国国庆日的决议》，决定每年 10 ⽉ 1 日为中华人民共和国宣告成立的伟大日子，为中华人民共和国国庆日 。\n这篇台词不仅可以用在 10 ⽉ 1 日的婚礼，也可以用在国庆假期的前几日 。第一自然段可修改为，“如果 月份有颜色 ，属于十月的一定是红色 。1949 年的 10 ⽉ 1 号，一串掷地有声的宣告，一个红色的中国从此屹 立在世界的东方”。第二 自然段，“今天这个日子 ”，可以改为“说起国庆节，对祖国来说是生日 ，对我们来说\n\n是节......第三自然段的“今天”可以去掉，这样修改过后，便可以无缝的应用到国庆长假期间的其他婚礼中。", "tags": ["台词", "开场", "祝福", "节日节气"]}, {"id": "l_5ce6103035", "cat": "节日节气", "title": "52 国庆节气通用婚礼开场词", "body": "(公历 10 ⽉ 1 ⽇)\n各位好，欢迎大家在一个如此特别的日子来参加小明和小兰的婚礼。\n如果月份有颜色 ，属于十月的一定是红色 。 1949 年的今天，一串掷地有声  的宣告，一个红色的中国从此屹立在世界的东方，70 多年后的今天，在这个富庶  而强大的国度，一面面红色的旗帜飘扬在商铺琳琅的大街小巷。十月的开篇，原  本就因为它自带的成熟的属性，给人们以丰收的喜悦，再有祖国母亲生日的加持， 让每一年的今天，都显得格外的温暖而特别。可是小明和小兰还有他们的每个家  人，在未来的每一年的国庆节里面，都会再加上一份团圆和幸福的感觉，他们的  小家，在今天成立了。\n今天这个日子，对祖国来说是生日 ，对我们来说是节日 ，对小明和小兰来说 是婚姻的纪念日 ，这个日子里面既包裹着我们大家的祝福和陪伴，还有他们从相 识到相恋，从相爱到结婚 的那些难忘的点点滴滴。在十月启程的这一刻， 把所 有的这些全部都打包在一起，和他们的爱一起迈向婚姻。\n各位，今天，国庆长假开始了，很多人也开始计划着自己的假期旅行。今天， 他们的婚昏礼开始了，两个人也规划着他们的婚姻旅程。旅行和旅程，有着相同  的本质，就是边走边看边欣赏沿途的风景。愿这一抹秋色，能为你的双眼装进更  多的些妙，也愿他们的人生，也会因为这段殳婚姻，和一个温暖的爱人，变得喜  乐丰盈，精彩纷呈。各位，祝祖国母亲生日快乐，大家国庆快乐，祝他们新婚快  乐。\n国庆长假的每一天也许都是结婚的旺季，如果婚期定在了假期的最后一天，这篇台词便可以完美适用。 写这篇台词的时候刚好主持过一场 10 ⽉ 7 号的婚礼于是便摘了两句话，将这段小长假最后天的台词补全。\n有人问为什么很多新人都喜欢在国庆期间结婚呢?相对于其他几个节日 ，只有国庆节的时间最长，大家 的时间也是最充沛的，这个时间邀请朋友参加婚礼，基本都会前往，只要关系没有问题。最后，也是最重 要一点就是，国庆节的时间在我国，气候适宜，不热不冷，穿着婚纱的新娘最美，同时可以拍摄下来一段 非 常美好的结婚记忆。所以每年的国庆节都是婚礼最忙的一段时间。 如果你国庆期间的婚礼都不多，那 就要找找原因，或者虚心学习了。", "tags": ["台词", "开场", "新娘", "祝福", "节日节气"]}, {"id": "l_35a7a6485f", "cat": "节日节气", "title": "53 国庆假期最后一天通用婚礼开场词", "body": "(公历 10 ⽉ 7 ⽇)\n各位来宾，大家中午好，欢迎参加小明和小兰的结婚典礼。过了今天，国庆 假期正式的结束。过了这个月 ，我们的秋天也要余额不足。再过不到 100 天，2022 年也将会落下帷幕。我们在风驰电掣的岁月里甚至来不及惋惜，时光带走的那些 珍贵，又要匆匆忙忙的整理心情去面对新的一切。比如，秋天过后，必将迎来一 个新的季节，比如今年过后，定会拥抱一个新的一年，比如恋爱过后，小明和小 兰也要开始他们新的婚姻的旅程。不是所有的结束都代表着终止 ，有些结束，其 实意味着一个新的起点。X 年前，小明和小兰在朋友的介绍和撮合下，结束了单 身的状态，成为情侣，对他们来说，这个结束，就令他们既幸福又期待。\n转眼十月已经过去了一个礼拜，假期也只剩下了最后一天， 听起来让人留  恋又略带着一点不舍。但是我们又都知道忙碌紧张的工作其实才是生活的常态。 就像小明和小兰今天的这一场婚礼不管有多美好，有多圆满，也都只是短短的一  天， 然后就被装进回忆里。而平凡的日子 ，平淡的流年，才是婚姻本来的状态。 我们有理由相信他们会在那些不惊不扰的时光里 ，用一个又一个小小的仪式感， 把平凡的日子过的像一首诗，过的浪漫，让每一个日出和月落，都变得充满期待。", "tags": ["仪式", "开场", "来宾", "节日节气"]}, {"id": "l_5cd250b231", "cat": "节日节气", "title": "54 寒露节气通用婚礼开场词", "body": "(公历 10 ⽉ 7-9 ⽇)\n各位来宾大家好。不知不觉凉意渐盛，刚刚迈进的这一扇十月的大门，就像 是通往深秋的人口 。北方的白天秋高气爽， 但夜晚已经冷若冰霜，南方的秋风 日益转凉，处处一派秋色天成的景象。中国农历二十四个节气中的寒露，又伴随 着星移斗转自然而生 ，它在提醒着我们，要珍惜阳光，温暖的日子，也许要离开 我们一段时间了。\n寒露的节气就像是一个“姑娘”的名字，但是这个“姑娘”  似乎并不算温暖。 小兰也是一个女生的名字， 这 X 年相爱的时光，小明却在她这里感受到这个世 界上最好的温柔。这一段恋爱的色彩不同于此刻的季节，虽然这几年的陪伴看似 平淡，但他们内心里却藏着外人难以触碰的热烈，虽然剧情也没有一波七八折那 样的吸引，但是却有着不欲人知的甜。\n如此节气真的是一个值得记录的好时节，不仅是一年好景君须记，最是橙黄  橘绿时。也不仅是停车坐爱枫林晚，霜叶红于二月花。他们也许还想借着十月这  个十全十美的月份，来拉开他们婚姻的帷幕。寒露过后，叶子会离开树木的羁绊， 去拥抱大地。结婚过后，孩子也会离开爸妈的港湾，去拥抱家庭。 愿这世上美\n\n好的一切， 都能周而复始，生生不息。各位，让我们共同来祝福他们的婚礼吧!\n“袅袅凉凤动，凄凄寒露零。”二十四节气中的第十七个节气寒章。寒露是一个反映气候变化特征的节 气。寒露节气后，星渐矩，夜渐长 ，日照减少，热气慢慢退去，寒气渐生，昼夜的温差较大，展晚略感丝丝 寒意。在我国民间，有“露水先白而后寒”之谚言 ，其意为经过白雾节气后，露水从初秋泛着丝凉意转为深 秋透着几分寒冷的“白雾欲霜”  。从洁白晶莹的雾 气转为寒冷欲凝，生动地反映出气温的不断下降。随着 寒气增长 ，万物也逐渐萧索，秋季是一个热与寒交替的季节。\n寒露是公历 10 月的节气 ，而在北方大部分地区，十月下旬就已经进入了深秋的季节，所以把这个节气 比作是一个深秋的入口 ，跨过了这一站，树叶飘零， 北风渐起。寒冷的日子就一天比一天近。第二段用了 一个对比的方式，寒露就像一个不算温暖的姑娘，而新娘却是拥有这世上最好的温柔。对比的还有他们的 恋爱,虽然寒露萧瑟而清冷,但是爱情却藏着热烈。用一些描写秋色景物的古诗词在中国人自己的节气当中， 会显现出浓浓的韵味和中华文化的静美。本篇台词可应用于整个寒露节气 ，最后一个自然段可当做十月的 通用台词。\n\n重阳节，是中国民间传统节日 ， 日期在每年农历九月初九。“九”数在《易纪)中为阳数，“九九”两阳数 相重，故日“重阳” :登高赏秋与感恩敬老是当今重阳节日活动的两大重要主题。重阳节源自天象崇拜，起始 于上古，普及于西汉，鼎盛于唐代以后据现存史料及考证，上古时代有在季秋举行丰收祭天祭祖的活动古 人在九月农作物丰收之时祭天帝 、祭祖，以谢天帝 、祖先恩德的活动，这是重阳节作为秋季丰收祭祀活动 而存在的原始形式。唐代是传统节日习俗揉合定型的重要时期，其主体部分传承至今。\n久久重阳，长长久久。不仅符合重阳节的节日特性，也契合我们对婚礼的祝福。重阳节在很多的地方 都被称之为老人节，象征着长久长寿。所以本篇台词的立意也是联想到家中老人希望儿女幸福的心愿，孩 子们要在老人节日的这天把一场幸福的婚礼当做一份礼物送给他们。既能表达孩子对家中长辈的孝道，又 能体现他们对婚姻能够美满长久的美好的期待。最后一个自然段，用 “⽼”字去诠释那些不会变老的永恒， 还有爱，就算时光变老 ，也会历久弥新。", "tags": ["台词", "开场", "新娘", "来宾", "祝福", "节日节气"]}, {"id": "l_ce086d4576", "cat": "节日节气", "title": "55 重阳节通用婚礼开场词", "body": "(农历九月初九)\n各位来窦大家中午好 ，欢迎各位来参加小明和小兰的婚礼 。今天是 X ⽉ X 号，农历的九月初九，重阳节。也是中华民族的传统节日之一 。 起源于中国古 代民间的风俗。古时候的人们把重阳节看做是一个值得庆贺的吉祥日子。认为这 一天为阳气至极，适合登高拜祖，饮宴祈寿。九月初九，九九归真，一元肇始， 万象更新。近代的习俗中，因为 9 象征着长久长寿，所以重阳节的意义又包含了 尊老敬老，对于婚姻来说，又寓意着他们白头偕老 。中国人喜欢用吉祥的谐音来 传送美好的祝福，所以今天这个日子，九九重阳，今天结婚的小明和小兰，也必\n\n定会长长久久。\n我们都喜欢把重阳节称为老人节，做为儿女子孙都希望老人家们长命百岁， 也让我们能有更多的岁月表达爱心和孝道。不知道大家都准备了怎样的礼物和心  意呢，不管准备了什么，估计都没有小明和小兰准备的这样盛大。每一个老人都  希望自己的孩子们能快乐和幸福，所以今天他们的孩子就用一场婚礼，来做为给  长辈们回报的一份节日的礼物。这份礼物他们一定格外的喜欢，因为对他们来说， 既满足了期待，也实现了心愿。看着深爱的孩子们拥有了自己的小家，今天真的  算得上是一个被幸福美好，填满的重阳节。\n每个人都会变老，所以这个节日与所有人都有关。只是如果常体联阳无的心 购整里装满温暖，你会发现，快乐不老 。时光不老 ，爱也永远不会老。祝福小明 和小兰在重阳节里开始的婚姻，同心久久，天长地久。\n霜降是秋季的最后一个节气 ，是秋季到冬季的过渡。霜降时节，万物毕成， 毕入于戌，阳下入地，阴气始凝。天气渐寒始于霜降。“霜降”节气特点是早晚天 气较冷、中午天气则比较热，昼夜温差大 ，秋燥明显。\n过了霜降秋天就结束了，所以这篇台词的开篇用到一个词“属于秋天的最后 一丝浪漫” 。下一个节气 ，将会一起拥抱冬天。第二段同样用了对比的手法，因 为南北不同的气温差异。霜降时节，层林尽染的应该是南方多地，树叶的颜色缤 纷绚烂美不胜收。而北方十月的景象便是寒风落叶，一片萧瑟了。对比的好处就 是可以让人最大化的产生代入，有画面感。窗外有落叶，婚礼有花瓣，虽然都是 零零碎碎的酒落在脚下，但却并非同一种心境和感受。一个是铺满了通往冬天的 路，一个是点缀了走向幸福的旅途。", "tags": ["台词", "开场", "祝福", "节日节气", "重阳节通用婚礼开场词"]}, {"id": "l_77a37127fa", "cat": "节日节气", "title": "56 霜降节气通用婚礼开场词", "body": "(公历 10 ⽉ 23-24 ⽇)     各位好，这里是 xx 酒店，小明和小兰的婚礼。\n一转眼时间已经来到十月的下旬，天气天比一天变得更凉，但是一直温暖的 是人心。感谢大家从四面八方赶来，欢聚一堂，来庆祝一个小家的新生，来祝福 婚姻，来赞颂爱情。今天是中国农历 24个节气中的霜降，也是立冬之前，属于 秋天的最后一丝浪漫。 我们一起来搭乘这一班通往未来的列车 ， 打包好行囊里 因爱而来的温暖，下一个停靠站，已然就是一个全新的季节。\n霜降的风光各有不同，有的地方层林尽染，有的地方寒风落叶。故事也是同 样，有的爱情波澜曲折，有的恋爱平淡温暖。就像小明和小兰。从相识到相恋， 从相爱到今天，他们一起经历过无数的时光和岁月 ，陪伴彼此穿越过好多不同风 光的季节。他们一同期待过春天的草木 ，夏天的花，也曾一同赏过秋天的明月 ，\n\n冬天的雪。而此刻应该是他们最爱的季节吧。在缤纷的秋色里，采摘下成熟的果 实，在清凉的秋风中，收获沿途有爱人依偎的温暖。\n此刻的窗外，落叶酒满了马路的两旁，多像今天婚礼现站的 T 台(通道)的两 边，也有花瓣铺满他们通向婚姻的路上。春光不必趁早，秋霜不会迟到，该来的 总会在最适合的时间到来，一切都是刚刚好。各位，秋天快乐，掌声送给新婚快 乐的他们吧。有请新郎，小明入场。\n\n立冬是冬季的第一个节气 ，代表着冬季的开始,为冬三月之始。立冬与立春、立夏、立秋合称“四立”。\n\n一段适用于立冬节气的开场词，我个人非常喜欢的一篇。虽然冬天就要来了，但是不管天气会变得有  多冷，都不会降下爱的温度，心中有爱的人 ， 自然可以融冰化雪， 自然春风得意， 自然春暖花开。第三自  然段我用四季来概括了人生 ，青春年少就像春天，生机勃勃，草木兴旺。青年时代就像夏天，满满的阳光  和希望。中年之后人会像秋天，变得成熟而有所收获，晚年的人们就像冬天，在静谥的冬夜里细数着过往。 四季如人生 ，又不同于人生 ，季节有更迭往复，但人生只有一程。好好的珍惜生活吧，珍惜所拥有的一切， 这都是这个世界给我们最宝贵的财富。愿每个人都能在有限的人生 ，看遍无限的风景。不辜负这短短的一  世人生旅程。", "tags": ["入场", "开场", "故事", "新郎", "祝福", "节日节气", "酒店"]}, {"id": "l_d4da219981", "cat": "节日节气", "title": "57 立冬节气通用婚礼开场词", "body": "(公历 11 ⽉ 7-8 ⽇)     各位好，欢迎大家来参加小明和小兰的婚礼。\n在过去的农耕社会，有这样的 8 个字概括了万物的自然规律。春耕夏长，秋 收冬藏。伴随着农历二十四个节气“立冬”的到来，季节的冬天也随之开启了属于 它的时段。未来的一段岁月 ，夹杂着冰霜的北风将会和我们在这个季节里不期而 遇，但是不管怎样的寒冷，也降不下爱的温度。任由这个世界大雪漫天，小明和 小兰，早已为对方准备了一冬天的暖。\n其实所谓的春耕夏长，秋收冬藏是自然的四季，而人生也有如四季排列的规 律。在今天以前，他们刚刚走过了生命的春天，满满的青春活力，散发着勃勃生 机。从今天起，他们将迎来生命中的夏天，用热烈，用澎湃，用阳光的心态去开 创未来，去构筑他们的婚姻和家庭。慢慢的他们会收获累累的硕果，会有成就， 也会有自己孩子，就像时光来到了秋天。而冬天，就像白头偕老的他们坐在温暖 壁炉的旁边，一边准备着晚餐，一边跟孩子们聊着天，回忆着从前。\n此刻虽然是立冬的节气，但对他们来讲，却正是人生夏天的开始，也是年岁\n\n的正当时。在最好的时光，跟最好的另一半，和最好的家人一起，展望他们更好 的将来。让我们一起来认识一下今天的男主人公吧。掌声有请，新郎人场。\n\n在我国 11 ⽉ 9 日的月 日数恰好与火警电话号码 119 相同，而且这一天前后，正值风干物燥、火灾多发  之际，全国各地都在紧锣密鼓地开展冬季防火工作。 为增加全民的消防安全意识,使“119”更加深入人心 ， 公安部在一些省 市进行 119\"消防活动的基础上，于 1992 年发起，将每年的 11 ⽉ 9  日定为全国的“消防日 ”。\n婚礼中经常可以遇见新人是一名光荣的消防英雄，在平凡而高尚的岗位上为社会的和谐稳定，百姓的 安居乐业付出着辛勤和汗水 。这篇台词的是针对 11 ⽉ 9 ⽇ “消防日”举办婚礼的消防英雄。如果新人并非消 防员，这篇台词没有大多的参考性。如果新人是消防员，即便不是 11 ⽉ 9 日结婚，这篇台词也仍有大部分 内容可以做为消防员的通用台词做为参考。祝愿每个消防员都能工作顺利，健康平安。“救人于水火 ，帮人 于危难，在和平年代能够挽救别人生命的，除了医生就是消防员。所以他们就是我们这个时代的英雄。”", "tags": ["台词", "开场", "新郎", "节日节气"]}, {"id": "l_8d48d808df", "cat": "节日节气", "title": "58 消防日通用婚礼开场词", "body": "(公历 11 ⽉ 9 ⽇)\n各位来宾大家好，欢迎各位前来参加婚礼。说起 119， 就像是一个极具安全  感的符号一样的刻在我们的心里。当灾难来临，当危险发生，一辆辆红色的卡车， 一个个穿着蓝色铠甲的英雄们，如神兵天降一般出现在挽救生命的第一线。就是  这群可爱的消防员，用他们的青春和热血为需要帮助的人冲锋陷阵，守护平安。 今天是 11 ⽉ 9 号，119，也是全国第 X 个(始于 1992 年)消防日 ，希望大家积极参  与和重视消防工作，也祝所有的消防队员，健康平安。\n小明就是一名光荣的消防员，他是小兰一个人的男朋友，也是我们所有人的 蓝朋友。那一身火焰蓝，就是他们为我们普通的百姓，赴汤蹈火的安全感。有人 叫他们逆行者，因为当灾害来临所有人都避难逃灾，而只有他们会扛起自己的武 器和使命，逆行于通往危险中心的第一线。 救人于水火 ，帮人于危难，在和平 年代能够挽救别人生命的，除了医生就是消防员。所以他们就是我们这个时代的 英雄。\n只是对于小兰来说，他是大家的英雄，却未必会做一个称职的好老公。当需 要他的时候，他也许不会及时出现，而且可能正在面对危险。当节日里别人都合 家团聚的时候，他也许未必会有时间，可能正在坚守着一座城市的平安。但是因 为爱，她无悔自己的付出和选择，她觉得她会很骄傲的对她未来的宝宝说，你的 爸爸是一个超级大英雄。对每个新认识的朋友说，我老公是一个光荣的消防员。 各位，就让我们起来欢迎这位，帅气的男主人公吧。掌声有请新郎，小明登场。\n\n双十一购物狂欢节,是指每年 11 ⽉ 11 日的网络促销日 ,源于淘宝商城(天猫)2009 年 11 ⽉  11 日举办的网 络促销活动，当时参与的商家数量和促销力度有限，但营业额远超预想的效果，于是 11 ⽉ 11 日成为天猫举 办大规模促销活动的固定日期。双十一已成为中国电子商务行业的年度盛事，并且逐渐影响到国际电子商 务行业。", "tags": ["开场", "新郎", "来宾", "消防日通用婚礼开场词", "节日节气"]}, {"id": "l_abca7d9fb3", "cat": "节日节气", "title": "11 ⽉ 11 号其实有两层含义。在电商尚未普及的年代记得这一天还被叫做“光棍节” ，经常会有酒吧，夜 店，俱乐部搞一些单身派对的活动以吸引单身的消费者，后来又演变为脱单节。希望这一天能找到一个对 象,结束自己的单身生活。 而最近的几年，在这一天结婚的新人数量也在不断的呈现上升的趋势，一方面有 告别单身的寓意，一方面觉得 11 就像是两个单身的人幸福的牵手站在一起，2 个数字“1”，变成了 1 个数字 “ 11” ，两个单身的人 ，共同组成了一个小家庭。", "body": "59“双 11”通用婚礼开场词\n\n(公历 11 ⽉ 11 ⽇)\n各位来宾，大家中午好，欢迎大家来参加小明和小兰的婚礼。\n今天是 11 ⽉ 11 号，有人称它“双 11” ，有人叫它光棍节，顾名思义，光棍节 是只有光棍才能过的节日 ，像小明和小兰这样，一个名花有主，一个心有所属的 人，就没资格过这个节了。当每个人都在忙着为购物车里的宝贝付款，小明准备 要清空他宝贝的购物车了。因为购物车里面装的最多的不是漂亮的衣服，好看的 鞋子 ，而是柴米油盐，碗盘碟子 ，这些，将要开启他们人间烟火的小日子。\n他们把结婚的日子选在 11 ⽉ 11 号这么特别的一天，我猜小明会不会觉得这  一天他们忙着结婚， 老婆就没有时间捧着手机疯狂的下单。我猜小兰可能是觉  得购物车的里的宝贝，今天终于可以名正言顺的让老公去付款。当然这些都是玩  笑。我觉得第一个意义，他们要在这一天彻底的告别的单身，从此光棍节与他们  无缘，这一天只有美满的纪念。 第二，双 11 全世界都在打折，唯独没有打折的， 是他们的幸福，期待和爱，还有这场婚礼注定会收获的圆满。", "tags": ["一方面有", "一方面觉得", "两个单身的人", "个数字", "变成了", "告别单身的寓意", "开场", "来宾", "经常会有酒吧", "而最近的几年", "节日节气"]}, {"id": "l_28f8ea60e0", "cat": "节日节气", "title": "11 ⽉ 11 号，当四个 1 站在一起，不知道各位会想到什么，而我能想到的文 字，就是生世，一心一意。而我想到的画面，大家可以脑补一下，像不像是两双 筷子 ，就让我们共同祝福未来的他们，每一顿早午晚餐，都是两个人在一起。各 位，掌声 送给双 11 的婚礼，感大家都能像小明和小兰一样， 收获自己心仪的 宝贝。", "body": "小雪，是二十四节气中的第 20 个节气，冬季第 2 个节气 ，时间在每年公历 11 ⽉ 22 或 23 日 ，即太阳到 达黄经 240°时。小雪是反映降水与气温的节气 ，它是寒潮和强冷空气活动频数较高的节气 。小雪节气的到 来，意味着天气会越来越冷、降水量渐增。\n“ 雪”是寒冷天气的产物 ，故以“小雪”比喻这个节气期间“气候寒未深且降水未大”的气候特征 。“小雪” 节气是反映气温与降水变化趋势的节气，并不是表示这个节气下很小量的雪，节气“小雪”与天气中的“小雪” 没有必然联系。“小雪未必下雪，却开启了一季的诗意和安宁” 。小雪的节气 ，也打开了冬日的地洁和静道。 这篇台词，用了冬天的冷，对比了恋爱的暖，用了慢寒凉的季节，对比了他们满满收获的圆满。我喜欢在  对比中来体现出想要表达的心境，心藏火热，无拱清冷的风 ，爱如骄阳，无是冬日的寒凉。似乎可以让美  好的东西对比的更美好，让温暖的事情交得更温暖。小雪节气的婚礼台词，适用于整个节气时令中。喜欢  可以斟酌使用。", "tags": ["不知道各位会想到什么", "像不像是两双", "台词", "大家可以脑补一下", "就是生世", "当四个", "掌声", "收获自己心仪的", "每一顿早午晚餐", "的婚礼", "祝福", "站在一起", "筷子", "而我能想到的文", "节日节气", "送给双"]}, {"id": "l_4f0f74a383", "cat": "节日节气", "title": "60 小雪节气通用婚礼开场词", "body": "(公历 11 ⽉ 22-23 ⽇)\n各位来宾，大家好。欢迎各位来参加小明和小兰的婚礼。 风寒岁暮，隆冬 渐浓，十一月的背影， 阳光耀眼依旧，但温暖早已远不及夏秋。农历的时节已 流转到小雪节气 ，虽然小雪未必下雪，但却开启了一季的诗意和安宁， 虽然冬 日天气渐寒，但是有家人和朋友，有期待和愿望，有关怀和陪伴，有爱有美酒， 日子同样可以，热气腾腾。\n小雪是冬天的第二个节气，万物都将要开始慢慢收敛生机，在为明年春天的  破土和发芽而积蓄力量。可是他们两个人的这份爱，却如同梅花一样，伴雪而生， 迎霜怒放。因为心藏火热，所以便无惧清冷的风 ，因为爱如骄阳，所以无畏冬日  的寒凉。小雪的节气其实并不是代表天气，而是象征着冷空气在频繁的穿梭于北  半球，在给这里的人们带来关于冬天更多的消息。\n十一月的下旬，北方早已大雪飞扬，但是江南却刚刚迎来初霜。不管是流转 的季节，还是故事的情节，都不会一蹴而就，而是慢慢的循序渐进。比如小明和 小兰的故事 ，在 X 年的时光里面一步一个脚印的走到婚姻的门口 ，才会让他们 今天的感情更坚实，和对方白头偕老的决心也更加的坚定。所以他们邀请了我们 大家，来一起听听他们的誓约，来共同见证他们的婚礼。那就让今天故事，从现 在开始吧，有请新郎，小明人场。", "tags": ["开场", "故事", "新郎", "来宾", "节日节气"]}, {"id": "l_b804e0cb5d", "cat": "节日节气", "title": "61 感恩节通用婚礼开场词", "body": "(公历 11 月第四个周四)\n各位好，欢迎大家来参加婚礼。跟其他平凡的日子相比 ， 今天似乎有一点 不同， 但却并没有太多人了解这个节日的意义。这个节日原本与宗教有关，这 个节日原本离我们很远。这个节日并不是华夏民族的传统，但是这个日子名字很 好听 ，而且会给人以温暖 。每年 11 月的第 4 个星期四 ，这一天叫感恩节 。所以 首先感恩各位的祝福，感恩你们的到来，感恩大家，让这场婚礼变得更圆满。谢 谢各位。\n这个世界有太多的东西值得感恩，但是我们今天还是应该替小明和小兰，好  好的感恩一下缘分的遇见，和命运的安排，可以让他们，在刚好温柔和成熟的年  岁里彼此邂近，一起走过一段相爱的旅程， 给了他们希望和动力去分享彼此未  来的余生 。 感恩他们这一路经历的那些苦和甜，让两人学到爱是彼此支撑与互  相温暖。感恩日子中的那些白天和黑夜，让他们懂得生活就是边各自努力，一边  守候与陪伴。还要感恩曾有过的风雨，让两人经历了成长，手牵的更紧，心靠的  更近，感情也坚实的不是冲击和考验。而最大的感恩，还是要留给这个完美的爱  人，美好的回忆，难忘的经历和幸福的值慢，全都与他有关。想到未来爱和他起  探索面行 ， 年一个分秒，都值得期待。各位，感思你们的掌声，为今天的婚礼， 热情的响起。谢谢大家。\n感恩节，西方传统节日 ，也是美国人合家欢聚的节日 。初时感恩节没有固定日期，由美国各州临时决 定。直到美国独立后的 1863 年，林肯总统宣布感恩节为全国性节日 。1941 年，美国国会正式将每年 11 月第 四个星期四定为“感恩节” 。至于这个节日的由来貌似有一点长 ，不在此详细介绍。\n感恩节并不是一个国内的常见节日 ，也并非国人的传统。只是近些年网络和媒体的宣传使这个节日频 繁诸见报端，而且名字好听，还有寓意，所以便将感恩节的台词准备一篇，以备需用 。做为感恩节主题的 台词，关键词一定是以感谢为主。感谢亲友，感谢缘分，感谢命运，感谢彼此这一路的风雨同舟 。 11 月的 第四个星期四，稍微修改下也可以用在前后的几天。如第二 自然段:再过两天的星期四，就是感恩节，但却 并没有太多人了解这个节日的意义。\n\n“大雪，十一月节，至此而雪盛也。”因“ 雪”是寒冷的产物，代表寒雨天气这节气的特点是气温显着下降， 强冷空气往往能够带来雨或雪。“大雪”名称是个比喻，反映的是这个节气期间气候变化，寒流活跃气温下  降 、降水增多，并不是表示这个节气期问下很大的雪。但是大雪节气之后，天气会越来越冷，下雪的可能  性大增。节气意义上的“大雪”与天气预报中描述降雪量的“大雪”无必然联系。\n虽然大雪节气也未必会下雪，但是用上了一句我很喜欢的话，下雪的时候一定要和心爱的人出去走走，\n\n因为一不小心，就会一起白了头。大雪是 12 月初的一个节气。在我国大多数的地方, 12 月份应已经进入了寒 冬模式。天气越来越冷，气温越来越低。所以台词的写作也会以冬天的季候特性做为切入点，然后引申出 我们的观点和想要表达的含义。“落叶有意境，落雪有浪漫，不同的时节，有不同的风景”。恋爱的时候可能 生活里面更多的是美满的香甜，而婚姻开始后，也许面对更多的是日子里面的柴米油盐。风起的日子笑看 落花，雪舞的时节举杯向月 。在大雪的节气开始的婚姻，祝愿我们的新人能白头借老 ，幸福与美满。", "tags": ["台词", "开场", "感恩节通用婚礼开场词", "祝福", "节日节气"]}, {"id": "l_c171149bd2", "cat": "节日节气", "title": "62 大雪节气通用婚礼开场词", "body": "(公历 12 ⽉ 6-8 ⽇)    各位好，欢迎大家来。加小明和小兰的婚礼。\n时光翻阅着四季的往事，在一片雪色里放慢脚步。这是一年中最后的一个季 节， 二十四个节气 ，来到了大雪。尽管寒风凉列，但是很多的恋人却喜欢下雪 天，不止是因为浪漫，还有他们笃信这样的一句话， 下雪的时候，跟心爱的人 在雪中走走 ，一不小心 ，就会一起白了头。\n有人说冬天结婚，没有夏天那样热烈的阳光， 白云和蓝天，缤纷的色彩，可 是幸福不分季节，况且，冬天也有冬天的浪漫。天气很冷风很凉，但却让热情的 事物更热情，让温暖更温暖。尽管冬天的颜色没有那么鲜亮，但却可以请冬雪， 装点这分颠覆世界的白 ，埋下来日璀璨的伏笔，静待来年浓墨重彩。\n也许恋爱如秋天的色彩缤纷，但他们知道真实的生活，其实像是一个银装素  裹的世界，哪怕不够绚丽，但却纯净而洁白 。踩在雪上的每一步，都坚定而柔软。 落叶有意境，落雪有浪漫。 不同的时节，有不同的风景，不同的年华， 有不同  的心境。比如此刻的小明和小兰，想用这样的一场婚礼，在大雪的节气，来纪念  他们的恋爱，来懂憬他们携手余生的婚姻。各位来宾，感谢你们的陪伴，让今天  的婚礼，温暖而圆满，还有更多感谢的话，交给小明吧，掌声来送给他。\n\n63“双 12”通用婚礼开场词\n\n(公历 12 ⽉ 12 ⽇)\n各位来宾，大家中午好，欢迎各位来参加小明和小兰的婚礼。\n听说“双 11”的时候好多的人都在忙着脱单，没时间去为心仪的宝贝下单，那 “双 12”机会来了，在商家们的炒作下，这又成了一个电商节。你说他的节日 ，除 了满满的商业气息，好像并没有太多的文化传承和历史底蕴。只是人们听说这一 天很多的宝贝都会便宜。小明不关心别人卖的东西有多便宜，因为小兰在这一天\n\n嫁给了他，这么好的老婆，真是老天便宜了自己。\n双 12 这一天 ，有人薅羊毛 ，有人割韭菜 ，有人喝喜酒 ，有人秀恩爱 。大家 各取所需，目的不同，但效果却都差不多，就是我们都有了自己的收获，每个人 都会觉得很快乐。当然最幸福的一定就是他们俩了，带着 X 年的恋爱成果，一路 披荆斩棘的走了过来，站在婚姻开始的地方 ，回望来路，面向未来。", "tags": ["开场", "来宾", "节日节气"]}, {"id": "l_a4d5f54893", "cat": "节日节气", "title": "12 ⽉ 12 号，各位有没有发现他们选的这个日子有多美好。12 的谐音 ，就是 要爱，这是小明小兰对彼此的承诺，要将这份爱进行到海枯石烂。12 的谐音,还 可以读做是友爱，这是给那些，一路陪他们走到今天的每个小伙伴们的一份致敬 和感谢。12  还有一个谐音 ， 叫永爱，这是要送给爸爸和妈妈的保证，请他们放 心 ，即便结婚了，成家了，长大了，孩子对爸妈的这份爱，也永远是无法制舍， 任何人不能代替的存在。", "body": "“双十二 ”顾名思义指的是每年的 12 ⽉ 12 日继此前双十一”大获成功之后，各 大电商网站推出 12 ⽉ 12 日作为“全民疯抢”之网购盛宴的延续。这是一个较为牵 强的“节日 ”，只是由于“双 11”的大火，意犹未尽的商家们又想出了薅羊毛的好日 子 。但双 12 从字面上理解似乎看起来还挺适合结婚，所以就奉上本篇台词。\n最后一个自然段用了很多的谐音梗，有趣好玩还很有意义，希望能够给到大 家一些参考和灵感。\n\n冬至 ，又称日南至 、冬节 、至岁等，兼具自然与人文两大内涵，既是二十四节气中一个重要的节气 ， 也是中国民间的传统祭祖节日 。冬至是四时八节之一 ，被祝为冬季的大节日 ，在古代民间有“冬至大如年” 的讲法。冬至习俗因地城不同而又存在着习俗内容或细节上的差异。在中国南方地区，有冬至祭祖 、宴饮 的习俗。在中国北方地区，每年冬至日有吃饺子的习俗。\n我很喜欢这篇台词的切入点。从夏天到冬天，从夏至到冬至 ，从年初到年尾，从恋爱到结婚，有季节  的交替，有时光的累积，还有慢慢升华的爱情。冬至节气的特点就是北半球的白天最短，夜晚最长 ，而且  也要开始了一年中最冷的一段时光。但是因为有家人在身旁，不怕风雪侵扰，不怕黑夜漫长，有爱在心里， 无尽的冬夜里也会生长出光亮和希望。最后一个自然段的台词，可以应用于年尾进行的任何一场婚礼中， 做为总结词。这是一种对生活的感悟，对未来的祝福。", "tags": ["也永远是无法制舍", "即便结婚了", "叫永爱", "可以读做是友爱", "台词", "孩子对爸妈的这份爱", "就是", "成家了", "的谐音", "祝福", "节日节气", "要爱", "请他们放", "还有一个谐音", "这是给那些", "长大了"]}, {"id": "l_a08bdd6108", "cat": "节日节气", "title": "64 冬至节气通用婚礼开场词", "body": "(公历 12 ⽉ 21-23 ⽇)\n各位来宾，大家中午好。欢迎各位来参加小明和小兰的婚礼。\n从夏天到冬天，不过是地球绕着太阳转了半圈，从夏至到冬至。不过是阳光  从北回归线划到南回归线。从年初到年尾，不过是本日历撕掉的一页又一页，从  恋爱到结婚，不过是一段关系的升华和转变。今天是冬至，北半球的世界这一天  黑夜最长，白天最短，阳光离我们最遥远。即将拥抱的是一年中最冷的一段时间。 冬至已至，美好的事，也都如期而至。感谢大家，在这个静谧寒冷的季节，来见  证今天这一场温暖的婚礼仪式。\n记得听过一句话我很喜欢，有家人在旁，就不怕黑夜漫长。虽然冬至是最长  的.一个冬夜，但是今天开始他们也将会正式的用丈夫妻子的身份，陪伴对方度  过这个冬至大如年的日子 。因为有爱，心有期待，期待着白天会变得越来越长 ， 期待他们的婚姻，也会从这里迎接明媚的春光，走向未来的温暖。一年四季，寒  来暑往，秋收冬藏。这样的季节真的很适合跟一些温暖的朋友，备下好菜和好酒， 一起来赞颂生活的美好，分享爱和幸福。\n墙上的日历变得越来越薄，生命的岁月却变得越来越厚。愿好运如同日渐回 归的阳光一般，一天一天离我们更近，伴随着新年的到来，让心愿中的美好，全 都有一个新的开始。感大家冬至安康，祝他们新婚快乐。\n\n平安夜又称圣诞夜，即圣诞前夕(12 ⽉ 24 ⽇) ，在大部分基督教会中是圣诞节日的一部分。传统上不少 基督徒会在平安夜参与子夜弥撒或聚会，通常在教堂内举行 ，以表示圣诞日的开始。一些教会则会在晚上 较早时间举行烛光崇拜，通常会有耶稣降生故事的话剧表演，亦会享用大餐。\n平安夜这样的节日对于非基督教的人来说并没有太多特别的感受，只是中国人心中对于平安吉祥的希 望让这个节日在国人心中显得喜闻乐见 。平安夜互送苹果，代表着祝福彼此平平安安，互送橙子 ，代表着 对你称心如意。如果新人的婚礼刚好赶上了平安夜，这段台词可以让节日里的婚礼更有主题感。如果新人 是基督徒，相信定会让本人，或者有信仰的家人亲友心里对婚礼及主持人的认可度提升一个台阶。“平安夜 不是节，只是提醒我们就算日子平凡，也要安安心心的过，要安安稳稳，要不急不缓” 。平安夜的钟声里， 愿每个人都得偿所愿，即将到来的新年，愿每个人都喜乐平安。", "tags": ["仪式", "台词", "开场", "故事", "来宾", "祝福", "节日节气"]}, {"id": "l_a96cc29c5c", "cat": "节日节气", "title": "65 平安夜通用婚礼开场词", "body": "(公历 12 ⽉ 24 ⽇)\n各位来宾，大家好，欢迎各位来参加小明和小兰的婚礼。\n突然发现属于 12 月的仪式感还真的有很多，比如像今天，12 ⽉ 24 号，这是 一个来自于西方宗教的传统节日 ，平安夜。 这个日子 ，一家人整整齐齐的围坐 一起， 共享节日晚餐。人们互赠礼物，表达对彼此节日的祝愿。据说圣诞老人 也是在今晚，背着他装满礼物的袋子，把藏着惊喜的袜子，送给那些满怀期待的 孩子。小明在今天看起来也像一个圣诞老人，他给小兰准备的礼物，就是这场盛 大的婚礼，只是这场婚礼装不进袜子 ，但却可以装进小兰的心里。\n对于中国人来说，平安夜并不算是个什么特别重要的日子，只是一个普通的  一天，一个平凡的冬天。但是店铺橱窗里绿绿红红的贴画，闪闪亮亮的彩灯，挂  满了松果和礼物的圣诞树，还有商场里面叮叮当的旋律，都在制造着生活里的仪  式感。平安夜不是节，只是在提醒着我们就算日子平凡，也要安安心心的过，尽  管岁月平淡，也要安安稳稳，不急不缓。这样的夜晚,家人闲坐，灯火可亲，岁月  静好，未来可期。让我们一起来祝小明和小兰，幸福圆满，平安顺遂。掌声有请， 今天的主人公吧", "tags": ["仪式", "平安夜通用婚礼开场词", "开场", "来宾", "节日节气"]}, {"id": "l_5b65351901", "cat": "节日节气", "title": "66 圣诞节通用婚礼开场词", "body": "(公历 12 ⽉ 25 ⽇)\n各位来宾大家好，欢迎各位来参加小明和小兰的婚礼。\n今天是 12 ⽉ 25 号，祝大家圣诞节快乐。虽然这一天并不是真正属于我们华 夏民族的节日 ，但却因为今天是小明和小兰结婚的日子，所以这一场婚礼多添了 一份欢乐与神圣，也让他们心里今年的圣诞节，多了一份浪漫和温暖。\n说起圣诞节和婚礼的联系，我觉得它们之间有一些共通，比如圣诞节是为了 庆祝耶稣的诞生，是基督教里面一年中最重要的一个节日 。而婚礼，是为了庆祝 婚姻和家庭的诞生，是绝大多数的人，一生中最重要的一个日子。国外的圣诞节 都是火树银花，圣诞树上挂满了礼物，而中国人的婚礼中都张灯结彩，不管是主 人和宾客，每个人的脸上都写满了幸福。传说中的圣诞老人会把惊喜装进袜子里 带给人们，但是我们没有圣诞老人 ，所有的惊喜，全都来自于爱你的人。\n就像小明和小兰从今天开始的这一个夫妻的身份， 应该就是他们为对方准 备的一份最好的圣诞礼物。 好多人在今天互送苹果，但他们送的却是一生携手\n\n的承诺，今天没有圣诞树和拉着雪橇的麋鹿 ，但却有条漫长且通往幸福的旅途。 婚礼开始了，掌声有请新郎，小明人场吧。\n基督教纪念耶稣诞生的重要节日 。亦称耶稣圣诞节 、主降生节，天主教亦称耶稣圣诞瞻礼。耶稣诞生 的日期，《圣经》并无记载。公元 336年罗马教会开始在 12 ⽉ 25 日过此节。12 ⽉ 25 日原是罗马帝国规定 的太阳神诞辰。有人认为选择这天庆祝圣诞，是因为基督教徒认为耶稣就是正义、永恒的太阳。5 世纪中叶 以后，圣诞节作为重要节日 ，成了教会的传统，并在东西派教会中逐渐传开。\n圣诞节无论在国内和国外，都是一个充满欢乐的日子 。虽然这并非是中国人的传统节日 ，而且近今年 我们国家对传统文化的重视，以及外来文化入侵的修正，让这样的节日变得没有从前那样的炙手可热。但 是对于信奉基督教的人来说，圣诞节毫无疑问是一年中最重要的节日之一 。而新人婚礼刚好赶在了圣诞节 来举行 ，就像是欢乐遇见了美好，喜庆遇见了圆满。在台词中我提到一个观点圣诞节和婚姻的共通。一个 是庆祝主的诞生 ，一个是庆祝婚烟的诞生 。一个火树银花，一个张灯结彩。但是心情都是同样的，就是幸 福快乐，惊喜，还有无与伦比的仪式感。", "tags": ["仪式", "台词", "圣诞节通用婚礼开场词", "开场", "新郎", "来宾", "节日节气"]}, {"id": "l_b58fc36e56", "cat": "节日节气", "title": "12 ⽉ 31 日也叫跨年夜，是一年中的最后一天。即将要告别过去的时光，拥 抱一个新的年份。人们在 这天都会举行些庆祝活动，比如燃放烟花， 吃一顿跨年夜的晚餐，一起看一场跨年的电影，或者来一个深 情的吻，一吻就吻过了一年。跨年只是一个时间的概念，真正心里在意的是在每一个值得纪念的日子和时 间，都有重要的人 ，或者爱的人在身边。", "body": "这篇台词是跨年当天婚礼的专属版。12 ⽉ 31 号，他们结婚了，既是把甜蜜的恋爱留在这个给他们无尽 美好回忆的旧时光，也要把一个全新的婚姻和家庭开始在一个全新的充满希望的新的一年。 最后一个自然 段我特别的喜欢，就像是在做一个总结， 对这个即将过去的日子的眷恋，同时还有对未来，有更多美好的 期待。如果用到了这篇台词，则说明一年的时光又过去了。辛辛苦苦了一年，在最后一天好好的表现。画 一个圆满的句号在这里，明天，明年，我们继续努力，继续的发光增彩。祝你新年快乐，一切顺利。多接单, 多赚钱，身体健康,闽家幸福!", "tags": ["一起看一场跨年的电影", "台词", "吃一顿跨年夜的晚餐", "情的吻", "或者来一个深", "日也叫跨年夜", "比如燃放烟花", "节日节气", "都有重要的人"]}, {"id": "l_8509e024d4", "cat": "节日节气", "title": "67 跨年通用婚礼开场词(公历 12 ⽉ 31 ⽇)", "body": "各位来宾大家好。我是主持人 xxx。\n有时感觉，时间很慢，时光很长，好像这年我们走了好久，才终于要看到了  新年的曙光。有时感觉， 日子飞快，岁月很短，365 个日升月落，阴晴冷暖，不  经不觉的便成了过往。眼看着 202X 年的日历已经撕到了最后一页，小明和小兰， 今天的这一场盛大的婚礼，就像是要把一缕灿烂的光亮留在这一年。然后翻开全  新的一页 ，拥抱新的精彩。\n\n普通人的跨年，其实就是对时间的跨越，而今天的两位主人公，却是在跨越 着他们身份和关系的转换。把过往的美好和诗情画意都带到新的一天，把难过和 遗憾的事情都终结在这个十二月 。今天，他们一起等待着跨年的烟花，明天，他 们起等待来年的春秋冬夏。季节，周而复始，循环更迭，而爱，也生生不息，缠 绵而热烈。\n今天是 202X年的最后一天， 又一年的光阴变旧了，但是期待却依然很新。 他们跨越着此刻分分秒秒，也可以跨过余生的漫长岁月 。今晚，当绚烂的烟火璀  璨夜空，那是为他们走过的圆满而升起的一道冬日的彩虹。明天，一个崭新的开  始，一个全新的起点，一个有爱和温度的小家，将从这里，带着祝福，走向未来。 各位，准备好掌声了吗?让我们共同来祝福他们此刻的团圆喜乐，未来的幸福美  满。", "tags": ["公历", "开场", "来宾", "祝福", "节日节气", "跨年通用婚礼开场词"]}, {"id": "l_eb7fef5b7b", "cat": "月份通用开场词", "title": "68 一月通用婚礼开场词", "body": "跨年，告别，迎接，崭新，希望，期待，伊始，周而往复，焕然一新\n\n各位来宾大家新年好，欢迎各位来参加小明和小兰的婚礼。似乎跨年夜的钟  声还在耳边回荡，好像那晚夜空的烟火依然 在眼中闪耀着光亮。它们的意义一  定 不是单纯的为了告别从前，而应该是为了庆祝和欢迎这个新的一年，光临世  界。一元复始，万象更新，这个崭新的一月 ，也许你的生活依旧如常，但也别忘  了要给新年里的自己，许下一个美丽的小心愿。就像小明和小兰这样，结婚是他  们相爱的 X 年一直以来的梦想， 你看今天，梦想成真了，他们也终于得偿所愿。\n在四季中，一月算得上是年中最冷的月份，有三九天，有农历节气的大寒和 小寒，在生活里，一月值得庆贺又拥有希望，焕然新的岁月 ，周而往复的时光和 流年。 好像也在提醒着我们，地球又开始了它环绕太阳飞行新的一圈， 我们也 应该整理过去的日子 ，生活里的碎片 ，准备好一些新的期待。所以幸福的他们， 在这个一月 ，带着过往的故事和相爱的甜，在新年伊始的这一刻，邀请了各位来 见证他们的承诺。\n人生中美好的瞬间有很多，而今天他们的幸福，就是亲人在身边，爱人在眼 前，喜乐记心间，所盼皆如愿。希望这份美好与他们的婚烟一起瓜瓞绵长，也祝 福这对小两口 ，一生相爱，一生相伴。", "tags": ["一月通用婚礼开场词", "开场", "故事", "月份通用开场词", "来宾"]}, {"id": "l_14226f4a1b", "cat": "月份通用开场词", "title": "69 二月通用婚礼开场词", "body": "年味，情人节，立春，成双入对，好事成双，双喜临门 ，福禄双全，比翼双飞\n\n各位来宾大家好，欢迎参加小明和小兰的婚礼，也欢迎各位来到二月 。\n二月不同于其他的季节，没有缤纷的花朵，没有温柔的暖风，但是我们还是 喜欢它。因为二月有浓浓的年味，二月有浪漫的情人节，二月的立春，是一个节 气新的轮回，二月里，还有一段恋爱的故事讲到了圆满的结尾，故事的两位主人 公在二月举办了婚礼，一场婚姻，在此有了开篇。\n中国的语言，数字 2 的谐音代表的是爱，所以 2 月中的每一个日子其实都沾 染了一点点与爱有关的温暖。今天更是如此。我们来见证的这段故事里面，包含 了一个偶然的相识，一份基于了解而生的喜欢，还有建立在喜欢上的爱情，以及 因为爱情而决定相守的婚姻，只是从今天开始，漫长而琐碎的生活会把他们的爱 情，慢慢的升华成为一份更大的爱，这份爱，更坚固更包容，也更加能经受得住 岁月的磨砺和考验。\n中国人的婚嫁观，讲究成双入对，所以 2 这个数字，无形中又成为了良辰吉 日的标配。那就在这个 2 月里，也让我们各位家人，朋友和伙伴，也把这些美好 的祝福都送给他们吧，愿他们好事成双，双喜临门，福禄双全，比翼双飞。谢谢 各位的到来见证，请用掌声请出我们今天婚礼的男主人公。", "tags": ["二月通用婚礼开场词", "开场", "故事", "月份通用开场词", "来宾", "祝福"]}, {"id": "l_5f7ac92730", "cat": "月份通用开场词", "title": "70 三月通用婚礼开场词", "body": "樱花盛放，春寒料峭，春天，春风得意， 春风 ，温柔，小团圆，温暖\n\n各位来宾大家好，欢迎参加小明和小兰的婚礼。今天是 3  ⽉ x 号，(南方:尽 管季节早已是樱花盛放的光景) (北方:尽管北方仍是春寒料峭的天气) ，但还是要 给各位送上一份春天的问候，愿大家在这个美好的三月 ，春风得意，万事顺心。\n不管多寒冷的冬天都阻挡不住春风归来的脚步，一切的等待终会有回响，所 有温柔的好时光都不会被辜负。X 年的情路跋涉，相爱的他们携手走过，终于等 到了终成眷属的这一场盛大的仪式，从此恋人变成家人，故事从一个他变成了他 们， 曾经浪漫和甜蜜一起分享，今后也将要共同的扛起责任。\n途经一朵花的盛开，便懂得了春的浪漫，见证一场婚礼的过程，也如同参与 了一份人间的小团圆。三月之所以美好，是因为他经过了一二月的料峭和清冷，\n\n还有对温暖季节的期待。婚礼之所以令人感到喜乐，是因为恋爱的过程所有的成 长和感动，都汇聚成此刻的终成卷属。人间三月有幸事，既是幸福的事，也是幸 运的事，更是庆幸遇见的缘分，和有幸相爱的故事。各位，期待你们的祝福如三 月的春风一般， 温暖今天的新人 ， 和他们的每一个家人 ， 掌声有请新郎，小 明人场。", "tags": ["三月通用婚礼开场词", "仪式", "开场", "故事", "新郎", "月份通用开场词", "来宾", "祝福"]}, {"id": "l_44c3d16903", "cat": "月份通用开场词", "title": "71 四月通用婚礼开场词", "body": "春光，温暖，盎然，生机，春天，人间四月天\n\n四月春光正好，阳光温暖，微风不操。既不见酷寒隆冬风雪的刺骨，也没有 盛夏七月烈日的炙烤，在荒芜与繁盛之间，草木酝酿着新绿，候鸟忙碌着迁徙， 世界充满着盎然的生机，相爱的人们，也在这样的四月 ， 把一个个大红喜字贴 满了崭新的小家里。恋爱是让两颗心有了归宿，而结婚，是让两个人，有了家的 归途。\n对于小明和小兰来讲，这个四月满是期待和爱，从未有如此的期待过一个春 天的到来，因为今年的这个春天，有他们牵手一生的喜悦。也从未有一个四月能 让他们感受到如此的温暖和团圆，因为爱，凝聚了过去的种种磨合与快乐，因为 爱，共同奔赴的明天里面 ，即便太多的不确定的神秘，他们也愿勇敢向前。因为 爱，他们不忘过往，又不畏将来。\n四月会终结三月的遗憾，也会延续那些未完成的期待，四月开始了一年中第 二个季度，希望不好的事都能变好，好事会变得更加圆满，四月是立夏的前奏， 风吹来的方向在一天比一天偏南，也一天比一天变暖。四月适合兑现一些承诺， 实现一些心愿，也适合埋下一些种子 ， 陪伴它们出芽开花，跟它们一起收获一 个更加丰盈的未来。谢谢各位到来和祝福，你们是爱，是暖，是窗外最好的人间 四月天。掌声送给新郎小明，请他出场吧。", "tags": ["四月通用婚礼开场词", "开场", "新郎", "月份通用开场词", "祝福"]}, {"id": "l_9fc5f40a47", "cat": "月份通用开场词", "title": "72 五月通用婚礼开场词", "body": "初夏，周而住复，按部就班，立夏，小调，暖风和煦，驾飞草长 ，明期，热烈，梦想，芬芳\n\n各位来宾大家好，欢迎各位在这样一个初夏 (将至)来临的五月 ，参加小明和 小兰的婚礼。\n有人说，四月春去，五月夏来，周而往复的时光里，季节在按部就班的变换。\n\n那些春天里面的计划，到了夏天都会的得以实现。每一个温暖而热闹的季节都值 得被纪念，每一段修成正果的圆满的爱情故事，也都是他们各自人生中的经典。 今天在这里，就有一个这样的一个故事要跟大家一起来品读和祝福。故事的主人 公，就是今天的新郎和新娘，幸福的小明和小兰。\n五月真的有太多的美好值得感受。在立夏和小满之间，在春天和夏天的交界， 有感恩妈妈的日子 ，还有 520 这个浪漫的网络情人节。一面日光，一面花香 ，一  边是暖风和煦，一边是莺飞草长。五月还是很多深情相爱的恋人们走进婚姻最多  的月份。所以五月的每一天，都会有爱有温度，有欢笑有幸福。希望五月的这份  灿烂能够填满日子的平凡，当天气一天比一天更加的明媚和热烈，希望每个人都  能离自己的梦想更近一点。也希望小明和小兰从今天开始的全新的生活，也能够  像五月的天一样，愈加的光亮，浓郁而芬芳。各位，婚礼开始了，掌声送给将要  登场的小明吧。", "tags": ["五月通用婚礼开场词", "开场", "故事", "新娘", "新郎", "月份通用开场词", "来宾", "祝福"]}, {"id": "l_209f6481d9", "cat": "月份通用开场词", "title": "73 六月通用婚礼开场词", "body": "仲夏，繁盛挺拔，百花绚烂，快乐，儿童节，回望，向往， 炙热，滚烫，夏天\n时光轻轻浅浅的飘过，不觉已是仲夏之初的人间六月 ，不觉一年已经过了小 半，不觉草木已经繁盛挺拔，不觉已经百花绚烂。每次想到六月似乎总是能把它 跟快乐联系起来，也许是因为六月一号的儿童节，也许是因为它是暑假前的最后 一个月 ， 当真正的站在六月里面 ，除了快乐，更加能感受到一半的回望，还有 另一半的向往。\n回望小明和小兰的来时路，从四目相对的怦然，到爱情降临的心动，从磕磕 绊绊的磨合，到如今内心的笃定和从容。这一段恋爱的历程，有匆忙也有成长， 那么多的塑造改变让他们变成了一个更好的自己，那么多的付出和经营他们拥有 了一段圆满的爱情。而向往却是他们一直在做的事，他们向往能和深爱的对方走 过更多的春夏秋冬，寒来暑往，也向往一去探索星辰大海，诗和远方，更加向往 他们有一天会以彼此的丈夫和妻子的身份，在大家祝福的掌声里，牵手站在各自 的身旁，就如同今天一样。\n六月本身并没有多么的炙热，但是从六月开始，都是一天比一天更加滚烫的 日子，就像婚礼，并不是说两个人的幸福到达了极致，而是将要去寻找更多幸福 的这一段漫长的旅程， 他们才刚刚开始。祝福大家，六月快乐，夏天快乐。祝 福他们俩，新婚快乐。谢谢各位。", "tags": ["六月通用婚礼开场词", "开场", "月份通用开场词", "祝福"]}, {"id": "l_1da1eeae4c", "cat": "月份通用开场词", "title": "74 七月通用婚礼开场词", "body": "姹紫嫣红，火热，热浪，梅雨季，如梦似幻，盛夏，初生 ，成长 ，收获，蕴藏，探索，遇见\n\n一直在想， 该用一个怎样的词汇去形容这个七月 ，说它是美好的七月 ，定 是因为姹紫嫣红的花色装扮了这个多情的夏天，说它是火热的七月 ，定是因为如 火的骄阳在我们头上翻滚着热浪，有种温暖到极致的感觉。说它是浪漫的七月 ， 定是因为梅雨季的缠绵情丝，裹挟着一缕缕清凉随南风降临这个世界。说它是幸 福的七月 ，定是因为今天的这场婚礼，把一段甜蜜的恋爱定格在这个如梦似幻的 盛夏季节。\n7 月把一年分成了两半，前一半是初生与成长 ，后一半是收获和蕴藏，就像  婚礼把人生也分成了不均等的两半，用前一小半去探索遇见，用后一大半来学习  陪伴。时间从来都不会讲话，而 7 月更像一个沉默的魔法师，给远处的青山以苍  翠，给近处的花朵以缤纷，给脚下的草地以繁茂，将一场幸福的记忆，留给你们， 留给他们，留给我们每一个心中有爱的人。谢谢各位如约而至，谢谢 7 月让这份  浪漫和美好，得以发生 ，掌声祝福今天的婚礼，愿它圆满，喜乐，谢谢。", "tags": ["七月通用婚礼开场词", "开场", "月份通用开场词", "祝福"]}, {"id": "l_a3721ab1ee", "cat": "月份通用开场词", "title": "75 八月通用婚礼开场词", "body": "艳阳，缠绵，交织，蒸腾，秋天，七夕，立秋，秋天第一杯奶茶，热烈，期待，风雨同舟\n\n火热的艳阳和缠绵的雨丝交织着蒸腾了一个夏天，七月的热浪还有余温在翻 滚，八月 ，已经温柔的将清爽的风 ，一丝一缕的悄悄的吹向人间。8 月是节气里 面秋天的开始，但是真正的秋离我们还有一点点远。恋爱是小明和小兰故事的开 始，但是走到今天，终成眷属，这个过程也不是一蹴而就，他们用了 X 年。\n8 月也有属于它独有的浪漫，农历的七夕节，牛郎织女的爱情象征着一种坚  贞和执着，热恋的全城处处可见娇艳的玫瑰花。8 月是立秋节气的开始，相爱的  年轻人 ，也一定不会忘记秋天里的第一杯奶茶。8 月的天就像是婚礼中的小明和  小兰，既有相爱的热情，又有成熟的理性。8 月 ，阳光依旧热烈，万事尽可期待。\n季节可以轮换，夏天过了还能重新等到，但是人生却不能重来，所以每一段 旅程都是独一无二的精彩。愿共同走过的恋爱的时光，让小明和小兰记住那些岁 月的美好，婚姻中的每一天，都好好珍惜，好好珍藏，好好的把这一首风雨同舟 的旋律，合唱的动听而默契。好了各位，故事就讲到这吧，掌声该响起了，男主 人公，也该出场了。", "tags": ["八月通用婚礼开场词", "开场", "故事", "月份通用开场词"]}, {"id": "l_fa8e49791d", "cat": "月份通用开场词", "title": "76 九月通用婚礼开场词", "body": "时节如流，夏末，安静，温柔，理性，成熟，风华正茂\n\n夏天的文字写不出九月的故事，时节如流的年岁，每个季节，每个月份，都 有不同的美丽。属于 9 月的特质，夜有清凉，昼有和暖。 日出时燃烧着夏末的灼 灼余温，黄昏后舞动着初秋的深情款款。欢迎大家来到 9 月的时光旅行，今天的 这一场婚礼，也许是我们这段旅行中见过的最美的风景之一。\n9 月的时光总是显得安静而温柔，就像刚刚走过恋爱的他们一样，理性又成 熟。什么是成熟，就是一件事物发展到完善的程度。树上的果子成熟了，吃起来 香甜脆爽，田里的稻谷成熟了，一颗颗的稻米堆满粮仓。长大的孩子成熟了，会 变得懂事又会愿意主动的承担起责任，恋人的感情成熟了，他们会想要一个共同 的家，所以结婚这件事，就会变得自然而然，顺理成章。\n为什么选在 9 月结婚，因为这是一个风华正茂的月份。收敛了盛夏的滚烫和 热烈，长在秋风里的理性和温柔，让人有一种被成熟宽厚的肩膀，轻轻拥抱的感 觉。恋爱七分甜，此刻有 8 分满的喜悦，在 9 月伊始的日子 ，出发向新的征程。 各位，在您的掌声中，让婚礼，有个圆满的开场吧。", "tags": ["九月通用婚礼开场词", "开场", "故事", "月份通用开场词"]}, {"id": "l_0d319a222e", "cat": "月份通用开场词", "title": "77 十月通用婚礼开场词", "body": "秋水天长 ，金风玉露，花开蒂落，累累硕果，秋天，成熟，金色谷穗，桂花香 ，红叶满山\n\n用一段惬意又怡然的长假来打开一一个明媚的十月 。在一个秋水天长的时节， 一个五光十色的世界。用一场浪漫又温暖的婚礼来开启一个温馨的小家，在一个   风华正茂的年岁，一个金风玉露的秋天。人们在过去的几个季节里所有辛勤的劳   作，都是为了在秋风吹过后，让付出有所收获，就像恋爱的开始如同在春天播下   的种子，如今，在小明和小兰悉心的呵护下，当初的种子已然花开蒂落，结出了   象征着喜乐和团圆的累累硕果。\n说起十月的美好几乎全都与秋天有关，而秋天又是一个代表着成熟的季节。 成熟是两个人走进婚姻的必要的前提，而婚姻，是小明和小兰相爱的目的，也是  他们过去的 X 年恋爱的过程中，最大的期待。所以在一起来走的这一段路上，那  些日渐深厚的情感，相扶相携的细节，那些出人预料的考验，和愈加成熟的心态， 每一个都重要而难得，都无比珍贵，都不可或缺。\n十月的秋天缤纷又令人沉醉。不止有金色谷穗，不止有淡雅的桂花香，不止\n\n有红叶满山，不止有秋水天长。还有一份浓浓的爱意，被秋风温柔的散播到这个  城市的大街小巷。所以，便有了此刻，各位的如约而至，谢谢你们的到来和陪伴， 这份祝福，不仅是给他们的婚礼，还有各位朋友和这一家人的情谊，地久天长 。 各位，一起为我们大家鼓鼓掌吧。", "tags": ["十月通用婚礼开场词", "开场", "月份通用开场词", "祝福"]}, {"id": "l_053b639ea9", "cat": "月份通用开场词", "title": "78 十一月通用婚礼开场词", "body": "渐行渐远，深秋风寒，立冬，轮转，纷飞落叶，荒芜萧瑟，生生不息，温暖\n\n天气天比一天变凉，虽然太阳正在和我们渐行渐远，但依然有充足的光亮笼 罩大地。温暖的日子要暂时的离开一阵子了，但是温暖的事，却每天都在发生。 今天各位来参加的这一场婚礼，就是一份炙热的爱情凝结而成的仪式感，因为两 颗相爱的心就像两团火，所以他们不惧怕十一月的深秋风寒，因为有各位家人热 情的祝福，所以即便初冬已(将)至 ，也依然会有一份和煦围绕在小明和小兰的身 边。\n因为 11 月是立冬的节气 ，所以这个月份，就像是敞开了一扇走进冬天的大  门 。迈过这个门槛，就要正式的告别怡人的秋色 ，来到一年中最后的一个季节。 就像婚礼又何尝不是一扇走进婚姻的大门呢?经过了这一场仪式的加冕， 他们俩  就将要变成一对正式的夫妻，从此人间烟火，柴米油盐。季节有春夏秋冬的轮转， 人生也有各种角色的变换，不同的时节有不同的景色，不同的身份，也有不同的  责任和承担。这对小两口 ，从今天开始，要在婚姻的海洋里 ，风雨同舟，扬帆远  行。", "tags": ["仪式", "十一月通用婚礼开场词", "开场", "月份通用开场词", "祝福"]}, {"id": "l_de5b306738", "cat": "月份通用开场词", "title": "11 月的世界里，同样是纷飞的落叶，有的人看到的是荒芜萧瑟的景象，有的  人看到的却是叶子回归大地，等到来年继续 繁茂的那一份生生不息的希望。 所  以，只要把美好装在眼里，你所见的一切，皆是美好。正如小明和小兰的婚姻生  活，在心里装满了喜乐和知足，未来的每一步的方向，都是走向幸福。各位来宾， 用一次掌声，来温暖今天的婚礼吧!", "body": "", "tags": ["你所见的一切", "只要把美好装在眼里", "同样是纷飞的落叶", "月份通用开场词", "月的世界里", "有的", "未来的每一步的方向", "来宾", "用一次掌声", "等到来年继续"]}, {"id": "l_885b79d139", "cat": "月份通用开场词", "title": "79 十二月通用婚礼开场词", "body": "回望，怀念，总结，憧憬，期待，举杯望月 ，圣诞树，钟声，希望，寄托，结束，寒冷\n\n岁月的马车载着我们一刻不停的向前飞奔，稍作停留的这一站，名字叫做十 二月 ，一年中最后的一个月 ，这个特别的时光，很适合回望，怀念和总结，总结 过去的这一年有哪些得到和失去，落寞还是精彩。这个特别的时光，也很适合计\n\n划，憧憬和期待。因为过了这一站，即将要拥抱一个新的年份，生命的日历也要 翻开全新的一页。\n对于小明和小兰来说这一年有怎样的故事，可能没办法在这里一一讲起，可  是这场婚礼，却把一份美好的记忆永远的留在这个即将结束的一年。也许他们想  要在这样的冬天多留存一些温暖的故事，比如大雪的节气，他们举杯望月 ，冬至  的日子 ， 起守候最长的寒夜。 圣诞的时候一起对着圣诞树许个愿，在 12 月的  最后一天，他们会一边牵手倒数，一边聆听着钟声，把更多的心愿和更大的希望， 寄托在新的一年。", "tags": ["十二月通用婚礼开场词", "开场", "故事", "月份通用开场词"]}, {"id": "l_2c9bd55d7e", "cat": "月份通用开场词", "title": "12 月是一年的结束，也是开始。12 月有冬日的寒冷，也有温暖。12  月也许 会有些许遗憾，但更有圆满，12 月的风雪已经来了，春暖花开，指日可待。让我 们和小明小兰一起跨越这个冬天，陪伴他们，也祝福我们大家，都会走向更好的 未来。掌声送给这场 12 月的婚礼，也送给这对幸福的小夫妻，谢谢大家!", "body": "", "tags": ["也祝福我们大家", "会有些许遗憾", "但更有圆满", "春暖花开", "月也许", "月份通用开场词", "月是一年的结束", "月有冬日的寒冷", "月的婚礼", "月的风雪已经来了", "祝福", "都会走向更好的", "陪伴他们"]}, {"id": "l_7ea6eb9d6e", "cat": "季节通用开场词", "title": "80 春季通用婚礼开场词", "body": "春季，四季之一 ，季期在立春至立夏之间。春，代表着温暖、生长。\n各位来宾大家好，欢迎各位在这样一个风光明媚的春天，赴约前来，参加小 明和小兰的婚礼。\n说起春天这个季节，好像听来就让人觉得很着迷，迎春爬满了枝头，飘散着 淡淡香气。微凉的风里也夹杂着一丝丝温柔。谁说春风不解风情，你看，这不是 吹来了有情人终成眷属的好消息。历经了一个冬天的等待和准备，小明和小兰的 这一场婚礼，在这个春日时光，如愿以偿，如期而至。\n春天的到来，意味着四季又开始了一个新的轮回。虽然它没有夏天的热烈， 没有秋日的缤纷，没有冬天的静谧，但是春天却是这一切美好的开始。就像相爱  的小明和小兰 ，他们都并非是两个天生完美的人 ，但是他们渴望会有更好的陪  伴，于是他们感受，他们倾听，他们适应，他们改变，他们努力的让自己成为了  这个世上最适合他的爱人，成为一个优秀且无人能代替的另一半。所以，完美的  爱情并不是爱的人无可挑剔，而是会在对方的身上，看到希望，看到幸福的可能， 看到更远的未来。\n\n尽管春天有着清风细雨的浪漫，但也不及各位家人，朋友和伙伴，一路陪伴  的暖，在这个幸福绽放的季节，祝愿他们的爱和婚姻，永远如此刻般，春意盎然， 春暖花开。", "tags": ["季节通用开场词", "开场", "春季通用婚礼开场词", "来宾"]}, {"id": "l_20a8e9fe37", "cat": "季节通用开场词", "title": "81 夏季通用婚礼开场词", "body": "夏季，四季之一 。季期在立夏和立秋之间。夏，代表着热烈，繁盛\n如果有人问，这人间最美好的东西，我相信夏天，绝对算的上一个。午后的  蝉鸣，雨后的天晴，冰镇的汽水，草莓味的冰淇淋。都会让我们感受到这世界的  美好。四季不断更迭变化，我们都没有办法永远的留住他，但是小明和小兰却能  够把这个夏天永远的留在记忆里。每次想到他们婚姻的开始，回忆起婚礼的举行， 都一定会想到这个百花盛放的浪漫季节。好多的花都是开在夏天里，比如他们手  捧里的玫瑰，但是最美的一朵，却是今天成为新娘的小兰，惊艳的盛放在所有人  的眼前，盛放在她人生最好的年纪。\n选择在这样的日子结婚，或许是他们特别的喜欢这样的季节，也或许是因为 特别的符合他们的爱情。正午的阳光热烈又火辣，多像热恋时候的他们，有一种 燃烧切的激情。 而清晨的风又很和照，就像两个人在平凡的生活里互相陪伴和 彼此照应。当伤晚的风 ，吹来丝清凉，让人觉得舒服又惬意，那是他们面对未来 时，有一半幸福的懂憬，有一半温柔的理性。夏天的天气，有风和日丽，有维绵 细雨 ，婚姻和日子也同样如此，有一半的鸡毛蒜皮 ，还交织半的喜乐和甜蜜。\n用一首歌来做为他们婚礼的主题曲吧，夏天的风，他们永远记得，清清楚楚 的，说你爱我。就让这份爱，被夏天的风 ，吹到世界的每一个角落，填满他们未 来的每时每刻。各位，祝福这一场夏天的婚礼，圆满，喜乐。", "tags": ["夏季通用婚礼开场词", "季节通用开场词", "开场", "新娘", "祝福"]}, {"id": "l_7666692b3f", "cat": "季节通用开场词", "title": "82 秋季通用婚礼开场词", "body": "秋季，四季之一 ，季期在立秋和立冬之间。秋，代表着成熟，收获\n感受着夏日的热情好像还在不久的昨天，秋天的风就悄无声息的让季节改换  了名字。各位秋天好，欢迎大家参加小明和小兰的婚礼。秋天好，不止是一句问  候，在我看来，秋天好看，满山秋叶绚烂缤纷，红黄蓝绿的色彩像是在精心的装  扮着这个世界的外套。秋天好听，清凉的风摇动着树枝，轻抚着落叶，一起构成  了这个季节独特的奏鸣曲。秋天好闻，桂花和月季的香，秋雨中仿佛都暗藏着一  缕芬芳， 秋天还会让人有一份好心情。爸妈的好心情因为见证了宝贝们的婚礼，\n\n小明和小兰的好心情是他们终于成为一对夫妻，而我们大家的好心情，是能够在 这样一个收获又成熟的季节里 ，来祝福幸福，来见证一份修成正果的爱情。\n秋天其实是藏在酷暑和严冬之间的一段温柔的时光，这段时光流淌过蒹葭苍 苍的白露时节，在秋分的那一天平分了昼夜，这段时光让冬天慢慢的苏醒，也让 人们渐渐地忘记夏天的热烈。这段时光，承载了小明和小兰故事的圆满，帮助他 们把婚姻开始的季节，镌刻在彼此的生命里面。这段时光，有天高云淡，有秋雨 绵绵，有硕果累累，有花开花谢，还有两个年轻人的成长 ，和成家的喜悦。各位 来宾，掌声响起，送给婚礼，送给新郎小明。", "tags": ["季节通用开场词", "开场", "故事", "新郎", "来宾", "祝福", "秋季通用婚礼开场词"]}, {"id": "l_ac85ed3e1e", "cat": "季节通用开场词", "title": "83 冬季通用婚礼开场词", "body": "冬季，四季之一 ，季期在立冬和立春之间。冬，代表着收敛。蕴藏\n冬天到了，气温从清爽变得有一点寒凉。 好像我们生活的这座城市也少了  几分喧器，多了些许的宁静和安然。冬天并没有其他的几个季节那样的缤纷多彩， 但是暖阳下的光亮，或者初雪后的素裹银装，都会使人沉浸于这个冰清玉洁的世  界。寒冷的季节，我们应该去找一些温暖的人 ， 恰好，在这里遇见了你们。萧  瑟的冬天，我们应该去经历一些温暖的事，恰好，这场婚礼在这个深邃又纯粹的  隆冬里面 ，如约而至。\n一年四季，寒来暑往，周而往复的更迭变化，每个季节都有属于它的浪漫。 人生也同样，无论青春懵懂，或者风华正茂，每个年纪也会有它的精彩。正如这 场婚礼在冬天举行 ，他们要共同守在一个新的小家，去度过冬至的漫长冬夜，要 一起迎接欢乐的圣诞节，要在跨年的晚上看烟火，许下心愿，在一月的第一缕阳 光中去拥抱新年的到来。\n未来人生中他们互相陪伴的每一年，都会迎来一个 新的冬天，季节都是同  样的，但是一定会有不同的心境。他们会有更多的收获，更深的感情，他们会有  自己的孩子，也必定会经历更多的风雨。所以冬天，一定会让他们有特别的感受， 因为漫长的故事，就开始在这里。冬天，是他们执子之手的元年，也是他们与子  偕老的起点。各位来宾，欢迎大家的到来，请用一次热烈的掌声，开始今天的婚  礼吧!", "tags": ["冬季通用婚礼开场词", "季节通用开场词", "开场", "故事", "来宾"]}, {"id": "l_9c9d0dab94", "cat": "星座通用开场词", "title": "84 白羊座通用婚礼开场词", "body": "3 ⽉ 21 ⽇ ~4 ⽉ 20 ⽇\n出生在 4 月的小明是一个白羊座的男生，一个不折不扣的乐观主义者，与生 俱来的快乐和阳光的性格，也让他比其他人看起来都幸运很多。别的方面我并不 了解，但是对于搞对象这件事，真的应了前面的那句话，遇见小兰，一定算的上 是幸运之神对他的眷顾吧。\n每一个白羊座的人其实对正义和美好事物的渴望都是最强烈的，他们希望自 己的每一件事情都可以做好，更加希望能得到爱人的表扬和认可。所以在恋爱的 这 X 年的过程里面 ，小明很努力的做了一个优秀又合格的男朋友 ，他希望能给 到爱人他认为自己做的最棒的所有。\n白羊座人都有一个共同的特点，是他们单纯却一点都不笨，他们热情还有着 强烈的自尊，他们积极却更加希望得到肯定，他们开朗却又豁达的很有分寸。他 们都有着很强烈的占有欲，也会主动的追求爱和用心的珍惜感情，这些他们认为 的最宝贵的东西。比如就像小明对小兰的这份迷恋和喜欢，不仅直率，也更加慷 慨。", "tags": ["开场", "星座通用开场词", "白羊座通用婚礼开场词"]}, {"id": "l_3494b8ce88", "cat": "星座通用开场词", "title": "85 金牛座通用婚礼开场词", "body": "4 ⽉ 20 ⽇-5 ⽉ 20 ⽇\n我们今天故事中的男(⼥)主角是一个金牛座。顾名思义。 他的身上有时候也 会体现出一种牛样固执和低强的性格。但是。对于感情来说，这并不是缺点。因 为一旦认准了一条路 ，就会坚持着走下去。认可了小兰这个爱人 。也会心无旁 骛的不离不弃。他们不喜欢生活里面有太多的变化。所以金牛座的小明。喜欢稳 定的爱，持久的关系，绝不会轻易的放弃，令他投人和付出过的感情。\n有人说金牛座的人抠门 ，物质，爱算计。为什么叫金牛啊?因为对金钱的敏 感，对理财的兴趣，是这个星座的天性。他们爱攒钱，不是为了什么安全感。因 为他对自己认可和喜欢的另一半付出的再多都不会介意。 所以每一个金牛看起 来都像是一个精致的利己主义者，但是小兰却有着深刻的体会，他其实利不只是 自己 ，利的还有被金牛爱上的你。\n金牛座的人都善于经营，比如经营关系，经营感情，经营事业，经营家庭。\n\n强烈的道德感会让他们对责任有着深刻的认识，坚守的原则性，也让他们对自己 在婚姻生活里的角色，永远保持着一个清醒的头脑，和更多的理性。因为过于务 实，所以常被抱怨不够浪漫，因为性格慢热，所以常被吐槽不解风情。但是金牛 座的小明究竟是一个怎样的爱人，相信只有小兰最有发言权。对他的评价不用什 么语言 ，因为跟他结婚，就已经是最好的答案。", "tags": ["开场", "故事", "星座通用开场词", "金牛座通用婚礼开场词"]}, {"id": "l_5bc5f43e88", "cat": "星座通用开场词", "title": "86 双子座通用婚礼开场词", "body": "5 ⽉ 21 ⽇-6 ⽉ 21 ⽇\n不同的星座往往都具有着截然不同的属性，比如有的很物质，有的很现实， 有的很细致，而双子座，绝对是最感性的一个存在。小明(小兰)就是一个这样的 星座。 双子座的人有一个最大的特点，就是凡事都相信感觉，他们选择爱人看 重的不是外在有多帅多好看，或者内在有多么深厚的内涵，也许这个人并不是一 个十全十美的，甚至还有一些小缺点，但是只要感觉对了，他们会奋不顾身的跳 进爱河，来开始一段恋爱。\n双子座的人心里都像住着一个小孩子 ， 时而理性，时而感性，时而任性， 他们讨厌一成不变的生活，会古灵精怪，会调皮捣蛋，也会在夜深人静的时候多  愁善感。所以双子座的小明之所以如此深爱着小兰，并不仅仅是因为这姑娘对他  总是很理解，而是因为她会在他快乐的时候做他最好的玩伴，一起品尝爱情的甜， 也会在他缺乏耐心或情绪失控的时候，在他的身边给他安静的陪伴，让他不会觉  得没有安全感。\n小兰说，双子座的男生最大的温柔就是会特别的愿意照顾别人的感受，相比 物质生活，他们更注重精神世界，也总是会在大人和孩子，热情与温柔，感性和 理性之间无缝切换。他们的爱情观就是这三种，快乐，值得和成就感。他们的眼 中的未来，不是遥远而未知的岁月 ，而是认真的过好当下的每一天，才是他们向 往的美好和精彩。", "tags": ["双子座通用婚礼开场词", "开场", "星座通用开场词"]}, {"id": "l_1183622af8", "cat": "星座通用开场词", "title": "87 巨蟹座通用婚礼开场词", "body": "6 ⽉ 22 ⽇ ~7 ⽉ 22 ⽇\n每年的 6 月下旬到 7 月下旬之间出生的人是巨蟹座。比如今天的男主角小明 (女主角小兰) 。他们于盛夏之初来到这个世界， 巨蟹的形象是举着两个大大的钳 子在保护着自己，他们有一件坚硬的外衣，也有着一颗柔软的内心，所以给人的 印象都是外刚内柔，不好接近。但是走近了他们，就会看到巨餐座的人 ，身上的 那些可爱的方面 。比如很顾家，很懂事，很温暖，很心软。除了这些，他们也常\n\n常会不小心的得罪人 ，会情绪化，会很敏感。不管是优点还是特点，究其根本， 所有的特质都是因为，他们太过于缺乏安全感。所以能够让这样性格的人决定要 走进婚姻的，不用怀疑，小明(小兰)一定是遇到了一个能让自己放心且依赖的另 一半。\n我身边有很多巨蟹的朋友，他们都很周全，很在乎别人的看法，很照顾别人  的感受，相信小明(小兰)  一定也是一个这样的人。有趣的是，巨蟹座是一个极度  需要被理解的人，但却给了别人最大限度的理解，巨蟹座极度缺乏安全感，但是  却给了别人最大的满足和安全感。小兰(小明)在恋爱当中一个很深刻的感受，她  (他)拥有的绝对是一个忠诚善良，又实心实意的爱人，只要能给到他足够的耐心， 足够的理解，他就会还给自己 ，十倍的体贴，和百倍的温暖。", "tags": ["巨蟹座通用婚礼开场词", "开场", "星座通用开场词"]}, {"id": "l_5d5f0ac889", "cat": "星座通用开场词", "title": "88 狮子座通用婚礼开场词", "body": "7 ⽉ 23 ⽇-8 ⽉ 22 ⽇\n还记得很多年前听过一首歌，七月份的尾巴，你是狮子座，八月份的前奏， 你是狮子座。在七月和八月间，这就是狮子座的人出生的时间。也许就是沾染了 出生的夏天时，那个季节的火热，所以狮子座的人，也都拥有着阳光热情，自信 大方的性格。 狮子座的小明(小兰)就完美的诠释了这一份特质。而且他还有一个 很大的优点，就是爱憎分明，一个浪漫的理想主义者。\n有人说狮子座的人在爱情里面有一点霸道和傲娇，没错，在喜欢的人面前， 他们永远都会像一个三岁小孩，因为对方给他的爱和陪伴，能够治愈狮子所有的 不安和委屈，也会让他变得有一点任性的肆无忌惮。狮子座的小明(小兰)常常会 不小心弄丢了耐心，但是爱人能给他足够多的包容，可能也常常会因为小事跟对 方争吵，但是爱人能给他足够温柔的理解，和足够温暖的拥抱。\n自己的另半是狮子座，是一种怎样的体验，小兰(小明)了给我一个满分的答 案 。他说 ，我懂他逞强里的柔弱 ，所以会给他精神上的支撑;我懂他快乐里的优 伤，所以会给他心灵上的呵护;我懂他偶尔的不讲道理，尊重他心里的做娇和眼 中的期盼:我懂他心路走向何方 ，所以会和他风雨同行 ，长路携手 ，一生相伴。", "tags": ["开场", "星座通用开场词", "狮子座通用婚礼开场词"]}, {"id": "l_adff88bec7", "cat": "星座通用开场词", "title": "89 处女座通用婚礼开场词", "body": "8 ⽉ 23 ⽇-9 ⽉ 22 ⽇\n说到秋天这个季节，大家一定能联想到成熟， 如果用在人的身上，则似乎 代表了一份清醒和理性。在秋天出生的处女座，也真的刚好就像是这样的性格。\n\n不知道大家发现了没有，但我估计小兰(小明)对他另一半，应该是会有这样的评 价。\n这个星座天生自带着强迫症，他们对于公平正义有很高的崇尚，对于完美的  事物有旺盛的追求，对于自己的主观标准， 有着近乎偏执的坚持。所以对待感  情，也会一丝不苟， 严肃认真。有人觉得处女座的人有一个特点就是喜欢吹毛  求疵，其实他们只是比其他人更重视细节，眼睛里不揉沙子。不愿意将就，让一  切井并有条才是他们的生活态度。不止是有现实中的洁癖， 精神上也同样如此。 所以处女座的人尽管看起来有一点挑剔， 但是他们的忠诚和专情，也是一份难  得又珍贵的特质。\n处女座的人还有一个最大的优点就是他们独立且清醒，他们不会谈没有把握 和未来的感情。一旦认定了一个人，他们会主动的磨合和适应，就像我们今天婚 礼中的小明(小兰) ，从一开始在一起，其实就已经做好了要和对方走进婚姻的准 备，只是他们需要一点时间让感情变得成熟和坚固，让彼此更加合拍和默契，却 也一刻不停的为了今天的婚礼做着富有成效的努力。所以我想说，处女座的小明 (小兰) ，真的算得上是情人眼里的掌上明珠，婚姻生活里的理想伴侣。", "tags": ["处女座通用婚礼开场词", "开场", "星座通用开场词"]}, {"id": "l_4f4236ea8c", "cat": "星座通用开场词", "title": "90 天秤座通用婚礼开场词", "body": "9 ⽉ 23 ⽇ ~10 ⽉ 23 ⽇\n如果你见过这样一种人，他可以一直保持优雅，总是彬彬有礼，他能够温婉  善良，也特别随性可亲，很重感情，很讲义气 ，那他很有可能是一个天秤座。这  是十二个星座里面最注重平衡和公正的星座。正如我们今天婚礼的新郎小明(新  娘小兰) 。虽然有那么多闪闪发光的地方 ，但却不代表他们就没有短板 ，比如 ， 天秤座的人都很容易纠结，有一点优柔寡断。不过也会有例外，就像选择自己的  爱人，小明(小兰)这一次， 不仅坚定，而且独具慧眼。你看这份终成眷属的恋爱， 就为他做了一个最好的证明。\n尽管很多人都说天秤座的人天生都是选择困难症，这一点拥有天秤爱人的小 明(小兰)却又很发言权。他说，虽然小事上他总是没有主见 ，但是大事上，却特 别有自己的原则。而且还有着超强的沟通能力 ，和适应能力 ，超高的审美眼光， 和一个还不错的好脾气。他给爱人带去的安全感不止是与世无争的性格，还有爱 好和平的柔软内心。两个人在一起的时候他们难免会有分歧，但是往往天秤会主 动的妥协;而矛盾的发生也肯定不可避免，往往天秤会表现的很随性。\n天秤座的理性让他们有着超强的正义感，对于很多的事情都会用心里的标尺， 来捍卫对公平公正的坚持。只有一点除外，就是对小明(小兰)的这份爱，他不会   计较究竟谁付出的多一点或者少一些，只要能让自己爱的人感受幸福，再多的付   出，他们也心甘情愿。", "tags": ["天秤座通用婚礼开场词", "开场", "新郎", "星座通用开场词"]}, {"id": "l_af7286e5de", "cat": "星座通用开场词", "title": "91 天蝎座通用婚礼开场词", "body": "", "tags": ["天蝎座通用婚礼开场词", "开场", "星座通用开场词"]}, {"id": "l_8268a064cc", "cat": "星座通用开场词", "title": "10 ⽉ 24 ⽇-11 ⽉ 22 ⽇", "body": "在十二个星座里面有这样的一种存在， 他们冷静而热情，高傲又胆怯。有  时候觉得很难走进他们的内心，而有时候又能感受到他的深情，这就是神秘又富  有魅力的天蝎座。在我的印象里面天蝎座的人都有一种很特别的气质，认识小明  (小兰)后，又加深了我对这个观点确信。小明(小兰)出生在秋末冬初的十月和十  一月间。萧瑟的季节给天蝎座塑造了几分沉默的冷静和清醒的理性。很多的时候， 他喜欢把情感深藏于内心，只有当他感受到对方的关怀和温柔，引燃了自己的爱  和热情，才会敞开紧闭的心门 ，并将会专一的将爱进行到底 。\n尽管很多相信星座的人都觉得天蝎座冷漠，难以捉摸，不好接触，但是小兰 (小明)会给你一个不同的解读。因为她遇见的这个天蝎，时而成熟，冷静而又充 满逻辑，时而像一个小孩子 ，单纯又温暖，细心又体贴。\n天蝎座的人都有着很强烈的自尊，且他们都极具城府，爱憎分明。当他能够 主动放弃尊严和城府去表达喜欢的时候，一定说明这份爱意已经根植内心深处， 一定说明这是他深思熟虑后的行动，也一定说明他已经做好了准备去接纳对方的 全部， 不管是优点还是不足 。所以当小明(  小兰)向爱人表白的那一刻，便意味 者这个天蝎男孩放弃了心里的做娇，遵从于自己不为人知的心动。他相信并且愿 意将那些看似冷漠的小个性都点燃，燃成宠爱，燃成深情，燃成感动，燃成生的 温暖，填满他们未来漫长的，婚姻旅途中。", "tags": ["星座通用开场词"]}, {"id": "l_d5b5fe2cf5", "cat": "星座通用开场词", "title": "92 射手座通用婚礼开场词", "body": "", "tags": ["射手座通用婚礼开场词", "开场", "星座通用开场词"]}, {"id": "l_ff3b2c7643", "cat": "星座通用开场词", "title": "11 ⽉ 23 ⽇-12 ⽉ 21 ⽇", "body": "虽然射手座的人都是冬天出生，但是他们身上的那种积极向上，开朗热情就 像一轮盛夏的骄阳一样在人群中散发光芒，带去温暖。他们是值得信赖又可靠的 好朋友，也是个坦率直接，真诚又宽厚的另一半。出生在 12 月的小明(小兰)就是 一个这样的射手座，和他出生的那个阴霾的冬天不同，这是一个喜欢分享，爱传 播快乐的大男孩(小姑娘)。\n跟射手座的人谈恋爱，你定不会觉得生活很沉闷，他就是像是一个大孩子一 样，会脆弱，会撒娇，会情绪化，会无理取闹。会贪玩，却可以为了爱他人的戒 掉很多的玩乐，尽管崇尚自由，也可以为了他爱的人放弃很多的诱惑。不管是对 人对事，对待感情，射手座的小明(小兰)有着一份认真正义的优秀品质，且决定 的事，不会轻易的反复，并为此负责。\n\n射手座的人之所以特别的招人喜欢，是因为他们都比较幽默，对朋友重义气， 对工作有行动力，他喜欢把负面的情绪都留给自己慢慢的消化，而把积极向上的  正能量都传递给身边的人 。所以即便有的时候过度的理想化，盲目的乐观主义， 也是因为他对关好的事物都有着很强烈的向往和信心。和一个射手在一起，不会  有太多的悲观和消极，因为有他，生活会变得有新意，有生气 ，有风和日丽，有  欢声笑语。", "tags": ["星座通用开场词"]}, {"id": "l_675e5d78d0", "cat": "星座通用开场词", "title": "93 摩羯座通用婚礼开场词", "body": "", "tags": ["开场", "摩羯座通用婚礼开场词", "星座通用开场词"]}, {"id": "l_eccccacfb2", "cat": "星座通用开场词", "title": "12 ⽉ 22 ⽇ ~1 ⽉ 19 ⽇", "body": "摩羯座的人出生的日期是从冬至开始到新年之后，也许是受到寒冷的天气的 影响，他们的个性也大多内敛深沉而保守，时常会觉得孤独。面对喜欢的人，也 可能会缺乏足够的自信心 ，再加上天生慢热，不爱表达，所以爱情对他们来说， 是一-件极 其难得的礼物。说到这里 ，真的要谢谢小兰(  小明) ，能够读懂爱人， 酷酷的外表下，藏在内心里面的一份柔软，能够理解他总是陷人感性和理性的矛 盾，现实和理想的两难。\n有人说固执是摩羯座的缺点，但是对于跟小兰的爱情来讲，小明的固执却是 他专一的体现。认准了这个爱人，认定了这份爱情，他真的在踏踏实实，全心全 意的经营着属于两个人的浪漫。可是由于性格保守又谨慎，让他的每个决定都需 要深思熟虑，甚至犹豫不决。而习惯性的评估一切，是摩羯的最大的特点，只有 确定了成功的概率更大 ，才会主动的去表达喜欢和爱。但是也会有例外的存在， 比如小兰在他世界里的出现，就让这个凡事按部就班的人 ，变得不顾一切。\n绝大多数的摩羯座都是天生优秀的工作狂，小明也是一样。浓厚的家庭观念， 还有背负的责任感，让他乐此不疲的为爱的人投身事业，为他们创造更好的生活， 而努力的拼搏。过去的时光里，用他的率真托起了和小兰圆满的爱情，在未来的  岁月中，相信会用一个摩羯座的忠诚，去捍卫和保护他们从今天成立的这个小家  庭。", "tags": ["星座通用开场词"]}, {"id": "l_597ec8ced5", "cat": "星座通用开场词", "title": "94 水瓶座通用婚礼开场词", "body": "1 ⽉ 20 ⽇ ~2 ⽉  18 ⽇\n我们生活的现代社会充斥着物欲横流的价值观。就连爱情也被套上了物质的 外衣，经济实力和生活条件，是现代人选择对象的一个优先的选项。可是在十二 个星座当中，有一个，却像是一股清流，他们对待另一半选项的排序，财富和地 位并没有很靠前，而更看重的是精神的门当户对，会把吸引和欣赏当做是爱情的\n\n必要条件。这就是水瓶座。\n水瓶座的小明在遇见小兰之前，其实并没有给自己的另一半设置过怎样的标 准，风象星座的人，有时候就连他们自己都觉得思想无法预测，难以捉摸。他喜 欢用创新的思维去刷新固化的墨守成规，喜欢不断地变化着生活方式，让它始终 保持新鲜的滋味。突然当小兰闯进了他的生活，这个像风一样的水瓶座，一下子 变得现实又安稳。他脚踏实地的跟着爱人的步伐， 一步一步的坚定， 似乎觉得 人生都因为她的出现变得多彩而完整。\n这是一个天生的理想主义者，不折不扣的有趣的灵魂。崇尚自我，性格自立， 热爱自由，但是这些在他遇见一个心悦诚服的爱人后，全部都可以放弃。自我会  变成共情，自立会变成依赖，自由也会慢的转化成为想要和喜欢的人常常站在一  起 。但不会放弃的 ，是他天马行空的创造和想象力 ，随心所欲的酒脱与不料:不  管是恋爱还是婚姻，这都是水瓶座的小明，令人吸引和着迷的人格魅力。", "tags": ["开场", "星座通用开场词", "水瓶座通用婚礼开场词"]}, {"id": "l_41d0c5c448", "cat": "星座通用开场词", "title": "95 双鱼座通用婚礼开场词", "body": "2 ⽉ 19 ⽇ ~3 ⽉ 20 ⽇\n如果把爱情比作一片海，不同的星座都是这片海里面的鱼 ， 我相信游的最 快乐的，一定是双鱼座， 他们就像是为了这片海而生 。不是所有完美的爱人都 是双鱼座，但是很多的双鱼，却都是完美的爱人。就像我们今天婚礼中的新郎小 明。\n双鱼座的人表面看起来都温和儒雅，有礼有节，但是内心里，都希望能拥有  一份极尽灿烂和热烈，极尽深情和温暖的爱。所以这个星座的小明，不仅有着可  爱的感性的一面，还有丰富的想象力，以及足够厚重的深情。在恋爱的过程里面， 相信小兰也一定深切的感受到身边有一个双鱼座，是一种怎样的浪漫，他懂得爱， 渴望爱，分享爱。他不在意谁付出的多或少，只希望能让他的爱人能够体会到来  自他的，这世界上最好的情感。\n双鱼座有着超强的直觉力，他能够判断出来自己会在某一件事上吃亏或者占  便宜，但是他不喜欢计较。因为双鱼都很重情义。对朋友不自私，对爱人不多疑。 喜欢设身处地的替别人着想，喜欢以共情的方式去衡量每一种关系。不管你跟他  拥有的是友情还是爱情，一定都会很喜欢这个星座的人。小兰应该可以感同身受， 被一个这样的男生宠爱着，陪伴着，除了幸福，最大的感受，一定是幸运 。", "tags": ["双鱼座通用婚礼开场词", "开场", "新郎", "星座通用开场词"]}, {"id": "l_0ba16a4835", "cat": "婚礼那天", "title": "96 婚礼那天是新郎的生日", "body": "各位来宾大家好，欢迎参加小明和小兰的婚礼。我猜这个日子，肯定是这个  男人有生以来，收到最多祝福的一天了。从早上到现在，快要被淹没在新婚快乐  的恭喜声中，可能大多数 的朋友并不知道，其实每一年的今天，他都会被满满  的，温暖的祝福所围绕。会不会有人觉得奇怪，但也有家人露出会心的微笑，他  们可能已经知道了答案。今天不仅是小明新婚之喜的日子，也是他 XX 岁的生日 。\n把婚礼定在自己的生日 ，不知道是谁的主意，真的是一个很棒的想法，仿佛  在用行动向爱人宣告，他生来，就是为了等待这一天。这一天，他要感谢老爸老  妈给他生命，要感谢家人们陪他长大，感谢各位朋友如既往的帮忙鼓励，而最重  要的，其实是想感谢一个姑娘， 在一个如此重要而特别的日子，成为他的妻子， 让他幸福，给他婚姻，让所有重要的人都来为他的生日祝贺，为他们相守一生的  承诺证明。\n今天的生日蛋糕，也是婚礼蛋糕，希望婚姻中的每一天都会高高兴兴，甜甜 蜜蜜。今天的生日快乐歌要换成婚礼的进行曲。生日是一个人的快乐，但是婚礼 是两个人的欣喜。婚姻更是两家人 ，因为爱而融合到一起。所以今天我们大家就 -起来祝福小明生日快乐，新婚快乐，祝福他们的生活，平安快乐，顺心如意!谢 谢各位。有请今天的新郎官，小寿星，小明登场。", "tags": ["婚礼那天", "婚礼那天是新郎的生日", "新郎", "来宾", "祝福"]}, {"id": "l_4c9e8d29d4", "cat": "婚礼那天", "title": "97 婚礼那天是新娘的生日", "body": "各位来宾大家好，欢迎参加小明和小兰的婚礼。生活里面总有些日子在我们 心里很特别，即便在其他人的眼中它平凡又普通，对小兰的爸爸和妈妈来说，今 天就是一个与众不同的日子。在整整 XX 年前的今天，他们的宝贝女儿来到这个 家，就 像一个天赐的礼物一般， 照亮了他们的生命，温暖了家庭，也牢牢的系 紧了他们夫妻之间，这条爱的纽带。XX 年后，又是这个日子 ，他们的宝贝结婚 出嫁，拥有了自己的家，就像一棵枝繁叶茂的小树一样，挺拔在阳光下，矗立在 风雨中。今天是小明和小兰结婚的日子，也是小兰 XX 岁的生日 。今天既是她人 生开始的纪念，也要承载婚姻和幸福的新生。\n在小兰成长的岁月中，每一年的生日肯定都会收到许多的礼物。但想必应该 不会有哪一份礼物会比今天更加的盛大。今年的生日里，有皇冠，有白纱，有爱 人 ，有爸妈，最亲的家人都在，最好的姐妹和朋友也都这里陪伴和守护着她。我\n\n问小明，老婆生日和婚礼纪念日是同一天，会不会庆幸以后送礼物的日子少了一  个?小明说不会，以后每年的今天都会准备两份，一份是送给婚姻纪念的礼物， 另一个是爱人生日的专属。其实嫁对了人，其他的都不重要，因为他就是最好的  礼物，有他在身边，幸福的不止每年过的生日 ，而是和他一起，每天都过的日子。 今天这场双重的幸福，希望可以让小兰感受到双倍的快乐。各位，我们响起掌声， 有请今天的主人公，上场吧。", "tags": ["婚礼那天", "婚礼那天是新娘的生日", "新娘", "来宾"]}, {"id": "l_09bd75d321", "cat": "婚礼那天", "title": "98 婚礼那天是新人父母的生日", "body": "各位来宾大家好，欢迎参加小明和小兰的婚礼。记得看过一段话，说这个美  好的世界，就是每一对父母送给自己的孩子最好的礼物。但同时我也想说，每个  孩子 ， 也是这个世界送给一对父母 ，最好的礼物。如果你要问为人父母的他们  喜欢的礼物是什么，相信最多的答案，一定是， 希望他们的孩子 ，能够健康， 平安，幸福。各位知道为什么今天的婚礼要从这个话题开始吗?因为这一场仪式， 是两个孩子送给他们的父母的一份生日的祝福，今天是小明(小兰)爸爸(妈妈)的  生日 ，相信现在坐在这里的他(她)，一定收到了有生以来， 最棒的一份生日的礼  物。\n今天我们来参加小明和小兰的婚礼，都会送上一句新婚快乐，其实我们祝福 的不止是他们的新婚，而是希望他们婚后的每天都能快乐。而今天我们来祝福小 明(小兰)爸爸(妈妈)的生日 ，也都会道上一声生日快乐。这句祝福又不只是生日 的那天，而是但愿他有生的日子每一天都快乐。结婚跟生日不间但其实却又都是 承载着幸福快乐的祝福和希望。所以就让我们共同来祝福今天婚礼的他们俩，思 爱有加，成双成对。祝提今天生日的老爸(老妈) ，健康平安，快乐万岁。还要祝 福来到这里的热情的你们，古祥如意，称心顺连。拿声明起，正式走进，今天的 婚礼。", "tags": ["仪式", "婚礼那天", "来宾", "父母", "祝福"]}, {"id": "l_518724ae6d", "cat": "婚礼那天", "title": "99 婚礼那天是恋爱纪念日", "body": "各位来宾大家中午好 ，欢迎各位来参加今天的婚礼 。今天是 XX年 X ⽉ X  号，小明和小兰结婚的日子。对我们大多数人来说，今天这个日子并没有太多特  别的地方，只是因为沾了他们两家人的喜气，所以可能会拥有一个比平时美丽的  好心情。可是站在今天婚礼的两位主人公的角度来说，这个日子真的好有意义， 因为在 X 年前的今天，他们之间的爱，还有因爱而生出的一切美好，都有了开始。 恋爱的生日 ，也是婚姻的生日 ，x ⽉ X 日 ，注定会成为他们之间一个与幸福有关  的纪念日 。\n\n什么是纪念日?其实顾名思义，就是值得记住的那些特别的日子 。它就像时  光的隧道里面树立的一个又一个路牌，提醒我们这一路走来，都经过了哪些重要  的时刻，哪些美丽的风景。每当我们回望身后的那些年岁，都不再是枯燥无味的  数字，而是一串串闪着光的密码箱，打开之后，里面藏着各种美好的回忆和故事。\n这一段完完整整的 X  年，蔷薇花开过了 X 次，地球公转了 X 圈，时节和冷  暖看起来还跟恋爱开始时一样，但是回忆多了故事，灵魂多了重量，眼中多了光  彩，这个神奇的日子，也被赋予了无限高的情感价值，让它值得回忆，值得纪念。 当激情和新鲜感被湮没于人间烟火，这个神奇的日子还会时时的提醒着他们，爱， 拥有着怎样的开始，还有他们结婚这一天，对幸福有多么坚定的相信，对婚姻曾  有多么美好的期待。各位来宾，就让我们大家一起用掌声来祝福他们这个特别的  日子 ，祝福他们的爱情和婚姻，生日快乐。\n\n100 婚礼那天是爸妈结婚纪念日\n\n各位来宾大家好，欢迎您前来参加小明和小兰的婚礼。很多的中国人选择婚  礼的日子，往往是要根据两位新人的生辰八字，来选择一个适合他们的黄道吉日 。 但是也有一些人会选择一个他们喜欢的日子，来做为彼此执子之手的起点。就像  小明和小兰就很喜欢今天，所以我们接到了两家的邀约，相聚于此，欢聚一堂。 不过我听说有人比他们更喜欢这个日子 ，不仅是小明(小兰)的爸爸妈妈，还有他  的爷爷奶奶和外公外婆，爸爸 妈妈喜欢这一天是因为，他们的儿女此刻才算得  上是真正的长大 ，而爷爷奶奶外公外婆喜欢这一天， 也同样是这个理由，他们  的儿女，也曾是在多年前的这一天，拥有了自己的家。在孩子们新婚之喜的日子， 爸爸和妈妈也迎来了他们的婚姻，XX 周岁的纪念日 。\n这个世上应该不会有什么东西，比今天这场婚礼更适合送给爸妈，当做他们 结婚纪念日的礼物。可能他们都已经忘了自己当年结婚的时候是怎样的心情，而 在今天却能真真切切的坐在这里，感受到比曾经多了无数倍的幸福和欣喜。那时 候的花没有现在的缤纷，婚纱也没有现在漂亮，那时候的婚礼也没有现在的好， 但白头到老初心却依旧跟几十年前一样。\n也许是孩子们觉得爸妈今天如此美满，是来自于这个日子所包含的一份幸运， 所以他们也要选在这一天。 就这样，一老一少两对夫妻，在不同年份的同一天   举办婚礼，这不是有趣的巧合，这是他们有意的选择。孩子们想要传承爸妈的幸   福，传承这一份温柔而坚定的爱，还有他们温暧而平凡的生活。我们今天既是祝   福一场新的婚姻，同时也是来弥补我们几十年前缺席的那场婚礼。所以祝福他们   新婚快乐和结婚周岁的掌声，就合在一起，为他们热烈的响起吧。\n婚礼当天是爸爸和妈妈的结婚纪念日 ，除了开场词可以用这一段之外，也可  以在感恩父母结束之后，在邀请父母上台的部分，让爸爸和妈妈从 T 台走上来。 上台的音乐可以用婚礼进行曲，让爸爸和妈妈重温当初的一份感动。如果是公婆\n\n的结婚纪念日 ，就让公婆走在前面，是岳父母的的结婚纪念日 ，就让他们走在前 面 。主持人台词建议:\n“爸爸和妈妈要走向舞台了，可能很多年前他们也曾羞涩的牵着手 ，站在过 舞台的中间，但那时候条件有限，没有这么好看的婚礼现场，这么华丽的舞台。 也一定没有今天的这份阅历，从容和淡然。所以今天，在你们结婚整整 XX 年的 日子，在孩子的婚礼上，让我们再一起重温一下当初的那份温暖和感动。刚好今 天这里一切都是现成的。有宾客，有舞台，小兰的爸妈就是你们的伴郎和伴娘， 各位来宾，那就让我们全体起立吧，用一次热烈的掌声有请这一对老新郎和老新 娘，在伴郎伴娘的陪伴下，深情款款，挽手入场!”音乐播放婚礼进行曲。环节仅 供参考。\n\n101 婚礼那天天气很热\n\n热爱可抵岁月漫长 ，热天...可配啤酒烤肠。\n\n大家好，欢迎各位来参加小明和小兰的婚礼。\n书里面说，幸福都是用汗水换来的，这句话在今天真的特别应景，在这样一 个热火朝天， 汗流夹背的日子 ，我们见证了幸福，他们收获了幸福。只是幸福 的感受各有不同，但却真的是和汗水有关的幸福。\n在这样炎热的天气结婚，我猜他们一定会有一点辛苦，不过他们应该不会在  乎这些，毕竟两个人是真爱。可是这样的温度，能出来相聚的你们，也一定是真  爱无疑了，多多少少有些教人感动，所以，天气越热，越能衡量出来你们的热情  和浓浓的情意，也相信这是太阳在把自己全部的光明和热度，都当做专属的礼物， 送给了今天的婚礼。\n既然是这样的气温，那就让我们准备一些和它有关的气氛。一对热恋的男女， 就要开始他们热闹的婚礼，希望各位热心的 家人和朋友们，一定准备好您的热  情，当两位走上婚礼舞台的时候，把我们准备好的掌声，为他们热烈的响起。各  位，掌声有请新郎，小明登场。\n\n102 婚礼那天天气很冷\n\n如果外面的世界太冷，那就赶快去找个温暖的拥抱吧!\n大家好，欢迎各位来参加小明和小兰的婚礼。从来季节都是慢慢的变换，可\n\n寒流却总是不按照套路，一瞬间就突如其来。尽管我们都已经做好了(秋天)冬天 到来的准备，但是今天出门的时候，还是被这阵始发于西伯利亚的冷空气，吹透 了外套，吹乱了节奏。天气降温了，大家要注意保暖，不过有人依偎的人，不管 多么寒冷都不怕，就像小明和小兰，从这一天开始， 正式的有一个他们温暖的 小家。\n寒冷的天气很适合去做一些温暖的事情，比如找个热乎乎的房间吃顿大餐， 比如约起好友喝点小酒，或者在一个喜气萦绕的的屋子里面参加一场婚礼，见证 一对新人的幸福和甜蜜。而今天在这里，有大餐，有小酒，有好友，也有一出终 成眷属的人间喜剧。\n所以不用去管窗外的世界刮的西风还是北风，也不用去想来的路上下的是雪 还是雨 。因为寒冷暑热，这都是我们必须都要去经历的天气。但是婚礼，却是为 数不多的相聚，也是小明 和小兰一辈子唯一的一次，以新郎和新娘的身份站在 这儿，接受大家的祝福和恭喜。在这样的寒冷的日子，一点点温暖，就会让人觉 得无比知足，所以首先请大家用点点温暖的掌声，来送给今天的婚礼，让我们听 一听，大家火热的内心中，有多大的热情，可以吗?掌声有请，小明。\n\n103 婚礼那天风雨交加\n\n雨下整夜，我的爱溢出就像雨水 。周杰伦--《七里香》\n来的路上天空下起了雨，希望这场小雨没有影响各位的出行，也不会影响大 家的心情。同样的天青色，有等烟雨，有人怪雨急。可阴晴冷暖刮风下雨这样的 自然规律，都是我们人力不可抗拒的因素，那就尽量用一颗平常心，来欣赏这个 世界呈现给我们不同形式，但却同样美好的风景。\n说到结婚下雨的寓意，虽然南方北方由于文化的差异，各有不同的说法，但 是其实每个说法都包含着吉利和福气 。有人说下雨浇新娘，男人娶(浇)娇妻。意 味着过了门的小媳妇，个性柔顺，夫唱妇随，还会对丈夫有所助益。有人说结婚 下雨老婆很厉害，不仅是个管家婆，还有着雷厉风行的个性。还有人说结婚下雨 是老天替新娘流出的眼泪，这辈子这个姑娘都不会再因为伤心而哭泣。而我的观 点是，结婚下雨 ，意味着过了门的媳妇在公婆和丈夫，还有婆家人的宠爱下，一 定会要风得风 ，要雨得雨。\n当然，对今天两位新人来讲，下雨或天晴都不会影响他们今天婚礼的好心情。 天气的好坏是老天的事，生活的好坏才是他们该关心和思考的问题。如果将来遇  到阳光灿烂，他们就会种朵花，名字叫开心快乐的花。如果将来遇到雨雪风霜， 他 们就撑把伞，伞下的他们一定会比平时靠的更近，楼的更紧，向着风雨来临  的方向，并肩前行。各位， 让我们衷心的祝福这对有情人，风雨中开始的婚姻， 能守得云开，等到雨过天晴。\n\n104 婚礼那天漫天飞雪\n\n雪是上天揉碎的云朵，是棉花糖占领了世界，是大地温暖的被窝。\n各位好，欢迎大家参加小明和小兰的婚礼。这一场飘飘洒酒的雪花，为冬日 增添了无尽浪漫的氛围，也为这个略显暗淡的季节，带来耀眼的光影。暂时不用 理会窗外清冷的寒风，在温暖的房间里，我们一起分享人间最美好的事物，有关 于爱情的喜乐与感动。或许当初定下婚期，小明和小兰并没有想到如此巧合的遇 到一场小雪，因为瑞雪兆丰年，这场瑞雪的喜兆该不止是对来年丰收的期待，而 是用爱来托起的婚姻，每一个平淡又温暖的岁岁年年。\n下雪是专属于冬天的浪漫限定，这个季节的寒冷会让人望而生畏，但是谁都 无法拒绝这份银装素裹的纯净。艺术家们喜欢雪，他们说这是上天揉碎的云朵， 是上帝写给人间的诗。小孩子们喜欢雪，他们说蒲公英在漫天飞舞，棉花糖正在 占领这个世界。种田的农民喜欢雪，他们说这是大地抵抗寒风的被窝。小明和小 兰也喜欢雪，他们说这是老天给他们携手白头的祝福，让整个世界，都穿着婚纱 一样的颜色。\n虽然雪景很美，却不会永远存在。不过这不用遗憾，因为雪化了，就会春色  满园。虽然婚礼很美，却只有一天。不过小明和小兰也不会失落，因为他们此刻  的手中握着两份幸福，一份是恋爱盛大的收场，一份是婚姻平静的开端。天地雪  初寒，唯有爱渐暖，他们的爱，会化作温暖的誓言，你们的爱，就化作温暖的掌  声，让这一场绽放在雪中的婚礼之花，芬芳而娇艳。各位，掌声响起，有请新郎， 小明登场。\n\n105 婚礼那天客人很多\n\n真正的爱就是在照照攘攘的人潮里 ，我也会一眼便看到你。\n各位好，欢迎大家来参加小明和小兰的婚礼。我之前听说今天的这一场婚礼 会有五六百位(特别多的)朋友到场见证，跟小明小兰(或者他们的家人)接触的过 程中，他们的亲和友善让我完全相信这两位有着良好家教的年轻人，还有他们的 爸爸妈妈一定会有特别好的人缘儿，在家逢喜事的这一天，有很多朋友来祝贺一 点都不奇怪。可是当我踏进这件宴会厅的那一刻，我还是觉得有一点震惊，用人 山人海来形容都不过分，好像远远超过了他们预期的场面。所以今天这场婚礼的 人气这么旺，也会预示着婚礼中两位新人未来的事业兴旺发达，家族人丁兴旺。\n能够有如此多的朋友在这一天放下手中的工作，前来参加婚礼，足以见得在 以往的生活中，小明小兰，还有他们的爸爸妈妈有多么的被大家认可与喜欢。这 么多的宾客中，有人是敬仰他们的为人和品格，有人喜欢他们的脾气和性格，有\n\n人受过他们的帮助与恩惠，有人是他们相交多年的情感寄托。还有好多的亲戚和 家人 ，都乐于见到这两个优秀又登对的孩子 ，完美的恋爱修成正果。\n相信此刻的他们，心里面也一定因为有如此多的亲友的到来，而觉得开心和 骄傲，毕竟比幸福更幸福的事，就是自己的幸福有人分享，并能感受到大家真心 实意的祝福。谢谢你们的到来，今天的婚礼，不仅壮观和热闹，也一定会浪漫又 精彩。各位，这么多的嘉宾我见过，但是这么多的朋友同时鼓掌，我们还没有听 过，那就让我们一起来听一听排山倒海的热情吧，掌声响起，有请新郎，小明登 场。\n\n106 婚礼那天客人很少\n\n我爱你，不必人尽皆知。因为你本就是我的小众心事。\n各位好，欢迎大家来参加小明和小兰的婚礼。我们今天的婚礼没有明确开始  的时间，他们说今天邀请的都是亲戚和家人，要么就是为数不多的，最好的朋友  和伙伴，只要大家到齐了，可以随时的开始仪式。我看到小明和小兰刚刚示意我， 他们都已经各自的做好准备，如果你们也都准备好了，那就用一次掌声来告诉我  们，婚礼可以开始了，好吗各位?谢谢大家。\n跟有一些喧闹又嘈杂的婚礼相比，相信很多的你们跟我一样，会更喜欢这种  因为安静而来的浪漫。因为这更像是朋友的小聚，像是除夕的年夜饭，是亲朋挚  友一起叙叙旧聊聊天，是家人团圆的仪式感。就像小明觉得，婚礼本就是两个人  的烟火，能邀请到最喜欢，最重要。最亲近的人跟他们一起欢呼喝彩就已经很幸  福了，太多的陌生人面前，怕自己和爱人觉得尴尬，从而表现的不够真实和自然。 其实我知道不仅这两位主角，还有两家人都特别的不愿意给别人添麻烦，不过你  们，是他们不怕麻烦的人 ，因为如果你们没有来，他们一定会觉得婚礼，少了些  什么，会多了些遗憾。\n做为主持人 ，我也很荣幸能够和大家一样， 接受到邀请来参与这样一场美 好的仪式。我们都是他们这两个人和两家人值得信任的好朋友，所以就不说太多 客套的话，祝愿大家开心愉快。鼓鼓掌，有请小明登场。谢谢。\n\n107 婚礼那天只有家人\n\n婚礼那天，有最爱的家人在旁， 不用千万人鼓掌，也同样可以幸福的很漂亮。\n各位家人，大家好，我是主持人刘德华，很真诚的问候大家，并代表小明和 小兰欢迎你们来参加这一场特别的婚礼。 这一场婚礼的第一个特别之处，它并\n\n不是举办在一间豪华酒店的宴会大厅，没有嘈杂的声音和炫目的舞美灯光。第二 个特别之处，他们没有很多的宾客和服务人员，参加婚礼的每个人，都是他们俩 的亲人和家人。我曾问过他们为什么会如此安排，他们说，也许过后还要答谢很 多的同事同学，朋友和伙伴，但是最重要的仪式部分，他们只想在最爱他们的家 人面前，最真诚的希望他们幸福的亲人身边,来披上婚纱，换上礼服，正式的告诉 大家，他们的成长 ，他们的幸福，他们走出了这个小家，又拥有自己的小家。\n从出生开始，这两个孩子就在你们的身旁，被照顾的无微不至，给我们大家  带来欢乐，也被寄予了好多的期待和祝福。 但是时间就像一个不近人情的车夫， 不肯定慢一点，不会停一下，所以稍一转身，曾经你们眼中的这两个可爱宝宝就  长成了大人，有了自己的朋友，自己的事业，自己的爱人，要成为了婚姻中的妻  子和丈夫。可能还会有些不够放心，不知道他们会不会经营好婚姻中的一切。 但  是你们就是他们俩最好的老师啊，在你们的身上，他们学习了很多大人的模样， 也学会了责任和 担当。他们也会像你们一样认真的去生活， 努力的做好各自人  生的角色。所以各位家人，请你们放心，这份幸福，他们牢牢地系在自己的身上。 好了，就这样开始这一场特别的婚礼吧，掌声送给我们今天的两位主人公，祝他  们新婚快乐!", "tags": ["仪式", "入场", "台词", "婚礼那天", "婚礼那天是恋爱纪念日", "开场", "故事", "新娘", "新郎", "来宾", "父母", "祝福", "誓言", "酒店"]}, {"id": "l_14be113748", "cat": "全流程台词", "title": "流程一:开场", "body": "尊敬的各位来宾，女士们先生们大家中午(晚上)好。欢迎来到大明和大兰的 宝贝女儿小兰，和女婿小明的新婚答谢午(晚)宴。代表他们这幸福的一家人衷心 感谢各位的到来。\n答谢宴，顾名思义，就是要以感谢来做为我们今天宴会的主题，在家逢喜事  的这一刻，备下美酒佳肴，宴请四方宾朋，请您和我们一道庆贺这一家族盛世。 向您分享对有情人终成眷属的消息。回顾小兰从呱呱坠地，到豆蔻少女，从学业  有成，事业有成，到如今拥有一个如此美好的归宿，这一路都少不了各位的关怀  和付出。因此在小兰新婚答谢宴会的这刻，本该让两位孩子来到大家面前亲自向  各位叔叔阿姨，家人亲友们敬酒致谢，但由于小两口由于 XXXX的原因无法及  时返回。而爸爸妈妈又迫不及待的想要分享这个幸福的消息，所以今天的答谢宴， 将会由大明和大兰两位老夫妻，代表小两口向各位表达一份歉意，同时还要送上  一份感谢。虽然小明和小兰无法亲自前来参加，但是他们也通过视频的形式准备  好了一份对大家的问候，接下来，就让我们通过大屏幕，一起认识下我们的新姑\n\n爷小明先生 ，来接受他们的欢迎和感谢。有请大屏幕。 流程二:视频结束\n通过屏幕我看到两个优秀的孩子的风采，小兰应该不需要向大家过多的介绍， 许多的家人都是看着姑娘长大的。(可简单介绍新娘成就，学习有成就介绍学业。 工作很好就介绍事业)也正是因为她的努力和优秀，让她也遇到了一个跟她一样   优秀的另一半，(简单介绍新郎的身份，工作等) 2 年前有缘相识，有幸相爱，有   情结为夫妻，相约一起共度婚姻的岁岁年年。由于他们(工作很忙/学业很忙/无法   抽身赶回) ，所以也特意的委托大明和大兰这对老夫妻来代替他们感谢各位，接   下来，就让我们用一次热烈的掌声，有请他们两个人，共同牵手，来到舞台中央。", "tags": ["全流程台词", "开场", "敬酒", "新娘", "新郎", "来宾", "流程一"]}, {"id": "l_4ef314b367", "cat": "全流程台词", "title": "流程三:敬酒词", "body": "孩子结婚，最高兴的未必是他们自己，还有可能是他们的父亲和母亲，就像 现在在舞台上的两个人，表面看起来风平浪静，但是内心里肯定满满的都是骄傲 和开心。为人父母最希望的就是看到孩子能健康长大，最希望他能拥有一番自己 事业，有生存和立足社会的本领，最希望的就是他会有自己的另一半，自己的小 家。如今孩子成家立业的愿望已经实现了，后面的期待就是他们能早生贵子，能 事业有成，能家庭幸福，很多年前的爸爸和妈妈也是在这样的期待中踏上了婚姻 之路，这么多年， 在各位的帮衬下，支持下，陪伴下一步一步的走到今天，真 的有太多的感谢要跟大家来讲，所以我想邀请爸爸(或妈妈)在敬酒之前向各位送 上一份感谢，有请小兰的爸爸。", "tags": ["全流程台词", "敬酒", "敬酒词", "流程三", "父母"]}, {"id": "l_595b9ecc7a", "cat": "全流程台词", "title": "流程四:敬酒结束，退场", "body": "请大家斟满酒杯，高举美酒，共同来分享喜乐。这杯酒，一敬过去，感谢大 家曾经风雨无阻的陪伴和关爱，我们一路前行。二敬现在，感谢你们百忙之中的 到来，分享儿女成家的喜悦。 三敬未来，感谢各位一如既往，和我们相约更美 好的明天和未来。并肩携手 ，砥砺前行 。各位，让我们干一杯，祝他们一家，幸 福，美满，快乐，如意，干杯。待到他日他们荣归故里 ，定让两位优秀的孩子， 向各位长辈和家人补上一杯喜酒，表达敬意。祝各位吃好喝好，用餐愉快，现在 我宣布，大明先生和大兰女士的爱女 ，小兰和小明的婚礼答谢午宴(晚宴) ，圆满 历程，请大家开怀畅饮!\n\n196 答谢宴/回门宴全流程", "tags": ["全流程台词", "敬酒", "敬酒结束", "流程四", "退场"]}, {"id": "l_ecd2346396", "cat": "全流程台词", "title": "流程一开场", "body": "尊敬的各位来宾，女士们先生们大家中午(晚上)好。欢迎来到大明和大兰的 宝贝女儿小兰，和女婿小明的新婚答谢午(晚)宴。代表他们这幸福的一家人衷心\n\n感谢各位的到来。\n今天是娘家的答谢宴，顾名思义，我们今天就是一场以感谢来作为主题的邀 约。要代表他们俩，还有他们的爸爸和妈妈，一来感谢家人们，对小兰在成长路 上的照顾与关心 ，二来感谢同事，同学，朋友和伙伴在她人生旅途中的陪伴。还 要向大家官宣他们立业成家，两位有情人终成眷属的喜悦。终成眷属，这是一个 多美好的词，里面包含了爸妈的欣慰，包含了相爱的他们的期待，包含了朋友们 的恭喜，也包含你们的到来，为他们送上这份真心实意的祝福。所以今天邀请您 来，不止是为了请您吃一顿饭，还要让你看看长大后的初为人妻的小兰，再给您 介绍一下我们的新姑爷小明，如今的他们已经等在了台下，即将牵手经过各位的 身边，好了，如果我们大家都已经做好了准备来迎接今天的两位主人公人场，就 请各位响起热烈的掌声，让他们听听我们的祝福有多温暖，掌声有请，小明和小 兰。", "tags": ["全流程台词", "开场", "来宾", "流程一开场", "祝福"]}, {"id": "l_0bdc12f8e0", "cat": "全流程台词", "title": "流程二:新人人场", "body": "回顾一个孩子的成长 ，从小兰呱呱坠地，到豆蔻少女 ，从不诸世事的姑娘， 到今天拥有了一个美好的归宿，人生中的每一个成长的历程，都离不开大家的支  持和帮助。好像转眼那个蹦蹦跳跳的扎着马尾辫的小姑娘就已经长成了大人，从  学业有成到事业有成，再到如今携手她的丈夫回到娘家人面前，来感恩各位成长  中的帮助，还要接受所有亲友们的祝福。小兰大家很熟悉，而小明会有一点陌生。 (这里可以用简明扼要的语言来介绍新郎，不用说的太多，挑闪光的地方) 。一个  如此优秀的男孩子不仅让我们为小兰找到一个美好的归宿而高兴，同时也为他们  的未来赋予了更多的期待和希望。\n在今天这样一个特别的时刻，小兰也一定会有很多心里的话想说，接下来我 把话简交给她，大家把掌声送给她，我们听听她心里的喜悦和感谢。有请小兰。 (新郎说新娘谁讲话可以事先沟通好，两人都说，就简单铺垫一下， 安排一下先 后顺序即可)", "tags": ["全流程台词", "新人人场", "新娘", "新郎", "流程二", "祝福"]}, {"id": "l_12b236c464", "cat": "全流程台词", "title": "流程三:新人致辞结束", "body": "能感觉到虽然话语不多，但句句源于心底，字情真意切，既有对过往时光的 怀念，对大家的感恩，还有对未来生活的心愿，对父母的感谢。说到父母，我们 必须要说一下小兰的爸爸和妈好，毕竟这一天除了台上的这两位，最开心幸福的 应该就是他们俩，所以我们接下来不浪费时间，马上请出今天答谢仪式的另外两 位主角，小兰的爸爸和妈妈，共同牵手，来到舞台上，站在孩子们身边，掌声友 情这两位老夫妻。", "tags": ["仪式", "全流程台词", "新人致辞结束", "流程三", "父母"]}, {"id": "l_9923ec580e", "cat": "全流程台词", "title": "流程四:父母人场", "body": "在他们的身上，在爸妈的脸上都能看到时光划过的痕迹，但是值得幸福的是， 孩子已经慢慢的长大，但是爸爸和妈妈还依然很年轻，并没有老去。一直以来这  个幸福的小家庭，让小兰沉浸其中，看到爸爸和妈妈的榜样，让她对自己的婚姻\n\n和幸福有憧憬也有相信。爸爸和妈妈只是茫茫人海中平凡而普通的一员，他们的 人生也并没有多么的精彩和成功，但是他们一辈子最大的成就。就是把他们的孩 子抚养长大。教会他们说话，走路，还有做人的道理。相信在不久的将来，当你 们为人父母那一刻。一定 会深切地感受到他们此时此刻内心的那一份难以启齿 的温柔。接下来我们今天的男二号(女二号)也要按捺不住的表达心情，所以这一 刻话简交给小兰的爸爸 (妈妈) ，我们来听听东道主此刻的心声。", "tags": ["全流程台词", "流程四", "父母", "父母人场"]}, {"id": "l_c25b794f1c", "cat": "全流程台词", "title": "流程五:父母致辞结束", "body": "在这里，爸爸和妈妈会和自己的孩子们，一起向所有一如既往支持他们的家  人和朋友们。敬上一杯幸福的美酒，我们期望这一杯美酒，承载的祝福，能够让  小明和小兰。有情人终成眷属!能够让我们尊敬的爸爸和妈妈身体健康!能够让我  们全场的所有嘉宾幸福快乐!期待您也可以举起手中的酒杯。真诚的为他们祝福， 为他们干杯。谢谢每一个到来的朋友。 希望大家好心情好胃口 。让我们一起， 干杯!", "tags": ["全流程台词", "流程五", "父母", "父母致辞结束", "祝福"]}, {"id": "l_ac9021c312", "cat": "全流程台词", "title": "流程六:父母退场", "body": "爸爸和妈妈的心情我们已经感受到了，待会他们可能还要亲自的来到各位的 身边向您问候致敬，此刻请大家响起掌声，首先有请爸爸和妈妈牵手走下舞台， 来到各位身边。掌声欢送!", "tags": ["全流程台词", "流程六", "父母", "父母退场", "退场"]}, {"id": "l_be36b95eba", "cat": "全流程台词", "title": "流程七:结束词", "body": "(如果他们已经举办完正式的婚礼了)\n这一刻答谢的仪式就要结束了。还记得在XX 天前(XX 月前)他们在小明的  家乡(省市县名) ，一场正式而又盛大的婚礼，在欢笑和泪水中落下帷幕。同时也  开启了他们全新的婚姻生活。对他们两个人来说，这是一次蜕变，也是一次成长。 虽然两个人的爱情并没有那么多的惊天动地，可平淡如水的陪伴，也让他们对未  来充满了无限的期待。\n(如果他们还没有举办正式的婚礼)\n这一刻答谢的仪式就要结束了。但是在XX 天后(XX 月后)他们将要在小明 的家乡(省市县名) ，举办他们正式而盛大的婚礼，对他们两个人来说，这是一次 蜕变，也是一次成长。虽然两个人的爱情并没有那么多的惊天动地，可平淡如水 的陪伴，也让他们对未来充满了无限的期待。\n祝福他们的未来，能夫唱妇随，举案齐眉，能携手百年，一生一世，幸福美 满!各位，我宣布,小明和小兰新婚答谢仪式部分，圆满礼成，宴会正式开始。让 我们响起掌声欢送他们走下这一方舞台，共同开启人生 ，新的篇章。\n\n197 百岁宴/百日宴全流程\n\n各位家人，各位朋友，大家晚上好。很荣幸能接受到邀请来主持静香小公主 的百岁宴。今天，我们到这里来一起见证和分享她的家人，在人生旅程开始的时 候，为她准备的这份祝福的心愿单，还有大家共同参与打造的，生命里第一份重 要的仪式感。\n一个宝贝的出生，代表了一个小家庭的完整。她不仅象征着爸爸和妈妈相爱  的结晶，也是他们生命的延伸，和血脉的交融。更是整个家族未来的希望，香火  的传承。还记得 X 年前(爸妈结婚的时间)，小明和小兰的婚礼，在欢笑和喜悦的  泪水中盛大的落下了帷幕。四年后的今天，他们的爱情果实，可爱的静香小公主， 已经出生 100 天了。为这个小家庭来带无尽的欢乐和感动。她就像一个天赐的礼  物一般，又像是一个天使降临人间，在她的爸爸妈妈，爷爷奶奶，姥姥姥爷的心  里，她值得 拥有这个世界上最好的一切。所以今天，我们大家一起 为她许下心  愿，送上祝福，为她留存百岁的纪念。各位，我们鼓一次掌，送给宝贝 ，祝福她  健康幸福，长命百岁。\n其实我们很多人都会有一种遗憾， 就是小的时候由于家庭条件，父母意识  等等的原因，没有留下什么太多的影像，更别说什么仪式感。所以小静香多幸福， 长大以后可以看到自己小的时候，身边有那么爱，一个在爱中长大的孩子 ，内心  一定会盛开着鲜花，也会用深情去爱着这个美好的世界。首先我们把，宝贝抱到  她人生中的第一个舞台。来接受这些仪式感。各位，掌声有请静香小公主。", "tags": ["仪式", "全流程台词", "流程七", "父母", "祝福", "结束词"]}, {"id": "l_eabbce390a", "cat": "全流程台词", "title": "流程一:爷爷奶奶的礼物--长命金锁", "body": "首先为宝贝送来祝福的是爷爷奶奶，他们准备的小礼物是一个小金锁。金锁 不仅象征着吉祥富贵，还寓意着长命百岁。希望金锁能锁住宝宝的健康，让病痛 不侵，能锁住宝宝的快乐，让她无忧无虑，能锁住宝宝的好运，让她一生平安， 幸福如意。", "tags": ["全流程台词", "流程一", "爷爷奶奶的礼物", "祝福", "长命金锁"]}, {"id": "l_d14b143eb5", "cat": "全流程台词", "title": "流程二:外公外婆的礼物--幸运手镯", "body": "第二个为宝宝送来祝福的是外公外婆，他们准备的小礼物是一个小金镯，为 宝宝带手镯是添福吉祥的寓意，手镯的谐音，叫守着，外公外婆希望它能够帮你 守着幸福，让小手更灵巧，帮着小静香圈住这个世界那么多的美好，把所有的快 乐，都握在手心。", "tags": ["全流程台词", "外公外婆的礼物", "幸运手镯", "流程二", "祝福"]}, {"id": "l_94399ac3d9", "cat": "全流程台词", "title": "流程三:妈妈的礼物--辟邪金别针", "body": "第三个为宝宝送来祝福的是妈妈，她准备的小礼物是一个金色的小别针。许 多的宝宝刚刚来到这个世界，因为过于的娇小柔弱，难免受惊，别针的寓意一来 是用来驱邪， 二来是用来压惊，希望百邪退避，吉祥平安。", "tags": ["全流程台词", "妈妈的礼物", "流程三", "祝福", "辟邪金别针"]}, {"id": "l_21ef6eaaec", "cat": "全流程台词", "title": "流程四:在“知足常乐”的字画里面留下脚印", "body": "有人说人生是旅程，需要用脚步一步一步的丈量，丈量这个世界有多大，丈 量梦想有多远，可能三个月的她还只会爬来爬去吧，但是她也终将会蹒跚而行， 踏上这条通向更大世界的路。我们今天，也将会为宝宝留下一个脚印，将它印在 一幅画框里面 ，祝福小静香以后的路，能够脚踏实地，知足常乐，能丰衣足食， 游历遍这世间的山川大河。", "tags": ["全流程台词", "流程四", "祝福"]}, {"id": "l_1c063d6519", "cat": "全流程台词", "title": "流程五:爸爸为女儿带头纱王冠(男宝不适用)", "body": "接下来的小环节，一定是最重要的，因为将要为她送上祝福的是爸爸。有请 小明。\n有人说女儿是爸爸的前世的小情人，其实这句话真正的意义，说的是女儿是  爸爸心里最重要的宝贝。他会见证宝贝的出生，陪伴她长大，也会看着一个男孩  子，带着他们共同对幸福的憧憬，和她组成一个属于自己的家。爸爸今天要做的， 是亲手为 她披上一件小婚纱，带上一个王冠，用他的行动告诉自己的宝贝 ，在  她婚礼上的婚纱披在身上之前，爸爸会把她当成是一个小公主，会好好的呵护， 直到她遇见属于自己的幸福。来吧小明，提前感受下穿着婚纱的女儿。", "tags": ["全流程台词", "流程五", "爸爸为女儿带头纱王冠", "男宝不适用", "祝福"]}, {"id": "l_b3aec016ce", "cat": "全流程台词", "title": "流程六:小公主妈妈致辞", "body": "各位，接下来还会有些对宝贝的祝福，对大家的欢迎，对各位家人的感谢， 我们把时间交给王茜，也把掌声来送给她。", "tags": ["全流程台词", "小公主妈妈致辞", "流程六", "祝福"]}, {"id": "l_517e83e9f6", "cat": "全流程台词", "title": "流程七:封酒礼", "body": "在我们舞台的一侧有一张桌，这摆着很多的很多的花馍，还有一瓶酒，其实 它的寓意是希望小静香长大有吃有喝，或者叫吃香喝辣。花馍的意思是代表着荣 华富贵，而酒则象征着历久弥香。我们今天将在宝宝的百岁宴上，将这瓶酒封存 起来，等有一天需要大家一起来把酒言欢庆祝的时候，再把它打开，或者是金榜 题名，或者是新婚大喜，或者是生儿育女，总之，这瓶酒承载了我们对未来的一 份祝愿和期许，希望再打开它的时候，依然醇厚，芳香四溢。封酒仪式，就交给 小明和小兰两个人吧。", "tags": ["仪式", "全流程台词", "封酒礼", "流程七"]}, {"id": "l_ff2a332c89", "cat": "全流程台词", "title": "流程八:切蛋糕", "body": "百岁宴，怎么少的了蛋糕，一来预示着，甜甜蜜蜜，二来象征着步步高升， 有请蛋糕进场，让他们这一家六口 ，一起切开蛋糕，品尝这份浓浓的团圆的甜。 有请静香小公主的爷爷奶 奶，外公外婆来到舞台上。我们倒计时，来准备，3, 2, 1!祝宝贝长命百岁，健康快乐，茁壮成长。", "tags": ["全流程台词", "切蛋糕", "流程八"]}, {"id": "l_eeaf00fca8", "cat": "全流程台词", "title": "流程九:保姆阿姨唱首歌", "body": "最后一个环节，要交给我们的阿姨，她说想为宝宝唱一首歌，宝宝最爱听的  就是她唱的这首歌，我们也要感谢您在这儿个月时间里的辛勤工作，付出和奉献， 全家人都会感恩并记得您所做的一切。", "tags": ["保姆阿姨唱首歌", "全流程台词", "流程九"]}, {"id": "l_62b48d415e", "cat": "全流程台词", "title": "流程十:结束词", "body": "生命就像是一段不能停下脚步的旅程。这一路，有人让我们依依惜别，也有 人让我们欢喜遇见 。这一路的人来人往，让我们感受到身边的关怀，陪伴和爱。 这一路的山川大海，让我们感受到生命的丰盈和精彩。我们都有着一个相似的起 点，但却有着各自不同的未来。祝福未来的小静香 ，所有泪水都是喜极而泣，所 有的梦想都能得偿所愿。愿她可以深情的爱这个世界，从而被这个世界，温柔以 待。各位来宾，静香小公主的百岁宴将要落下帷幕了，真诚感谢您的陪伴，就让 我们一起响起掌声，让这一场祝福的酒宴，在欢笑中，热闹的开始吧!\n\n198 升学宴/成人礼全流程\n\n各位来宾大家中午好，很荣幸和大家一样接到了邀请， 我们在这里欢聚一 堂，以祝福的名义来见证一个小伙子(小姑娘)18 岁的仪式感。今天是 TA 的升学 宴，伴随着高考的结束，学习生涯的第一个部分已经完美的告一段落。 十多年 的寒窗和辛苦，也终于要有了结果。\n每个人都有自己的 18 岁。你们还记得当年自己的样子吗?有着怎样的心境? 是轻狂叛逆，觉得世界不过而已，还是怀着对生活的热爱，对明天有着美好的憧 憬? 18 岁是一个人从稚嫩走向成熟，必须要翻过的一座高山，也是一个人从孩子 转变成大人，必须要淌过的一条长河。18 岁的行囊装满了雄心壮志，也还夹杂着 对未知的未来一丝丝的忐忑，站在人生的第一个路口 ，即将出发在他们青春落幕 的这一刻。", "tags": ["仪式", "全流程台词", "来宾", "流程十", "祝福", "结束词"]}, {"id": "l_86ce35711c", "cat": "全流程台词", "title": "18 岁的小明(小兰)即将要离开家和爸妈去奔赴自己的大学生涯，一片新的天  地，充满了新鲜和挑战，也充满了无穷的机遇。这一刻，他不再是一个父母庇护  下的孩子，而是要成为一个大人，还要把一口独当一面的勇气，放进自己胸膛里。 各位，这个年轻人，已经做好准备了，现在就让他来到台上，听一听我们所有人， 给他的祝福吧，掌声有请，小明(小兰)登场。", "body": "", "tags": ["一片新的天", "下的孩子", "他不再是一个父母庇护", "充满了新鲜和挑战", "全流程台词", "各位", "听一听我们所有人", "小兰", "小明", "岁的小明", "已经做好准备了", "掌声有请", "父母", "现在就让他来到台上", "祝福", "给他的祝福吧", "而是要成为一个大人", "这个年轻人"]}, {"id": "l_2873c0b2bc", "cat": "全流程台词", "title": "流程一:主人公人场", "body": "欢迎小明(小兰) ，今天舞台的中央是留给你的，明天会有更多更大的舞台， 希望那你可以继续努力的让自己闪耀在不同的舞台上。青春勃发的身影和自信满 满的笑容，这是一段特别美好的年纪，见山是山，看水是水，错便是错，对就是 对。黑白分明的眼眸里看世间的万千事物都很简单而纯粹。小明(小 兰)出生在一\n\n个温暖有爱的家庭。家人的优秀让他有鞭策自己的榜样，爸妈的陪伴和鼓励让他 拥有更多的自信。从可爱的童年，到少年的顽皮，经历过青春的叛逆还有此刻的 坚定，身边有那么多的爱，让她觉得不孤单，身边有那么多人能够带给他温暖。 今天我们都是为你而来，共同奔赴一场关于成长的邀约。 所以，做为主人公， 也想请你来亲自的问候一下大家， 简单的说说心里话，大家给小明(小兰)鼓鼓掌 吧。", "tags": ["主人公人场", "全流程台词", "流程一"]}, {"id": "l_9f3bb7a2c4", "cat": "全流程台词", "title": "流程二:主人公致辞结束", "body": "听到大家的掌声了吧?这既是对你的赞许和肯定，也是给你的期许和鼓励。 刚刚的话语当中他提到了很多的人，有辛苦培育他的老师，有一路陪伴他的同学， 有见证他成长的亲属，还有含辛茹苦的父母。如果不是因为时间的关系，我相信  他会 把每个值得感谢的人的名字，都一一的讲出来。 每个人都教会了他一些不  同的东西 ，老师的专业知识，和同学的为人处世，亲属长辈要怎样孝顺和尊重， 还有爸爸妈妈让他懂得做人的道理。当然，最重要的，是他在这些人的身上学会  了感恩。也明白了这将是他未来人生的立足之本。而最值得感谢的人，不用多说  了，就小明的爸妈，他们此刻好像比小明还有点紧张的等在台下，各位来宾，用  一次掌声，有请爸妈人场吧。", "tags": ["主人公致辞结束", "全流程台词", "来宾", "流程二", "父母"]}, {"id": "l_eaf3b32a46", "cat": "全流程台词", "title": "流程三:父母入场", "body": "谢谢你的参与和帮忙，让一个孩子可以在幸福快乐的环境中成长。让他可以 遵循着自己的本性，在一个被保护的空间里  自由的飞翔。爸爸妈妈是孩子的第 一个老师， 也是通过你们让他看到了世界的样子 。包括他的认知，他的三观， 他的行为和习惯，都是经由你们的引导而树立。在孩子即将背起行囊远赴学海的 这一天，我们也想听听爸爸和妈妈对孩子有着怎样的寄语，还有对现场的来宾， 有怎样要表达的心情，有请爸爸。", "tags": ["入场", "全流程台词", "来宾", "流程三", "父母", "父母入场"]}, {"id": "l_c6015b0da3", "cat": "全流程台词", "title": "流程四:礼物环节---爸爸送孩子一把雨伞", "body": "爸爸除了刚刚的那一番语重心长的话， 其实今天也为自己的宝贝在出发之\n前准备了一份小礼物，有请工作人员。\n这是一把雨伞。它的用意不言自明。过去的十多年，爸爸 和妈妈就像一把  雨伞一样为你撑起一片天空，为你挡风遮雨。可是不远的未来，你要就独自一个  人去闯荡这个世界，要像大人一样的去面对生活里的挑战和纷繁，琐碎和麻烦。 爸爸和妈妈不会一直的陪在你的身边，但却寄希望于这一把伞，酷暑时帮你遮挡  烈日 ，风雨时保护你别被淋湿。不用它的时候，把他们的牵挂和想念都收进伞里， 可是每次撑开时，你会看到爸妈 暖暖的温柔和浓浓的爱意，就像他们一直和你  在一起。 祝福你未来的学业和事业，风雨无阻，踏梦前行。", "tags": ["全流程台词", "流程四", "爸爸送孩子一把雨伞", "礼物环节", "祝福"]}, {"id": "l_6baf2ccba1", "cat": "全流程台词", "title": "流程五:礼物环节-妈妈送孩子一个平安扣/孩子给长辈送花", "body": "今天妈妈还准备了一份礼物送给你，妈妈说，这是一个平安扣，即将远行了，\n\n妈妈希望你越飞越高，越来越好，而妈妈更希望你能遇到困难可以勇敢，希望你 生健康平安。这个平安扣就留在你的身边，就像是陪着你的，妈妈和爸爸的爱。 除了爸妈给孩子的礼物，今天这个感恩的小家伙也准备了一番自己的心意要送给 爸爸和妈妈，有请工作人员送上鲜花。(  如果有老师需要送，或者其他重要的家 长 ，如爷爷奶奶或外公外婆及其他的亲属，一定要事先商量好)", "tags": ["全流程台词", "妈妈送孩子一个平安扣", "孩子给长辈送花", "流程五", "礼物环节"]}, {"id": "l_5b7b79ad02", "cat": "全流程台词", "title": "流程六:封存酒(女孩版)", "body": "在我国南方的一些地方 ， 要是谁的家里生了女儿，一定要酿几坛子女儿红， 埋在桂花树下。就像深深埋藏起来的父爱。带到女儿出阁之日 ，再做为陪嫁的贺  礼送到夫家。但嘉怡出生的时候家里没有这个条件，所以今天，在你成人礼的日  子，爸爸决定为你封存几坛女儿红，待到若干年后你大婚之日 ，用于款待天下亲  朋老友。待到那时， 相信花不迷人人自迷，酒不醉人人自醉。一个美好心愿， 希  望那一天，早日到来。\n封存酒(男孩版)\n我们准备的除了美味佳肴，还有很多的美酒，愿大家能开怀畅饮。除此之外， 我们还准备了有着特别意义的一瓶酒，要在今天把它封存起来，等到小明(小兰)  学业有成，凯旋荣归之时，或是等到他立业成家，新婚大喜的那一刻，我们和大  家一起分享今天珍藏起来的期待和希望的味道。酒是时光的宠儿，一切都会因为  时光的流逝而变淡甚至消失不见 ，只有酒，会随时光的走过，变得越醇厚，变得  越香甜。愿我们大家因酒相约，相约不久的未来。同时还要见证这个年轻人，人  生每个重要的时刻，每一个幸福的瞬间。", "tags": ["全流程台词", "女孩版", "封存酒", "流程六"]}, {"id": "l_b2f5712154", "cat": "全流程台词", "title": "流程七:金玉锦绣", "body": "今天的宴会对小明和他的家人来说是一场重要的仪式， 那接下来的环节应\n该算的上是仪式中的仪式感，请工作人员送上红色纸板。\n这个环节其实有一个寓意，因为过去的小家庭，都是爸爸妈妈一直在操劳和 努力，可如今已经长大的小明也要在小家庭里面伸出手来，既是为这个小家的和 谐幸福，也是帮爸妈稍微的松一松气，所以现在，就请你们一家三口一起拿起杯 子，将里面的金色粉末，共同酒落于红色纸板，它将预示着，美好的未来，需要 每个家庭成员，一起用双手去拼搏和努力。\n各位，在我们中国的汉字当中，有一个字，它代表着锦瑟年华，它象征着锦  衣玉食，它表达着衣锦还乡，但是今天的我们，更加期待的是小明的未来，能够， 前程似锦!\n(红色纸板用透明胶水写“锦\"，平放捧到舞台中央。用高脚杯装好金色粉末由 督导或家人送上舞台，每人各一杯金粉，均匀洒落于胶水上，当主持人的台词进 行到“前程似锦”时，由工作人员瞬间立着举起红色纸板朝向宾客，胶水部分会出 现事先写好的“锦\"字，其他的部分会掉落地面 。操作方法与婚礼中的“金粉世家”\n\n“家和万事兴”相同，可根据与家人商定的结果，或策划师实际流程决定此流程是 否进行)", "tags": ["仪式", "全流程台词", "台词", "流程七", "金玉锦绣"]}, {"id": "l_e7c89d7f7b", "cat": "全流程台词", "title": "流程八:敬酒环节", "body": "各位来宾，接下来的一家三口会向大家敬上一杯酒，有您的陪伴，过去的人 生旅途，让他们不怕孤单，有您的到来，让今天的晚宴，变得更加的圆满。有您 的祝福，相信小明的一家， 一定会拥有一个更加值得期待的明天。各位来宾， 让我们共同举杯，祝福大家平安喜乐，永远相随。有请爸妈退场，请大家响起热 烈的掌声送给今天升学宴的两位功臣!", "tags": ["全流程台词", "敬酒", "敬酒环节", "来宾", "流程八", "祝福", "退场"]}, {"id": "l_c06de7a507", "cat": "全流程台词", "title": "流程九:大合影/纸飞机", "body": "好了接下来，小明还有一个心愿，就是想在自己的升学宴，成人礼的这一天， 和他所有亲爱的同学们一起来拍张大合影，记录下你们从青春年华，要走进风华  正茂的岁月 ，有请各位同学。\n(拍照结束后每人发只纸飞机) 流程十:结束词\n孩子们!即将要结束了今天的升学宴，即将要向美好的青春告别 。下一步， 是就要冲进这个新鲜刺激又光怪陆离的世界。要记得，没有谁的人生是一路平坦， 你们需要的不是安逸和自在，而是在面对逆境时候的坚持，面对困难时的勇敢。 所有的胜利都不是自然而然，所有的圆满都不是与生俱来。不断向前奋斗和奔跑  的过程，才能体会到人生的意义，生命的精彩。未来会有风雨和阳光，失落和希  望 ，只有全都经历了 ，才不辜负我们来这人间这一-趟 。所以 ，我们在这里就不  祝你们一帆风顺了，愿你们每个人 ，能踩着你们梦想的船帆，在人生的海洋里 ， 乘风破浪!\n拿起手中的纸飞机，这是我们一个一个色彩斑斓的小心愿，放飞它，追赶它， 实现它，你们就是这个世界，最耀眼的光芒， 1.2.3.  飞吧。各位来宾，用热烈的  掌声送给这群孩子们，愿他们的未来，美好精彩，充满希望!加油吧!\n\n199 订婚宴全流程", "tags": ["全流程台词", "合影", "大合影", "来宾", "流程九", "纸飞机"]}, {"id": "l_14be113748", "cat": "全流程台词", "title": "流程一:开场", "body": "尊敏的各位来宾，女土们先生们大家好。欢迎参加小明和小兰的订婚仪式。 我是主持人 xx ，很高兴见到各位。\n\n在所有跟爱情有关的祝福中，我最喜欢的就是终成眷属。因为它代表着恋爱 有圆满，付出有回报，也代表他们得到了彼此家人的认可和祝福。这一对浪漫的 有情人，开心的邀请到各位，来见证他们终成眷属的前一站，来参加今天的这场 订婚宴。意味着彼此好事将近，他们心心念念的幸福婚礼，终于也该提到了日程 当中。\n订婚其实是一个古老的传统，相传在古代的时候只有订婚后，男女才算是正 式的开始恋爱关系。接下来还要经过家人的观察考验，彼此的磨合与了解后再结 为夫妻。而现代的年轻人都是自由恋爱，对他们来说订婚的意义是要向各位家中 亲友和最好的伙伴，来官宣他们的爱情，寻求大家的祝福，也彰显了他们对待这 份感情的认真，以及双方家长 ，对他们的婚姻的重视。", "tags": ["仪式", "全流程台词", "开场", "来宾", "流程一", "祝福"]}, {"id": "l_68cc8afb6e", "cat": "全流程台词", "title": "流程四:互带婚戒", "body": "除了送花之外，今天两位还将要在舞台中央，在大家的见证下，来互带婚戒， 表达他们这生不变的爱。有请戒指人场。首先请小兰为小明带上戒指，这一刻起， 他成为了你的未婚夫，不久未来，他会成为你的丈夫。小明为小兰带上婚戒，以  后好好爱她，好好照顾她，让她开心 ，让爸妈放心。", "tags": ["互带婚戒", "全流程台词", "戒指", "流程四"]}, {"id": "l_0109488540", "cat": "全流程台词", "title": "流程五:签订婚书", "body": "在订婚的仪式中，除了鲜花，婚戒，还有一个传统仪式叫签订婚书，两姓联 姻，一堂缔约，订成佳偶， 白首永借。你们两个人要在婚书上签上各自的名字， 来承诺爱情的忠诚，相爱的心 ，此生不变。有请婚书。(主持人或新人可念婚书)", "tags": ["仪式", "全流程台词", "流程五", "签订婚书"]}, {"id": "l_f2f460d293", "cat": "全流程台词", "title": "流程六:切订婚蛋糕", "body": "我想用一个词来形容今天的订婚宴，就是甜蜜。爸爸和妈妈脸上的笑容很甜  蜜，今天各位家人守在这里，气氛很甜蜜。站在台上的两个人他们的表情很甜蜜， 还有旁边的一个大大的蛋糕，相信它的味道-定也很甜蜜。两位准新人 ，将一起  来切开这甜蜜的大蛋糕，不仅预示着你们的爱情，像这纯白的奶油一样香甜纯净， 也祝福你们二位的事业，步步高升，生活，高高兴兴，开开心心。来起切开蛋糕， 分享甜蜜吧。", "tags": ["全流程台词", "切订婚蛋糕", "流程六", "祝福"]}, {"id": "l_ee4ed3272a", "cat": "全流程台词", "title": "流程七:答谢来宾致辞", "body": "刚刚尝过了甜蜜的蛋糕，相信小明(小兰)的嘴巴正甜着呢，那就正好趁现在， 用甜甜的嘴巴来跟大家说两句吧。", "tags": ["全流程台词", "来宾", "流程七", "答谢来宾致辞"]}, {"id": "l_6ae39aa483", "cat": "全流程台词", "title": "流程八:双方家长人场", "body": "订婚就是两位准新人要定下婚约，商定婚礼的事宜。也把两个原本没有什么  交集的小家庭给聚到了一起。看看现在你们围桌而坐，变成了亲家，变成了亲戚， 变成了一家人 ，这不是正是缘分的神奇吗?从此两个妈妈又多了个姐妹，两位爸\n\n爸又多了一位兄弟，两个家庭都多了一个宝贝。接下来，就让我们这幸福的两对 老两口 ，也共同携手 ，从 T 台来到舞台中央吧。掌声有请。", "tags": ["全流程台词", "双方家长人场", "流程八"]}, {"id": "l_2ef12fc80d", "cat": "全流程台词", "title": "流程九:彩礼五金环节", "body": "下面要来点真格的了，彩礼和五金，好像都准备好了，接下来，就有请双父 母正式交接。(  此处各地习俗不同，我本人不是特别懂，所以内容不多，请根据 实际情况自行斟酌)", "tags": ["交接", "全流程台词", "彩礼五金环节", "流程九"]}, {"id": "l_26cfdb1529", "cat": "全流程台词", "title": "流程十:准新人父母讲话", "body": "(此处可实现与准新人家长商议，如有讲话，简单介绍后交给其话简即可， 不必过分渲染)", "tags": ["全流程台词", "准新人父母讲话", "流程十", "父母"]}, {"id": "l_91be7b0597", "cat": "全流程台词", "title": "流程十一:准新人与双方家长共举杯答谢", "body": "谢谢 XX 的致辞，特别的精彩，也特别的真诚。感谢大家怎么能只靠说，还 要喝。请为台上的一家送上酒杯，他们要一起向各位家人敬上一杯感谢的美酒， 谢谢大家今天的见证，谢谢你们过去的陪伴，也谢谢你们继续的支持和帮助他们 的两个孩子 。这杯酒，就敬给各位了，我来倒数 321,我们一起来一句干杯，怎么 样? 3,2, 1,  干杯!", "tags": ["全流程台词", "流程十一"]}, {"id": "l_31f2622cfb", "cat": "全流程台词", "title": "流程十二:结束语", "body": "伴随着一杯杯美酒，和一声声的感谢，小明和小兰两位准新人的订婚仪式到 此圆满礼成，祝愿他们的爱情之路，顺利又甜蜜，美满又欢喜，也祝福大家今天 在这里，过的快乐和开心。他们携手退场的时候，请您把双手借给他们一小会的 时间，用力的拍拍好吗?谢谢各位!\n\n200 十二岁生日/圆锁礼全流程", "tags": ["仪式", "全流程台词", "流程十二", "祝福", "结束语", "退场"]}, {"id": "l_14be113748", "cat": "全流程台词", "title": "流程一:开场", "body": "hello 各位来宾，女士们，先生们，各位大朋友小朋友们，大家中午好(晚上 好)。很开心在这里跟大家一起来参加小明(  小兰/以下不再单独注释)同学的十二 岁生日派对，祝愿各位都能收获一份快乐的好心情。\n十二 岁是人生中的一个很重要的路口 ，时辰 12 个， 月份 12 个，生肖 12 个， 星座 12 个，12 也是本命年的一个轮回。 就像是画了一个完整的圆，一个生命又 回到这个圆的起点，但人生已然开始了一个全新的阶段。回顾这个小生命从初来 乍到，每一个家人寄予他(她/以下不再单独注释)虔诚的祝福和极尽所能的呵护，\n\n到如今他朝气蓬勃，青春飞扬的身影和脚步，这十二年的过程，有数不尽的爱伴 随他的成长 ，家人带给他陪伴，他为家人带来幸福。\n因此在他 12 岁生日的这一天，爸爸妈妈一定要大摆筵席，感恩还愿，邀请  四方宾朋同来庆贺他们爱子(爱女) ，冲破了生命的桎梏，告别蒙昧，开启智慧， 从童趣迈进少年，人生的书本，又翻开全新的一页。好了各位，小明同学早已经  迫不及待的等在台下，他才是今天这里真正的主角，就让我们大家一起响起掌声， 为他送上第一次生日快乐的祝福，同时请他来到舞台的中间，掌声有请，小明登  场。", "tags": ["全流程台词", "开场", "来宾", "流程一", "祝福"]}, {"id": "l_cbe767c65e", "cat": "全流程台词", "title": "流程二:主人公登场", "body": "如果你要是觉得他们的掌声不够响亮，那就试试再一次向各位长辈家人鞠躬 行礼，感谢大家，看看这次掌声是不是能更热情一些。\n祝福小明，12 岁了。可能宝宝还没有当够，就马不停蹄的赶往自己的青春少 年。每个人都要经历成长，这是生命的自然法则。但是不同的年龄会有不同的美 好，也会感受到不同人生阶段的快乐。我们祝愿你可以一直保持无忧无虑，这一 辈子 ，都能将快乐，进行到底。\n看看今天来了好多的人，大家都是为你的生日而来，足以见得爸爸和妈妈的  人缘，还有你是多么的招人喜欢。所以接下来别怠慢了各位叔叔阿姨，还有你的  小伙伴，拿着话筒，跟大家说两句。(  如果孩子有才艺，可以先展示才艺再讲话， 直接把引导讲话的词换成引导才艺的词，比如为了感谢大家的祝福，要为各位展  示自己的才艺等)\n-如果孩子讲的特别棒\n从刚刚的表现来看，我似乎已经有了画面感，在若干年后的一个超大的会场， 自信的小明在演讲台上侃侃而谈，台下都是崇拜和赞许的目光。一个新的演说家  将在这里诞生了，各位不赶快为这位未来的演说家鼓鼓掌?\n-如果孩子讲的很一般\n刚才的这一段话，大家应该是见证了一个历史，略显紧张的小明完成了他人 生中第一次在众人面前的演讲。这对他来说，是一个重要的开始。第一次面对未 知的事物，人们都是这样的状态和情绪，也许他觉得讲话的时候没有掌声，不知 道自己表现的是不是让大家满意，所以这一刻，各位，我们是不是该做点什么了? 缓解一下他的紧张，告诉他，他表现的很棒!谢谢。", "tags": ["主人公登场", "全流程台词", "流程二", "祝福"]}, {"id": "l_ee79e65624", "cat": "全流程台词", "title": "流程三:父母或家人人场", "body": "时间过的多快，十几年前，他的爸爸和妈妈牵着手 ，以新郎和新娘的身份站 在舞台中间，接受着所有亲朋好友的祝福和恭喜。可能他们都已经忘了当天是怎\n\n样的流程，彼此是怎样的表情。如今在台下看到舞台上的宝贝儿子(宝贝女儿)拿 着话 简侃侃而谈，来分享自己 12 岁生日的喜悦。可能他们一边在感叹时光的无 情，一边又谢谢老天的给予，一边失落自己的年轻，一边幸福着孩子带给他们的 惊喜。人生就是这样，一边得到，一边失去，能得到这样一份生命的传承，我们 失去的一切，都有意义。接下来小明同学的爸爸妈妈将要走上舞台了，像十多年 前一样，牵着手 ，走在大家中间，我们给他们热情的鼓鼓掌吧!", "tags": ["全流程台词", "新娘", "新郎", "流程三", "父母", "父母或家人人场", "祝福"]}, {"id": "l_415a0dc69c", "cat": "全流程台词", "title": "流程四:父母代表讲话", "body": "看到刚才孩子的表现了，可能当爸妈的心里会有点压力，讲的太好，盖了主 人公的风头，讲的不好，让人觉得连孩子都不如。不过幸好今天来的都是自己的 家人和好朋友，没有人会笑自己，所以我们就放松心情，慢慢说，慢慢讲，说说 心里的感谢，讲 讲对孩子的期望。有请爸爸(  妈妈)。", "tags": ["全流程台词", "流程四", "父母", "父母代表讲话"]}, {"id": "l_fa0a821560", "cat": "全流程台词", "title": "流程五:圆锁环节", "body": "圆锁是我们国家北方部分地区的习俗，过去是来自于民间的传说，为了让孩  子能健康成长，生命力旺盛而特别为孩子举行的仪式。而现代在我们继承风俗的  基础上，逐渐的改换了观念，变成了父母长辈对小孩的祝福，在宝宝出生的时候  为他准备把锁，期望他健健康康，长命百岁，摆脱蒙昧，开启智慧。在孩子十二  岁生日的这一天，由舅舅将锁打开，而这个重要的仪式环节，叫做圆锁。接下来， 就有请这位承担重任的舅舅，来到舞台上，为外甥(外甥女)圆锁。", "tags": ["仪式", "全流程台词", "圆锁环节", "流程五", "父母", "祝福"]}, {"id": "l_06c29b3503", "cat": "全流程台词", "title": "流程六:圆锁三开，福运自来。 一开:聪明伶俐!", "body": "二开:学业有成! 三开:满堂富贵!\n亲友鼓掌，祝福小福星拥有一个锦绣美好的未来! 流程七:送礼物环节\n个别家族也许会有在这一天给孩 子送礼物的仪式，如果有，请事先沟通， 礼物的寓意请咨询送礼者或根据自己的理解来诠释。圆锁后可以赠送礼物。", "tags": ["一开", "仪式", "全流程台词", "圆锁三开", "流程六", "祝福"]}, {"id": "l_6e7e3040ee", "cat": "全流程台词", "title": "流程八:顶花馍", "body": "有句老话讲，“花馍头上顶，富贵享不停”，顶花馍是我们当地的一个有着吉 祥寓意的传统习俗。在孩子十二 岁生日这一天，头上顶着花馍转圈圈，未来定会 丰衣足食 ，荣华富贵。有请家人将蒸好的一帘花馍举到小福星的头上。\n\n左一圈，长命百岁! 右一圈，福寿绵长!\n咬一口花馍，不愁吃来不愁穿，荣华富贵代代享。 流程九:蛋糕蜡烛\n不管今天有多少的仪式，我们都不能忘了今天的主题，就是小明的十二 岁生 日 。而生日最不能缺少的就是蜡烛和蛋糕，当然还要许下一个美美的小心愿。今 天在我们舞台的一侧，也摆放了一只蛋糕，爸爸和妈妈会像以往一样帮着孩子点 燃蜡烛，请小明来到蛋糕前，双手合十闭上眼睛，在心里悄悄的许下一个愿望。 愿这一只跳动的烛火能照亮你的梦想，照亮你的脸庞，成为你前行的霞光，愿你 的小梦想能像这蛋糕一样，一节更比一节高 ，甜蜜而又闪耀光芒。", "tags": ["仪式", "全流程台词", "流程八", "顶花馍"]}, {"id": "l_62b48d415e", "cat": "全流程台词", "title": "流程十:结束词", "body": "十二 岁是人生中一个普通的年份，但又是不平凡的一个时间节点。这一年， 告别了童年，走向青春，这一年，甩掉了蒙昧，开启了新的智慧。这一年孩子圆  了锁，爸妈圆了心愿，这年，生肖又要开始新的一个轮回。愿十二 岁的小明能带  着爸妈的期望和我们所有人的祝愿，取得更好的成绩，更大的进步。在此我宣布， 小明同学 12 岁生日派对，圆满礼成。祝愿小明生日快乐，祝愿大家每天开心 。 欢迎您来参加小明的圆锁生日宴。再次感谢各位的到来!掌声有请爸妈退场，祝  各位用餐愉快!", "tags": ["全流程台词", "流程十", "结束词", "退场"]}, {"id": "l_2c27cd11dd", "cat": "全流程台词", "title": "流程十一:拍照时间", "body": "请我们的各位小朋友，可以用你们的方式来给今天的小明送上祝福了。我们 可以和他一起拍张照片 ，合影留念。留下这十二 岁最美好的时光。\n\n201 金婚庆典全流程", "tags": ["全流程台词", "合影", "拍照时间", "流程十一", "祝福"]}, {"id": "l_14be113748", "cat": "全流程台词", "title": "流程一:开场", "body": "尊敬的各位来宾，女士们先生们大家中午好，今天我们在这里来共同庆祝王 小明先生 ，李小兰女士 ，两位老人家50 周年的金婚纪念，首先请大家送上我们 共同的一份礼物，热情的掌声，祝愿两位老人家幸福安康，金婚快乐!\n记忆中的缘分是来自媒人介绍，婚姻开始在他们芳年华月的 XXXX 年，在 那个特殊的年代，动荡的时局，和物质的匮乏，都不会影响当时的人们，对于忠 诚至高无上的追求和理解。那个时代的年轻人，对于婚姻的态度，从不奢求一见\n\n倾心，也不知何为嫁给爱情。自由恋爱只是一种美好的向往，而更多的都是遵照 父母之命，听从媒妁之言 。所以，他们不懂得什么是浪漫的爱情，却在 50 年岁 月的蹉跎与洗礼中，把对方变成了自已没有血缘的血亲，甚至变成了自己的半条 生命那样，不能割舍，亦无法分离。\n他们经受过饥荒，经历过动荡，他们沐浴过改革开放的春 风 ， 目睹了一个 破败的国家，如何一步一步的走到今天的繁荣兴旺。他们共同努力的让曾经一贫 如洗的小家，变得枝繁叶茂，变得喜乐美满。在此刻，他们也迎来了自己的金婚 之年。并邀请大家来共同庆祝他们的婚姻，50 年的纪念。现在，有请两位老人家 原地起立 ，向所有嘉宾挥手礼谢，请大家再一次把一份金婚的祝福，化作掌声送 给他们吧!有请两位老人家在家人的搀扶和帮忙下，共同来到典礼舞台。", "tags": ["全流程台词", "开场", "来宾", "流程一", "父母", "祝福"]}, {"id": "l_0a611730d4", "cat": "全流程台词", "title": "流程二:家人代表讲话", "body": "两位老人家是幸福的，幸福的不仅是他们携手走过五十年的风雨人生，彼此 用爱来交织的人生岁月 。幸福的还有他们孩子们有出息，不让他们操心，不给他 们丢脸。如今家里变得原来越好了，除了他们两位老夫妻打下的基础，还有就是 这些优秀的孩子们，继承了家风和传统，不怕辛苦，不畏艰难，勤勤恳恳，踏实 能干。正是他们的组织筹划，要给爸爸妈妈准备一份人生中的仪式感，才有了今 天的两位老人家的金婚庆典。所 以我们首先要请出的是，今天这一场金婚庆典 的策划之一  ， 也是两位老人家的长子，来到台前，向爸妈致敬，向各位送上感 谢，有请!", "tags": ["仪式", "全流程台词", "家人代表讲话", "流程二"]}, {"id": "l_8f4ed1b302", "cat": "全流程台词", "title": "流程三:蛋糕环节", "body": "时光飞逝，岁月轮转。伟大的祖国母亲从 1949 年诞生至今，已经走过了 70 多年的华彩。而两位老人家也已经迈进古来稀 的岁月 。70 多年仿佛一篇交响乐 章，时而淡如流水 ，时而波满壮园。他们走过了半个世纪的婚姻，早已经让彼此 都融进各自的生命里面，我中有你，你中有我，这片辽阔富饶的土地，见证了他 们 50 年风雨同舟，50  年相濡以沫。所以今天他们和我们一起庆祝婚姻的 50 岁生 日 ，而说到生日也一定会有蛋糕，有请 XX 为两位老人家送上金婚的幸福味道。\n请两位老人闭上眼睛，许下一个美好的心愿吧!然后和家人一起吹灭蜡烛。 请我们大家也一起来为他们两位，还有他们的整个家族许下一个美好的心愿， 祝 福他们身体安康，福寿延绵，祝他们金婚快乐，幸福永远。3, 2, 1 吹蜡烛喽!", "tags": ["全流程台词", "流程三", "蛋糕环节"]}, {"id": "l_1082019d28", "cat": "全流程台词", "title": "流程四:金婚证书", "body": "为了让今天的金婚庆典更加的有仪式感，我们也为两位老人家特别定制了一 份金婚证书，有请家中的 XXXX,宣读金婚证书，并为爷爷奶奶颁发!", "tags": ["仪式", "全流程台词", "流程四", "金婚证书"]}, {"id": "l_4a0303941b", "cat": "全流程台词", "title": "流程五:封存白酒", "body": "", "tags": ["全流程台词", "封存白酒", "流程五"]}, {"id": "l_eae836e9d5", "cat": "全流程台词", "title": "50 年中相信他们一定拥有和实现过很多的梦想，希望日子越来越好，希望子", "body": "女成家立业，而此刻最大的心愿一定就是孙子外孙子孙女外孙女早一点结婚，拥  有一个自己的家庭， 所以老人家在此刻把这份祝福和心愿装进一个酒瓶当中， 把它封存起来，不管孙子辈的孩子谁先结婚，我们都会把它拿出来一起品尝和分  享这醇厚的香浓，祝福孩子们也能够风雨同舟，幸福美满未来的 50 十年，60 年， 70 年。愿快乐幸福，永远都萦绕在每一个家人的身边。", "tags": ["全流程台词", "希望子", "希望日子越来越好", "祝福"]}, {"id": "l_1af62d00f4", "cat": "全流程台词", "title": "流程六:家人上台", "body": "", "tags": ["全流程台词", "家人上台", "流程六"]}, {"id": "l_7ed8eda37c", "cat": "全流程台词", "title": "50 年过去了，生活正在一点点的变得更好，如今的老两口都已经退休在家颐 养天年。过着简朴而又富足的生活。简朴并不是因为日子拮据，而是因为这一辈 子，老人家们一直都在恪守着勤俭持家的高尚美德。而富足也并不是因为，他们 住在大大的房子里 ，享受着衣食无忧的安逸，而是老人家心中最宝贵的财富，她 的子孙们，善良孝顺，健康快乐!  在他们金婚庆 典的这一刻，我们也为他们这 一家设计了一个小环节，名字叫金粉世家。有请工作人员。", "body": "", "tags": ["一家设计了一个小环节", "享受着衣食无忧的安逸", "他们", "住在大大的房子里", "全流程台词", "典的这一刻", "善良孝顺", "在他们金婚庆", "年过去了", "我们也为他们这", "的子孙们", "而是因为这一辈"]}, {"id": "l_de27206765", "cat": "全流程台词", "title": "流程七:金粉世家", "body": "(红色纸板上面用胶水写“家” ，家族成员每人一杯金色粉末 ，均匀洒落纸板 上面 ，听主持人的引导，向来宾展示)\n曾经，家就是一个简陋的屋子，因为有了男主人和女主人，慢慢的有了家的  样子。后来他们有了孩子，过着有些清贫却又团圆幸福的日子。一代一代的人为  这个家辛苦的付出着，建设着，才会让家，有了今天的这个样子 。家不是一个房  子 ，以前，爸妈在哪，他们的家就在哪。如今，孩子们在哪，爸妈的家，就在哪。 让我们共同祝福他们家昌业旺，团圆喜乐。幸福永相伴，家和万事兴(这一句将  纸板立起来展示给观众)。", "tags": ["全流程台词", "来宾", "流程七", "祝福", "金粉世家"]}, {"id": "l_9ca286f6ba", "cat": "全流程台词", "title": "流程八:集体敬酒/结束词", "body": "在时光的旅途中，我们总是忙着与时间和过去的自己告别，但同时也满怀憧 憬的期待着即将到来的美好明天。就像此刻的两位老人家和他们的儿孙们，共同 来庆祝这个家族成立的纪念。向前是成长 ，回头是怀念，一路走来有风有雨，这 都是人生对我们成长的历练，他们期待明天的明天，未来的未来，温暖的爱和灿 烂的希望，永远在这个家族，水远都在每个人的身边，各位来寞，斟满美酒，让 我们与这幸福的一家，干杯祝愿，祝愿老人家金婚快乐，祝福大家吉祥平安，干 杯!有请家人和老人家退场。再次主持人宣布，王小明先生和李小兰女士的金婚 庆典仪式部分圆满礼成，金婚酒宴正式开始!请各位用餐。\n\n202 寿宴全流程", "tags": ["仪式", "全流程台词", "敬酒", "流程八", "祝福", "结束词", "退场", "集体敬酒"]}, {"id": "l_14be113748", "cat": "全流程台词", "title": "流程一:开场", "body": "尊敬的各位来宾，女士们先生们大家中午(下午)好!欢迎大家前来参加位老人 生命的华彩时刻，来见证他人生旅途的一座重要的里程碑。我们今天一起来分享 的是刘静香老人 88岁的寿宴，首先代表今天的老寿星和所有的孙男娣女，每位 家 族成员，欢迎大家的光临，也请各位响起一起掌声，我们共同来祝福老人家生日 快乐。平安健康!\n在筹备这次宴会的过程当中，我和我的伙伴们闲聊，有人说，如果真的有前  世今生的话，老太太一定是上辈子做了许多的好事，这辈子才会累积如此大的福  报，如此圆满而丰盈。而我对他们讲，老夫人岂止是上辈子，就连这一生都乐善  好施，广结善缘。在那个战火肆虐的年代，穷困的童年让她并太多没有读书认字  的机会，她也不懂得何为上善若水，厚德载物，她只是知道但行好事，莫问前程。 堂堂正正，就是她做人的根本。佛经里面讲，善恶有报，因果轮回，正是因为这  样处处与人为善的慈悲，才会让老夫人虽近百岁高龄，生命的颂歌依然嘹亮，生  命之树依然挺拔而秀美，才会让老夫人虽近百岁高龄，仍然尽享人间喜乐，为每  一个儿女子孙带来平安富贵。\n孩子们说，老太太不仅仅是一个妈妈， 更像是一个活菩萨， 度化着身边的 一切，用她精神的光辉照耀着家族兴旺发达的明天。今天她已经 88 岁了，仍然 幸福快乐的生活在儿女们的身旁，此刻，做为家中长子的小明先生将做为儿女代 表，为妈妈祝寿贺词，向各位分享自己的心声，掌声有请小明先生。", "tags": ["全流程台词", "开场", "来宾", "流程一", "祝福"]}, {"id": "l_459fff6864", "cat": "全流程台词", "title": "流程二:嘉宾代表致辞", "body": "谢谢小明先生的致辞，他代表的不仅仅是他自己，还有每一个孝子贤孙对老 太太健康长寿的心愿和期盼。然而盼望她健康长寿的一定不止是孩子们，今天来 到现场的每位来宾相信都有着同样的心情。接下来，我们会请上一位嘉宾，代表 各位，向老太太送上生日的祝福，掌声有请今天的特别嘉宾，尊敬 XXX 先生， 隆重登场。", "tags": ["全流程台词", "嘉宾代表致辞", "来宾", "流程二", "祝福"]}, {"id": "l_f809414325", "cat": "全流程台词", "title": "流程三:寿星登场", "body": "如果说一个民族最宝贵的财富是厚重而悠久的历史。一段人生最宝贵的财富， 一定是深邃而丰富的经历。行走在路上的我们，往往看不清那些美丽的风景。而   暮然回首才发现，原来我们走过了那么完美的历程。接下来的时间，让我们共同   品味，刘老夫人的精彩人生。请各位，用我们用最隆重的方式，有请老夫人登上   幸福的舞台，嘉宾挚友全体起立 。热情的掌声有请柳刘静香老寿星，荣登华堂!    掌声祝福人家，寿如松柏，万福金安。", "tags": ["全流程台词", "寿星登场", "流程三", "祝福"]}, {"id": "l_29b4242baa", "cat": "全流程台词", "title": "流程四:拜寿环节", "body": "接着来到了一个重要时刻。我们大家期待已久的拜寿环节。有请第一组拜寿 嘉宾。老人家的儿子女儿 ，儿媳女婿，为老寿星敬花拜寿。\n\n(如需要念名字，需要和事主确定好上场拜寿的人员名单,另，因各地习俗不 同，有些儿女要行跪拜大礼，拜寿应唱为叩首，有些儿女年龄也不小，或身体原 因不便下跪，拜寿应唱为拜首 ，即为鞠躬)\n请子女面向老人站(跪)好。\n一拜首 ，祝福您日月昌明，松鹤长春 再拜首 ，祝福您笑口常开，天伦永享 三拜首 ，祝福您身体健康，长命安康\n(如有献花环节此时可将献花赠与老人家，工作人员接过，引导儿子儿媳等 立于老人身后或身侧，个别地方有老寿星赐福环节，可以事先准备好锦囊，里面 可放红包或硬币，由老太发给大家)\n有请第二组拜寿嘉宾。夫人的孙子孙女 。孙外外孙女 ，上台拜寿。\n一叩首 ，祝福您万事如意，晚年幸福 再叩首 ，祝福您生日快乐，后福无疆 三叩首 ，祝福您吉祥如意，富贵安康\n有请第三组拜寿嘉宾，老夫人的曾孙曾孙女 。为老夫人上台拜寿。\n一叩首 ，祝福您事事顺心 ，青春不老 再叩首 ，祝福您吉祥如意，幸福常伴 三叩首 ，祝福您日月同辉，身体安康 流程五:生日蛋糕\n请老人家的长孙为老寿星带上生日帽，请工作人员推上生日蛋糕，请老人家 和儿女子孙们一起切开这甜蜜的蛋糕。各位来宾，我们一起大声的祝福老太太， 生日快乐!", "tags": ["全流程台词", "拜寿环节", "来宾", "流程四", "祝福"]}, {"id": "l_4c32a982b5", "cat": "全流程台词", "title": "流程六:敬酒环节", "body": "今天的宴会大厅高朋满座，宾友如云，这些都是这个幸福的家族最宝贵的财 富，感恩在人生的路上，能够遇见你们，让他们的人生，让家族的未来，创造了 更多的可能。感恩是我们一个永恒不变的话题，今天这个家族的所有成员也将会 向来宾敬上一杯酒，过去有您的支持，让我们今天得以如此的兴旺昌达，今天有\n\n您的到来,让我们对未来充满希望，未来有您的陪伴，一定会让这个家族永远沐  浴喜乐和暖的阳光。这杯酒敬大家，祝各位今后的日子里 ，家庭幸福和睦，事业  飞黄腾达，财源广进,身体安康，同时也让我们共同举杯祝福老人家 88 岁，生日  快乐!祝我们家和万事兴。至此，刘静香老人 88 岁的生日庆典，到此圆满礼成， 谢谢大家的光临，美酒佳肴请您尽情享用，愿老人家福寿绵长，祝各位身体健康， 愿我们的友谊，地久天长 。谢谢各位!", "tags": ["全流程台词", "敬酒", "敬酒环节", "来宾", "流程六", "祝福"]}];

  const LINES_KEY = "host_lines_state_v2";
  function loadLinesState(){
    try {
      return JSON.parse(localStorage.getItem(LINES_KEY) || "{}") || {};
    } catch(e) { return {}; }
  }
  function saveLinesState(s){
    localStorage.setItem(LINES_KEY, JSON.stringify(s||{}));
  }

  function mergeLines() {
    const st = loadLinesState();
    const deleted = new Set(st.deleted||[]);
    const overrides = st.overrides||{};
    const custom = st.custom||[];
    const catsCustom = st.customCats||[];
    const base = LINES_BASE
      .filter(x=>!deleted.has(x.id))
      .map(x=> overrides[x.id] ? ({...x, ...overrides[x.id], id:x.id, __base:true}) : ({...x, __base:true}));
    const out = base.concat(custom.map(x=>({...x, __base:false})));
    const cats = Array.from(new Set(out.map(x=>x.cat))).concat(catsCustom).filter(Boolean);
    return { list: out, cats: Array.from(new Set(cats)) , st };
  }

  let linesInited = false;
  let linesFilterCat = "ALL";
  let linesSelectedId = null;

  function initLines() {
    if (linesInited) { renderLinesUI(); return; }
    const elSearch = $("#linesSearch");
    if (!elSearch) return;
    linesInited = true;

    $("#btnLinesClearSearch")?.addEventListener("click", ()=>{ elSearch.value=""; renderLinesUI(); });
    elSearch.addEventListener("input", ()=>{ renderLinesUI(); });

    $("#btnLinesNewCat")?.addEventListener("click", ()=> {
      const name = (prompt("新分类名称（例如：开场 / 父母 / 敬酒 / 退场）") || "").trim();
      if (!name) return;
      const st = loadLinesState();
      st.customCats = st.customCats || [];
      if (!st.customCats.includes(name)) st.customCats.push(name);
      saveLinesState(st);
      linesFilterCat = name;
      toast("已新增分类 ✅");
      renderLinesUI();
    });

    $("#btnLinesNew")?.addEventListener("click", ()=> {
      const merged = mergeLines();
      const st = merged.st;
      const newId = "c_" + Math.random().toString(36).slice(2,9) + "_" + Date.now().toString(36);
      const cat = (linesFilterCat==="ALL" ? (merged.cats[0]||"未分类") : linesFilterCat);
      const obj = {id:newId, cat:cat||"未分类", title:"新台词（点我改标题）", body:"", tags:[] };
      st.custom = st.custom || [];
      st.custom.unshift(obj);
      saveLinesState(st);
      linesSelectedId = newId;
      toast("已创建台词 ✅");
      renderLinesUI();
      focusLinesEditor();
    });

    $("#btnLinesSave")?.addEventListener("click", ()=> saveLinesEd());
    $("#btnLinesDelete")?.addEventListener("click", ()=> deleteLinesEd());
    $("#btnLinesCopy")?.addEventListener("click", ()=> {
      const t = $("#linesEdTitle")?.innerText?.trim() || "";
      const b = $("#linesEdBody")?.value || "";
      copyText((t? (t+"\n\n"):"") + b);
      toast("已复制 ✅");
    });

    renderLinesUI();
  }

  function focusLinesEditor(){
    setTimeout(()=>{ $("#linesEdTitle")?.focus(); }, 60);
  }

  function buildCats(merged, q){
    const byCat = {};
    merged.list.forEach(x=>{ 
      if (q) {
        const hay = (x.title+" "+(x.body||"")+" "+(x.tags||[]).join(" ")).toLowerCase();
        if (!hay.includes(q)) return;
      }
      byCat[x.cat] = (byCat[x.cat]||0)+1;
    });
    const cats = merged.cats.slice().sort((a,b)=> (byCat[b]||0)-(byCat[a]||0));
    return {cats, byCat};
  }

  function renderLinesUI(){
    const merged = mergeLines();
    const q = ($("#linesSearch")?.value||"").trim().toLowerCase();
    const {cats, byCat} = buildCats(merged, q);

    const catsWrap = $("#linesCats");
    if (catsWrap) {
      const allCount = merged.list.filter(x=>!q || ((x.title+" "+(x.body||"")+" "+(x.tags||[]).join(" ")).toLowerCase().includes(q))).length;
      const mkBtn = (name, count)=> {
        const b = document.createElement("button");
        b.className = "catBtn" + ((linesFilterCat===name) ? " active" : "");
        b.type="button";
        b.innerHTML = `<div><div style="font-weight:900">${h(name==="ALL"?"全部":name)}</div><div class="cmeta">${count} 条</div></div><div class="chip">${count}</div>`;
        b.addEventListener("click", ()=>{ linesFilterCat = name; renderLinesUI(); });
        return b;
      };
      catsWrap.innerHTML="";
      catsWrap.appendChild(mkBtn("ALL", allCount));
      cats.forEach(c=> catsWrap.appendChild(mkBtn(c, byCat[c]||0)));
    }

    const listWrap = $("#linesList");
    const listTitle = $("#linesListTitle");
    const listSub = $("#linesListSub");
    if (listTitle) listTitle.textContent = (linesFilterCat==="ALL" ? "台词列表" : ("台词列表 · "+linesFilterCat));
    if (listSub) listSub.textContent = q ? ("搜索："+q) : ("共 "+ merged.list.length +" 条（含默认库 + 你新增/修改的）");

    const filtered = merged.list.filter(x=> {
      const matchCat = (linesFilterCat==="ALL") || (x.cat===linesFilterCat);
      if (!matchCat) return false;
      if (!q) return true;
      const hay = (x.title+" "+(x.body||"")+" "+(x.tags||[]).join(" ")).toLowerCase();
      return hay.includes(q);
    });

    if (listWrap) {
      if (!filtered.length) {
        listWrap.innerHTML = `<div class="muted-small">没有匹配的台词。换个关键词试试，或点“新建台词”。</div>`;
      } else {
        listWrap.innerHTML = "";
        filtered.slice(0, 500).forEach(x=> {
          const card = document.createElement("div");
          card.className = "lineCard" + ((linesSelectedId===x.id) ? " active" : "");
          const snippet = (x.body||"").replace(/\s+/g," ").slice(0, 68);
          const meta = [x.cat].concat((x.tags||[]).slice(0,4));
          card.innerHTML = `
            <div class="t">${h(x.title)}</div>
            <div class="m">${meta.map(m=>`<span class="chip">${h(m)}</span>`).join("")}</div>
            <div class="muted-small" style="margin-top:6px">${h(snippet || "—")}…</div>
            <div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap">
              ${x.__base ? `<button class="sbtn" data-restore="1">恢复默认</button>` : ``}
            </div>
          `;
          card.addEventListener("click", (e)=> {
            if ((e.target && e.target.getAttribute("data-restore")==="1")) return;
            linesSelectedId = x.id;
            renderLinesUI();
            fillLinesEditor(x.id);
          });
          card.querySelector("[data-restore]")?.addEventListener("click", (e)=> {
            e.stopPropagation();
            restoreBaseLine(x.id);
          });
          listWrap.appendChild(card);
        });
        if (!linesSelectedId && filtered[0]) {
          linesSelectedId = filtered[0].id;
          fillLinesEditor(linesSelectedId);
          renderLinesUI();
        } else if (linesSelectedId) {
          fillLinesEditor(linesSelectedId);
        }
      }
    }

    const sel = $("#linesEdCat");
    if (sel) {
      const current = sel.value || linesFilterCat;
      sel.innerHTML = merged.cats
        .slice()
        .sort((a,b)=>a.localeCompare(b))
        .map(c=>`<option value="${h(c)}">${h(c)}</option>`).join("");
      const cur = (current && merged.cats.includes(current)) ? current : (merged.cats[0]||"未分类");
      sel.value = cur;
    }
  }

  function findLineById(id){
    const merged = mergeLines();
    return merged.list.find(x=>x.id===id) || null;
  }

  function fillLinesEditor(id){
    const x = findLineById(id);
    if (!x) return;
    $("#linesEdTitle").innerText = x.title || "";
    $("#linesEdBody").value = x.body || "";
    const sel = $("#linesEdCat");
    if (sel) sel.value = x.cat || (sel.value||"未分类");
    $("#linesEdTags").value = (x.tags||[]).join(", ");
  }

  function saveLinesEd(){
    const id = linesSelectedId;
    if (!id) return toast("先选一条台词");
    const t = ($("#linesEdTitle")?.innerText||"").trim() || "未命名台词";
    const b = ($("#linesEdBody")?.value||"").trim();
    const cat = ($("#linesEdCat")?.value||"未分类").trim() || "未分类";
    const tags = ($("#linesEdTags")?.value||"").split(",").map(s=>s.trim()).filter(Boolean);

    const st = loadLinesState();
    const base = LINES_BASE.find(x=>x.id===id);
    if (base) {
      st.overrides = st.overrides || {};
      st.overrides[id] = { title:t, body:b, cat:cat, tags:tags };
      saveLinesState(st);
      toast("已保存（覆盖默认）✅");
    } else {
      st.custom = st.custom || [];
      const idx = st.custom.findIndex(x=>x.id===id);
      if (idx!==-1) {
        st.custom[idx] = {...st.custom[idx], title:t, body:b, cat:cat, tags:tags };
        saveLinesState(st);
        toast("已保存 ✅");
      }
    }
    linesFilterCat = cat;
    renderLinesUI();
  }

  function deleteLinesEd(){
    const id = linesSelectedId;
    if (!id) return;
    const st = loadLinesState();
    const base = LINES_BASE.find(x=>x.id===id);
    if (base) {
      st.deleted = st.deleted || [];
      if (!st.deleted.includes(id)) st.deleted.push(id);
      if (st.overrides) delete st.overrides[id];
      saveLinesState(st);
      toast("已删除（从列表隐藏）✅");
    } else {
      st.custom = (st.custom||[]).filter(x=>x.id!==id);
      saveLinesState(st);
      toast("已删除 ✅");
    }
    linesSelectedId = null;
    renderLinesUI();
  }

  function restoreBaseLine(id){
    const st = loadLinesState();
    if (st.overrides) delete st.overrides[id];
    st.deleted = (st.deleted||[]).filter(x=>x!==id);
    saveLinesState(st);
    toast("已恢复默认 ✅");
    renderLinesUI();
  }



  // =========================
  // v2.1 Final: Line Picker (insert to client section)
  // =========================
  const picker = $("#linePicker");
  const btnClosePicker = $("#btnClosePicker");
  const pickerSearch = $("#pickerSearch");
  const pickerCats = $("#pickerCats");
  const pickerList = $("#pickerList");
  let pickerForSecId = null;
  let pickerCat = "ALL";

  function mergedLinesForPicker(){
    // reuse Lines module merge if exists
    try{
      if (typeof mergeLines === "function"){
        return mergeLines().list || [];
      }
    }catch(e){}
    // fallback (should not happen)
    return (window.LINES_BASE || []);
  }

  function showPicker(secId){
    pickerForSecId = secId;
    pickerCat = "ALL";
    if (pickerSearch) pickerSearch.value="";
    renderPicker();
    picker?.classList.add("show");
    picker?.setAttribute("aria-hidden","false");
  }
  function hidePicker(){
    picker?.classList.remove("show");
    picker?.setAttribute("aria-hidden","true");
    pickerForSecId = null;
  }
  btnClosePicker?.addEventListener("click", hidePicker);
  picker?.addEventListener("click", (e)=>{ if (e.target===picker) hidePicker(); });
  pickerSearch?.addEventListener("input", ()=> renderPicker());

  function renderPicker(){
    if (!pickerCats || !pickerList) return;
    const q = (pickerSearch?.value||"").trim().toLowerCase();
    const all = mergedLinesForPicker();

    const filtered = all.filter(x=>{
      if (pickerCat!=="ALL" && x.cat!==pickerCat) return false;
      if (!q) return true;
      const hay = (x.title+" "+(x.body||"")+" "+(x.tags||[]).join(" ")).toLowerCase();
      return hay.includes(q);
    });

    // cats
    const byCat = {};
    all.forEach(x=>{
      if (q){
        const hay=(x.title+" "+(x.body||"")+" "+(x.tags||[]).join(" ")).toLowerCase();
        if (!hay.includes(q)) return;
      }
      byCat[x.cat]=(byCat[x.cat]||0)+1;
    });
    const cats = Array.from(new Set(all.map(x=>x.cat))).sort((a,b)=>(byCat[b]||0)-(byCat[a]||0));

    const mkCat = (name, count)=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="catBtn"+(pickerCat===name?" active":"");
      b.innerHTML = `<div style="font-weight:900">${h(name==="ALL"?"全部":name)}</div><div class="chip">${count||0}</div>`;
      b.addEventListener("click", ()=>{ pickerCat=name; renderPicker(); });
      return b;
    };
    pickerCats.innerHTML="";
    const allCount = Object.values(byCat).reduce((a,b)=>a+b,0);
    pickerCats.appendChild(mkCat("ALL", allCount));
    cats.forEach(c=> pickerCats.appendChild(mkCat(c, byCat[c]||0)));

    // list
    if (!filtered.length){
      pickerList.innerHTML = `<div class="muted-small">没有匹配的台词。换个关键词试试。</div>`;
      return;
    }
    pickerList.innerHTML="";
    filtered.slice(0, 300).forEach(x=>{
      const el=document.createElement("div");
      el.className="pItem";
      const snippet=(x.body||"").replace(/\s+/g," ").slice(0, 90);
      el.innerHTML = `<div class="t">${h(x.title)}</div>
                      <div class="s">${h(x.cat)} · ${(x.tags||[]).slice(0,4).map(t=>h(t)).join(" / ")}</div>
                      <div class="muted-small" style="margin-top:6px">${h(snippet||"—")}…</div>`;
      el.addEventListener("click", ()=>{
        if (!pickerForSecId) return;
        const txt = (x.body && x.body.trim()) ? x.body : x.title;
        const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
        draft.overrides = draft.overrides || {};
        const cur = (draft.overrides[pickerForSecId] && Array.isArray(draft.overrides[pickerForSecId])) ? draft.overrides[pickerForSecId] : [];
        draft.overrides[pickerForSecId] = cur.concat(lines.length?lines:[txt]);
        renderClientScriptBox(pickerForSecId);
        markDirty();
        toast("已插入台词 ✅（记得保存档期）");
        hidePicker();
      });
      pickerList.appendChild(el);
    });
  }

  // Hook into client toolbar
  const _bindClientToolbar = bindClientToolbar;
  bindClientToolbar = function(block, secId){
    _bindClientToolbar(block, secId);
    const tools = block.querySelector(`[data-cs-tools="${secId}"]`);
    const pickBtn = tools?.querySelector(`[data-action="pick"]`);
    pickBtn?.addEventListener("click", ()=> showPicker(secId));
  };

  // =========================
  // v2.1 Final: Cue Sheet print
  // =========================
  const btnPrintCue = $("#btnPrintCue");
  btnPrintCue?.addEventListener("click", ()=>{
    try{
      readFormToDraft();
      ensureTimeline();
      const rows = (draft.timeline||[]).slice().sort((a,b)=> (timeToMin(a.time)||0)-(timeToMin(b.time)||0));
      const head = `
        <div class="cueTop">
          <div class="cueTitle">Cue Sheet / 点位表</div>
          <div class="cueMeta">
            <div><b>客户：</b>${h(draft.clientName||"—")}</div>
            <div><b>婚期：</b>${h(draft.date||"—")} ${h(draft.time||"")}</div>
            <div><b>酒店：</b>${h(draft.weddingHotel||"—")}</div>
            <div><b>电话：</b>${h(draft.phone||"—")}</div>
            <div><b>地址：</b>${h(draft.address||"—")}</div>
          </div>
          <div class="cueNote"><b>备注：</b>${h(draft.notes||"")}</div>
        </div>
      `;
      const table = `
        <table class="cueTable">
          <thead><tr><th style="width:90px">时间</th><th>环节</th><th>备注</th></tr></thead>
          <tbody>
            ${rows.map(r=>`<tr><td>${h(r.time||"")}</td><td>${h(r.name||"")}</td><td>${h(r.note||"")}</td></tr>`).join("")}
          </tbody>
        </table>
      `;
      const w = window.open("", "_blank");
      const css = `
        <style>
          @page{ size:A4; margin:12mm; }
          body{ font-family: ui-sans-serif, -apple-system, "PingFang SC", "Microsoft YaHei"; color:#111; }
          .cueTitle{ font-size:20px; font-weight:900; margin-bottom:8px; }
          .cueMeta{ display:grid; grid-template-columns: 1fr 1fr; gap:6px 14px; font-size:12px; }
          .cueNote{ margin-top:8px; font-size:12px; }
          .cueTable{ width:100%; border-collapse:collapse; margin-top:12px; font-size:12px;}
          .cueTable th,.cueTable td{ border:1px solid #999; padding:8px; vertical-align:top; }
          .cueTable th{ background:#f2f2f2; text-align:left; }
          .foot{ margin-top:10px; font-size:11px; color:#666; }
        
  /* queue item mode (per-item): 顺序 / 单曲循环 / 播完暂停 */
  #queueList .qModeWrap{display:flex; gap:6px; align-items:center; flex-wrap:wrap}
  #queueList .sbtn.qMode{padding:6px 8px; min-width:34px}
  #queueList .sbtn.qMode.on{
    background: color-mix(in srgb, var(--pri) 18%, transparent);
    border-color: color-mix(in srgb, var(--pri) 55%, var(--line));
  }
  #queueList .qModeBadge{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 8px; border-radius:999px;
    border:1px solid var(--line);
    background: rgba(255,255,255,.06);
    margin-left:10px;
    font-weight:600;
  }
</style>
      `;
      w.document.write(`<!doctype html><html><head><meta charset="utf-8"/>${css}</head><body>${head}${table}<div class="foot">打印提示：建议“缩放 100% / 纵向 / 只打印此页”。</div></body></html>`);
      w.document.close();
      w.focus();
      setTimeout(()=> w.print(), 250);
    }catch(e){
      console.error(e);
      toast("打印失败：请先打开一个档期再试");
    }
  });

  // =========================
  
  // =========================
  // v2.1 Final: Music categories + waveform trimming + draggable clip
  // =========================
  const libCats = $("#libCats");
  const libScroll = $("#libScroll");
  let activeCat = "全部";
  const MUSIC_CATS_KEY = "music_cats_v2";
  function loadCats(){ try{ return JSON.parse(localStorage.getItem(MUSIC_CATS_KEY)||"[]")||[]; }catch(e){ return []; } }
  function saveCats(c){ localStorage.setItem(MUSIC_CATS_KEY, JSON.stringify(c||[])); }

  async function deleteCatDirect(name){
    name = (name||"").trim();
    if (!name || name==="全部") return;
    // 1) update stored custom categories
    const cur = loadCats();
    if (cur.includes(name)){
      saveCats(cur.filter(x=>x!==name));
    }
    // 2) reassign tracks
    ensureTrackCats();
    const touched = (MUSIC.tracks||[]).filter(t=> (t.cat||"未分类")===name);
    for (const t of touched){
      t.cat = "未分类";
      try{ await dbPut("tracks", t); }catch(e){}
    }
    // 3) reset active
    if (activeCat===name) activeCat="全部";
    toast(`已删除分类：${name}`);
    renderCats(); renderLibrary();
  }

  function ensureTrackCats(){
    (MUSIC.tracks||[]).forEach(t=>{ if (!t.cat) t.cat="未分类"; });
  }
  function allCatsFromTracks(){
    ensureTrackCats();
    const set = new Set(["全部"]);
    (MUSIC.tracks||[]).forEach(t=> set.add(t.cat||"未分类"));
    loadCats().forEach(x=> set.add(x));
    return Array.from(set).filter(Boolean);
  }

  function renderCats(){
    if (!libCats) return;
    const cats = allCatsFromTracks();
    const userCats = loadCats(); // custom cats
    libCats.innerHTML="";
    cats.forEach(c=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="chipBtn"+(activeCat===c?" active":"");
      const canDel = (c!=="全部" && c!=="未分类"); // keep built-ins safe
      b.innerHTML = `<span>${h(c)}</span>` + (canDel ? `<span class="x" title="删除分类" data-cat-del="1">×</span>` : ``);

      b.addEventListener("click", ()=>{
        activeCat = c;
        renderCats();
        renderLibrary();
      });

      if (canDel){
        b.querySelector("[data-cat-del]")?.addEventListener("click", (e)=>{
          e.preventDefault();
          e.stopPropagation();
          // no confirm, direct delete
          deleteCatDirect(c);
        });
      }

      libCats.appendChild(b);
    });

    // inline add cat
    const add=document.createElement("button");
    add.type="button";
    add.className="chipBtn";
    add.innerHTML = `<span class="x">＋ 分类</span>`;
    add.addEventListener("click", ()=>{
      const chip=document.createElement("button");
      chip.type="button";
      chip.className="chipBtn editing";
      chip.contentEditable="true";
      chip.spellcheck=false;
      chip.innerText="新分类";
      libCats.insertBefore(chip, add);
      chip.focus();
      const commit=()=>{
        const name=(chip.innerText||"").trim();
        chip.contentEditable="false";
        chip.classList.remove("editing");
        if (!name){ chip.remove(); return; }
        const cur=loadCats();
        if (!cur.includes(name)) { cur.push(name); saveCats(cur); }
        activeCat = name;
        toast("已新增分类 ✅");
        renderCats(); renderLibrary();
      };
      chip.addEventListener("blur", commit, {once:true});
      chip.addEventListener("keydown", (e)=>{
        if (e.key==="Enter"){ e.preventDefault(); chip.blur(); }
        if (e.key==="Escape"){ e.preventDefault(); chip.remove(); }
      });
    });
    libCats.appendChild(add);
  }

  // Filter library by category + keep search
  const _renderLibrary = renderLibrary;
  renderLibrary = function(){
    ensureTrackCats();
    const q = ($("#libSearch")?.value||"").trim().toLowerCase();
    const all = (MUSIC.tracks||[]).slice();
    const filtered = all.filter(t=>{
      if (activeCat!=="全部" && (t.cat||"未分类")!==activeCat) return false;
      if (!q) return true;
      return (t.name||"").toLowerCase().includes(q);
    });

    const backup = MUSIC.tracks;
    MUSIC.tracks = filtered;
    _renderLibrary();
    MUSIC.tracks = backup;

    // library scroll slider
    const libListEl = $("#libList");
    if (libScroll && libListEl){
      const max = Math.max(0, (libListEl.scrollHeight - libListEl.clientHeight));
      libScroll.max = String(Math.max(1, max));
      libScroll.value = String(Math.min(max, libListEl.scrollTop||0));
      libScroll.oninput = ()=>{ libListEl.scrollTop = parseInt(libScroll.value,10)||0; };
      libListEl.onscroll = ()=>{ libScroll.value = String(Math.min(max, libListEl.scrollTop||0)); };
    }
  };

  // When adding files, assign current category (best effort, no弹窗)
  const _addFilesToLibrary = addFilesToLibrary;
  addFilesToLibrary = async function(files, alsoAddToQueue=false){
    const before = new Set((MUSIC.tracks||[]).map(t=>t.id));
    await _addFilesToLibrary(files, alsoAddToQueue);
    ensureTrackCats();
    const newOnes = (MUSIC.tracks||[]).filter(t=>!before.has(t.id));
    const cat = (activeCat==="全部") ? "未分类" : activeCat;
    for (const t of newOnes){
      t.cat = cat;
      try{ await dbPut("tracks", t); }catch(e){}
    }
    renderCats();
    renderLibrary();
  };

  // After library UI ready, render cats once
  const _bindLibraryUI = bindLibraryUI;
  bindLibraryUI = function(){
    _bindLibraryUI();
    renderCats();
    setTimeout(()=> renderLibrary(), 40);
  };

  // -------- Waveform trimming inside clip drawer --------
  const clipWave = $("#clipWave");
  const btnSaveClipAs = $("#btnSaveClipAs");
  const clipHandle = $("#clipHandle");
  let clipBuf = null;
  let clipPeaks = null;
  let waveIdx = -1;
  let waveDragging = null; // 'start'|'end'|'range'|null

  function getWaveCtx(){
    if (!MUSIC.audioCtx){
      MUSIC.audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    }
    return MUSIC.audioCtx;
  }

  function getWaveState(idx){
    const q = MUSIC.queue[idx];
    if (!q) return null;
    const tr = trackById(q.trackId);
    const dur = tr?.duration || 0;
    const start = (typeof q.start==="number") ? q.start : 0;
    const end = (typeof q.end==="number") ? q.end : dur;
    return { q, tr, dur, start, end };
  }

  function secToPx(sec, dur){
    const w = clipWave ? clipWave.width : 1;
    return (sec/Math.max(0.001,dur))*w;
  }
  function pxToSec(px, dur){
    const w = clipWave ? clipWave.width : 1;
    return Math.max(0, Math.min(dur, (px/w)*dur));
  }

  function computePeaks(buffer, points){
    const n = points || (clipWave?clipWave.width:1200);
    const ch = buffer.getChannelData(0);
    const step = Math.floor(ch.length / n) || 1;
    const peaks = new Float32Array(n);
    for (let i=0;i<n;i++){
      const start=i*step;
      let end=start+step;
      if (end>ch.length) end=ch.length;
      let max=0;
      for (let j=start;j<end;j++){
        const v=Math.abs(ch[j]);
        if (v>max) max=v;
      }
      peaks[i]=max;
    }
    return peaks;
  }

  function drawWave(){
    if (!clipWave) return;
    const st = getWaveState(waveIdx);
    if (!st) return;
    const {dur, start, end} = st;
    const ctx = clipWave.getContext("2d");
    const w = clipWave.width, h = clipWave.height;
    ctx.clearRect(0,0,w,h);

    // peaks
    if (clipPeaks){
      const mid=h/2;
      ctx.fillStyle="rgba(0,0,0,.18)";
      for (let x=0;x<clipPeaks.length;x++){
        const p=clipPeaks[x];
        const y=p*(h*0.42);
        ctx.fillRect(x, mid-y, 1, y*2);
      }
    }else{
      ctx.fillStyle="rgba(0,0,0,.55)";
      ctx.font="600 16px sans-serif";
      ctx.fillText("波形加载中…", 12, 28);
      return;
    }

    // selection
    const xs = secToPx(start, dur);
    const xe = secToPx(end, dur);
    ctx.fillStyle="rgba(120,120,255,.18)";
    ctx.fillRect(xs, 0, Math.max(2, xe-xs), h);
    ctx.fillStyle="rgba(120,120,255,.85)";
    ctx.fillRect(xs-2, 0, 4, h);
    ctx.fillRect(xe-2, 0, 4, h);
  }

  async function ensureWave(idx){
    const st = getWaveState(idx);
    if (!st) return;
    const blob = st.tr?.blob;
    if (!blob) return;
    waveIdx = idx;
    try{
      const ab = await blob.arrayBuffer();
      const ctx = getWaveCtx();
      clipBuf = await ctx.decodeAudioData(ab.slice(0));
      clipPeaks = computePeaks(clipBuf, clipWave?clipWave.width:1200);
      drawWave();
    }catch(e){
      console.warn("decode fail", e);
    }
  }

  function applyClip(idx, s, e){
    const st = getWaveState(idx);
    if (!st) return;
    const {q, dur} = st;
    const minLen = 0.2;
    let start = Math.max(0, Math.min(dur, s));
    let end = Math.max(start+minLen, Math.min(dur, e));
    q.start = start;
    q.end = end;

    // sync UI inputs
    const cs=$("#clipStart"), ce=$("#clipEnd"), csn=$("#clipStartNum"), cen=$("#clipEndNum");
    if (cs && ce){
      cs.value = String(start);
      ce.value = String(end);
    }
    if (csn && cen){
      csn.value = String(start.toFixed(2));
      cen.value = String(end.toFixed(2));
    }
    updateClipLabel();
    persistActivePlaylistFromQueue();
    if (MUSIC.currentIndex===idx){
      MUSIC.segStart = q.start;
      MUSIC.segEnd = q.end;
      MUSIC.segTriggered = false;
    }
    renderQueue();
    setNowPlaying();
    drawWave();
  }

  // Hook openClip to prepare waveform + keep redraw in sync
  const _openClip = openClip;
  openClip = function(idx){
    _openClip(idx);
    setTimeout(()=>{
      ensureWave(idx);
      // redraw when sliders move
      $("#clipStart")?.addEventListener("input", ()=>drawWave());
      $("#clipEnd")?.addEventListener("input", ()=>drawWave());
      $("#clipStartNum")?.addEventListener("change", ()=>drawWave());
      $("#clipEndNum")?.addEventListener("change", ()=>drawWave());
      drawWave();
    }, 80);
  };

  // Draggable clip drawer
  (function(){
    const drawer = $("#clipDrawer");
    if (!drawer || !clipHandle) return;
    let dragging=false, ox=0, oy=0, sx=0, sy=0;
    clipHandle.style.cursor="move";
    clipHandle.addEventListener("mousedown", (e)=>{
      if (e.target && (e.target.id==="btnSaveClipAs")) return;
      dragging=true;
      const r=drawer.getBoundingClientRect();
      ox=r.left; oy=r.top;
      sx=e.clientX; sy=e.clientY;
      drawer.style.left = ox+"px";
      drawer.style.top = oy+"px";
      drawer.style.bottom = "auto";
      drawer.style.transform = "none";
      e.preventDefault();
    });
    window.addEventListener("mousemove", (e)=>{
      if (!dragging) return;
      const nx = ox + (e.clientX - sx);
      const ny = oy + (e.clientY - sy);
      drawer.style.left = Math.max(8, Math.min(window.innerWidth - drawer.offsetWidth - 8, nx))+"px";
      drawer.style.top = Math.max(8, Math.min(window.innerHeight - drawer.offsetHeight - 8, ny))+"px";
    });
    window.addEventListener("mouseup", ()=> dragging=false);
  })();

  // Waveform interactions: drag handles / range
  (function(){
    if (!clipWave) return;
    const hit = (px, st)=>{
      const xs=secToPx(st.start, st.dur);
      const xe=secToPx(st.end, st.dur);
      if (Math.abs(px-xs)<10) return "start";
      if (Math.abs(px-xe)<10) return "end";
      if (px>xs && px<xe) return "range";
      return null;
    };

    clipWave.addEventListener("dblclick", (e)=>{
      // Double-click waveform = select whole segment (but never blank the waveform)
      e.preventDefault();
      e.stopPropagation();
      const st = getWaveState(waveIdx);
      if (!st) return;
      const doAll = ()=>{
        const st2 = getWaveState(waveIdx);
        const d = (clipBuf?.duration || st2?.dur || 0);
        if (!st2) return;
        applyClip(waveIdx, 0, d || st2.dur);
      };
      if (!clipPeaks){
        ensureWave(waveIdx).then(()=>{ doAll(); }).catch(()=>{});
        return;
      }
      doAll();
    });

    clipWave.addEventListener("mousedown", (e)=>{
      const st = getWaveState(waveIdx);
      if (!st) return;
      const rect=clipWave.getBoundingClientRect();
      const px=(e.clientX-rect.left)*(clipWave.width/rect.width);
      waveDragging = hit(px, st) || "end";
      // click outside selection -> move end to click
      if (waveDragging==="end"){
        const sec=pxToSec(px, st.dur);
        applyClip(waveIdx, st.start, Math.max(sec, st.start+0.2));
      }
      e.preventDefault();
    });

    window.addEventListener("mousemove", (e)=>{
      if (!waveDragging) return;
      const st = getWaveState(waveIdx);
      if (!st) return;
      const rect=clipWave.getBoundingClientRect();
      const inside = e.clientX>=rect.left && e.clientX<=rect.right;
      if (!inside) return;
      const px=(e.clientX-rect.left)*(clipWave.width/rect.width);
      const sec=pxToSec(px, st.dur);
      const span=st.end-st.start;
      const minLen=0.2;
      if (waveDragging==="start"){
        applyClip(waveIdx, Math.min(sec, st.end-minLen), st.end);
      }else if (waveDragging==="end"){
        applyClip(waveIdx, st.start, Math.max(sec, st.start+minLen));
      }else if (waveDragging==="range"){
        let ns=sec - span/2;
        ns=Math.max(0, Math.min(st.dur-span, ns));
        applyClip(waveIdx, ns, ns+span);
      }
    });

    window.addEventListener("mouseup", ()=> waveDragging=null);
  })();

  // Save clip as new track (WAV) into library
  function floatTo16BitPCM(output, offset, input){
    for (let i=0;i<input.length;i++, offset+=2){
      let s = Math.max(-1, Math.min(1, input[i]));
      output.setInt16(offset, s<0 ? s*0x8000 : s*0x7FFF, true);
    }
  }
  function writeString(view, offset, string){
    for (let i=0;i<string.length;i++){ view.setUint8(offset+i, string.charCodeAt(i)); }
  }
  function encodeWAVFromBuffer(buffer, startSec, endSec){
    const sr = buffer.sampleRate;
    const s = Math.max(0, Math.min(buffer.duration, startSec||0));
    const e = Math.max(s+0.01, Math.min(buffer.duration, endSec||buffer.duration));
    const start = Math.floor(s * sr);
    const end = Math.floor(e * sr);
    const length = end - start;
    const ch0 = buffer.getChannelData(0).slice(start, end);
    const bytesPerSample = 2;
    const blockAlign = bytesPerSample;
    const byteRate = sr * blockAlign;
    const dataSize = length * blockAlign;

    const ab = new ArrayBuffer(44 + dataSize);
    const view = new DataView(ab);
    writeString(view, 0, "RIFF");
    view.setUint32(4, 36 + dataSize, true);
    writeString(view, 8, "WAVE");
    writeString(view, 12, "fmt ");
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, 1, true);
    view.setUint32(24, sr, true);
    view.setUint32(28, byteRate, true);
    view.setUint16(32, blockAlign, true);
    view.setUint16(34, 16, true);
    writeString(view, 36, "data");
    view.setUint32(40, dataSize, true);
    floatTo16BitPCM(view, 44, ch0);
    return new Blob([view], {type:"audio/wav"});
  }

  btnSaveClipAs?.addEventListener("click", async ()=>{
    try{
      const st = getWaveState(waveIdx);
      if (!st) return toast("请先打开一首队列音乐的裁剪");
      if (!clipBuf) await ensureWave(waveIdx);
      if (!clipBuf) return toast("波形尚未加载");
      const blob = encodeWAVFromBuffer(clipBuf, st.start, st.end);
      const id = idNow("trk");
      const baseName = st.tr?.name || "片段";
      const name = `${baseName}_${fmtTime(st.start)}-${fmtTime(st.end)}`;
      const duration = Math.max(0.1, st.end - st.start);
      const item = { id, name, blob, duration, cat: st.tr?.cat || "未分类", createdAt: Date.now() };
      MUSIC.tracks.push(item);
      try{ await dbPut("tracks", item); }catch(e){}
      toast("已保存为新曲目 ✅");
      renderCats();
      renderLibrary();
    }catch(err){
      console.error(err);
      toast("保存片段失败（可能浏览器限制）");
    }
  });


// =========================
  // v2.1 Final: Copy generator 20+ frames
  // =========================
  const COPY_FRAMES = [
    (v)=>`${v.hook}

你遇到的不是“偶尔翻车”，而是典型的：${v.stage}里${v.pain}。

我给你一个“现场可执行”的三步：
1）先把负责人叫到一起：主持/酒店/摄影摄像，30秒对齐下一步。
2）再用一句口令锁定动作：谁站哪里、音乐从哪进、镜头对准谁。
3）最后留个B方案：一旦出意外，直接切换，不解释不慌。

口令模板：
“我来报节点——下一步是【环节】；音乐点位我数3-2-1进；站位按我手势走。”

${v.cta}`,
    (v)=>`${v.hook}

很多新人以为氛围靠“热闹”，其实靠“节奏”。${v.stage}卡在${v.pain}时，越补越乱。

把流程收紧：
- 删：所有可有可无的串词
- 留：一个高光动作（镜头/走位/音乐）
- 定：一个明确结束点（到点就切下一环节）

你要${v.benefit}，就别赌临场发挥。

${v.cta}`,
    (v)=>`${v.hook}

【新手主持救场清单】
✅ 先稳新人：一句话告诉他们“我来控场，你们只管享受”。
✅ 再稳现场：把“人/物/音乐/镜头”四件事对齐。
✅ 最后稳节奏：每个环节只讲一段“有画面的话”，别堆词。

最常见的坑：${v.pain}。
你把这个点提前写进时间轴，婚礼当天就不会乱。

${v.cta}`,
    (v)=>`${v.hook}

如果你只记一个原则：
“先把现场变简单，再把情绪变浓。”

${v.stage}遇到${v.pain}时，按这个顺序做：
① 先让关键人站位固定
② 再让音乐点位固定
③ 最后才让台词上情绪

这样做的好处：氛围更稳，你也更容易把控镜头与节奏。

${v.cta}`,
    (v)=>`${v.hook}

你想${v.benefit}，别只换标题。
内容交付要有“画面感+动作点+口令”。

给你一个万能结构：
【场景】${v.stage}
【坑】${v.pain}
【动作】我做了哪3步
【结果】现场怎么被拉回来
【模板】一句可复用口令

这条你照着拍，45秒很好撑满。

${v.cta}`,
    (v)=>`${v.hook}

我见过最多的翻车，不是新人紧张，而是${v.pain}没人负责。

把责任说清楚：
- 酒店负责：灯光/音响/麦克
- 摄影负责：机位/走位提醒
- 主持负责：口令/节奏/收尾

你只要做对一件事：把“谁负责什么”写进时间轴。

${v.cta}`,
    (v)=>`${v.hook}

婚礼现场最怕的不是意外，是“意外发生后没人敢拍板”。

遇到${v.pain}，你直接用三句：
1）“我来控节奏。”
2）“下一步按我口令走。”
3）“到点切环节，不解释。”

你会发现：你越果断，现场越安静。

${v.cta}`,
    (v)=>`${v.hook}

【同城新人必收藏】
${v.stage}最容易踩的坑就是：${v.pain}。

解决思路很简单：
先把“动作”定出来，再把“台词”贴上去。
动作三件套：站位 → 镜头 → 音乐点位。

这三件事定了，哪怕台词少两句，氛围也不会垮。

${v.cta}`,
    (v)=>`${v.hook}

你问我婚礼为什么会冷？
90%是因为：主持在讲，现场在等，镜头在找。

反过来做：
先给镜头一个“目标动作”（走位/拥抱/举杯）
再给音乐一个“进点”
最后才给台词一段“情绪”

${v.stage}卡在${v.pain}时，这套顺序最救命。

${v.cta}`,
    (v)=>`${v.hook}

【一条就够用的口令】
“我数3-2-1，音乐进，新人走到点位停，镜头跟上。”

为什么这句好用？
因为它把${v.pain}拆成了三个动作：音乐、走位、镜头。

新手主持最怕忘词？别怕，你只要记住“动作口令”，就能稳住场。

${v.cta}`,
    (v)=>`${v.hook}

如果你是新人：把这一条转发给伴郎伴娘。
如果你是主持：把这一条写进Cue Sheet。

${v.stage}最容易翻车点：${v.pain}。
解决：提前3分钟做一次“彩排式对齐”，每个人只确认一件事。

彩排口令：
“站位确认→音乐确认→镜头确认→我开口。”

${v.cta}`,
    (v)=>`${v.hook}

【抖音适配拍法】
开头3秒：直接抛出“${v.pain}”的画面。
中间：给一个“动作口令”。
结尾：给一个“可复制模板”。

内容别讲大道理，就讲一件事：${v.stage}怎么救。

${v.cta}`,
    (v)=>`${v.hook}

【小红书收藏版】
标题解决“搜什么”，正文解决“怎么做”。

${v.stage}遇到${v.pain}，你按这张表做：
- 负责人：谁
- 时间点：什么时候
- 音乐点：从哪进
- 镜头点：拍谁
- 台词点：说哪句

写进时间轴，一次就会。

${v.cta}`,
    (v)=>`${v.hook}

你以为你缺的是台词，其实你缺的是“节点感”。

节点感怎么练？
把${v.stage}拆成：进入→停顿→动作→收尾。
每个节点只说一句“有画面的话”。

当${v.pain}出现，你就能立刻判断：该推进还是该停住。

${v.cta}`,
    (v)=>`${v.hook}

【现场1分钟救场法】
0–20秒：把新人情绪稳住
20–40秒：把关键人站位固定
40–60秒：把音乐和镜头对齐

你会发现：只要站位和音乐不乱，${v.pain}就不会扩散。

${v.cta}`,
    (v)=>`${v.hook}

很多主持喜欢“多说”，结果越说越尬。

${v.stage}出现${v.pain}时，你只需要：
- 少说：一句口令
- 多做：一个动作
- 快切：下一环节

氛围是被“推动”的，不是被“解释”的。

${v.cta}`,
    (v)=>`${v.hook}

如果你是酒店：记住这三点，主持会很感谢你。
1）麦克正常
2）音乐到点
3）灯光不乱跳

${v.stage}最怕${v.pain}，多半是这三点没对齐。

${v.cta}`,
    (v)=>`${v.hook}

【来宾视角】
来宾不在乎你说了多少词，他们只在乎：什么时候开始、哪里看、什么时候鼓掌。

所以${v.stage}遇到${v.pain}，你把信息说清楚就行：
“大家看这里”“掌声给到”“我们继续下一步”。

${v.cta}`,
    (v)=>`${v.hook}

【五大金刚协同】
主持负责口令，摄影负责镜头，摄像负责机位，灯光负责氛围，音控负责进点。

${v.stage}一旦${v.pain}，先把“口令链路”打通：
主持一句→音控一键→灯光一键→镜头到位。

${v.cta}`,
    (v)=>`${v.hook}

你要的是“稳”，不是“花”。

把${v.pain}提前写进应急预案：
A方案：正常走
B方案：缩短串词 + 直接切环节
C方案：音乐一停→我直接口令推进

新手照着做，现场就不会被带乱。

${v.cta}`,
  ];

  function genCopy(vars){
    const tone = vars.tone;
    const hookTpl = pickToneHook(tone);
    const hook = formatTpl(hookTpl, vars);

    const v = {
      ...vars,
      hook,
      cta: `\n\n${rnd(GEN.ctas)}`
    };

    // Expand to 20+ by combining frames with variants
    const base = rnd(COPY_FRAMES);
    const extra = rnd([
      `\n\n加一条小提醒：所有“口令”最好提前和酒店/摄影对齐一次，别到现场才喊。`,
      `\n\n如果你在同城，建议标题里带酒店/区域关键词，抖音更容易推到同城新人。`,
      `\n\n想要“模板包”的，把这条收藏；婚礼当天你只需要照着时间轴执行。`
    ]);
    const out = base(v) + extra;
    return clampLen(out, 520, 860);
  }


// =========================
// v2.4 Patch: Music system fixes (playlists+cats+resizer+queue-state)
// - library-only collapse (remove "收起左侧" effect)
// - restore categories (chips + delete + filter + per-track category)
// - library scroll comfort
// - playlist click -> load queue + queue title suffix
// - playlist drag reorder (persist order)
// - add list-loop button (mutual exclusive with single-loop)
// - hotkeys + external remote support (space/arrows + media keys) + MediaSession
// =========================
(function(){
  try{
    if (typeof MUSIC !== "object" || !MUSIC) return;

    // ---- 0) State
    if (MUSIC.loopAll === undefined) MUSIC.loopAll = false;
    const normalizeLoopState = ()=>{
      if (MUSIC.loopAll){
        MUSIC.loopOne = false;
        if (MUSIC.mode === "pause") MUSIC.mode = "next";
      }
    };

    // ---- 1) Prefs: loopAll + force leftCollapsed off
    if (typeof loadMusicPrefs === "function"){
      const _loadMusicPrefs_v23 = loadMusicPrefs;
      loadMusicPrefs = function(){
        _loadMusicPrefs_v23();
        try{
          const p = JSON.parse(localStorage.getItem("mc_music_prefs") || "{}");
          MUSIC.loopAll = !!p.loopAll;
        }catch(e){}
        normalizeLoopState();
      };
    }
    if (typeof saveMusicPrefs === "function"){
      saveMusicPrefs = function(){
        try{
          const raw = localStorage.getItem("mc_music_prefs");
          const p = raw ? JSON.parse(raw) : {};
          p.mode = MUSIC.mode || "next";
          p.loopOne = !!MUSIC.loopOne;
          p.loopAll = !!MUSIC.loopAll;

          const a = $("#audioEl");
          if (a && typeof a.volume === "number") p.vol = a.volume;
          if (!MUSIC.layout) MUSIC.layout = {};
          p.libW = MUSIC.layout.libW ?? p.libW ?? 340;
          p.plW  = MUSIC.layout.plW  ?? p.plW  ?? 240;
          p.leftCollapsed = false;
          p.libCollapsed  = !!(MUSIC.layout.libCollapsed ?? p.libCollapsed);
          p.qSize = MUSIC.layout.qSize ?? p.qSize ?? 2;

          localStorage.setItem("mc_music_prefs", JSON.stringify(p));
        }catch(e){}
      };
    }

    // ---- 2) Queue title suffix
    window.applyPlaylistPlayback = function(pl){
      if (!pl) return;
      try{
        const loopAll = !!pl.loopAll;
        const mode = (pl.mode === "pause") ? "pause" : "next";
        const loopOne = (pl.loopOne === undefined) ? true : !!pl.loopOne;
        MUSIC.loopAll = loopAll;
        MUSIC.mode = mode;
        MUSIC.loopOne = loopOne;
        if (MUSIC.loopAll){ MUSIC.loopOne = false; MUSIC.mode = "next"; }
        if (MUSIC.mode === "pause"){ MUSIC.loopOne = false; MUSIC.loopAll = false; }
        if (typeof syncModeHint === "function") syncModeHint();
        if (typeof saveMusicPrefs === "function") saveMusicPrefs();
      }catch(e){}
    }

    function updateQueueTitle(){
      const el = $("#queueTitle");
      if (!el) return;
      const pl = (typeof playlistById === "function") ? playlistById(MUSIC.activePlId) : null;
      el.textContent = pl ? `当前队列 · ${pl.name || "未命名"}` : "当前队列";
    }

    // ---- 3) Mode hint (include loopAll)
    if (typeof syncModeHint === "function"){
      syncModeHint = function(){
        const bLoop = $("#btnLoop");
        const bLoopAll = $("#btnLoopAll");
        const bMode = $("#btnMode");
        if (bLoop) bLoop.classList.toggle("active", !!MUSIC.loopOne);
        if (bLoopAll) bLoopAll.classList.toggle("active", !!MUSIC.loopAll);
        if (bMode){ bMode.innerHTML = (MUSIC.mode === "pause") ? "⏸" : "⏭"; bMode.title = (MUSIC.mode === "pause") ? "播完暂停" : "播完下一曲"; }
        const hint = $("#modeHint");
        if (hint){
          if (MUSIC.loopOne) hint.textContent = "模式：单曲循环（片段循环）";
          else if (MUSIC.loopAll) hint.textContent = "模式：列表循环（末尾回到第一首）";
          else hint.textContent = (MUSIC.mode === "pause") ? "模式：播完暂停" : "模式：播完下一曲";
        }
      };
    }

    // ---- 4) Segment end behavior: loopAll
    if (typeof handleSegmentEnd === "function"){
      handleSegmentEnd = function(){
        const a = $("#audioEl");
        if (!a) return;
        normalizeLoopState();

        if (MUSIC.loopOne){
          MUSIC.segTriggered = false;
          a.currentTime = MUSIC.segStart || 0;
          safePlay(a);
          return;
        }
        if (MUSIC.mode === "pause"){
          a.pause();
          if (typeof syncPlayBtn === "function") syncPlayBtn();
          return;
        }
        const next = MUSIC.currentIndex + 1;
        if (next < MUSIC.queue.length){
          if (typeof playTrack === "function") playTrack(next, true);
          return;
        }
        if (MUSIC.loopAll && MUSIC.queue.length){
          if (typeof playTrack === "function") playTrack(0, true);
        } else {
          a.pause();
          if (typeof syncPlayBtn === "function") syncPlayBtn();
        }
      };
    }

    // ---- 5) Layout: ONLY collapse library. Remove duplicate button.
    if (typeof updateMusicLayoutButtons === "function"){
      updateMusicLayoutButtons = function(){
        const grid = $("#kgGrid");
        if (!grid) return;

        const bLib = $("#btnToggleLeft"); // keep this one
        const bDup = $("#btnToggleLib");  // hide this one
        const bRe  = $("#btnReopenLeft"); // hide reopen
        if (bDup) bDup.style.display = "none";
        if (bRe)  bRe.style.display  = "none";

        if (bLib){
          const libCollapsed = grid.classList.contains("kgLibCollapsed");
          bLib.textContent = libCollapsed ? "⟫ 展开音乐库" : "⟪ 收起音乐库";
          bLib.title = "仅收起/展开：音乐库";
        }
      };
    }

    if (typeof initMusicLayout === "function"){
      initMusicLayout = function(){
        const grid = $("#kgGrid");
        if (!grid) return;

        let p = {};
        try{ p = JSON.parse(localStorage.getItem("mc_music_prefs") || "{}"); }catch(e){ p = {}; }
        if (typeof ensureMusicLayoutDefaults === "function") p = ensureMusicLayoutDefaults(p);
        p.leftCollapsed = false;

        MUSIC.layout = {
          libW: p.libW ?? 340,
          plW:  p.plW  ?? 240,
          leftCollapsed: false,
          libCollapsed: !!p.libCollapsed,
          qSize: p.qSize ?? 2
        };

        if (typeof setMusicPaneVars === "function") setMusicPaneVars(MUSIC.layout.libW, MUSIC.layout.plW);
      if (typeof applyLibListH === "function"){ try{ applyLibListH(); }catch(_e){} }
        grid.classList.remove("kgLeftCollapsed");
        grid.classList.remove("kgLibCollapsed"); MUSIC.layout.libCollapsed = false;
        if (typeof applyQueueSize === "function") applyQueueSize(MUSIC.layout.qSize);
        updateMusicLayoutButtons();

        const btnToggle = $("#btnToggleLeft");
        const btnReset  = $("#btnResetPanes");
        const btnQS     = $("#btnQueueSmaller");
        const btnQB     = $("#btnQueueBigger");

        const setLibCollapsed = (on)=>{
          MUSIC.layout.libCollapsed = !!on;
          grid.classList.remove("kgLibCollapsed"); MUSIC.layout.libCollapsed = false;
          updateMusicLayoutButtons();
          saveMusicPrefs();
        };

        if (btnToggle){
          const c = btnToggle.cloneNode(true);
          btnToggle.parentNode.replaceChild(c, btnToggle);
          c.addEventListener("click", ()=> setLibCollapsed(!grid.classList.contains("kgLibCollapsed")));
        }

        if (btnReset){
          const c = btnReset.cloneNode(true);
          btnReset.parentNode.replaceChild(c, btnReset);
          c.addEventListener("click", ()=>{
            MUSIC.layout.libW = 340;
            MUSIC.layout.plW  = 240;
            MUSIC.layout.leftCollapsed = false;
            MUSIC.layout.libCollapsed  = false;
            if (typeof setMusicPaneVars === "function") setMusicPaneVars(MUSIC.layout.libW, MUSIC.layout.plW);
      if (typeof applyLibListH === "function"){ try{ applyLibListH(); }catch(_e){} }
            grid.classList.remove("kgLeftCollapsed");
            grid.classList.remove("kgLibCollapsed");
            MUSIC.layout.qSize = 2;
            if (typeof applyQueueSize === "function") applyQueueSize(MUSIC.layout.qSize);
            updateMusicLayoutButtons();
            saveMusicPrefs();
            if (typeof toast === "function") toast("已重置布局 ✅");
          });
        }

        if (btnQS){
          const c = btnQS.cloneNode(true);
          btnQS.parentNode.replaceChild(c, btnQS);
          c.addEventListener("click", ()=>{
            MUSIC.layout.qSize = clampNum(MUSIC.layout.qSize - 1, 0, 4);
            applyQueueSize(MUSIC.layout.qSize);
            saveMusicPrefs();
          });
        }
        if (btnQB){
          const c = btnQB.cloneNode(true);
          btnQB.parentNode.replaceChild(c, btnQB);
          c.addEventListener("click", ()=>{
            MUSIC.layout.qSize = clampNum(MUSIC.layout.qSize + 1, 0, 4);
            applyQueueSize(MUSIC.layout.qSize);
            saveMusicPrefs();
          });
        }

        // If user starts resizing lib while collapsed, auto expand first.
        grid.querySelectorAll(".kgResizer[data-resize='lib']").forEach(res=>{
          res.addEventListener("pointerdown", ()=>{
            if (grid.classList.contains("kgLibCollapsed")){
              grid.classList.remove("kgLibCollapsed");
              MUSIC.layout.libCollapsed = false;
              updateMusicLayoutButtons();
              saveMusicPrefs();
            }
          }, {capture:true});
        });
      };
    }

    // ---- 6) Categories (chips + delete + filter + per-track edit)
    let activeCat = "全部";
    function loadCats(){
      try{ return JSON.parse(localStorage.getItem("mc_music_cats") || "[]") || []; }catch(e){ return []; }
    }
    function saveCats(arr){
      try{ localStorage.setItem("mc_music_cats", JSON.stringify(arr || [])); }catch(e){}
    }
    function allCatsFromTracks(){
      const s = new Set();
      (MUSIC.tracks || []).forEach(t => s.add((t.cat || "未分类")));
      return Array.from(s).filter(Boolean);
    }
    function ensureTrackCats(){
      const cats = new Set(loadCats());
      cats.add("未分类");
      let needPersist = [];
      (MUSIC.tracks || []).forEach(t=>{
        if (!t.cat){
          t.cat = "未分类";
          needPersist.push(t);
        }
        cats.add(t.cat || "未分类");
      });
      if (needPersist.length){
        (async ()=>{
          for (const t of needPersist){
            try{ await dbPut("tracks", t); }catch(e){}
          }
        })();
      }
      saveCats(Array.from(cats).filter(c=>c && c!=="全部"));
    }
    async function deleteCat(cat){
      if (!cat || cat === "全部") return;
      for (const t of (MUSIC.tracks || [])){
        if ((t.cat || "未分类") === cat){
          t.cat = "未分类";
          try{ await dbPut("tracks", t); }catch(e){}
        }
      }
      saveCats(loadCats().filter(c=>c !== cat));
      if (activeCat === cat) activeCat = "全部";
      renderCats();
      renderLibrary();
      if (typeof toast === "function") toast("已删除分类");
    }

    function renderCats(){
      const wrap = $("#libCats");
      if (!wrap) return;
      ensureTrackCats();
      const cats = ["全部", ...Array.from(new Set([...loadCats(), ...allCatsFromTracks()])).filter(Boolean)];
      wrap.innerHTML = cats.map(c=>{
        const act = (c === activeCat) ? "active" : "";
        const del = (c !== "全部") ? `<span class="chipDel" title="删除分类">×</span>` : "";
        return `<div class="chip ${act}" data-cat="${h(c)}"><span class="chipTxt">${h(c)}</span>${del}</div>`;
      }).join("");

      wrap.querySelectorAll("[data-cat]").forEach(chip=>{
        chip.addEventListener("click", (e)=>{
          if (e.target && e.target.classList && e.target.classList.contains("chipDel")) return;
          activeCat = chip.getAttribute("data-cat") || "全部";
          renderCats();
          renderLibrary();
        });
        const del = chip.querySelector(".chipDel");
        if (del){
          del.addEventListener("click", async (e)=>{
            e.stopPropagation();
            const c = chip.getAttribute("data-cat");
            await deleteCat(c);
          });
        }
      });
    }

    if (typeof renderLibrary === "function"){
      const _renderLibrary_v23 = renderLibrary;
      renderLibrary = function(){
        const wrap = $("#libList");
        if (!wrap) return _renderLibrary_v23();

        const q = String($("#libSearch")?.value || "").trim().toLowerCase();
        ensureTrackCats();
        const cat = activeCat || "全部";

        const list = (MUSIC.tracks || []).slice()
          .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0))
          .filter(t=>{
            if (q && !String(t.name||"").toLowerCase().includes(q)) return false;
            if (cat !== "全部" && (t.cat || "未分类") !== cat) return false;
            return true;
          });

        if (!list.length){
          wrap.innerHTML = `<div class="muted">暂无音乐（或该分类下没有音乐）。点“上传/拖入”或把文件拖到上面区域。</div>`;
          return;
        }

        const cats = ["未分类", ...Array.from(new Set([...loadCats(), ...allCatsFromTracks()])).filter(c=>c && c!=="未分类" && c!=="全部")];

        wrap.innerHTML = list.map(tr=>{
          const curCat = tr.cat || "未分类";
          const options = cats.map(c=>`<option value="${h(c)}"${c===curCat?" selected":""}>${h(c)}</option>`).join("");
          return `
            <div class="kgItem" data-track-id="${tr.id}">
          <div class="kgGrip" draggable="true" data-drag-track="${tr.id}" title="拖拽：加入队列/播放列表">⋮⋮</div>
              <div class="kgLeft">
                <div class="kgName" contenteditable="true" data-tr-name="1">${h(tr.name||"未命名")}</div>
                <div class="kgSub">${fmtTime(tr.duration||0)} · 分类：
                  <select class="miniSel" data-cat-sel="1">${options}</select>
                  · 拖到队列/播放列表 · 或点右侧“+队列”
                </div>
              </div>
              <div class="kgRight">
                <button class="sbtn" data-addq="1">+队列</button>
                <button class="sbtn danger" data-del="1">删</button>
              </div>
            </div>
          `;
        }).join("");

        wrap.querySelectorAll("[data-track-id]").forEach(card=>{
          // Drag reorder via handle (more reliable than dragging editable text)
          const handle = card.querySelector("[data-pl-drag]");
          if (handle){
            handle.addEventListener("dragstart", (e)=>{
              e.dataTransfer.effectAllowed = "move";
              try{ e.dataTransfer.setData("text/plain", card.getAttribute("data-pl-id") || ""); }catch(_){}
              card.classList.add("dragging");
            });
            handle.addEventListener("dragend", ()=>{
              card.classList.remove("dragging");
            });
          }

          card.addEventListener("dragover", (e)=>{
            e.preventDefault();
            const dragging = wrap.querySelector(".dragging");
            if (!dragging || dragging === card) return;
            const rect = card.getBoundingClientRect();
            const before = (e.clientY - rect.top) < rect.height/2;
            wrap.insertBefore(dragging, before ? card : card.nextSibling);
          });

          card.addEventListener("drop", async (e)=>{
            e.preventDefault();
            const ids = Array.from(wrap.querySelectorAll("[data-pl-id]")).map(el=>el.getAttribute("data-pl-id"));
            const newList = ids.map(id => (MUSIC.playlists||[]).find(p=>p.id===id)).filter(Boolean);
            MUSIC.playlists = newList;
            await persistPlaylistOrder(newList);
            renderPlaylists();
          });
        });

        wrap.querySelectorAll("[data-pl-play]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const id = btn.closest("[data-pl-id]")?.getAttribute("data-pl-id");
            if (id && typeof loadPlaylistToQueue === "function") loadPlaylistToQueue(id, true);
          });
        });

        wrap.querySelectorAll("[data-pl-del]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.closest("[data-pl-id]")?.getAttribute("data-pl-id");
            if (!id) return;
            const pl = (MUSIC.playlists||[]).find(p=>p.id===id);
            if (!confirm(`确认删除播放列表「${pl?.name||"未命名"}」？`)) return;

            MUSIC.playlists = (MUSIC.playlists||[]).filter(p=>p.id!==id);
            await dbDel("playlists", id);

            if (MUSIC.activePlId === id){
              MUSIC.activePlId = MUSIC.playlists[0]?.id || null;
              if (MUSIC.activePlId) await loadPlaylistToQueue(MUSIC.activePlId, false);
            }
            renderPlaylists();
            updateQueueTitle();
            if (typeof toast === "function") toast("已删除播放列表");
          });
        });

        wrap.querySelectorAll("[data-pl-name]").forEach(el=>{
          el.addEventListener("blur", async ()=>{
            const id = el.closest("[data-pl-id]")?.getAttribute("data-pl-id");
            const pl = (MUSIC.playlists||[]).find(p=>p.id===id);
            if (!pl) return;
            pl.name = el.textContent.trim() || "未命名";
            pl.updatedAt = Date.now();
            await dbPut("playlists", pl);
            renderPlaylists();
            updateQueueTitle();
          });
        });
      };
    }

    // Fix missing function in v2.1: playlist click handler refers to loadPlaylist
    if (typeof window !== "undefined" && typeof window.loadPlaylist === "undefined" && typeof loadPlaylistToQueue === "function"){
      window.loadPlaylist = function(id){ return loadPlaylistToQueue(id, true); };
    }

    // keep queue title updated even when other actions trigger render
    if (typeof renderQueue === "function"){
      const _renderQueue_v23 = renderQueue;
      renderQueue = function(){
        _renderQueue_v23();
        updateQueueTitle();
        updateMediaSession();
      };
    }

    // ---- 8) Player UI: loopAll button (互斥单曲循环)
    if (typeof bindPlayerUI === "function"){
      const _bindPlayerUI_v23 = bindPlayerUI;
      bindPlayerUI = function(){
        _bindPlayerUI_v23();
        const bAll = $("#btnLoopAll");
        if (bAll){
          bAll.addEventListener("click", ()=>{
            MUSIC.loopAll = !MUSIC.loopAll;
            if (MUSIC.loopAll){
              MUSIC.loopOne = false;
              if (MUSIC.mode === "pause") MUSIC.mode = "next";
            }
            saveMusicPrefs();
            syncModeHint();
          });
        }
      };
    }

    // ---- 9) Hotkeys + remote + MediaSession
    function bindMusicHotkeys(){
      if (MUSIC._hotkeysBound) return;
      MUSIC._hotkeysBound = true;

      const adjustVol = (d)=>{
        const a = $("#audioEl");
        if (!a) return;
        let v = (a.volume ?? 0.85) + d;
        v = Math.max(0, Math.min(1, v));
        a.volume = v;
        const vb = $("#volBar");
        if (vb) vb.value = String(v);
        saveMusicPrefs();
      };

      document.addEventListener("keydown", (e)=>{
        const vMusic = $("#viewMusic");
        if (vMusic && !vMusic.classList.contains("active")) return;

        if (e.ctrlKey || e.metaKey || e.altKey) return;
        const ae = document.activeElement;
        const tag = (ae?.tagName || "").toLowerCase();
        if (ae && (ae.isContentEditable || tag==="input" || tag==="textarea" || tag==="select")) return;

        const code = e.code;

        // Media keys / some remotes
        if (code === "MediaPlayPause"){ e.preventDefault(); togglePlay(); return; }
        if (code === "MediaTrackNext"){ e.preventDefault(); playPrevNext(1); return; }
        if (code === "MediaTrackPrevious"){ e.preventDefault(); playPrevNext(-1); return; }
        if (code === "MediaStop"){
          e.preventDefault();
          const a = $("#audioEl");
          if (a){ a.pause(); syncPlayBtn(); }
          return;
        }

        // Remote mode2: 左 / 空格 / 右
        if (code === "Space"){ e.preventDefault(); togglePlay(); return; }
        if (code === "ArrowLeft"){ e.preventDefault(); playPrevNext(-1); return; }
        if (code === "ArrowRight"){ e.preventDefault(); playPrevNext(1); return; }
        if (code === "ArrowUp" || code === "PageUp"){ e.preventDefault(); adjustVol(+0.05); return; }
        if (code === "ArrowDown" || code === "PageDown"){ e.preventDefault(); adjustVol(-0.05); return; }
      }, {passive:false});
    }

    function bindMediaSession(){
      if (MUSIC._mediaSessionBound) return;
      MUSIC._mediaSessionBound = true;
      if (!("mediaSession" in navigator)) return;
      try{
        navigator.mediaSession.setActionHandler("play", ()=>{ const a = $("#audioEl"); if (a && a.paused) togglePlay(); });
        navigator.mediaSession.setActionHandler("pause", ()=>{ const a = $("#audioEl"); if (a && !a.paused) togglePlay(); });
        navigator.mediaSession.setActionHandler("previoustrack", ()=> playPrevNext(-1));
        navigator.mediaSession.setActionHandler("nexttrack", ()=> playPrevNext(1));
        navigator.mediaSession.setActionHandler("stop", ()=>{ const a = $("#audioEl"); if (a){ a.pause(); syncPlayBtn(); }});
      }catch(e){}
      updateMediaSession();
    }

    function updateMediaSession(){
      try{
        if (!("mediaSession" in navigator)) return;
        const ms = navigator.mediaSession;
        const q = (MUSIC.queue || [])[MUSIC.currentIndex];
        const tr = q ? trackById(q.trackId) : null;
        const title = tr?.name || q?.title || "未命名";
        if (typeof MediaMetadata !== "undefined"){
          ms.metadata = new MediaMetadata({ title, artist:"", album:"" });
        }
        const a = $("#audioEl");
        ms.playbackState = (a && !a.paused && !a.ended) ? "playing" : "paused";
      }catch(e){}
    }

    if (typeof setNowPlaying === "function"){
      const _setNowPlaying_v23 = setNowPlaying;
      setNowPlaying = function(){
        _setNowPlaying_v23();
        updateQueueTitle();
        updateMediaSession();
      };
    }
    if (typeof togglePlay === "function"){
      const _togglePlay_v23 = togglePlay;
      togglePlay = function(){
        _togglePlay_v23();
        updateMediaSession();
      };
    }
    if (typeof playTrack === "function"){
      const _playTrack_v23 = playTrack;
      playTrack = function(i, forcePlay=true){
        const r = _playTrack_v23(i, forcePlay);
        setTimeout(updateMediaSession, 0);
        return r;
      };
    }

    // ---- 10) initMusic wrapper: ensure cats + hotkeys + playlist order + media session
    if (typeof initMusic === "function"){
      const _initMusic_v23 = initMusic;
      initMusic = async function(){
        await _initMusic_v23();

        renderCats();
        bindMusicHotkeys();
        bindMediaSession();

        // Normalize playlist order if missing
        if (Array.isArray(MUSIC.playlists) && MUSIC.playlists.length){
          const missing = MUSIC.playlists.some(pl => pl.order === undefined || pl.order === null);
          if (missing){
            const ordered = sortPlaylistsForUI(MUSIC.playlists);
            await persistPlaylistOrder(ordered);
            renderPlaylists();
          }
        }

        updateQueueTitle();
        syncModeHint();
        updateMediaSession();
      };
    }

    // If already inited (e.g. user hot-reload), bind once
    if (MUSIC.inited){
      try{ renderCats(); }catch(e){}
      try{ updateQueueTitle(); }catch(e){}
      try{ bindMusicHotkeys(); }catch(e){}
      try{ bindMediaSession(); }catch(e){}
    }
  }catch(e){
    console.error("v2.4 music patch failed", e);
  }
})();


// =========================
// v2.4.3 Patch: Music system fixes (only the items you requested)
// - 三列分割线：可拖动 + 放宽拖拽命中范围/宽度范围
// - 音乐库分类：可隐藏（按钮）+ 新增不弹窗（自动生成）+ 删除不弹窗并归入“未分类”
// - 音乐库音乐列表：可上下拉伸（真正生效）
// - 播放列表：指针拖拽排序（更稳定更顺滑，不依赖⋮⋮手柄）
// =========================
(function(){
  try{
    if (typeof MUSIC !== "object" || !MUSIC) return;

    // -------- 1) widen divider drag ranges (so it's easier to make narrow/wide)
    if (typeof ensureMusicLayoutDefaults === "function"){
      const _ensure = ensureMusicLayoutDefaults;
      ensureMusicLayoutDefaults = function(p){
        p = _ensure(p||{});
        p.libW = clampNum(p.libW ?? 340, 140, 900);
        p.plW  = clampNum(p.plW  ?? 240, 120, 900);
        return p;
      };
    }
    if (typeof setMusicPaneVars === "function"){
      const _set = setMusicPaneVars;
      setMusicPaneVars = function(libW, plW){
        const grid = $("#kgGrid");
        if (!grid) return _set(libW, plW);
        grid.style.setProperty("--kgLibW", clampNum(libW, 140, 900) + "px");
        grid.style.setProperty("--kgPlW",  clampNum(plW, 120, 900) + "px");
      };
    }

    // -------- 2) robust resizer binding (avoid "拖不动/很难抓住")
    if (typeof initMusicLayout === "function"){
      const _init = initMusicLayout;
      initMusicLayout = function(){
        _init();
        const grid = $("#kgGrid");
        if (!grid) return;

        // Make hit area wider even if CSS gets overridden elsewhere
        grid.style.setProperty("--kgRes1", "44px");
        grid.style.setProperty("--kgRes2", "44px");

        // Re-bind with a robust document-level move/up (once)
        grid.querySelectorAll(".kgResizer[data-resize]").forEach(res=>{
          if (res.dataset.bound243 === "1") return;
          res.dataset.bound243 = "1";

          res.addEventListener("pointerdown", (e)=>{
            if (e.button!==0 && e.pointerType!=="touch") return;
            e.preventDefault();

            const type = res.getAttribute("data-resize");
            const startX = e.clientX;
            const startLib = MUSIC.layout?.libW ?? 340;
            const startPl  = MUSIC.layout?.plW  ?? 240;

            res.classList.add("dragging");
            try{ res.setPointerCapture?.(e.pointerId); }catch(err){}

            const onMove = (ev)=>{
              const dx = (ev.clientX - startX);
              if (!MUSIC.layout) MUSIC.layout = {};
              if (type==="lib"){
                MUSIC.layout.libW = clampNum(startLib + dx, 140, 900);
              }else{
                MUSIC.layout.plW  = clampNum(startPl + dx, 120, 900);
              }
              setMusicPaneVars(MUSIC.layout.libW, MUSIC.layout.plW);
      if (typeof applyLibListH === "function"){ try{ applyLibListH(); }catch(_e){} }
            };
            const onUp = ()=>{
              res.classList.remove("dragging");
              document.removeEventListener("pointermove", onMove, true);
              document.removeEventListener("pointerup", onUp, true);
              document.removeEventListener("pointercancel", onUp, true);
              try{ saveMusicPrefs(); }catch(err){}
            };

            document.addEventListener("pointermove", onMove, true);
            document.addEventListener("pointerup", onUp, true);
            document.addEventListener("pointercancel", onUp, true);
          }, {passive:false});
        });

        // Ensure cats toggle works + shows "隐藏/显示分类"
        const btnCatsToggle = $("#btnCatsToggle");
        const colLib = $("#kgColLib");
        if (btnCatsToggle && colLib && btnCatsToggle.dataset.bound243 !== "1"){
          btnCatsToggle.dataset.bound243 = "1";
          const apply = ()=>{
            const hidden = !!(MUSIC.layout?.catsHidden);
            colLib.classList.toggle("catsHidden", hidden);
            btnCatsToggle.textContent = hidden ? "显示分类" : "隐藏分类";
          };
          apply();
          btnCatsToggle.addEventListener("click", ()=>{
            if (!MUSIC.layout) MUSIC.layout = {};
            MUSIC.layout.catsHidden = !MUSIC.layout.catsHidden;
            apply();
            try{ saveMusicPrefs(); }catch(err){}
          });
        }
      };
    }

    // -------- 3) category delete (no confirm) + reassign to "未分类" for ALL tracks
    deleteCatDirect = async function(name){
      name = (name||"").trim();
      if (!name || name==="全部" || name==="未分类") return;

      // remove from custom cats list
      const cur = (loadCats()||[]).filter(Boolean);
      if (cur.includes(name)){
        saveCats(cur.filter(x=>x!==name));
      }

      // update DB (source of truth)
      let all = [];
      try{ all = await dbGetAll("tracks"); }catch(err){ all = (MUSIC.tracks||[]).slice(); }
      for (const t of all){
        if ((t.cat||"未分类") === name){
          t.cat = "未分类";
          try{ await dbPut("tracks", t); }catch(e){}
        }
      }

      // update in-memory
      (MUSIC.tracks||[]).forEach(t=>{ if ((t.cat||"未分类")===name) t.cat="未分类"; });
      if (typeof activeCat !== "undefined" && activeCat===name) activeCat="全部";

      try{ toast(`已删除分类：${name}`); }catch(err){}
      try{ renderCats(); }catch(err){}
      try{ renderLibrary(); }catch(err){}
    };

    // -------- 4) categories: add without popup (auto name) + delete without popup + inline rename by double click
    if (typeof renderCats === "function"){
      renderCats = function(){
        const wrap = $("#libCats");
        if (!wrap) return;

        try{ ensureTrackCats(); }catch(err){}

        const custom = (loadCats()||[]).filter(Boolean);
        const fromTracks = Array.from(new Set((MUSIC.tracks||[]).map(t => (t.cat||"未分类")))).filter(Boolean);
        const cats = Array.from(new Set(["全部", "未分类", ...fromTracks, ...custom])).filter(Boolean);

        wrap.innerHTML = "";

        const makeChip = (cat)=>{
          const isAll = cat==="全部";
          const isBuilt = (cat==="未分类");
          const isCustom = custom.includes(cat);

          const b = document.createElement("button");
          b.type="button";
          b.className="chipBtn"+(activeCat===cat?" active":"");

          b.innerHTML = `<span class="chipTxt">${h(cat)}</span>` + ((isCustom && !isAll && !isBuilt) ? `<span class="x" data-cat-del="1" title="删除">×</span>` : ``);

          b.addEventListener("click", (e)=>{
            if (e.target && e.target.closest && e.target.closest("[data-cat-del]")) return;
            activeCat = cat;
            renderCats(); renderLibrary();
          });

          if (isCustom && !isAll && !isBuilt){
            b.querySelector("[data-cat-del]")?.addEventListener("click", (e)=>{
              e.preventDefault(); e.stopPropagation();
              deleteCatDirect(cat);
            });

            // rename: double click (no popup), inline input
            b.addEventListener("dblclick", (e)=>{
              e.preventDefault(); e.stopPropagation();
              const span = b.querySelector(".chipTxt");
              if (!span) return;
              const old = (span.textContent||"").trim() || cat;

              const inp = document.createElement("input");
              inp.className = "chipRename";
              inp.value = old;

              span.replaceWith(inp);
              inp.focus();
              inp.select();

              const commit = async ()=>{
                const nn = (inp.value||"").trim();
                if (!nn || nn===old){ renderCats(); return; }

                const cur = (loadCats()||[]).filter(Boolean);
                if (cur.includes(nn)){
                  try{ toast("已存在同名分类"); }catch(err){}
                  renderCats(); return;
                }

                // update custom cats storage
                saveCats(cur.map(x=>x===old? nn : x));

                // update DB tracks
                let all = [];
                try{ all = await dbGetAll("tracks"); }catch(err){ all = (MUSIC.tracks||[]).slice(); }
                for (const t of all){
                  if ((t.cat||"未分类") === old){
                    t.cat = nn;
                    try{ await dbPut("tracks", t); }catch(e){}
                  }
                }

                // update memory
                (MUSIC.tracks||[]).forEach(t=>{ if ((t.cat||"未分类")===old) t.cat = nn; });
                if (activeCat===old) activeCat = nn;

                try{ toast("分类已重命名"); }catch(err){}
                renderCats(); renderLibrary();
              };

              inp.addEventListener("blur", commit, {once:true});
              inp.addEventListener("keydown", (ev)=>{
                if (ev.key==="Enter"){ ev.preventDefault(); inp.blur(); }
                if (ev.key==="Escape"){ ev.preventDefault(); renderCats(); }
              });
            });
          }

          wrap.appendChild(b);
        };

        cats.forEach(makeChip);

        // Add button: NO prompt, auto generate unique name
        const add = document.createElement("button");
        add.type="button";
        add.className="chipBtn";
        add.innerHTML = `<span class="x">＋ 分类</span>`;
        add.addEventListener("click", ()=>{
          const base = "新分类";
          const cur = (loadCats()||[]).filter(Boolean);
          const exist = new Set([...cur, ...fromTracks, "全部", "未分类"]);
          let name = base;
          let i = 1;
          while (exist.has(name)){
            i++;
            name = base + i;
          }
          cur.push(name);
          saveCats(cur);
          activeCat = name;
          try{ toast("已新增分类 ✅（双击可重命名）"); }catch(err){}
          renderCats(); renderLibrary();
        });
        wrap.appendChild(add);
      };
    }

    // -------- 5) library list vertical resize: make it actually work (flex was preventing height)
    // CSS already forces #libList flex:0; here we just ensure persisted height applies on init.
    if (typeof initMusicLayout === "function"){
      const _init2 = initMusicLayout;
      initMusicLayout = function(){
        _init2();
        const libListEl = $("#libList");
        if (libListEl && MUSIC.layout && typeof MUSIC.layout.libListH === "number"){
          libListEl.style.height = clampNum(MUSIC.layout.libListH, 220, 980) + "px";
        }
      };
    }

    // -------- 6) playlists: pointer drag reorder (smooth) + persist order
    function sortPlaylistsUI(list){
      return (list||[]).slice().sort((a,b)=>{
        const oa = (a.order===undefined||a.order===null) ? 1e9 : a.order;
        const ob = (b.order===undefined||b.order===null) ? 1e9 : b.order;
        if (oa!==ob) return oa-ob;
        return (b.updatedAt||0) - (a.updatedAt||0);
      });
    }

    async function ensurePlaylistPlayDefaults(){
      const list = MUSIC.playlists || [];
      if (!list.length) return;
      let changed = false;
      for (const pl of list){
        let loopOne = (pl.loopOne === undefined) ? true : !!pl.loopOne;
        let loopAll = !!pl.loopAll;
        let mode = (pl.mode === "pause") ? "pause" : "next";
        if (loopAll){ loopOne = false; mode = "next"; }
        if (mode === "pause"){ loopOne = false; loopAll = false; }
        if (pl.loopOne !== loopOne || pl.loopAll !== loopAll || pl.mode !== mode){
          pl.loopOne = loopOne; pl.loopAll = loopAll; pl.mode = mode;
          pl.updatedAt = pl.updatedAt || Date.now();
          changed = true;
          try{ await dbPut("playlists", pl); }catch(e){}
        }
      }
      return changed;
    }

    async function ensurePlaylistOrder(){
      const list = MUSIC.playlists || [];
      if (!list.length) return;
      const missing = list.some(pl => pl.order === undefined || pl.order === null);
      if (!missing) return;

      const ordered = sortPlaylistsUI(list);
      for (let i=0;i<ordered.length;i++){
        ordered[i].order = i;
        try{ await dbPut("playlists", ordered[i]); }catch(e){}
      }
    }

    async function persistPlaylistOrderFromDOM(wrap){
      const ids = Array.from(wrap.querySelectorAll("[data-pl-id]"))
        .map(el=>el.getAttribute("data-pl-id"))
        .filter(Boolean);

      const map = new Map((MUSIC.playlists||[]).map(pl=>[pl.id, pl]));
      let i = 0;
      for (const id of ids){
        const pl = map.get(id);
        if (!pl) continue;
        pl.order = i++;
        try{ await dbPut("playlists", pl); }catch(e){}
      }
    }

    // override renderPlaylists only for ordering + drag binding (other behaviors keep as close as possible)
    if (typeof renderPlaylists === "function"){
      renderPlaylists = function(){
        const wrap = $("#plList");
        if (!wrap) return;

        ensurePlaylistOrder().catch(()=>{});
        ensurePlaylistPlayDefaults && ensurePlaylistPlayDefaults().catch(()=>{});

        const list = sortPlaylistsUI(MUSIC.playlists);
        if (!list.length){
          wrap.innerHTML = `<div class="muted">暂无播放列表，点“新建”。</div>`;
          return;
        }

        wrap.innerHTML = list.map(pl=>{
          const active = (pl.id===MUSIC.activePlId) ? "active" : "";
          const count = pl.items?.length || 0;

          // per-playlist play mode defaults + normalize
          let loopOne = (pl.loopOne === undefined) ? true : !!pl.loopOne;
          let loopAll = !!pl.loopAll;
          let mode = (pl.mode === "pause") ? "pause" : "next";
          if (loopAll){ loopOne = false; mode = "next"; }
          if (mode === "pause"){ loopOne = false; loopAll = false; }
          pl.loopOne = loopOne; pl.loopAll = loopAll; pl.mode = mode;

          const b1 = loopOne ? "on" : "";
          const b2 = loopAll ? "on" : "";
          const b3 = (mode==="pause") ? "on" : "";
          return `
            <div class="kgItem kgPlItem ${active}" data-pl-id="${pl.id}">
              <div class="kgLeft">
                <div class="kgName" contenteditable="true" spellcheck="false" data-pl-name="1">${h(pl.name||"未命名")}</div>
                <div class="kgSub">${count} 首</div>
              </div>
              <div class="kgRight">
                <button class="sbtn plModeBtn ${b1}" data-pl-set="loopOne" title="单曲循环（此播放列表）">🔁</button>
                <button class="sbtn plModeBtn ${b2}" data-pl-set="loopAll" title="列表循环（此播放列表）">🔂</button>
                <button class="sbtn plModeBtn ${b3}" data-pl-set="mode" title="播完暂停 / 播完下一曲（此播放列表）">${mode==="pause" ? "⏸" : "⏭"}</button>
                <button class="sbtn danger" data-pl-del="1">删</button>
              </div>
            </div>
          `;
        }).join("");

        // click to load (avoid when editing / clicking buttons; also avoid accidental after drag)
        wrap.querySelectorAll("[data-pl-id]").forEach(card=>{
          card.addEventListener("click", (e)=>{
            const lastDrag = Number(wrap.dataset.lastDragTs||0);
            if (Date.now() - lastDrag < 350) return;
            if (e.target && (e.target.closest?.("button") || e.target.closest?.("[data-pl-name]") || e.target.isContentEditable)) return;
            const id = card.getAttribute("data-pl-id");
            if (id) loadPlaylistToQueue(id, true);
          });
        });

        // delete
        wrap.querySelectorAll("[data-pl-del]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const card = btn.closest("[data-pl-id]");
            const id = card?.getAttribute("data-pl-id");
            if (!id) return;
            MUSIC.playlists = MUSIC.playlists.filter(x=>x.id!==id);
            if (MUSIC.activePlId===id) MUSIC.activePlId=null;
            try{ await dbDel("playlists", id); }catch(e){}
            renderPlaylists();
            try{ toast("已删除"); }catch(err){}
          });
        });

        // rename
        wrap.querySelectorAll("[data-pl-name]").forEach(el=>{
          el.addEventListener("keydown", (e)=>{
            if (e.key==="Enter"){ e.preventDefault(); el.blur(); }
          });
          el.addEventListener("blur", async ()=>{
            const card = el.closest("[data-pl-id]");
            const id = card?.getAttribute("data-pl-id");
            const pl = playlistById(id);
            if (!pl) return;
            pl.name = (el.textContent||"").trim() || "未命名";
            pl.updatedAt = Date.now();
            try{ await dbPut("playlists", pl); }catch(e){}
            renderPlaylists();
          });
        });


        // per-playlist play mode buttons (🔁/🔂/⏭⏸)
        wrap.querySelectorAll("[data-pl-set]").forEach(btn=>{
          btn.addEventListener("click", async (e)=>{
            e.preventDefault(); e.stopPropagation();
            const card = btn.closest("[data-pl-id]");
            const id = card?.getAttribute("data-pl-id");
            const pl = playlistById(id);
            if (!pl) return;

            const k = btn.getAttribute("data-pl-set");
            // normalize existing
            pl.loopOne = (pl.loopOne === undefined) ? true : !!pl.loopOne;
            pl.loopAll = !!pl.loopAll;
            pl.mode = (pl.mode === "pause") ? "pause" : "next";
            if (pl.loopAll){ pl.loopOne = false; pl.mode = "next"; }
            if (pl.mode === "pause"){ pl.loopOne = false; pl.loopAll = false; }

            if (k === "loopOne"){
              pl.loopOne = !pl.loopOne;
              if (pl.loopOne){ pl.loopAll = false; pl.mode = "next"; }
            } else if (k === "loopAll"){
              pl.loopAll = !pl.loopAll;
              if (pl.loopAll){ pl.loopOne = false; pl.mode = "next"; }
            } else if (k === "mode"){
              pl.mode = (pl.mode === "pause") ? "next" : "pause";
              if (pl.mode === "pause"){ pl.loopOne = false; pl.loopAll = false; }
            }

            pl.updatedAt = Date.now();
            try{ await dbPut("playlists", pl); }catch(err){}

            if (MUSIC.activePlId === pl.id){
              try{ window.applyPlaylistPlayback && window.applyPlaylistPlayback(pl); }catch(e){}
            }
            renderPlaylists();
            try{ toast("已更新播放模式"); }catch(_e){}
          });
        });



        // drop track into playlist (keep original behavior)
        wrap.querySelectorAll("[data-pl-id]").forEach(card=>{
          card.addEventListener("dragover", (e)=>{ e.preventDefault(); card.classList.add("dragover"); });
          card.addEventListener("dragleave", ()=> card.classList.remove("dragover"));
          card.addEventListener("drop", async (e)=>{
            e.preventDefault(); card.classList.remove("dragover");
            const id = card.getAttribute("data-pl-id");
            const pl = playlistById(id);
            if (!pl) return;
            const data = e.dataTransfer?.getData("text/plain") || "";
            let obj = null;
            try{ obj = JSON.parse(data); }catch(err){}
            if (obj?.type==="track"){
              pl.items = pl.items || [];
              pl.items.push({ id:idNow("pi"), trackId: obj.id, title:"", start:0, end:null });
              pl.updatedAt = Date.now();
              try{ await dbPut("playlists", pl); }catch(err){}
              try{ toast("已加入播放列表"); }catch(err){}
              renderPlaylists();
              if (MUSIC.activePlId===pl.id) loadPlaylistToQueue(pl.id, false);
            }
          });
        });

        // drag reorder (pointer, smooth)
        bindPlaylistsPointerSort(wrap);
      };
    }

    function bindPlaylistsPointerSort(wrap){
      if (!wrap || wrap.dataset.sort243 === "1") return;
      wrap.dataset.sort243 = "1";

      let dragging = null;
      let placeholder = null;
      let pointerId = null;
      let startX = 0, startY = 0;
      let startRect = null;
      let offsetY = 0;
      let moved = false;

      const startDrag = ()=>{
        if (!dragging || moved) return;
        moved = true;

        // placeholder where it came from
        placeholder = document.createElement("div");
        placeholder.className = "kgItem placeholder";
        placeholder.style.height = startRect.height + "px";

        // swap
        dragging.replaceWith(placeholder);

        // float dragging in body
        dragging.classList.add("pdrag");
        dragging.style.position = "fixed";
        dragging.style.left = startRect.left + "px";
        dragging.style.top  = startRect.top + "px";
        dragging.style.width = startRect.width + "px";
        dragging.style.zIndex = "9999";
        dragging.style.pointerEvents = "none";
        document.body.appendChild(dragging);
      };

      const moveDrag = (clientY)=>{
        if (!dragging || !moved) return;
        const top = clientY - offsetY;
        dragging.style.top = top + "px";

        const cards = Array.from(wrap.querySelectorAll("[data-pl-id]"));
        let inserted = false;
        for (const c of cards){
          const r = c.getBoundingClientRect();
          const mid = r.top + r.height/2;
          if (clientY < mid){
            wrap.insertBefore(placeholder, c);
            inserted = true;
            break;
          }
        }
        if (!inserted){
          wrap.appendChild(placeholder);
        }
      };

      const endDrag = async ()=>{
        if (!dragging) return;

        // put back to list
        if (moved){
          dragging.classList.remove("pdrag");
          dragging.style.position = "";
          dragging.style.left = "";
          dragging.style.top = "";
          dragging.style.width = "";
          dragging.style.zIndex = "";
          dragging.style.pointerEvents = "";
          placeholder.replaceWith(dragging);
          placeholder = null;

          wrap.dataset.lastDragTs = String(Date.now());
          try{ await persistPlaylistOrderFromDOM(wrap); }catch(e){}
          // re-render to reflect active styles/order cleanly
          renderPlaylists();
        }

        dragging = null;
        moved = false;
        pointerId = null;
      };

      wrap.addEventListener("pointerdown", (e)=>{
        const card = e.target.closest?.("[data-pl-id]");
        if (!card || !wrap.contains(card)) return;

        // ignore if interacting with editable name / button
        if (e.target.closest?.("button") || e.target.closest?.("[data-pl-name]") || e.target.isContentEditable) return;
        if (e.button!==0 && e.pointerType!=="touch") return;

        dragging = card;
        pointerId = e.pointerId;
        startX = e.clientX;
        startY = e.clientY;
        startRect = dragging.getBoundingClientRect();
        offsetY = startY - startRect.top;
        moved = false;

        try{ dragging.setPointerCapture?.(pointerId); }catch(err){}

        const onMove = (ev)=>{
          if (ev.pointerId !== pointerId) return;
          const dy = ev.clientY - startY;
          const dx = ev.clientX - startX;

          if (!moved){
            if (Math.abs(dy) < 6 && Math.abs(dx) < 6) return;
            ev.preventDefault();
            startDrag();
          }else{
            ev.preventDefault();
            moveDrag(ev.clientY);
          }
        };

        const onUp = (ev)=>{
          if (ev.pointerId !== pointerId) return;
          document.removeEventListener("pointermove", onMove, true);
          document.removeEventListener("pointerup", onUp, true);
          document.removeEventListener("pointercancel", onUp, true);
          endDrag();
        };

        document.addEventListener("pointermove", onMove, true);
        document.addEventListener("pointerup", onUp, true);
        document.addEventListener("pointercancel", onUp, true);
      }, {passive:true});
    }

  }catch(e){
    console.error("v2.4.3 patch failed", e);
  }
})();


// Init app
  applyChecks();
  bindChecks();
  updateProgress();
  bindNavActive();
  bindSearch();
  initScripts();
  initSchedule();
  setTab("schedule");
})();



  // ---- Lines Tips Toggle (inline) ----
  (function(){
    const btn = document.getElementById('btnToggleLinesTips');
    const body = document.getElementById('linesTipsBody');
    if(!btn || !body) return;
    const key = 'linesTipsOpen_v25';
    const open = localStorage.getItem(key)==='1';
    body.hidden = !open;
    btn.textContent = open ? '收起' : '展开';
    btn.addEventListener('click', ()=>{
      const nowOpen = body.hidden;
      body.hidden = !nowOpen;
      btn.textContent = nowOpen ? '收起' : '展开';
      localStorage.setItem(key, nowOpen ? '1' : '0');
    });
  
  // =========================
  // v2.6.1 PATCH: 分类点击筛选修复 + 音乐库折叠扩展 + 队列单曲独立行为
  // =========================
  try{
    // --- ① 分类点击：使用 dataset + 事件代理，避免 HTML 实体导致匹配失败 ---
    if (typeof window.__mc_cats_v261_bound === "undefined") window.__mc_cats_v261_bound = false;

    renderCats = function(){
      const wrap = $("#libCats");
      if (!wrap) return;
      ensureTrackCats();
      const custom = (typeof loadCats === "function") ? (loadCats()||[]) : [];
      const fromTracks = (typeof allCatsFromTracks === "function") ? (allCatsFromTracks()||[]) : [];
      const set = new Set();
      set.add("未分类");
      custom.forEach(c=>{ c=String(c||"").trim(); if (c) set.add(c); });
      fromTracks.forEach(c=>{ c=String(c||"").trim(); if (c && c!=="全部") set.add(c); });

      const cats = ["全部", ...Array.from(set)];
      wrap.innerHTML = "";
      cats.forEach(cat=>{
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "chipBtn" + (cat===activeCat ? " active":"");
        btn.dataset.cat = cat;

        const txt = document.createElement("span");
        txt.className = "chipTxt";
        txt.textContent = cat;
        btn.appendChild(txt);

        const isBuilt = (cat==="全部" || cat==="未分类");
        const isCustom = custom.includes(cat);
        if (!isBuilt && isCustom){
          const del = document.createElement("span");
          del.className = "x";
          del.title = "删除分类";
          del.textContent = "×";
          del.dataset.delCat = "1";
          btn.appendChild(del);
        }
        wrap.appendChild(btn);
      });

      const addBtn = document.createElement("button");
      addBtn.type="button";
      addBtn.className="chipBtn";
      addBtn.dataset.addCat="1";
      addBtn.innerHTML = `<span class="x">＋ 分类</span>`;
      wrap.appendChild(addBtn);
    };

    async function deleteCatNoPrompt(name){
      name = String(name||"").trim();
      if (!name || name==="全部" || name==="未分类") return;
      // remove from custom list
      try{
        const cur = (typeof loadCats==="function") ? (loadCats()||[]) : [];
        const next = cur.filter(c=>c!==name);
        if (typeof saveCats==="function") saveCats(next);
      }catch(_){}
      // move tracks to 未分类
      try{
        ensureTrackCats();
        const changed = [];
        (MUSIC.tracks||[]).forEach(t=>{
          if ((t.cat||"未分类")===name){
            t.cat="未分类";
            changed.push(t);
          }
        });
        for (const t of changed){
          try{ await dbPut("tracks", t); }catch(_){}
        }
      }catch(_){}
      if (typeof activeCat!=="undefined" && activeCat===name) activeCat="全部";
      try{ toast(`已删除分类：${name}`); }catch(_){}
      renderCats(); renderLibrary();
    }

    if (!window.__mc_cats_v261_bound){
      window.__mc_cats_v261_bound = true;
      document.addEventListener("click", async (e)=>{
        const wrap = $("#libCats");
        if (!wrap) return;
        const btn = e.target.closest && e.target.closest("#libCats .chipBtn");
        if (!btn) return;

        // delete
        if (e.target && e.target.closest && e.target.closest("[data-del-cat]")){
          e.preventDefault(); e.stopPropagation();
          await deleteCatNoPrompt(btn.dataset.cat);
          return;
        }
        // add
        if (btn.dataset.addCat==="1"){
          e.preventDefault(); e.stopPropagation();
          const base = "新分类";
          const cur = (typeof loadCats==="function") ? (loadCats()||[]) : [];
          let i=1, name=base;
          const exist = new Set([...(cur||[]), ...(typeof allCatsFromTracks==="function"? (allCatsFromTracks()||[]):[])]);
          while (exist.has(name)){
            i+=1; name = base + i;
          }
          cur.push(name);
          if (typeof saveCats==="function") saveCats(cur);
          activeCat = name;
          try{ toast("已新增分类 ✅"); }catch(_){}
          renderCats(); renderLibrary();
          return;
        }

        // select
        activeCat = btn.dataset.cat || "全部";
        renderCats();
        renderLibrary();
      }, true);
    }

    // Override renderLibrary: 保持 +队列/删/拖拽逻辑，只确保按 activeCat 正确过滤
    if (typeof renderLibrary === "function"){
      const _renderLibrary_v261_prev = renderLibrary;
      renderLibrary = function(){
        const wrap = $("#libList");
        if (!wrap) return _renderLibrary_v261_prev();

        ensureTrackCats();
        const q = String($("#libSearch")?.value || "").trim().toLowerCase();
        const cat = activeCat || "全部";

        const list = (MUSIC.tracks || []).slice()
          .sort((a,b)=>(b.createdAt||0)-(a.createdAt||0))
          .filter(t=>{
            if (q && !String(t.name||"").toLowerCase().includes(q)) return false;
            if (cat!=="全部" && (t.cat||"未分类")!==cat) return false;
            return true;
          });

        if (!list.length){
          wrap.innerHTML = `<div class="muted">暂无音乐（或该分类下没有音乐）。</div>`;
          return;
        }

        const optCats = ["未分类", ...Array.from(new Set([
          ...(typeof loadCats==="function" ? (loadCats()||[]) : []),
          ...(typeof allCatsFromTracks==="function" ? (allCatsFromTracks()||[]) : [])
        ])).filter(c=>c && c!=="全部")];

        wrap.innerHTML = list.map(tr=>{
          const curCat = tr.cat || "未分类";
          const options = optCats.map(c=>`<option value="${h(c)}"${c===curCat?" selected":""}>${h(c)}</option>`).join("");
          return `
            <div class="kgItem" data-track-id="${tr.id}">
              <div class="kgGrip" draggable="true" data-drag-track="${tr.id}" title="拖拽：加入队列/播放列表">⋮⋮</div>
              <div class="kgLeft">
                <div class="kgName" contenteditable="true" data-tr-name="1">${h(tr.name||"未命名")}</div>
                <div class="kgSub">${fmtTime(tr.duration||0)} · 分类：
                  <select class="miniSel" data-cat-sel="1">${options}</select>
                  · 拖到队列/播放列表 · 或点右侧“+队列”
                </div>
              </div>
              <div class="kgRight">
                <button class="sbtn" data-addq="1">+队列</button>
                <button class="sbtn danger" data-del="1">删</button>
              </div>
            </div>
          `;
        }).join("");

        // drag payload for track
        wrap.querySelectorAll("[data-drag-track]").forEach(grip=>{
          grip.addEventListener("dragstart", (e)=>{
            const id = grip.getAttribute("data-drag-track");
            e.dataTransfer.effectAllowed = "copy";
            const payload = JSON.stringify({type:"track", id});
            try{ e.dataTransfer.setData("application/json", payload);}catch(_){}
            try{ e.dataTransfer.setData("text/plain", payload);}catch(_){}
          });
        });

        // category select change
        wrap.querySelectorAll("[data-track-id] select[data-cat-sel]").forEach(sel=>{
          sel.addEventListener("change", async ()=>{
            const card = sel.closest("[data-track-id]");
            const id = card?.getAttribute("data-track-id");
            const tr = (MUSIC.tracks||[]).find(x=>String(x.id)===String(id));
            if (!tr) return;
            tr.cat = sel.value || "未分类";
            try{ await dbPut("tracks", tr); }catch(_){}
            renderCats();
            renderLibrary();
          });
        });
      };
    }

    // render cats once after patch
    setTimeout(()=>{ try{ renderCats(); }catch(_){} }, 20);

    // --- ② 队列：每首歌独立“单曲循环/播完下一曲/播完暂停” ---
    function getQOverrides(q){
      const loopOv = (q && Object.prototype.hasOwnProperty.call(q, "loopOne")) ? q.loopOne : null; // null|true|false
      const modeOv = (q && Object.prototype.hasOwnProperty.call(q, "endMode")) ? q.endMode : null; // null|'next'|'pause'
      return { loopOv, modeOv };
    }
    function getEffectiveLoop(q){
      const {loopOv} = getQOverrides(q);
      if (loopOv===true) return true;
      if (loopOv===false) return false;
      return !!MUSIC.loopOne;
    }
    function getEffectiveMode(q){
      const {modeOv} = getQOverrides(q);
      if (modeOv==="pause") return "pause";
      if (modeOv==="next") return "next";
      return MUSIC.mode || "next";
    }
    // per-track handleSegmentEnd override disabled (use global mode only)

        // per-track mode buttons removed (queue uses global playback mode only)
// ensure queue refresh
    setTimeout(()=>{ try{ renderQueue(); }catch(_){} }, 80);

  }catch(e){
    console.error("v2.6.1 patch failed", e);
  }




  // per-track playback mode patch removed (use global mode + playlist settings only)


})();</script>

<div class="prompt" id="savePrompt" aria-hidden="true">
  <div class="promptPanel">
    <div class="promptTitle">有未保存的修改</div>
    <div class="promptSub">要先保存再关闭吗？（建议保存，避免丢失时间轴与台词修改）</div>
    <div class="promptBtns">
      <button class="sbtn danger" id="promptDiscard">不保存关闭</button>
      <button class="sbtn" id="promptCancel">继续编辑</button>
      <button class="sbtn primary" id="promptSave">保存并关闭</button>
    </div>
  </div>
</div>


<div class="picker" id="linePicker" aria-hidden="true">
  <div class="pickerPanel">
    <div class="pickerHead">
      <div>
        <div class="pickerTitle">选择台词插入到当前环节</div>
        <div class="pickerSub muted-small">支持搜索标题/关键词/正文；点击一条即可插入（会自动转为“客户专属”并标记未保存）。</div>
      </div>
      <button class="sbtn" id="btnClosePicker">关闭</button>
    </div>
    <div class="pickerBody">
      <div class="pickerLeft">
        <input class="input" id="pickerSearch" placeholder="搜索：开场 / 父母 / 敬酒 / 退场 …"/>
        <div class="muted-small" style="margin-top:10px">分类</div>
        <div class="pickerCats" id="pickerCats"></div>
      </div>
      <div class="pickerRight">
        <div class="pickerList" id="pickerList"></div>
      </div>
    </div>
    <div class="pickerFoot muted-small">提示：插入后你仍可在该环节里继续编辑/删改句子；最后记得点“保存档期”。</div>
  </div>
</div>


<script>
/* v2.6.32: main-page controls for P1 height/fullscreen + small QoL fixes (no other behavior changes) */
(function(){
  // Expand library column when collapsed (click on the column background)
  try{
    const grid = document.getElementById("kgGrid");
    const col = document.getElementById("kgColLib");
    if (grid && col && col.dataset.expandClick !== "1"){
      col.dataset.expandClick = "1";
      col.addEventListener("click", (e)=>{
        if (!grid.classList.contains("kgLibCollapsed")) return;
        if (e.target && (e.target.closest?.("button") || e.target.closest?.("input") || e.target.closest?.("textarea") || e.target.closest?.(".kgItem"))) return;
        try{
          const btn = document.getElementById("btnToggleLib");
          btn && btn.click();
        }catch(err){}
      });
    }
  }catch(err){}

  // ===== P1 UI size bar (this lives in parent page, not inside iframe) =====
  const HEIGHT_KEY = "mc_p1_height";
  const FULL_KEY   = "mc_p1_fullscreen";

  const root  = document.documentElement;
  const frame = document.getElementById("p1ConsoleFrame");
  const wrap  = document.getElementById("msP1Wrap");
  const range = document.getElementById("p1HeightRange");
  const label = document.getElementById("p1HeightLabel");
  const btnFull  = document.getElementById("btnP1Full");
  const btnReset = document.getElementById("btnP1ResetH");

  const clamp = (n, a, b)=> Math.max(a, Math.min(b, n));
  const setLabel = (t)=>{ if (label) label.textContent = t; };

  const refreshRangeMax = ()=>{
    if (!range) return;
    const maxH = Math.max(520, Math.floor(window.innerHeight * 0.96));
    range.max = String(maxH);
  };

  const applyHeight = (px, {save=true, silent=false}={})=>{
    if (!frame) return;
    const maxH = range ? Number(range.max || 1600) : 1600;
    const n = clamp(Number(px), 360, maxH);
    frame.style.height = Math.round(n) + "px";
    root.style.setProperty("--p1ConsoleH", Math.round(n) + "px");
    if (range) range.value = String(Math.round(n));
    setLabel(Math.round(n) + "px");
    if (save){
      try{ localStorage.setItem(HEIGHT_KEY, String(Math.round(n))); }catch(e){}
    }
  };

  const resetHeight = ({save=true}={})=>{
    if (!frame) return;
    frame.style.height = "";
    root.style.removeProperty("--p1ConsoleH");
    // keep slider visually reasonable even when auto
    const fallback = Math.min(1120, Math.floor(window.innerHeight * 0.92));
    if (range) range.value = String(fallback);
    setLabel("auto");
    if (save){
      try{ localStorage.removeItem(HEIGHT_KEY); }catch(e){}
    }
  };

  const setFullscreen = (on, {save=true}={})=>{
    document.body.dataset.p1Fullscreen = on ? "1" : "0";
    if (btnFull) btnFull.textContent = on ? "退出满屏" : "满屏";
    if (save){
      try{ localStorage.setItem(FULL_KEY, on ? "1" : "0"); }catch(e){}
    }
    // Optional: use browser fullscreen for maximum screen use (falls back to CSS fullscreen if blocked)
    try{
      if (on){
        if (wrap && wrap.requestFullscreen) wrap.requestFullscreen().catch(()=>{});
      } else {
        if (document.fullscreenElement && document.exitFullscreen) document.exitFullscreen().catch(()=>{});
      }
    }catch(e){}
    // in fullscreen, label can show 100%
    if (on) setLabel("100%");
    else {
      if (frame && frame.style.height) setLabel(frame.style.height);
      else setLabel("auto");
    }
  };

  // Init
  refreshRangeMax();

  // Restore saved height (if any)
  try{
    const saved = localStorage.getItem(HEIGHT_KEY);
    if (saved){
      applyHeight(saved, {save:false, silent:true});
    } else {
      resetHeight({save:false});
    }
  }catch(e){
    resetHeight({save:false});
  }

  // Restore fullscreen state (CSS fullscreen) if any
  try{
    const fs = localStorage.getItem(FULL_KEY);
    if (fs === "1") setFullscreen(true, {save:false});
    else setFullscreen(false, {save:false});
  }catch(e){
    setFullscreen(false, {save:false});
  }

  // Bind events
  if (range){
    range.addEventListener("input", ()=> applyHeight(range.value, {save:false, silent:true}));
    range.addEventListener("change", ()=> applyHeight(range.value, {save:true, silent:false}));
  }
  btnReset && btnReset.addEventListener("click", ()=> resetHeight({save:true}));
  btnFull && btnFull.addEventListener("click", ()=> setFullscreen(!(document.body.dataset.p1Fullscreen === "1"), {save:true}));

  // ===== P1 Fullscreen mini bar buttons (shown only in CSS fullscreen) =====
  const btnExitToBuiltinMini = document.getElementById("btnP1ExitToBuiltin");
  const btnMiniExitFull = document.getElementById("btnP1MiniExitFull");

  // Bind once
  const bindOnce = (el, key, fn)=>{
    if (!el) return;
    const k = "p1Bind_" + key;
    if (el.dataset && el.dataset[k] === "1") return;
    try{ if (el.dataset) el.dataset[k] = "1"; }catch(e){}
    el.addEventListener("click", fn);
  };

  bindOnce(btnMiniExitFull, "miniExitFull", ()=>{
    // Exit both CSS fullscreen and browser fullscreen (if any)
    setFullscreen(false, {save:true});
  });

  bindOnce(btnExitToBuiltinMini, "miniExitBuiltin", ()=>{
    // First exit fullscreen, then switch back to built-in player mode
    setFullscreen(false, {save:true});
    try{
      const btn = document.getElementById("btnMusicBuiltin");
      if (btn) btn.click();
      else if (typeof window.setMusicPlayerMode === "function") window.setMusicPlayerMode("builtin");
    }catch(e){}
  });

  // Sync: if user exits browser fullscreen via ESC, also exit CSS fullscreen state
  document.addEventListener("fullscreenchange", ()=>{
    try{
      if (document.body?.dataset?.p1Fullscreen === "1" && !document.fullscreenElement){
        setFullscreen(false, {save:true});
      }
    }catch(e){}
  });

  // Flag to prevent duplicate P1 UI bindings elsewhere
  try{ document.body.dataset.p1UiBound = "1"; }catch(e){}


  window.addEventListener("resize", ()=>{
    refreshRangeMax();
    // If user had a saved height, keep it applied
    try{
      const saved = localStorage.getItem(HEIGHT_KEY);
      if (saved && document.body.dataset.p1Fullscreen !== "1"){
        applyHeight(saved, {save:false, silent:true});
      }
    }catch(e){}
  });

  // ESC exits fullscreen (CSS/fullscreen API)
  window.addEventListener("keydown", (e)=>{
    if (e.key === "Escape" && document.body.dataset.p1Fullscreen === "1"){
      setFullscreen(false, {save:true});
    }
  });

})();
</script>



  <!-- ===== Embedded P1 Console (srcdoc for iframe) ===== -->
  <template id="tplP1ConsoleSrcdoc">
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>P1风格｜音频播控台 v2.8（离线单页）</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1621;
      --panel2:#0c131d;
      --card:#101a28;
      --card2:#0e1723;
      --text:#e9eef7;
      --muted:#9aa7bd;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.06);
      --accent:#6ee7ff;
      --good:#2ee59d;
      --warn:#ffcc66;
      --bad:#ff5d6c;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius:14px;
      --radius2:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --top:62px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(110,231,255,.10), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(46,229,157,.08), transparent 60%),
        radial-gradient(900px 700px at 60% 120%, rgba(255,93,108,.06), transparent 60%),
        var(--bg);
      overflow:hidden;
    }
    a{color:inherit}
    button, input, select{font:inherit}
    .topbar{
      height:var(--top);
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
      backdrop-filter: blur(8px);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px;
      border:1px solid var(--line2);
      border-radius:999px;
      background: rgba(255,255,255,.03);
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--accent); box-shadow:0 0 0 4px rgba(110,231,255,.15), 0 0 18px rgba(110,231,255,.35);}
    .brand strong{letter-spacing:.5px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--line2);
      border-radius:999px;
      background: rgba(255,255,255,.02);
      color:var(--muted);
      white-space:nowrap;
    }
    .spacer{flex:1}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{border-color: rgba(110,231,255,.35); background: rgba(110,231,255,.06)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{border-color: rgba(110,231,255,.45); background: rgba(110,231,255,.10)}
    .btn.danger:hover{border-color: rgba(255,93,108,.5); background: rgba(255,93,108,.10)}
    .btn.small{padding:7px 9px; border-radius:10px; font-size:12px; color:var(--muted)}
    .btn.icon{width:40px; padding:10px 0}
    .btn.tiny{padding:6px 8px; border-radius:10px; font-size:12px}
    .kbd{
      font-family:var(--mono);
      padding:2px 6px;
      border:1px solid var(--line2);
      border-radius:8px;
      background: rgba(0,0,0,.25);
      color:var(--muted);
      font-size:12px;
    }
    .meter{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      min-width:250px;
    }
    .meter label{color:var(--muted); font-size:12px}
    input[type="range"]{width:120px}
    .time{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      min-width:170px;
      text-align:center;
    }

    /* Layout with resizers */
    .app{
      height: calc(100% - var(--top));
      display:flex;
      overflow:hidden;
    }
    .col{
      height:100%;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:220px;
    }
    .col.left{width:300px}
    .col.mid{width:520px}
    .col.right{flex:1; min-width:320px}
    .split{
      width:14px; /* wider hitbox */
      cursor:col-resize;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.06), transparent);
      position:relative;
    }
    .split:before{
      content:"";
      position:absolute;
      top:0; bottom:0; left:5px; right:5px;
      border-left:1px solid rgba(255,255,255,.08);
      border-right:1px solid rgba(0,0,0,.35);
      opacity:.6;
    }
    .splitV{
      height:14px;
      cursor:row-resize;
      background: linear-gradient(180deg, transparent, rgba(255,255,255,.06), transparent);
      position:relative;
      flex:0 0 auto;
    }
    .splitV:before{
      content:"";
      position:absolute;
      left:0; right:0; top:5px; bottom:5px;
      border-top:1px solid rgba(255,255,255,.08);
      border-bottom:1px solid rgba(0,0,0,.35);
      opacity:.6;
    }

    /* ===== Collapsible panes (v2.7) ===== */
    .col.left, .col.mid{ transition: width .18s ease, opacity .18s ease; }
    .app.collapsed-left #colLeft{
      width:0 !important;
      min-width:0 !important;
      opacity:0;
      pointer-events:none;
    }
    .app.collapsed-left #split1{ display:none; }

    .app.collapsed-mid #colMid{
      width:0 !important;
      min-width:0 !important;
      opacity:0;
      pointer-events:none;
    }
    .app.collapsed-mid #split2{ display:none; }


    .panel{
      height:100%;
      background: rgba(255,255,255,.02);
      border-right: 1px solid var(--line2);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .panel.right{border-right:none}
    .panelHeader{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .panelHeader h3{
      margin:0;
      font-size:13px;
      letter-spacing:.6px;
      text-transform:uppercase;
      color:#cfe0ff;
    }
    .panelHeader .sub{font-size:12px;color:var(--muted)}
    .panelBody{padding:12px; overflow:auto}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .muted{color:var(--muted)}
    .hr{height:1px; background: var(--line2); margin:12px 0}

    .search{
      display:flex; gap:8px; align-items:center;
      padding:10px;
      border:1px solid var(--line2);
      border-radius:12px;
      background: rgba(0,0,0,.22);
    }
    .search input{
      flex:1; border:none; outline:none;
      background:transparent;
      color:var(--text);
    }
    .tag{
      font-size:12px; color:var(--muted);
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      white-space:nowrap;
    }
    .tag.clip{
      max-width: 180px;
      overflow:hidden;
      text-overflow:ellipsis;
      vertical-align:bottom;
    }

    /* Thin native scrollbars (no overlay sliders) */
    .panelBody, .grid, .rightTop, .cardBody, .modal{
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.28) transparent;
    }
    .panelBody::-webkit-scrollbar,
    .grid::-webkit-scrollbar,
    .rightTop::-webkit-scrollbar,
    .cardBody::-webkit-scrollbar,
    .modal::-webkit-scrollbar{
      width:5px;
      height:5px;
    }
    .panelBody::-webkit-scrollbar-thumb,
    .grid::-webkit-scrollbar-thumb,
    .rightTop::-webkit-scrollbar-thumb,
    .cardBody::-webkit-scrollbar-thumb,
    .modal::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.22);
      border-radius: 999px;
      border: 2px solid transparent;
      background-clip: content-box;
    }
    .panelBody::-webkit-scrollbar-thumb:hover,
    .grid::-webkit-scrollbar-thumb:hover,
    .rightTop::-webkit-scrollbar-thumb:hover,
    .cardBody::-webkit-scrollbar-thumb:hover,
    .modal::-webkit-scrollbar-thumb:hover{
      background: rgba(255,255,255,.35);
      border: 2px solid transparent;
      background-clip: content-box;
    }
    .panelBody::-webkit-scrollbar-track,
    .grid::-webkit-scrollbar-track,
    .rightTop::-webkit-scrollbar-track,
    .cardBody::-webkit-scrollbar-track,
    .modal::-webkit-scrollbar-track{
      background: transparent;
    }


    /* lists */
    .list{margin-top:12px; display:flex; flex-direction:column; gap:8px;}
    /* 队列：改为方块卡片（与中间“音频块”一致的 cue 风格） */
    #queueList{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap:10px;
      align-content:start;
    }
    #queueList .queueCue{
      aspect-ratio: 1 / 1;
      display:flex;
      flex-direction:column;
    }
    #queueList .queueCue .cueTop{ padding-right:38px; }
    #queueList .queueCue .dragHandle{
      position:absolute;
      top:10px; right:10px;
      z-index:2;
      cursor:grab;
    }
    #queueList .queueCue.active{
      border-color: rgba(110,231,255,.55);
      background: linear-gradient(180deg, rgba(110,231,255,.08), rgba(0,0,0,.10));
    }
    #queueList .queueCue.q-playing{
      border-color: rgba(46,229,157,.65);
      background: rgba(46,229,157,.10);
      box-shadow: inset 0 0 0 2px rgba(46,229,157,.22);
    }
    #queueList .queueCue.q-played{
      border-color: rgba(255,93,108,.55);
      background: rgba(255,93,108,.08);
      box-shadow: inset 0 0 0 2px rgba(255,93,108,.18);
    }
    #queueList .queueCue .cueBtns{ margin-top:auto; }

    /* 删除“当前播放”标题下的提示行（如果存在） */
    .panelHeader .sub{ display:none !important; }

    .item{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border:1px solid var(--line2);
      border-radius:14px;
      background: rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
      transition: border-color .15s ease, background .15s ease;
    }
    .item:hover{border-color: rgba(110,231,255,.28); background: rgba(110,231,255,.05)}
    .item.active{border-color: rgba(110,231,255,.55); background: rgba(110,231,255,.08)}
    /* queue status colors */
    #queueList .item{ position: relative; }
    #queueList .item.q-playing{
      border-color: rgba(46,229,157,.65);
      background: rgba(46,229,157,.10);
      box-shadow: inset 4px 0 0 rgba(46,229,157,.85);
    }
    #queueList .item.q-played{
      border-color: rgba(255,93,108,.55);
      background: rgba(255,93,108,.08);
      box-shadow: inset 4px 0 0 rgba(255,93,108,.85);
    }

    .dragHandle{
      width:20px; height:20px;
      display:flex; align-items:center; justify-content:center;
      border-radius:10px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.22);
      color:#cfe0ff;
      font-family:var(--mono);
      font-size:12px;
      cursor:grab;
      flex:0 0 auto;
    }
    .item .meta{flex:1; overflow:hidden}
    .item .meta .name{font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .item .meta .count{font-size:12px;color:var(--muted)}
    .dropHint{
      outline:2px dashed rgba(110,231,255,.35);
      outline-offset:2px;
    }

    .dropzone{
      border:1px dashed rgba(110,231,255,.45);
      border-radius: 16px;
      padding:12px;
      background: rgba(110,231,255,.06);
      color: var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
    }

    /* Mid: cue grid + vertical slider */
    .gridHeader{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      padding:12px;
      border-bottom:1px solid var(--line2);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.22);
      color:var(--muted);
      font-size:12px;
      user-select:none;
      white-space:nowrap;
    }
    .chip strong{color:var(--text); font-weight:600}
    .gridWrap{
      position:relative;
      flex:1;
      min-height:0;
      overflow:auto;
    }
    .grid{
      padding:12px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap:10px;
      overflow:visible;
      padding-right:12px;
    }
    .vscroll{
      position:absolute;
      top:12px;
      right:8px;
      bottom:12px;
      width:18px;
      writing-mode: bt-lr;
      -webkit-appearance: slider-vertical;
      appearance: slider-vertical;
      background: transparent;
      opacity:.85;
      cursor:ns-resize;
    }
    .vscroll:focus{outline:none}
    .vscroll::-webkit-slider-runnable-track{background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); border-radius: 999px;}
    .vscroll::-webkit-slider-thumb{ -webkit-appearance:none; width:16px; height:16px; border-radius:999px; background: rgba(110,231,255,.55); border:1px solid rgba(255,255,255,.20); box-shadow:0 0 14px rgba(110,231,255,.25);}

    .cue{
      border:1px solid var(--line2);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.10));
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      position:relative;
      transition: border-color .15s ease, transform .05s ease, background .15s ease;
    }
    .cue:hover{border-color: rgba(110,231,255,.35); background: linear-gradient(180deg, rgba(110,231,255,.07), rgba(0,0,0,.10))}
    .cue:active{transform: translateY(1px)}
    .cueTop{
      padding:10px 10px 8px;
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .cueState{
      width:10px;height:10px;border-radius:999px;
      margin-top:4px;
      background: rgba(154,167,189,.6);
      box-shadow: 0 0 0 4px rgba(154,167,189,.12);
      flex:0 0 auto;
    }
    .cueState.ready{background: rgba(154,167,189,.75); box-shadow: 0 0 0 4px rgba(154,167,189,.12)}
    .cueState.playing{background: var(--good); box-shadow: 0 0 0 4px rgba(46,229,157,.18)}
    .cueState.played{background: var(--warn); box-shadow: 0 0 0 4px rgba(255,204,102,.18)}
    .cueTitle{flex:1; overflow:hidden;}
    .cueTitle .name{
      font-size:13px;
      font-weight:650;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .cueTitle .sub{
      margin-top:5px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .cutIcon{display:inline-block; margin-right:6px; opacity:.85; filter: drop-shadow(0 0 6px rgba(255,204,102,.18));}
    .tag.cut{ border-color: rgba(255,204,102,.45); background: rgba(255,204,102,.10); color: rgba(255,231,191,.95); }
    .progress{
      touch-action:none;

      height:4px;
      background: rgba(255,255,255,.08);
      position:relative;
      cursor:pointer;
    }
    .progress > i{
      position:absolute; left:0; top:0; bottom:0;
      width:0%;
      background: linear-gradient(90deg, rgba(110,231,255,.35), rgba(46,229,157,.55));
      box-shadow: 0 0 10px rgba(110,231,255,.25);
    }
    .cueBtns{
      padding:10px;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      border-top:1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.10);
    }
    .cueBtns .leftBtns{display:flex; gap:8px}
    .cueBtns .rightBtns{display:flex; gap:8px}

    /* Right pane */
    .rightPane{display:flex; flex-direction:column; height:100%; overflow:hidden;}
    .rightTop{flex:1 1 auto; overflow:auto; padding:12px;}
    .rightBottom{flex:1 1 auto; overflow:hidden; padding:12px; padding-top:0;}
    .bottomGrid{
      height:100%;
      display:flex;
      gap:12px;
      overflow:hidden;
      align-items:stretch;
    }
    .bottomGrid .split.pq{
      flex:0 0 14px;
      border-radius: 10px;
    }
    #playlistCard{
      flex:0 0 360px;
      min-width:240px;
    }
    #queueCard{
      flex:1 1 auto;
      min-width:260px;
    }
    .card{
      border:1px solid var(--line2);
      border-radius: var(--radius2);
      background: rgba(0,0,0,.22);
      box-shadow: var(--shadow);
      overflow:hidden;
      height:100%;
      display:flex;
      flex-direction:column;
      min-height:120px;
    }
    .card .cardHead{
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
      flex:0 0 auto;
    }
    .card .cardHead h4{margin:0;font-size:13px; letter-spacing:.4px}
    .card .cardBody{padding:12px; overflow:auto; flex:1 1 auto;}
    .bigWave{
      touch-action:none;

      height:88px;
      width:100%;
      display:block;
      background: rgba(0,0,0,.30);
      border:1px solid rgba(255,255,255,.05);
      border-radius: 14px;
      cursor:pointer;
    }
    .field{
      display:flex; flex-direction:column; gap:6px;
      min-width:160px;
    }
    .field label{font-size:12px; color:var(--muted)}
    .field input, .field select{
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.02);
      color:var(--text);
      outline:none;
    }
    .field input:focus, .field select:focus{border-color: rgba(110,231,255,.35)}
    .twoCol{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .small{font-size:12px; color:var(--muted); line-height:1.5}
    .mono{font-family:var(--mono)}
    .warn{color:var(--warn)}
    .good{color:var(--good)}
    .bad{color:var(--bad)}

    .toast{
      position:fixed;
      right:14px;
      bottom:14px;
      max-width: 420px;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.55);
      box-shadow: 0 20px 45px rgba(0,0,0,.55);
      color: var(--text);
      opacity:0;
      transform: translateY(8px);
      transition: opacity .22s ease, transform .22s ease;
      pointer-events:none;
      z-index: 1000;
    }
    .toast.show{opacity:1; transform: translateY(0)}

    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index: 2000;
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width:min(920px, 98vw);
      max-height: 92vh;
      overflow:auto;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,14,20,.92);
      box-shadow: 0 30px 70px rgba(0,0,0,.6);
      backdrop-filter: blur(10px);
    }
    .modalHead{
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      position:sticky;
      top:0;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(10,14,20,.92));
    }
    .modalHead h3{margin:0;font-size:14px;letter-spacing:.5px}
    .modalBody{padding:12px}
    .helpGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
    }
    @media (max-width: 920px){
      .col.left{width:240px}
      .col.mid{width:420px}
      .helpGrid{grid-template-columns:1fr}
      .meter{min-width:210px}
      .bottomGrid{flex-direction:column}
      .bottomGrid .split.pq{display:none}
      #playlistCard{width:auto; flex:0 0 auto}
    }

    .ghostInput{
      width:100%;
      border:none;
      outline:none;
      padding:6px 8px;
      border-radius:10px;
      background: rgba(0,0,0,.25);
      color: var(--text);
      border:1px solid rgba(255,255,255,.12);
    }
    .inlineEdit{
      display:flex;
      gap:8px;
      align-items:center;
      width:100%;
    }
  
    .gridWrap, .cardBody, .rightTop{ scrollbar-gutter: stable; }

    /* queue per-item end action */
    .tag.mode{border-color: rgba(110,231,255,.28); background: rgba(110,231,255,.08)}
    .btn.tiny{padding:6px 8px; border-radius:10px; font-size:12px; line-height:1}
    .btn.qMode.on{border-color: rgba(110,231,255,.60); background: rgba(110,231,255,.14)}
    .modeBtns{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-left:10px}


    /* ===== Mobile: playlist/queue as swipeable single panel ===== */
    .pqSeg{display:none; gap:8px; align-items:center; justify-content:flex-start; margin: 8px 0 10px;}
    .pqSeg .pqbtn{border-radius:999px;}
    .pqSeg .pqbtn.on{border-color: rgba(110,231,255,.60); background: rgba(110,231,255,.14); color:#f2f4ff;}
    @media (max-width: 980px){
      .pqSeg{
        display:flex;
        position: sticky;
        top: 0;
        z-index: 6;
        padding: 8px;
        border: 1px solid rgba(255,255,255,.10);
        border-radius: 16px;
        background: rgba(16,18,34,.82);
        backdrop-filter: blur(10px);
      }
      #bottomGrid{ grid-template-columns: 1fr !important; gap: 0 !important; }
      #splitPQ{ display:none !important; }
      #bottomGrid .card{ display:none; }
      #bottomGrid.show-pl #playlistCard{ display:block; }
      #bottomGrid.show-q #queueCard{ display:block; }
      #playlistCard .cardBody, #queueCard .cardBody{
        max-height: min(50dvh, 520px);
        overflow:auto;
      }
      #playlistCard .small, #queueCard .small{ display:none; }
    }
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand" title="离线单页 · P1风格音频播控台 v2.8">
      <span class="dot"></span>
      <strong>音频播控台</strong>
      <span class="tag">v2.8</span>
    </div>

    <button class="btn small" id="btnTopToggleLeft" title="收起/展开左侧素材库">收起素材库</button>
    <button class="btn small" id="btnTopToggleMid" title="收起/展开中间当前分类">收起当前分类</button>

    <button class="btn icon primary" id="btnPlayPause" title="播放/暂停（空格）">▶</button>
    <button class="btn icon" id="btnStop" title="停止（S）">■</button>
    <div class="meter" title="主音量">
      <label>主音量</label>
      <input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.85"/>
      <span class="mono" id="masterVolText">0.85</span>
    </div>
    <button class="btn small" id="btnGlobalSettings">设置</button>
<div class="pill" id="savePill" title="自动保存状态"><span id="saveStateText">已保存</span></div>
    <button class="btn small" id="btnUndo" title="撤销上一步（Ctrl+Z）" disabled>撤销</button>

    <div class="spacer"></div>

    <button class="btn" id="btnImport" title="导入音频（I）">导入音频</button>
    <button class="btn" id="btnExport" title="导出工程（E）">导出工程</button>
    <button class="btn" id="btnImportProject" title="导入工程">导入工程</button>
<button class="btn danger" id="btnResetStates" title="重置已播状态（R）">状态重置</button>
    <button class="btn" id="btnHelp" title="快捷键/使用说明（?）">帮助</button>

    <input id="fileInput" type="file" accept="audio/*" multiple style="display:none" />
    <input id="projectInput" type="file" accept="application/json" style="display:none" />
  </div>

  <div class="app" id="app">
    <!-- Left -->
    <div class="col left" id="colLeft">
      <div class="panel">
        <div class="panelHeader">
          <div>
            <h3>素材库 / 分类</h3>
</div>
          <div class="row">
            <button class="btn small" id="btnAddCat">+ 分类</button>
            <button class="btn small danger" id="btnDelCat" title="删除当前分类（立即执行）">删除</button>
          </div>
        </div>
        <div class="panelBody">
          <div class="search">
            <span class="muted">🔎</span>
            <input id="catSearch" placeholder="搜索分类 / 音频..." />
            <span class="tag" id="libCount">0</span>
          </div>

          <div class="dropzone" id="dropzone">
            <div>
              <div><strong>拖拽音频到这里导入</strong></div>
              <div class="small">mp3 / wav / m4a 等（取决于浏览器解码能力）</div>
            </div>
            <div class="row">
              <button class="btn small" id="btnBrowse">选择文件</button>
            </div>
          </div>

          <div class="hr"></div>
          <div class="small">
            建议分类：<span class="mono">01迎宾 / 02开场 / 03仪式 / 04敬酒 / 05互动 / 06退场 / 07救场</span>
          </div>

          <div class="list" id="catList"></div>
        </div>
      </div>
    </div>

    <div class="split" id="split1" title="拖动调整宽度"></div>

    <!-- Middle -->
    <div class="col mid" id="colMid">
      <div class="panel">
        <div class="gridHeader">
          <div class="chip"><span class="muted">当前分类</span> <strong id="curCatName">未选择</strong></div>
          <div class="chip"><span class="muted">模式</span> <strong id="modeText">单轨</strong>
            <button class="btn small" id="btnMode">切换</button>
          </div>
          <div class="chip"><span class="muted">操作</span> 点击卡片播放 · 点击 <span class="kbd">＋</span> 加入队列 · 拖拽卡片到队列</div>
          <div class="spacer"></div>
          <button class="btn small" id="btnAddCue" title="添加空白音频块（占位/稍后绑定）">+ 音频块</button>
        </div>

        <div class="gridWrap">
          <div class="grid" id="cueGrid"></div>
</div>
      </div>
    </div>

    <div class="split" id="split2" title="拖动调整宽度"></div>

    <!-- Right -->
    <div class="col right" id="colRight">
      <div class="panel right rightPane">
        <div class="panelHeader">
          <div>
            <h3>当前播放</h3>
            </div>
          <div class="row">
            <button class="btn small" id="btnNowCompact" title="压缩/展开当前播放区高度">⬇ 展开</button>
            <button class="btn small" id="btnCueSettings" title="当前曲目设置" disabled>⚙ 设置</button>
          </div>
        </div>

        <div class="rightTop" id="rightTop">
          <div class="card" style="height:auto">
            <div class="cardHead">
              <h4>正在播放</h4>
              <span class="tag" id="playStateTag">Idle</span>
            </div>
            <div class="cardBody">
              <div class="row" style="justify-content:space-between">
                <div style="min-width:240px; max-width:72%">
                  <div style="font-weight:700" id="nowName">—</div>
                  <div class="small mono" id="nowMeta">—</div>
                </div>
                <div class="row">
                  <button class="btn icon" id="btnPrev" title="上一条（↑）">↑</button>
                  <button class="btn icon" id="btnNext" title="下一条（↓）">↓</button>
                </div>
              </div>
              <div class="nowWaveWrap">
                <canvas class="bigWave" id="bigWave"></canvas>
              </div>
              <div class="progress nowProg" id="bigProgress"><i id="bigProg"></i></div>
              <div class="row nowTimeRow" style="justify-content:space-between">
                <div class="mono" id="nowTime">00:00.000 / 00:00.000</div>
                <div class="row">
                  <span class="tag mono" id="hotkeyTag">HK: —</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="splitV" id="splitV" title="拖动调整上下高度"></div>

        <div class="rightBottom" id="rightBottom">
          <div class="pqSeg" id="pqSeg" role="tablist" aria-label="播放列表与队列切换">
            <button class="btn small pqbtn on" type="button" data-k="pl" role="tab">播放列表</button>
            <button class="btn small pqbtn" type="button" data-k="q" role="tab">当前队列</button>
          </div>
          <div class="bottomGrid show-pl" id="bottomGrid">
            <div class="card" id="playlistCard">
              <div class="cardHead">
                <h4>播放列表</h4>
                <div class="row">
                  <button class="btn tiny" id="btnAddPlaylist">+ 列表</button>
                <button class="btn tiny" id="btnPlaylistSettings" title="当前播放列表设置">⚙</button>
                </div>
              </div>
              <div class="cardBody">
                <div class="small">拖拽排序 · 双击重命名</div>
                <div class="list" id="playlistList" style="margin-top:10px"></div>
              </div>
            </div>

            <div class="split pq" id="splitPQ" title="拖动调整左右宽度"></div>

            <div class="card" id="queueCard">
              <div class="cardHead">
                <h4>当前队列</h4>
                <span class="tag" id="queueCount">0</span>
              </div>
              <div class="cardBody" style="position:relative">
                <div class="small">拖拽排序 · 可从中间拖入音频块</div>
                <div class="list" id="queueList" style="margin-top:10px"></div>
</div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>

  <div class="toast" id="toast"></div>

  <!-- Global settings modal -->
  <div class="modalBackdrop" id="globalModal">
    <div class="modal">
      <div class="modalHead">
        <h3>工程设置</h3>
        <div class="row">
          <button class="btn small" id="globalClose">关闭</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="row">
          <div class="field">
            <label>默认淡入（秒）</label>
            <input id="dfadeIn" type="number" min="0" step="0.05" value="0.4"/>
          </div>
          <div class="field">
            <label>默认淡出（秒）</label>
            <input id="dfadeOut" type="number" min="0" step="0.05" value="0.6"/>
          </div>
          <div class="field">
            <label>项目名（导出时显示）</label>
            <input id="projectName" placeholder="例如：2026-02-12 婚礼A场" />
          </div>
        </div>
        <div class="hr"></div>
        <div class="small">
          默认淡入/淡出会应用到新导入的音频块；已存在的音频块不强制覆盖（可在单曲设置中单独改）。
        </div>
        
        <div class="hr"></div>
        <div class="row" style="align-items:flex-end; flex-wrap:wrap">
          <div class="field" style="min-width:260px">
            <label>界面布局</label>
            <div class="row" style="flex-wrap:wrap">
              <button class="btn small" id="btnToggleLeftPane" title="收起/展开左侧素材库">收起素材库</button>
              <button class="btn small" id="btnToggleMidPane" title="收起/展开中间当前分类">收起当前分类</button>
            </div>
            <div class="small muted" style="margin-top:6px">收起后右侧「当前播放」会自动扩展；再次点击可展开。</div>
          </div>
          <div class="field" style="min-width:260px">
            <label>本地自动保存</label>
            <div class="row" style="flex-wrap:wrap">
              <span class="tag good" id="autoSaveTag" title="所有操作会自动写入本地（含音频）">已开启</span>
              <button class="btn tiny" id="btnSaveNow" title="立刻写入本地存档">立即保存</button>
            </div>
            <div class="small muted" style="margin-top:6px">保存位置：浏览器本地（IndexedDB）。关闭页面不会丢失。</div>
          </div>
          <div class="field" style="min-width:320px">
            <label>磁盘工程文件（可选）</label>
            <div class="row" style="flex-wrap:wrap">
              <button class="btn tiny" id="btnBindDiskFile" title="选择一个 .json 文件，用于写入工程备份（含音频）">绑定文件</button>
              <button class="btn tiny" id="btnWriteDiskNow" title="立刻写入到已绑定的文件">写入磁盘</button>
              <button class="btn tiny" id="btnToggleDiskAuto" title="是否跟随本地自动保存一起写入磁盘（节流约 60 秒）">自动：关</button>
              <button class="btn tiny danger" id="btnUnbindDiskFile" title="解除绑定（不会删除磁盘文件）">解除</button>
            </div>
            <div class="small muted" style="margin-top:6px" id="diskFileHint">未绑定（推荐 Chrome/Edge；部分浏览器/环境可能不支持直接写入磁盘）</div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="row">
          <button class="btn primary" id="globalSave">保存</button>
          <span class="small muted">快捷键：<span class="kbd">I</span> 导入 · <span class="kbd">E</span> 导出 · <span class="kbd">S</span> 停止 · <span class="kbd">Space</span> 暂停/继续</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Cue settings modal (includes trim) -->
  <div class="modalBackdrop" id="cueModal">
    <div class="modal">
      <div class="modalHead">
        <h3 id="cueModalTitle">单曲设置</h3>
        <div class="row">
          <button class="btn small" id="cueClose">关闭</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div style="flex:1; min-width: 360px">
            <div class="row">
              <div class="field" style="min-width:240px">
                <label>名称（双击也可改）</label>
                <input id="cueName" />
              </div>
              <div class="field" style="min-width:240px">
                <label>文件名（仅显示/导出）</label>
                <input id="cueFileName" />
              </div>
            </div>

            <div class="hr"></div>

            <div class="row">
              <div class="field">
                <label>音量（单条）</label>
                <input type="range" min="0" max="1.8" step="0.01" id="cueVol" />
              </div>
              <div class="field">
                <label>播放模式</label>
                <select id="cueBehavior">
                  <option value="default">跟随全局</option>
                  <option value="solo">强制单轨（切换时淡出当前）</option>
                  <option value="mix">允许叠加（不打断）</option>
                </select>
              </div>
              <div class="field">
                <label>快捷键（单键）</label>
                <input id="cueHotkey" placeholder="例如：A / 1 / F" />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label>淡入（秒）</label>
                <input id="cueFadeIn" type="number" min="0" step="0.05"/>
              </div>
              <div class="field">
                <label>淡出（秒）</label>
                <input id="cueFadeOut" type="number" min="0" step="0.05"/>
              </div>
            </div>
          </div>

          <div style="width: min(360px, 38vw)">
            <div class="small">
              裁剪：点击波形/进度条定位播放头 → 点“设为起点/终点”。<br/>
              <span class="warn">你选了 B：</span>“生成新文件”会 <b>下载 + 自动加入当前分类</b>。
            </div>
            <div class="hr"></div>
            <div class="row">
              <button class="btn small" id="btnSetIn">设为起点</button>
              <button class="btn small" id="btnSetOut">设为终点</button>
            </div>
            <div class="row">
              <div class="field">
                <label>起点 In（秒）</label>
                <input id="trimIn" type="number" min="0" step="0.01"/>
              </div>
              <div class="field">
                <label>终点 Out（秒）</label>
                <input id="trimOut" type="number" min="0" step="0.01"/>
              </div>
            </div>
            <div class="row">
              <button class="btn primary" id="btnApplyTrim">保存应用</button>
              <button class="btn" id="btnRenderTrim">生成新文件</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div>
          <canvas class="bigWave" id="trimWave" style="height:160px"></canvas>
          <div style="margin-top:10px" class="progress" id="trimProgress"><i id="trimProg"></i></div>
          <div class="row" style="margin-top:10px; justify-content:space-between">
            <div class="mono" id="trimTime">00:00.000 / 00:00.000</div>
            <div class="row">
              <button class="btn small" id="btnPlayFromHead">从播放头播放</button>
              <button class="btn small danger" id="btnStopFromModal">停止</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="row" style="justify-content:space-between">
          <div class="small muted">
            小技巧：拖动中间音频块或队列条目即可排序；队列支持从中间拖入。
          </div>
          <div class="row">
            <button class="btn danger" id="btnDeleteCue">删除此音频块</button>
            <button class="btn" id="cueSave">保存设置</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  
  <!-- Playlist settings modal -->
  <div class="modalBackdrop" id="plModal">
    <div class="modal">
      <div class="modalHead">
        <h3 id="plModalTitle">播放列表设置</h3>
        <div class="row">
          <button class="btn small" id="plClose">关闭</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="row">
          <div class="field" style="min-width:240px">
            <label>播完后</label>
            <select id="plEndAction">
              <option value="next">播放下一曲</option>
              <option value="pause">播放完暂停</option>
            </select>
          </div>
          <div class="field" style="min-width:240px">
            <label>循环</label>
            <select id="plLoopMode">
              <option value="none">不循环</option>
              <option value="single">单曲循环（当前曲）</option>
              <option value="queue">队列循环（到头回到第一首）</option>
            </select>
          </div>
          <div class="field" style="min-width:240px">
            <label>顺序</label>
            <select id="plOrder">
              <option value="seq">顺序播放</option>
              <option value="shuffle">随机播放</option>
            </select>
          </div>
        </div>
        <div class="hr"></div>
        <div class="small">
          说明：这些设置对 <b>当前播放列表</b> 生效。你可以为不同场次/不同环节准备不同的播放列表。
        </div>
        <div class="hr"></div>
        <div class="row">
          <button class="btn primary" id="plSave">保存</button>
        </div>
      </div>
    </div>
  </div>


  <!-- Help modal -->
  <div class="modalBackdrop" id="helpModal">
    <div class="modal">
      <div class="modalHead">
        <h3>使用说明（v2）</h3>
        <div class="row">
          <button class="btn small" id="helpClose">关闭</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="helpGrid">
          <div>
            <div class="card" style="height:auto">
              <div class="cardHead"><h4>快速上手</h4></div>
              <div class="cardBody small">
                1）左侧 <b>+ 分类</b>：双击分类名可原位重命名；拖拽手柄可排序。<br/>
                2）导入：拖拽音频到左侧导入区，或点“导入音频”。<br/>
                3）中间：点击音频卡片播放；点 <b>＋</b> 加入队列；也可直接拖到右侧队列。<br/>
                4）右侧：点击波形或进度条可跳播；<b>⚙ 设置</b> 进入单曲参数与裁剪。<br/>
                5）播放列表：右下“播放列表”可新增/重命名/拖拽排序；队列对当前列表生效。<br/>
              </div>
            </div>
          </div>
          <div>
            <div class="card" style="height:auto">
              <div class="cardHead"><h4>快捷键</h4></div>
              <div class="cardBody small">
                <div class="row">
                  <span class="kbd">Space</span> 播放/暂停当前
                  <span class="kbd">S</span> 停止（淡出）
                  <span class="kbd">I</span> 导入音频
                  <span class="kbd">E</span> 导出工程
                  <span class="kbd">R</span> 状态重置
                  <span class="kbd">←</span>/<span class="kbd">→</span> 队列上一条/下一条
                  <span class="kbd">↑</span>/<span class="kbd">↓</span> 主音量 +/−
                  <span class="kbd">?</span> 帮助
                </div>
                <div class="hr"></div>
                单条快捷键：在“单曲设置”里填一个键（例如 F），按下即可触发播放。
              </div>
            </div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="small">
          说明：本页为离线单页运行；保存使用 IndexedDB（刷新也保留音频）。生成新文件会下载 WAV，并自动加入当前分类。
        </div>
      </div>
    </div>
  </div>

  <script>

    // ===== Utilities =====
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const fmtTime = (sec) => {
      if (!isFinite(sec)) return "00:00.000";
      const m = Math.floor(sec / 60);
      const s = sec - m*60;
      const mm = String(m).padStart(2,'0');
      const ss = String(Math.floor(s)).padStart(2,'0');
      const ms = String(Math.floor((s - Math.floor(s))*1000)).padStart(3,'0');
      return `${mm}:${ss}.${ms}`;
    };
    const uuid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
    const escapeHtml = (s="") => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const escapeAttr = (s="") => escapeHtml(s);

    function toast(msg){
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=>t.classList.remove("show"), 2200);
    }

    // ===== State =====
    const STORE_KEY = "p1_style_audio_console_v2";
    const state = {
      projectName: "local",
      dfFadeIn: 0.40,
      dfFadeOut: 0.60,
      masterVol: 0.85,
      mode: "solo", // solo | mix
      cats: [],
      curCatId: null,
      cues: {},     // cueId -> cue obj (audioBuf in-memory only)
      playlists: [], // {id,name,order,queue, settings:{endAction, loopMode, order}}
      activePlaylistId: null,
      selectedCueId: null,
      // runtime audio
      audio: null,
      playingNodes: {}, // cueId -> {cueId, source, gain, startedAt, offset, duration}
      focusCueId: null, // last triggered / shown in "当前播放"
      pausedFocus: null, // {cueId, offset, remaining}
      raf: null,
      trimDraft: {cueId:null, in:0, out:0, head:0},
      ui: {playlistW: 360, leftW: null, midW: null, collapseLeft: false, collapseMid: false},
      _dirty: false,
      _saving: false,
      _lastSavedAt: 0,
      _pendingAudioKeys: new Set()
    };

    // ===== UI helpers (v2.7) =====
    function ensureUI(){
      state.ui = state.ui || {};
      if (!("playlistW" in state.ui)) state.ui.playlistW = 360;
      if (!("leftW" in state.ui)) state.ui.leftW = null;
      if (!("midW" in state.ui)) state.ui.midW = null;
      if (!("collapseLeft" in state.ui)) state.ui.collapseLeft = false;
      if (!("collapseMid" in state.ui)) state.ui.collapseMid = false;
      if (!("diskAuto" in state.ui)) state.ui.diskAuto = false;
      if (!("diskFileName" in state.ui)) state.ui.diskFileName = "";
      if (!("_lastDiskWrite" in state.ui)) state.ui._lastDiskWrite = 0;
    }

    function applyLayoutUI(){
      ensureUI();
      const app = $("#app");
      const leftCollapsed = !!state.ui.collapseLeft;
      const midCollapsed  = !!state.ui.collapseMid;

      // restore widths when expanded
      if (!leftCollapsed && state.ui.leftW){
        $("#colLeft").style.width = state.ui.leftW + "px";
      }
      if (!midCollapsed && state.ui.midW){
        $("#colMid").style.width = state.ui.midW + "px";
      }

      app.classList.toggle("collapsed-left", leftCollapsed);
      app.classList.toggle("collapsed-mid",  midCollapsed);

      // sync buttons (if present)
      const bl = $("#btnToggleLeftPane");
      const bm = $("#btnToggleMidPane");
      if (bl){
        bl.textContent = leftCollapsed ? "展开素材库" : "收起素材库";
        bl.classList.toggle("primary", leftCollapsed);
      }
      if (bm){
        bm.textContent = midCollapsed ? "展开当前分类" : "收起当前分类";
        bm.classList.toggle("primary", midCollapsed);
      }

      const tl = $("#btnTopToggleLeft");
      const tm = $("#btnTopToggleMid");
      if (tl){
        tl.textContent = leftCollapsed ? "展开素材库" : "收起素材库";
        tl.classList.toggle("primary", leftCollapsed);
      }
      if (tm){
        tm.textContent = midCollapsed ? "展开当前分类" : "收起当前分类";
        tm.classList.toggle("primary", midCollapsed);
      }
    }

    function togglePaneCollapse(side){
      ensureUI();
      if (side === "left"){
        const now = !!state.ui.collapseLeft;
        if (!now){
          const w = Math.round($("#colLeft").getBoundingClientRect().width);
          if (w) state.ui.leftW = w;
        }
        state.ui.collapseLeft = !now;
      }else if (side === "mid"){
        const now = !!state.ui.collapseMid;
        if (!now){
          const w = Math.round($("#colMid").getBoundingClientRect().width);
          if (w) state.ui.midW = w;
        }
        state.ui.collapseMid = !now;
      }
      applyLayoutUI();
      persist(); // auto save UI
    }


    // ===== Audio Engine (Web Audio) =====
    function ensureAudio(){
      if (state.audio) return state.audio;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const master = ctx.createGain();
      master.gain.value = state.masterVol;
      master.connect(ctx.destination);
      state.audio = {ctx, master};
      return state.audio;
    }
    function ensureAudioUserGesture(){
      ensureAudio();
      const {ctx} = state.audio;
      if (ctx.state === "suspended"){
        ctx.resume().catch(()=>{});
      }
    }

    async function decodeFile(file){
      const {ctx} = ensureAudio();
      const buf = await file.arrayBuffer();
      const audioBuf = await ctx.decodeAudioData(buf.slice(0));
      return {arrayBuffer: buf, audioBuf};
    }

    function computePeaks(audioBuf, points=140){
      const ch = audioBuf.numberOfChannels ? audioBuf.getChannelData(0) : new Float32Array();
      const len = ch.length;
      const step = Math.max(1, Math.floor(len / points));
      const peaks = new Float32Array(points);
      for (let i=0;i<points;i++){
        const start = i*step;
        let peak = 0;
        for (let j=0;j<step && start+j<len;j++){
          const v = Math.abs(ch[start+j]);
          if (v>peak) peak=v;
        }
        peaks[i]=peak;
      }
      let max = 0;
      for (const p of peaks) if (p>max) max=p;
      if (max>0){
        for (let i=0;i<peaks.length;i++) peaks[i]=peaks[i]/max;
      }
      return Array.from(peaks);
    }

    function getCue(cueId){ return state.cues[cueId]; }
    function getCueFadeIn(cueId){
      const c = getCue(cueId);
      const v = (c?.fadeIn ?? state.dfFadeIn);
      return Math.max(0, +v || 0);
    }
    function getCueFadeOut(cueId){
      const c = getCue(cueId);
      const v = (c?.fadeOut ?? state.dfFadeOut);
      return Math.max(0, +v || 0);
    }
    function getCueBehavior(cueId){
      const c = getCue(cueId);
      return c?.behavior || "default";
    }
    function shouldSolo(cueId){
      const beh = getCueBehavior(cueId);
      if (beh === "solo") return true;
      if (beh === "mix") return false;
      return state.mode === "solo";
    }
    function cueClip(c){
      const dur = c?.duration || 0;
      const start = clamp(+c.start || 0, 0, dur);
      let end = +c.end || 0;
      end = end <= 0 ? dur : clamp(end, 0, dur);
      if (end < start) end = start;
      return {start, end, playDur: Math.max(0, end - start), dur};
    }

    function isCueTrimmed(c){
      const clip = cueClip(c);
      // When duration is unknown (not decoded yet), still treat non-zero trim points as "trimmed".
      const rawS = Number(c?.start || 0);
      const rawE = Number(c?.end || 0);
      if (!clip || !clip.dur || clip.dur <= 0){
        return (rawS > 0.01) || (rawE > 0.01);
      }
      return (clip.start > 0.01) || (clip.end < (clip.dur - 0.01));
    }

    function stopNode(cueId, {fade=true}={}){
      const node = state.playingNodes[cueId];
      if (!node) return;
      const {ctx} = ensureAudio();
      try{
        const fadeOut = fade ? getCueFadeOut(cueId) : 0;
        if (fadeOut > 0 && node.gain){
          const now = ctx.currentTime;
          node.gain.gain.cancelScheduledValues(now);
          node.gain.gain.setValueAtTime(node.gain.gain.value, now);
          node.gain.gain.linearRampToValueAtTime(0.0001, now + fadeOut);
          setTimeout(()=>{ try{ node.source?.stop(); }catch(e){} }, Math.ceil((fadeOut+0.05)*1000));
        }else{
          try{ node.source?.stop(); }catch(e){}
        }
      }catch(e){}
      delete state.playingNodes[cueId];
      if (state.focusCueId === cueId) state.focusCueId = null;
    }

    function stopAll({fade=true}={}){
      const ids = Object.keys(state.playingNodes);
      for (const id of ids){
        stopNode(id, {fade});
      }
      state.pausedFocus = null;
      state.focusCueId = null;
      updateNowPlaying(null);
      renderGrid();
      renderQueue();
    }

    function pauseOrResumeFocus(){
      // focus chosen: playing focus -> pause; pausedFocus -> resume; else play queue first
      if (state.pausedFocus){
        ensureAudioUserGesture();
        const {cueId, offset, remaining} = state.pausedFocus;
        state.pausedFocus = null;
        playCue(cueId, {offset, duration: remaining, fadeInOverride: 0.02, force:true});
        return;
      }
      const focus = state.focusCueId;
      if (!focus){
        const q = getActiveQueue();
        if (q.length){
          ensureAudioUserGesture();
          playCue(q[0], {force:true});
        }
        return;
      }
      const node = state.playingNodes[focus];
      if (!node){
        // nothing playing -> try resume from clip start
        ensureAudioUserGesture();
        playCue(focus, {force:true});
        return;
      }
      // pause focus: compute current time, stop without fade, store pausedFocus
      const {ctx} = ensureAudio();
      const played = (ctx.currentTime - node.startedAt);
      const cur = clamp(node.offset + played, node.offset, node.offset + node.duration);
      const remain = Math.max(0, (node.offset + node.duration) - cur);
      stopNode(focus, {fade:false});
      state.pausedFocus = {cueId: focus, offset: cur, remaining: remain};
      updateNowPlaying(focus, {paused:true});
      renderGrid();
      renderQueue();
    }

    function playCue(cueId, opts={}){
      const c = getCue(cueId);
      if (!c || !c.audioBuf){
        toast("该音频块未绑定音频文件");
        return;
      }
      ensureAudioUserGesture();
      const {ctx, master} = state.audio;

      // toggle stop if same cue is focus and currently playing
      if (!opts.force && state.focusCueId === cueId && state.playingNodes[cueId]){
        stopNode(cueId, {fade:true});
        updateNowPlaying(null);
        renderGrid();
        renderQueue();
        return;
      }

      // if solo needed, stop all others
      if (shouldSolo(cueId)){
        // 若切歌导致上一首被打断，记为“已播放”（仅队列内）
        for (const pid of Object.keys(state.playingNodes || {})){
          if (pid !== cueId) markCuePlayedIfInQueue(pid);
        }
        stopAll({fade:true});
      }else{
        // stop same cue if already playing (re-trigger)
        if (state.playingNodes[cueId]) stopNode(cueId, {fade:true});
      }

      const g = ctx.createGain();
      g.connect(master);

      const s = ctx.createBufferSource();
      s.buffer = c.audioBuf;

      const clip = cueClip(c);
      const offset = opts.offset != null ? opts.offset : clip.start;
      const end = clip.end;
      const duration = opts.duration != null ? opts.duration : Math.max(0, end - offset);

      const v = clamp(+c.vol || 1, 0, 2);
      const fadeIn = (opts.fadeInOverride != null) ? Math.max(0, opts.fadeInOverride) : getCueFadeIn(cueId);

      const now = ctx.currentTime;
      g.gain.setValueAtTime(0.0001, now);
      g.gain.linearRampToValueAtTime(v, now + Math.max(0.001, fadeIn));

      s.connect(g);

      try{
        s.start(0, offset, duration);
      }catch(e){
        try{s.start(0, offset);}catch(e2){}
      }

      c.state = "playing";
      c.lastPlayedAt = Date.now();
      state.playingNodes[cueId] = {cueId, source:s, gain:g, startedAt:now, offset, duration};
      state.focusCueId = cueId;
      state.pausedFocus = null;

      updateNowPlaying(cueId, {paused:false});
      renderGrid();
      renderQueue();

      s.onended = () => {
        // node might already be stopped/replaced
        if (state.playingNodes[cueId] && state.playingNodes[cueId].source === s){
          delete state.playingNodes[cueId];
          c.state = "played";
          markCuePlayedIfInQueue(cueId);
          // if this was focus, follow playlist rules
          if (state.focusCueId === cueId){
            state.focusCueId = null;
            updateNowPlaying(null);
            handleCueEnded(cueId);
          }
          renderGrid();
          renderQueue();
        }
      };
    }

    function seekTo(cueId, targetSec){
      const c = getCue(cueId);
      if (!c) return;
      const clip = cueClip(c);
      const t = clamp(targetSec, clip.start, clip.end);

      // always jump and continue playing (even if previously paused)
      if (state.pausedFocus && state.pausedFocus.cueId === cueId){
        state.pausedFocus = null;
      }
      // stop current node instantly for snappy seek
      if (state.playingNodes[cueId]){
        stopNode(cueId, {fade:false});
      }
      ensureAudioUserGesture();
      playCue(cueId, {offset:t, fadeInOverride:0.02, force:true});
    }

    // ===== Project model helpers =====
    function makeCue({name, fileName, audioBuf, arrayBuffer, peaks, duration}){
      return {
        id: uuid(),
        name: name || "未命名音频块",
        fileName: fileName || "",
        audioKey: "",
        mimeType: "",
        arrayBuffer: arrayBuffer || null,
        audioBuf: audioBuf || null,
        peaks: peaks || [],
        duration: duration || 0,
        state: "ready",
        vol: 1,
        fadeIn: state.dfFadeIn,
        fadeOut: state.dfFadeOut,
        start: 0,
        end: 0,
        hotkey: "",
        behavior: "default",
        lastPlayedAt: 0,
      };
    }

    function ensureDefaultPlaylists(){
      const defSettings = ()=>({endAction:"next", loopMode:"none", order:"seq"});
      const ensureQueueModes = (p)=>{
        if (!Array.isArray(p.queue)) p.queue = [];
        if (!Array.isArray(p.queueModes)) p.queueModes = [];
        const need = p.queue.length - p.queueModes.length;
        if (need>0) p.queueModes = p.queueModes.concat(Array(need).fill("next"));
        if (p.queueModes.length > p.queue.length) p.queueModes = p.queueModes.slice(0, p.queue.length);
        p.queueModes = p.queueModes.map(m=> (m==="loop"||m==="pause"||m==="next") ? m : "next");
      };

      if (!state.playlists.length){
        state.playlists = [
          {id: uuid(), name:"主列表", order:1, queue:[], queueModes:[], playedIds:[], settings:defSettings()},
          {id: uuid(), name:"备选", order:2, queue:[], queueModes:[], playedIds:[], settings:defSettings()},
        ];
        state.activePlaylistId = state.playlists[0].id;
      }else{
        for (const p of state.playlists){
          if (!p.settings) p.settings = defSettings();
          if (!p.settings.endAction) p.settings.endAction = "next";
          if (!p.settings.loopMode) p.settings.loopMode = "none";
          if (!p.settings.order) p.settings.order = "seq";
          if (!Array.isArray(p.playedIds)) p.playedIds = [];
          ensureQueueModes(p);
        }
        if (!state.activePlaylistId){
          state.activePlaylistId = state.playlists[0].id;
        }
      }
    }
    function getActivePlaylist(){
      ensureDefaultPlaylists();
      return state.playlists.find(p=>p.id===state.activePlaylistId) || state.playlists[0];
    }
    function getActiveQueue(){
      return getActivePlaylist().queue;
    }

    function handleCueEnded(cueId){
      const pl = getActivePlaylist();
      const q = pl.queue || [];
      if (!q.length) return;

      // only auto-advance when the ended cue is in active queue
      const idx = q.indexOf(cueId);
      if (idx < 0) return;

      if (!Array.isArray(pl.queueModes)) pl.queueModes = [];
      const mode = pl.queueModes[idx] || "next";

      // 每个队列条目独立：顺序 / 单曲循环 / 播完暂停
      if (mode === "loop"){
        ensureAudioUserGesture();
        playCue(cueId, {force:true});
        return;
      }
      if (mode === "pause"){
        return;
      }

      // otherwise follow playlist order (保持原有：顺序/随机 + 列表循环)
      let nextId = null;
      if (pl.settings.order === "shuffle"){
        if (q.length === 1){
          nextId = q[0];
        }else{
          const pool = q.filter(id=>id!==cueId);
          nextId = pool[Math.floor(Math.random()*pool.length)];
        }
      }else{
        if (idx < q.length-1) nextId = q[idx+1];
        else if (pl.settings.loopMode === "queue") nextId = q[0];
      }

      if (nextId){
        ensureAudioUserGesture();
        playCue(nextId, {force:true});
      }
    }

    // ===== Rendering =====
    function renderAll(){
      renderCats();
      renderGrid();
      renderPlaylists();
      renderQueue();
      updateTopbar();
      updateNowPlaying(state.focusCueId || state.pausedFocus?.cueId || null, {paused: !!state.pausedFocus});
    }

    function updateTopbar(){
      const __dfIn = $("#dfIn"); if (__dfIn) __dfIn.textContent = `${state.dfFadeIn.toFixed(2)}s`;
      const __dfOut = $("#dfOut"); if (__dfOut) __dfOut.textContent = `${state.dfFadeOut.toFixed(2)}s`;
      $("#masterVol").value = String(state.masterVol);
      $("#masterVolText").textContent = state.masterVol.toFixed(2);
      $("#modeText").textContent = (state.mode==="solo" ? "单轨" : "叠加");
    }

    function renderCats(){
      const list = $("#catList");
      list.innerHTML = "";
      const q = ($("#catSearch").value || "").trim().toLowerCase();

      let totalCues = 0;
      const cats = [...state.cats].sort((a,b)=>a.order-b.order);
      for (const cat of cats){
        const cues = cat.cues.map(id => state.cues[id]).filter(Boolean);
        totalCues += cues.length;
        const hit = !q || cat.name.toLowerCase().includes(q) || cues.some(c => (c.name||"").toLowerCase().includes(q));
        if (!hit) continue;

        const div = document.createElement("div");
        div.className = "item" + (cat.id===state.curCatId ? " active":"");
        div.draggable = true;
        div.dataset.catId = cat.id;
        div.innerHTML = `
          <div class="dragHandle" title="拖拽排序">≡</div>
          <div class="meta">
            <div class="name" data-role="catName" title="双击重命名">${escapeHtml(cat.name)}</div>
            <div class="count">${cues.length} 条</div>
          </div>
          <span class="tag mono">${String(cat.order).padStart(2,'0')}</span>
        `;

        div.addEventListener("click", (e)=>{
          const isEditing = div.querySelector("input.ghostInput");
          if (isEditing) return;
          if (e.target.closest('.dragHandle')) return;
          selectCat(cat.id);
        });
        div.querySelector('[data-role="catName"]').addEventListener("dblclick", (e)=>{
          e.stopPropagation();
          inlineEdit(e.target, cat.name, (val)=>{
            cat.name = val || cat.name;
            persist();
            renderCats();
            renderGrid();
          });
        });

        bindDnDCategory(div);
        list.appendChild(div);
      }
      $("#libCount").textContent = String(totalCues);
    }

    function renderGrid(){
      const grid = $("#cueGrid");
      grid.innerHTML = "";
      const cat = state.cats.find(c=>c.id===state.curCatId);
      $("#curCatName").textContent = cat ? cat.name : "未选择";

      if (!cat){
        grid.innerHTML = `<div class="small muted">左侧先创建/选择一个分类，然后导入音频。</div>`;
        $("#btnCueSettings").disabled = true;
        return;
      }

      const cueObjs = cat.cues.map(id => state.cues[id]).filter(Boolean);

      for (const cue of cueObjs){
        const isSel = cue.id===state.selectedCueId;
        const isPlaying = !!state.playingNodes[cue.id];
        const stateClass = isPlaying ? "playing" : (cue.state==="played"?"played":"ready");
        const clip = cueClip(cue);
        const durText = cue.duration ? fmtTime(clip.playDur) : "—";
        const hk = cue.hotkey ? cue.hotkey.toUpperCase() : "";
        const cutMark = isCueTrimmed(cue) ? '<span class="cutIcon" title="已剪裁">✂</span>' : '';
        const card = document.createElement("div");
        card.className = "cue";
        card.draggable = true;
        card.dataset.cueId = cue.id;
        card.style.outline = isSel ? "2px solid rgba(110,231,255,.45)" : "none";

        card.innerHTML = `
          <div class="cueTop">
            <div class="cueState ${stateClass}"></div>
            <div class="cueTitle">
              <div class="name" data-role="cueName" title="双击重命名">${cutMark}${escapeHtml(cue.name||"未命名音频块")}</div>
</div>
          </div>
          <div class="progress" data-role="cueProgress"><i style="width:${getCueProgressPct(cue.id)}%"></i></div>
          <div class="cueBtns">
            <div class="leftBtns">
              <button class="btn small" data-action="play">${isPlaying?"停止":"播放"}</button>
              <button class="btn small" data-action="queue">＋</button>
            </div>
            <div class="rightBtns">
              <button class="btn small" data-action="settings">⚙</button>
              <button class="btn small danger" data-action="del">删</button>
            </div>
          </div>
        `;

        const cueNameEl = card.querySelector('[data-role="cueName"]');
        if (cueNameEl){
          cueNameEl.addEventListener("dblclick", (e)=>{
            e.stopPropagation();
            inlineEdit(e.target, cue.name || "", (val)=>{
              cue.name = val || cue.name;
              persist();
              renderGrid();
              renderQueue();
              if (state.focusCueId === cue.id) updateNowPlaying(cue.id, {paused: !!state.pausedFocus});
            });
          });
        }

        const fnEl = card.querySelector('[data-role="cueFileName"]');
        if (fnEl){
          fnEl.addEventListener("dblclick", (e)=>{
            e.stopPropagation();
            inlineEdit(e.target, cue.fileName || "", (val)=>{
              cue.fileName = val || cue.fileName;
              persist();
              renderGrid();
              renderQueue();
              if (state.focusCueId === cue.id) updateNowPlaying(cue.id, {paused: !!state.pausedFocus});
            });
          });
        }

        card.addEventListener("click", (e)=>{
          const isEditing = card.querySelector("input.ghostInput");
          if (isEditing) return;
          if (e.target.closest('[data-role="cueName"]') || e.target.closest('[data-role="cueFileName"]') || e.target.closest('.dragHandle')) return;
          const btn = e.target.closest("button");
          if (btn){
            const action = btn.dataset.action;
            if (action==="play"){
              state.selectedCueId = cue.id;
              ensureAudioUserGesture();
              if (state.playingNodes[cue.id]) stopNode(cue.id, {fade:true});
              else playCue(cue.id, {force:true});
              persist();
              renderGrid();
              return;
            }
            if (action==="queue"){
              enqueueCue(cue.id);
              return;
            }
            if (action==="settings"){
              state.selectedCueId = cue.id;
              persist();
              openCueModal(cue.id);
              return;
            }
            if (action==="del"){
              removeCue(cue.id);
              return;
            }
          }else{
            state.selectedCueId = cue.id;
            ensureAudioUserGesture();
            playCue(cue.id, {force:true});
            persist();
            renderGrid();
          }
        });

        const prog = card.querySelector('[data-role="cueProgress"]');
        prog.addEventListener("click", (e)=>{
          e.stopPropagation();
          const rect = prog.getBoundingClientRect();
          const ratio = clamp((e.clientX - rect.left) / rect.width, 0, 1);
          const t = cueClip(cue).start + ratio * cueClip(cue).playDur;
          state.selectedCueId = cue.id;
          persist();
          seekTo(cue.id, t);
        });

        bindDnDCue(card);
        grid.appendChild(card);
      }

      $("#btnCueSettings").disabled = !state.selectedCueId;
    }

    function renderPlaylists(){
      ensureDefaultPlaylists();
      const list = $("#playlistList");
      list.innerHTML = "";
      const pls = [...state.playlists].sort((a,b)=>a.order-b.order);
      for (const p of pls){
        const div = document.createElement("div");
        div.className = "item" + (p.id===state.activePlaylistId ? " active":"");
        div.draggable = true;
        div.dataset.plId = p.id;
        div.innerHTML = `
          <div class="dragHandle" title="拖拽排序">≡</div>
          <div class="meta">
            <div class="name" data-role="plName" title="双击重命名">${escapeHtml(p.name)}</div>
            <div class="count">${p.queue.length} 条</div>
          </div>
          <button class="btn tiny danger" data-action="del">删</button>
        `;
        div.addEventListener("click", (e)=>{
          if (e.target.closest('button')) return;
          if (e.target.closest('[data-role="plName"]')) return;
          if (e.target.closest('.dragHandle')) return;
          setActivePlaylist(p.id);
        });
        div.querySelector('[data-role="plName"]').addEventListener("dblclick", (e)=>{
          e.stopPropagation();
          inlineEdit(e.target, p.name, (val)=>{
            p.name = val || p.name;
            persist();
            renderPlaylists();
          });
        });
        div.querySelector('button[data-action="del"]').addEventListener("click", (e)=>{
          e.stopPropagation();
          deletePlaylist(p.id);
        });

        bindDnDPlaylist(div);
        list.appendChild(div);
      }
    }


    function renderQueue(){
      ensureDefaultPlaylists();
      const pl = getActivePlaylist();
      ensurePlaylistPlayed(pl);
      const playedSet = new Set(pl.playedIds || []);
      const q = getActiveQueue();
      $("#queueCount").textContent = String(q.length);
      const list = $("#queueList");
      list.innerHTML = "";

      if (!q.length){
        list.innerHTML = `<div class="small muted">暂无。点中间卡片的 <span class="kbd">＋</span> 或直接拖拽音频块到这里。</div>`;
      }else{
        for (let i=0;i<q.length;i++){
          const id = q[i];
          const cue = state.cues[id];
          if (!cue) continue;

          const isFocus = (state.focusCueId===id) || (state.pausedFocus?.cueId===id);
          const isPlaying = !!state.playingNodes[id];
          const stateClass = isPlaying ? "playing" : (playedSet.has(id) ? "played" : "ready");
          const clip = cueClip(cue);
          const cutTag = isCueTrimmed(cue) ? '<span class="tag cut mono" title="已剪裁">✂</span>' : '';
          const mode = (pl.queueModes && pl.queueModes[i]) ? pl.queueModes[i] : "next";
          const modeIcon = (mode==="loop") ? "🔁" : (mode==="pause") ? "⏸" : "⏭";
          const modeText = (mode==="loop") ? "单曲循环" : (mode==="pause") ? "播完暂停" : "顺序播放";

          const card = document.createElement("div");
          card.className = "cue queueCue" + (isFocus ? " active":"");
          if (isPlaying) card.classList.add("q-playing");
          else if (playedSet.has(id)) card.classList.add("q-played");
          card.draggable = true;
          card.dataset.queueIndex = String(i);
          card.dataset.cueId = id;

          card.innerHTML = `
            <div class="cueTop">
              <div class="cueState ${stateClass}"></div>
              <div class="cueTitle">
                <div class="name" data-role="qName" title="双击重命名">${escapeHtml(cue.name||"未命名")}</div>
                <div class="sub">
                  <span class="mono">${fmtTime(clip.playDur)}</span>
                  ${cutTag}
                  <span class="tag mode mono" title="播放结束动作">${modeIcon} ${modeText}</span>
                  ${cue.fileName?`<span class="tag clip mono" data-role="qFileName" title="双击重命名文件名">${escapeHtml(cue.fileName)}</span>`:""}
                </div>
              </div>
              <div class="dragHandle" title="拖拽排序">≡</div>
            </div>
            <div class="progress" data-role="qProgress"><i style="width:${getCueProgressPct(id)}%"></i></div>
            <div class="cueBtns">
              <div class="leftBtns">
                <button class="btn small" data-action="play">${isPlaying?"停止":"播放"}</button>
                <div class="modeBtns" title="每条独立：顺序 / 单曲循环 / 播完暂停">
                  <button class="btn tiny qMode ${mode==="next"?"on":""}" data-action="mode" data-mode="next" title="顺序播放">⏭</button>
                  <button class="btn tiny qMode ${mode==="loop"?"on":""}" data-action="mode" data-mode="loop" title="单曲循环">🔁</button>
                  <button class="btn tiny qMode ${mode==="pause"?"on":""}" data-action="mode" data-mode="pause" title="播放完暂停">⏸</button>
                </div>
              </div>
              <div class="rightBtns">
                <button class="btn small danger" data-action="rm">移除</button>
              </div>
            </div>
          `;

          // click: play / remove
          card.addEventListener("click", (e)=>{
            const isEditing = card.querySelector('input.ghostInput');
            if (isEditing) return;
            if (e.target.closest('[data-role="qName"]') || e.target.closest('[data-role="qFileName"]') || e.target.closest('.dragHandle')) return;

            const b = e.target.closest("button");
            if (b){
              const act = b.dataset.action;
              if (act==="mode"){
                e.stopPropagation();
                const m = b.dataset.mode || "next";
                if (!Array.isArray(pl.queueModes)) pl.queueModes = [];
                pl.queueModes[i] = (m==="loop"||m==="pause"||m==="next") ? m : "next";
                persist();
                renderQueue();
                return;
              }
              if (act==="rm"){
                e.stopPropagation();
                pushUndo("从队列移除");
                q.splice(i, 1);
                if (pl && Array.isArray(pl.queueModes)) pl.queueModes.splice(i,1);
                if (pl && pl.playedIds) pl.playedIds = pl.playedIds.filter(x=>x!==id);
                persist();
                renderQueue();
                return;
              }
              if (act==="play"){
                e.stopPropagation();
                state.selectedCueId = id;
                state.focusCueId = id;
                persist();
                renderGrid();
                ensureAudioUserGesture();
                if (state.playingNodes[id]) stopNode(id, {fade:true});
                else playCue(id, {force:true});
                return;
              }
            }

            state.selectedCueId = id;
            state.focusCueId = id;
            persist();
            renderGrid();
            ensureAudioUserGesture();
            playCue(id, {force:true});
          });

          // rename (cue name)
          const qNameEl = card.querySelector('[data-role="qName"]');
          if (qNameEl){
            qNameEl.addEventListener("dblclick", (e)=>{
              e.stopPropagation();
              inlineEdit(e.target, cue.name || "", (val)=>{
                cue.name = val || cue.name;
                persist();
                renderGrid();
                renderQueue();
                if (state.focusCueId === cue.id) updateNowPlaying(cue.id, {paused: !!state.pausedFocus});
              });
            });
          }

          // rename (file name)
          const qFnEl = card.querySelector('[data-role="qFileName"]');
          if (qFnEl){
            qFnEl.addEventListener("dblclick", (e)=>{
              e.stopPropagation();
              inlineEdit(e.target, cue.fileName || "", (val)=>{
                cue.fileName = val || cue.fileName;
                persist();
                renderGrid();
                renderQueue();
                if (state.focusCueId === cue.id) updateNowPlaying(cue.id, {paused: !!state.pausedFocus});
              });
            });
          }

          // seek by progress
          const prog = card.querySelector('[data-role="qProgress"]');
          if (prog){
            prog.addEventListener("click", (e)=>{
              e.stopPropagation();
              const rect = prog.getBoundingClientRect();
              const ratio = clamp((e.clientX - rect.left) / Math.max(1, rect.width), 0, 1);
              const t = cueClip(cue).start + ratio * cueClip(cue).playDur;
              state.selectedCueId = id;
              persist();
              seekTo(id, t);
            });
          }

          bindDnDQueueItem(card);
          list.appendChild(card);
        }
      }

      if (!list._dndBound){
        list.addEventListener("dragover", (e)=>{ e.preventDefault(); });
        list.addEventListener("drop", (e)=>{ handleDropToQueue(e); });
        list._dndBound = true;
      }
    }


    function getCueProgressPct(cueId){
      const node = state.playingNodes[cueId];
      if (!node) return 0;
      const {ctx} = ensureAudio();
      const played = (ctx.currentTime - node.startedAt);
      const pct = clamp((played / Math.max(0.001, node.duration)) * 100, 0, 100);
      return pct;
    }

    // ===== Now playing + wave/progress drawing =====
    function updateNowPlaying(cueId, extra={}){
      const tag = $("#playStateTag");
      if (!cueId){
        $("#nowName").textContent = "—";
        $("#nowMeta").textContent = "—";
        $("#nowTime").textContent = "00:00.000 / 00:00.000";
        $("#hotkeyTag").textContent = "HK: —";
        $("#bigProg").style.width = "0%";
        tag.textContent = "Idle";
        drawWave($("#bigWave"), null, {});
        $("#btnCueSettings").disabled = true;
        return;
      }
      const cue = getCue(cueId);
      if (!cue) return;
      const clip = cueClip(cue);
      const trimmed = isCueTrimmed(cue);
      $("#nowName").textContent = cue.name || "未命名音频块";
      $("#nowMeta").textContent = `${trimmed ? "✂ " : ""}${cue.fileName || "未绑定文件"} · 裁剪 ${fmtTime(clip.start)} → ${fmtTime(clip.end)} · 淡入${getCueFadeIn(cueId).toFixed(2)}s 淡出${getCueFadeOut(cueId).toFixed(2)}s`;
      $("#hotkeyTag").textContent = "HK: " + (cue.hotkey ? cue.hotkey.toUpperCase() : "—");
      tag.textContent = extra.paused ? "Paused" : "Playing";
      drawWave($("#bigWave"), cue.peaks, {cueId, clip, drawHead: true});
      $("#btnCueSettings").disabled = false;
    }

    function drawWave(canvas, peaks, opts){
      const dpr = window.devicePixelRatio || 1;
      const w = canvas.width = Math.max(10, canvas.clientWidth) * dpr;
      const h = canvas.height = Math.max(10, canvas.clientHeight) * dpr;
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = "rgba(0,0,0,.25)";
      ctx.fillRect(0,0,w,h);

      if (!peaks || !peaks.length){
        ctx.fillStyle = "rgba(255,255,255,.15)";
        ctx.font = `${12*dpr}px ui-monospace`;
        ctx.fillText("—", 14*dpr, (h/2));
        return;
      }

      const mid = h/2;
      const step = w / peaks.length;
      ctx.fillStyle = "rgba(110,231,255,.22)";
      for (let i=0;i<peaks.length;i++){
        const p = peaks[i];
        const x = i*step;
        const barH = p * (h*0.32);
        ctx.fillRect(x, mid-barH, Math.max(1, step*0.75), barH*2);
      }

      if (opts && opts.clip){
        const clip = opts.clip;
        const dur = Math.max(0.001, clip.dur || (clip.end || 1));
        const inX = (clip.start / dur) * w;
        const outX = (clip.end / dur) * w;
        ctx.fillStyle = "rgba(255,255,255,.06)";
        ctx.fillRect(0,0,inX,h);
        ctx.fillRect(outX,0,w-outX,h);
        ctx.fillStyle = "rgba(255,204,102,.55)";
        ctx.fillRect(inX, 0, 2*dpr, h);
        ctx.fillRect(outX, 0, 2*dpr, h);
      }

      if (opts && opts.drawHead){
        let pct = 0;
        if (opts.headRatio != null){ pct = +opts.headRatio; }
        else if (opts.cueId){ pct = getCueProgressPct(opts.cueId)/100; }
        pct = clamp(pct, 0, 1);
        ctx.fillStyle = "rgba(46,229,157,.12)";
        ctx.fillRect(0,0,w*pct,h);
        ctx.fillStyle = "rgba(255,255,255,.18)";
        ctx.fillRect(w*pct, 0, 2*dpr, h);
      }
    }

    function startRaf(){
      cancelAnimationFrame(state.raf);
      const loop = ()=>{
        state.raf = requestAnimationFrame(loop);
        try{ updateClock(); }catch(err){ console.warn(err); }
        try{ updateProgressUI(); }catch(err){ console.warn(err); }
      };
      state.raf = requestAnimationFrame(loop);
    }

    function updateClock(){
      const d = new Date();
      const h = String(d.getHours()).padStart(2,'0');
      const m = String(d.getMinutes()).padStart(2,'0');
      const s = String(d.getSeconds()).padStart(2,'0');
      const ms = String(d.getMilliseconds()).padStart(3,'0');
      const __clk = $("#clock"); if (__clk) __clk.textContent = `${h}:${m}:${s}.${ms}`;
    }

    
    function updateProgressUI(){
      // cue cards progress
      try{
        $$('#cueGrid .cue').forEach(el=>{
          const id = el.dataset.cueId;
          const bar = el.querySelector('.progress > i');
          if (!bar) return;
          bar.style.width = getCueProgressPct(id) + "%";
        });
      }catch(err){}

      // now playing area
      const bigProgEl = $("#bigProg");
      const bigWaveEl = $("#bigWave");
      const nowTimeEl = $("#nowTime");

      const focus = state.pausedFocus?.cueId || state.focusCueId;
      const cue = focus ? getCue(focus) : null;
      if (!cue){
        if (bigProgEl) bigProgEl.style.width = "0%";
        if (nowTimeEl) nowTimeEl.textContent = "00:00.000 / 00:00.000";
        if (bigWaveEl) drawWave(bigWaveEl, null, {});
        return;
      }

      const clip = cueClip(cue);
      let cur = clip.start;

      // paused focus keeps its offset
      if (state.pausedFocus && state.pausedFocus.cueId === focus){
        cur = state.pausedFocus.offset;
      }else{
        const node = state.playingNodes[focus];
        if (node){
          const {ctx} = ensureAudio();
          const played = (ctx.currentTime - node.startedAt);
          cur = node.offset + played;
        }
      }

      cur = clamp(cur, clip.start, clip.end);
      const headRatio = clip.playDur <= 0.001 ? 0 : ((cur - clip.start) / clip.playDur);
      const pct = clamp(headRatio * 100, 0, 100);

      if (bigProgEl) bigProgEl.style.width = pct + "%";
      if (nowTimeEl) nowTimeEl.textContent = `${fmtTime(cur)} / ${fmtTime(clip.end)}`;
      if (bigWaveEl) drawWave(bigWaveEl, cue.peaks, {clip, drawHead:true, headRatio});
    }


    // ===== Inline edit helper =====
    function inlineEdit(targetEl, initial, onSave){
      const parent = targetEl.parentElement;
      const old = targetEl;
      const input = document.createElement("input");
      input.className = "ghostInput";
      input.value = initial || "";
      input.addEventListener("keydown", (e)=>{
        if (e.key==="Enter"){
          e.preventDefault();
          input.blur();
        }else if (e.key==="Escape"){
          e.preventDefault();
          parent.replaceChild(old, input);
        }
      });
      input.addEventListener("blur", ()=>{
        const val = (input.value || "").trim();
        parent.replaceChild(old, input);
        if (val && val !== initial){
          onSave(val);
        }
      });
      parent.replaceChild(input, old);
      input.focus();
      input.select();
    }


    // ===== Undo (single step) =====
    let _undo = null; // {label, snap, ts}

    function captureUndoSnapshot(){
      const cues = {};
      for (const [id, c] of Object.entries(state.cues || {})){
        if (!c) continue;
        cues[id] = {...c, audioBuf:null, arrayBuffer:null};
      }
      const snap = {
        projectName: state.projectName,
        dfFadeIn: state.dfFadeIn,
        dfFadeOut: state.dfFadeOut,
        masterVol: state.masterVol,
        mode: state.mode,
        cats: state.cats,
        curCatId: state.curCatId,
        selectedCueId: state.selectedCueId,
        playlists: state.playlists,
        activePlaylistId: state.activePlaylistId,
        ui: state.ui || {},
        cues,
      };
      return JSON.parse(JSON.stringify(snap));
    }

    function pushUndo(label){
      try{
        _undo = {label: label || "上一步", snap: captureUndoSnapshot(), ts: Date.now()};
        updateUndoUI();
      }catch(e){
        console.warn("pushUndo failed", e);
      }
    }

    function updateUndoUI(){
      const btn = $("#btnUndo");
      if (!btn) return;
      btn.disabled = !_undo;
      btn.title = _undo ? `撤销：${_undo.label}（Ctrl+Z）` : "撤销上一步（Ctrl+Z）";
    }

    async function ensureCueAudioFromDB(db, cue){
      try{
        if (!cue || cue.audioBuf) return;
        const key = cue.audioKey || cue.id;
        cue.audioKey = key;
        if (!cue.arrayBuffer){
          const arow = await idbGet(db, "audio", key);
          if (arow && arow.blob){
            cue.arrayBuffer = await arow.blob.arrayBuffer();
            cue.mimeType = cue.mimeType || arow.blob.type || "application/octet-stream";
          }
        }
        if (cue.arrayBuffer){
          ensureAudioUserGesture();
          const {ctx} = ensureAudio();
          cue.audioBuf = await ctx.decodeAudioData(cue.arrayBuffer.slice(0));
          cue.duration = cue.audioBuf.duration;
          cue.peaks = (cue.peaks && cue.peaks.length) ? cue.peaks : computePeaks(cue.audioBuf, 140);

          // normalize trim (seconds; end=0 means to end)
          cue.start = clamp(+cue.start || 0, 0, cue.duration);
          let e = (+cue.end || 0);
          if (e !== 0) e = clamp(e, 0, cue.duration);
          if (e >= cue.duration - 1e-4) e = 0;
          cue.end = e;
        }
      }catch(e){
        console.warn("ensureCueAudioFromDB failed", cue?.fileName, e);
      }
    }

    async function undoLast(){
      if (!_undo){ toast("暂无可撤销"); return; }
      const {label, snap} = _undo;
      _undo = null;
      updateUndoUI();

      // stop runtime audio first
      stopAll({fade:false});

      // cache in-memory audio for fast restore
      const cache = {};
      for (const [id, c] of Object.entries(state.cues || {})){
        if (!c) continue;
        cache[id] = {audioBuf:c.audioBuf, arrayBuffer:c.arrayBuffer, peaks:c.peaks, duration:c.duration, mimeType:c.mimeType};
      }

      // apply snapshot
      state.projectName = snap.projectName || state.projectName;
      state.dfFadeIn = Math.max(0, +snap.dfFadeIn || state.dfFadeIn);
      state.dfFadeOut = Math.max(0, +snap.dfFadeOut || state.dfFadeOut);
      state.masterVol = clamp(+snap.masterVol || state.masterVol, 0, 1);
      state.mode = (snap.mode==="mix" ? "mix":"solo");
      state.cats = snap.cats || [];
      state.curCatId = snap.curCatId || state.cats[0]?.id || null;
      state.selectedCueId = snap.selectedCueId || null;
      state.playlists = snap.playlists || [];
      state.activePlaylistId = snap.activePlaylistId || null;
      state.ui = snap.ui || {};
      state.cues = snap.cues || {};

      // runtime-only
      state.focusCueId = null;
      state.pausedFocus = null;
      state.playingNodes = {};

      ensureDefaultPlaylists();
      applyLayoutUI();

      // restore cached audio for existing cues
      for (const [id, c] of Object.entries(state.cues || {})){
        const cc = cache[id];
        if (cc){
          if (!c.audioBuf && cc.audioBuf) c.audioBuf = cc.audioBuf;
          if (!c.arrayBuffer && cc.arrayBuffer) c.arrayBuffer = cc.arrayBuffer;
          if ((!c.peaks || !c.peaks.length) && cc.peaks) c.peaks = cc.peaks;
          if (!c.duration && cc.duration) c.duration = cc.duration;
          if (!c.mimeType && cc.mimeType) c.mimeType = cc.mimeType;
        }
      }

      // best-effort: reload missing audio from IDB
      try{
        const db = await openDB();
        const arr = Object.values(state.cues || {});
        for (const cue of arr){
          if (cue && !cue.audioBuf){
            await ensureCueAudioFromDB(db, cue);
          }
        }
      }catch(e){}

      persist();
      updateTopbar();
      renderAll();
      toast(`已撤销：${label}`);
    }

    // ===== Queue played status =====
    function ensurePlaylistPlayed(pl){
      if (!pl) return;
      if (!Array.isArray(pl.playedIds)) pl.playedIds = [];
    }
    function clearCuePlayed(pl, cueId){
      if (!pl || !pl.playedIds) return;
      pl.playedIds = pl.playedIds.filter(id=>id!==cueId);
    }
    function markCuePlayed(pl, cueId){
      if (!pl || !cueId) return;
      ensurePlaylistPlayed(pl);
      if (!pl.playedIds.includes(cueId)) pl.playedIds.push(cueId);
    }
    function markCuePlayedIfInQueue(cueId){
      const pl = getActivePlaylist();
      if (!pl || !cueId) return;
      const q = pl.queue || [];
      if (q.includes(cueId)){
        markCuePlayed(pl, cueId);
        persist();
        renderQueue();
      }
    }

    // ===== Categories / Cues ops =====
    function selectCat(catId){
      state.curCatId = catId;
      state.selectedCueId = null;
      persist();
      renderCats();
      renderGrid();
      toast("已切换分类");
    }

    function addCat(name){
      pushUndo("新增分类");
      const order = state.cats.length ? Math.max(...state.cats.map(c=>c.order))+1 : 1;
      const cat = {id: uuid(), name: name || `0${order} 新分类`, order, cues: []};
      state.cats.push(cat);
      state.cats.sort((a,b)=>a.order-b.order);
      if (!state.curCatId) state.curCatId = cat.id;
      persist();
      renderCats();
      renderGrid();
    }

    function deleteCurrentCat(){
      pushUndo("删除分类");
      const catId = state.curCatId;
      if (!catId) return;
      const idx = state.cats.findIndex(c=>c.id===catId);
      if (idx<0) return;
      const cat = state.cats[idx];

      // cleanup cues from state + all playlists
      for (const id of cat.cues){
        const aKey = state.cues[id]?.audioKey;
        stopNode(id, {fade:false});
        delete state.cues[id];
        // 软删除：不立即清理音频数据，便于“撤销”恢复
        // deleteAudioKey(aKey);
        for (const pl of state.playlists){
          pl.queue = pl.queue.filter(q=>q!==id);
        }
      }
      state.cats.splice(idx,1);
      state.curCatId = state.cats[0]?.id || null;
      state.selectedCueId = null;
      if (state.focusCueId && cat.cues.includes(state.focusCueId)){
        state.focusCueId = null;
        updateNowPlaying(null);
      }
      persist();
      renderAll();
      toast("已删除分类（含其音频块）");
    }

    function addCueBlank(){
      const cat = state.cats.find(c=>c.id===state.curCatId);
      if (!cat){ toast("请先选择分类"); return; }
      const cue = makeCue({name:"未命名音频块"});
      state.cues[cue.id] = cue;
      cat.cues.push(cue.id);
      state.selectedCueId = cue.id;
      persist();
      renderGrid();
      toast("已添加音频块");
    }

    function removeCue(cueId){
      pushUndo("删除音频块");
      const cat = state.cats.find(c=>c.id===state.curCatId);
      if (!cat) return;
      const aKey = state.cues[cueId]?.audioKey;
      stopNode(cueId, {fade:false});
      cat.cues = cat.cues.filter(id=>id!==cueId);
      delete state.cues[cueId];
      // 软删除：不立即清理音频数据，便于“撤销”恢复
      // deleteAudioKey(aKey);
      for (const pl of state.playlists){
        pl.queue = pl.queue.filter(id=>id!==cueId);
      }
      if (state.selectedCueId===cueId) state.selectedCueId = null;
      if (state.pausedFocus?.cueId===cueId) state.pausedFocus = null;
      if (state.focusCueId===cueId) state.focusCueId = null;
      persist();
      renderAll();
      toast("已删除音频块");
    }

    function enqueueCue(cueId){
      ensureDefaultPlaylists();
      const pl = getActivePlaylist();
      const q = pl.queue || [];
      if (!q.includes(cueId)){
        pushUndo("加入队列");
        q.push(cueId);
        if (!Array.isArray(pl.queueModes)) pl.queueModes = [];
        pl.queueModes.push("next");
        // 重新加入队列，默认视作“未播放”
        clearCuePlayed(pl, cueId);
        persist();
        renderQueue();
        toast("已加入队列");
      }else{
        toast("队列里已有");
      }
    }

    // ===== Playlists ops =====
    function addPlaylist(){
      ensureDefaultPlaylists();
      const order = state.playlists.length ? Math.max(...state.playlists.map(p=>p.order))+1 : 1;
      const pl = {id: uuid(), name:`列表 ${order}`, order, queue:[], queueModes:[], playedIds:[], settings:{endAction:"next", loopMode:"none", order:"seq"}};
      state.playlists.push(pl);
      state.activePlaylistId = pl.id;
      persist();
      renderPlaylists();
      renderQueue();
      toast("已新增播放列表");
    }

    function setActivePlaylist(plId){
      state.activePlaylistId = plId;
      persist();
      renderPlaylists();
      renderQueue();
      toast("已切换播放列表");
    }

    function deletePlaylist(plId){
      pushUndo("删除播放列表");
      if (state.playlists.length<=1){
        toast("至少保留一个播放列表");
        return;
      }
      const idx = state.playlists.findIndex(p=>p.id===plId);
      if (idx<0) return;
      state.playlists.splice(idx,1);
      if (state.activePlaylistId===plId){
        state.activePlaylistId = state.playlists[0].id;
      }
      persist();
      renderPlaylists();
      renderQueue();
      toast("已删除播放列表");
    }

    // ===== Import / Export =====
    async function importFiles(files){
      const cat = state.cats.find(c=>c.id===state.curCatId);
      if (!cat){ toast("请先创建/选择分类"); return; }
      ensureAudioUserGesture();

      const arr = Array.from(files || []);
      if (!arr.length) return;

      toast(`正在导入 ${arr.length} 个音频...`);
      const importedKeys = [];
      for (const file of arr){
        try{
          const {arrayBuffer, audioBuf} = await decodeFile(file);
          const peaks = computePeaks(audioBuf, 140);
          const cue = makeCue({
            name: file.name.replace(/\.[^/.]+$/, ""),
            fileName: file.name,
            audioBuf,
            arrayBuffer,
            peaks,
            duration: audioBuf.duration
          });
          state.cues[cue.id] = cue;
          cat.cues.push(cue.id);
          cue.audioKey = cue.id;
          cue.mimeType = file.type || "application/octet-stream";
          importedKeys.push(cue.audioKey);
        }catch(e){
          console.error(e);
          toast(`导入失败：${file.name}`);
        }
      }
      persist({audioKeys: importedKeys});
      renderCats();
      renderGrid();
      toast("导入完成");
    }

    function exportProject(){
      const data = serializeProject();
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      const nm = (state.projectName || "audio_console").replace(/[^\w\-一-龥]+/g,"_");
      a.download = `${nm}_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      toast("已导出工程");
    }

    function serializeProject(){
      const cues = {};
      for (const [id, c] of Object.entries(state.cues)){
        cues[id] = {
          ...c,
          audioBuf: null,
          arrayBufferB64: c.arrayBuffer ? arrayBufferToBase64(c.arrayBuffer) : null,
          arrayBuffer: null,
        };
      }
      return {
        v: 2,
        projectName: state.projectName,
        dfFadeIn: state.dfFadeIn,
        dfFadeOut: state.dfFadeOut,
        masterVol: state.masterVol,
        mode: state.mode,
        cats: state.cats,
        cues,
        playlists: state.playlists,
        activePlaylistId: state.activePlaylistId,
        savedAt: Date.now()
      };
    }

    async function importProjectFile(file){
      const text = await file.text();
      const data = JSON.parse(text);
      if (!data || !data.cats || !data.cues){ throw new Error("工程格式不正确"); }

      state.projectName = data.projectName || "import";
      state.dfFadeIn = +data.dfFadeIn || 0.4;
      state.dfFadeOut = +data.dfFadeOut || 0.6;
      state.masterVol = clamp(+data.masterVol || 0.85, 0, 1);
      state.mode = (data.mode==="mix" ? "mix":"solo");
      state.cats = data.cats || [];
      state.cues = {};
      state.curCatId = state.cats[0]?.id || null;
      state.selectedCueId = null;

      state.playlists = data.playlists || [];
      state.activePlaylistId = data.activePlaylistId || null;
      ensureDefaultPlaylists();

      // stop runtime audio
      stopAll({fade:false});

      ensureAudioUserGesture();
      const importedKeys = [];

      for (const [id, c] of Object.entries(data.cues)){
        const cue = {...c};
        cue.id = id;
        cue.audioKey = id;
        cue.state = "ready";
        cue.audioBuf = null;
        cue.arrayBuffer = null;

        if (c.arrayBufferB64){
          try{
            const buf = base64ToArrayBuffer(c.arrayBufferB64);
            cue.arrayBuffer = buf;
            cue.mimeType = cue.mimeType || "audio/wav";
            importedKeys.push(cue.audioKey);
            const {ctx} = ensureAudio();
            cue.audioBuf = await ctx.decodeAudioData(buf.slice(0));
            cue.duration = cue.audioBuf.duration;
            if (!cue.peaks || cue.peaks.length===0){
              cue.peaks = computePeaks(cue.audioBuf, 140);
            }
          }catch(e){
            console.warn("音频重建失败", cue.fileName, e);
          }
        }
        delete cue.arrayBufferB64;
        state.cues[id] = cue;
      }

      if (state.audio){
        state.audio.master.gain.value = state.masterVol;
      }

      persist({audioKeys: importedKeys});
      renderAll();
      toast("工程已导入");
    }

        // ===== Persist (IndexedDB) =====
    const DB_NAME = "p1_style_audio_console_db";
    const DB_VERSION = 2;
    const PROJECT_KEY = "state";

    let _dbPromise = null;
    function openDB(){
      if (_dbPromise) return _dbPromise;
      _dbPromise = new Promise((resolve, reject)=>{
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = ()=>{
          const db = req.result;
          if (!db.objectStoreNames.contains("project")){
            db.createObjectStore("project", {keyPath:"key"});
          }
          if (!db.objectStoreNames.contains("audio")){
            db.createObjectStore("audio", {keyPath:"key"});
          }
          if (!db.objectStoreNames.contains("fs")){
            db.createObjectStore("fs", {keyPath:"key"});
          }
        };
        req.onsuccess = ()=> resolve(req.result);
        req.onerror = ()=> reject(req.error);
      });
      return _dbPromise;
    }

    function idbGet(db, store, key){
      return new Promise((resolve, reject)=>{
        const tx = db.transaction(store, "readonly");
        const st = tx.objectStore(store);
        const req = st.get(key);
        req.onsuccess = ()=> resolve(req.result || null);
        req.onerror = ()=> reject(req.error);
      });
    }
    function idbPut(db, store, value){
      return new Promise((resolve, reject)=>{
        const tx = db.transaction(store, "readwrite");
        const st = tx.objectStore(store);
        const req = st.put(value);
        req.onsuccess = ()=> resolve(true);
        req.onerror = ()=> reject(req.error);
      });
    }
    function idbDel(db, store, key){
      return new Promise((resolve, reject)=>{
        const tx = db.transaction(store, "readwrite");
        const st = tx.objectStore(store);
        const req = st.delete(key);
        req.onsuccess = ()=> resolve(true);
        req.onerror = ()=> reject(req.error);
      });
    }

    function updateSavePill(){
      const el = $("#saveStateText");
      if (!el) return;
      if (state._saving){
        el.textContent = "保存中…";
        return;
      }
      if (state._dirty){
        el.textContent = "未保存";
      }else{
        el.textContent = "已保存";
      }
    }

    let _saveTimer = null;
    async function saveProjectNow(){
      try{
        state._saving = true;
        updateSavePill();

        const db = await openDB();

        // save pending audio
        if (!state._pendingAudioKeys) state._pendingAudioKeys = new Set();
        const pending = Array.from(state._pendingAudioKeys);
        if (pending.length){
          const cueArr = Object.values(state.cues);
          for (const key of pending){
            const cue = cueArr.find(c=>c.audioKey===key);
            if (cue && cue.arrayBuffer){
              const blob = new Blob([cue.arrayBuffer], {type: cue.mimeType || "application/octet-stream"});
              await idbPut(db, "audio", {key, blob});
            }
            state._pendingAudioKeys.delete(key);
          }
        }

        // metadata
        const meta = {
          version: "2.8",
          trimUnit: "sec",
          projectName: state.projectName,
          dfFadeIn: state.dfFadeIn,
          dfFadeOut: state.dfFadeOut,
          masterVol: state.masterVol,
          mode: state.mode,
          cats: state.cats,
          curCatId: state.curCatId,
          selectedCueId: state.selectedCueId,
          playlists: state.playlists,
          activePlaylistId: state.activePlaylistId,
          ui: state.ui || {},
          cues: Object.fromEntries(Object.entries(state.cues).map(([id,c])=>[id,{
            ...c,
            audioBuf: null,
            arrayBuffer: null
          }]))
        };

        await idbPut(db, "project", {key: PROJECT_KEY, data: meta, ts: Date.now()});
        try{ localStorage.setItem("P1_PROJECT_META_JSON", JSON.stringify(meta)); }catch(e){}

        state._dirty = false;
        state._saving = false;
        state._lastSavedAt = Date.now();
        updateSavePill();
        try{ await maybeAutoWriteDisk(); }catch(e){}
      }catch(e){
        console.warn("saveProjectNow failed", e);
        state._saving = false;
        updateSavePill();
      }
    }

    function persist(opts={}){
      state._dirty = true;
      if (!state._pendingAudioKeys) state._pendingAudioKeys = new Set();
      (opts.audioKeys || []).forEach(k=> state._pendingAudioKeys.add(k));
      updateSavePill();

      clearTimeout(_saveTimer);
      _saveTimer = setTimeout(()=> saveProjectNow(), 420);
    }

    async function deleteAudioKey(key){
      try{
        if (!key) return;
        const db = await openDB();
        await idbDel(db, "audio", key);
      }catch(e){
        console.warn("deleteAudioKey failed", e);
      }
    }


    // ===== Disk backup (File System Access API) =====
    function fsSupported(){
      return typeof window.showSaveFilePicker === "function";
    }
    function updateDiskUI(){
      const hint = $("#diskFileHint");
      const tag = $("#btnToggleDiskAuto");
      const has = !!state._diskFileHandle;
      const nm = (state.ui?.diskFileName || (state._diskFileHandle?.name || "")).trim();
      if (hint){
        hint.textContent = has
          ? `已绑定：${nm || "（未命名文件）"} · ${fsSupported() ? "可写入" : "当前环境可能不支持写入"}`
          : `未绑定（推荐 Chrome/Edge；部分浏览器/环境可能不支持直接写入磁盘）`;
      }
      if (tag){
        const on = !!state.ui?.diskAuto;
        tag.textContent = on ? "自动：开" : "自动：关";
        tag.classList.toggle("primary", on);
      }
    }
    async function bindDiskFile(){
      if (!fsSupported()){
        toast("当前浏览器/环境不支持直接写入磁盘（可用“导出工程”下载 .json）");
        return;
      }
      try{
        const nm = ((state.projectName || "audio_console").replace(/[^\w\-一-龥]+/g,"_") || "audio_console") + ".json";
        const handle = await window.showSaveFilePicker({
          suggestedName: nm,
          types: [{ description: "工程文件（JSON）", accept: {"application/json":[".json"]} }]
        });
        if (!handle) return;
        state._diskFileHandle = handle;
        ensureUI();
        state.ui.diskFileName = handle.name || nm;
        state.ui.diskAuto = true;

        // best effort: persist handle in IDB (chromium supports structured clone)
        try{
          const db = await openDB();
          await idbPut(db, "fs", {key:"projectFile", handle, name: state.ui.diskFileName, ts: Date.now()});
        }catch(e){
          console.warn("persist disk handle failed", e);
        }

        updateDiskUI();
        toast("已绑定磁盘工程文件");
      }catch(e){
        // user cancelled or blocked
      }
    }
    async function writeDiskNow(opts={quiet:false}){
      if (!state._diskFileHandle){
        if (!opts.quiet) toast("未绑定磁盘文件");
        return false;
      }
      try{
        const data = serializeProject(); // includes audio in base64 for portability
        const json = JSON.stringify(data, null, 2);
        const writable = await state._diskFileHandle.createWritable();
        await writable.write(json);
        await writable.close();
        ensureUI();
        state.ui._lastDiskWrite = Date.now();
        updateDiskUI();
        if (!opts.quiet) toast("已写入磁盘");
        return true;
      }catch(e){
        console.warn("writeDiskNow failed", e);
        if (!opts.quiet) toast("写入磁盘失败（可能需要授权/或当前环境不支持）");
        return false;
      }
    }
    async function maybeAutoWriteDisk(){
      ensureUI();
      if (!state._diskFileHandle) return;
      if (!state.ui.diskAuto) return;
      const now = Date.now();
      const last = +state.ui._lastDiskWrite || 0;
      if (now - last < 60000) return; // throttle
      await writeDiskNow({quiet:true});
    }
    async function unbindDiskFile(){
      state._diskFileHandle = null;
      ensureUI();
      state.ui.diskFileName = "";
      state.ui.diskAuto = false;
      try{
        const db = await openDB();
        await idbDel(db, "fs", "projectFile");
      }catch(e){}
      updateDiskUI();
      toast("已解除绑定");
    }

    async function load(){
      // try IDB first
      try{
        const db = await openDB();
        const row = await idbGet(db, "project", PROJECT_KEY);

        // load disk handle (best effort)
        try{
          const fsrow = await idbGet(db, "fs", "projectFile");
          if (fsrow && fsrow.handle){
            state._diskFileHandle = fsrow.handle;
            ensureUI();
            state.ui.diskFileName = state.ui.diskFileName || fsrow.name || fsrow.handle.name || "";
          }
        }catch(e){ /* ignore */ }

        if (!row){
          // migrate old localStorage meta if exists
          const raw = localStorage.getItem(STORE_KEY);
          if (raw){
            const data = JSON.parse(raw);
            Object.assign(state, data);
          }else{
            // default
            const defaults = ["01迎宾","02开场","03仪式","04敬酒","05互动","06退场","07救场"];
            state.cats = defaults.map((name,i)=>({id: uuid(), name, order: i+1, cues: []}));
            state.curCatId = state.cats[0]?.id || null;
            state.playlists = [];
            state.activePlaylistId = null;
            state.cues = {};
          }
          ensureUI();
          ensureDefaultPlaylists();
          applyLayoutUI();
          persist();
          return;
        }

        const data = row.data || {};
        Object.assign(state, data);
        ensureUI();

        // apply UI widths
        if (state.ui?.playlistW){
          $("#playlistCard").style.width = state.ui.playlistW + "px";
        }

        // apply UI widths for left/mid
        if (state.ui?.leftW){ $("#colLeft").style.width = state.ui.leftW + "px"; }
        if (state.ui?.midW){ $("#colMid").style.width = state.ui.midW + "px"; }

        // apply collapsed state
        applyLayoutUI();


        // restore audio blobs for each cue
        const cueArr = Object.values(state.cues || {});
        for (const cue of cueArr){
          cue.audioBuf = null;
          cue.arrayBuffer = null;
          const key = cue.audioKey || cue.id;
          cue.audioKey = key;

          const arow = await idbGet(db, "audio", key);
          if (arow && arow.blob){
            const ab = await arow.blob.arrayBuffer();
            cue.arrayBuffer = ab;
            cue.mimeType = cue.mimeType || arow.blob.type || "application/octet-stream";
            try{
              const {ctx} = ensureAudio();
              cue.audioBuf = await ctx.decodeAudioData(ab.slice(0));
              cue.duration = cue.audioBuf.duration;
              // trim unit normalization: v2.2 used ratio (0-1), v2.4 uses seconds (end=0 means to end)
              const trimUnit = (data.trimUnit || "ratio");
              if (trimUnit !== "sec"){
                const s = clamp(+cue.start || 0, 0, 1) * cue.duration;
                let e = (+cue.end || 0);
                e = (e <= 0) ? 0 : (clamp(e, 0, 1) * cue.duration);
                if (e >= cue.duration - 1e-4) e = 0;
                cue.start = s;
                cue.end = e;
              }else{
                cue.start = clamp(+cue.start || 0, 0, cue.duration);
                let e = (+cue.end || 0);
                if (e !== 0) e = clamp(e, 0, cue.duration);
                if (e >= cue.duration - 1e-4) e = 0;
                cue.end = e;
              }
              cue.peaks = cue.peaks || computePeaks(cue.audioBuf, 140);
            }catch(e){
              console.warn("decodeAudioData failed", e);
            }
          }
        }

        // ensure defaults and clean
        ensureDefaultPlaylists();
        state._dirty = false;
        updateSavePill();
      }catch(e){
        console.warn("load failed", e);
        // fallback default
        const defaults = ["01迎宾","02开场","03仪式","04敬酒","05互动","06退场","07救场"];
        state.cats = defaults.map((name,i)=>({id: uuid(), name, order: i+1, cues: []}));
        state.curCatId = state.cats[0]?.id || null;
        state.cues = {};
        ensureDefaultPlaylists();
        state._dirty = false;
        updateSavePill();
      }
    }

    // ===== Base64 helpers =====
    function arrayBufferToBase64(buffer){
      let binary = '';
      const bytes = new Uint8Array(buffer);
      const chunk = 0x8000;
      for (let i=0; i<bytes.length; i+=chunk){
        binary += String.fromCharCode.apply(null, bytes.subarray(i, i+chunk));
      }
      return btoa(binary);
    }
    function base64ToArrayBuffer(b64){
      const binary = atob(b64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for (let i=0;i<len;i++) bytes[i] = binary.charCodeAt(i);
      return bytes.buffer;
    }

    // ===== Drag & Drop =====
    function bindDnDCategory(el){
      el.addEventListener("dragstart", (e)=>{
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", `cat:${el.dataset.catId}`);
      });
      el.addEventListener("dragover", (e)=>{
        e.preventDefault();
        el.classList.add("dropHint");
      });
      el.addEventListener("dragleave", ()=> el.classList.remove("dropHint"));
      el.addEventListener("drop", (e)=>{
        e.preventDefault();
        el.classList.remove("dropHint");
        const data = e.dataTransfer.getData("text/plain") || "";
        if (!data.startsWith("cat:")) return;
        const fromId = data.slice(4);
        const toId = el.dataset.catId;
        if (fromId===toId) return;
        reorderListById(state.cats, fromId, toId);
        state.cats.forEach((c,i)=>c.order=i+1);
        persist();
        renderCats();
      });
    }

    function bindDnDCue(el){
      el.addEventListener("dragstart", (e)=>{
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", `cue:${el.dataset.cueId}`);
      });
      el.addEventListener("dragover", (e)=>{
        e.preventDefault();
        el.classList.add("dropHint");
      });
      el.addEventListener("dragleave", ()=> el.classList.remove("dropHint"));
      el.addEventListener("drop", (e)=>{
        e.preventDefault();
        el.classList.remove("dropHint");
        const data = e.dataTransfer.getData("text/plain") || "";
        if (!data.startsWith("cue:")) return;
        const fromId = data.slice(4);
        const toId = el.dataset.cueId;
        if (fromId===toId) return;
        const cat = state.cats.find(c=>c.id===state.curCatId);
        if (!cat) return;
        reorderArray(cat.cues, fromId, toId);
        persist();
        renderGrid();
      });
    }

    function bindDnDPlaylist(el){
      el.addEventListener("dragstart", (e)=>{
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", `pl:${el.dataset.plId}`);
      });
      el.addEventListener("dragover", (e)=>{ e.preventDefault(); el.classList.add("dropHint"); });
      el.addEventListener("dragleave", ()=> el.classList.remove("dropHint"));
      el.addEventListener("drop", (e)=>{
        e.preventDefault();
        el.classList.remove("dropHint");
        const data = e.dataTransfer.getData("text/plain") || "";
        if (!data.startsWith("pl:")) return;
        const fromId = data.slice(3);
        const toId = el.dataset.plId;
        if (fromId===toId) return;
        reorderListById(state.playlists, fromId, toId);
        state.playlists.forEach((p,i)=>p.order=i+1);
        persist();
        renderPlaylists();
      });
    }

    function bindDnDQueueItem(el){
      el.addEventListener("dragstart", (e)=>{
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", `q:${el.dataset.cueId}`);
      });
      el.addEventListener("dragover", (e)=>{ e.preventDefault(); el.classList.add("dropHint"); });
      el.addEventListener("dragleave", ()=> el.classList.remove("dropHint"));
      el.addEventListener("drop", (e)=>{
        e.preventDefault();
        e.stopPropagation();
        el.classList.remove("dropHint");
        const data = e.dataTransfer.getData("text/plain") || "";
        const toId = el.dataset.cueId;

        const pl = getActivePlaylist();
        const q = pl.queue || [];
        if (!Array.isArray(pl.queueModes)) pl.queueModes = [];
        const qm = pl.queueModes;

        if (data.startsWith("q:")){
          const fromId = data.slice(2);
          if (fromId===toId) return;
          const from = q.indexOf(fromId);
          const to = q.indexOf(toId);
          if (from<0 || to<0) return;
          const [item] = q.splice(from, 1);
          q.splice(to, 0, item);
          const [m] = qm.splice(from, 1);
          qm.splice(to, 0, (m==="loop"||m==="pause"||m==="next") ? m : "next");
          persist();
          renderQueue();
          return;
        }

        if (data.startsWith("cue:")){
          const fromCue = data.slice(4);
          if (!q.includes(fromCue)){
            const idxTo = q.indexOf(toId);
            if (idxTo>=0){
              q.splice(idxTo,0,fromCue);
              qm.splice(idxTo,0,"next");
            }else{
              q.push(fromCue);
              qm.push("next");
            }
            persist();
            renderQueue();
            toast("已拖入队列");
          }
        }
      });
    }

    function handleDropToQueue(e){
      e.preventDefault();
      const data = e.dataTransfer.getData("text/plain") || "";
      const pl = getActivePlaylist();
      const q = pl.queue || [];
      if (!Array.isArray(pl.queueModes)) pl.queueModes = [];
      const qm = pl.queueModes;

      if (data.startsWith("cue:")){
        const cueId = data.slice(4);
        if (!q.includes(cueId)){
          q.push(cueId);
          qm.push("next");
          persist();
          renderQueue();
          toast("已拖入队列");
        }
      }
    }

    function reorderArray(arr, fromId, toId){
      const from = arr.indexOf(fromId);
      const to = arr.indexOf(toId);
      if (from<0 || to<0) return;
      const [item] = arr.splice(from, 1);
      arr.splice(to, 0, item);
    }
    function reorderListById(list, fromId, toId){
      const from = list.findIndex(x=>x.id===fromId);
      const to = list.findIndex(x=>x.id===toId);
      if (from<0 || to<0) return;
      const [item] = list.splice(from,1);
      list.splice(to,0,item);
    }

    // ===== Resizers =====
    function bindHorizontalResizer(splitEl, leftCol, uiKey){
      let dragging = false;
      let startX = 0;
      let startLeft = 0;
      let lastW = 0;
      splitEl.addEventListener("pointerdown", (e)=>{
        dragging = true;
        startX = e.clientX;
        startLeft = leftCol.getBoundingClientRect().width;
        lastW = startLeft;
        splitEl.setPointerCapture(e.pointerId);
      });
      splitEl.addEventListener("pointermove", (e)=>{
        if (!dragging) return;
        const dx = e.clientX - startX;
        const newLeft = clamp(startLeft + dx, 220, window.innerWidth - 420);
        leftCol.style.width = newLeft + "px";
        lastW = newLeft;
      });
      const end = ()=>{
        if (!dragging) return;
        dragging = false;
        if (uiKey){
          state.ui = state.ui || {};
          state.ui[uiKey] = Math.round(lastW || leftCol.getBoundingClientRect().width);
          persist(); // auto save UI
        }
      };
      splitEl.addEventListener("pointerup", end);
      splitEl.addEventListener("pointercancel", end);
    }

    function bindPaneResizer(splitEl, leftPane, containerEl){
      let dragging = false;
      let startX = 0;
      let startW = 0;
      splitEl.addEventListener("pointerdown", (e)=>{
        dragging = true;
        startX = e.clientX;
        startW = leftPane.getBoundingClientRect().width;
        splitEl.setPointerCapture(e.pointerId);
      });
      splitEl.addEventListener("pointermove", (e)=>{
        if (!dragging) return;
        const dx = e.clientX - startX;
        const containerW = containerEl.getBoundingClientRect().width;
        const splitW = splitEl.getBoundingClientRect().width || 14;
        const gap = 24; // two gaps of 12px in flex
        const minLeft = 240;
        const minRight = 260;
        const maxLeft = Math.max(minLeft, containerW - minRight - splitW - gap);

        const next = clamp(startW + dx, minLeft, maxLeft);
        leftPane.style.width = `${next}px`;
        leftPane.style.flex = `0 0 ${next}px`;

        state.ui = state.ui || {};
        state.ui.playlistW = Math.round(next);
        persist(); // auto save UI
      });
      splitEl.addEventListener("pointerup", ()=> dragging = false);
      splitEl.addEventListener("pointercancel", ()=> dragging = false);
    }


    function bindVerticalResizer(splitEl, topEl, bottomEl){
      let dragging = false;
      let startY = 0;
      let startTop = 0;
      splitEl.addEventListener("pointerdown", (e)=>{
        dragging = true;
        startY = e.clientY;
        startTop = topEl.getBoundingClientRect().height;
        splitEl.setPointerCapture(e.pointerId);
      });
      splitEl.addEventListener("pointermove", (e)=>{
        if (!dragging) return;
        const dy = e.clientY - startY;
        const containerH = splitEl.parentElement.getBoundingClientRect().height;
        const minTop = 120;
        const minBottom = 180;
        const newTop = clamp(startTop + dy, minTop, containerH - minBottom - 14);
        topEl.style.flex = "0 0 auto";
        topEl.style.height = newTop + "px";
        bottomEl.style.flex = "1 1 auto";
      });
      splitEl.addEventListener("pointerup", ()=> dragging = false);
      splitEl.addEventListener("pointercancel", ()=> dragging = false);
    }

    // ===== Modals =====
    function openModal(id){ $(id).classList.add("show"); }
    function closeModal(id){ $(id).classList.remove("show"); }

    function openGlobalModal(){
      $("#dfadeIn").value = String(state.dfFadeIn);
      $("#dfadeOut").value = String(state.dfFadeOut);
      $("#projectName").value = state.projectName || "local";
      applyLayoutUI();
      openModal("#globalModal");
    }

    function openPlaylistModal(){
      const pl = getActivePlaylist();
      $("#plModalTitle").textContent = `播放列表设置 · ${pl.name}`;
      $("#plEndAction").value = pl.settings.endAction || "next";
      $("#plLoopMode").value = pl.settings.loopMode || "none";
      $("#plOrder").value = pl.settings.order || "seq";
      openModal("#plModal");
    }

    function savePlaylistModal(){
      const pl = getActivePlaylist();
      pl.settings.endAction = $("#plEndAction").value || "next";
      pl.settings.loopMode = $("#plLoopMode").value || "none";
      pl.settings.order = $("#plOrder").value || "seq";
      persist();
      toast("已保存播放列表设置");
    }

    function openCueModal(cueId){
      const cue = getCue(cueId);
      if (!cue) return;
      state.selectedCueId = cueId;
      persist();

      $("#cueModalTitle").textContent = `单曲设置 · ${cue.name || "未命名"}`;
      $("#cueName").value = cue.name || "";
      $("#cueFileName").value = cue.fileName || "";
      $("#cueVol").value = String(cue.vol ?? 1);
      $("#cueBehavior").value = cue.behavior || "default";
      $("#cueHotkey").value = cue.hotkey || "";
      $("#cueFadeIn").value = String(cue.fadeIn ?? state.dfFadeIn);
      $("#cueFadeOut").value = String(cue.fadeOut ?? state.dfFadeOut);

      const clip = cueClip(cue);
      state.trimDraft.cueId = cueId;
      state.trimDraft.in = clip.start;
      state.trimDraft.out = clip.end;
      state.trimDraft.head = clip.start;

      $("#trimIn").value = String(clip.start.toFixed(2));
      $("#trimOut").value = String(clip.end.toFixed(2));
      $("#trimTime").textContent = `${fmtTime(state.trimDraft.head)} / ${fmtTime(clip.end)}`;

      drawTrimWave();
      openModal("#cueModal");
    }

    function saveCueModal(){
      const cueId = state.selectedCueId;
      const cue = getCue(cueId);
      if (!cue) return;

      cue.name = ($("#cueName").value || cue.name).trim() || cue.name;
      cue.fileName = ($("#cueFileName").value || cue.fileName).trim();
      cue.vol = clamp(+$("#cueVol").value || 1, 0, 2);
      cue.behavior = $("#cueBehavior").value || "default";

      let hk = ($("#cueHotkey").value||"").trim();
      if (hk.length>1) hk = hk[0];
      cue.hotkey = hk ? hk.toUpperCase() : "";

      cue.fadeIn = Math.max(0, +$("#cueFadeIn").value || 0);
      cue.fadeOut = Math.max(0, +$("#cueFadeOut").value || 0);

      // commit trim (IN/OUT) when user clicks “保存”
      const dur = +cue.duration || +(cue.audioBuf?.duration || 0);
      if (dur > 0){
        let inSec = clamp(+$("#trimIn").value || 0, 0, dur);
        let outSec = clamp(+$("#trimOut").value || dur, 0, dur);
        if (outSec <= 0) outSec = dur;
        if (outSec < inSec) outSec = inSec;
        cue.start = inSec;
        cue.end = (Math.abs(outSec - dur) < 1e-3) ? 0 : outSec;
      }

      persist();
      renderGrid();
      renderQueue();

      // if currently focused, apply immediately
      if (state.focusCueId === cueId && state.playingNodes[cueId]){
        stopNode(cueId, {fade:false});
        ensureAudioUserGesture();
        playCue(cueId, {force:true});
      }

      updateNowPlaying(state.focusCueId || state.pausedFocus?.cueId || null, {paused: !!state.pausedFocus});
      toast("已保存单曲设置");
    }

    function applyTrimToCue(){
      const cueId = state.selectedCueId;
      const cue = getCue(cueId);
      if (!cue) return;
      const clip = cueClip(cue);
      const tIn = clamp(+$("#trimIn").value || 0, 0, clip.dur);
      let tOut = clamp(+$("#trimOut").value || clip.dur, 0, clip.dur);
      if (tOut <= 0) tOut = clip.dur;
      if (tOut < tIn) tOut = tIn;

      cue.start = tIn;
      cue.end = (Math.abs(tOut - clip.dur) < 1e-3) ? 0 : tOut;
      persist();
      renderGrid();
      renderQueue();
      // move playhead for preview (not forced play)
      state.trimDraft.head = tIn;
      drawTrimWave();

      // apply immediately if this cue is focused/playing
      if (state.focusCueId === cueId && state.playingNodes[cueId]){
        stopNode(cueId, {fade:false});
        ensureAudioUserGesture();
        playCue(cueId, {force:true});
      }

      toast("裁剪已应用到当前音频块");
    }

    async function renderTrimToNewFile(){
      const cueId = state.selectedCueId;
      const cue = getCue(cueId);
      const cat = state.cats.find(c=>c.id===state.curCatId);
      if (!cue || !cue.audioBuf || !cat) return;

      const clip = cueClip(cue);
      const tIn = clamp(+$("#trimIn").value || 0, 0, clip.dur);
      let tOut = clamp(+$("#trimOut").value || clip.dur, 0, clip.dur);
      if (tOut <= 0) tOut = clip.dur;
      if (tOut < tIn) tOut = tIn;

      const dur = Math.max(0, tOut - tIn);
      if (dur <= 0.02){
        toast("裁剪区间太短");
        return;
      }

      toast("正在生成新文件...");
      try{
        const rendered = await renderAudioSlice(cue.audioBuf, tIn, tOut);
        const wav = encodeWav(rendered);
        const safeName = (cue.name || "trim").replace(/[^\w\-一-龥]+/g,"_");
        const fname = `${safeName}_trim_${Math.round(dur*1000)}ms.wav`;
        downloadArrayBuffer(wav, fname, "audio/wav");

        const peaks = computePeaks(rendered, 140);
        const newCue = makeCue({
          name: `${cue.name || "音频"}（裁剪）`,
          fileName: fname,
          audioBuf: rendered,
          arrayBuffer: wav,
          peaks,
          duration: rendered.duration
        });
        newCue.start = 0;
        newCue.end = 0;

        state.cues[newCue.id] = newCue;
        cat.cues.push(newCue.id);
        newCue.audioKey = newCue.id;
        newCue.mimeType = "audio/wav";

        persist({audioKeys:[newCue.audioKey]});
        renderCats();
        renderGrid();
        toast("已生成并加入当前分类");
      }catch(e){
        console.error(e);
        toast("生成失败：浏览器不支持或内存不足");
      }
    }

    function downloadArrayBuffer(buf, filename, mime){
      const blob = new Blob([buf], {type:mime || "application/octet-stream"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    async function renderAudioSlice(audioBuf, startSec, endSec){
      const sr = audioBuf.sampleRate;
      const ch = audioBuf.numberOfChannels;
      const dur = Math.max(0, endSec - startSec);
      const length = Math.ceil(dur * sr);
      const ctx = new OfflineAudioContext(ch, length, sr);

      const src = ctx.createBufferSource();
      src.buffer = audioBuf;
      src.connect(ctx.destination);
      src.start(0, startSec, dur);
      const rendered = await ctx.startRendering();
      return rendered;
    }

    function encodeWav(audioBuffer){
      const numChannels = audioBuffer.numberOfChannels;
      const sampleRate = audioBuffer.sampleRate;
      const format = 1; // PCM
      const bitDepth = 16;

      const samples = interleave(audioBuffer);
      const bytesPerSample = bitDepth / 8;
      const blockAlign = numChannels * bytesPerSample;
      const buffer = new ArrayBuffer(44 + samples.length * bytesPerSample);
      const view = new DataView(buffer);

      writeString(view, 0, 'RIFF');
      view.setUint32(4, 36 + samples.length * bytesPerSample, true);
      writeString(view, 8, 'WAVE');
      writeString(view, 12, 'fmt ');
      view.setUint32(16, 16, true);
      view.setUint16(20, format, true);
      view.setUint16(22, numChannels, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, sampleRate * blockAlign, true);
      view.setUint16(32, blockAlign, true);
      view.setUint16(34, bitDepth, true);
      writeString(view, 36, 'data');
      view.setUint32(40, samples.length * bytesPerSample, true);

      floatTo16BitPCM(view, 44, samples);
      return buffer;

      function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
      }
      function interleave(input) {
        const length = input.length;
        const result = new Float32Array(length * numChannels);
        let index = 0;
        for (let i=0;i<length;i++){
          for (let c=0;c<numChannels;c++){
            result[index++] = input.getChannelData(c)[i];
          }
        }
        return result;
      }
      function floatTo16BitPCM(output, offset, input) {
        for (let i = 0; i < input.length; i++, offset += 2) {
          let s = Math.max(-1, Math.min(1, input[i]));
          output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
        }
      }
    }

    function drawTrimWave(){
      const cueId = state.selectedCueId;
      const cue = getCue(cueId);
      if (!cue) return;
      const clip = cueClip(cue);
      const inSec = clamp(+$("#trimIn").value || 0, 0, clip.dur);
      let outSec = clamp(+$("#trimOut").value || clip.dur, 0, clip.dur);
      if (outSec <= 0) outSec = clip.dur;
      if (outSec < inSec) outSec = inSec;

      const head = clamp(state.trimDraft.head, inSec, outSec);
      state.trimDraft.head = head;
      $("#trimTime").textContent = `${fmtTime(head)} / ${fmtTime(outSec)}`;

      const canvas = $("#trimWave");
      drawWave(canvas, cue.peaks, {clip:{start:inSec,end:outSec,dur:clip.dur}});
      const dpr = window.devicePixelRatio || 1;
      const ctx = canvas.getContext("2d");
      const w = canvas.width;
      const h = canvas.height;
      const x = (head / Math.max(0.001, clip.dur)) * w;
      ctx.fillStyle = "rgba(46,229,157,.75)";
      ctx.fillRect(x, 0, 2*dpr, h);

      // draggable trim handles
      const inX = (inSec / Math.max(0.001, clip.dur)) * w;
      const outX = (outSec / Math.max(0.001, clip.dur)) * w;
      const rr = 6*dpr;
      ctx.fillStyle = "rgba(255,204,102,.95)";
      ctx.beginPath(); ctx.arc(inX, h*0.5, rr, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(outX, h*0.5, rr, 0, Math.PI*2); ctx.fill();

      const pct = (head - inSec) / Math.max(0.001, (outSec - inSec));
      $("#trimProg").style.width = clamp(pct*100, 0, 100) + "%";
    }

    // ===== Binding =====
    function bindUI(){
      $("#btnPlayPause").onclick = ()=>{ pauseOrResumeFocus(); };
      $("#btnStop").onclick = ()=>{ stopAll({fade:true}); };

      $("#masterVol").oninput = ()=>{
        state.masterVol = clamp(+$("#masterVol").value || 0.85, 0, 1);
        $("#masterVolText").textContent = state.masterVol.toFixed(2);
        ensureAudio();
        state.audio.master.gain.value = state.masterVol;
        persist();
      };

      $("#btnImport").onclick = ()=> $("#fileInput").click();
      $("#btnBrowse").onclick = ()=> $("#fileInput").click();
      $("#fileInput").addEventListener("change", (e)=> importFiles(e.target.files));
      $("#btnExport").onclick = exportProject;
      $("#btnImportProject").onclick = ()=> $("#projectInput").click();
      $("#projectInput").addEventListener("change", async (e)=>{
        const f = e.target.files?.[0];
        if (!f) return;
        try{
          await importProjectFile(f);
        }catch(err){
          console.error(err);
          toast("导入失败：文件格式不正确");
        }
      });

      $("#btnResetStates").onclick = ()=>{
        pushUndo("状态重置");
        for (const c of Object.values(state.cues)){
          if (c) c.state = "ready";
        }
        for (const p of (state.playlists || [])){
          if (p) p.playedIds = [];
        }
        persist();
        renderGrid();
        renderQueue();
        toast("已重置状态");
      };

      const _btnUndo = $("#btnUndo");
      if (_btnUndo) _btnUndo.onclick = ()=> undoLast();
      updateUndoUI();

      $("#btnHelp").onclick = ()=> openModal("#helpModal");
      $("#helpClose").onclick = ()=> closeModal("#helpModal");

      $("#btnGlobalSettings").onclick = openGlobalModal;
      $("#globalClose").onclick = ()=> closeModal("#globalModal");
      $("#globalSave").onclick = ()=>{
        state.dfFadeIn = Math.max(0, +$("#dfadeIn").value || 0);
        state.dfFadeOut = Math.max(0, +$("#dfadeOut").value || 0);
        state.projectName = ($("#projectName").value || "local").trim() || "local";
        updateTopbar();
        persist();
        closeModal("#globalModal");
        toast("已保存工程设置");
      };


      // layout collapse (v2.8)
      const _btnLeft = $("#btnToggleLeftPane");
      const _btnMid  = $("#btnToggleMidPane");
      if (_btnLeft) _btnLeft.onclick = ()=>{ togglePaneCollapse("left"); toast(state.ui.collapseLeft ? "已收起素材库" : "已展开素材库"); };
      if (_btnMid)  _btnMid.onclick  = ()=>{ togglePaneCollapse("mid");  toast(state.ui.collapseMid ? "已收起当前分类" : "已展开当前分类"); };

      // topbar tiny buttons
      const _topLeft = $("#btnTopToggleLeft");
      const _topMid  = $("#btnTopToggleMid");
      if (_topLeft) _topLeft.onclick = ()=>{ togglePaneCollapse("left"); toast(state.ui.collapseLeft ? "已收起素材库" : "已展开素材库"); };
      if (_topMid)  _topMid.onclick  = ()=>{ togglePaneCollapse("mid");  toast(state.ui.collapseMid ? "已收起当前分类" : "已展开当前分类"); };

      // disk backup buttons
      const _bindDisk = $("#btnBindDiskFile");
      const _writeDisk = $("#btnWriteDiskNow");
      const _toggleDiskAuto = $("#btnToggleDiskAuto");
      const _unbindDisk = $("#btnUnbindDiskFile");
      if (_bindDisk) _bindDisk.onclick = bindDiskFile;
      if (_writeDisk) _writeDisk.onclick = ()=> writeDiskNow();
      if (_unbindDisk) _unbindDisk.onclick = unbindDiskFile;
      if (_toggleDiskAuto) _toggleDiskAuto.onclick = ()=>{
        ensureUI();
        state.ui.diskAuto = !state.ui.diskAuto;
        updateDiskUI();
        persist();
      };

      // manual save (optional)
      const _btnSaveNow = $("#btnSaveNow");
      if (_btnSaveNow){
        _btnSaveNow.onclick = async ()=>{
          await saveProjectNow();
          toast("已立即保存到本地");
        };
      }


      // playlist settings
      $("#btnPlaylistSettings").onclick = openPlaylistModal;
      $("#plClose").onclick = ()=> closeModal("#plModal");
      $("#plSave").onclick = ()=>{ savePlaylistModal(); closeModal("#plModal"); };

      // category actions
      $("#btnAddCat").onclick = ()=> addCat();
      $("#btnDelCat").onclick = deleteCurrentCat;
      $("#catSearch").addEventListener("input", renderCats);

      // cue actions
      $("#btnAddCue").onclick = addCueBlank;
      $("#btnMode").onclick = ()=>{
        state.mode = (state.mode==="solo" ? "mix":"solo");
        persist();
        updateTopbar();
        renderGrid();
        toast("模式已切换");
      };

      // right actions
      $("#btnCueSettings").onclick = ()=>{
        if (!state.selectedCueId) return;
        openCueModal(state.selectedCueId);
      };

      // queue nav
      $("#btnPrev").onclick = ()=> playPrevInQueue();
      $("#btnNext").onclick = ()=> playNextInQueue();

      // now playing seek
      $("#bigWave").addEventListener("click", (e)=> handleSeekClick(e, "big"));
      $("#bigProgress").addEventListener("click", (e)=> handleSeekClick(e, "bigbar"));
      bindSeekDrag($("#bigWave"), "big");
      bindSeekDrag($("#bigProgress"), "bigbar");

      // trim modal
      $("#cueClose").onclick = ()=> closeModal("#cueModal");
      $("#cueSave").onclick = ()=>{ saveCueModal(); closeModal("#cueModal"); };
      $("#btnDeleteCue").onclick = ()=>{ if(state.selectedCueId){ removeCue(state.selectedCueId); closeModal("#cueModal"); } };

      $("#btnSetIn").onclick = ()=>{
        $("#trimIn").value = String(state.trimDraft.head.toFixed(2));
        drawTrimWave();
      };
      $("#btnSetOut").onclick = ()=>{
        $("#trimOut").value = String(state.trimDraft.head.toFixed(2));
        drawTrimWave();
      };
      $("#trimIn").addEventListener("change", drawTrimWave);
      $("#trimOut").addEventListener("change", drawTrimWave);

      $("#btnApplyTrim").onclick = applyTrimToCue;
      $("#btnRenderTrim").onclick = renderTrimToNewFile;

      $("#trimWave").addEventListener("click", (e)=> handleSeekClick(e, "trim"));
      $("#trimProgress").addEventListener("click", (e)=> handleSeekClick(e, "trimbar"));
      bindSeekDrag($("#trimWave"), "trim");
      bindSeekDrag($("#trimProgress"), "trimbar");
      bindTrimRangeDrag($("#trimWave"));

      $("#btnPlayFromHead").onclick = ()=>{
        const cueId = state.selectedCueId;
        if (!cueId) return;
        const t = state.trimDraft.head;
        ensureAudioUserGesture();
        playCue(cueId, {offset:t, fadeInOverride:0.02, force:true});
      };
      $("#btnStopFromModal").onclick = ()=> stopAll({fade:true});

      // playlists
      $("#btnAddPlaylist").onclick = addPlaylist;

      // dropzone
      const dz = $("#dropzone");
      dz.addEventListener("dragover", (e)=>{ e.preventDefault(); dz.classList.add("dropHint"); });
      dz.addEventListener("dragleave", ()=> dz.classList.remove("dropHint"));
      dz.addEventListener("drop", (e)=>{
        e.preventDefault();
        dz.classList.remove("dropHint");
        const files = e.dataTransfer.files;
        if (files && files.length) importFiles(files);
      });

      // resizers
      bindHorizontalResizer($("#split1"), $("#colLeft"), "leftW");
      bindHorizontalResizer($("#split2"), $("#colMid"), "midW");
      bindVerticalResizer($("#splitV"), $("#rightTop"), $("#rightBottom"));
      bindPaneResizer($("#splitPQ"), $("#playlistCard"), $("#bottomGrid"));
      // ===== UI: 当前播放区紧凑/展开（释放播放列表与队列高度） =====
      const NOW_COMPACT_KEY = "music_now_compact_v1";
      const SPLIT_TOP_KEY = "music_rightTop_height_v1";
      const P1_HEIGHT_KEY = "music_p1_console_height_v1";
      const P1_FULLSCREEN_KEY = "music_p1_fullscreen_v1";

      const rightTop = $("#rightTop");
      const btnNowCompact = $("#btnNowCompact");
      const setNowCompact = (on, silent=false)=>{
        document.body.dataset.nowCompact = on ? "1" : "0";
        try{ localStorage.setItem(NOW_COMPACT_KEY, on ? "1" : "0"); }catch(e){}
        if (btnNowCompact) btnNowCompact.textContent = on ? "⬇ 展开" : "🗜 紧凑";
        if (!silent) toast(on ? "当前播放区：紧凑 ✅" : "当前播放区：展开 ✅");
      };
      try{
        const saved = localStorage.getItem(NOW_COMPACT_KEY);
        if (saved === "1") setNowCompact(true, true);
        else setNowCompact(false, true);
      }catch(e){ setNowCompact(false, true); }
      btnNowCompact && btnNowCompact.addEventListener("click", ()=> setNowCompact(!(document.body.dataset.nowCompact==="1")));

      // 记住上下分割高度（默认给下方更多空间）
      const applyRightTopHeight = (px, silent=false)=>{
        if (!rightTop) return;
        const n = Number(px);
        if (!Number.isFinite(n) || n <= 0) return;
        rightTop.style.flex = "0 0 auto";
        rightTop.style.height = Math.round(n) + "px";
        try{ localStorage.setItem(SPLIT_TOP_KEY, String(Math.round(n))); }catch(e){}
        if (!silent) toast("已调整：播放区高度 ✅");
      };
      try{
        const savedH = localStorage.getItem(SPLIT_TOP_KEY);
        if (savedH){
          applyRightTopHeight(savedH, true);
        } else {
          // 默认：让播放列表/队列更“高”
          applyRightTopHeight(Math.min(260, Math.max(180, Math.round(window.innerHeight * 0.28))), true);
        }
      }catch(e){}

      // 当用户拖动上下分割条时，实时写入本地
      const splitV = $("#splitV");
      if (splitV && rightTop){
        splitV.addEventListener("pointerup", ()=>{
          try{ applyRightTopHeight(rightTop.getBoundingClientRect().height, true); }catch(e){}
        });
      }

      // ===== UI: P1 播控台高度滑块 + 满屏 =====
      if (document.body.dataset.p1UiBound !== "1"){
      const p1Bar = $("#p1SizeBar");
      const p1Range = $("#p1HeightRange");
      const p1Label = $("#p1HeightLabel");
      const btnP1Full = $("#btnP1Full");
      const btnP1ResetH = $("#btnP1ResetH");
      const p1Frame = $("#p1ConsoleFrame");

      const refreshP1RangeBounds = ()=>{
        if (!p1Range) return;
        const maxH = Math.max(520, Math.floor(window.innerHeight * 0.95));
        p1Range.max = String(maxH);
      };

      const setP1Height = (px, silent=false)=>{
        if (!p1Frame) return;
        const n = Number(px);
        if (!Number.isFinite(n) || n < 260) return;
        p1Frame.style.height = Math.round(n) + "px";
        document.documentElement.style.setProperty("--p1ConsoleH", Math.round(n) + "px");
        if (p1Range) p1Range.value = String(Math.round(n));
        if (p1Label) p1Label.textContent = Math.round(n) + "px";
        try{ localStorage.setItem(P1_HEIGHT_KEY, String(Math.round(n))); }catch(e){}
        if (!silent) toast("P1 高度已更新 ✅");
      };

      const resetP1Height = (silent=false)=>{
        if (!p1Frame) return;
        p1Frame.style.height = "";
        document.documentElement.style.removeProperty("--p1ConsoleH");
        const fallback = Math.min(980, Math.floor(window.innerHeight * 0.86));
        if (p1Range) p1Range.value = String(fallback);
        if (p1Label) p1Label.textContent = "auto";
        try{ localStorage.removeItem(P1_HEIGHT_KEY); }catch(e){}
        if (!silent) toast("P1 高度已重置 ✅");
      };

      const setP1Fullscreen = (on, silent=false)=>{
        document.body.dataset.p1Fullscreen = on ? "1" : "0";
        try{ localStorage.setItem(P1_FULLSCREEN_KEY, on ? "1" : "0"); }catch(e){}
        if (btnP1Full) btnP1Full.textContent = on ? "退出满屏" : "满屏";
        if (!silent) toast(on ? "P1：满屏 ✅" : "P1：退出满屏 ✅");
      };

      refreshP1RangeBounds();
      window.addEventListener("resize", ()=>{
        refreshP1RangeBounds();
        // 若用户用过自定义高度，保持相对可用
        try{
          const saved = localStorage.getItem(P1_HEIGHT_KEY);
          if (saved) setP1Height(saved, true);
          else {
            if (p1Label && !document.body.dataset.p1Fullscreen) p1Label.textContent = "auto";
          }
        }catch(e){}
      });

      try{
        const saved = localStorage.getItem(P1_HEIGHT_KEY);
        if (saved){
          setP1Height(saved, true);
        } else {
          if (p1Label) p1Label.textContent = "auto";
          if (p1Range) p1Range.value = String(Math.min(980, Math.floor(window.innerHeight * 0.86)));
        }
      }catch(e){}

      // 仅在 P1 模式时显示并更新标签（CSS 控制显示，JS补充更新）
      const updateP1BarLabel = ()=>{
        if (!p1Label) return;
        if (document.body.dataset.p1Fullscreen === "1"){ p1Label.textContent = "100%"; return; }
        if (p1Frame && p1Frame.style.height) p1Label.textContent = p1Frame.style.height;
        else p1Label.textContent = "auto";
      };
      updateP1BarLabel();

      p1Range && p1Range.addEventListener("input", ()=> setP1Height(p1Range.value, true));
      p1Range && p1Range.addEventListener("change", ()=> setP1Height(p1Range.value, false));
      btnP1ResetH && btnP1ResetH.addEventListener("click", ()=> resetP1Height(false));
      btnP1Full && btnP1Full.addEventListener("click", ()=> setP1Fullscreen(!(document.body.dataset.p1Fullscreen==="1")));

      // ESC 退出满屏
      window.addEventListener("keydown", (e)=>{
        if (e.key === "Escape" && document.body.dataset.p1Fullscreen === "1"){
          setP1Fullscreen(false, true);
        }
      });


      // 与“播放器模式”切换互斥：离开 P1 时强制退出满屏，并同步按钮文字
      const btnMusicBuiltin = $("#btnMusicBuiltin");
      const btnMusicP1 = $("#btnMusicP1");
      const syncP1FullBtn = ()=>{
        if (!btnP1Full) return;
        btnP1Full.textContent = (document.body.dataset.p1Fullscreen === "1") ? "退出满屏" : "满屏";
      };
      btnMusicBuiltin && btnMusicBuiltin.addEventListener("click", ()=>{
        if (document.body.dataset.p1Fullscreen === "1") setP1Fullscreen(false, true);
        syncP1FullBtn();
      });
      btnMusicP1 && btnMusicP1.addEventListener("click", ()=>{
        syncP1FullBtn();
        updateP1BarLabel();
      });
      syncP1FullBtn();

      } // end P1 UI bindings guard



      // hotkeys
      window.addEventListener("keydown", (e)=>{
        if (isTextInputFocused()) return;

        if (e.key === " "){
          e.preventDefault();
          pauseOrResumeFocus();
          return;
        }
        if (e.key.toLowerCase() === "s"){
          e.preventDefault();
          stopAll({fade:true});
          return;
        }
        if (e.key.toLowerCase() === "i"){
          e.preventDefault();
          $("#fileInput").click();
          return;
        }
        if (e.key.toLowerCase() === "e"){
          e.preventDefault();
          exportProject();
          return;
        }
        if (e.key.toLowerCase() === "r"){
          e.preventDefault();
          for (const c of Object.values(state.cues)){ if (c) c.state = "ready"; }
          persist();
          renderGrid();
          toast("已重置状态");
          return;
        }
        if (e.key === "?"){
          e.preventDefault();
          openModal("#helpModal");
          return;
        }
        // 司仪宝/键盘：←上一曲 →下一曲（兼容 Alt+← / Alt+→）
        if (e.key === "ArrowLeft" || (e.altKey && e.key === "ArrowLeft")){
          e.preventDefault();
          playPrevInQueue();
          return;
        }
        if (e.key === "ArrowRight" || (e.altKey && e.key === "ArrowRight")){
          e.preventDefault();
          playNextInQueue();
          return;
        }

        // 键盘：↑音量+ ↓音量-
        if (e.key === "ArrowUp"){
          e.preventDefault();
          const v = clamp(state.masterVol + 0.05, 0, 1);
          $("#masterVol").value = v;
          $("#masterVol").dispatchEvent(new Event("input"));
          toast(`音量 ${v.toFixed(2)}`);
          return;
        }
        if (e.key === "ArrowDown"){
          e.preventDefault();
          const v = clamp(state.masterVol - 0.05, 0, 1);
          $("#masterVol").value = v;
          $("#masterVol").dispatchEvent(new Event("input"));
          toast(`音量 ${v.toFixed(2)}`);
          return;
        }

        // external remotes / multimedia keys
        const k2 = e.key || "";
        if (k2 === "MediaTrackNext" || k2 === "MediaNextTrack" || k2 === "PageDown"){
          e.preventDefault();
          playNextInQueue();
          return;
        }
        if (k2 === "MediaTrackPrevious" || k2 === "MediaPreviousTrack" || k2 === "PageUp"){
          e.preventDefault();
          playPrevInQueue();
          return;
        }
        // per-cue hotkey
        const k = (e.key || "").toUpperCase();
        if (k.length===1){
          const hit = Object.values(state.cues).find(c => (c?.hotkey || "").toUpperCase() === k);
          if (hit){
            e.preventDefault();
            ensureAudioUserGesture();
            playCue(hit.id, {force:true});
            return;
          }
        }
      });

      // close modal on backdrop click
      ["#globalModal","#cueModal","#helpModal","#plModal"].forEach(id=>{
        const modal = $(id);
        if (!modal) return;
        modal.addEventListener("click", (e)=>{ if (e.target === modal) closeModal(id); });
      });
    }

    function isTextInputFocused(){
      const el = document.activeElement;
      if (!el) return false;
      const tag = el.tagName.toLowerCase();
      return tag === "input" || tag === "textarea" || tag === "select" || el.isContentEditable;
    }

    
    function handleSeekAt(el, clientX, kind){
      const focus = state.pausedFocus?.cueId || state.focusCueId || state.selectedCueId;
      const cueId = (kind.startsWith("trim")) ? state.selectedCueId : focus;
      if (!cueId) return;
      const cue = getCue(cueId);
      if (!cue) return;
      const clip = cueClip(cue);

      const rect = el.getBoundingClientRect();
      const ratio = clamp((clientX - rect.left) / rect.width, 0, 1);

      if (kind.startsWith("trim")){
        const inSec = clamp(+$("#trimIn").value || 0, 0, clip.dur);
        let outSec = clamp(+$("#trimOut").value || clip.dur, 0, clip.dur);
        if (outSec<=0) outSec = clip.dur;
        if (outSec < inSec) outSec = inSec;
        const target = inSec + ratio * Math.max(0.001, (outSec - inSec));
        state.trimDraft.head = clamp(target, inSec, outSec);
        drawTrimWave();
        return;
      }

      const target = clip.start + ratio * clip.playDur;
      seekTo(cueId, target);
    }

    function bindSeekDrag(el, kind){
      let dragging = false;
      let last = 0;
      el.addEventListener("pointerdown", (e)=>{
        if (e.pointerType === "mouse" && e.button !== 0) return;
        dragging = true;
        last = 0;
        try{ el.setPointerCapture(e.pointerId); }catch(_){}
        handleSeekAt(el, e.clientX, kind);
      });
      el.addEventListener("pointermove", (e)=>{
        if (!dragging) return;
        const now = performance.now();
        if (now - last < 90) return; // throttle for realtime preview
        last = now;
        handleSeekAt(el, e.clientX, kind);
      });
      const end = ()=>{ dragging = false; };
      el.addEventListener("pointerup", end);
      el.addEventListener("pointercancel", end);
      el.addEventListener("lostpointercapture", end);
    }


    function bindTrimRangeDrag(canvas){
      if (!canvas) return;
      let mode = null; // "in" | "out" | "move"
      let startX = 0;
      let origIn = 0;
      let origOut = 0;
      let fullDur = 0;
      const tol = 10; // px hit area

      function getRange(){
        const cueId = state.selectedCueId;
        const cue = getCue(cueId);
        if (!cue) return null;
        const clip = cueClip(cue);
        const inSec = clamp(+$("#trimIn").value || 0, 0, clip.dur);
        let outSec = clamp(+$("#trimOut").value || clip.dur, 0, clip.dur);
        if (outSec <= 0) outSec = clip.dur;
        if (outSec < inSec) outSec = inSec;
        return {clip, inSec, outSec};
      }

      function hitTest(x, w, inSec, outSec, dur){
        const inX = (inSec / Math.max(0.001, dur)) * w;
        const outX = (outSec / Math.max(0.001, dur)) * w;
        if (Math.abs(x - inX) <= tol) return "in";
        if (Math.abs(x - outX) <= tol) return "out";
        if (x > inX && x < outX) return "move";
        return null;
      }

      canvas.addEventListener("pointerdown", (e)=>{
        if (e.pointerType === "mouse" && e.button !== 0) return;
        const r = getRange();
        if (!r) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const m = hitTest(x, rect.width, r.inSec, r.outSec, r.clip.dur);
        if (!m) return; // allow normal seek drag
        mode = m;
        startX = x;
        origIn = r.inSec;
        origOut = r.outSec;
        fullDur = r.clip.dur;

        e.preventDefault();
        e.stopPropagation();
        try{ canvas.setPointerCapture(e.pointerId); }catch(_){}
      }, true);

      canvas.addEventListener("pointermove", (e)=>{
        const r = getRange();
        if (!r) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;

        if (!mode){
          const m = hitTest(x, rect.width, r.inSec, r.outSec, r.clip.dur);
          canvas.style.cursor = (m==="in" || m==="out") ? "ew-resize" : (m==="move" ? "grab" : "crosshair");
          return;
        }

        const dx = x - startX;
        const delta = (dx / Math.max(1, rect.width)) * fullDur;

        let inSec = origIn;
        let outSec = origOut;

        if (mode === "in"){
          inSec = clamp(origIn + delta, 0, outSec - 0.01);
        }else if (mode === "out"){
          outSec = clamp(origOut + delta, inSec + 0.01, fullDur);
        }else if (mode === "move"){
          const len = origOut - origIn;
          inSec = origIn + delta;
          outSec = origOut + delta;
          if (inSec < 0){ inSec = 0; outSec = len; }
          if (outSec > fullDur){ outSec = fullDur; inSec = fullDur - len; }
          inSec = clamp(inSec, 0, fullDur);
          outSec = clamp(outSec, 0, fullDur);
        }

        $("#trimIn").value = String(inSec.toFixed(2));
        $("#trimOut").value = String(outSec.toFixed(2));
        state.trimDraft.head = clamp(state.trimDraft.head, inSec, outSec);
        drawTrimWave();

        e.preventDefault();
        e.stopPropagation();
      }, true);

      function end(){
        mode = null;
      }
      canvas.addEventListener("pointerup", end, true);
      canvas.addEventListener("pointercancel", end, true);
      canvas.addEventListener("lostpointercapture", end, true);
    }

function handleSeekClick(e, kind){
      handleSeekAt(e.currentTarget, e.clientX, kind);
    }

    function playNextInQueue(){
      const pl = getActivePlaylist();
      const q = pl.queue || [];
      if (!q.length) return;
      const cur = state.focusCueId || state.pausedFocus?.cueId;
      // “下一曲”视为切歌：把当前曲标记为已播放（队列内）
      if (cur && cur !== null){ markCuePlayedIfInQueue(cur); }
      let next = null;
      if (pl.settings.order === "shuffle"){
        next = q.length===1 ? q[0] : q[Math.floor(Math.random()*q.length)];
      }else{
        const idx = cur ? q.indexOf(cur) : -1;
        next = (idx>=0 && idx<q.length-1) ? q[idx+1] : q[0];
      }
      ensureAudioUserGesture();
      playCue(next, {force:true});
    }

    function playPrevInQueue(){
      const pl = getActivePlaylist();
      const q = pl.queue || [];
      if (!q.length) return;
      const cur = state.focusCueId || state.pausedFocus?.cueId;
      // “上一曲”视为切歌：把当前曲标记为已播放（队列内）
      if (cur && cur !== null){ markCuePlayedIfInQueue(cur); }
      let prev = null;
      if (pl.settings.order === "shuffle"){
        prev = q.length===1 ? q[0] : q[Math.floor(Math.random()*q.length)];
      }else{
        const idx = cur ? q.indexOf(cur) : -1;
        prev = (idx>0) ? q[idx-1] : q[q.length-1];
      }
      ensureAudioUserGesture();
      playCue(prev, {force:true});
    }

    
    

    // ===== Mobile PQ (playlist/queue) switch + swipe =====
    function initPqMobile(){
      const seg = $("#pqSeg");
      const grid = $("#bottomGrid");
      const rightBottom = $("#rightBottom");
      if(!seg || !grid) return;

      const btns = Array.from(seg.querySelectorAll(".pqbtn"));
      const KEY = "p1_pq_view";

      function setView(k, saveIt=true){
        const view = (k === "q") ? "q" : "pl";
        grid.classList.toggle("show-pl", view === "pl");
        grid.classList.toggle("show-q", view === "q");
        btns.forEach(b => b.classList.toggle("on", b.dataset.k === view));
        if(saveIt){
          try{ localStorage.setItem(KEY, view); }catch(e){}
        }
        return view;
      }

      // initial
      let cur = "pl";
      try{ cur = localStorage.getItem(KEY) || "pl"; }catch(e){}
      cur = (cur === "q") ? "q" : "pl";
      setView(cur, false);

      seg.addEventListener("click", (e)=>{
        const b = e.target.closest(".pqbtn");
        if(!b) return;
        setView(b.dataset.k);
      });

      // swipe on the lower area (avoid interfering with vertical scroll)
      let sx=0, sy=0, st=0;
      const touchEl = rightBottom || grid;
      touchEl.addEventListener("touchstart", (e)=>{
        const t = e.touches && e.touches[0];
        if(!t) return;
        sx = t.clientX; sy = t.clientY; st = Date.now();
      }, {passive:true});

      touchEl.addEventListener("touchend", (e)=>{
        // only enable on narrow screens
        if(window.innerWidth > 980) return;

        const t = e.changedTouches && e.changedTouches[0];
        if(!t) return;
        const dx = t.clientX - sx;
        const dy = t.clientY - sy;
        const dt = Date.now() - st;

        if(dt > 650) return;
        if(Math.abs(dx) < 55) return;
        if(Math.abs(dx) < Math.abs(dy) * 1.15) return;

        const curView = grid.classList.contains("show-q") ? "q" : "pl";
        const next = (dx < 0) ? (curView === "pl" ? "q" : "pl") : (curView === "q" ? "pl" : "q");
        setView(next);
      }, {passive:true});
    }

// ===== Init =====
    async function bootstrap(){
      await load();
      ensureDefaultPlaylists();
      updateTopbar();
      renderAll();
      bindUI();
      initPqMobile();
      applyLayoutUI();
      updateDiskUI();
      startRaf();
      updateSavePill();
      // safety autosave: flush dirty state periodically
      setInterval(()=>{ if (state._dirty && !state._saving) saveProjectNow(); }, 8000);
      toast("v2.8 已载入");
    }

    // start
    bootstrap();

    // ===== UVR Bridge (parent MusicSystem uses this to access full CUE library) =====
    window.__UVR_P1__ = {
      async listAllCues(){
        const out = [];
        const cats = Array.isArray(state.cats) ? state.cats : [];
        const cues = state.cues || {};
        const seen = new Set();
        for (const cat of cats){
          const cn = cat?.name || "未分类";
          const ids = Array.isArray(cat?.cues) ? cat.cues : [];
          for (const id of ids){
            const c = cues[id];
            if (!c || seen.has(id)) continue;
            seen.add(id);
            out.push({ id:c.id, name:(c.name||c.fileName||"未命名"), catId:cat.id, catName:cn, duration:(c.duration||0) });
          }
        }
        // include orphan cues (not in any cat)
        for (const [id, c] of Object.entries(cues)){
          if (!c || seen.has(id)) continue;
          out.push({ id:c.id, name:(c.name||c.fileName||"未命名"), catId:"", catName:"未分类", duration:(c.duration||0) });
        }
        return out;
      },

      getNowCueId(){
        return state.focusCueId || (state.pausedFocus && state.pausedFocus.cueId) || state.selectedCueId || null;
      },

      async getCueBlob(cueId){
        const cue = state.cues && state.cues[cueId];
        if (!cue) throw new Error("cue not found");
        const key = cue.audioKey || cue.id || cueId;
        const db = await openDB();
        const row = await idbGet(db, "audio", key);
        if (row && row.blob) return row.blob;
        if (cue.arrayBuffer) return new Blob([cue.arrayBuffer], {type: cue.mimeType || "audio/wav"});
        throw new Error("audio blob missing");
      },

      async importBlobAsCue(blob, {name="", fileName="", catName="UVR 输出"}={}){
        if (!(blob instanceof Blob)) throw new Error("blob required");
        const cn = String(catName || "UVR 输出");
        let cat = (state.cats||[]).find(c=>c && c.name===cn);
        if (!cat){
          addCat(cn);
          cat = (state.cats||[]).find(c=>c && c.name===cn);
        }
        if (!cat) throw new Error("cat create failed");

        const ab = await blob.arrayBuffer();
        const cue = makeCue({
          name: name || fileName || "UVR 输出",
          fileName: fileName || ((name||"UVR输出") + ".wav"),
          audioBuf: null,
          arrayBuffer: ab,
          peaks: [],
          duration: 0
        });
        cue.audioKey = cue.id;
        cue.mimeType = blob.type || "audio/wav";
        state.cues[cue.id] = cue;
        cat.cues.push(cue.id);
        persist({audioKeys:[cue.audioKey]});
        try{ renderCats(); renderGrid(); renderQueue(); }catch(e){}
        return cue.id;
      },

      async enqueueCue(cueId){
        enqueueCue(cueId);
        return true;
      },

      async playCue(cueId){
        ensureAudioUserGesture();
        playCue(cueId, {force:true});
        persist();
        try{ renderAll(); }catch(e){}
        return true;
      }
    };


  
    // ===== KTV Bridge (host lyrics sync) =====
    window.__ktvBridge = {
      getPlayback(){
        try{
          const cueId = (state.pausedFocus && state.pausedFocus.cueId) ? state.pausedFocus.cueId : state.focusCueId;
          if (!cueId) return {mode:"p1", playing:false, t:0, dur:0, cueId:null, title:""};
          const cue = getCue(cueId);
          const clip = cue ? cueClip(cue) : {start:0, end:0};
          let t = clip.start || 0;
          let playing = false;

          if (state.pausedFocus && state.pausedFocus.cueId === cueId){
            t = Number(state.pausedFocus.offset);
            if (!Number.isFinite(t)) t = clip.start || 0;
            playing = false;
          }else{
            const node = state.playingNodes[cueId];
            if (node){
              const {ctx} = ensureAudio();
              t = node.offset + (ctx.currentTime - node.startedAt);
              playing = true;
            }else{
              t = clip.start || 0;
              playing = false;
            }
          }

          t = clamp(t, clip.start, clip.end);
          const dur = (cue && cue.audioBuf && cue.audioBuf.duration) ? cue.audioBuf.duration : (cue && cue.duration ? cue.duration : (clip.end || 0));
          const titleEl = document.getElementById("nowTitle");
          const title = (titleEl && titleEl.textContent) || (cue && (cue.name || cue.title || cue.fileName)) || "";
          return {mode:"p1", playing, t, dur, cueId, title};
        }catch(e){
          return {mode:"p1", playing:false, t:0, dur:0, cueId:null, title:""};
        }
      },

      seekFocus(sec){
        try{
          const cueId = (state.pausedFocus && state.pausedFocus.cueId) ? state.pausedFocus.cueId : state.focusCueId;
          if (!cueId) return false;
          seekTo(cueId, Number(sec)||0);
          return true;
        }catch(e){
          return false;
        }
      }
    };


</script>
</body>
</html>

  </template>


<script id="__mobileUIPatch_v2633_m1">
(() => {
  const LS = { toc: "__ui_toc_open__", music: "__ui_music_view__" };
  const qs = (s, r=document) => r.querySelector(s);
  const ce = (t, cls, txt) => {
    const el = document.createElement(t);
    if (cls) el.className = cls;
    if (txt !== undefined) el.textContent = txt;
    return el;
  };

  function setupTocDrawer(){
    const aside = qs(".aside");
    const tools = qs(".tools");
    if(!aside || !tools) return;

    if(qs("#btnToc")) return;

    const btn = ce("button", "btn", "📚 目录");
    btn.id = "btnToc";
    btn.type = "button";
    btn.style.whiteSpace = "nowrap";
    tools.prepend(btn);

    let backdrop = qs("#tocBackdrop");
    if(!backdrop){
      backdrop = ce("div");
      backdrop.id = "tocBackdrop";
      document.body.appendChild(backdrop);
    }

    const close = () => {
      document.body.classList.remove("tocOpen");
      backdrop.classList.remove("show");
      try{ localStorage.setItem(LS.toc, "0"); }catch(e){}
    };
    const open = () => {
      document.body.classList.add("tocOpen");
      backdrop.classList.add("show");
      try{ localStorage.setItem(LS.toc, "1"); }catch(e){}
    };

    btn.addEventListener("click", () => {
      const isOpen = document.body.classList.toggle("tocOpen");
      backdrop.classList.toggle("show", isOpen);
      try{ localStorage.setItem(LS.toc, isOpen ? "1" : "0"); }catch(e){}
    });

    backdrop.addEventListener("click", close);
    document.addEventListener("keydown", (e) => { if(e.key === "Escape") close(); });

    aside.addEventListener("click", (e) => {
      const a = e.target.closest("a");
      if(!a) return;
      if(window.matchMedia("(max-width: 900px)").matches) close();
    });

    // restore on mobile only
    try{
      const want = localStorage.getItem(LS.toc) === "1";
      if(want && window.matchMedia("(max-width: 900px)").matches) open();
    }catch(e){}
  }

  function setupMusicMobileTabs(){
    const kgGrid = document.getElementById("kgGrid");
    if(!kgGrid) return;

    const lib = document.getElementById("kgColLib");
    const pl  = document.getElementById("kgColPl");
    const q   = document.getElementById("kgColQueue");
    if(!lib || !pl || !q) return;

    if(document.getElementById("kgMobileSeg")) return;

    const bar = ce("div", "kgMobileSeg");
    bar.id = "kgMobileSeg";
    bar.innerHTML = `
      <div class="seg" role="tablist" aria-label="音乐系统切换">
        <button class="segbtn" data-k="lib" type="button" role="tab">素材库</button>
        <button class="segbtn" data-k="pl" type="button" role="tab">播放列表</button>
        <button class="segbtn" data-k="queue" type="button" role="tab">当前队列</button>
      </div>
      <span class="mini" id="kgMobileHint">手机/平板：用这里切换面板（支持左右滑动）</span>
    `;

    kgGrid.parentElement?.insertBefore(bar, kgGrid);

    const mqPortrait  = window.matchMedia("(max-width: 1100px) and (orientation: portrait)");
    const mqLandscape = window.matchMedia("(max-width: 1100px) and (orientation: landscape)");
    const hint = bar.querySelector("#kgMobileHint");

    const KEYS_PORTRAIT = ["lib","pl","queue"];
    const KEYS_LANDSCAPE = ["pl","queue"]; // right panel only (library always visible)

    const getSaved = () => { try{ return (localStorage.getItem(LS.music) || "queue"); }catch(e){ return "queue"; } };
    const setSaved = (k) => { try{ localStorage.setItem(LS.music, k); }catch(e){} };

    const btnLib = bar.querySelector('[data-k="lib"]');
    const btnPl  = bar.querySelector('[data-k="pl"]');
    const btnQ   = bar.querySelector('[data-k="queue"]');

    function normalizeKey(k){
      k = (k || "queue");
      const isP = mqPortrait.matches;
      const isL = mqLandscape.matches;
      if(isL){
        return (k === "pl") ? "pl" : "queue";
      }
      if(isP){
        return KEYS_PORTRAIT.includes(k) ? k : "queue";
      }
      return k;
    }

    function setBarMode(){
      const isP = mqPortrait.matches;
      const isL = mqLandscape.matches;
      // In landscape, library is always visible, so hide the "素材库" button to save space.
      if(btnLib) btnLib.style.display = isL ? "none" : "";
      if(hint){
        hint.textContent = isL
          ? "横屏：左库 + 右侧（列表/队列）切换（支持左右滑动）"
          : "竖屏：单面板切换（支持左右滑动）";
      }
    }

    function apply(k){
      const isP = mqPortrait.matches;
      const isL = mqLandscape.matches;

      // Desktop / wide screens: show all columns normally.
      if(!isP && !isL){
        kgGrid.classList.remove("mobilePortrait","mobileLandscape");
        [lib,pl,q].forEach(el => el.classList.remove("show"));
        bar.querySelectorAll(".segbtn").forEach(b => b.classList.remove("on"));
        return;
      }

      k = normalizeKey(k);

      if(isP){
        kgGrid.classList.add("mobilePortrait");
        kgGrid.classList.remove("mobileLandscape");
        [lib,pl,q].forEach(el => el.classList.remove("show"));
        (k==="lib" ? lib : k==="pl" ? pl : q).classList.add("show");
      }else{
        kgGrid.classList.add("mobileLandscape");
        kgGrid.classList.remove("mobilePortrait");
        // library is always visible in landscape, only switch right panel
        [pl,q].forEach(el => el.classList.remove("show"));
        (k==="pl" ? pl : q).classList.add("show");
      }

      // active button
      bar.querySelectorAll(".segbtn").forEach(b => {
        const kk = b.dataset.k;
        if(isL && kk === "lib"){ b.classList.remove("on"); return; }
        b.classList.toggle("on", kk === k);
      });

      setSaved(k);
      return k;
    }

    function refresh(){
      setBarMode();
      apply(getSaved());
    }

    // Button click
    bar.addEventListener("click", (e) => {
      const b = e.target.closest(".segbtn");
      if(!b) return;
      apply(b.dataset.k);
    });

    // Swipe gesture (left/right)
    let sx=0, sy=0, st=0;
    kgGrid.addEventListener("touchstart", (e)=>{
      const t = e.touches && e.touches[0];
      if(!t) return;
      sx = t.clientX; sy = t.clientY; st = Date.now();
    }, {passive:true});

    kgGrid.addEventListener("touchend", (e)=>{
      const t = e.changedTouches && e.changedTouches[0];
      if(!t) return;
      const dx = t.clientX - sx;
      const dy = t.clientY - sy;
      const dt = Date.now() - st;

      // Horizontal swipe only: not too slow, not too vertical
      if(dt > 650) return;
      if(Math.abs(dx) < 55) return;
      if(Math.abs(dx) < Math.abs(dy) * 1.15) return;

      const isP = mqPortrait.matches;
      const isL = mqLandscape.matches;
      if(!isP && !isL) return;

      const cur = normalizeKey(getSaved());
      const keys = isL ? KEYS_LANDSCAPE : KEYS_PORTRAIT;
      let i = keys.indexOf(cur);
      if(i < 0) i = keys.length-1;
      // swipe left => next, swipe right => prev
      i = (dx < 0) ? (i+1)%keys.length : (i-1+keys.length)%keys.length;
      apply(keys[i]);
    }, {passive:true});

    refresh();

    // breakpoint / orientation change
    const onChange = () => refresh();
    [mqPortrait, mqLandscape].forEach(mq=>{
      if(mq.addEventListener) mq.addEventListener("change", onChange);
      else mq.addListener(onChange);
    });
  }

  function init(){
    setupTocDrawer();
    setupMusicMobileTabs();
  }

  if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();
</script>

</body>
</html>
